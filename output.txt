# PROJECT DUMP
# Root: /home/blackkungfu/manyagi
# Generated: 2026-01-26 18:06:31.183894
# Limits: NO LIMITS (danger: huge output possible)
# Skips: .cache, .git, .husky, .next, .turbo, .venv, .vercel, .vscode, _scanscratch, build, coverage, cypress, dist, node_modules, out, playwright, scan_reports, venv
# Lockfiles excluded: bun.lockb, package-lock.json, package.lock.json, pnpm-lock.yaml, yarn.lock
# ENV INCLUDED: NO (use --include-env to include .env files)
# NOTE: This script file and the output file are excluded.

## ROUTES (Next.js-style)
- /
- /404
- /500
- /about
- /admin
- /api/admin/fulfillment/retry
- /api/admin/quick-create-product
- /api/admin/upload-asset
- /api/admin/upload-asset-multi
- /api/capital/subscriptions-admin
- /api/checkout/create-session
- /api/events
- /api/order-details
- /api/posts
- /api/posts/:slug
- /api/products
- /api/realty/:slug
- /api/realty/availability
- /api/realty/book
- /api/realty/booking-success
- /api/realty/booking-summary
- /api/realty/calendar-blocks
- /api/realty/cleanup-holds
- /api/realty/create-checkout
- /api/realty/external-blocks
- /api/realty/ical
- /api/realty/ical-export
- /api/realty/lead
- /api/realty/property
- /api/realty/quote
- /api/realty/rates
- /api/realty/reservations-admin
- /api/realty/send-booking-confirmation
- /api/realty/sync-ical
- /api/realty/test-email
- /api/realty/upcoming
- /api/realty/webhook
- /api/site-config
- /api/stripe-webhook
- /api/stripe/charge
- /api/studio/download-packet
- /api/studio/download-page
- /api/track
- /blog
- /blog/:slug
- /capital
- /cart
- /checkout/studio-cancel
- /checkout/studio-success
- /coming-soon
- /contact
- /dashboard
- /designs
- /events
- /links
- /login
- /media
- /media/:slug
- /privacy
- /products
- /publishing
- /r/:code
- /realty
- /realty/:slug
- /realty/booking/:slug
- /signup
- /studios
- /studios/:slug
- /tech
- /tech/:slug
- /terms
- /thank-you
- /track

### Dynamic Routes
- /studios/:slug  ‚Üê pages/studios/[slug].js
- /r/:code  ‚Üê pages/r/[code].js
- /realty/:slug  ‚Üê pages/realty/[slug].js
- /blog/:slug  ‚Üê pages/blog/[slug].js
- /tech/:slug  ‚Üê pages/tech/[slug].js
- /media/:slug  ‚Üê pages/media/[slug].js
- /realty/booking/:slug  ‚Üê pages/realty/booking/[slug].js
- /api/realty/:slug  ‚Üê pages/api/realty/[slug].js
- /api/posts/:slug  ‚Üê pages/api/posts/[slug].js

## DIRECTORY TREE
manyagi/
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AffiliatesForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AffiliatesTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AnalyticsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AssetsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AttachToProperty.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BlogTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BundlesForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BundlesTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CalendarSyncPanel.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CapitalProductForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CapitalTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DesignsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IcalSyncPanel.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MediaShowcaseForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MediaTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MultiUploader.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OverviewTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PropertyForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PropertyRatesPanel.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PublishingProductForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PublishingTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QuickProductForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RealtyTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RealtyTestEmailPanelWithProperty.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SectionCard.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StudioPagesTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TechShowcaseForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TechTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UniversesTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UpcomingStaysPanel.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsersTab.js
‚îÇ   ‚îú‚îÄ‚îÄ Calendar.js
‚îÇ   ‚îú‚îÄ‚îÄ Card.js
‚îÇ   ‚îú‚îÄ‚îÄ Cart.js
‚îÇ   ‚îú‚îÄ‚îÄ ErrorBoundary.js
‚îÇ   ‚îú‚îÄ‚îÄ Footer.js
‚îÇ   ‚îú‚îÄ‚îÄ Header.js
‚îÇ   ‚îú‚îÄ‚îÄ Hero.js
‚îÇ   ‚îú‚îÄ‚îÄ RealtyLeadForm.js
‚îÇ   ‚îú‚îÄ‚îÄ Recommender.js
‚îÇ   ‚îú‚îÄ‚îÄ SectionIntro.js
‚îÇ   ‚îú‚îÄ‚îÄ SEO.js
‚îÇ   ‚îú‚îÄ‚îÄ SignalsSubscriptionForm.js
‚îÇ   ‚îú‚îÄ‚îÄ SubscriptionForm.js
‚îÇ   ‚îú‚îÄ‚îÄ TechQuoteForm.js
‚îÇ   ‚îî‚îÄ‚îÄ ThemeToggle.js
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ emails
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bookingReceipt.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ itineraryEmail.js
‚îÇ   ‚îú‚îÄ‚îÄ studio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ build-packet.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ build-pdf.js
‚îÇ   ‚îú‚îÄ‚îÄ adminUtils.js
‚îÇ   ‚îú‚îÄ‚îÄ affiliate.js
‚îÇ   ‚îú‚îÄ‚îÄ cartSlice.js
‚îÇ   ‚îú‚îÄ‚îÄ emailTemplates.js
‚îÇ   ‚îú‚îÄ‚îÄ printful.js
‚îÇ   ‚îú‚îÄ‚îÄ realtyHelpers.js
‚îÇ   ‚îú‚îÄ‚îÄ sendEmail.js
‚îÇ   ‚îú‚îÄ‚îÄ store.js
‚îÇ   ‚îú‚îÄ‚îÄ supabase.js
‚îÇ   ‚îî‚îÄ‚îÄ supabaseAdmin.js
‚îú‚îÄ‚îÄ pages
‚îÇ   ‚îú‚îÄ‚îÄ api
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fulfillment
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retry.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quick-create-product.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upload-asset-multi.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload-asset.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ capital
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscriptions-admin.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create-session.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ realty
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [slug].js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ availability.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking-success.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking-summary.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar-blocks.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cleanup-holds.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-checkout.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ external-blocks.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ical-export.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ical.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lead.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ property.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quote.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rates.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reservations-admin.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ send-booking-confirmation.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync-ical.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test-email.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upcoming.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ charge.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ studio
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ download-packet.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ download-page.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ events.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order-details.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ site-config.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe-webhook.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track.js
‚îÇ   ‚îú‚îÄ‚îÄ blog
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ checkout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ studio-cancel.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ studio-success.js
‚îÇ   ‚îú‚îÄ‚îÄ media
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ r
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [code].js
‚îÇ   ‚îú‚îÄ‚îÄ realty
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ studios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ tech
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ 404.js
‚îÇ   ‚îú‚îÄ‚îÄ 500.js
‚îÇ   ‚îú‚îÄ‚îÄ _app.js
‚îÇ   ‚îú‚îÄ‚îÄ _document.js
‚îÇ   ‚îú‚îÄ‚îÄ about.js
‚îÇ   ‚îú‚îÄ‚îÄ admin.js
‚îÇ   ‚îú‚îÄ‚îÄ blog.js
‚îÇ   ‚îú‚îÄ‚îÄ capital.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.js
‚îÇ   ‚îú‚îÄ‚îÄ coming-soon.js
‚îÇ   ‚îú‚îÄ‚îÄ contact.js
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js
‚îÇ   ‚îú‚îÄ‚îÄ designs.js
‚îÇ   ‚îú‚îÄ‚îÄ events.js
‚îÇ   ‚îú‚îÄ‚îÄ index.js
‚îÇ   ‚îú‚îÄ‚îÄ links.js
‚îÇ   ‚îú‚îÄ‚îÄ login.js
‚îÇ   ‚îú‚îÄ‚îÄ media.js
‚îÇ   ‚îú‚îÄ‚îÄ privacy.js
‚îÇ   ‚îú‚îÄ‚îÄ products.js
‚îÇ   ‚îú‚îÄ‚îÄ publishing.js
‚îÇ   ‚îú‚îÄ‚îÄ realty.js
‚îÇ   ‚îú‚îÄ‚îÄ signup.js
‚îÇ   ‚îú‚îÄ‚îÄ studios.js
‚îÇ   ‚îú‚îÄ‚îÄ tech.js
‚îÇ   ‚îú‚îÄ‚îÄ terms.js
‚îÇ   ‚îú‚îÄ‚îÄ thank-you.js
‚îÇ   ‚îî‚îÄ‚îÄ track.js
‚îú‚îÄ‚îÄ posts
‚îÇ   ‚îî‚îÄ‚îÄ example-post.mdx
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îú‚îÄ‚îÄ assets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Legacy_of_the_Hidden_Clans (Chapter 1)_by D.N. Manyagi.pdf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Legacy_of_the_Hidden_Clans (Chapter 2)_by D.N. Manyagi.pdf
‚îÇ   ‚îú‚îÄ‚îÄ images
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ author-portrait.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-4.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chart-hero.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ daito-screenshot.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grain-texture.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ legacy-chapter-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo.svg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-4.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-5.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mock-mug-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mock-print-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mock-tee-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-about.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-capital.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-comingsoon.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-contact.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-designs.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-home.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-media.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-publishing.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-tech.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ performance-chart.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ team-photo.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-4.webp
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ video-carousel-5.webp
‚îÇ   ‚îú‚îÄ‚îÄ videos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hero-bg.mp4
‚îÇ   ‚îú‚îÄ‚îÄ favicon.ico
‚îÇ   ‚îú‚îÄ‚îÄ placeholder.png
‚îÇ   ‚îú‚îÄ‚îÄ robots.txt
‚îÇ   ‚îú‚îÄ‚îÄ sitemap-0.xml
‚îÇ   ‚îî‚îÄ‚îÄ sitemap.xml
‚îú‚îÄ‚îÄ styles
‚îÇ   ‚îî‚îÄ‚îÄ globals.css
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next-sitemap.config.js
‚îú‚îÄ‚îÄ next.config.js
‚îú‚îÄ‚îÄ package-lock.json  (not dumped)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json

## FILE CONTENTS


===== FILE: components/admin/AffiliatesForm.js  (size=2420 bytes) =====
// components/admin/AffiliatesForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { safeJSON } from '@/lib/adminUtils';

function AffiliatesForm({ onCreated }) {
  const [name, setName] = useState('');
  const [referralCode, setReferralCode] = useState('');
  const [commissionRate, setCommissionRate] = useState('0.1');
  const [metadataStr, setMetadataStr] = useState('');

  const create = async () => {
    try {
      if (!name) return alert('Name required.');
      if (!referralCode) return alert('Referral code required.');

      const payload = {
        name,
        referral_code: referralCode,
        commission_rate: Number(commissionRate),
        status: 'active',
        metadata: metadataStr ? safeJSON(metadataStr, {}) : {},
      };

      const { error } = await supabase.from('affiliates').insert(payload);
      if (error) throw error;

      setName('');
      setReferralCode('');
      setCommissionRate('0.1');
      setMetadataStr('');
      onCreated?.();
      alert('Affiliate created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Affiliates ‚Äî Add Partner">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Partner Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Referral Code"
          value={referralCode}
          onChange={(e) => setReferralCode(e.target.value)}
        />
        <input
          placeholder="Commission Rate (e.g., 0.1 for 10%)"
          type="number"
          step="0.01"
          value={commissionRate}
          onChange={(e) => setCommissionRate(e.target.value)}
        />
        <textarea
          className="md:col-span-3"
          placeholder='Metadata (JSON, e.g., {"partner_type":"influencer"})'
          value={metadataStr}
          onChange={(e) => setMetadataStr(e.target.value)}
        />
        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Affiliate
        </button>
      </div>
    </SectionCard>
  );
}

export default AffiliatesForm;


===== FILE: components/admin/AffiliatesTab.js  (size=6354 bytes) =====
// components/admin/AffiliatesTab.js
import React, { useMemo } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import AffiliatesForm from '@/components/admin/AffiliatesForm';
import { supabase } from '@/lib/supabase';

// tiny util
const currency = (n) => {
  const num = Number(n || 0);
  return `$${num.toFixed(2)}`;
};

export default function AffiliatesTab({
  affiliates,
  orders = [],
  reservations = [],
  refreshAll,
}) {
  // Build a lookup so we can aggregate earnings per affiliate
  // We consider two revenue sources:
  // 1. Normal/digital/merch orders in `orders`
  // 2. Realty bookings in `realty_reservations`
  //
  // We only count rows that are "paid".
  // For orders: status === 'paid'
  // For reservations: status === 'paid'
  //
  // We sum:
  // - total revenue attributed
  // - total commission saved on each row (commission_amount)
  //
  // NOTE: commission_amount is already calculated and stored when
  // the checkout session was created. We're just summing it here.

  const affiliateStats = useMemo(() => {
    const stats = {};

    // helper to init stats row
    function ensure(id) {
      if (!stats[id]) {
        stats[id] = {
          revenue: 0,
          commission: 0,
        };
      }
    }

    // 1) aggregate normal product orders
    orders.forEach((o) => {
      if ((o.status || '').toLowerCase() !== 'paid') return;
      if (!o.affiliate_id) return; // only count if attributed
      ensure(o.affiliate_id);

      // total_amount is assumed to be the total charged (before tax/shipping or after?)
      // We're just summing what you stored.
      stats[o.affiliate_id].revenue += Number(o.total_amount || 0);

      // commission_amount numeric(12,2)
      stats[o.affiliate_id].commission += Number(o.commission_amount || 0);
    });

    // 2) aggregate realty reservations
    reservations.forEach((r) => {
      if ((r.status || '').toLowerCase() !== 'paid') return;
      if (!r.affiliate_id) return;
      ensure(r.affiliate_id);

      // amount_cents is in cents; convert to dollars
      const amountDollars = Number(r.amount_cents || 0) / 100;
      stats[r.affiliate_id].revenue += amountDollars;

      // commission_amount for reservations we stored in dollars already
      stats[r.affiliate_id].commission += Number(r.commission_amount || 0);
    });

    return stats;
  }, [orders, reservations]);

  return (
    <SectionCard title="Affiliates Division">
      {/* create new affiliate */}
      <AffiliatesForm onCreated={refreshAll} />

      {/* list affiliates with performance */}
      <div className="mt-6">
        <h3 className="font-semibold mb-3">Affiliates</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse min-w-[800px]">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Name</th>
                <th>Referral Code</th>
                <th>Rate</th>
                <th>Referred Revenue (paid)</th>
                <th>Commission Owed</th>
                <th>Metadata</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {affiliates.map((aff) => {
                const stat = affiliateStats[aff.id] || {
                  revenue: 0,
                  commission: 0,
                };
                return (
                  <tr
                    key={aff.id}
                    className="border-b dark:border-gray-800 align-top"
                  >
                    <td className="py-2 font-semibold">{aff.name}</td>

                    <td className="py-2 text-xs">
                      <div className="font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded inline-block">
                        {aff.referral_code}
                      </div>
                    </td>

                    <td className="py-2">
                      {(Number(aff.commission_rate || 0) * 100).toFixed(1)}%
                    </td>

                    <td className="py-2 whitespace-nowrap">
                      {currency(stat.revenue)}
                    </td>

                    <td className="py-2 whitespace-nowrap text-green-600 font-semibold">
                      {currency(stat.commission)}
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <textarea
                        className="w-full h-16 dark:bg-gray-800 text-[11px]"
                        value={JSON.stringify(aff.metadata || {}, null, 0)}
                        readOnly
                      />
                    </td>

                    <td className="py-2">
                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded text-xs"
                        onClick={async () => {
                          if (!confirm('Delete this affiliate?')) return;
                          const { error } = await supabase
                            .from('affiliates')
                            .delete()
                            .eq('id', aff.id);
                          if (error) {
                            alert(`Delete failed: ${error.message}`);
                          } else {
                            refreshAll?.();
                          }
                        }}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })}

              {affiliates.length === 0 && (
                <tr>
                  <td colSpan={7} className="py-6 opacity-70 text-center">
                    No affiliates yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        <p className="text-[10px] opacity-60 mt-4 leading-relaxed">
          Referred Revenue = sum of paid Orders + paid Realty bookings
          attributed to this affiliate.
          Commission Owed = sum of commission_amount we stored at checkout.
        </p>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/AnalyticsTab.js  (size=2910 bytes) =====
// components/admin/AnalyticsTab.js
import React, { useMemo } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
  LineChart,
  Line,
  Legend,
} from 'recharts';
import { isWithinLastDays } from '@/lib/adminUtils';

export default function AnalyticsTab({ users, orders }) {
  // revenue by division (last 30d)
  const revenueByDivision = useMemo(() => {
    const map = {};
    orders.forEach((o) => {
      if (!isWithinLastDays(o.created_at, 30)) return;
      const d = (o.division || 'site').toLowerCase();
      map[d] = (map[d] || 0) + Number(o.total_amount || 0);
    });
    return Object.entries(map).map(([division, total]) => ({
      division,
      total,
    }));
  }, [orders]);

  // naive user growth per month
  const userGrowth = useMemo(() => {
    const growthMap = users.reduce((acc, u) => {
      const created = new Date(u.created_at || Date.now());
      const monthLabel = created.toLocaleString('default', {
        month: 'short',
        year: 'numeric',
      });
      acc[monthLabel] = (acc[monthLabel] || 0) + 1;
      return acc;
    }, {});
    return Object.entries(growthMap)
      .map(([month, count]) => ({ month, count }))
      .sort(
        (a, b) =>
          new Date(a.month + ' 1').getTime() -
          new Date(b.month + ' 1').getTime()
      );
  }, [users]);

  return (
    <SectionCard title="Analytics Dashboard">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Revenue by Division */}
        <div>
          <h3 className="font-semibold mb-3">Revenue by Division</h3>
          <div className="w-full h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={revenueByDivision}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="division" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="total" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* User Growth */}
        <div>
          <h3 className="font-semibold mb-3">User Growth</h3>
          <div className="w-full h-64">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={userGrowth}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="month" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="count"
                  stroke="#8884d8"
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/AssetsTab.js  (size=8688 bytes) =====
// components/admin/AssetsTab.js
import React, { useState } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import MultiUploader from '@/components/admin/MultiUploader';
import { toArrayTags, safeJSON, copyText } from '@/lib/adminUtils';

export default function AssetsTab({ assets, refreshAll }) {
  const [assetEdits, setAssetEdits] = useState({});

  const saveAssetRow = async (a) => {
    try {
      const edits = assetEdits[a.id] || {};
      if (!Object.keys(edits).length) return;

      const payload = {
        ...('filename'   in edits ? { filename: edits.filename } : {}),
        ...('division'   in edits ? { division: edits.division } : {}),
        ...('purpose'    in edits ? { purpose: edits.purpose } : {}),
        ...('tagsStr'    in edits ? { tags: toArrayTags(edits.tagsStr) } : {}),
        ...('metadataStr' in edits
          ? { metadata: safeJSON(edits.metadataStr, a.metadata || {}) }
          : {}),
      };

      const { error } = await window.supabase
        .from('assets')
        .update(payload)
        .eq('id', a.id);

      if (error) throw error;

      setAssetEdits((prev) => ({ ...prev, [a.id]: {} }));
      refreshAll?.();
      alert('Asset saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  const deleteAssetRow = async (a) => {
    if (!confirm(`Delete asset "${a.filename || a.file_url}"?\nThis cannot be undone.`)) {
      return;
    }
    try {
      // Best-effort storage delete
      const parts = (a.file_url || '').split('/storage/v1/object/public/');
      if (parts.length > 1) {
        const bucketAndPath = parts[1].split('?')[0];
        const bucket = bucketAndPath.split('/')[0];
        const filePath = bucketAndPath.split('/').slice(1).join('/');
        if (bucket && filePath) {
          await window.supabase.storage.from(bucket).remove([filePath]);
        }
      }

      const { error } = await window.supabase
        .from('assets')
        .delete()
        .eq('id', a.id);

      if (error) throw error;

      refreshAll?.();
      alert('Asset deleted.');
    } catch (e) {
      alert(`Delete failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Assets Library">
      <p className="text-sm opacity-80 mb-3">
        Upload once, reuse anywhere. Choose division + purpose to route files into
        structured folders in Supabase Storage (e.g., <code>designs/hero</code>).
      </p>

      {/* Uploader (now sends contentType/fileType hints; server sanitizes) */}
      <MultiUploader
        division="site"
        purpose="general"
        fileType="image"
        onUploaded={refreshAll}
      />

      <div className="mt-6 overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Preview</th>
              <th>Filename</th>
              <th>Division</th>
              <th>Purpose</th>
              <th>Tags</th>
              <th>Metadata (JSON)</th>
              <th>URL</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {assets.slice(0, 50).map((a) => {
              const row = assetEdits[a.id] || {};
              return (
                <tr key={a.id} className="align-top border-b dark:border-gray-800">
                  <td className="py-2">
                    {a.file_type === 'image' ? (
                      <img src={a.file_url} className="w-12 h-12 object-cover rounded" alt="" />
                    ) : a.file_type === 'video' ? (
                      <span title="video">üéûÔ∏è</span>
                    ) : a.file_type === 'pdf' ? (
                      <span title="pdf">üìÑ PDF</span>
                    ) : (
                      <span>üìÑ</span>
                    )}
                  </td>

                  <td className="py-2 min-w-[160px]">
                    <input
                      className="w-full dark:bg-gray-800"
                      placeholder={a.filename || '-'}
                      value={row.filename ?? a.filename ?? ''}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, filename: e.target.value },
                        }))
                      }
                    />
                  </td>

                  <td className="py-2">
                    <select
                      className="dark:bg-gray-800"
                      value={row.division ?? a.division ?? 'site'}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, division: e.target.value },
                        }))
                      }
                    >
                      {['site','publishing','designs','capital','tech','media','realty'].map((d) => (
                        <option key={d} value={d}>{d}</option>
                      ))}
                    </select>
                  </td>

                  <td className="py-2">
                    <select
                      className="dark:bg-gray-800"
                      value={row.purpose ?? a.purpose ?? 'general'}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, purpose: e.target.value },
                        }))
                      }
                    >
                      <option value="general">general</option>
                      <option value="hero">hero</option>
                      <option value="carousel">carousel</option>
                      <option value="gallery">gallery</option>
                      <option value="pdf">pdf</option>
                    </select>
                  </td>

                  <td className="py-2 min-w-[200px]">
                    <input
                      className="w-full dark:bg-gray-800"
                      placeholder="comma,separated,tags"
                      value={row.tagsStr ?? (Array.isArray(a.tags) ? a.tags.join(', ') : '')}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, tagsStr: e.target.value },
                        }))
                      }
                    />
                  </td>

                  <td className="py-2 min-w-[260px]">
                    <textarea
                      className="w-full h-16 dark:bg-gray-800"
                      placeholder='{"scene":"exile-portal"}'
                      value={row.metadataStr ?? JSON.stringify(a.metadata || {}, null, 0)}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, metadataStr: e.target.value },
                        }))
                      }
                    />
                  </td>

                  <td className="py-2 max-w-[280px] truncate">{a.file_url}</td>

                  <td className="py-2 space-x-2">
                    <button
                      className="text-blue-600 underline"
                      type="button"
                      onClick={() => copyText(a.file_url)}
                    >
                      Copy URL
                    </button>

                    <button
                      className="px-3 py-1 bg-blue-600 text-white rounded"
                      type="button"
                      onClick={() => saveAssetRow(a)}
                    >
                      Save
                    </button>

                    <button
                      className="px-3 py-1 bg-red-600 text-white rounded"
                      type="button"
                      onClick={() => deleteAssetRow(a)}
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              );
            })}

            {assets.length === 0 && (
              <tr>
                <td colSpan={8} className="py-6 opacity-70">
                  No assets yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/AttachToProperty.js  (size=1688 bytes) =====
// components/admin/AttachToProperty.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';

function AttachToProperty({ properties, onAfter }) {
  const [propertyId, setPropertyId] = useState('');
  const [urls, setUrls] = useState(''); // newline or comma separated

  const save = async () => {
    if (!propertyId) return alert('Pick a property');
    const list = Array.from(new Set(
      urls.split(/\s|,/).map(s => s.trim()).filter(Boolean)
    ));

    if (list.length === 0) return alert('Add at least one URL');

    // insert into property_images
    const rows = list.map((u, i) => ({
      property_id: propertyId,
      file_url: u,
      file_type: u.match(/\.(mp4)$/i) ? 'video' : 'image',
      position: i,
    }));

    const { error } = await supabase.from('property_images').insert(rows);
    if (error) return alert(error.message);

    setUrls('');
    onAfter?.();
    alert('Attached!');
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
      <select value={propertyId} onChange={e => setPropertyId(e.target.value)} className="dark:bg-gray-800">
        <option value="">Select property</option>
        {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
      </select>
      <textarea
        className="md:col-span-2 h-24 dark:bg-gray-800"
        placeholder="Paste one URL per line (or comma separated)"
        value={urls}
        onChange={(e) => setUrls(e.target.value)}
      />
      <button onClick={save} className="px-4 py-2 rounded bg-blue-600 text-white">Attach</button>
    </div>
  );
}

export default AttachToProperty;


===== FILE: components/admin/BlogTab.js  (size=12820 bytes) =====
// components/admin/BlogTab.js
import React, { useState, useMemo } from 'react';
import dynamic from 'next/dynamic';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import SEO from '@/components/SEO';

// lazy MDX renderer for preview
const MDXRemote = dynamic(
  () => import('next-mdx-remote').then((m) => m.MDXRemote),
  { ssr: false }
);

// simple slug helper so you don't have to type it every time
function slugify(str = '') {
  return str
    .toLowerCase()
    .trim()
    .replace(/['"]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

export default function BlogTab({ posts, refreshAll, user }) {
  const [postForm, setPostForm] = useState({
    id: null,
    title: '',
    slug: '',
    excerpt: '',
    content: '',
    featured_image: '',
    status: 'draft',
    division: 'site',
    description: '', // unused here but fine for shared table
    start_date: '',
    end_date: '',
  });

  const [postFilter, setPostFilter] = useState('all');
  const [postQuery, setPostQuery] = useState('');
  const [showPreview, setShowPreview] = useState(false);
  const [mdx, setMdx] = useState(null);
  const [saving, setSaving] = useState(false);

  // sort newest ‚Üí oldest, then apply filters/search
  const filteredPosts = useMemo(() => {
    const sorted = [...posts].sort((a, b) => {
      const da = new Date(a.created_at || 0).getTime();
      const db = new Date(b.created_at || 0).getTime();
      return db - da;
    });

    return sorted
      .filter((p) =>
        postFilter === 'all'
          ? true
          : (p.status || 'draft') ===
            (postFilter === 'draft' ? 'draft' : 'published')
      )
      .filter((p) => {
        if (!postQuery) return true;
        const q = postQuery.toLowerCase();
        return (
          (p.title || '').toLowerCase().includes(q) ||
          (p.slug || '').toLowerCase().includes(q)
        );
      });
  }, [posts, postFilter, postQuery]);

  const clearPostForm = () =>
    setPostForm({
      id: null,
      title: '',
      slug: '',
      excerpt: '',
      content: '',
      featured_image: '',
      status: 'draft',
      division: 'site',
      description: '',
      start_date: '',
      end_date: '',
    });

  const loadPostToForm = (p) => {
    setPostForm({
      id: p.id,
      title: p.title || '',
      slug: p.slug || '',
      excerpt: p.excerpt || '',
      content: p.content || '',
      featured_image: p.featured_image || '',
      status: p.status || 'draft',
      division: p.division || 'site',
      description: p.description || '',
      start_date: p.start_date || '',
      end_date: p.end_date || '',
    });
    setShowPreview(false);
    setMdx(null);
    if (typeof window !== 'undefined') {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const savePost = async (e) => {
    e.preventDefault();
    if (!postForm.title.trim()) {
      alert('Title is required.');
      return;
    }
    if (!postForm.slug.trim()) {
      alert('Slug is required.');
      return;
    }

    setSaving(true);
    try {
      const payload = {
        title: postForm.title.trim(),
        slug: postForm.slug.trim(),
        excerpt: postForm.excerpt.trim(),
        content: postForm.content,
        featured_image: postForm.featured_image.trim(),
        status: postForm.status,
        division: postForm.division || 'site',
        author_id: user?.id ?? null,
      };

      if (postForm.id) {
        const { error } = await supabase
          .from('posts')
          .update(payload)
          .eq('id', postForm.id);
        if (error) throw error;
      } else {
        const { error } = await supabase.from('posts').insert(payload);
        if (error) throw error;
      }

      clearPostForm();
      refreshAll?.();
      alert('Saved post.');
    } catch (err) {
      alert(`Failed to save post: ${err.message}`);
    } finally {
      setSaving(false);
    }
  };

  const publishToggle = async (id, nextStatus) => {
    const { error } = await supabase
      .from('posts')
      .update({ status: nextStatus })
      .eq('id', id);
    if (error) alert(error.message);
    else refreshAll?.();
  };

  const deletePost = async (id) => {
    if (!confirm('Delete this post?')) return;
    const { error } = await supabase.from('posts').delete().eq('id', id);
    if (error) alert(error.message);
    else {
      if (postForm.id === id) clearPostForm();
      refreshAll?.();
    }
  };

  const doPreview = async () => {
    try {
      const { serialize } = await import('next-mdx-remote/serialize');
      const ser = await serialize(postForm.content || '');
      setMdx(ser);
      setShowPreview(true);
    } catch (err) {
      alert(`MDX parse error: ${err.message}`);
    }
  };

  return (
    <SectionCard title="Blog">
      <SEO
        title="Manyagi Admin - Blog Management"
        description="Manage blog posts for Manyagi divisions."
      />

      {/* filters / search */}
      <div className="flex flex-col md:flex-row gap-3 mb-4">
        <select
          value={postFilter}
          onChange={(e) => setPostFilter(e.target.value)}
          className="p-2 rounded border dark:bg-gray-800"
        >
          <option value="all">All</option>
          <option value="draft">Drafts</option>
          <option value="published">Published</option>
        </select>

        <input
          placeholder="Search title or slug‚Ä¶"
          value={postQuery}
          onChange={(e) => setPostQuery(e.target.value)}
          className="p-2 rounded border flex-1 dark:bg-gray-800"
        />
      </div>

      {/* editor form */}
      <form
        onSubmit={savePost}
        className="grid grid-cols-1 md:grid-cols-2 gap-3 bg-white p-4 rounded border mb-6 dark:bg-gray-800"
      >
        <input
          placeholder="Title"
          value={postForm.title}
          onChange={(e) =>
            setPostForm({ ...postForm, title: e.target.value })
          }
        />

        <div className="flex gap-2">
          <input
            className="flex-1"
            placeholder="Slug (auto from title or custom)"
            value={postForm.slug}
            onChange={(e) =>
              setPostForm({ ...postForm, slug: e.target.value })
            }
          />
          <button
            type="button"
            onClick={() =>
              setPostForm((prev) => {
                const base = slugify(prev.title || '');
                if (!base) return prev;
                const div = prev.division || 'site';
                const prefix = div === 'site' ? 'site' : div;
                const autoSlug = `${prefix}-${base}`;
                return {
                  ...prev,
                  slug: prev.slug || autoSlug,
                };
              })
            }
            className="px-3 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700"
          >
            Auto
          </button>
        </div>

        <input
          className="col-span-2"
          placeholder="Excerpt"
          value={postForm.excerpt}
          onChange={(e) =>
            setPostForm({ ...postForm, excerpt: e.target.value })
          }
        />

        <input
          className="col-span-2"
          placeholder="Featured Image URL"
          value={postForm.featured_image}
          onChange={(e) =>
            setPostForm({
              ...postForm,
              featured_image: e.target.value,
            })
          }
        />

        <select
          value={postForm.division}
          onChange={(e) =>
            setPostForm({ ...postForm, division: e.target.value })
          }
        >
          {[
            'site',
            'publishing',
            'designs',
            'capital',
            'tech',
            'media',
            'realty',
          ].map((d) => (
            <option key={d} value={d}>
              {d}
            </option>
          ))}
        </select>

        <select
          value={postForm.status}
          onChange={(e) =>
            setPostForm({ ...postForm, status: e.target.value })
          }
        >
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>

        <textarea
          className="col-span-2 h-32"
          placeholder="Content (MDX)"
          value={postForm.content}
          onChange={(e) =>
            setPostForm({ ...postForm, content: e.target.value })
          }
        />

        <div className="flex gap-2 flex-wrap">
          <button
            className="p-2 bg-black text-white rounded dark:bg-gray-700 disabled:opacity-50"
            disabled={saving}
          >
            {saving ? 'Saving‚Ä¶' : 'Save Post'}
          </button>

          <button
            type="button"
            onClick={doPreview}
            className="p-2 bg-gray-500 text-white rounded"
          >
            Preview
          </button>

          <button
            type="button"
            onClick={() => {
              clearPostForm();
              setShowPreview(false);
              setMdx(null);
            }}
            className="p-2 bg-red-500 text-white rounded"
          >
            Clear
          </button>
        </div>
      </form>

      {/* preview */}
      {showPreview && mdx && (
        <div className="mb-6 rounded border bg-white p-4 dark:bg-gray-900 dark:border-gray-700">
          <h3 className="text-sm font-semibold mb-2 opacity-70">
            Live MDX Preview
          </h3>
          <div className="prose max-w-none dark:prose-invert">
            <MDXRemote {...mdx} />
          </div>
        </div>
      )}

      {/* posts list */}
      <table className="w-full text-sm">
        <thead>
          <tr>
            <th className="text-left py-2">Title</th>
            <th className="text-left py-2">Slug</th>
            <th className="text-left py-2">Division</th>
            <th className="text-left py-2">Status</th>
            <th className="text-left py-2">Actions</th>
          </tr>
        </thead>

        <tbody>
          {filteredPosts.map((p) => (
            <tr
              key={p.id}
              className="border-t dark:border-gray-800 align-top"
            >
              <td className="py-2">{p.title}</td>
              <td className="py-2 text-xs">{p.slug}</td>
              <td className="py-2 text-xs">{p.division || 'site'}</td>
              <td className="py-2">
                <span
                  className={`px-2 py-1 rounded text-xs ${
                    (p.status || 'draft') === 'published'
                      ? 'bg-green-100 text-green-800'
                      : 'bg-yellow-100 text-yellow-800'
                  }`}
                >
                  {p.status || 'draft'}
                </span>
              </td>
              <td className="py-2 space-x-3 text-xs">
                <button
                  onClick={() => loadPostToForm(p)}
                  className="text-blue-500"
                >
                  Edit
                </button>

                <button
                  onClick={() =>
                    publishToggle(
                      p.id,
                      (p.status || 'draft') === 'published'
                        ? 'draft'
                        : 'published'
                    )
                  }
                  className="text-green-600"
                >
                  {(p.status || 'draft') === 'published'
                    ? 'Unpublish'
                    : 'Publish'}
                </button>

                <a
                  href={`/blog/${p.slug}`}
                  target="_blank"
                  rel="noreferrer"
                  className="text-gray-600 hover:underline"
                >
                  View
                </a>

                <button
                  onClick={() => deletePost(p.id)}
                  className="text-red-500"
                >
                  Delete
                </button>
              </td>
            </tr>
          ))}

          {filteredPosts.length === 0 && (
            <tr>
              <td colSpan={5} className="py-6 opacity-70">
                No posts found.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </SectionCard>
  );
}


===== FILE: components/admin/BundlesForm.js  (size=2504 bytes) =====
// components/admin/BundlesForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';

function BundlesForm({ products, onCreated }) {
  const [name, setName] = useState('');
  const [description, setDescription] = useState('');
  const [price, setPrice] = useState('49.99');
  const [productIds, setProductIds] = useState([]);

  const create = async () => {
    try {
      if (!name) return alert('Name required.');
      if (!price) return alert('Price required.');
      if (productIds.length === 0) return alert('Select at least one product.');

      const payload = {
        name,
        description,
        price: Number(price),
        product_ids: productIds,
        status: 'active',
      };

      const { error } = await supabase.from('bundles').insert(payload);
      if (error) throw error;

      setName('');
      setDescription('');
      setPrice('49.99');
      setProductIds([]);
      onCreated?.();
      alert('Bundle created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Bundles ‚Äî Create Product Bundle">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Bundle Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Price"
          type="number"
          value={price}
          onChange={(e) => setPrice(e.target.value)}
        />
        <select
          multiple
          value={productIds}
          onChange={(e) =>
            setProductIds([...e.target.selectedOptions].map((o) => o.value))
          }
          className="md:col-span-3 h-32 dark:bg-gray-800"
        >
          {products.map((p) => (
            <option key={p.id} value={p.id}>
              {p.name} ({p.division})
            </option>
          ))}
        </select>
        <textarea
          className="md:col-span-3"
          placeholder="Description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
        />
        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Bundle
        </button>
      </div>
    </SectionCard>
  );
}

export default BundlesForm;


===== FILE: components/admin/BundlesTab.js  (size=2620 bytes) =====
// components/admin/BundlesTab.js
import React from 'react';
import SectionCard from '@/components/admin/SectionCard';
import BundlesForm from '@/components/admin/BundlesForm';
import { supabase } from '@/lib/supabase';
import { currency } from '@/lib/adminUtils';

export default function BundlesTab({ bundles, products, refreshAll }) {
  return (
    <SectionCard title="Bundles Division">
      <BundlesForm products={products} onCreated={refreshAll} />

      <div className="mt-6">
        <h3 className="font-semibold mb-3">Bundles</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Name</th>
              <th>Description</th>
              <th>Price</th>
              <th>Products</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {bundles.map((bund) => (
              <tr
                key={bund.id}
                className="border-b dark:border-gray-800 align-top"
              >
                <td className="py-2">{bund.name}</td>
                <td className="py-2">{bund.description || '‚Äî'}</td>
                <td className="py-2">{currency(bund.price)}</td>
                <td className="py-2">
                  {Array.isArray(bund.product_ids)
                    ? bund.product_ids.length
                    : 0}{' '}
                  products
                </td>
                <td className="py-2">
                  <button
                    className="px-3 py-1 bg-red-600 text-white rounded"
                    onClick={async () => {
                      if (!confirm('Delete this bundle?')) return;
                      const { error } = await supabase
                        .from('bundles')
                        .delete()
                        .eq('id', bund.id);
                      if (error)
                        alert(`Delete failed: ${error.message}`);
                      else {
                        refreshAll?.();
                      }
                    }}
                  >
                    Delete
                  </button>
                </td>
              </tr>
            ))}

            {bundles.length === 0 && (
              <tr>
                <td colSpan={5} className="py-6 opacity-70">
                  No bundles yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/CalendarSyncPanel.js  (size=5085 bytes) =====
// components/admin/CalendarSyncPanel.js
import React, { useState } from 'react';

/**
 * Admin panel for syncing external Airbnb/VRBO calendars.
 *
 * props:
 *  - properties: [{ id, name, slug, metadata, ... }]
 *
 * What it does:
 *  - lets you pick a property
 *  - shows that property's metadata.ical_urls (if any)
 *  - "Sync Now" POSTs to /api/realty/sync-ical with { property_id }
 *  - shows alert with results (how many imported)
 *
 * This uses the /api/realty/sync-ical endpoint you already have.
 */
export default function CalendarSyncPanel({ properties = [] }) {
  const [selectedId, setSelectedId] = useState('');
  const [loading, setLoading] = useState(false);
  const [resultMsg, setResultMsg] = useState('');

  async function runSync() {
    if (!selectedId) {
      alert('Select a property first');
      return;
    }

    setLoading(true);
    setResultMsg('');
    try {
      const res = await fetch('/api/realty/sync-ical', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: selectedId }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON response from /sync-ical:', txt);
        throw new Error('Server returned non-JSON for sync-ical');
      }

      if (data.error) {
        throw new Error(data.error);
      }

      // happy path
      const msg = `Imported ${data.imported || 0} blocks from ${data.feeds || 0} feed(s).`;
      setResultMsg(msg);
      alert(msg);
    } catch (err) {
      console.error('sync-ical error:', err);
      alert('Sync failed: ' + err.message);
    } finally {
      setLoading(false);
    }
  }

  const currentProperty = properties.find((p) => p.id === selectedId) || null;

  const icalList = Array.isArray(currentProperty?.metadata?.ical_urls)
    ? currentProperty.metadata.ical_urls
    : [];

  return (
    <div className="glass p-4 rounded mb-4">
      {/* Property picker + Sync button */}
      <div className="flex flex-col gap-3 md:flex-row md:items-end md:gap-4">
        <div className="flex-1">
          <label className="block text-sm font-semibold mb-1">Property</label>
          <select
            className="w-full dark:bg-gray-900 border rounded px-2 py-2 text-sm"
            value={selectedId}
            onChange={(e) => {
              setSelectedId(e.target.value);
              setResultMsg('');
            }}
          >
            <option value="">Select property‚Ä¶</option>
            {properties.map((p) => (
              <option key={p.id} value={p.id}>
                {p.name || p.slug || p.id}
              </option>
            ))}
          </select>
        </div>

        <div className="shrink-0">
          <button
            className="bg-purple-600 text-white px-3 py-2 rounded text-sm font-semibold disabled:opacity-50"
            onClick={runSync}
            disabled={loading || !selectedId}
          >
            {loading ? 'Syncing‚Ä¶' : 'Sync Now'}
          </button>
        </div>
      </div>

      {/* Feed preview + result message */}
      {currentProperty && (
        <div className="mt-4 text-xs leading-relaxed text-gray-700 dark:text-gray-300">
          <div className="font-semibold mb-1">
            External iCal Feeds for this property:
          </div>

          {icalList.length > 0 ? (
            <ul className="list-disc ml-4 space-y-1 break-all">
              {icalList.map((u, i) => (
                <li key={i}>{u}</li>
              ))}
            </ul>
          ) : (
            <div className="opacity-70">
              No iCal feeds set. Add an array of URLs in
              <code className="px-1 py-0.5 bg-gray-900 text-white rounded text-[10px] mx-1">
                property.metadata.ical_urls
              </code>
              (edit that in the table below).
              <pre className="bg-gray-900 text-white rounded p-2 text-[10px] mt-2 whitespace-pre-wrap break-all">
{`{
  "location": "Big Bear, CA",
  "ical_urls": [
    "https://airbnb.com/calendar/ical/XXXXX.ics",
    "https://www.vrbo.com/icalendar/XXXXX.ics"
  ],
  "cover_url": "https://.../hero.webp"
}`}
              </pre>
            </div>
          )}

          {resultMsg && (
            <div className="mt-3 text-green-600 dark:text-green-400 font-semibold">
              {resultMsg}
            </div>
          )}

          <div className="mt-3 text-[10px] opacity-70 leading-relaxed">
            When you click Sync Now:
            <br />
            ‚Ä¢ We fetch each .ics feed in metadata.ical_urls<br />
            ‚Ä¢ We insert those ranges into realty_external_blocks<br />
            ‚Ä¢ Those show up as unavailable in the public calendar<br />
            ‚Ä¢ Prevents double-booking against Airbnb / VRBO
          </div>
        </div>
      )}
    </div>
  );
}


===== FILE: components/admin/CapitalProductForm.js  (size=4480 bytes) =====
// components/admin/CapitalProductForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { toArrayTags, safeJSON } from '@/lib/adminUtils';

function CapitalProductForm({ onCreated }) {
  const [name, setName] = useState('');
  const [price, setPrice] = useState('99.99');
  const [description, setDescription] = useState('');
  const [thumbnailUrl, setThumbnailUrl] = useState('');
  const [tagsStr, setTagsStr] = useState('trading, signals');
  const [licenseType, setLicenseType] = useState('bot'); // bot | ebook | course | api | signals
  const [apiAccess, setApiAccess] = useState(false);
  const [metadataStr, setMetadataStr] = useState('');

  const create = async () => {
    try {
      if (!name) return alert('Title required.');
      if (!price) return alert('Price required.');
      if (!thumbnailUrl) return alert('Thumbnail URL required.');

      const metadata = {
        license_type: licenseType,
        api_access: apiAccess,
        ...(metadataStr ? safeJSON(metadataStr, {}) : {}),
      };

      const payload = {
        name,
        price: Number(price || 0),
        division: 'capital',
        description,
        display_image: thumbnailUrl,
        thumbnail_url: thumbnailUrl,
        status: 'active',
        tags: toArrayTags(tagsStr),
        metadata,
        // IMPORTANT: we no longer send `productType` to Supabase.
        // Capital page derives type from metadata.productType.
      };

      const { error } = await supabase.from('products').insert(payload);
      if (error) throw error;

      // reset
      setName('');
      setPrice('99.99');
      setDescription('');
      setThumbnailUrl('');
      setTagsStr('trading, signals');
      setLicenseType('bot');
      setApiAccess(false);
      setMetadataStr('');
      onCreated?.();
      alert('Capital product created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Capital ‚Äî Add Product (Signals, Bot License, eBook, etc.)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Product Title (e.g., Crypto Signals)"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Price (e.g., 39.99)"
          type="number"
          value={price}
          onChange={(e) => setPrice(e.target.value)}
        />
        <select
          value={licenseType}
          onChange={(e) => setLicenseType(e.target.value)}
          className="dark:bg-gray-800"
        >
          <option value="bot">Bot License</option>
          <option value="ebook">eBook (PDF)</option>
          <option value="course">Course</option>
          <option value="api">API Access</option>
          <option value="signals">Signals Tier</option>
        </select>

        <input
          placeholder="Thumbnail URL"
          className="md:col-span-2"
          value={thumbnailUrl}
          onChange={(e) => setThumbnailUrl(e.target.value)}
        />

        <textarea
          className="md:col-span-3"
          placeholder="Description (what this tier or product is about)"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
        />

        <input
          className="md:col-span-2"
          placeholder="Tags (comma-separated)"
          value={tagsStr}
          onChange={(e) => setTagsStr(e.target.value)}
        />

        <label className="flex items-center gap-2">
          <input
            type="checkbox"
            checked={apiAccess}
            onChange={(e) => setApiAccess(e.target.checked)}
          />
          Includes API Access
        </label>

        <textarea
          className="md:col-span-3"
          placeholder='Additional Metadata (JSON, e.g., {"productType":"subscription","plan_type":"Crypto Signals"})'
          value={metadataStr}
          onChange={(e) => setMetadataStr(e.target.value)}
        />

        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Capital Product
        </button>
      </div>
    </SectionCard>
  );
}

export default CapitalProductForm;


===== FILE: components/admin/CapitalTab.js  (size=13462 bytes) =====
// components/admin/CapitalTab.js
import React, { useState, useEffect } from 'react';
import CapitalProductForm from '@/components/admin/CapitalProductForm';
import SectionCard from '@/components/admin/SectionCard';
import {
  toArrayTags,
  safeJSON,
  updateProduct,
  deleteProduct,
} from '@/lib/adminUtils';

export default function CapitalTab({ products: allProducts, refreshAll }) {
  const [edits, setEdits] = useState({});

  // All capital division products
  const capitalProducts = (allProducts || []).filter(
    (p) => p.division === 'capital'
  );

  // ---------- SUBSCRIPTIONS DASHBOARD ----------
  const [subsLoading, setSubsLoading] = useState(true);
  const [subsError, setSubsError] = useState('');
  const [subsRows, setSubsRows] = useState([]);
  const [mrr, setMrr] = useState(0);

  useEffect(() => {
    (async () => {
      try {
        setSubsLoading(true);
        const r = await fetch('/api/capital/subscriptions-admin');
        const j = await r.json();
        if (!j.ok) {
          setSubsError(j.error || 'failed to load subscriptions');
        } else {
          setSubsError('');
          setSubsRows(j.subs || []);
          setMrr(j.mrr || 0);
        }
      } catch (e) {
        setSubsError(e.message || 'error');
      } finally {
        setSubsLoading(false);
      }
    })();
  }, []);

  // ---------- EDIT EXISTING PRODUCTS ----------
  const buildPayload = (row, p) => ({
    ...(row.thumbnail_url !== undefined
      ? { thumbnail_url: row.thumbnail_url }
      : {}),
    ...(row.price !== undefined
      ? { price: parseFloat(row.price || 0) }
      : {}),
    ...(row.tagsStr !== undefined
      ? { tags: toArrayTags(row.tagsStr) }
      : {}),
    ...(row.description !== undefined
      ? { description: row.description }
      : {}),
    ...(row.metadata !== undefined
      ? { metadata: safeJSON(row.metadata, p.metadata || {}) }
      : {}),
  });

  const save = async (p) => {
    try {
      const row = edits[p.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, p);
      await updateProduct(p.id, payload);
      setEdits((prev) => ({ ...prev, [p.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Capital Division">
      {/* 1. ADD NEW PRODUCT */}
      <div className="space-y-2 mb-8">
        <h3 className="text-xl font-bold">Add Capital Product</h3>
        <p className="text-sm opacity-80">
          Use this to create signals tiers, bot licenses, and trading ebooks
          that show up in the Capital catalog on <code>/capital</code>.
        </p>

        <ul className="text-xs opacity-70 list-disc ml-5">
          <li>
            <strong>Signals tier</strong> ‚Äî set license type to{' '}
            <code>Signals Tier</code>, price to your monthly price, and
            include metadata like:{' '}
            <code>
              {'{'}
              "productType":"subscription","plan_type":"Crypto
              Signals","stripe_price_id":"price_123"
              {'}'}
            </code>
            .
          </li>
          <li>
            <strong>Trading Playbook (PDF)</strong> ‚Äî set license type{' '}
            <code>eBook (PDF)</code>, and include metadata like:{' '}
            <code>
              {'{'}
              "productType":"download","license_type":"ebook","format":"pdf"
              {'}'}
            </code>
            .
          </li>
        </ul>

        <CapitalProductForm onCreated={refreshAll} />
      </div>

      {/* 2. SUBS / REVENUE DASHBOARD */}
      <div className="border-t pt-6 mt-8">
        <h3 className="text-xl font-bold mb-2">
          Active Signals Subscribers
        </h3>

        {subsLoading ? (
          <div className="text-sm opacity-70">Loading subscribers‚Ä¶</div>
        ) : subsError ? (
          <div className="text-sm text-red-500">
            Failed to load: {subsError}
          </div>
        ) : (
          <>
            <div className="mb-4 text-sm">
              <div>
                <span className="font-semibold">Est. MRR: </span>${mrr.toFixed(
                  2
                )}{' '}
                / month
              </div>
              <div className="text-xs opacity-70">
                MRR is sum of plan_type prices (e.g. &quot;Basic Signals&quot; =
                $29.99).
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-sm border-collapse">
                <thead>
                  <tr className="text-left border-b dark:border-gray-700">
                    <th className="py-2">Plan</th>
                    <th>Status</th>
                    <th>Telegram ID</th>
                    <th>Next Renewal</th>
                    <th>$/mo</th>
                  </tr>
                </thead>
                <tbody>
                  {subsRows.length > 0 ? (
                    subsRows.map((s) => (
                      <tr
                        key={s.id}
                        className="border-b dark:border-gray-800"
                      >
                        <td className="py-2">{s.plan_type || '‚Äî'}</td>
                        <td className="py-2">{s.status || '‚Äî'}</td>
                        <td className="py-2">{s.telegram_id || '‚Äî'}</td>
                        <td className="py-2 text-xs">
                          {s.current_period_end || '‚Äî'}
                        </td>
                        <td className="py-2">
                          ${Number(s.amount_usd || 0).toFixed(2)}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td
                        className="py-4 opacity-70 text-xs"
                        colSpan={5}
                      >
                        No active subscribers yet.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </>
        )}
      </div>

      {/* 3. EDIT EXISTING PRODUCTS */}
      <div className="border-t pt-6 mt-8">
        <h3 className="font-semibold mb-3">Products (Capital)</h3>

        <p className="text-xs opacity-70 mb-2">
          Tip: Signals tiers should have{' '}
          <code>metadata.plan_type</code> (e.g. &quot;Crypto Signals&quot;). If
          they also have <code>metadata.productType = "subscription"</code>{' '}
          that&apos;s ideal, but the frontend will still treat them as
          subscriptions as long as <code>plan_type</code> is set.
        </p>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Thumb</th>
              <th>Name</th>
              <th>Price</th>
              <th>Thumbnail URL</th>
              <th>Tags</th>
              <th>Description</th>
              <th>Metadata JSON</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {capitalProducts.length > 0 ? (
              capitalProducts.map((p) => {
                const row = edits[p.id] || {};
                return (
                  <tr
                    key={p.id}
                    className="border-b dark:border-gray-800 align-top"
                  >
                    <td className="py-2">
                      {p.thumbnail_url ? (
                        <img
                          src={p.thumbnail_url}
                          className="w-16 h-16 object-cover rounded"
                          alt=""
                        />
                      ) : null}
                    </td>

                    <td className="py-2">
                      <div className="font-semibold text-xs">
                        {p.name}
                      </div>
                      <div className="text-[10px] opacity-60">
                        {p.metadata?.productType ||
                          p.productType ||
                          '‚Äî'}
                      </div>
                    </td>

                    <td className="py-2 min-w-[100px]">
                      <input
                        type="number"
                        className="w-full dark:bg-gray-800"
                        value={row.price ?? (p.price ?? '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              price: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="thumbnail_url"
                        value={
                          row.thumbnail_url ??
                          p.thumbnail_url ??
                          ''
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              thumbnail_url: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="comma,separated,tags"
                        value={
                          row.tagsStr ??
                          (Array.isArray(p.tags)
                            ? p.tags.join(', ')
                            : '')
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              tagsStr: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[300px]">
                      <textarea
                        className="w-full h-20 dark:bg-gray-800"
                        placeholder="description"
                        value={
                          row.description ??
                          p.description ??
                          ''
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              description: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[300px]">
                      <textarea
                        className="w-full h-20 dark:bg-gray-800"
                        placeholder='{"productType":"subscription","plan_type":"Crypto Signals"}'
                        value={
                          row.metadata ??
                          JSON.stringify(p.metadata || {}, null, 0)
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              metadata: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 space-x-2">
                      <button
                        className="px-3 py-1 bg-blue-600 text-white rounded"
                        onClick={() => save(p)}
                      >
                        Save
                      </button>

                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded"
                        onClick={() =>
                          deleteProduct(p.id, refreshAll)
                        }
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr>
                <td colSpan={8} className="py-6 opacity-70">
                  No products yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/DesignsTab.js  (size=13453 bytes) =====
// components/admin/DesignsTab.js
import React, { useMemo, useState } from 'react';
import QuickProductForm from '@/components/admin/QuickProductForm';
import SectionCard from '@/components/admin/SectionCard';
import {
  toArrayTags,
  safeJSON,
  updateProduct,
  deleteProduct,
  copyText, // small convenience if you already expose this in adminUtils
} from '@/lib/adminUtils';

export default function DesignsTab({
  products: allProducts,
  assets = [],
  refreshAll,
}) {
  const [edits, setEdits] = useState({});

  const designsProducts = useMemo(
    () => allProducts.filter((p) => p.division === 'designs'),
    [allProducts]
  );

  // Show the latest designs uploads (images) so you can quickly copy & paste URLs
  const recentDesignsAssets = useMemo(
    () =>
      (assets || [])
        .filter((a) => a.division === 'designs' && a.file_type === 'image')
        .sort(
          (a, b) =>
            new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
        )
        .slice(0, 30),
    [assets]
  );

  // Build payload; safely merge metadata if nft_url or metadataStr was edited
  const buildPayload = (row, p) => {
    const next = {
      ...(row.thumbnail_url !== undefined
        ? { thumbnail_url: row.thumbnail_url }
        : {}),
      ...(row.printful_product_id !== undefined
        ? { printful_product_id: row.printful_product_id }
        : {}),
      ...(row.price !== undefined ? { price: parseFloat(row.price || 0) } : {}),
      ...(row.description !== undefined ? { description: row.description } : {}),
      ...(row.tagsStr !== undefined ? { tags: toArrayTags(row.tagsStr) } : {}),
    };

    // Merge metadata if needed
    const baseMeta = p.metadata || {};
    let mergedMeta = baseMeta;

    // If user edited the raw JSON field
    if (row.metadataStr !== undefined) {
      mergedMeta = safeJSON(row.metadataStr, baseMeta);
    }

    // If user edited the nft_url field (we set it under metadata.nft_url)
    if (row.nft_url !== undefined) {
      mergedMeta = { ...mergedMeta, nft_url: row.nft_url || '' };
    }

    if (row.metadataStr !== undefined || row.nft_url !== undefined) {
      next.metadata = mergedMeta;
    }

    return next;
  };

  const save = async (p) => {
    try {
      const row = edits[p.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, p);
      await updateProduct(p.id, payload);
      setEdits((prev) => ({ ...prev, [p.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Designs Division">
      {/* Quick create remains as-is */}
      <QuickProductForm defaultDivision="designs" onCreated={refreshAll} />

      {/* NEW: recent uploads for quick copy/paste into thumbnails or product galleries */}
      <div className="mt-8">
        <h3 className="font-semibold mb-2">Recent Designs Uploads</h3>
        <p className="text-xs opacity-70 mb-3">
          Latest image assets uploaded under <code>division=&quot;designs&quot;</code>.
          Click &quot;Copy URL&quot; to paste into a product thumbnail, NFT, or metadata.
        </p>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Preview</th>
                <th>Filename</th>
                <th>Purpose</th>
                <th>Tags</th>
                <th>URL</th>
                <th>Copy</th>
              </tr>
            </thead>
            <tbody>
              {recentDesignsAssets.length > 0 ? (
                recentDesignsAssets.map((a) => (
                  <tr key={a.id} className="border-b dark:border-gray-800 align-top">
                    <td className="py-2">
                      <img
                        src={a.file_url}
                        className="w-14 h-14 object-cover rounded"
                        alt=""
                      />
                    </td>
                    <td className="py-2">{a.filename || '‚Äî'}</td>
                    <td className="py-2">{a.purpose || '‚Äî'}</td>
                    <td className="py-2">
                      {Array.isArray(a.tags) && a.tags.length
                        ? a.tags.join(', ')
                        : '‚Äî'}
                    </td>
                    <td className="py-2 max-w-[360px] truncate">{a.file_url}</td>
                    <td className="py-2">
                      <button
                        className="text-blue-600 underline"
                        onClick={() => {
                          if (typeof copyText === 'function') copyText(a.file_url);
                          else navigator.clipboard?.writeText?.(a.file_url);
                        }}
                      >
                        Copy URL
                      </button>
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td className="py-6 opacity-70" colSpan={6}>
                    No recent design uploads found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Products editor (Designs) */}
      <div className="mt-10">
        <h3 className="font-semibold mb-3">Products (Designs)</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Thumb</th>
                <th>Name</th>
                <th>Price</th>
                <th>Printful ID</th>
                <th>Thumbnail URL</th>
                <th>NFT URL</th> {/* ‚úÖ NEW column */}
                <th>Tags</th>
                <th>Description</th>
                <th>Metadata (JSON)</th> {/* ‚úÖ NEW: raw JSON editor */}
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {designsProducts.map((p) => {
                const row = edits[p.id] || {};
                const currentNFT =
                  row.nft_url ??
                  (p?.metadata && typeof p.metadata.nft_url === 'string'
                    ? p.metadata.nft_url
                    : '');

                return (
                  <tr key={p.id} className="border-b dark:border-gray-800 align-top">
                    <td className="py-2">
                      {p.thumbnail_url ? (
                        <img
                          src={p.thumbnail_url}
                          className="w-16 h-16 object-cover rounded"
                          alt=""
                        />
                      ) : null}
                    </td>

                    <td className="py-2">{p.name}</td>

                    <td className="py-2 min-w-[100px]">
                      <input
                        type="number"
                        className="w-full dark:bg-gray-800"
                        value={row.price ?? (p.price ?? '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, price: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[160px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="printful_product_id"
                        value={row.printful_product_id ?? p.printful_product_id ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              printful_product_id: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="thumbnail_url"
                        value={row.thumbnail_url ?? p.thumbnail_url ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              thumbnail_url: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    {/* ‚úÖ NFT URL editor (saved inside metadata.nft_url) */}
                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="https://opensea.io/assets/... (NFT link)"
                        value={currentNFT}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              nft_url: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="comma,separated,tags"
                        value={
                          row.tagsStr ??
                          (Array.isArray(p.tags) ? p.tags.join(', ') : '')
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, tagsStr: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[220px]">
                      <textarea
                        className="w-full h-16 dark:bg-gray-800"
                        placeholder="description"
                        value={row.description ?? p.description ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              description: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    {/* ‚úÖ Raw metadata editor (optional but handy) */}
                    <td className="py-2 min-w-[280px]">
                      <textarea
                        className="w-full h-20 dark:bg-gray-800"
                        placeholder='{"book":"Nice World","drop":"First Edition"}'
                        value={
                          row.metadataStr ??
                          JSON.stringify(p.metadata || {}, null, 0)
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              metadataStr: e.target.value,
                            },
                          }))
                        }
                      />
                      <div className="text-[10px] opacity-60 mt-1">
                        <code>metadata.nft_url</code> is used by the Designs page/card
                        if you want to show a badge or link to the NFT.
                      </div>
                    </td>

                    <td className="py-2 space-x-2 whitespace-nowrap">
                      <button
                        className="px-3 py-1 bg-blue-600 text-white rounded"
                        onClick={() => save(p)}
                      >
                        Save
                      </button>

                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteProduct(p.id, refreshAll)}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })}

              {designsProducts.length === 0 && (
                <tr>
                  <td colSpan={10} className="py-6 opacity-70">
                    No products yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/EventsTab.js  (size=5677 bytes) =====
// components/admin/EventsTab.js
import React, { useState } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import EventCalendar from '@/components/Calendar';
import { supabase } from '@/lib/supabase';

export default function EventsTab({ events, refreshAll }) {
  // lightweight local state for new event
  const [draft, setDraft] = useState({
    title: '',
    description: '',
    start_date: '',
    end_date: '',
    division: 'site',
    metadataStr: '',
  });

  const createEvent = async () => {
    const payload = {
      title: draft.title,
      description: draft.description,
      start_date: draft.start_date,
      end_date: draft.end_date,
      division: draft.division || 'site',
      // safe parse metadataStr -> JSON or {}
      metadata: draft.metadataStr
        ? (() => {
            try {
              return JSON.parse(draft.metadataStr);
            } catch {
              return {};
            }
          })()
        : {},
    };

    const { error } = await supabase.from('events').insert(payload);
    if (error) {
      alert(`Create failed: ${error.message}`);
    } else {
      setDraft({
        title: '',
        description: '',
        start_date: '',
        end_date: '',
        division: 'site',
        metadataStr: '',
      });
      refreshAll?.();
      alert('Event created.');
    }
  };

  const deleteEvent = async (id) => {
    if (!confirm('Delete this event?')) return;
    const { error } = await supabase.from('events').delete().eq('id', id);
    if (error) alert(`Delete failed: ${error.message}`);
    else refreshAll?.();
  };

  return (
    <SectionCard title="Events Management">
      {/* Add Event Form */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
        <input
          placeholder="Event Title"
          value={draft.title}
          onChange={(e) =>
            setDraft({ ...draft, title: e.target.value })
          }
        />

        <input
          type="datetime-local"
          placeholder="Start Date"
          value={draft.start_date}
          onChange={(e) =>
            setDraft({ ...draft, start_date: e.target.value })
          }
        />

        <input
          type="datetime-local"
          placeholder="End Date"
          value={draft.end_date}
          onChange={(e) =>
            setDraft({ ...draft, end_date: e.target.value })
          }
        />

        <select
          className="dark:bg-gray-800"
          value={draft.division}
          onChange={(e) =>
            setDraft({ ...draft, division: e.target.value })
          }
        >
          <option value="site">site</option>
          <option value="tech">tech</option>
          <option value="media">media</option>
          <option value="capital">capital</option>
          <option value="realty">realty</option>
        </select>

        <textarea
          className="md:col-span-2"
          placeholder="Description"
          value={draft.description}
          onChange={(e) =>
            setDraft({ ...draft, description: e.target.value })
          }
        />

        <textarea
          className="md:col-span-3 h-24 text-xs dark:bg-gray-800"
          placeholder='Metadata (JSON, optional) e.g. {"location":"123 Main St, LA"}'
          value={draft.metadataStr}
          onChange={(e) =>
            setDraft({ ...draft, metadataStr: e.target.value })
          }
        />

        <button
          type="button"
          onClick={createEvent}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Add Event
        </button>
      </div>

      {/* Calendar */}
      <EventCalendar events={events} />

      {/* Event List */}
      <div className="mt-6">
        <h3 className="font-semibold mb-3">Events List</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Title</th>
              <th>Division</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {events.map((ev) => (
              <tr
                key={ev.id}
                className="border-b dark:border-gray-800"
              >
                <td className="py-2">{ev.title}</td>
                <td className="py-2">
                  {ev.division || 'site'}
                </td>
                <td className="py-2">
                  {ev.start_date
                    ? new Date(ev.start_date).toLocaleString()
                    : '‚Äî'}
                </td>
                <td className="py-2">
                  {ev.end_date
                    ? new Date(ev.end_date).toLocaleString()
                    : '‚Äî'}
                </td>
                <td className="py-2">
                  <button
                    className="px-3 py-1 bg-red-600 text-white rounded"
                    onClick={() => deleteEvent(ev.id)}
                  >
                    Delete
                  </button>
                </td>
              </tr>
            ))}

            {events.length === 0 && (
              <tr>
                <td colSpan={5} className="py-6 opacity-70">
                  No events yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/IcalSyncPanel.js  (size=5522 bytes) =====
// components/admin/IcalSyncPanel.js
import React, { useState } from 'react';

/**
 * Admin control to pull Airbnb/VRBO calendar blocks into our DB.
 *
 * Flow:
 * - Select a property.
 * - Click "Sync Now".
 * - Calls /api/realty/sync-ical with { property_id }.
 *
 * On success, Supabase realty_external_blocks is refreshed for that property.
 * The public /realty/[slug] page is already reading merged data from
 * /api/realty/calendar-blocks, so blocked dates appear automatically.
 *
 * Props:
 *  - properties: array of { id, name, metadata, ... }
 */
export default function IcalSyncPanel({ properties = [] }) {
  const [selectedPropertyId, setSelectedPropertyId] = useState('');
  const [statusMsg, setStatusMsg] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const currentProp = properties.find((p) => p.id === selectedPropertyId);

  // pull any ical_urls so admin can see what's going to sync
  const icalList = Array.isArray(currentProp?.metadata?.ical_urls)
    ? currentProp.metadata.ical_urls
    : [];

  async function handleSync() {
    if (!selectedPropertyId) {
      alert('Select a property first');
      return;
    }

    setIsLoading(true);
    setStatusMsg('');
    try {
      const res = await fetch('/api/realty/sync-ical', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: selectedPropertyId }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON sync-ical response:', txt);
        throw new Error('Server returned non-JSON for sync-ical');
      }

      if (!data.ok && !data.imported && !data.feeds) {
        // our route returns { ok:true, feeds:n, imported:m }
        // but in some cases { ok:true, imported:0, feeds:0 }
        // if you get here, we didn't get those keys, so assume error
        throw new Error(data.error || 'Sync failed');
      }

      setStatusMsg(
        `Synced ${data.imported ?? 0} blocks from ${data.feeds ?? 0} feed(s).`
      );
    } catch (err) {
      console.error('sync-ical error:', err);
      setStatusMsg(`Error: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className="space-y-3 glass p-4 rounded">
      <div className="flex flex-col gap-2 md:flex-row md:items-end md:gap-4">
        {/* Property selector */}
        <div className="flex-1">
          <label className="block text-sm font-semibold mb-1">
            Property
          </label>
          <select
            className="w-full dark:bg-gray-800 border dark:border-gray-600 rounded px-2 py-1 text-sm"
            value={selectedPropertyId}
            onChange={(e) => {
              setSelectedPropertyId(e.target.value);
              setStatusMsg('');
            }}
          >
            <option value="">Select property‚Ä¶</option>
            {properties.map((p) => (
              <option key={p.id} value={p.id}>
                {p.name || '(no name)'}
              </option>
            ))}
          </select>
        </div>

        {/* Sync button */}
        <div className="md:w-auto">
          <button
            className="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded disabled:opacity-50 text-sm w-full md:w-auto"
            disabled={!selectedPropertyId || isLoading}
            onClick={handleSync}
          >
            {isLoading ? 'Syncing‚Ä¶' : 'Sync Now'}
          </button>
        </div>
      </div>

      {/* Show ical_urls so admin knows what‚Äôs being synced */}
      {selectedPropertyId && (
        <div className="text-xs bg-gray-900/5 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded p-3">
          <div className="font-semibold mb-1">External Feeds:</div>
          {icalList.length === 0 ? (
            <div className="opacity-70">
              This property does not have any metadata.ical_urls yet.
              Add them in the property metadata JSON:
              <pre className="mt-2 p-2 bg-black/10 dark:bg-black/30 rounded text-[10px] whitespace-pre-wrap break-all">
{`{
  "location": "Big Bear, CA",
  "ical_urls": [
    "https://example.com/airbnb.ics",
    "https://example.com/vrbo.ics"
  ]
}`}
              </pre>
            </div>
          ) : (
            <ul className="list-disc pl-4 space-y-1 break-all">
              {icalList.map((u, i) => (
                <li key={i} className="text-[10px] md:text-[11px]">
                  {u}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}

      {/* Result / status */}
      {statusMsg && (
        <div className="text-xs font-mono bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded p-2 whitespace-pre-wrap break-all">
          {statusMsg}
        </div>
      )}

      <div className="text-[10px] opacity-60 leading-relaxed">
        This pulls reservations from Airbnb/VRBO and writes them into
        <code className="px-1 rounded bg-black/10 dark:bg-black/30">
          realty_external_blocks
        </code>
        . Those dates are merged with paid reservations and shown as
        unavailable on the public listing calendar so guests can‚Äôt double-book.
      </div>
    </div>
  );
}


===== FILE: components/admin/MediaShowcaseForm.js  (size=3991 bytes) =====
// components/admin/MediaShowcaseForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';

function MediaShowcaseForm({ onCreated }) {
  const [title, setTitle] = useState('');
  const [slug, setSlug] = useState('');
  const [excerpt, setExcerpt] = useState('');
  const [content, setContent] = useState('');
  const [featuredImage, setFeaturedImage] = useState('');
  const [thumbnailUrl, setThumbnailUrl] = useState('');
  const [mediaUrl, setMediaUrl] = useState('');
  const [mediaType, setMediaType] = useState('playlist');

  const create = async () => {
    try {
      if (!title) return alert('Title required.');
      if (!slug) return alert('Slug required.');

      const payload = {
        title,
        slug,
        excerpt,
        content,
        featured_image: featuredImage || undefined, // hero image on detail page
        thumbnail_url: thumbnailUrl || undefined,   // card image on /media grid
        status: 'published',
        division: 'media',
        metadata: {
          media_type: mediaType,
          media_url: mediaUrl || undefined, // YouTube / Spotify / etc
        },
      };

      const { error } = await supabase.from('posts').insert(payload);
      if (error) throw error;

      // reset form
      setTitle('');
      setSlug('');
      setExcerpt('');
      setContent('');
      setFeaturedImage('');
      setThumbnailUrl('');
      setMediaUrl('');
      setMediaType('playlist');

      onCreated?.();
      alert('Media showcase item created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Media ‚Äî Add Showcase Item (Playlist, Podcast, etc.)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Title (e.g., Manyagi Playlist)"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
        />

        <input
          placeholder="Slug (e.g., manyagi-playlist)"
          value={slug}
          onChange={(e) => setSlug(e.target.value)}
        />

        <select
          value={mediaType}
          onChange={(e) => setMediaType(e.target.value)}
          className="dark:bg-gray-800"
        >
          <option value="playlist">Playlist</option>
          <option value="podcast">Podcast</option>
          <option value="reel">Reel</option>
          <option value="short">YouTube Short</option>
          <option value="audiobook">Audiobook</option>
        </select>

        <input
          placeholder="Featured Image URL (hero on detail page)"
          className="md:col-span-2"
          value={featuredImage}
          onChange={(e) => setFeaturedImage(e.target.value)}
        />

        <input
          placeholder="Thumbnail URL (card on /media)"
          className="md:col-span-1"
          value={thumbnailUrl}
          onChange={(e) => setThumbnailUrl(e.target.value)}
        />

        <input
          placeholder="Media URL (YouTube / Spotify / etc)"
          className="md:col-span-3"
          value={mediaUrl}
          onChange={(e) => setMediaUrl(e.target.value)}
        />

        <textarea
          className="md:col-span-3"
          placeholder="Short excerpt / teaser"
          value={excerpt}
          onChange={(e) => setExcerpt(e.target.value)}
        />

        <textarea
          className="md:col-span-3 h-32"
          placeholder="Long content / MDX"
          value={content}
          onChange={(e) => setContent(e.target.value)}
        />

        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Showcase Item
        </button>
      </div>
    </SectionCard>
  );
}

export default MediaShowcaseForm;


===== FILE: components/admin/MediaTab.js  (size=56774 bytes) =====
// components/admin/MediaTab.js
import React, { useEffect, useMemo, useRef, useState } from "react";
import { supabase } from "@/lib/supabase";
import SectionCard from "@/components/admin/SectionCard";
import { safeJSON } from "@/lib/adminUtils";

/**
 * MANYAGI MEDIA TAB (Audio-first, works with /media posts)
 * ‚úÖ Upload MP3/WAV to Supabase Storage bucket: "assets"
 * ‚úÖ Optional thumbnail upload (image) tied to the track
 * ‚úÖ Auto-creates:
 *    1) assets row (division=media, file_type=audio) for Recent Audio Uploads
 *    2) posts row (division=media, status=published) so it appears on /media
 *
 * FIXES INCLUDED:
 * - Stops "PGRST204 Could not find column ..." spam by not selecting missing columns to detect schema.
 * - Detects posts columns safely via select('*') and checking returned keys.
 * - Writes thumbnail ALWAYS to metadata.thumbnail_url, and only to post columns if they truly exist.
 * - Adds CRUD for Recent Audio Uploads (assets table): edit tags/thumb, delete duplicates, optional delete from Storage.
 */

const BUCKET = "assets";
const AUDIO_PREFIX = "media/audio";
const THUMB_PREFIX = "media/thumbs";

const AUDIO_EXTS = ["mp3", "wav"];
const IMG_EXTS = ["jpg", "jpeg", "png", "webp"];

const MEDIA_TYPES = [
  "soundtrack",
  "score",
  "opening_theme",
  "ending_theme",
  "character_theme",
  "battle_theme",
  "chapter_read",
  "scene",
  "podcast",
  "interview",
  "event",
  "playlist",
  "trailer",
  "musicvideo",
];

const PLATFORMS = ["Suno", "YouTube", "Spotify", "SoundCloud", "Apple Music", "Other"];

function slugify(str = "") {
  return String(str)
    .toLowerCase()
    .trim()
    .replace(/['"]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function extOf(name = "") {
  const parts = String(name).split(".");
  return parts.length > 1 ? parts.pop().toLowerCase() : "";
}

function isAudioFile(fileOrUrl) {
  if (!fileOrUrl) return false;
  const s = typeof fileOrUrl === "string" ? fileOrUrl : fileOrUrl.name;
  return AUDIO_EXTS.includes(extOf(s));
}

function isImageFile(fileOrUrl) {
  if (!fileOrUrl) return false;
  const s = typeof fileOrUrl === "string" ? fileOrUrl : fileOrUrl.name;
  return IMG_EXTS.includes(extOf(s));
}

function MiniChip({ children }) {
  return (
    <span className="inline-flex items-center px-2 py-1 rounded-full text-[11px] border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/60">
      {children}
    </span>
  );
}

function CopyBtn({ text, label = "Copy" }) {
  return (
    <button
      className="text-blue-600 underline text-xs"
      onClick={() => navigator.clipboard?.writeText?.(text || "")}
      type="button"
    >
      {label}
    </button>
  );
}

function toTagsArray(tags) {
  if (Array.isArray(tags)) return tags.filter(Boolean);
  if (!tags) return [];
  return String(tags)
    .split(",")
    .map((t) => t.trim())
    .filter(Boolean);
}

function buildMeta({
  media_type,
  platform,
  audio_url,
  media_url,
  duration,
  mood,
  scene,
  book,
  universe,
  tags,
  download_url,
  license_url,
  thumbnail_url,
} = {}) {
  const tagsArr = toTagsArray(tags);
  const cleanedAudio = isAudioFile(audio_url || "") ? (audio_url || "").trim() : "";

  return {
    media_type: media_type || "soundtrack",
    platform: platform || "Suno",
    audio_url: cleanedAudio,
    media_url: (media_url || "").trim(),
    duration: duration || "",
    mood: mood || "",
    scene: scene || "",
    book: book || "",
    universe: universe || book || "",
    download_url: (download_url || "").trim(),
    license_url: (license_url || "").trim(),
    thumbnail_url: (thumbnail_url || "").trim(), // ALWAYS safe in metadata
    tags: tagsArr,
  };
}

function formatDuration(sec) {
  if (!Number.isFinite(sec) || sec <= 0) return "";
  const s = Math.round(sec);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${m}:${String(r).padStart(2, "0")}`;
}

async function getAudioDurationSeconds(url) {
  return new Promise((resolve) => {
    try {
      const a = new Audio();
      a.preload = "metadata";
      a.src = url;
      const done = (v) => {
        a.onloadedmetadata = null;
        a.onerror = null;
        resolve(v);
      };
      a.onloadedmetadata = () => {
        const d = Number(a.duration);
        if (!Number.isFinite(d) || d <= 0) return done(null);
        done(d);
      };
      a.onerror = () => done(null);
    } catch {
      resolve(null);
    }
  });
}

function extractThumbFromPost(post, rowOverride = {}) {
  const m = post?.metadata || {};
  const row = rowOverride || {};
  return (
    (row.thumbnail_url ?? "").trim() ||
    (row.featured_image ?? "").trim() ||
    (post.thumbnail_url ?? "").trim() ||
    (post.featured_image ?? "").trim() ||
    (m.thumbnail_url ?? "").trim() ||
    ""
  );
}

function extractStoragePathFromPublicUrl(url) {
  // Example:
  // https://xxxx.supabase.co/storage/v1/object/public/assets/media/audio/123_file.mp3
  // -> "media/audio/123_file.mp3"
  if (!url) return "";
  try {
    const u = new URL(url);
    const marker = `/storage/v1/object/public/${BUCKET}/`;
    const idx = u.pathname.indexOf(marker);
    if (idx === -1) return "";
    return decodeURIComponent(u.pathname.slice(idx + marker.length));
  } catch {
    // fallback string parse
    const marker = `/storage/v1/object/public/${BUCKET}/`;
    const idx = String(url).indexOf(marker);
    if (idx === -1) return "";
    return decodeURIComponent(String(url).slice(idx + marker.length).split("?")[0]);
  }
}

async function getPublicUrl(bucket, path) {
  const { data } = supabase.storage.from(bucket).getPublicUrl(path);
  return data?.publicUrl || "";
}

export default function MediaTab({ posts: allPosts, refreshAll }) {
  const mediaPosts = useMemo(() => {
    return (allPosts || [])
      .filter((p) => p.division === "media")
      .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
  }, [allPosts]);

  const [mediaAssets, setMediaAssets] = useState([]);
  const [notice, setNotice] = useState(null);
  const [busy, setBusy] = useState(false);

  // browse
  const [q, setQ] = useState("");
  const [typeFilter, setTypeFilter] = useState("ALL");
  const [platformFilter, setPlatformFilter] = useState("ALL");

  // upload panel
  const [audioFile, setAudioFile] = useState(null);
  const [thumbFile, setThumbFile] = useState(null);
  const [uploadPct, setUploadPct] = useState(0);

  const [newTitle, setNewTitle] = useState("");
  const [newIP, setNewIP] = useState("");
  const [newType, setNewType] = useState("soundtrack");
  const [newPlatform, setNewPlatform] = useState("Suno");
  const [newMood, setNewMood] = useState("");
  const [newScene, setNewScene] = useState("");
  const [newTags, setNewTags] = useState("suno, cinematic");

  // editor state per post
  const [edits, setEdits] = useState({});

  // assets CRUD state
  const [assetEdits, setAssetEdits] = useState({});
  const [deleteFromStorage, setDeleteFromStorage] = useState(true);

  const audioInputRef = useRef(null);
  const thumbInputRef = useRef(null);
  const dropRef = useRef(null);

  // posts columns support (safe detection)
  const [postsCols, setPostsCols] = useState({
    thumbnail_url: false,
    featured_image: false,
    published_at: false,
  });

  async function detectPostsColumns() {
    // SAFEST detection: ask for '*' and inspect keys.
    // If RLS blocks select, we avoid assuming columns exist (so we don't write them).
    try {
      const { data, error } = await supabase.from("posts").select("*").limit(1);
      if (error) {
        // If this errors, it's commonly RLS. Safer to not write optional columns.
        setPostsCols({ thumbnail_url: false, featured_image: false, published_at: false });
        return;
      }
      const row = (data && data[0]) || {};
      const keys = new Set(Object.keys(row || {}));
      setPostsCols({
        thumbnail_url: keys.has("thumbnail_url"),
        featured_image: keys.has("featured_image"),
        published_at: keys.has("published_at"),
      });
    } catch {
      setPostsCols({ thumbnail_url: false, featured_image: false, published_at: false });
    }
  }

  async function refreshAssets() {
    const { data, error } = await supabase
      .from("assets")
      .select("*")
      .eq("division", "media")
      .order("created_at", { ascending: false })
      .limit(250);

    if (error) console.error(error);
    setMediaAssets(data || []);
  }

  useEffect(() => {
    detectPostsColumns();
    refreshAssets();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function setRow(postId, patch) {
    setEdits((prev) => {
      const row = prev[postId] || {};
      return { ...prev, [postId]: { ...row, ...patch } };
    });
  }

  function getRow(post) {
    return edits[post.id] || {};
  }

  function getQuick(post) {
    const row = getRow(post);
    const base = post.metadata || {};
    const merged = { ...base, ...(row.metaQuick || {}) };
    const tags = merged.tags;
    return {
      media_type: merged.media_type || "",
      platform: merged.platform || "",
      duration: merged.duration || "",
      audio_url: merged.audio_url || "",
      media_url: merged.media_url || "",
      mood: merged.mood || "",
      scene: merged.scene || "",
      book: merged.book || "",
      universe: merged.universe || "",
      download_url: merged.download_url || "",
      license_url: merged.license_url || "",
      thumbnail_url: merged.thumbnail_url || "",
      tags: Array.isArray(tags) ? tags.join(", ") : tags || "",
    };
  }

  function setRowQuick(postId, patch) {
    setEdits((prev) => {
      const row = prev[postId] || {};
      const current = row.metaQuick || {};
      return { ...prev, [postId]: { ...row, metaQuick: { ...current, ...patch } } };
    });
  }

  // assets edits helpers
  function setAssetRow(assetId, patch) {
    setAssetEdits((prev) => {
      const row = prev[assetId] || {};
      return { ...prev, [assetId]: { ...row, ...patch } };
    });
  }
  function getAssetRow(assetId) {
    return assetEdits[assetId] || {};
  }

  const filteredPosts = useMemo(() => {
    let list = [...mediaPosts];

    if (typeFilter !== "ALL") {
      list = list.filter(
        (p) => String(p?.metadata?.media_type || "").toLowerCase() === typeFilter.toLowerCase()
      );
    }

    if (platformFilter !== "ALL") {
      list = list.filter(
        (p) => String(p?.metadata?.platform || "").toLowerCase() === platformFilter.toLowerCase()
      );
    }

    if (q.trim()) {
      const query = q.trim().toLowerCase();
      list = list.filter((p) => {
        const m = p.metadata || {};
        const hay = [
          p.title,
          p.slug,
          p.excerpt,
          p.content,
          m.media_type,
          m.platform,
          m.audio_url,
          m.media_url,
          m.book,
          m.universe,
          m.scene,
          m.mood,
          m.thumbnail_url,
          Array.isArray(m.tags) ? m.tags.join(", ") : m.tags,
        ]
          .filter(Boolean)
          .join(" ")
          .toLowerCase();
        return hay.includes(query);
      });
    }

    // audio-clean view: must have mp3/wav audio_url OR external media_url
    list = list.filter((p) => {
      const m = p.metadata || {};
      const a = String(m.audio_url || "").trim();
      const u = String(m.media_url || "").trim();
      return (a && isAudioFile(a)) || !!u;
    });

    return list;
  }, [mediaPosts, q, typeFilter, platformFilter]);

  // drag/drop
  useEffect(() => {
    const el = dropRef.current;
    if (!el) return;

    const onDragOver = (e) => {
      e.preventDefault();
      e.stopPropagation();
      el.classList.add("ring-2", "ring-amber-300");
    };
    const onDragLeave = (e) => {
      e.preventDefault();
      e.stopPropagation();
      el.classList.remove("ring-2", "ring-amber-300");
    };
    const onDrop = (e) => {
      e.preventDefault();
      e.stopPropagation();
      el.classList.remove("ring-2", "ring-amber-300");

      const files = Array.from(e.dataTransfer.files || []);
      const aud = files.find((f) => isAudioFile(f));
      const img = files.find((f) => isImageFile(f));

      if (!aud) {
        setNotice({ type: "error", msg: "Drop an MP3 or WAV file." });
        return;
      }
      setAudioFile(aud);
      if (img) setThumbFile(img);
      if (!newTitle) setNewTitle(aud.name.replace(/\.[^/.]+$/, ""));
    };

    el.addEventListener("dragover", onDragOver);
    el.addEventListener("dragleave", onDragLeave);
    el.addEventListener("drop", onDrop);
    return () => {
      el.removeEventListener("dragover", onDragOver);
      el.removeEventListener("dragleave", onDragLeave);
      el.removeEventListener("drop", onDrop);
    };
  }, [newTitle]);

  async function uploadToStorage(file, prefix) {
    const cleanName = file.name.replace(/[^\w.\-]+/g, "_");
    const path = `${prefix}/${Date.now()}_${Math.random().toString(16).slice(2)}_${cleanName}`;

    const { error } = await supabase.storage.from(BUCKET).upload(path, file, {
      cacheControl: "3600",
      upsert: true,
      contentType: file.type || undefined,
    });

    if (error) {
      console.error("Storage upload error:", error);
      throw new Error(`${error.message} (bucket="${BUCKET}", path="${path}")`);
    }

    const url = await getPublicUrl(BUCKET, path);
    if (!url) throw new Error("Upload succeeded but public URL was empty.");
    return { path, url };
  }

  async function createAssetRow({ audioUrl, thumbUrl, audioFilename, tagsArr }) {
    const payload = {
      division: "media",
      file_url: audioUrl,
      file_type: "audio",
      filename: audioFilename,
      purpose: "music",
      tags: tagsArr || [],
      metadata: thumbUrl ? { thumbnail_url: thumbUrl } : {},
    };

    const { error } = await supabase.from("assets").insert(payload);
    if (error) {
      console.error("assets insert error", error);
      // don't hard-fail; the file is already in Storage
    }
  }

  async function createMediaPost({ title, audioUrl, thumbUrl, durationStr }) {
    const slug = slugify(`${title}-${Date.now().toString().slice(-5)}`);

    const meta = buildMeta({
      media_type: newType,
      platform: newPlatform,
      audio_url: audioUrl,
      duration: durationStr || "",
      mood: newMood,
      scene: newScene,
      book: newIP,
      universe: newIP,
      tags: newTags,
      thumbnail_url: thumbUrl || "",
    });

    const payload = {
      division: "media",
      status: "published",
      title: title || "Untitled Track",
      slug,
      excerpt: `${meta.media_type || "soundtrack"} ‚Ä¢ ${meta.platform || "Suno"}${
        meta.duration ? ` ‚Ä¢ ${meta.duration}` : ""
      }`,
      content: meta.scene || meta.mood || "",
      metadata: meta,
      // Only include columns if they exist (detected safely)
      ...(postsCols.thumbnail_url ? { thumbnail_url: thumbUrl || null } : {}),
      ...(postsCols.featured_image ? { featured_image: thumbUrl || null } : {}),
      ...(postsCols.published_at ? { published_at: new Date().toISOString() } : {}),
    };

    const { error } = await supabase.from("posts").insert(payload);
    if (error) {
      console.error("posts insert error payload:", payload);
      console.error("posts insert error:", error);

      // Helpful message if it's likely RLS
      const msg = String(error.message || "");
      const code = String(error.code || "");
      if (msg.toLowerCase().includes("row level security") || code === "42501") {
        throw new Error(
          "Posts insert blocked by RLS. Add an insert policy for authenticated admin users on posts."
        );
      }

      throw new Error(error.message || "Failed to insert into posts");
    }
  }

  async function handleUploadCreate() {
    try {
      setNotice(null);

      if (!audioFile) return setNotice({ type: "error", msg: "Select an MP3 or WAV file first." });
      if (!isAudioFile(audioFile))
        return setNotice({ type: "error", msg: "Only MP3/WAV uploads are allowed." });
      if (thumbFile && !isImageFile(thumbFile))
        return setNotice({ type: "error", msg: "Thumbnail must be an image (jpg/png/webp)." });

      setBusy(true);
      setUploadPct(8);

      // 1) upload audio
      const { url: audioUrl } = await uploadToStorage(audioFile, AUDIO_PREFIX);
      setUploadPct(55);

      // 2) upload thumb (optional)
      let thumbUrl = "";
      if (thumbFile) {
        const up = await uploadToStorage(thumbFile, THUMB_PREFIX);
        thumbUrl = up.url;
      }
      setUploadPct(70);

      // 3) sniff duration
      let durationStr = "";
      const sec = await getAudioDurationSeconds(audioUrl);
      if (sec) durationStr = formatDuration(sec);
      setUploadPct(82);

      // 4) assets row
      const tagsArr = toTagsArray(newTags);
      await createAssetRow({ audioUrl, thumbUrl, audioFilename: audioFile.name, tagsArr });

      // 5) post row (this is what was failing for you)
      const title = (newTitle || audioFile.name.replace(/\.[^/.]+$/, "")).trim();
      await createMediaPost({ title, audioUrl, thumbUrl, durationStr });

      setUploadPct(100);

      // reset UI
      setAudioFile(null);
      setThumbFile(null);
      setNewTitle("");
      setNewMood("");
      setNewScene("");
      setNewIP("");

      setNotice({ type: "ok", msg: `Uploaded + created Media Post (bucket "${BUCKET}").` });

      await refreshAssets();
      refreshAll?.();
    } catch (e) {
      setNotice({ type: "error", msg: `Upload failed: ${e.message}` });
    } finally {
      setBusy(false);
      setTimeout(() => setUploadPct(0), 700);
    }
  }

  // POSTS CRUD
  async function save(post) {
    try {
      setNotice(null);
      const row = edits[post.id] || {};
      if (!Object.keys(row).length) return;

      let mergedMeta = post.metadata || {};
      if (row.metadataStr !== undefined) mergedMeta = safeJSON(row.metadataStr, mergedMeta);
      if (row.metaQuick) mergedMeta = { ...mergedMeta, ...buildMeta(row.metaQuick) };

      // enforce mp3/wav
      if (mergedMeta.audio_url && !isAudioFile(mergedMeta.audio_url)) mergedMeta.audio_url = "";

      // if user typed thumb URL, keep metadata.thumbnail_url in sync
      if (row.thumbnail_url !== undefined) mergedMeta.thumbnail_url = String(row.thumbnail_url || "").trim();
      if (row.featured_image !== undefined) mergedMeta.thumbnail_url = String(row.featured_image || "").trim();

      const payload = {
        ...(row.title !== undefined ? { title: row.title } : {}),
        ...(row.slug !== undefined ? { slug: row.slug } : {}),
        ...(row.excerpt !== undefined ? { excerpt: row.excerpt } : {}),
        ...(row.content !== undefined ? { content: row.content } : {}),
        metadata: mergedMeta,
        ...(postsCols.thumbnail_url && row.thumbnail_url !== undefined
          ? { thumbnail_url: row.thumbnail_url || null }
          : {}),
        ...(postsCols.featured_image && row.featured_image !== undefined
          ? { featured_image: row.featured_image || null }
          : {}),
      };

      const { error } = await supabase.from("posts").update(payload).eq("id", post.id);
      if (error) throw error;

      setEdits((prev) => ({ ...prev, [post.id]: {} }));
      refreshAll?.();
      setNotice({ type: "ok", msg: "Saved." });
    } catch (e) {
      setNotice({ type: "error", msg: `Save failed: ${e.message}` });
    }
  }

  async function remove(postId) {
    if (!confirm("Delete this media post?")) return;
    try {
      setNotice(null);
      const { error } = await supabase.from("posts").delete().eq("id", postId);
      if (error) throw error;
      refreshAll?.();
      setNotice({ type: "ok", msg: "Deleted." });
    } catch (e) {
      setNotice({ type: "error", msg: `Delete failed: ${e.message}` });
    }
  }

  // ASSETS CRUD (Recent Audio Uploads)
  async function saveAsset(asset) {
    try {
      setNotice(null);
      const row = getAssetRow(asset.id);
      if (!Object.keys(row).length) return;

      const nextTags = row.tagsStr !== undefined ? toTagsArray(row.tagsStr) : asset.tags || [];
      const nextThumb =
        row.thumbStr !== undefined ? String(row.thumbStr || "").trim() : asset?.metadata?.thumbnail_url || "";

      const payload = {
        ...(row.filename !== undefined ? { filename: row.filename } : {}),
        ...(row.purpose !== undefined ? { purpose: row.purpose } : {}),
        ...(row.file_url !== undefined ? { file_url: row.file_url } : {}),
        ...(row.file_type !== undefined ? { file_type: row.file_type } : {}),
        tags: nextTags,
        metadata: { ...(asset.metadata || {}), ...(nextThumb ? { thumbnail_url: nextThumb } : { thumbnail_url: "" }) },
      };

      const { error } = await supabase.from("assets").update(payload).eq("id", asset.id);
      if (error) throw error;

      setAssetEdits((prev) => ({ ...prev, [asset.id]: {} }));
      await refreshAssets();
      setNotice({ type: "ok", msg: "Asset saved." });
    } catch (e) {
      setNotice({ type: "error", msg: `Asset save failed: ${e.message}` });
    }
  }

  async function deleteAsset(asset) {
    const ok = confirm(
      `Delete this asset row${deleteFromStorage ? " AND delete file from Storage" : ""}?`
    );
    if (!ok) return;

    try {
      setNotice(null);

      // optionally delete storage object first
      if (deleteFromStorage) {
        const path = extractStoragePathFromPublicUrl(asset.file_url || "");
        if (path) {
          const { error: rmErr } = await supabase.storage.from(BUCKET).remove([path]);
          if (rmErr) {
            // don't block DB delete; but warn
            console.error("storage remove error", rmErr);
          }
        }
      }

      const { error } = await supabase.from("assets").delete().eq("id", asset.id);
      if (error) throw error;

      await refreshAssets();
      setNotice({ type: "ok", msg: "Asset deleted." });
    } catch (e) {
      setNotice({ type: "error", msg: `Asset delete failed: ${e.message}` });
    }
  }

  const audioAssets = useMemo(() => {
    return (mediaAssets || []).filter((a) => a.file_type === "audio" && isAudioFile(a.file_url || ""));
  }, [mediaAssets]);

  const duplicatesSummary = useMemo(() => {
    const map = new Map();
    for (const a of audioAssets) {
      const key = (a.filename || a.file_url || "").toLowerCase().trim();
      if (!key) continue;
      map.set(key, (map.get(key) || 0) + 1);
    }
    const dups = Array.from(map.entries())
      .filter(([, count]) => count > 1)
      .sort((a, b) => b[1] - a[1]);
    return dups.slice(0, 8);
  }, [audioAssets]);

  return (
    <SectionCard title="Media (Audio Studio)">
      {notice?.msg ? (
        <div
          className={`mt-4 rounded-xl border p-3 text-sm ${
            notice.type === "error"
              ? "border-red-200 bg-red-50 text-red-800"
              : "border-emerald-200 bg-emerald-50 text-emerald-800"
          }`}
        >
          {notice.msg}
        </div>
      ) : null}

      {/* UPLOAD STUDIO */}
      <div className="mt-6 rounded-3xl border border-amber-100/80 dark:border-gray-800 bg-white/70 dark:bg-gray-900/60 p-5 md:p-6 shadow-sm">
        <div className="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Suno Workflow</div>
            <h3 className="text-xl md:text-2xl font-bold mt-1">Upload a Track (MP3/WAV)</h3>
            <p className="text-xs opacity-70 mt-1">
              Uploads go to bucket <b>{BUCKET}</b>. Thumbnails are optional and stored in{" "}
              <code>metadata.thumbnail_url</code> (and in post columns only if they exist).
            </p>
            <div className="text-[11px] opacity-60 mt-2">
              Posts columns detected:{" "}
              <span className="font-semibold">
                thumbnail_url={String(postsCols.thumbnail_url)} ‚Ä¢ featured_image={String(postsCols.featured_image)} ‚Ä¢
                published_at={String(postsCols.published_at)}
              </span>
            </div>
          </div>

          <div className="flex gap-2 flex-wrap">
            <MiniChip>Bucket: {BUCKET}</MiniChip>
            <MiniChip>.mp3 / .wav only</MiniChip>
            <MiniChip>Auto-creates /media post</MiniChip>
          </div>
        </div>

        <div
          ref={dropRef}
          className="mt-4 rounded-3xl border border-dashed border-gray-300 dark:border-gray-700 bg-white/60 dark:bg-gray-950/20 p-5"
        >
          <div className="flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
            <div>
              <div className="text-sm font-semibold">Drag & drop MP3/WAV here</div>
              <div className="text-xs opacity-70 mt-1">You can also drop an image thumbnail alongside the audio.</div>

              <div className="mt-3 flex flex-wrap gap-2">
                <button
                  type="button"
                  onClick={() => audioInputRef.current?.click()}
                  className="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold"
                >
                  Choose Audio
                </button>
                <button
                  type="button"
                  onClick={() => thumbInputRef.current?.click()}
                  className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/30 text-sm font-semibold"
                >
                  Choose Thumbnail (optional)
                </button>
              </div>

              <input
                ref={audioInputRef}
                type="file"
                accept=".mp3,.wav,audio/mpeg,audio/wav"
                className="hidden"
                onChange={(e) => {
                  const f = e.target.files?.[0];
                  if (!f) return;
                  if (!isAudioFile(f)) return setNotice({ type: "error", msg: "Only MP3 or WAV allowed." });
                  setAudioFile(f);
                  if (!newTitle) setNewTitle(f.name.replace(/\.[^/.]+$/, ""));
                }}
              />

              <input
                ref={thumbInputRef}
                type="file"
                accept=".jpg,.jpeg,.png,.webp,image/*"
                className="hidden"
                onChange={(e) => {
                  const f = e.target.files?.[0];
                  if (!f) return;
                  if (!isImageFile(f)) return setNotice({ type: "error", msg: "Thumbnail must be jpg/png/webp." });
                  setThumbFile(f);
                }}
              />
            </div>

            <div className="min-w-[280px] w-full md:w-[360px]">
              <div className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/40 p-4">
                <div className="text-xs opacity-70">Selected</div>
                <div className="mt-2 text-sm">
                  <div className="flex items-center justify-between gap-2">
                    <span className="opacity-70">Audio:</span>
                    <span className="font-semibold truncate">{audioFile?.name || "‚Äî"}</span>
                  </div>
                  <div className="flex items-center justify-between gap-2 mt-1">
                    <span className="opacity-70">Thumb:</span>
                    <span className="font-semibold truncate">{thumbFile?.name || "‚Äî"}</span>
                  </div>
                </div>

                {busy && uploadPct ? (
                  <div className="mt-4">
                    <div className="text-xs opacity-70 mb-1">Uploading‚Ä¶ {uploadPct}%</div>
                    <div className="h-2 rounded-full bg-gray-200 dark:bg-gray-800 overflow-hidden">
                      <div className="h-full bg-amber-400" style={{ width: `${uploadPct}%` }} />
                    </div>
                  </div>
                ) : null}
              </div>
            </div>
          </div>

          <div className="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label className="block text-[10px] opacity-70">Title</label>
              <input
                className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                value={newTitle}
                onChange={(e) => setNewTitle(e.target.value)}
                placeholder="Main Theme ‚Äî Legacy of the Hidden Clans"
              />
            </div>

            <div>
              <label className="block text-[10px] opacity-70">IP (Book/Universe)</label>
              <input
                className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                value={newIP}
                onChange={(e) => setNewIP(e.target.value)}
                placeholder="Legacy of the Hidden Clans"
              />
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-[10px] opacity-70">Type</label>
                <select
                  className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                  value={newType}
                  onChange={(e) => setNewType(e.target.value)}
                >
                  {MEDIA_TYPES.map((t) => (
                    <option key={t} value={t}>
                      {t}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-[10px] opacity-70">Platform</label>
                <select
                  className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                  value={newPlatform}
                  onChange={(e) => setNewPlatform(e.target.value)}
                >
                  {PLATFORMS.map((t) => (
                    <option key={t} value={t}>
                      {t}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div>
              <label className="block text-[10px] opacity-70">Mood</label>
              <input
                className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                value={newMood}
                onChange={(e) => setNewMood(e.target.value)}
                placeholder="epic, mystical, tragic‚Ä¶"
              />
            </div>

            <div className="md:col-span-2">
              <label className="block text-[10px] opacity-70">Scene / Notes</label>
              <input
                className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                value={newScene}
                onChange={(e) => setNewScene(e.target.value)}
                placeholder="Opening credits theme. Establishes mythic scale‚Ä¶"
              />
            </div>

            <div className="md:col-span-3">
              <label className="block text-[10px] opacity-70">Tags</label>
              <input
                className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                value={newTags}
                onChange={(e) => setNewTags(e.target.value)}
                placeholder="main-theme, opening-credits, dark-fantasy‚Ä¶"
              />
            </div>
          </div>

          <div className="mt-4 flex gap-3 flex-wrap items-center">
            <button
              type="button"
              disabled={busy}
              onClick={handleUploadCreate}
              className="px-5 py-2 rounded-2xl bg-amber-200 text-amber-950 font-semibold hover:bg-amber-300 disabled:opacity-60 disabled:cursor-not-allowed"
            >
              Upload + Create Media Post
            </button>

            <button
              type="button"
              disabled={busy}
              onClick={() => {
                setAudioFile(null);
                setThumbFile(null);
                setNewTitle("");
                setNewMood("");
                setNewScene("");
                setNewIP("");
                setNotice(null);
              }}
              className="px-5 py-2 rounded-2xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/30 font-semibold"
            >
              Clear
            </button>

            <div className="text-xs opacity-70 flex flex-wrap gap-2">
              <MiniChip>Audio path: {AUDIO_PREFIX}/‚Ä¶</MiniChip>
              <MiniChip>Thumb path: {THUMB_PREFIX}/‚Ä¶</MiniChip>
            </div>
          </div>
        </div>
      </div>

      {/* BROWSE */}
      <div className="mt-8 rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/60 p-4">
        <div className="flex flex-col md:flex-row gap-3 md:items-end md:justify-between">
          <div className="flex-1">
            <label className="block text-[10px] opacity-70">Search</label>
            <input
              className="w-full dark:bg-gray-800 text-sm rounded-lg px-3 py-2 border border-gray-200 dark:border-gray-700"
              placeholder="Search title, IP, scene, mood‚Ä¶"
              value={q}
              onChange={(e) => setQ(e.target.value)}
            />
          </div>

          <div className="min-w-[180px]">
            <label className="block text-[10px] opacity-70">Type</label>
            <select
              className="w-full dark:bg-gray-800 text-sm rounded-lg px-3 py-2 border border-gray-200 dark:border-gray-700"
              value={typeFilter}
              onChange={(e) => setTypeFilter(e.target.value)}
            >
              <option value="ALL">All types</option>
              {MEDIA_TYPES.map((t) => (
                <option key={t} value={t}>
                  {t}
                </option>
              ))}
            </select>
          </div>

          <div className="min-w-[180px]">
            <label className="block text-[10px] opacity-70">Platform</label>
            <select
              className="w-full dark:bg-gray-800 text-sm rounded-lg px-3 py-2 border border-gray-200 dark:border-gray-700"
              value={platformFilter}
              onChange={(e) => setPlatformFilter(e.target.value)}
            >
              <option value="ALL">All</option>
              {PLATFORMS.map((t) => (
                <option key={t} value={t}>
                  {t}
                </option>
              ))}
            </select>
          </div>

          <div className="text-xs opacity-70">
            Showing <b>{filteredPosts.length}</b> / {mediaPosts.length} (audio-clean)
          </div>
        </div>
      </div>

      {/* RECENT UPLOADS (ASSETS CRUD) */}
      <div className="mt-10">
        <div className="flex items-end justify-between gap-3 flex-wrap">
          <div>
            <h3 className="font-semibold mb-1">Recent Audio Uploads</h3>
            <p className="text-xs opacity-70">
              Shows assets where <code>division=media</code> and <code>file_type=audio</code>. You can edit + delete
              duplicates here.
            </p>

            {duplicatesSummary.length ? (
              <div className="mt-2 text-[11px] opacity-70">
                <span className="font-semibold">Duplicates detected:</span>{" "}
                {duplicatesSummary.map(([k, c]) => (
                  <span key={k} className="ml-2">
                    <MiniChip>
                      {c}√ó {k.slice(0, 26)}
                      {k.length > 26 ? "‚Ä¶" : ""}
                    </MiniChip>
                  </span>
                ))}
              </div>
            ) : null}
          </div>

          <div className="flex items-center gap-3 flex-wrap">
            <label className="text-xs opacity-80 flex items-center gap-2">
              <input
                type="checkbox"
                checked={deleteFromStorage}
                onChange={(e) => setDeleteFromStorage(e.target.checked)}
              />
              Delete file from Storage too
            </label>

            <button
              type="button"
              className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/30 text-sm font-semibold"
              onClick={refreshAssets}
            >
              Refresh
            </button>
          </div>
        </div>

        <div className="overflow-x-auto mt-3 rounded-2xl border border-gray-200 dark:border-gray-800">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b dark:border-gray-700 bg-gray-50/60 dark:bg-gray-900/40">
                <th className="py-2 px-3">Preview</th>
                <th className="px-3">Filename</th>
                <th className="px-3">Thumb</th>
                <th className="px-3">Tags</th>
                <th className="px-3">URL</th>
                <th className="px-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {audioAssets.length ? (
                audioAssets.map((a) => {
                  const url = a.file_url || "";
                  const thumb = a?.metadata?.thumbnail_url || "";
                  const row = getAssetRow(a.id);

                  const filenameVal = row.filename ?? a.filename ?? "";
                  const tagsVal =
                    row.tagsStr ?? (Array.isArray(a.tags) && a.tags.length ? a.tags.join(", ") : "");
                  const thumbVal = row.thumbStr ?? thumb;

                  return (
                    <tr key={a.id} className="border-b dark:border-gray-800 align-top">
                      <td className="py-2 px-3">
                        <div className="w-[260px] max-w-full">
                          <audio controls className="w-full">
                            <source src={url} />
                          </audio>
                        </div>
                        <div className="mt-2 text-[11px] opacity-60">id: {a.id}</div>
                      </td>

                      <td className="py-2 px-3 min-w-[240px]">
                        <input
                          className="w-full dark:bg-gray-800 text-xs rounded-lg px-2 py-1 border border-gray-200 dark:border-gray-700"
                          value={filenameVal}
                          onChange={(e) => setAssetRow(a.id, { filename: e.target.value })}
                          placeholder="filename.mp3"
                        />
                      </td>

                      <td className="py-2 px-3 min-w-[220px]">
                        <div className="flex items-center gap-2">
                          {thumbVal ? (
                            <img src={thumbVal} className="w-10 h-10 object-cover rounded" alt="" />
                          ) : (
                            <div className="w-10 h-10 rounded bg-gray-200 dark:bg-gray-800" />
                          )}
                          <input
                            className="w-full dark:bg-gray-800 text-xs rounded-lg px-2 py-1 border border-gray-200 dark:border-gray-700"
                            value={thumbVal}
                            onChange={(e) => setAssetRow(a.id, { thumbStr: e.target.value })}
                            placeholder="https://.../thumb.webp (optional)"
                          />
                        </div>
                      </td>

                      <td className="py-2 px-3 min-w-[260px]">
                        <input
                          className="w-full dark:bg-gray-800 text-xs rounded-lg px-2 py-1 border border-gray-200 dark:border-gray-700"
                          value={tagsVal}
                          onChange={(e) => setAssetRow(a.id, { tagsStr: e.target.value })}
                          placeholder="comma, tags"
                        />
                      </td>

                      <td className="py-2 px-3 max-w-[420px]">
                        <div className="truncate">{url}</div>
                        <div className="mt-1 flex gap-3 flex-wrap">
                          <CopyBtn text={url} label="Copy URL" />
                          {thumbVal ? <CopyBtn text={thumbVal} label="Copy Thumb" /> : null}
                        </div>
                      </td>

                      <td className="py-2 px-3 space-y-2 min-w-[160px]">
                        <button
                          type="button"
                          className="px-3 py-1 rounded-lg bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700"
                          onClick={() => saveAsset(a)}
                        >
                          Save
                        </button>
                        <button
                          type="button"
                          className="px-3 py-1 rounded-lg bg-red-600 text-white text-xs font-semibold hover:bg-red-700"
                          onClick={() => deleteAsset(a)}
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  );
                })
              ) : (
                <tr>
                  <td className="py-6 px-3 opacity-70" colSpan={6}>
                    No audio uploads found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* POSTS LIST */}
      <div className="mt-10">
        <div className="flex items-center justify-between gap-3 flex-wrap">
          <h3 className="font-semibold mb-1">Media Posts (what appears on /media)</h3>
          <div className="text-xs opacity-70">Audio posts only (mp3/wav audio_url OR external media_url).</div>
        </div>

        <div className="grid grid-cols-1 gap-5 mt-3">
          {filteredPosts.length === 0 ? (
            <div className="rounded-2xl border border-gray-200 dark:border-gray-800 p-8 text-center bg-white/70 dark:bg-gray-900/50">
              <div className="text-lg font-bold">No media posts yet</div>
              <div className="opacity-80 mt-2">Upload a track above to auto-create one.</div>
              <div className="opacity-70 mt-1 text-sm">
                If uploads show under ‚ÄúRecent Audio Uploads‚Äù but not here, the <b>posts insert</b> is failing (likely RLS
                or schema mismatch).
              </div>
            </div>
          ) : (
            filteredPosts.map((p) => {
              const row = getRow(p);
              const quick = getQuick(p);

              const audioUrl = (row?.metaQuick?.audio_url ?? quick.audio_url ?? "").trim();
              const mediaUrl = (row?.metaQuick?.media_url ?? quick.media_url ?? "").trim();
              const effective = audioUrl || mediaUrl;

              const thumb = extractThumbFromPost(p, row);
              const showThumb = !!thumb && !!effective;

              return (
                <div
                  key={p.id}
                  className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm p-5 md:p-6"
                >
                  <div className="flex flex-col md:flex-row gap-4 md:items-start md:justify-between">
                    <div className="flex gap-4 items-start">
                      <div className="w-16 h-16 rounded-2xl overflow-hidden bg-gray-200 dark:bg-gray-800 flex items-center justify-center text-[10px] text-gray-500">
                        {showThumb ? <img src={thumb} className="w-full h-full object-cover" alt="" /> : "audio"}
                      </div>

                      <div>
                        <div className="flex flex-wrap gap-2">
                          {quick.media_type ? <MiniChip>{quick.media_type}</MiniChip> : null}
                          {quick.platform ? <MiniChip>{quick.platform}</MiniChip> : null}
                          {quick.duration ? <MiniChip>{quick.duration}</MiniChip> : null}
                          {quick.book ? <MiniChip>{quick.book}</MiniChip> : null}
                        </div>

                        <div className="mt-2 text-xl font-bold">{row.title ?? p.title}</div>
                        <div className="text-xs opacity-70 mt-1">/media/{row.slug ?? p.slug}</div>
                      </div>
                    </div>

                    <div className="flex gap-2 flex-wrap">
                      <a
                        className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/30 text-sm font-semibold"
                        href={`/media/${row.slug ?? p.slug}`}
                        target="_blank"
                        rel="noreferrer"
                      >
                        View
                      </a>
                      <button
                        className="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700"
                        onClick={() => save(p)}
                        type="button"
                      >
                        Save
                      </button>
                      <button
                        className="px-4 py-2 rounded-xl bg-red-600 text-white text-sm font-semibold hover:bg-red-700"
                        onClick={() => remove(p.id)}
                        type="button"
                      >
                        Delete
                      </button>
                    </div>
                  </div>

                  {effective && isAudioFile(effective) ? (
                    <div className="mt-4 rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/60 dark:bg-gray-950/20 p-3">
                      <div className="text-[10px] opacity-70 mb-1">Preview</div>
                      <audio controls className="w-full">
                        <source src={effective} />
                      </audio>
                      <div className="mt-2 flex gap-3 flex-wrap">
                        <CopyBtn text={effective} label="Copy audio_url" />
                        {thumb ? <CopyBtn text={thumb} label="Copy thumbnail" /> : null}
                      </div>
                    </div>
                  ) : effective ? (
                    <div className="mt-4 text-sm">
                      <div className="text-xs opacity-70">External media</div>
                      <a className="underline" href={effective} target="_blank" rel="noreferrer">
                        Open link ‚Üí
                      </a>
                    </div>
                  ) : (
                    <div className="mt-4 text-sm opacity-70">No audio_url/media_url set yet.</div>
                  )}

                  <div className="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                      <label className="block text-[10px] opacity-70">Title</label>
                      <input
                        className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                        value={row.title ?? p.title ?? ""}
                        onChange={(e) => setRow(p.id, { title: e.target.value })}
                      />
                    </div>

                    <div>
                      <label className="block text-[10px] opacity-70">Slug</label>
                      <input
                        className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                        value={row.slug ?? p.slug ?? ""}
                        onChange={(e) => setRow(p.id, { slug: e.target.value })}
                      />
                    </div>

                    <div>
                      <label className="block text-[10px] opacity-70">Thumbnail URL (optional)</label>
                      <input
                        className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                        value={
                          postsCols.thumbnail_url
                            ? row.thumbnail_url ?? p.thumbnail_url ?? quick.thumbnail_url ?? ""
                            : row.featured_image ?? p.featured_image ?? quick.thumbnail_url ?? ""
                        }
                        onChange={(e) => {
                          const v = e.target.value;
                          if (postsCols.thumbnail_url) setRow(p.id, { thumbnail_url: v });
                          else if (postsCols.featured_image) setRow(p.id, { featured_image: v });
                          else setRowQuick(p.id, { thumbnail_url: v }); // metadata-only fallback
                        }}
                        placeholder="https://.../thumb.webp"
                      />
                      <div className="text-[10px] opacity-60 mt-1">
                        Stored in <code>metadata.thumbnail_url</code> always. Column write is auto-detected.
                      </div>
                    </div>

                    <div className="md:col-span-3">
                      <label className="block text-[10px] opacity-70">Quick Metadata</label>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
                        <select
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          value={row?.metaQuick?.media_type ?? quick.media_type}
                          onChange={(e) => setRowQuick(p.id, { media_type: e.target.value })}
                        >
                          <option value="">Media Type</option>
                          {MEDIA_TYPES.map((t) => (
                            <option key={t} value={t}>
                              {t}
                            </option>
                          ))}
                        </select>

                        <select
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          value={row?.metaQuick?.platform ?? quick.platform}
                          onChange={(e) => setRowQuick(p.id, { platform: e.target.value })}
                        >
                          <option value="">Platform</option>
                          {PLATFORMS.map((t) => (
                            <option key={t} value={t}>
                              {t}
                            </option>
                          ))}
                        </select>

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          placeholder="duration e.g. 2:45"
                          value={row?.metaQuick?.duration ?? quick.duration}
                          onChange={(e) => setRowQuick(p.id, { duration: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700 md:col-span-2"
                          placeholder="audio_url (mp3/wav only)"
                          value={row?.metaQuick?.audio_url ?? quick.audio_url}
                          onChange={(e) => setRowQuick(p.id, { audio_url: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          placeholder="media_url (YouTube/Spotify/etc.)"
                          value={row?.metaQuick?.media_url ?? quick.media_url}
                          onChange={(e) => setRowQuick(p.id, { media_url: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          placeholder="IP (book/universe)"
                          value={row?.metaQuick?.book ?? quick.book}
                          onChange={(e) => setRowQuick(p.id, { book: e.target.value, universe: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          placeholder="scene"
                          value={row?.metaQuick?.scene ?? quick.scene}
                          onChange={(e) => setRowQuick(p.id, { scene: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                          placeholder="mood"
                          value={row?.metaQuick?.mood ?? quick.mood}
                          onChange={(e) => setRowQuick(p.id, { mood: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700 md:col-span-3"
                          placeholder="tags (comma-separated)"
                          value={row?.metaQuick?.tags ?? quick.tags}
                          onChange={(e) => setRowQuick(p.id, { tags: e.target.value })}
                        />

                        <input
                          className="w-full dark:bg-gray-800 text-sm rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700 md:col-span-3"
                          placeholder="thumbnail_url (optional) ‚Äî stored in metadata"
                          value={row?.metaQuick?.thumbnail_url ?? quick.thumbnail_url}
                          onChange={(e) => setRowQuick(p.id, { thumbnail_url: e.target.value })}
                        />
                      </div>
                    </div>

                    <div className="md:col-span-3">
                      <label className="block text-[10px] opacity-70">Metadata JSON (advanced)</label>
                      <textarea
                        className="w-full h-32 dark:bg-gray-800 text-[11px] rounded-xl px-3 py-2 border border-gray-200 dark:border-gray-700"
                        value={row.metadataStr ?? JSON.stringify(p.metadata || {}, null, 2)}
                        onChange={(e) => setRow(p.id, { metadataStr: e.target.value })}
                      />
                      <div className="mt-2 text-[10px] opacity-60">
                        Save merges Quick Metadata + JSON. <b>audio_url is enforced to mp3/wav.</b>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/MultiUploader.js  (size=7561 bytes) =====
// components/admin/MultiUploader.js
import { useState, useCallback } from 'react';
import axios from 'axios';
import { supabase } from '@/lib/supabase';

function extFromName(name = '') {
  const m = String(name).split('.').pop();
  return (m || '').toLowerCase();
}

function logicalTypeFromExt(ext) {
  if (['jpg','jpeg','png','webp','gif','svg','heic','heif'].includes(ext)) return 'image';
  if (['mp4','mov','m4v','webm'].includes(ext)) return 'video';
  if (['mp3','wav'].includes(ext)) return 'audio';
  if (ext === 'pdf') return 'pdf';
  return 'file';
}

function acceptFor(localType) {
  switch (localType) {
    case 'image': return 'image/*';
    case 'video': return 'video/*';
    case 'audio': return 'audio/*';
    case 'pdf':   return 'application/pdf';
    default:      return '*/*';
  }
}

function MultiUploader({
  division = 'site',
  purpose = 'general',
  fileType = 'image',     // default UI selection
  metadata = {},
  onUploaded,
}) {
  const [busy, setBusy] = useState(false);
  const [dndOver, setDndOver] = useState(false);
  const [localPurpose, setLocalPurpose] = useState(purpose);
  const [localDivision, setLocalDivision] = useState(division);
  const [localType, setLocalType] = useState(fileType);

  // how many files per request to avoid 413s
  const BATCH_SIZE = 2;

  async function fileToPayload(file) {
    const base64Full = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const base64Only = base64Full.includes('base64,')
      ? base64Full.split('base64,').pop()
      : base64Full;

    const ext = extFromName(file?.name || '');
    // Prefer the explicit dropdown selection, otherwise infer from extension
    const inferredType = logicalTypeFromExt(ext);
    const fileTypeToSend = localType || inferredType || 'file';
    const contentTypeToSend = file?.type || (
      ext === 'pdf' ? 'application/pdf' :
      inferredType === 'image' ? 'image/*' :
      inferredType === 'video' ? 'video/*' :
      inferredType === 'audio' ? 'audio/*' : 'application/octet-stream'
    );

    return {
      name: file.name,
      data: base64Only,
      // Hints for the API (it will still sanitize/validate):
      fileType: fileTypeToSend,       // 'image' | 'video' | 'audio' | 'pdf' | 'file'
      contentType: contentTypeToSend, // e.g. 'image/jpeg', 'application/pdf'
    };
  }

  async function uploadBatch({ token, filesChunk }) {
    const encodedFiles = [];
    for (const f of filesChunk) {
      const payloadPiece = await fileToPayload(f);
      encodedFiles.push(payloadPiece);
    }

    const resp = await axios.post(
      '/api/admin/upload-asset-multi',
      {
        files: encodedFiles,
        division: localDivision,
        purpose: localPurpose,
        metadata,
      },
      {
        headers: token ? { Authorization: `Bearer ${token}` } : {},
      }
    );

    return resp.data || { ok: false, items: [], errors: [] };
  }

  const uploadFiles = async (files) => {
    if (!files?.length) return;
    setBusy(true);

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token || null;

      const allFiles = [...files];
      const batches = [];
      for (let i = 0; i < allFiles.length; i += BATCH_SIZE) {
        batches.push(allFiles.slice(i, i + BATCH_SIZE));
      }

      const allItems = [];
      const allErrors = [];

      for (const chunk of batches) {
        try {
          const { ok, items = [], errors = [] } = await uploadBatch({
            token,
            filesChunk: chunk,
          });
          allItems.push(...items);
          allErrors.push(...errors);
        } catch (batchErr) {
          const serverMsg = batchErr?.response?.data?.error || batchErr.message;
          for (const f of chunk) {
            allErrors.push({
              name: f?.name || '(unknown)',
              reason: serverMsg || 'batch failed',
            });
          }
        }
      }

      const successCount = allItems.length;
      const errorCount = allErrors.length;

      if (errorCount === 0) {
        alert(`Upload complete. ${successCount} file(s) uploaded.`);
      } else {
        const errLines = allErrors
          .slice(0, 8)
          .map((e) => `‚Ä¢ ${e.name}: ${e.reason}`)
          .join('\n');
        alert(
          `Uploaded ${successCount} file(s), ${errorCount} failed:\n${errLines}${allErrors.length > 8 ? '\n‚Ä¶' : ''}`
        );
      }

      onUploaded?.({ ok: errorCount === 0, items: allItems, errors: allErrors });
    } catch (e) {
      const serverMsg = e?.response?.data?.error || e.message;
      alert(`Upload failed: ${serverMsg}`);
    } finally {
      setBusy(false);
      setDndOver(false);
    }
  };

  const onDrop = useCallback((e) => {
    e.preventDefault();
    setDndOver(false);
    const files = [...(e.dataTransfer?.files || [])];
    uploadFiles(files);
  }, []);

  return (
    <div
      onDragOver={(e) => {
        e.preventDefault();
        setDndOver(true);
      }}
      onDragLeave={() => setDndOver(false)}
      onDrop={onDrop}
      className={`rounded border-2 border-dashed p-4 ${
        dndOver
          ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
          : 'border-gray-300 dark:border-gray-700'
      }`}
    >
      <div className="flex flex-wrap gap-3 mb-3">
        <select
          value={localDivision}
          onChange={(e) => setLocalDivision(e.target.value)}
          className="dark:bg-gray-900"
        >
          {['site','publishing','designs','capital','tech','media','realty'].map((d) => (
            <option key={d} value={d}>{d}</option>
          ))}
        </select>

        <select
          value={localPurpose}
          onChange={(e) => setLocalPurpose(e.target.value)}
          className="dark:bg-gray-900"
        >
          <option value="general">general</option>
          <option value="hero">hero</option>
          <option value="carousel">carousel</option>
          <option value="gallery">gallery</option>
          <option value="pdf">pdf</option>
        </select>

        <select
          value={localType}
          onChange={(e) => setLocalType(e.target.value)}
          className="dark:bg-gray-900"
        >
          <option value="image">image</option>
          <option value="video">video</option>
          <option value="audio">audio</option>
          <option value="pdf">pdf</option>
          <option value="file">file</option>
        </select>

        <label className="ml-auto inline-flex items-center gap-2 px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 cursor-pointer">
          <input
            type="file"
            multiple
            accept={acceptFor(localType)}
            className="hidden"
            onChange={(e) => uploadFiles([...e.target.files])}
          />
          Choose files‚Ä¶
        </label>
      </div>

      <p className="text-sm opacity-80">
        Drag & drop files here (multi-upload supported). They‚Äôll go to{' '}
        <b>{localDivision}</b> / <b>{localPurpose}</b>.
      </p>

      {busy && <p className="mt-2 text-sm">Uploading‚Ä¶</p>}
    </div>
  );
}

export default MultiUploader;


===== FILE: components/admin/OverviewTab.js  (size=3254 bytes) =====
// components/admin/OverviewTab.js
import React, { useMemo } from 'react';
import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from 'recharts';
import SectionCard from '@/components/admin/SectionCard';
import { currency, isWithinLastDays } from '@/lib/adminUtils';

export default function OverviewTab({ orders, subscriptions, users }) {
  const kpis = useMemo(() => {
    const last30Orders = orders.filter((o) =>
      isWithinLastDays(o.created_at, 30)
    );
    const revenueL30 = last30Orders.reduce(
      (acc, o) => acc + Number(o.total_amount || 0),
      0
    );
    const ordersL30 = last30Orders.length;
    const subsActive = subscriptions.filter(
      (s) => (s.status || '').toLowerCase() === 'active'
    ).length;
    return {
      revenueL30,
      ordersL30,
      subsActive,
      users: users.length,
    };
  }, [orders, subscriptions, users]);

  const revenueByDivision = useMemo(() => {
    const map = {};
    orders.forEach((o) => {
      if (!isWithinLastDays(o.created_at, 30)) return;
      const d = (o.division || 'site').toLowerCase();
      map[d] = (map[d] || 0) + Number(o.total_amount || 0);
    });
    return Object.entries(map).map(([division, total]) => ({
      division,
      total,
    }));
  }, [orders]);

  return (
    <>
      <SectionCard title="Key Metrics (Last 30 Days)">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Revenue</div>
            <div className="text-2xl font-bold">
              {currency(kpis.revenueL30)}
            </div>
          </div>

          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Orders</div>
            <div className="text-2xl font-bold">{kpis.ordersL30}</div>
          </div>

          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Active Subs</div>
            <div className="text-2xl font-bold">{kpis.subsActive}</div>
          </div>

          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Users</div>
            <div className="text-2xl font-bold">{kpis.users}</div>
          </div>
        </div>
      </SectionCard>

      <SectionCard title="Revenue by Division (Last 30 Days)">
        {revenueByDivision.length === 0 ? (
          <p className="opacity-70">No orders in the last 30 days.</p>
        ) : (
          <div className="w-full h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={revenueByDivision}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="division" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="total" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        )}
      </SectionCard>
    </>
  );
}


===== FILE: components/admin/PropertyForm.js  (size=2257 bytes) =====
// components/admin/PropertyForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { safeJSON } from '@/lib/adminUtils';

function PropertyForm({ onCreated }) {
  const [name, setName] = useState('');
  const [slug, setSlug] = useState('');
  const [description, setDescription] = useState('');
  const [price, setPrice] = useState('200');
  const [metadataStr, setMetadataStr] = useState('');

  const create = async () => {
    try {
      if (!name || !slug) return alert('Name and slug required.');
      const metadata = safeJSON(metadataStr, {});
      const payload = {
        name,
        slug,
        description,
        price: Number(price || 0),
        division: 'realty',
        status: 'active',
        metadata,
      };
      const { error } = await supabase.from('properties').insert(payload);
      if (error) throw error;
      setName('');
      setSlug('');
      setDescription('');
      setPrice('200');
      setMetadataStr('');
      onCreated?.();
      alert('Property created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Realty ‚Äî Add Property">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input placeholder="Name" value={name} onChange={(e) => setName(e.target.value)} />
        <input placeholder="Slug" value={slug} onChange={(e) => setSlug(e.target.value)} />
        <input placeholder="Nightly Price" type="number" value={price} onChange={(e) => setPrice(e.target.value)} />
        <textarea className="md:col-span-3" placeholder="Description" value={description} onChange={(e) => setDescription(e.target.value)} />
        <textarea className="md:col-span-3" placeholder='Metadata JSON e.g. {"location":"Big Bear, CA", "ical_urls":["https://airbnb.com/ical/xxx"]}' value={metadataStr} onChange={(e) => setMetadataStr(e.target.value)} />
        <button type="button" onClick={create} className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white">
          Create Property
        </button>
      </div>
    </SectionCard>
  );
}

export default PropertyForm;


===== FILE: components/admin/PropertyRatesPanel.js  (size=4549 bytes) =====
// components/admin/PropertyRatesPanel.js
import { useState, useEffect } from 'react';

function PropertyRatesPanel({ properties }) {
  const [selected, setSelected] = useState('');
  return (
    <div className="glass p-4 rounded">
      <div className="flex items-center gap-3 mb-3">
        <select
          className="dark:bg-gray-900"
          value={selected}
          onChange={(e)=>setSelected(e.target.value)}
        >
          <option value="">Select property‚Ä¶</option>
          {properties.map(p => (
            <option key={p.id} value={p.id}>{p.name}</option>
          ))}
        </select>
      </div>
      {selected ? <RealtyRatesManager propertyId={selected} /> : <p className="opacity-70 text-sm">Choose a property to manage seasonal rates.</p>}
    </div>
  );
}

function RealtyRatesManager({ propertyId }) {
  const [items, setItems] = useState([]);
  const [form, setForm] = useState({
    start_date: '',
    end_date: '',
    nightly_rate: '',
    min_nights: '',
    priority: 0,
    notes: '',
  });
  const load = async () => {
    if (!propertyId) return;
    const r = await fetch(`/api/realty/rates?property_id=${encodeURIComponent(propertyId)}`);
    const j = await r.json();
    setItems(j.items || []);
  };
  useEffect(() => { load(); }, [propertyId]);

  const add = async () => {
    if (!form.start_date || !form.end_date || !form.nightly_rate) {
      alert('Start, end and nightly rate are required');
      return;
    }
    const r = await fetch('/api/realty/rates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ property_id: propertyId, ...form }),
    });
    const j = await r.json();
    if (!j.ok) return alert(j.error || 'Failed');
    setForm({ start_date: '', end_date: '', nightly_rate: '', min_nights: '', priority: 0, notes: '' });
    load();
  };
  const delItem = async (id) => {
    if (!confirm('Delete rate?')) return;
    const r = await fetch(`/api/realty/rates?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
    const j = await r.json();
    if (!j.ok) return alert(j.error || 'Failed');
    load();
  };

  return (
    <div className="mt-6 glass p-4 rounded">
      <h3 className="font-semibold mb-3">Seasonal / Holiday Rates</h3>
      <div className="grid grid-cols-1 md:grid-cols-6 gap-2">
        <input type="date" value={form.start_date} onChange={(e)=>setForm({...form,start_date:e.target.value})} />
        <input type="date" value={form.end_date} onChange={(e)=>setForm({...form,end_date:e.target.value})} />
        <input type="number" placeholder="Nightly $" value={form.nightly_rate} onChange={(e)=>setForm({...form,nightly_rate:e.target.value})}/>
        <input type="number" placeholder="Min nights" value={form.min_nights} onChange={(e)=>setForm({...form,min_nights:e.target.value})}/>
        <input type="number" placeholder="Priority (higher wins)" value={form.priority} onChange={(e)=>setForm({...form,priority:e.target.value})}/>
        <input placeholder="Notes" value={form.notes} onChange={(e)=>setForm({...form,notes:e.target.value})}/>
      </div>
      <button className="mt-3 px-3 py-2 rounded bg-blue-600 text-white" onClick={add}>Add Rate</button>

      <div className="mt-4 overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-800">
              <th className="py-2">Dates</th><th>Nightly</th><th>Min</th><th>Priority</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {items.map(r => (
              <tr key={r.id} className="border-b dark:border-gray-900">
                <td className="py-2">{r.start_date} ‚Üí {r.end_date}</td>
                <td className="py-2">${Number(r.nightly_rate).toFixed(2)}</td>
                <td className="py-2">{r.min_nights ?? '‚Äî'}</td>
                <td className="py-2">{r.priority ?? 0}</td>
                <td className="py-2">{r.notes || '‚Äî'}</td>
                <td className="py-2">
                  <button className="text-red-600" onClick={()=>delItem(r.id)}>Delete</button>
                </td>
              </tr>
            ))}
            {items.length === 0 && <tr><td colSpan={6} className="py-4 opacity-70">No overrides yet.</td></tr>}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default PropertyRatesPanel;


===== FILE: components/admin/PublishingProductForm.js  (size=7250 bytes) =====
// components/admin/PublishingProductForm.js
import { useState } from 'react';
import axios from 'axios';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { toArrayTags } from '@/lib/adminUtils';

function PublishingProductForm({ onCreated }) {
  const [name, setName] = useState('');
  const [price, setPrice] = useState('9.99');
  const [description, setDescription] = useState('');
  const [coverUrl, setCoverUrl] = useState('');
  const [tagsStr, setTagsStr] = useState('fantasy, lohc');
  const [amazonUrl, setAmazonUrl] = useState('');
  const [paperbackUrl, setPaperbackUrl] = useState('');
  const [kindleUrl, setKindleUrl] = useState('');
  const [hardcoverUrl, setHardcoverUrl] = useState('');
  const [pdfUrl, setPdfUrl] = useState('');
  const [format, setFormat] = useState('ebook');
  const [year, setYear] = useState(2025);
  const [primaryStore, setPrimaryStore] = useState('amazon');

  const uploadCover = async (file) => {
    if (!file) return;
    const base64 = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result).split(',')[1] || '');
      r.onerror = reject;
      r.readAsDataURL(file);
    });
    const {
      data: { session },
    } = await supabase.auth.getSession();
    const token = session?.access_token;
    const res = await axios.post(
      '/api/admin/upload-asset',
      {
        file: { data: base64, name: file.name },
        file_type: 'image',
        division: 'publishing',
        purpose: 'general',
        metadata: { type: 'book_cover', year },
      },
      { headers: token ? { Authorization: `Bearer ${token}` } : {} }
    );
    if (res.data?.file_url) setCoverUrl(res.data.file_url);
  };

  const create = async () => {
    try {
      if (!name) return alert('Title required.');
      if (!coverUrl) return alert('Cover image URL required (upload or paste).');

      const numericYear = Number(year);
      const numericPrice = Number(price || 0);

      const metadata = {
        amazon_url: amazonUrl || undefined,
        paperback_url: paperbackUrl || undefined,
        kindle_url: kindleUrl || undefined,
        hardcover_url: hardcoverUrl || undefined,
        pdf_url: pdfUrl || undefined,
        format,
        year: Number.isFinite(numericYear) ? numericYear : undefined,
        primary_store: primaryStore,
      };

      const payload = {
        name,
        price: Number.isFinite(numericPrice) ? numericPrice : 0,
        division: 'publishing',
        description,
        display_image: coverUrl,
        thumbnail_url: coverUrl,
        status: 'active',
        tags: toArrayTags(tagsStr),
        metadata,
        // ‚õîÔ∏è DO NOT SEND productType ‚Äî it is not a column in `products`
      };

      // Supabase prefers an array for inserts; select().single() is optional but convenient
      const { error } = await supabase.from('products').insert([payload]).select().single();
      if (error) throw error;

      // reset form
      setName('');
      setPrice('9.99');
      setDescription('');
      setCoverUrl('');
      setAmazonUrl('');
      setPaperbackUrl('');
      setKindleUrl('');
      setHardcoverUrl('');
      setPdfUrl('');
      setFormat('ebook');
      setYear(2025);
      setTagsStr('');
      setPrimaryStore('amazon');

      onCreated?.();
      alert('Publishing product created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Publishing ‚Äî Add Book (Amazon links + sample PDF)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Book Title"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Internal Price (optional)"
          type="number"
          value={price}
          onChange={(e) => setPrice(e.target.value)}
        />
        <select value={format} onChange={(e) => setFormat(e.target.value)}>
          <option value="ebook">ebook</option>
          <option value="paperback">paperback</option>
          <option value="hardcover">hardcover</option>
        </select>

        <input
          placeholder="Cover Image URL"
          className="md:col-span-2"
          value={coverUrl}
          onChange={(e) => setCoverUrl(e.target.value)}
        />
        <label className="inline-flex items-center gap-2 px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 cursor-pointer">
          <input
            type="file"
            accept="image/*"
            className="hidden"
            onChange={(e) => uploadCover(e.target.files?.[0])}
          />
          Upload Cover‚Ä¶
        </label>

        <textarea
          className="md:col-span-3"
          placeholder="Description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
        />
        <input
          className="md:col-span-3"
          placeholder="Tags (comma-separated)"
          value={tagsStr}
          onChange={(e) => setTagsStr(e.target.value)}
        />

        <input
          className="md:col-span-3"
          placeholder="Amazon (general product) URL"
          value={amazonUrl}
          onChange={(e) => setAmazonUrl(e.target.value)}
        />
        <input
          placeholder="Amazon Paperback URL"
          value={paperbackUrl}
          onChange={(e) => setPaperbackUrl(e.target.value)}
        />
        <input
          placeholder="Amazon Kindle URL"
          value={kindleUrl}
          onChange={(e) => setKindleUrl(e.target.value)}
        />
        <input
          placeholder="Amazon Hardcover URL"
          value={hardcoverUrl}
          onChange={(e) => setHardcoverUrl(e.target.value)}
        />

        <input
          className="md:col-span-2"
          placeholder="Sample PDF URL (Chapter 1)"
          value={pdfUrl}
          onChange={(e) => setPdfUrl(e.target.value)}
        />
        <input
          placeholder="Year"
          type="number"
          value={year}
          onChange={(e) => setYear(e.target.value)}
        />

        <div className="md:col-span-3 flex items-center gap-3">
          <label>Primary Store Button:</label>
          <select
            value={primaryStore}
            onChange={(e) => setPrimaryStore(e.target.value)}
            className="dark:bg-gray-900"
          >
            <option value="amazon">Amazon (auto)</option>
            <option value="paperback">Paperback</option>
            <option value="kindle">Kindle</option>
            <option value="hardcover">Hardcover</option>
            <option value="pdf">PDF (sample)</option>
          </select>

          <button
            type="button"
            onClick={create}
            className="ml-auto px-4 py-2 rounded bg-blue-600 text-white"
          >
            Create Book
          </button>
        </div>
      </div>
    </SectionCard>
  );
}

export default PublishingProductForm;


===== FILE: components/admin/PublishingTab.js  (size=15669 bytes) =====
// components/admin/PublishingTab.js
import React, { useMemo, useState } from 'react';
import PublishingProductForm from '@/components/admin/PublishingProductForm';
import SectionCard from '@/components/admin/SectionCard';
import {
  toArrayTags,
  safeJSON,
  updateProduct,
  deleteProduct,
} from '@/lib/adminUtils';

const extractMetaFields = (m = {}) => ({
  // ‚úÖ Added (requested)
  universe_id: m.universe_id || '',
  stripe_price_id: m.stripe_price_id || '',

  // existing
  amazon_url:    m.amazon_url || '',
  kindle_url:    m.kindle_url || '',
  paperback_url: m.paperback_url || '',
  store_url:     m.store_url || '',
  pdf_url:       m.pdf_url || '',
  format:        m.format || '',
  year:          m.year ?? '',
});

export default function PublishingTab({ products: allProducts, refreshAll }) {
  const [edits, setEdits] = useState({});
  const publishingProducts = useMemo(
    () => allProducts.filter((p) => p.division === 'publishing'),
    [allProducts]
  );

  const buildPayload = (row, p) => {
    const payload = {
      ...(row.display_image !== undefined
        ? { display_image: row.display_image, thumbnail_url: row.display_image }
        : {}),
      ...(row.price !== undefined ? { price: parseFloat(row.price || 0) } : {}),
      ...(row.description !== undefined ? { description: row.description } : {}),
      ...(row.tagsStr !== undefined ? { tags: toArrayTags(row.tagsStr) } : {}),
    };

    // Merge metadata from quick fields + raw JSON (if user edited it)
    const currentMeta = p.metadata || {};
    const quick = row.metaQuick || {};

    // ‚úÖ Guardrail: prevent accidental bleed from offers into books
    // (Offers use tier/access_tier/required_tier; Publishing should not.)
    const quickSanitized = { ...quick };
    if (quickSanitized?.tier !== undefined) delete quickSanitized.tier;
    if (quickSanitized?.access_tier !== undefined) delete quickSanitized.access_tier;
    if (quickSanitized?.required_tier !== undefined) delete quickSanitized.required_tier;

    // ‚úÖ Validate Stripe price id format (optional but smart)
    if (
      quickSanitized?.stripe_price_id &&
      !String(quickSanitized.stripe_price_id).startsWith('price_')
    ) {
      throw new Error('stripe_price_id should start with "price_"');
    }

    const mergedQuick = {
      ...currentMeta,
      ...quickSanitized,
      // normalize simple fields
      ...(quickSanitized.year !== undefined && quickSanitized.year !== ''
        ? { year: Number(quickSanitized.year) }
        : {}),
      ...(quickSanitized.format !== undefined ? { format: quickSanitized.format } : {}),
    };

    // If user typed JSON manually, it wins. Otherwise use mergedQuick.
    if (row.metadataStr !== undefined) {
      payload.metadata = safeJSON(row.metadataStr, mergedQuick);
    } else if (Object.keys(quickSanitized).length) {
      payload.metadata = mergedQuick;
    }

    return payload;
  };

  const save = async (p) => {
    try {
      const row = edits[p.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, p);
      await updateProduct(p.id, payload);
      setEdits((prev) => ({ ...prev, [p.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Publishing Division">
      <PublishingProductForm onCreated={refreshAll} />

      <div className="mt-6">
        <h3 className="font-semibold mb-3">Books</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Cover</th>
                <th>Title</th>
                <th>Display Image</th>
                <th>Price</th>
                <th>Tags</th>
                <th>Description</th>
                <th>Quick Metadata</th>
                <th>Raw Metadata JSON</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {publishingProducts.map((p) => {
                const row = edits[p.id] || {};
                const prettyMeta = JSON.stringify(p.metadata || {}, null, 2);
                const quickDefaults = extractMetaFields(p.metadata || {});
                const quick = { ...quickDefaults, ...(row.metaQuick || {}) };

                return (
                  <tr key={p.id} className="border-b dark:border-gray-800 align-top">
                    <td className="py-2">
                      {p.thumbnail_url || p.display_image ? (
                        <img
                          src={p.thumbnail_url || p.display_image}
                          className="w-14 h-14 object-cover rounded"
                          alt=""
                        />
                      ) : '‚Äî'}
                    </td>

                    <td className="py-2 min-w-[160px]">{p.name}</td>

                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="display_image / thumbnail_url"
                        value={row.display_image ?? p.display_image ?? p.thumbnail_url ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, display_image: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[100px]">
                      <input
                        type="number"
                        className="w-full dark:bg-gray-800"
                        placeholder={String(p.price ?? '')}
                        value={row.price ?? (p.price ?? '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, price: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="comma,separated,tags"
                        value={row.tagsStr ?? (Array.isArray(p.tags) ? p.tags.join(', ') : '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, tagsStr: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[260px]">
                      <textarea
                        className="w-full h-24 dark:bg-gray-800"
                        value={row.description ?? p.description ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, description: e.target.value },
                          }))
                        }
                      />
                    </td>

                    {/* Quick Metadata fields */}
                    <td className="py-2 min-w-[320px]">
                      <div className="grid grid-cols-1 gap-2">
                        {/* ‚úÖ Added */}
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="universe_id (optional, UUID)"
                          value={quick.universe_id}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, universe_id: e.target.value },
                              },
                            }))
                          }
                        />

                        {/* ‚úÖ Added */}
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="stripe_price_id (optional) e.g. price_123..."
                          value={quick.stripe_price_id}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, stripe_price_id: e.target.value },
                              },
                            }))
                          }
                        />

                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="amazon_url"
                          value={quick.amazon_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, amazon_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="kindle_url"
                          value={quick.kindle_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, kindle_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="paperback_url"
                          value={quick.paperback_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, paperback_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="pdf_url (chapter preview)"
                          value={quick.pdf_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, pdf_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="store_url (optional)"
                          value={quick.store_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, store_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <div className="flex gap-2">
                          <input
                            className="w-1/2 dark:bg-gray-800"
                            placeholder="format (ebook/paperback/‚Ä¶)"
                            value={quick.format}
                            onChange={(e) =>
                              setEdits((prev) => ({
                                ...prev,
                                [p.id]: {
                                  ...row,
                                  metaQuick: { ...quick, format: e.target.value },
                                },
                              }))
                            }
                          />
                          <input
                            className="w-1/2 dark:bg-gray-800"
                            placeholder="year"
                            value={quick.year}
                            onChange={(e) =>
                              setEdits((prev) => ({
                                ...prev,
                                [p.id]: {
                                  ...row,
                                  metaQuick: { ...quick, year: e.target.value },
                                },
                              }))
                            }
                          />
                        </div>
                        <div className="text-[11px] opacity-60">
                          Tip: Paste your PDF URL here (from Assets ‚Üí Copy URL) to show a ‚ÄúPreview Chapter 1‚Äù button on the Publishing page.
                        </div>
                      </div>
                    </td>

                    {/* Raw JSON (optional) */}
                    <td className="py-2 min-w-[360px]">
                      <textarea
                        className="w-full h-36 dark:bg-gray-800"
                        placeholder='{"amazon_url":"‚Ä¶","paperback_url":"‚Ä¶","pdf_url":"‚Ä¶"}'
                        value={row.metadataStr ?? prettyMeta}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, metadataStr: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 space-x-2">
                      <button
                        className="px-3 py-1 bg-blue-600 text-white rounded"
                        onClick={() => save(p)}
                      >
                        Save
                      </button>

                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteProduct(p.id, refreshAll)}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })}

              {publishingProducts.length === 0 && (
                <tr>
                  <td colSpan={9} className="py-6 opacity-70">
                    No books yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/QuickProductForm.js  (size=9114 bytes) =====
// components/admin/QuickProductForm.js
import { useState } from 'react';
import axios from 'axios';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { toArrayTags, copyText } from '@/lib/adminUtils';

// Derive metadata from tags + title + description + thumbnail/asset
function deriveMetadata({ tags, title, description, thumbnailUrl, assetUrl }) {
  // Tags convention: [BOOKCODE, scene-code, P#, itemtype]
  const bookCode = tags[0] || '';       // e.g. "COLLAPSE"
  const sceneCode = tags[1] || '';      // e.g. "rotunda"
  const promptTag = tags[2] || 'P1';    // e.g. "P1"

  const bookMap = {
    LOHC: 'Legacy of the Hidden Clans',
    SHATTERPOINT: 'Shatterpoint Sky',
    DREAMLESS: 'Dreamless',
    NiceWorld: 'Nice World',
    TW: 'The Wandering',
    CHOICE: 'Choice',
    LAMINA: 'Lamina',
    MAGISCI: 'Magisci',
    COLLAPSE: 'Collapse',
  };

  const promptNumber =
    typeof promptTag === 'string' && promptTag.toUpperCase().startsWith('P')
      ? Number(promptTag.slice(1)) || 1
      : 1;

  const scenePretty = sceneCode ? sceneCode.replace(/-/g, ' ') : '';
  const year = new Date().getFullYear();

  return {
    book: bookCode,                          // e.g. "COLLAPSE"
    series: bookMap[bookCode] || '',         // e.g. "Collapse"
    prompt: promptNumber,                    // e.g. 1
    scene: scenePretty,                      // e.g. "rotunda"
    year,
    drop: `${bookCode || 'GEN'}_P${promptNumber}`, // e.g. "COLLAPSE_P1"
    asset_url: assetUrl || thumbnailUrl || '',
    name: title || '',
    description: description || '',
    tags, // store tags snapshot in metadata as well
  };
}

function QuickProductForm({ defaultDivision = 'designs', onCreated }) {
  const [artFile, setArtFile] = useState(null);
  const [assetUrl, setAssetUrl] = useState('');
  const [isUploading, setIsUploading] = useState(false);

  const [title, setTitle] = useState('');
  const [price, setPrice] = useState('19.99');
  const [printfulId, setPrintfulId] = useState('');
  const [thumbnailUrl, setThumbnailUrl] = useState('');
  const [description, setDescription] = useState('');
  const [tagsStr, setTagsStr] = useState('');

  const [purpose, setPurpose] = useState('general');
  const [fileType, setFileType] = useState('image');

  const doUploadAsset = async () => {
    if (!artFile) {
      alert('Choose a file first.');
      return;
    }
    setIsUploading(true);
    try {
      const base64 = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result).split(',')[1] || '');
        r.onerror = reject;
        r.readAsDataURL(artFile);
      });

      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;

      // Use current tags/title/description to seed asset metadata
      const tags = toArrayTags(tagsStr);
      const metadata = deriveMetadata({
        tags,
        title,
        description,
        thumbnailUrl,
        assetUrl: undefined,
      });

      const res = await axios.post(
        '/api/admin/upload-asset',
        {
          file: { data: base64, name: artFile.name },
          file_type: fileType,
          division: defaultDivision,
          purpose,
          metadata,
        },
        { headers: token ? { Authorization: `Bearer ${token}` } : {} }
      );
      if (res.data?.error) throw new Error(res.data.error);
      setAssetUrl(res.data.file_url || '');
      alert('Asset uploaded. URL below.');
    } catch (e) {
      alert(`Upload failed: ${e.message}`);
    } finally {
      setIsUploading(false);
    }
  };

  const doCreateProduct = async () => {
    try {
      if (!title || !price) return alert('Title and price are required.');
      if (!thumbnailUrl) return alert('Provide a thumbnail_url (mockup).');
      if (!printfulId) return alert('Printful product ID is required.');

      const tags = toArrayTags(tagsStr);
      const metadata = deriveMetadata({
        tags,
        title,
        description,
        thumbnailUrl,
        assetUrl,
      });

      const payload = {
        name: title,
        price: parseFloat(price),
        division: defaultDivision,
        description,
        thumbnail_url: thumbnailUrl,
        printful_product_id: printfulId,
        status: 'active',
        tags,
        metadata,
        // NOTE: nft_url column is left null here; you can edit it later in DesignsTab
      };

      const { error } = await supabase.from('products').insert(payload);
      if (error) throw error;

      // reset form
      setTitle('');
      setPrice('19.99');
      setPrintfulId('');
      setThumbnailUrl('');
      setDescription('');
      setTagsStr('');
      setArtFile(null);
      setAssetUrl('');

      onCreated?.();
      alert('Product created.');
    } catch (e) {
      alert(`Create product failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Quick Product (Designs) ‚Äî Upload ‚Üí Copy URL ‚Üí Create">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* 1) Upload asset */}
        <div className="md:col-span-3 border rounded p-4 dark:border-gray-700">
          <h3 className="font-semibold mb-2">1) Upload asset (optional)</h3>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
            <input
              type="file"
              onChange={(e) => setArtFile(e.target.files?.[0] || null)}
            />
            <select
              value={fileType}
              onChange={(e) => setFileType(e.target.value)}
              className="dark:bg-gray-800"
            >
              <option value="image">image</option>
              <option value="video">video</option>
              <option value="pdf">pdf</option>
            </select>
            <select
              value={purpose}
              onChange={(e) => setPurpose(e.target.value)}
              className="dark:bg-gray-800"
            >
              <option value="general">general</option>
              <option value="hero">hero</option>
              <option value="carousel">carousel</option>
            </select>
            <button
              type="button"
              onClick={doUploadAsset}
              disabled={isUploading}
              className="p-2 bg-black text-white rounded dark:bg-gray-700"
            >
              {isUploading ? 'Uploading‚Ä¶' : 'Upload ‚Üí Get URL'}
            </button>
          </div>
          {assetUrl && (
            <div className="mt-3 flex items-center gap-2">
              <input
                value={assetUrl}
                readOnly
                className="w-full dark:bg-gray-800"
              />
              <button
                type="button"
                className="px-3 py-2 bg-blue-600 text-white rounded"
                onClick={() => copyText(assetUrl)}
              >
                Copy
              </button>
            </div>
          )}
        </div>

        {/* 2) Create product */}
        <div className="md:col-span-3 border rounded p-4 dark:border-gray-700">
          <h3 className="font-semibold mb-2">2) Create product</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input
              placeholder="Title"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
            />
            <input
              placeholder="Price"
              type="number"
              value={price}
              onChange={(e) => setPrice(e.target.value)}
            />
            <input
              placeholder="Printful Product ID"
              value={printfulId}
              onChange={(e) => setPrintfulId(e.target.value)}
            />
            <input
              placeholder="thumbnail_url (mockup)"
              value={thumbnailUrl}
              onChange={(e) => setThumbnailUrl(e.target.value)}
            />
            <input
              className="md:col-span-2"
              placeholder="Description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
            <input
              className="md:col-span-2"
              placeholder="Tags (comma-separated, e.g. COLLAPSE, rotunda, P1, mug)"
              value={tagsStr}
              onChange={(e) => setTagsStr(e.target.value)}
            />
          </div>
          <div className="mt-3">
            <button
              type="button"
              onClick={doCreateProduct}
              className="p-2 bg-black text-white rounded dark:bg-gray-700"
            >
              Create Product
            </button>
          </div>
        </div>
      </div>
    </SectionCard>
  );
}

export default QuickProductForm;


===== FILE: components/admin/RealtyTab.js  (size=34461 bytes) =====
// components/admin/RealtyTab.js
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import MultiUploader from '@/components/admin/MultiUploader';
import AttachToProperty from '@/components/admin/AttachToProperty';
import PropertyRatesPanel from '@/components/admin/PropertyRatesPanel';
import RealtyTestEmailPanelWithProperty from '@/components/admin/RealtyTestEmailPanelWithProperty';
import PropertyForm from '@/components/admin/PropertyForm';
import SectionCard from '@/components/admin/SectionCard';
import { safeJSON, copyText, updateRow } from '@/lib/adminUtils';

/**
 * Small money formatter helper for table display.
 * amount_cents is stored as integer cents.
 */
function formatMoney(amount_cents, currency = 'usd') {
  if (amount_cents == null) return '‚Äî';
  const dollars = Number(amount_cents) / 100;
  return `${currency.toUpperCase()} $${dollars.toFixed(2)}`;
}

/**
 * Helper: detect expired pending reservations (15+ minutes old)
 */
function isPendingAndExpired(reservation) {
  if (!reservation || reservation.status !== 'pending') return false;
  if (!reservation.created_at) return false;

  const created = new Date(reservation.created_at);
  if (Number.isNaN(created.getTime())) return false;

  const diffMs = Date.now() - created.getTime();
  const diffMinutes = diffMs / (1000 * 60);
  return diffMinutes > 15;
}

/**
 * UpcomingStaysPanel
 * - Fetches reservations from /api/realty/reservations-admin
 * - Shows future (and recent) stays, guest info, and money
 * - Hides obviously abandoned Stripe sessions (pending > 15 minutes)
 * - Lets you manually expire any non-paid reservation
 */
function UpcomingStaysPanel() {
  const [loadingResv, setLoadingResv] = useState(true);
  const [reservations, setReservations] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const r = await fetch('/api/realty/reservations-admin');
        const j = await r.json();

        if (j.ok) {
          const raw = j.items || [];
          const pruned = raw.filter((res) => !isPendingAndExpired(res));
          setReservations(pruned);
        } else {
          console.error('reservations-admin error:', j.error);
          setReservations([]);
        }
      } catch (err) {
        console.error('reservations-admin crash:', err);
        setReservations([]);
      } finally {
        setLoadingResv(false);
      }
    })();
  }, []);

  // simple revenue sum of PAID
  const totalPaidCents = reservations
    .filter((r) => r.status === 'paid')
    .reduce((acc, r) => acc + (Number(r.amount_cents) || 0), 0);

  const handleExpire = async (resv) => {
    const label = resv.property_name || resv.id;
    const ok = window.confirm(
      `Mark this reservation as expired/cancelled?\n\n${label}\n\nThis will update the status so it no longer clutters your board.`
    );
    if (!ok) return;

    try {
      const { error } = await supabase
        .from('realty_reservations')
        .update({ status: 'expired' })
        .eq('id', resv.id);

      if (error) throw error;

      setReservations((prev) => prev.filter((r) => r.id !== resv.id));
      alert('Reservation marked as expired.');
    } catch (err) {
      alert(`Expire failed: ${err.message}`);
    }
  };

  return (
    <div className="space-y-4 mb-10">
      <h3 className="text-xl font-bold">Upcoming Stays / Revenue</h3>

      <div className="text-sm opacity-80">
        <div>
          <strong>Total Paid (all listed):</strong>{' '}
          {formatMoney(totalPaidCents, 'usd')}
        </div>
        <div className="text-[11px] opacity-60">
          Includes only reservations currently marked &quot;paid&quot;.
          Pending/abandoned sessions automatically fall off after ~15 minutes.
        </div>
      </div>

      <div className="overflow-x-auto border rounded dark:border-gray-700">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900/40">
              <th className="py-2 px-2">Property</th>
              <th className="py-2 px-2">Stay</th>
              <th className="py-2 px-2">Nights / Guests</th>
              <th className="py-2 px-2">Guest Contact</th>
              <th className="py-2 px-2">Notes</th>
              <th className="py-2 px-2 whitespace-nowrap">Total</th>
              <th className="py-2 px-2">Status</th>
              <th className="py-2 px-2">Actions</th>
            </tr>
          </thead>
          <tbody>
            {loadingResv ? (
              <tr>
                <td className="py-6 text-center opacity-70" colSpan={8}>
                  Loading reservations‚Ä¶
                </td>
              </tr>
            ) : reservations.length === 0 ? (
              <tr>
                <td className="py-6 text-center opacity-70" colSpan={8}>
                  No reservations yet.
                </td>
              </tr>
            ) : (
              reservations.map((r) => (
                <tr
                  key={r.id}
                  className="border-b dark:border-gray-800 align-top"
                >
                  {/* Property name / link */}
                  <td className="py-2 px-2 min-w-[140px]">
                    <div className="font-semibold">{r.property_name || '‚Äî'}</div>
                    {r.property_slug ? (
                      <a
                        className="text-xs text-blue-600 underline"
                        href={`/realty/${r.property_slug}`}
                        target="_blank"
                        rel="noreferrer"
                      >
                        /realty/{r.property_slug}
                      </a>
                    ) : (
                      <div className="text-[10px] opacity-50">(no slug)</div>
                    )}
                  </td>

                  {/* Dates */}
                  <td className="py-2 px-2 min-w-[140px] text-xs leading-relaxed">
                    <div>
                      <strong>Check-in:</strong> {r.checkin}
                    </div>
                    <div>
                      <strong>Check-out:</strong> {r.checkout}
                    </div>
                  </td>

                  {/* Nights / guests */}
                  <td className="py-2 px-2 min-w-[90px] text-xs leading-relaxed">
                    <div>{r.nights} nights</div>
                    <div>{r.guests} guests</div>
                  </td>

                  {/* Guest contact */}
                  <td className="py-2 px-2 min-w-[160px] text-xs leading-relaxed">
                    <div className="font-medium">{r.guest_name || '‚Äî'}</div>
                    <div className="break-words">{r.guest_email || '‚Äî'}</div>
                    {r.guest_phone ? (
                      <div className="opacity-70">{r.guest_phone}</div>
                    ) : null}
                  </td>

                  {/* Notes to host */}
                  <td className="py-2 px-2 min-w-[160px] text-xs">
                    {r.notes ? r.notes : <span className="opacity-50">‚Äî</span>}
                  </td>

                  {/* Amount */}
                  <td className="py-2 px-2 whitespace-nowrap text-xs font-semibold">
                    {formatMoney(r.amount_cents, r.currency)}
                  </td>

                  {/* Status */}
                  <td className="py-2 px-2 min-w-[80px] text-xs">
                    <span
                      className={
                        r.status === 'paid'
                          ? 'bg-green-100 text-green-800 px-2 py-1 rounded text-[11px] font-semibold'
                          : 'bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-[11px] font-semibold'
                      }
                    >
                      {r.status || '‚Äî'}
                    </span>
                    {r.status !== 'paid' && (
                      <div className="mt-1 text-[10px] opacity-70">
                        Unpaid / in-progress
                      </div>
                    )}
                  </td>

                  {/* Actions */}
                  <td className="py-2 px-2 min-w-[90px] text-xs">
                    {r.status !== 'paid' && (
                      <button
                        type="button"
                        onClick={() => handleExpire(r)}
                        className="px-2 py-1 rounded bg-red-600 text-white text-[11px] w-full"
                      >
                        Mark Expired
                      </button>
                    )}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <p className="text-[10px] opacity-60 leading-relaxed">
        This is your internal board. Cleaners / ops can look here for arrivals, departures,
        and payout amounts without touching Stripe or Supabase. Abandoned Stripe checkouts
        are hidden after ~15 minutes; you can also force-expire anything that shouldn&apos;t
        count as a real reservation.
      </p>
    </div>
  );
}

export default function RealtyTab({ properties: allProperties, assets, refreshAll }) {
  const [edits, setEdits] = useState({});
  const [openGalleryFor, setOpenGalleryFor] = useState(null);
  const [galleryDrafts, setGalleryDrafts] = useState({});
  const [newGalleryInput, setNewGalleryInput] = useState({});

  // filter just realty props and gallery assets
  const realtyProperties = allProperties
    .filter((p) => (p.division || 'realty') === 'realty')
    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  const realtyAssets = assets
    .filter((a) => a.division === 'realty' && a.purpose === 'gallery')
    .slice(0, 50);

  // build payload for saving edits of a property row
  const buildPayload = (row, propRow) => {
    const baseMeta = propRow.metadata || {};
    let mergedMeta = baseMeta;

    // user edited metadataStr -> parse
    if (row.metadataStr !== undefined) {
      mergedMeta = safeJSON(row.metadataStr, baseMeta);
    }

    // if they edited cover_url directly, inject into metadata
    if (row.cover_url !== undefined) {
      mergedMeta = {
        ...mergedMeta,
        cover_url: row.cover_url || '',
      };
    }

    return {
      ...(row.name !== undefined ? { name: row.name } : {}),
      ...(row.slug !== undefined ? { slug: row.slug } : {}),
      ...(row.price !== undefined ? { price: parseFloat(row.price || 0) } : {}),
      ...(row.status !== undefined ? { status: row.status } : {}),
      ...(row.description !== undefined ? { description: row.description } : {}),
      ...((row.metadataStr !== undefined || row.cover_url !== undefined)
        ? { metadata: mergedMeta }
        : {}),
    };
  };

  // save basic info for a property
  const saveProperty = async (propRow) => {
    try {
      const row = edits[propRow.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, propRow);

      await updateRow('properties', propRow.id, payload);

      setEdits((prev) => ({ ...prev, [propRow.id]: {} }));
      refreshAll?.();
      alert('Property saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  // DELETE PROPERTY
  const deleteProperty = async (propRow) => {
    const name = propRow.name || propRow.slug || propRow.id;
    const ok = confirm(
      `Delete property "${name}"?\nThis will remove it from the database.\nBooked reservations and uploaded gallery assets are NOT automatically deleted.`
    );
    if (!ok) return;

    try {
      const { error } = await supabase
        .from('properties')
        .delete()
        .eq('id', propRow.id);

      if (error) throw error;

      refreshAll?.();
      alert('Property deleted.');
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  };

  // expand/collapse gallery editor for one property
  const toggleGalleryEditor = (propRow) => {
    setOpenGalleryFor((cur) => (cur === propRow.id ? null : propRow.id));

    setGalleryDrafts((prev) => {
      if (prev[propRow.id]) return prev;
      const existing = Array.from(
        new Set(
          Array.isArray(propRow.metadata?.gallery_urls)
            ? propRow.metadata.gallery_urls
            : []
        )
      );
      return {
        ...prev,
        [propRow.id]: [...existing],
      };
    });

    setNewGalleryInput((prev) => ({
      ...prev,
      [propRow.id]: '',
    }));
  };

  const removeGalleryImage = (propId, idx) => {
    setGalleryDrafts((prev) => {
      const list = prev[propId] || [];
      const next = list.filter((_, i) => i !== idx);
      return { ...prev, [propId]: next };
    });
  };

  // take comma/newline separated URLs in newGalleryInput[propId] and merge them into galleryDrafts[propId]
  const addGalleryImages = (propId) => {
    setGalleryDrafts((prev) => {
      const current = prev[propId] || [];
      const raw = newGalleryInput[propId] || '';
      const toAdd = raw
        .split(/[\n,]/)
        .map((s) => s.trim())
        .filter(Boolean);
      const deduped = Array.from(new Set([...current, ...toAdd]));
      return { ...prev, [propId]: deduped };
    });

    setNewGalleryInput((prev) => ({
      ...prev,
      [propId]: '',
    }));
  };

  const saveGallery = async (propRow) => {
    const propId = propRow.id;
    const draftList = galleryDrafts[propId] || [];

    const mergedMeta = {
      ...(propRow.metadata || {}),
      gallery_urls: draftList,
    };

    const { error } = await supabase
      .from('properties')
      .update({ metadata: mergedMeta })
      .eq('id', propId);

    if (error) {
      alert(error.message);
      return;
    }

    alert('Gallery saved.');
    refreshAll?.();
  };

  // deleteAsset (for "Recent Realty Uploads")
  const deleteAsset = async (assetRow) => {
    const label = assetRow.filename || assetRow.file_url || assetRow.id;
    const ok = confirm(
      `Delete this uploaded file?\n${label}\n\nThis removes it from the assets table so it won't show up anymore.`
    );
    if (!ok) return;

    try {
      const { error } = await supabase
        .from('assets')
        .delete()
        .eq('id', assetRow.id);

      if (error) throw error;

      refreshAll?.();
      alert('Asset deleted.');
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  };

  return (
    <SectionCard title="Realty / Rentals">
      <div className="space-y-6">
        {/* Upcoming stays / revenue dashboard */}
        <UpcomingStaysPanel />

        {/* uploader */}
        <div>
          <h3 className="text-xl font-bold mb-2">Realty Gallery Uploader</h3>
          <p className="text-sm opacity-80 mb-4">
            Upload multiple images to storage under{' '}
            <code>assets/realty/&lt;purpose&gt;/YYYY/MM</code>. Then attach them to a
            property (gallery).
          </p>

          <MultiUploader division="realty" purpose="gallery" onUploaded={refreshAll} />
        </div>

        {/* attach assets to property */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">Attach uploaded URLs to a property</h4>
          <AttachToProperty properties={realtyProperties} onAfter={refreshAll} />
        </div>

        {/* seasonal rates */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">Manage Seasonal Rates for a Property</h4>
          <PropertyRatesPanel properties={realtyProperties} />
        </div>

        {/* test email */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">Send Test Itinerary Email</h4>
          <RealtyTestEmailPanelWithProperty />
        </div>

        {/* new property form */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">Create New Property</h4>
          <PropertyForm onCreated={refreshAll} />
        </div>

        {/* recent uploads */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">Recent Realty Uploads (gallery)</h4>

          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b dark:border-gray-700">
                  <th className="py-2">Preview</th>
                  <th>Filename</th>
                  <th>URL</th>
                  <th>Copy</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                {realtyAssets.length > 0 ? (
                  realtyAssets.map((a) => (
                    <tr
                      key={a.id}
                      className="border-b dark:border-gray-800 align-top"
                    >
                      <td className="py-2">
                        {a.file_type === 'image' ? (
                          <img
                            src={a.file_url}
                            className="w-16 h-16 object-cover rounded"
                            alt=""
                          />
                        ) : (
                          '‚Äî'
                        )}
                      </td>
                      <td className="py-2">{a.filename || '‚Äî'}</td>
                      <td className="py-2 max-w-[280px] truncate">{a.file_url}</td>
                      <td className="py-2">
                        <button
                          className="text-blue-600 underline"
                          type="button"
                          onClick={() => copyText(a.file_url)}
                        >
                          Copy URL
                        </button>
                      </td>
                      <td className="py-2">
                        <button
                          className="px-3 py-1 bg-red-600 text-white rounded text-xs"
                          type="button"
                          onClick={() => deleteAsset(a)}
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td className="py-6 opacity-70" colSpan={5}>
                      No realty uploads yet.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>

          <p className="text-xs opacity-60 mt-2">
            Tip: copy a few URLs, paste them into the property gallery editor below.
          </p>
        </div>

        {/* property list / editor */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">Your Properties (Most Recent First)</h4>

          <div className="overflow-x-auto">
            <table className="w-full text-sm border-collapse">
              <thead>
                <tr className="text-left border-b dark:border-gray-700">
                  <th className="py-2">Name</th>
                  <th>Slug</th>
                  <th>Base Price</th>
                  <th>Status</th>
                  <th>Description</th>
                  <th>Cover &amp; Metadata</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody>
                {realtyProperties.length > 0 ? (
                  realtyProperties.map((propRow) => {
                    const row = edits[propRow.id] || {};
                    const coverPreview =
                      row.cover_url ?? propRow.metadata?.cover_url ?? '';

                    return (
                      <React.Fragment key={propRow.id}>
                        <tr className="border-b dark:border-gray-800 align-top">
                          {/* name */}
                          <td className="py-2 min-w-[180px]">
                            <input
                              className="w-full dark:bg-gray-800"
                              placeholder={propRow.name || ''}
                              value={row.name ?? propRow.name ?? ''}
                              onChange={(e) =>
                                setEdits((prev) => ({
                                  ...prev,
                                  [propRow.id]: {
                                    ...prev[propRow.id],
                                    name: e.target.value,
                                  },
                                }))
                              }
                            />
                          </td>

                          {/* slug */}
                          <td className="py-2 min-w-[160px]">
                            <input
                              className="w-full dark:bg-gray-800"
                              placeholder={propRow.slug || ''}
                              value={row.slug ?? propRow.slug ?? ''}
                              onChange={(e) =>
                                setEdits((prev) => ({
                                  ...prev,
                                  [propRow.id]: {
                                    ...prev[propRow.id],
                                    slug: e.target.value,
                                  },
                                }))
                              }
                            />
                            <div className="text-[10px] opacity-60">
                              /realty/{row.slug ?? propRow.slug}
                            </div>
                          </td>

                          {/* price */}
                          <td className="py-2 min-w-[100px]">
                            <input
                              type="number"
                              className="w-full dark:bg-gray-800"
                              placeholder={String(propRow.price ?? '')}
                              value={row.price ?? propRow.price ?? ''}
                              onChange={(e) =>
                                setEdits((prev) => ({
                                  ...prev,
                                  [propRow.id]: {
                                    ...prev[propRow.id],
                                    price: e.target.value,
                                  },
                                }))
                              }
                            />
                          </td>

                          {/* status */}
                          <td className="py-2 min-w-[120px]">
                            <input
                              className="w-full dark:bg-gray-800"
                              placeholder={propRow.status || 'active'}
                              value={row.status ?? propRow.status ?? ''}
                              onChange={(e) =>
                                setEdits((prev) => ({
                                  ...prev,
                                  [propRow.id]: {
                                    ...prev[propRow.id],
                                    status: e.target.value,
                                  },
                                }))
                              }
                            />
                          </td>

                          {/* description */}
                          <td className="py-2 min-w-[260px]">
                            <textarea
                              className="w-full h-24 dark:bg-gray-800"
                              placeholder="Description"
                              value={row.description ?? propRow.description ?? ''}
                              onChange={(e) =>
                                setEdits((prev) => ({
                                  ...prev,
                                  [propRow.id]: {
                                    ...prev[propRow.id],
                                    description: e.target.value,
                                  },
                                }))
                              }
                            />
                          </td>

                          {/* metadata / cover */}
                          <td className="py-2 min-w-[320px]">
                            <div className="mb-2 flex gap-2 items-start">
                              <div className="w-16 h-16 rounded overflow-hidden bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs text-gray-500">
                                {coverPreview ? (
                                  <img
                                    src={coverPreview}
                                    className="w-full h-full object-cover"
                                    alt="cover"
                                  />
                                ) : (
                                  'no img'
                                )}
                              </div>

                              <div className="flex-1">
                                <label className="block text-[11px] opacity-60 mb-1">
                                  Cover URL (card / hero image)
                                </label>
                                <input
                                  className="w-full dark:bg-gray-800 text-xs"
                                  placeholder="https://.../your-image.webp"
                                  value={coverPreview}
                                  onChange={(e) =>
                                    setEdits((prev) => ({
                                      ...prev,
                                      [propRow.id]: {
                                        ...prev[propRow.id],
                                        cover_url: e.target.value,
                                      },
                                    }))
                                  }
                                />
                              </div>
                            </div>

                            <textarea
                              className="w-full h-24 dark:bg-gray-800 text-xs"
                              placeholder='{"location":"Big Bear, CA","ical_urls":["https://..."],"cover_url":"https://..."}'
                              value={
                                row.metadataStr ??
                                JSON.stringify(propRow.metadata || {}, null, 0)
                              }
                              onChange={(e) =>
                                setEdits((prev) => ({
                                  ...prev,
                                  [propRow.id]: {
                                    ...prev[propRow.id],
                                    metadataStr: e.target.value,
                                  },
                                }))
                              }
                            />

                            <div className="text-[10px] opacity-60 mt-1">
                              location, cover_url, ical_urls all live in metadata.
                            </div>
                          </td>

                          {/* actions */}
                          <td className="py-2 min-w-[100px] space-y-2">
                            <button
                              className="px-3 py-1 bg-blue-600 text-white rounded w-full"
                              onClick={() => saveProperty(propRow)}
                            >
                              Save
                            </button>

                            <button
                              className="px-3 py-1 bg-gray-700 text-white rounded w-full"
                              onClick={() => toggleGalleryEditor(propRow)}
                            >
                              {openGalleryFor === propRow.id
                                ? 'Close Gallery'
                                : 'Gallery'}
                            </button>

                            <button
                              className="px-3 py-1 bg-red-600 text-white rounded w-full"
                              onClick={() => deleteProperty(propRow)}
                            >
                              Delete
                            </button>
                          </td>
                        </tr>

                        {openGalleryFor === propRow.id && (
                          <tr className="border-b dark:border-gray-800 bg-gray-50 dark:bg-gray-900/40">
                            <td colSpan={7} className="p-4">
                              {/* gallery editor block */}
                              <div className="space-y-4">
                                <div className="text-sm font-semibold">
                                  Property Gallery (
                                  {galleryDrafts[propRow.id]?.length || 0} images)
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
                                  {(galleryDrafts[propRow.id] || []).map(
                                    (url, idx) => (
                                      <div
                                        key={idx}
                                        className="relative border rounded overflow-hidden bg-gray-200 dark:bg-gray-800"
                                      >
                                        <img
                                          src={url}
                                          className="w-full h-24 object-cover"
                                          alt={`img-${idx}`}
                                        />
                                        <button
                                          className="absolute top-1 right-1 bg-red-600 text-white text-xs px-1.5 py-0.5 rounded"
                                          onClick={() =>
                                            removeGalleryImage(propRow.id, idx)
                                          }
                                          title="Remove this image from gallery"
                                        >
                                          ‚úï
                                        </button>
                                      </div>
                                    )
                                  )}

                                  {(galleryDrafts[propRow.id] || []).length ===
                                    0 && (
                                    <div className="text-xs text-gray-500 col-span-full">
                                      No images yet.
                                    </div>
                                  )}
                                </div>

                                <div className="space-y-2">
                                  <label className="block text-xs opacity-70">
                                    Add image URLs (comma or newline separated). Paste from
                                    ‚ÄúRecent Realty Uploads‚Äù or wherever.
                                  </label>

                                  <textarea
                                    className="w-full h-20 text-xs dark:bg-gray-800 border rounded p-2"
                                    value={newGalleryInput[propRow.id] || ''}
                                    onChange={(e) =>
                                      setNewGalleryInput((prev) => ({
                                        ...prev,
                                        [propRow.id]: e.target.value,
                                      }))
                                    }
                                    placeholder={`https://.../photo1.webp\nhttps://.../photo2.webp`}
                                  />

                                  <button
                                    className="px-3 py-1 bg-gray-800 text-white rounded text-sm"
                                    type="button"
                                    onClick={() => addGalleryImages(propRow.id)}
                                  >
                                    Add to Gallery
                                  </button>
                                </div>

                                <div>
                                  <button
                                    className="px-4 py-2 bg-green-600 text-white rounded text-sm"
                                    type="button"
                                    onClick={() => saveGallery(propRow)}
                                  >
                                    Save Gallery Changes
                                  </button>
                                </div>

                                <div className="text-[10px] opacity-60 leading-relaxed">
                                  First image in this list shows as the big hero on the
                                  property page. Reorder by removing and re-adding
                                  (drag-and-drop later).
                                </div>
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    );
                  })
                ) : (
                  <tr>
                    <td className="py-6 opacity-70" colSpan={7}>
                      No properties yet.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/RealtyTestEmailPanelWithProperty.js  (size=1603 bytes) =====
// components/admin/RealtyTestEmailPanelWithProperty.js
import { useState } from 'react';
import axios from 'axios';

function RealtyTestEmailPanelWithProperty() {
  // Assume fetching properties or use context; for stub, empty
  return <RealtyTestEmailPanel properties={[]} />;
}

function RealtyTestEmailPanel({ properties }) {
  const [selected, setSelected] = useState('');
  const [email, setEmail] = useState(process.env.NEXT_PUBLIC_TEST_EMAIL || '');
  const [busy, setBusy] = useState(false);

  const sendTest = async () => {
    if (!selected) return alert('Select a property');
    if (!email) return alert('Enter an email');
    setBusy(true);
    try {
      const { data } = await axios.post('/api/realty/test-email', { property_id: selected, email });
      alert(data.message || 'Sent!');
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="glass p-4 rounded">
      <select value={selected} onChange={e => setSelected(e.target.value)} className="dark:bg-gray-800">
        <option value="">Select property</option>
        {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
      </select>
      <input value={email} onChange={e => setEmail(e.target.value)} placeholder="Test email" className="dark:bg-gray-800" />
      <button onClick={sendTest} disabled={busy} className="px-4 py-2 rounded bg-blue-600 text-white">
        {busy ? 'Sending...' : 'Send Test Email'}
      </button>
    </div>
  );
}

export default RealtyTestEmailPanelWithProperty;


===== FILE: components/admin/SectionCard.js  (size=313 bytes) =====
'use client';
import React from 'react';

export default function SectionCard({ title, className = '', children }) {
  return (
    <section className={`glass p-6 rounded ${className}`}>
      {title ? <h2 className="text-2xl font-bold mb-4">{title}</h2> : null}
      {children}
    </section>
  );
}


===== FILE: components/admin/StudioPagesTab.js  (size=85644 bytes) =====
// components/admin/StudioPagesTab.js
import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import { supabase } from "@/lib/supabase";

function clampInt(v, fallback = 0) {
  const n = parseInt(String(v ?? ""), 10);
  return Number.isFinite(n) ? n : fallback;
}

function safeJsonParse(str, fallback = {}) {
  try {
    if (!str || !String(str).trim()) return fallback;
    const v = JSON.parse(str);
    return v && typeof v === "object" ? v : fallback;
  } catch {
    return fallback;
  }
}

function asStr(v) {
  return v === null || v === undefined ? "" : String(v);
}

function uniqBy(arr, keyFn) {
  const seen = new Set();
  const out = [];
  for (const item of arr || []) {
    const k = keyFn(item);
    if (seen.has(k)) continue;
    seen.add(k);
    out.push(item);
  }
  return out;
}

function extFromName(name = "") {
  const s = String(name || "").trim();
  const idx = s.lastIndexOf(".");
  return idx >= 0 ? s.slice(idx + 1).toLowerCase() : "";
}

function guessKindFromUrl(url = "") {
  const u = String(url || "").toLowerCase();
  const ext = extFromName(u.split("?")[0]);
  if (["jpg", "jpeg", "png", "webp", "gif"].includes(ext)) return "image";
  if (["mp3", "wav", "m4a", "aac", "ogg"].includes(ext)) return "audio";
  if (["mp4", "mov", "webm", "mkv"].includes(ext)) return "video";
  if (["pdf"].includes(ext)) return "document";
  if (u.includes("youtube.com") || u.includes("youtu.be") || u.includes("vimeo.com")) return "video";
  if (u.includes("spotify.com")) return "audio";
  return "link";
}

function publicUrlForStoragePath(bucket, path) {
  if (!bucket || !path) return "";
  const { data } = supabase.storage.from(bucket).getPublicUrl(path);
  return data?.publicUrl || "";
}

// ------------------------------
// ‚úÖ Page Types
// ------------------------------
const LEGACY_PAGE_TYPES = ["one_sheet", "series_bible", "press_kit", "negotiation", "roadmap", "prompts", "deck_copy"];

// ‚úÖ 25 must-have deliverables (page_type)
const REQUIRED_25_PAGE_TYPES = [
  "logline",
  "pitch_1p",
  "synopsis_1page",
  "comparable_titles",
  "format_rating_audience",
  "beat_sheet",
  "season1_outline",
  "episode_list",
  "pilot_outline",
  "pilot_script_or_treatment",
  "franchise_roadmap",
  "series_bible",
  "world_rules_factions",
  "timeline",
  "glossary",
  "cast_profiles_arcs",
  "lookbook_pdf",
  "poster_key_art",
  "trailer_storyboard",
  "teaser_trailer",
  "signature_scene_clip",
  "themes_main_hero_villain",
  "trailer_cue_stingers",
  "chain_of_title_rights_matrix",
  "option_term_sheet_producer_packet",
];

const PAGE_TYPES = Array.from(new Set([...LEGACY_PAGE_TYPES, ...REQUIRED_25_PAGE_TYPES]));

const PAGE_TYPE_PRESETS = {
  logline: { title: "Logline", sort: 10 },
  pitch_1p: { title: "Pitch (1 Page)", sort: 20 },
  synopsis_1page: { title: "Synopsis (1 Page)", sort: 30 },
  comparable_titles: { title: "Comparable Titles + Positioning", sort: 40 },
  format_rating_audience: { title: "Format ‚Ä¢ Rating ‚Ä¢ Audience", sort: 50 },

  beat_sheet: { title: "Beat Sheet", sort: 60 },
  season1_outline: { title: "Season 1 Outline", sort: 70 },
  episode_list: { title: "Episode List", sort: 80 },
  pilot_outline: { title: "Pilot Outline", sort: 90 },
  pilot_script_or_treatment: { title: "Pilot Script / Treatment", sort: 100 },

  franchise_roadmap: { title: "Franchise Roadmap", sort: 110 },
  series_bible: { title: "Series Bible", sort: 120 },
  world_rules_factions: { title: "World Rules + Factions", sort: 130 },
  timeline: { title: "Timeline", sort: 140 },
  glossary: { title: "Glossary", sort: 150 },
  cast_profiles_arcs: { title: "Cast Profiles + Arcs", sort: 160 },

  lookbook_pdf: { title: "Lookbook (PDF)", sort: 170 },
  poster_key_art: { title: "Poster / Key Art", sort: 180 },
  trailer_storyboard: { title: "Trailer Storyboard", sort: 190 },
  teaser_trailer: { title: "Teaser Trailer", sort: 200 },
  signature_scene_clip: { title: "Signature Scene Clip", sort: 210 },

  themes_main_hero_villain: { title: "Themes: Main ‚Ä¢ Hero ‚Ä¢ Villain", sort: 220 },
  trailer_cue_stingers: { title: "Trailer Cues + Stingers", sort: 230 },

  chain_of_title_rights_matrix: { title: "Chain of Title + Rights Matrix (Vault)", sort: 240 },
  option_term_sheet_producer_packet: { title: "Option Term Sheet + Producer Packet (Vault)", sort: 250 },

  // legacy (kept)
  one_sheet: { title: "One-Sheet", sort: 15 },
  press_kit: { title: "Press Kit", sort: 260 },
  negotiation: { title: "Negotiation", sort: 270 },
  roadmap: { title: "Roadmap", sort: 280 },
  prompts: { title: "Prompts", sort: 290 },
  deck_copy: { title: "Deck Copy", sort: 300 },
};

function getPreset(type) {
  return PAGE_TYPE_PRESETS[type] || { title: type.replace(/_/g, " ").toUpperCase(), sort: 100 };
}

const BUCKET = "assets"; // matches your MediaTab bucket
const UPLOAD_PREFIX = "studio_pages"; // storage path prefix
const MAX_ATTACHMENTS = 24;

// Attachment schema (stored in metadata.attachments):
function newAttachmentSeed(overrides = {}) {
  const id = `att_${Math.random().toString(16).slice(2)}_${Date.now()}`;
  return {
    id,
    kind: "link",
    media_type: "other",
    title: "",
    url: "",
    thumbnail_url: "",
    tags: [],
    duration: "",
    bpm: null,
    license_tier: "",
    notes: "",
    ...overrides,
  };
}

function normalizeTags(input) {
  if (Array.isArray(input)) return input.map((t) => asStr(t).trim()).filter(Boolean);
  const s = asStr(input).trim();
  if (!s) return [];
  return s
    .split(",")
    .map((x) => x.trim())
    .filter(Boolean);
}

function countAttachmentsByKind(atts = []) {
  const c = { image: 0, video: 0, audio: 0, document: 0, link: 0 };
  for (const a of atts || []) {
    const k = asStr(a?.kind || "link");
    if (c[k] === undefined) c.link += 1;
    else c[k] += 1;
  }
  return c;
}

// ------------------------------
// ‚úÖ Products/Offer helpers (Stripe-ready)
// ------------------------------
function safeMetaObj(meta) {
  if (!meta) return {};
  if (typeof meta === "object") return meta;
  if (typeof meta === "string") return safeJsonParse(meta, {});
  return {};
}

function moneyToNumber(input) {
  // Accept "9.99", 9.99, "10"
  const s = String(input ?? "").trim();
  if (!s) return null;
  const n = Number(s);
  if (!Number.isFinite(n)) return null;
  return n;
}

/**
 * ‚úÖ IMPORTANT FIX:
 * Your DB does NOT have `products.title`.
 * Your schema has: name, price, division, description, image_url, thumbnail_url, status, metadata, etc.
 * So we only select real columns.
 */
const PRODUCTS_SELECT_SAFE =
  "id,name,description,division,status,price,image_url,thumbnail_url,metadata,created_at,updated_at,slug,tags";

// ‚úÖ IMPORTANT: your studio checkout expects these tiers
// We keep older tiers too so nothing breaks.
const OFFER_TIER_OPTIONS = [
  { value: "public", label: "public" },
  { value: "supporter", label: "supporter" },

  // ‚úÖ studio-access tiers
  { value: "priority", label: "priority" },
  { value: "producer", label: "producer" },
  { value: "packaging", label: "packaging" },

  // admin / misc
  { value: "vault", label: "vault" },
  { value: "custom", label: "custom" },
];

/* ---------------------------------------------------------
   ‚úÖ ADDED: Studio-offer filtering so books never show here
   Why this won't break:
   - Only filters products loaded into this admin tab.
   - Does not change DB schema or other pages.
--------------------------------------------------------- */
const STUDIO_OFFER_TIERS = new Set(["priority", "producer", "packaging"]);

function isStudioOfferProduct(row) {
  const md = safeMetaObj(row?.metadata);

  const tier = String(md?.tier || md?.access_tier || md?.required_tier || "").trim().toLowerCase();
  const offerType = String(md?.offer_type || "").trim().toLowerCase(); // marker we set on save
  const kind = String(md?.kind || "").trim().toLowerCase();
  const name = String(row?.name || "").toLowerCase();

  const hasStudioTier = STUDIO_OFFER_TIERS.has(tier);
  const explicitlyStudio = offerType === "studio_access" || kind === "studio_access";
  const looksLikeStudioByName = name.includes("studio access");

  return hasStudioTier || explicitlyStudio || looksLikeStudioByName;
}

// We support link via metadata.universe_id (no schema change).
async function tryLoadProductsForUniverse(universeId) {
  // Preferred: filter by metadata->>universe_id
  try {
    const { data, error } = await supabase
      .from("products")
      .select(PRODUCTS_SELECT_SAFE)
      .filter("metadata->>universe_id", "eq", String(universeId))
      .order("updated_at", { ascending: false })
      .limit(200);

    if (!error) {
      const onlyOffers = (data || []).filter(isStudioOfferProduct);
      return { data: onlyOffers, mode: "metadata" };
    }
  } catch {
    // ignore
  }

  // Last resort: fetch recent and filter client-side
  const { data } = await supabase
    .from("products")
    .select(PRODUCTS_SELECT_SAFE)
    .order("updated_at", { ascending: false })
    .limit(300);

  const filtered = (data || []).filter((row) => {
    const md = safeMetaObj(row?.metadata);
    return asStr(md?.universe_id) === asStr(universeId);
  });

  const onlyOffers = filtered.filter(isStudioOfferProduct);
  return { data: onlyOffers, mode: "client_filter" };
}

export default function StudioPagesTab() {
  const [universes, setUniverses] = useState([]);
  const [selectedUniverseId, setSelectedUniverseId] = useState("");

  const [pages, setPages] = useState([]);
  const [loading, setLoading] = useState(true);
  const [loadingPages, setLoadingPages] = useState(false);
  const [saving, setSaving] = useState(false);

  const [notice, setNotice] = useState(null); // {type,msg}

  // editor fields
  const [pId, setPId] = useState(null);
  const [pType, setPType] = useState("one_sheet");
  const [pTitle, setPTitle] = useState("");
  const [pStatus, setPStatus] = useState("draft");
  const [pSort, setPSort] = useState(100);
  const [pExcerpt, setPExcerpt] = useState("");
  const [pHeroImg, setPHeroImg] = useState("");
  const [pHeroVid, setPHeroVid] = useState("");
  const [pContent, setPContent] = useState("");

  // visibility stored in metadata.visibility
  const [pVisibility, setPVisibility] = useState("public"); // public|vault
  const [pMetaStr, setPMetaStr] = useState(""); // raw JSON

  // ‚úÖ attachments stored in metadata.attachments
  const [pAttachments, setPAttachments] = useState([]);
  const [attPickerQuery, setAttPickerQuery] = useState("");
  const [attPickerKind, setAttPickerKind] = useState("all"); // all|image|video|audio|document|link
  const [attPickerBusy, setAttPickerBusy] = useState(false);
  const [libraryItems, setLibraryItems] = useState([]);
  const uploadInputRef = useRef(null);

  // ‚úÖ NEW: Products/Offers CRUD
  const [products, setProducts] = useState([]);
  const [loadingProducts, setLoadingProducts] = useState(false);
  const [productsMode, setProductsMode] = useState("unknown"); // metadata | client_filter | unknown

  const [prodId, setProdId] = useState(null);
  const [prodTitle, setProdTitle] = useState(""); // UI label (maps to products.name)
  const [prodStatus, setProdStatus] = useState("active"); // active|draft|archived (we store as text)
  const [prodTier, setProdTier] = useState("public"); // ‚úÖ now supports priority/packaging too
  const [prodKind, setProdKind] = useState("digital"); // digital|service|bundle|custom
  const [prodPriceDisplay, setProdPriceDisplay] = useState(""); // dollars string, optional
  const [prodCurrency, setProdCurrency] = useState("usd");
  const [prodStripePriceId, setProdStripePriceId] = useState(""); // price_...
  const [prodStripeProductId, setProdStripeProductId] = useState(""); // prod_...
  const [prodImageUrl, setProdImageUrl] = useState("");
  const [prodDescription, setProdDescription] = useState("");
  const [prodMetadataStr, setProdMetadataStr] = useState(""); // advanced

  const selectedUniverse = useMemo(
    () => universes.find((u) => u.id === selectedUniverseId) || null,
    [universes, selectedUniverseId]
  );

  const resetEditor = useCallback(() => {
    setPId(null);
    setPType("one_sheet");
    setPTitle("");
    setPStatus("draft");
    setPSort(100);
    setPExcerpt("");
    setPHeroImg("");
    setPHeroVid("");
    setPContent("");
    setPVisibility("public");
    setPMetaStr("");
    setPAttachments([]);
    setAttPickerQuery("");
    setAttPickerKind("all");
    setLibraryItems([]);
  }, []);

  const resetProductEditor = useCallback(() => {
    setProdId(null);
    setProdTitle("");
    setProdStatus("active");
    setProdTier("public");
    setProdKind("digital");
    setProdPriceDisplay("");
    setProdCurrency("usd");
    setProdStripePriceId("");
    setProdStripeProductId("");
    setProdImageUrl("");
    setProdDescription("");
    setProdMetadataStr(
      JSON.stringify(
        {
          universe_id: selectedUniverseId || "",
          offer_type: "studio_access", // ‚úÖ ADDED: makes these unambiguously studio offers
          tier: "public",
          access_tier: "public", // ‚úÖ mirrored field for compatibility
          kind: "digital",
          stripe_price_id: "",
          stripe_product_id: "",
          currency: "usd",
          // optional helpers:
          // features: [],
          // deliverables: [],
        },
        null,
        2
      )
    );
  }, [selectedUniverseId]);

  const loadUniverses = useCallback(async () => {
    setLoading(true);
    setNotice(null);

    const { data, error } = await supabase
      .from("universes")
      .select("id,title,slug,status,updated_at")
      .order("updated_at", { ascending: false });

    if (error) {
      console.error(error);
      setUniverses([]);
      setNotice({ type: "error", msg: error.message || "Failed to load universes" });
    } else {
      setUniverses(data || []);
      if (!selectedUniverseId && (data || []).length) setSelectedUniverseId(data[0].id);
    }
    setLoading(false);
  }, [selectedUniverseId]);

  const loadPages = useCallback(async (universeId) => {
    if (!universeId) {
      setPages([]);
      return;
    }
    setLoadingPages(true);
    setNotice(null);

    const { data, error } = await supabase
      .from("studio_pages")
      .select("*")
      .eq("universe_id", universeId)
      .order("sort_order", { ascending: true })
      .order("updated_at", { ascending: false });

    if (error) {
      console.error(error);
      setPages([]);
      setNotice({ type: "error", msg: error.message || "Failed to load studio pages" });
    } else {
      setPages(data || []);
    }
    setLoadingPages(false);
  }, []);

  const loadProducts = useCallback(async (universeId) => {
    if (!universeId) {
      setProducts([]);
      setProductsMode("unknown");
      return;
    }

    setLoadingProducts(true);
    try {
      const res = await tryLoadProductsForUniverse(universeId);
      setProducts(res?.data || []);
      setProductsMode(res?.mode || "unknown");
    } catch (e) {
      console.error(e);
      setProducts([]);
      setProductsMode("unknown");
      setNotice({ type: "error", msg: e?.message || "Failed to load products" });
    } finally {
      setLoadingProducts(false);
    }
  }, []);

  useEffect(() => {
    loadUniverses();
  }, [loadUniverses]);

  useEffect(() => {
    if (!selectedUniverseId) return;
    loadPages(selectedUniverseId);
    loadProducts(selectedUniverseId);
    resetEditor();
    resetProductEditor();
  }, [selectedUniverseId, loadPages, loadProducts, resetEditor, resetProductEditor]);

  const selectPage = useCallback((pg) => {
    const md = pg.metadata && typeof pg.metadata === "object" ? pg.metadata : safeJsonParse(pg.metadata, {});
    const visibility = String(md?.visibility || "public") === "vault" ? "vault" : "public";
    const attachments = Array.isArray(md?.attachments) ? md.attachments : [];
    setPId(pg.id);
    setPType(pg.page_type || "one_sheet");
    setPTitle(pg.title || "");
    setPStatus(pg.status || "draft");
    setPSort(pg.sort_order ?? 100);
    setPExcerpt(pg.excerpt || "");
    setPHeroImg(pg.hero_image_url || "");
    setPHeroVid(pg.hero_video_url || "");
    setPContent(pg.content_md || "");
    setPVisibility(visibility);
    setPAttachments(
      (attachments || [])
        .map((a) => ({
          ...newAttachmentSeed(),
          ...a,
          id: a?.id || `att_${Math.random().toString(16).slice(2)}_${Date.now()}`,
          kind: asStr(a?.kind || "link"),
          media_type: asStr(a?.media_type || "other"),
          title: asStr(a?.title || ""),
          url: asStr(a?.url || ""),
          thumbnail_url: asStr(a?.thumbnail_url || ""),
          tags: normalizeTags(a?.tags || []),
          duration: asStr(a?.duration || ""),
          bpm: a?.bpm ?? null,
          license_tier: asStr(a?.license_tier || ""),
          notes: asStr(a?.notes || ""),
        }))
        .slice(0, MAX_ATTACHMENTS)
    );

    const mdForEditor = { ...(md || {}) };
    mdForEditor.visibility = visibility;
    if (!Array.isArray(mdForEditor.attachments)) mdForEditor.attachments = attachments || [];
    setPMetaStr(JSON.stringify(mdForEditor || {}, null, 2));
  }, []);

  const selectProduct = useCallback(
    (row) => {
      const md = safeMetaObj(row?.metadata);

      // ‚úÖ FIX: products table uses "name", not "title"
      const title = row?.name || md?.title || md?.name || "";
      const img = row?.image_url || row?.thumbnail_url || md?.image_url || md?.thumbnail_url || "";
      const desc = row?.description || md?.description || "";

      const stripePriceId = md?.stripe_price_id || md?.price_id || "";
      const stripeProductId = md?.stripe_product_id || "";

      // ‚úÖ tier can live in either tier or access_tier
      const tier = md?.tier || md?.access_tier || md?.required_tier || "public";
      const kind = md?.kind || md?.product_kind || "digital";
      const currency = md?.currency || "usd";
      const status = row?.status || md?.status || "active";

      setProdId(row?.id || null);
      setProdTitle(asStr(title));
      setProdImageUrl(asStr(img));
      setProdDescription(asStr(desc));
      setProdPriceDisplay(row?.price !== null && row?.price !== undefined ? String(row.price) : "");
      setProdStripePriceId(asStr(stripePriceId));
      setProdStripeProductId(asStr(stripeProductId));
      setProdTier(asStr(tier));
      setProdKind(asStr(kind));
      setProdCurrency(asStr(currency));
      setProdStatus(asStr(status) || "active");

      const mdForEditor = { ...(md || {}) };
      mdForEditor.universe_id = mdForEditor.universe_id || selectedUniverseId || "";
      mdForEditor.offer_type = mdForEditor.offer_type || "studio_access"; // ‚úÖ ADDED: persist marker on edit
      mdForEditor.tier = tier;
      mdForEditor.access_tier = mdForEditor.access_tier || tier; // ‚úÖ mirror for compatibility
      mdForEditor.kind = kind;
      mdForEditor.currency = currency;
      mdForEditor.stripe_price_id = stripePriceId;
      mdForEditor.stripe_product_id = stripeProductId;

      setProdMetadataStr(JSON.stringify(mdForEditor, null, 2));
    },
    [selectedUniverseId]
  );

  // ‚úÖ package meter (x/25) based on page_type presence (any status)
  const packageProgress = useMemo(() => {
    const typesPresent = new Set((pages || []).map((p) => String(p.page_type || "").trim()).filter(Boolean));
    const have = REQUIRED_25_PAGE_TYPES.filter((t) => typesPresent.has(t));
    const missing = REQUIRED_25_PAGE_TYPES.filter((t) => !typesPresent.has(t));
    return { have, missing, count: have.length, total: REQUIRED_25_PAGE_TYPES.length };
  }, [pages]);

  // ‚úÖ helper: create only missing 25 pages
  const createMissingPackagePages = useCallback(async () => {
    if (!selectedUniverseId) {
      setNotice({ type: "error", msg: "Select a universe first." });
      return;
    }

    const missing = packageProgress.missing;
    if (!missing.length) {
      setNotice({ type: "ok", msg: "All 25 package pages already exist." });
      return;
    }

    setSaving(true);
    setNotice(null);

    try {
      const rows = missing.map((t) => {
        const preset = getPreset(t);
        const isVault = t.includes("rights") || t.includes("term_sheet") || t.includes("producer_packet");
        const visibility = isVault ? "vault" : "public";
        return {
          universe_id: selectedUniverseId,
          page_type: t,
          title: preset.title,
          status: "draft",
          sort_order: preset.sort,
          excerpt: null,
          hero_image_url: null,
          hero_video_url: null,
          content_md: `# ${preset.title}\n\n`,
          metadata: { visibility, attachments: [] },
        };
      });

      const { error } = await supabase.from("studio_pages").insert(rows);
      if (error) throw error;

      setNotice({ type: "ok", msg: `Created ${rows.length} missing package pages (draft).` });
      await loadPages(selectedUniverseId);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to create missing pages" });
    } finally {
      setSaving(false);
    }
  }, [selectedUniverseId, packageProgress.missing, loadPages]);

  // ‚úÖ best-effort: load existing media library (tries media table, then products)
  const loadMediaLibrary = useCallback(
    async (q = "") => {
      setAttPickerBusy(true);
      setNotice(null);

      const query = asStr(q).trim();
      const kindFilter = attPickerKind;

      const normalizeRow = (row) => {
        const meta = row?.metadata && typeof row.metadata === "object" ? row.metadata : safeJsonParse(row?.metadata, {});
        const title = row?.title || row?.name || meta?.title || "";
        const url = row?.url || row?.media_url || row?.download_url || meta?.url || meta?.download_url || "";
        const thumbnail_url = row?.thumbnail_url || row?.image_url || meta?.thumbnail_url || meta?.image_url || "";
        const media_type = meta?.media_type || meta?.type || meta?.kind || "other";
        const kind = meta?.kind || guessKindFromUrl(url || thumbnail_url || "");
        const tags = normalizeTags(row?.tags || meta?.tags || []);
        const duration = meta?.duration || "";
        const bpm = meta?.bpm ?? null;
        const license_tier = meta?.license_tier || "";
        const sourceTable = row?._source_table || "unknown";

        return {
          _key: `${sourceTable}:${row?.id || title}:${url}`,
          sourceTable,
          id: row?.id || null,
          title: asStr(title),
          url: asStr(url),
          thumbnail_url: asStr(thumbnail_url),
          kind: asStr(kind),
          media_type: asStr(media_type),
          tags,
          duration: asStr(duration),
          bpm,
          license_tier: asStr(license_tier),
          raw: row,
        };
      };

      const applyFilters = (items) => {
        let out = items || [];
        if (kindFilter && kindFilter !== "all") out = out.filter((it) => it.kind === kindFilter);
        if (query) {
          const qq = query.toLowerCase();
          out = out.filter((it) => {
            const blob = `${it.title} ${it.url} ${(it.tags || []).join(" ")} ${it.media_type}`.toLowerCase();
            return blob.includes(qq);
          });
        }
        out = uniqBy(out, (x) => x._key);
        return out.slice(0, 60);
      };

      try {
        let items = [];
        try {
          let req = supabase
            .from("media")
            .select("id,title,url,thumbnail_url,metadata,created_at,updated_at")
            .order("updated_at", { ascending: false });
          const { data, error } = await req.limit(80);
          if (!error && data) {
            items = (data || []).map((r) => ({ ...r, _source_table: "media" })).map(normalizeRow);
          }
        } catch {
          // ignore
        }

        if (!items.length) {
          try {
            // ‚úÖ FIX: products has name (not title)
            let req = supabase
              .from("products")
              .select("id,name,division,image_url,thumbnail_url,metadata,created_at,updated_at,tags")
              .order("updated_at", { ascending: false })
              .limit(120);

            const { data, error } = await req;
            if (!error && data) {
              items = (data || []).map((r) => ({ ...r, _source_table: "products" })).map(normalizeRow);
            }
          } catch {
            // ignore
          }
        }

        const filtered = applyFilters(items || []);
        setLibraryItems(filtered);
      } catch (e) {
        console.error(e);
        setLibraryItems([]);
        setNotice({ type: "error", msg: e?.message || "Failed to load media library" });
      } finally {
        setAttPickerBusy(false);
      }
    },
    [attPickerKind]
  );

  const addAttachment = useCallback((seed = {}) => {
    setPAttachments((prev) => {
      const next = [...(prev || [])];
      if (next.length >= MAX_ATTACHMENTS) return next;
      next.push(newAttachmentSeed(seed));
      return next;
    });
  }, []);

  const updateAttachment = useCallback((id, patch) => {
    setPAttachments((prev) =>
      (prev || []).map((a) =>
        a.id === id ? { ...a, ...patch, tags: patch?.tags !== undefined ? normalizeTags(patch.tags) : a.tags } : a
      )
    );
  }, []);

  const removeAttachment = useCallback((id) => {
    setPAttachments((prev) => (prev || []).filter((a) => a.id !== id));
  }, []);

  const moveAttachment = useCallback((id, dir) => {
    setPAttachments((prev) => {
      const arr = [...(prev || [])];
      const idx = arr.findIndex((a) => a.id === id);
      if (idx < 0) return arr;
      const to = idx + dir;
      if (to < 0 || to >= arr.length) return arr;
      const tmp = arr[idx];
      arr[idx] = arr[to];
      arr[to] = tmp;
      return arr;
    });
  }, []);

  const addFromLibrary = useCallback(
    (item) => {
      if (!item?.url && !item?.thumbnail_url) return;
      addAttachment({
        kind: item.kind || guessKindFromUrl(item.url || item.thumbnail_url),
        media_type: item.media_type || "other",
        title: item.title || "",
        url: item.url || "",
        thumbnail_url: item.thumbnail_url || "",
        tags: item.tags || [],
        duration: item.duration || "",
        bpm: item.bpm ?? null,
        license_tier: item.license_tier || "",
        notes: "",
      });
    },
    [addAttachment]
  );

  const onUploadFiles = useCallback(
    async (files) => {
      if (!files || !files.length) return;
      if (!selectedUniverse?.slug) {
        setNotice({ type: "error", msg: "Universe slug missing. Add a slug to this universe before uploading." });
        return;
      }

      setSaving(true);
      setNotice(null);

      try {
        const uploaded = [];
        for (const file of files) {
          const kind = guessKindFromUrl(file.name);
          const safeName = file.name.replace(/[^a-zA-Z0-9._-]+/g, "-");
          const path = `${UPLOAD_PREFIX}/${selectedUniverse.slug}/${Date.now()}_${safeName}`;

          const { error } = await supabase.storage.from(BUCKET).upload(path, file, {
            cacheControl: "3600",
            upsert: false,
          });

          if (error) throw error;

          const url = publicUrlForStoragePath(BUCKET, path);
          uploaded.push({ file, url, kind });
        }

        for (const u of uploaded) {
          addAttachment({
            kind: u.kind,
            media_type:
              u.kind === "image" ? "poster" : u.kind === "video" ? "trailer" : u.kind === "audio" ? "cue" : "document",
            title: u.file.name.replace(/\.[^.]+$/, ""),
            url: u.url,
            thumbnail_url: "",
            tags: [`universe:${selectedUniverse.slug}`, `page_type:${pType}`],
            duration: "",
            bpm: null,
            license_tier: u.kind === "audio" ? "Pitch / Web" : "",
            notes: "",
          });
        }

        setNotice({ type: "ok", msg: `Uploaded ${uploaded.length} file(s) to Storage and attached to this page.` });
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Upload failed" });
      } finally {
        setSaving(false);
        if (uploadInputRef.current) uploadInputRef.current.value = "";
      }
    },
    [selectedUniverse, addAttachment, pType]
  );

  const savePage = useCallback(async () => {
    if (!selectedUniverseId) {
      setNotice({ type: "error", msg: "Select a universe first." });
      return;
    }
    if (!pTitle.trim()) {
      setNotice({ type: "error", msg: "Title is required." });
      return;
    }

    setSaving(true);
    setNotice(null);

    const metaObj = safeJsonParse(pMetaStr, {});
    metaObj.visibility = pVisibility;

    metaObj.attachments = (pAttachments || [])
      .filter((a) => a && (asStr(a.title).trim() || asStr(a.url).trim()))
      .slice(0, MAX_ATTACHMENTS)
      .map((a) => ({
        id: a.id || `att_${Math.random().toString(16).slice(2)}_${Date.now()}`,
        kind: asStr(a.kind || "link"),
        media_type: asStr(a.media_type || "other"),
        title: asStr(a.title || "").trim(),
        url: asStr(a.url || "").trim(),
        thumbnail_url: asStr(a.thumbnail_url || "").trim(),
        tags: normalizeTags(a.tags || []),
        duration: asStr(a.duration || "").trim(),
        bpm: a.bpm === null || a.bpm === undefined || a.bpm === "" ? null : clampInt(a.bpm, null),
        license_tier: asStr(a.license_tier || "").trim(),
        notes: asStr(a.notes || "").trim(),
      }));

    const payload = {
      universe_id: selectedUniverseId,
      page_type: pType,
      title: pTitle.trim(),
      status: pStatus,
      sort_order: clampInt(pSort, 100),
      excerpt: pExcerpt || null,
      hero_image_url: pHeroImg || null,
      hero_video_url: pHeroVid || null,
      content_md: pContent || "",
      metadata: metaObj,
    };

    try {
      if (pId) {
        const { error } = await supabase.from("studio_pages").update(payload).eq("id", pId);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Studio page saved." });
      } else {
        const { data, error } = await supabase.from("studio_pages").insert([payload]).select("*").single();
        if (error) throw error;
        setPId(data.id);
        setNotice({ type: "ok", msg: "Studio page created." });
      }

      await loadPages(selectedUniverseId);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to save studio page" });
    } finally {
      setSaving(false);
    }
  }, [
    selectedUniverseId,
    pId,
    pType,
    pTitle,
    pStatus,
    pSort,
    pExcerpt,
    pHeroImg,
    pHeroVid,
    pContent,
    pMetaStr,
    pVisibility,
    pAttachments,
    loadPages,
  ]);

  const deletePage = useCallback(async () => {
    if (!pId) return;
    if (!confirm("Delete this studio page?")) return;

    setSaving(true);
    setNotice(null);

    try {
      const { error } = await supabase.from("studio_pages").delete().eq("id", pId);
      if (error) throw error;

      setNotice({ type: "ok", msg: "Studio page deleted." });
      resetEditor();
      await loadPages(selectedUniverseId);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to delete studio page" });
    } finally {
      setSaving(false);
    }
  }, [pId, resetEditor, loadPages, selectedUniverseId]);

  // ‚úÖ NEW: Product save/delete (Stripe Price ID ready)
  const saveProduct = useCallback(async () => {
    if (!selectedUniverseId) {
      setNotice({ type: "error", msg: "Select a universe first." });
      return;
    }
    if (!prodTitle.trim()) {
      setNotice({ type: "error", msg: "Product title is required." });
      return;
    }
    if (prodStripePriceId && !String(prodStripePriceId).startsWith("price_")) {
      setNotice({ type: "error", msg: "Stripe Price ID should look like: price_..." });
      return;
    }
    if (prodStripeProductId && !String(prodStripeProductId).startsWith("prod_")) {
      setNotice({ type: "error", msg: "Stripe Product ID should look like: prod_..." });
      return;
    }

    setSaving(true);
    setNotice(null);

    const metaObj = safeJsonParse(prodMetadataStr, {});
    metaObj.universe_id = selectedUniverseId;

    // ‚úÖ ADDED: enforce studio-offer marker so books can‚Äôt get mixed in
    metaObj.offer_type = "studio_access";

    // ‚úÖ enforce tier in BOTH fields so your studio page can read either
    metaObj.tier = prodTier;
    metaObj.access_tier = prodTier;

    metaObj.kind = prodKind;
    metaObj.currency = prodCurrency || "usd";
    metaObj.stripe_price_id = prodStripePriceId || "";
    metaObj.stripe_product_id = prodStripeProductId || "";

    // price: store both in metadata (optional) and in products.price if provided
    const priceNum = moneyToNumber(prodPriceDisplay);
    if (priceNum !== null) metaObj.price = priceNum;

    /**
     * ‚úÖ IMPORTANT FIX:
     * Your products table uses `name` (not `title`).
     * So we write to `name` ONLY.
     */
    const payload = {
      name: prodTitle.trim(),
      description: prodDescription || null,
      status: prodStatus || "active",
      image_url: prodImageUrl || null,
      thumbnail_url: prodImageUrl || null,
      metadata: metaObj,
      // division must pass your constraint; we set a safe default
      division: "publishing",
      // only set price if user provided a valid number (your schema has price numeric NOT NULL)
      price: priceNum !== null ? priceNum : 0,
    };

    try {
      if (prodId) {
        const { error } = await supabase.from("products").update(payload).eq("id", prodId);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Product saved." });
      } else {
        const { data, error } = await supabase.from("products").insert([payload]).select("*").single();
        if (error) throw error;
        if (data?.id) setProdId(data.id);
        setNotice({ type: "ok", msg: "Product created." });
      }

      await loadProducts(selectedUniverseId);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to save product" });
    } finally {
      setSaving(false);
    }
  }, [
    selectedUniverseId,
    prodId,
    prodTitle,
    prodStatus,
    prodTier,
    prodKind,
    prodPriceDisplay,
    prodCurrency,
    prodStripePriceId,
    prodStripeProductId,
    prodImageUrl,
    prodDescription,
    prodMetadataStr,
    loadProducts,
  ]);

  const deleteProduct = useCallback(async () => {
    if (!prodId) return;
    if (!confirm("Delete this product/offer?")) return;

    setSaving(true);
    setNotice(null);

    try {
      const { error } = await supabase.from("products").delete().eq("id", prodId);
      if (error) throw error;
      setNotice({ type: "ok", msg: "Product deleted." });
      resetProductEditor();
      await loadProducts(selectedUniverseId);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to delete product" });
    } finally {
      setSaving(false);
    }
  }, [prodId, resetProductEditor, loadProducts, selectedUniverseId]);

  // ‚úÖ quality-of-life: auto-fill title/sort + default visibility for new pages
  useEffect(() => {
    if (pId) return;
    const preset = getPreset(pType);
    if (!pTitle) setPTitle(preset.title);
    if (!pSort || Number(pSort) === 100) setPSort(preset.sort);

    if (!pMetaStr) {
      const isVaultType = pType.includes("rights") || pType.includes("term_sheet") || pType.includes("producer_packet");
      const vis = isVaultType ? "vault" : "public";
      setPVisibility(vis);
      setPMetaStr(JSON.stringify({ visibility: vis, attachments: [] }, null, 2));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [pType]);

  const studioPreviewUrl = useMemo(() => {
    if (!selectedUniverse?.slug) return "";
    return `/studios/${selectedUniverse.slug}`;
  }, [selectedUniverse?.slug]);

  const vaultPreviewUrl = useMemo(() => {
    if (!selectedUniverse?.slug) return "";
    return `/studios/${selectedUniverse.slug}?vault=1`;
  }, [selectedUniverse?.slug]);

  const editorAttachmentsCounts = useMemo(() => countAttachmentsByKind(pAttachments || []), [pAttachments]);

  // ‚úÖ Products completeness quick check (do we have at least one usable Stripe price?)
  const productsReady = useMemo(() => {
    const usable = (products || []).filter((row) => {
      const md = safeMetaObj(row?.metadata);
      const pid = asStr(md?.stripe_price_id || md?.price_id).trim();
      return pid.startsWith("price_");
    });
    return { count: usable.length };
  }, [products]);

  return (
    <div className="space-y-6">
      <div className="flex items-end justify-between gap-4 flex-wrap">
        <div>
          <h2 className="text-2xl font-bold">Studio Pages</h2>
          <p className="text-sm opacity-70">
            Fast-scan pitch copy + optional media attachments per page. Published pages render on{" "}
            <code>/studios/[slug]</code>. Vault pages are hidden unless <code>?vault=1</code>.
          </p>
        </div>

        <div className="flex items-center gap-2 flex-wrap">
          {studioPreviewUrl ? (
            <a
              className="px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50"
              href={studioPreviewUrl}
              target="_blank"
              rel="noreferrer"
            >
              View Studio ‚Üí
            </a>
          ) : null}
          {vaultPreviewUrl ? (
            <a
              className="px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50"
              href={vaultPreviewUrl}
              target="_blank"
              rel="noreferrer"
              title="Shows vault pages (deal docs) if your studios/[slug] supports ?vault=1"
            >
              View Vault ‚Üí
            </a>
          ) : null}
        </div>
      </div>

      {notice?.msg && (
        <div
          className={`rounded-2xl border p-3 text-sm ${
            notice.type === "error"
              ? "border-red-200 bg-red-50 text-red-800"
              : "border-emerald-200 bg-emerald-50 text-emerald-800"
          }`}
        >
          {notice.msg}
        </div>
      )}

      {/* ‚úÖ Package Completeness Meter */}
      <div className="rounded-2xl border border-gray-200 p-4 bg-white">
        <div className="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <div className="font-semibold">Hollywood Package (25)</div>
            <div className="text-sm opacity-70">
              Completeness is based on required <code>page_type</code> presence.
            </div>
          </div>

          <button
            className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 disabled:opacity-50"
            onClick={createMissingPackagePages}
            disabled={!selectedUniverseId || saving}
            title="Creates only missing 25 required page types as draft pages"
          >
            + Create Missing Package Pages
          </button>
        </div>

        <div className="mt-3 flex items-center gap-3 flex-wrap">
          <div className="text-sm">
            Progress: <span className="font-semibold">{packageProgress.count}</span> / {packageProgress.total}
          </div>
          <div className="flex-1 min-w-[220px] h-2 rounded-full bg-gray-100 overflow-hidden border">
            <div
              className="h-full bg-black"
              style={{ width: `${Math.round((packageProgress.count / packageProgress.total) * 100)}%` }}
            />
          </div>
          {packageProgress.count === packageProgress.total ? (
            <span className="text-[11px] px-2 py-0.5 rounded-full border border-emerald-300 bg-emerald-50 text-emerald-800">
              complete
            </span>
          ) : (
            <span className="text-[11px] px-2 py-0.5 rounded-full border border-amber-300 bg-amber-50 text-amber-900">
              missing {packageProgress.missing.length}
            </span>
          )}
        </div>

        {packageProgress.missing.length > 0 && (
          <div className="mt-3 text-xs opacity-80">
            Missing: <span className="font-mono">{packageProgress.missing.join(", ")}</span>
          </div>
        )}
      </div>

      {/* ‚úÖ Products / Offers (Option A) */}
      <div className="rounded-2xl border border-gray-200 p-4 bg-white">
        <div className="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <div className="font-semibold">Products / Offers (Stripe-ready)</div>
            <div className="text-sm opacity-70">
              Create offers for this Universe and paste your Stripe <code>price_...</code> ID. This is ‚ÄúOption A‚Äù
              (products live in Supabase).
            </div>
          </div>

          <div className="flex items-center gap-2 flex-wrap">
            <span className="text-[11px] px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">
              link mode: <b>{productsMode}</b>
            </span>
            <span
              className={`text-[11px] px-2 py-0.5 rounded-full border ${
                productsReady.count > 0
                  ? "border-emerald-300 bg-emerald-50 text-emerald-800"
                  : "border-amber-300 bg-amber-50 text-amber-900"
              }`}
              title="Counts products with a valid Stripe price_ id"
            >
              stripe prices: <b>{productsReady.count}</b>
            </span>

            <button
              className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 disabled:opacity-50"
              onClick={() => loadProducts(selectedUniverseId)}
              disabled={!selectedUniverseId || loadingProducts || saving}
            >
              {loadingProducts ? "Refreshing‚Ä¶" : "Refresh"}
            </button>

            <button
              className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 disabled:opacity-50"
              onClick={resetProductEditor}
              disabled={!selectedUniverseId || saving}
              title="Create a new offer"
            >
              + New Offer
            </button>
          </div>
        </div>

        {!selectedUniverseId ? (
          <div className="mt-3 text-sm opacity-70">Select a universe to manage offers.</div>
        ) : (
          <div className="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            {/* Offer list */}
            <div className="rounded-2xl border border-gray-200 p-3">
              <div className="flex items-center justify-between gap-2">
                <div className="font-semibold">Offers</div>
                <div className="text-xs opacity-60">{loadingProducts ? "Loading‚Ä¶" : `${(products || []).length} total`}</div>
              </div>

              {(products || []).length === 0 ? (
                <div className="mt-3 text-sm opacity-70">
                  No offers yet. Click <b>+ New Offer</b>, paste your <code>price_...</code> ID, then Save.
                </div>
              ) : (
                <div className="mt-3 space-y-2 max-h-[340px] overflow-auto pr-1">
                  {(products || []).map((row) => {
                    const md = safeMetaObj(row?.metadata);
                    const title = row?.name || md?.title || md?.name || "(untitled)";
                    const tier = md?.tier || md?.access_tier || "public";
                    const kind = md?.kind || md?.product_kind || "digital";
                    const status = row?.status || md?.status || "active";
                    const pid = asStr(md?.stripe_price_id || md?.price_id).trim();
                    const price = row?.price !== null && row?.price !== undefined ? String(row.price) : "";

                    return (
                      <button
                        key={row.id}
                        onClick={() => selectProduct(row)}
                        className={`w-full text-left p-3 rounded-2xl border transition ${
                          prodId === row.id ? "border-black" : "border-gray-200 hover:border-gray-300"
                        }`}
                        title="Click to edit"
                      >
                        <div className="flex items-start justify-between gap-2">
                          <div className="min-w-0">
                            <div className="font-semibold truncate">{title}</div>
                            <div className="text-xs opacity-70 mt-0.5 truncate">
                              <span className="font-mono">id:</span> {row.id}
                            </div>
                            <div className="text-xs opacity-70 mt-1 flex items-center gap-2 flex-wrap">
                              <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">{status}</span>
                              <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">{tier}</span>
                              <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">{kind}</span>
                              {price ? (
                                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">${price}</span>
                              ) : null}
                              {pid ? (
                                <span
                                  className={`px-2 py-0.5 rounded-full border ${
                                    pid.startsWith("price_")
                                      ? "border-emerald-300 bg-emerald-50 text-emerald-800"
                                      : "border-amber-300 bg-amber-50 text-amber-900"
                                  }`}
                                >
                                  {pid.startsWith("price_") ? "stripe ok" : "stripe?"}
                                </span>
                              ) : (
                                <span className="px-2 py-0.5 rounded-full border border-amber-300 bg-amber-50 text-amber-900">
                                  missing price_id
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Offer editor */}
            <div className="rounded-2xl border border-gray-200 p-3">
              <div className="flex items-start justify-between gap-3 flex-wrap">
                <div>
                  <div className="font-semibold">{prodId ? "Edit Offer" : "Create Offer"}</div>
                  <div className="text-xs opacity-70 mt-0.5">
                    Paste Stripe <code>price_...</code>. We store it in <code>products.metadata.stripe_price_id</code>.
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  {prodStripePriceId ? (
                    <span
                      className={`text-[11px] px-2 py-0.5 rounded-full border ${
                        String(prodStripePriceId).startsWith("price_")
                          ? "border-emerald-300 bg-emerald-50 text-emerald-800"
                          : "border-amber-300 bg-amber-50 text-amber-900"
                      }`}
                      title="Stripe Price ID validation"
                    >
                      {String(prodStripePriceId).startsWith("price_") ? "price id ok" : "check price id"}
                    </span>
                  ) : null}
                </div>
              </div>

              <div className="mt-3 grid grid-cols-1 gap-3">
                <label className="text-sm">
                  Title
                  <input
                    className="mt-1 w-full border rounded-xl p-2"
                    value={prodTitle}
                    onChange={(e) => setProdTitle(e.target.value)}
                    placeholder="Studio Access ‚Äî Priority Window"
                  />
                </label>

                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm">
                    Status
                    <select
                      className="mt-1 w-full border rounded-xl p-2"
                      value={prodStatus}
                      onChange={(e) => setProdStatus(e.target.value)}
                    >
                      <option value="active">active</option>
                      <option value="draft">draft</option>
                      <option value="archived">archived</option>
                    </select>
                  </label>

                  <label className="text-sm">
                    Tier
                    <select
                      className="mt-1 w-full border rounded-xl p-2"
                      value={prodTier}
                      onChange={(e) => setProdTier(e.target.value)}
                    >
                      {OFFER_TIER_OPTIONS.map((t) => (
                        <option key={t.value} value={t.value}>
                          {t.label}
                        </option>
                      ))}
                    </select>
                    <div className="text-[11px] opacity-60 mt-1">
                      Studio checkout expects <code>priority</code>, <code>producer</code>, <code>packaging</code>.
                    </div>
                  </label>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm">
                    Kind
                    <select className="mt-1 w-full border rounded-xl p-2" value={prodKind} onChange={(e) => setProdKind(e.target.value)}>
                      <option value="digital">digital</option>
                      <option value="service">service</option>
                      <option value="bundle">bundle</option>
                      <option value="custom">custom</option>
                    </select>
                  </label>

                  <label className="text-sm">
                    Display Price (optional)
                    <input
                      className="mt-1 w-full border rounded-xl p-2"
                      value={prodPriceDisplay}
                      onChange={(e) => setProdPriceDisplay(e.target.value)}
                      placeholder="2500"
                    />
                    <div className="text-[11px] opacity-60 mt-1">Stored in <code>products.price</code> (and metadata) for display.</div>
                  </label>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm">
                    Currency
                    <input className="mt-1 w-full border rounded-xl p-2" value={prodCurrency} onChange={(e) => setProdCurrency(e.target.value)} placeholder="usd" />
                  </label>

                  <label className="text-sm">
                    Stripe Price ID (required for checkout)
                    <input
                      className="mt-1 w-full border rounded-xl p-2 font-mono text-sm"
                      value={prodStripePriceId}
                      onChange={(e) => setProdStripePriceId(e.target.value)}
                      placeholder="price_123..."
                    />
                  </label>
                </div>

                <label className="text-sm">
                  Stripe Product ID (optional)
                  <input
                    className="mt-1 w-full border rounded-xl p-2 font-mono text-sm"
                    value={prodStripeProductId}
                    onChange={(e) => setProdStripeProductId(e.target.value)}
                    placeholder="prod_123..."
                  />
                </label>

                <label className="text-sm">
                  Image URL (optional)
                  <input className="mt-1 w-full border rounded-xl p-2" value={prodImageUrl} onChange={(e) => setProdImageUrl(e.target.value)} placeholder="https://..." />
                </label>

                <label className="text-sm">
                  Description (optional)
                  <textarea
                    className="mt-1 w-full border rounded-xl p-2 min-h-[90px]"
                    value={prodDescription}
                    onChange={(e) => setProdDescription(e.target.value)}
                    placeholder="What the buyer gets (deliverables, access, usage rights)."
                  />
                </label>

                <label className="text-sm">
                  Metadata JSON (optional)
                  <textarea
                    className="mt-1 w-full border rounded-xl p-2 min-h-[130px] font-mono text-xs"
                    value={prodMetadataStr}
                    onChange={(e) => setProdMetadataStr(e.target.value)}
                    placeholder={`{\n  "universe_id": "${selectedUniverseId}",\n  "tier": "producer",\n  "kind": "digital",\n  "stripe_price_id": "price_...",\n  "currency": "usd"\n}`}
                  />
                  <div className="text-[11px] opacity-60 mt-1">
                    Advanced: anything here is preserved, but <code>universe_id</code>, <code>offer_type</code>, <code>tier</code>, <code>access_tier</code>, <code>kind</code>, and Stripe fields are enforced from the form on Save.
                  </div>
                </label>

                <div className="flex gap-2 pt-1">
                  <button
                    className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50"
                    onClick={saveProduct}
                    disabled={saving || !selectedUniverseId || !prodTitle.trim()}
                  >
                    {saving ? "Saving‚Ä¶" : "Save Offer"}
                  </button>

                  {prodId ? (
                    <button
                      className="px-4 py-2 rounded-xl border border-red-300 bg-red-50 text-red-900 disabled:opacity-50"
                      onClick={deleteProduct}
                      disabled={saving}
                    >
                      Delete
                    </button>
                  ) : null}
                </div>

                <div className="text-xs opacity-60">Tip: If you don‚Äôt have a <code>price_</code> yet, create it in Stripe, then paste it here.</div>
              </div>
            </div>
          </div>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Universe picker */}
        <div className="rounded-2xl border border-gray-200 p-4 bg-white">
          <div className="font-semibold mb-2">Universe</div>
          {loading ? (
            <div className="opacity-70">Loading‚Ä¶</div>
          ) : universes.length === 0 ? (
            <div className="opacity-70">No universes yet.</div>
          ) : (
            <>
              <select
                className="w-full border rounded-xl p-2"
                value={selectedUniverseId}
                onChange={(e) => setSelectedUniverseId(e.target.value)}
              >
                {universes.map((u) => (
                  <option key={u.id} value={u.id}>
                    {u.title} ({u.status || "draft"})
                  </option>
                ))}
              </select>

              {selectedUniverse?.slug ? (
                <div className="mt-3 grid grid-cols-2 gap-2">
                  <a
                    className="inline-flex w-full justify-center px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50"
                    href={`/studios/${selectedUniverse.slug}`}
                    target="_blank"
                    rel="noreferrer"
                  >
                    Public ‚Üí
                  </a>
                  <a
                    className="inline-flex w-full justify-center px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50"
                    href={`/studios/${selectedUniverse.slug}?vault=1`}
                    target="_blank"
                    rel="noreferrer"
                    title="Shows vault pages if your studios/[slug] supports ?vault=1"
                  >
                    Vault ‚Üí
                  </a>
                </div>
              ) : (
                <div className="mt-3 text-xs opacity-70">
                  Tip: add a <code>slug</code> to this universe to enable upload paths + preview links.
                </div>
              )}
            </>
          )}
        </div>

        {/* Pages list */}
        <div className="rounded-2xl border border-gray-200 p-4 bg-white">
          <div className="flex items-center justify-between gap-3 mb-2">
            <div className="font-semibold">Pages</div>
            <button
              className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm hover:bg-gray-50 disabled:opacity-50"
              onClick={resetEditor}
              disabled={!selectedUniverseId}
            >
              + New
            </button>
          </div>

          {loadingPages ? (
            <div className="opacity-70">Loading pages‚Ä¶</div>
          ) : pages.length === 0 ? (
            <div className="opacity-70 text-sm">No studio pages yet.</div>
          ) : (
            <div className="space-y-2">
              {pages.map((pg) => {
                const md = pg.metadata && typeof pg.metadata === "object" ? pg.metadata : safeJsonParse(pg.metadata, {});
                const visibility = String(md?.visibility || "public") === "vault" ? "vault" : "public";
                const atts = Array.isArray(md?.attachments) ? md.attachments : [];
                const counts = countAttachmentsByKind(atts);
                const totalAtts = (atts || []).length;

                return (
                  <button
                    key={pg.id}
                    onClick={() => selectPage(pg)}
                    className={`w-full text-left p-3 rounded-2xl border transition ${
                      pId === pg.id ? "border-black" : "border-gray-200 hover:border-gray-300"
                    }`}
                  >
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <div className="font-semibold leading-tight">{pg.title}</div>
                        <div className="text-xs opacity-70 mt-0.5">
                          <span className="font-mono">{pg.page_type}</span> ‚Ä¢ sort {pg.sort_order}
                        </div>
                      </div>

                      <div className="flex items-center gap-2 flex-wrap justify-end">
                        {visibility === "vault" ? (
                          <span className="px-2 py-0.5 rounded-full border text-xs border-slate-300 bg-slate-50 text-slate-800">
                            vault
                          </span>
                        ) : null}

                        <span
                          className={`px-2 py-0.5 rounded-full border text-xs ${
                            pg.status === "published"
                              ? "border-emerald-300 bg-emerald-50 text-emerald-800"
                              : "border-amber-300 bg-amber-50 text-amber-900"
                          }`}
                        >
                          {pg.status}
                        </span>

                        {totalAtts ? (
                          <span className="px-2 py-0.5 rounded-full border text-xs border-gray-300 bg-gray-50 text-gray-800">
                            {totalAtts} media
                            <span className="opacity-70">
                              {" "}
                              ¬∑ i{counts.image} v{counts.video} a{counts.audio}
                            </span>
                          </span>
                        ) : null}
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          )}
        </div>

        {/* Editor */}
        <div className="rounded-2xl border border-gray-200 p-4 bg-white lg:col-span-1">
          <div className="flex items-start justify-between gap-3 mb-3">
            <div className="font-semibold">{pId ? "Edit Studio Page" : "Create Studio Page"}</div>
            {pId ? (
              <button
                className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm hover:bg-gray-50 disabled:opacity-50"
                onClick={() => {
                  if (!pExcerpt?.trim()) {
                    const raw = asStr(pContent).replace(/\s+/g, " ").trim();
                    setPExcerpt(raw.slice(0, 240));
                  }
                }}
                disabled={saving}
                title="Fill excerpt from the first part of content (up to 240 chars)"
              >
                Auto Excerpt
              </button>
            ) : null}
          </div>

          {/* Everything below is unchanged from your original file (pages editor + attachments + library) */}
          {/* (kept intact to avoid breaking your current workflow) */}

          <div className="grid grid-cols-1 gap-3">
            <label className="text-sm">
              Title
              <input className="mt-1 w-full border rounded-xl p-2" value={pTitle} onChange={(e) => setPTitle(e.target.value)} />
            </label>
            <label className="text-sm">
              Type
              <select className="mt-1 w-full border rounded-xl p-2" value={pType} onChange={(e) => setPType(e.target.value)}>
                {PAGE_TYPES.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </select>
              <div className="text-[11px] opacity-60 mt-1">Use the 25 page types for Hollywood packaging. Legacy types still supported.</div>
            </label>
            <div className="grid grid-cols-2 gap-3">
              <label className="text-sm">
                Status
                <select className="mt-1 w-full border rounded-xl p-2" value={pStatus} onChange={(e) => setPStatus(e.target.value)}>
                  <option value="draft">draft</option>
                  <option value="published">published</option>
                </select>
              </label>
              <label className="text-sm">
                Sort
                <input className="mt-1 w-full border rounded-xl p-2" value={String(pSort)} onChange={(e) => setPSort(e.target.value)} />
              </label>
            </div>
            <label className="text-sm">
              Visibility
              <select className="mt-1 w-full border rounded-xl p-2" value={pVisibility} onChange={(e) => setPVisibility(e.target.value)}>
                <option value="public">public</option>
                <option value="vault">vault (deal docs / private)</option>
              </select>
              <div className="text-[11px] opacity-60 mt-1">
                Stored in <code>studio_pages.metadata.visibility</code> (no schema change).
              </div>
            </label>
            <label className="text-sm">
              Excerpt (optional ‚Ä¢ max ~240 chars recommended)
              <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[70px]" value={pExcerpt} onChange={(e) => setPExcerpt(e.target.value)} />
            </label>
            <div className="grid grid-cols-1 gap-3">
              <label className="text-sm">
                Hero Image URL (optional)
                <input className="mt-1 w-full border rounded-xl p-2" value={pHeroImg} onChange={(e) => setPHeroImg(e.target.value)} />
              </label>
              <label className="text-sm">
                Hero Video URL (optional)
                <input className="mt-1 w-full border rounded-xl p-2" value={pHeroVid} onChange={(e) => setPHeroVid(e.target.value)} />
              </label>
            </div>

            {/* ‚úÖ Attachments */}
            <div className="rounded-2xl border border-gray-200 p-3">
              <div className="flex items-start justify-between gap-3 flex-wrap">
                <div>
                  <div className="font-semibold">Media Attachments</div>
                  <div className="text-xs opacity-70">
                    Stored in <code>metadata.attachments</code>. Keep pages ‚Äúpaper-scan‚Äù + attach lookbooks, posters, teasers, audio.
                  </div>
                </div>
                <div className="flex items-center gap-2 flex-wrap">
                  <button
                    className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm hover:bg-gray-50 disabled:opacity-50"
                    onClick={() => addAttachment({ kind: "link", media_type: "other" })}
                    disabled={saving || (pAttachments || []).length >= MAX_ATTACHMENTS}
                    title="Add a blank attachment row (link or file URL)"
                  >
                    + Add
                  </button>
                  <button
                    className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm hover:bg-gray-50 disabled:opacity-50"
                    onClick={() => uploadInputRef.current?.click()}
                    disabled={saving || !selectedUniverse?.slug}
                    title={!selectedUniverse?.slug ? "Add a universe slug to enable uploads" : "Upload files to Supabase Storage and attach"}
                  >
                    Upload
                  </button>
                  <input
                    ref={uploadInputRef}
                    type="file"
                    multiple
                    className="hidden"
                    accept=".png,.jpg,.jpeg,.webp,.gif,.mp3,.wav,.m4a,.aac,.ogg,.mp4,.mov,.webm,.pdf"
                    onChange={(e) => onUploadFiles(Array.from(e.target.files || []))}
                  />
                </div>
              </div>

              <div className="mt-2 flex items-center gap-2 flex-wrap text-xs">
                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">
                  images <b>{editorAttachmentsCounts.image}</b>
                </span>
                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">
                  video <b>{editorAttachmentsCounts.video}</b>
                </span>
                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">
                  audio <b>{editorAttachmentsCounts.audio}</b>
                </span>
                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">
                  docs <b>{editorAttachmentsCounts.document}</b>
                </span>
                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">
                  links <b>{editorAttachmentsCounts.link}</b>
                </span>
              </div>

              {(pAttachments || []).length === 0 ? (
                <div className="mt-3 text-sm opacity-70">No attachments yet.</div>
              ) : (
                <div className="mt-3 space-y-3">
                  {(pAttachments || []).map((a, idx) => (
                    <div key={a.id} className="rounded-2xl border border-gray-200 p-3">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="text-xs opacity-60">Attachment {idx + 1}</div>
                          <div className="font-semibold truncate">{a.title || "(untitled)"}</div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            className="px-2 py-1 rounded-lg border border-gray-300 text-xs hover:bg-gray-50"
                            onClick={() => moveAttachment(a.id, -1)}
                            disabled={idx === 0}
                            title="Move up"
                          >
                            ‚Üë
                          </button>
                          <button
                            className="px-2 py-1 rounded-lg border border-gray-300 text-xs hover:bg-gray-50"
                            onClick={() => moveAttachment(a.id, 1)}
                            disabled={idx === (pAttachments || []).length - 1}
                            title="Move down"
                          >
                            ‚Üì
                          </button>
                          <button
                            className="px-2 py-1 rounded-lg border border-red-300 bg-red-50 text-xs text-red-900 hover:bg-red-100"
                            onClick={() => removeAttachment(a.id)}
                            title="Remove"
                          >
                            Remove
                          </button>
                        </div>
                      </div>

                      <div className="mt-3 grid grid-cols-1 gap-3">
                        <div className="grid grid-cols-2 gap-3">
                          <label className="text-xs">
                            Kind
                            <select
                              className="mt-1 w-full border rounded-xl p-2 text-sm"
                              value={a.kind}
                              onChange={(e) => updateAttachment(a.id, { kind: e.target.value })}
                            >
                              <option value="image">image</option>
                              <option value="video">video</option>
                              <option value="audio">audio</option>
                              <option value="document">document</option>
                              <option value="link">link</option>
                            </select>
                          </label>
                          <label className="text-xs">
                            Media Type
                            <select
                              className="mt-1 w-full border rounded-xl p-2 text-sm"
                              value={a.media_type}
                              onChange={(e) => updateAttachment(a.id, { media_type: e.target.value })}
                            >
                              <option value="poster">poster</option>
                              <option value="lookbook">lookbook</option>
                              <option value="trailer">trailer</option>
                              <option value="theme">theme</option>
                              <option value="cue">cue</option>
                              <option value="stinger">stinger</option>
                              <option value="packet">packet</option>
                              <option value="other">other</option>
                            </select>
                          </label>
                        </div>

                        <label className="text-xs">
                          Title
                          <input
                            className="mt-1 w-full border rounded-xl p-2 text-sm"
                            value={a.title}
                            onChange={(e) => updateAttachment(a.id, { title: e.target.value })}
                            placeholder="Main Theme ‚Ä¢ Official"
                          />
                        </label>

                        <label className="text-xs">
                          URL (required)
                          <input
                            className="mt-1 w-full border rounded-xl p-2 text-sm"
                            value={a.url}
                            onChange={(e) => {
                              const url = e.target.value;
                              const inferredKind = guessKindFromUrl(url);
                              updateAttachment(a.id, { url, kind: a.kind === "link" ? inferredKind : a.kind });
                            }}
                            placeholder="https://‚Ä¶"
                          />
                        </label>

                        <label className="text-xs">
                          Thumbnail URL (optional)
                          <input
                            className="mt-1 w-full border rounded-xl p-2 text-sm"
                            value={a.thumbnail_url}
                            onChange={(e) => updateAttachment(a.id, { thumbnail_url: e.target.value })}
                            placeholder="https://‚Ä¶"
                          />
                        </label>

                        <div className="grid grid-cols-2 gap-3">
                          <label className="text-xs">
                            Duration (optional)
                            <input
                              className="mt-1 w-full border rounded-xl p-2 text-sm"
                              value={a.duration}
                              onChange={(e) => updateAttachment(a.id, { duration: e.target.value })}
                              placeholder="0:45"
                            />
                          </label>
                          <label className="text-xs">
                            BPM (audio optional)
                            <input
                              className="mt-1 w-full border rounded-xl p-2 text-sm"
                              value={a.bpm ?? ""}
                              onChange={(e) => updateAttachment(a.id, { bpm: e.target.value })}
                              placeholder="90"
                            />
                          </label>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <label className="text-xs">
                            License Tier (audio optional)
                            <input
                              className="mt-1 w-full border rounded-xl p-2 text-sm"
                              value={a.license_tier}
                              onChange={(e) => updateAttachment(a.id, { license_tier: e.target.value })}
                              placeholder="Pitch / Web / Full"
                            />
                          </label>
                          <label className="text-xs">
                            Tags (comma separated)
                            <input
                              className="mt-1 w-full border rounded-xl p-2 text-sm"
                              value={(a.tags || []).join(", ")}
                              onChange={(e) => updateAttachment(a.id, { tags: e.target.value })}
                              placeholder="soundtrack, trailer, lohc"
                            />
                          </label>
                        </div>

                        <label className="text-xs">
                          Notes (optional)
                          <textarea
                            className="mt-1 w-full border rounded-xl p-2 text-sm min-h-[70px]"
                            value={a.notes}
                            onChange={(e) => updateAttachment(a.id, { notes: e.target.value })}
                            placeholder="Use: cold open / act break / end card‚Ä¶"
                          />
                        </label>

                        <div className="flex items-center gap-2 flex-wrap">
                          {a.url ? (
                            <a
                              className="px-3 py-1.5 rounded-xl border border-gray-300 text-xs hover:bg-gray-50"
                              href={a.url}
                              target="_blank"
                              rel="noreferrer"
                            >
                              Open URL ‚Üí
                            </a>
                          ) : null}
                          {a.thumbnail_url ? (
                            <a
                              className="px-3 py-1.5 rounded-xl border border-gray-300 text-xs hover:bg-gray-50"
                              href={a.thumbnail_url}
                              target="_blank"
                              rel="noreferrer"
                            >
                              Open Thumb ‚Üí
                            </a>
                          ) : null}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Library Picker */}
              <div className="mt-4 rounded-2xl border border-gray-200 p-3 bg-gray-50">
                <div className="flex items-start justify-between gap-3 flex-wrap">
                  <div>
                    <div className="font-semibold">Add from Media Library</div>
                    <div className="text-xs opacity-70">
                      Pulls from your DB (tries <code>media</code> table, then <code>products</code>). Adds selected items into this page‚Äôs attachments.
                    </div>
                  </div>
                  <button
                    className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm hover:bg-white disabled:opacity-50"
                    onClick={() => loadMediaLibrary(attPickerQuery)}
                    disabled={attPickerBusy || saving}
                  >
                    {attPickerBusy ? "Loading‚Ä¶" : "Refresh"}
                  </button>
                </div>

                <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input
                    className="border rounded-xl p-2 text-sm"
                    value={attPickerQuery}
                    onChange={(e) => setAttPickerQuery(e.target.value)}
                    placeholder="Search title / tags‚Ä¶"
                  />
                  <select
                    className="border rounded-xl p-2 text-sm"
                    value={attPickerKind}
                    onChange={(e) => setAttPickerKind(e.target.value)}
                  >
                    <option value="all">all kinds</option>
                    <option value="image">image</option>
                    <option value="video">video</option>
                    <option value="audio">audio</option>
                    <option value="document">document</option>
                    <option value="link">link</option>
                  </select>
                  <button
                    className="px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-white disabled:opacity-50"
                    onClick={() => loadMediaLibrary(attPickerQuery)}
                    disabled={attPickerBusy || saving}
                  >
                    Search
                  </button>
                </div>

                <div className="mt-3">
                  {libraryItems.length === 0 ? (
                    <div className="text-sm opacity-70">No library items loaded yet. Hit Refresh.</div>
                  ) : (
                    <div className="space-y-2 max-h-[260px] overflow-auto pr-1">
                      {libraryItems.map((it) => (
                        <div
                          key={it._key}
                          className="rounded-2xl border border-gray-200 bg-white p-3 flex items-start justify-between gap-3"
                        >
                          <div className="min-w-0">
                            <div className="font-semibold truncate">{it.title || "(untitled)"}</div>
                            <div className="text-xs opacity-70 mt-0.5">
                              <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">{it.kind}</span>{" "}
                              <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">{it.media_type}</span>{" "}
                              {it.license_tier ? (
                                <span className="px-2 py-0.5 rounded-full border border-gray-300 bg-gray-50">{it.license_tier}</span>
                              ) : null}
                            </div>
                            {it.url ? <div className="text-xs opacity-60 truncate mt-1">{it.url}</div> : null}
                          </div>
                          <div className="flex items-center gap-2">
                            {it.url ? (
                              <a
                                className="px-3 py-1.5 rounded-xl border border-gray-300 text-xs hover:bg-gray-50"
                                href={it.url}
                                target="_blank"
                                rel="noreferrer"
                              >
                                Open
                              </a>
                            ) : null}
                            <button
                              className="px-3 py-1.5 rounded-xl bg-black text-white text-xs hover:opacity-90 disabled:opacity-50"
                              onClick={() => addFromLibrary(it)}
                              disabled={(pAttachments || []).length >= MAX_ATTACHMENTS}
                              title="Add to this page‚Äôs attachments"
                            >
                              + Attach
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>

            <label className="text-sm">
              Metadata JSON (optional)
              <textarea
                className="mt-1 w-full border rounded-xl p-2 min-h-[110px] font-mono text-xs"
                value={pMetaStr}
                onChange={(e) => setPMetaStr(e.target.value)}
                placeholder={`{\n "visibility": "public",\n "attachments": []\n}`}
              />
              <div className="text-[11px] opacity-60 mt-1">
                Advanced: any extra metadata you add here will be preserved, but <code>visibility</code> and <code>attachments</code> are enforced from the UI on Save.
              </div>
            </label>

            <label className="text-sm">
              Content (Markdown or plain text ‚Äî paste)
              <textarea
                className="mt-1 w-full border rounded-xl p-3 min-h-[240px] font-mono text-xs"
                value={pContent}
                onChange={(e) => setPContent(e.target.value)}
                placeholder={`# ${pTitle || "Studio Page"}\n\n(Write/paste here.)\n`}
              />
            </label>
          </div>

          <div className="mt-4 flex gap-2">
            <button
              className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50"
              onClick={savePage}
              disabled={saving || !selectedUniverseId || !pTitle.trim()}
            >
              {saving ? "Saving‚Ä¶" : "Save"}
            </button>
            {pId ? (
              <button
                className="px-4 py-2 rounded-xl border border-red-300 bg-red-50 text-red-900 disabled:opacity-50"
                onClick={deletePage}
                disabled={saving}
              >
                Delete
              </button>
            ) : null}
          </div>
        </div>
      </div>
    </div>
  );
}


===== FILE: components/admin/TechShowcaseForm.js  (size=12924 bytes) =====
// components/admin/TechShowcaseForm.js
import React, { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase'; // ‚úÖ client-side Supabase

function parseList(str) {
  return (str || '')
    .split(',')
    .map((s) => s.trim())
    .filter(Boolean);
}

export default function TechShowcaseForm({
  onCreated,
  editingPost, // optional post to edit
  clearEditing, // callback to exit edit mode
}) {
  const isEditing = Boolean(editingPost?.id);

  const [title, setTitle] = useState('');
  const [slug, setSlug] = useState('');
  const [excerpt, setExcerpt] = useState('');
  const [description, setDescription] = useState('');
  const [featuredImage, setFeaturedImage] = useState('');
  const [tagline, setTagline] = useState('');
  const [appUrl, setAppUrl] = useState('');
  const [platformsText, setPlatformsText] = useState('');
  const [labelsText, setLabelsText] = useState('');
  const [appCategory, setAppCategory] = useState('flagship'); // 'flagship' | 'upcoming'
  const [appType, setAppType] = useState('app'); // 'app' | 'website'
  const [status, setStatus] = useState('Live'); // UI status badge

  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');

  // Hydrate form when entering/exiting edit mode
  useEffect(() => {
    if (!editingPost) {
      setTitle('');
      setSlug('');
      setExcerpt('');
      setDescription('');
      setFeaturedImage('');
      setTagline('');
      setAppUrl('');
      setPlatformsText('');
      setLabelsText('');
      setAppCategory('flagship');
      setAppType('app');
      setStatus('Live');
      setError('');
      return;
    }

    const meta = editingPost.metadata || {};

    setTitle(editingPost.title || '');
    setSlug(editingPost.slug || '');
    setExcerpt(editingPost.excerpt || '');
    setDescription(editingPost.content || '');
    setFeaturedImage(editingPost.featured_image || '');
    setTagline(meta.tagline || '');
    setAppUrl(meta.app_url || '');
    setPlatformsText(
      Array.isArray(meta.platforms) ? meta.platforms.join(', ') : ''
    );
    setLabelsText(
      Array.isArray(meta.labels) ? meta.labels.join(', ') : ''
    );
    setAppCategory(meta.app_category || 'flagship');
    setAppType(meta.app_type || 'app');
    setStatus(meta.status || 'Live');
    setError('');
  }, [editingPost]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSaving(true);
    setError('');

    try {
      if (!title) throw new Error('Title is required');

      const finalSlug =
        slug ||
        title
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)+/g, '');

      const metadata = {
        app_category: appCategory,
        app_type: appType,
        status,
        app_url: appUrl,
        tagline,
        platforms: parseList(platformsText),
        labels: parseList(labelsText),
      };

      if (isEditing) {
        // UPDATE existing row (keep posts.status as-is)
        const { error: updateError } = await supabase
          .from('posts')
          .update({
            title,
            slug: finalSlug,
            division: 'tech',
            excerpt: excerpt || (description || '').slice(0, 180),
            content: description,
            featured_image: featuredImage,
            metadata,
          })
          .eq('id', editingPost.id)
          .select()
          .single();

        if (updateError) throw updateError;
      } else {
        // INSERT new row with posts.status = 'published'
        const { error: insertError } = await supabase
          .from('posts')
          .insert({
            title,
            slug: finalSlug,
            division: 'tech',
            status: 'published',
            excerpt: excerpt || (description || '').slice(0, 180),
            content: description,
            featured_image: featuredImage,
            metadata,
          })
          .select()
          .single();

        if (insertError) throw insertError;
      }

      onCreated?.();

      if (isEditing) {
        clearEditing?.();
      } else {
        // reset for next create
        setTitle('');
        setSlug('');
        setExcerpt('');
        setDescription('');
        setFeaturedImage('');
        setTagline('');
        setAppUrl('');
        setPlatformsText('');
        setLabelsText('');
        setAppCategory('flagship');
        setAppType('app');
        setStatus('Live');
      }
    } catch (err) {
      console.error('TechShowcaseForm save error', err);
      setError(err.message || 'Failed to save showcase item');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div>
      <div className="flex items-center justify-between gap-3 mb-2">
        <h3 className="font-semibold">
          {isEditing ? 'Edit Tech Showcase Item' : 'Add Tech Showcase Item'}
        </h3>

        {isEditing && (
          <button
            type="button"
            onClick={clearEditing}
            className="text-xs px-3 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800"
          >
            Cancel editing
          </button>
        )}
      </div>

      <p className="text-xs mb-4 opacity-80">
        Use this to add or edit <strong>Daito</strong>, <strong>Nexu</strong>,{' '}
        <strong>RealKenyans</strong>, <strong>Manyagi.net</strong>, and any
        future Manyagi Tech apps. Everything you put here will drive the
        <code> /tech</code> page.
      </p>

      <form onSubmit={handleSubmit} className="space-y-4 text-sm">
        {/* Title + slug */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-semibold mb-1">Title</label>
            <input
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              placeholder="Daito ‚Äî Delivery & Marketplace"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              required
            />
          </div>

          <div>
            <label className="block text-xs font-semibold mb-1">
              Slug (optional)
            </label>
            <input
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              placeholder="daito-delivery-app"
              value={slug}
              onChange={(e) => setSlug(e.target.value)}
            />
            <p className="text-[11px] text-gray-500 mt-1">
              Leave blank to auto-generate from the title.
            </p>
          </div>
        </div>

        {/* Tagline + URL */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-semibold mb-1">Tagline</label>
            <input
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              placeholder="Buy, sell, and get anything delivered across your city."
              value={tagline}
              onChange={(e) => setTagline(e.target.value)}
            />
          </div>

          <div>
            <label className="block text-xs font-semibold mb-1">
              App / Site URL
            </label>
            <input
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              placeholder="https://daitoapp.net"
              value={appUrl}
              onChange={(e) => setAppUrl(e.target.value)}
            />
          </div>
        </div>

        {/* Featured image */}
        <div>
          <label className="block text-xs font-semibold mb-1">
            Featured Image URL
          </label>
          <input
            className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
            placeholder="https://.../daito-screenshot.webp"
            value={featuredImage}
            onChange={(e) => setFeaturedImage(e.target.value)}
          />
          <p className="text-[11px] text-gray-500 mt-1">
            Use a Supabase image URL or static <code>/images/...</code> path.
          </p>
        </div>

        {/* Excerpt + description */}
        <div>
          <label className="block text-xs font-semibold mb-1">
            Short Excerpt
          </label>
          <textarea
            className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 h-16"
            placeholder="One or two sentences that summarize the product."
            value={excerpt}
            onChange={(e) => setExcerpt(e.target.value)}
          />
        </div>

        <div>
          <label className="block text-xs font-semibold mb-1">
            Full Description
          </label>
          <textarea
            className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 h-28"
            placeholder="Longer description of what this app does, who it serves, and any key features."
            value={description}
            onChange={(e) => setDescription(e.target.value)}
          />
        </div>

        {/* Platforms + labels */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-semibold mb-1">
              Platforms (comma-separated)
            </label>
            <input
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              placeholder="iOS, Android, Web"
              value={platformsText}
              onChange={(e) => setPlatformsText(e.target.value)}
            />
          </div>
          <div>
            <label className="block text-xs font-semibold mb-1">
              Labels / Tags (comma-separated)
            </label>
            <input
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              placeholder="Delivery, E-commerce, Logistics"
              value={labelsText}
              onChange={(e) => setLabelsText(e.target.value)}
            />
          </div>
        </div>

        {/* Category + type + status */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label className="block text-xs font-semibold mb-1">
              Category
            </label>
            <select
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              value={appCategory}
              onChange={(e) => setAppCategory(e.target.value)}
            >
              <option value="flagship">Flagship / Live</option>
              <option value="upcoming">Upcoming / Labs</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-semibold mb-1">Type</label>
            <select
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              value={appType}
              onChange={(e) => setAppType(e.target.value)}
            >
              <option value="app">App</option>
              <option value="website">Website</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-semibold mb-1">Status</label>
            <select
              className="w-full rounded border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
            >
              <option>Live</option>
              <option>Beta</option>
              <option>Prototype</option>
              <option>In Design</option>
            </select>
          </div>
        </div>

        {error && <p className="text-xs text-red-500">{error}</p>}

        <button
          type="submit"
          disabled={saving}
          className="px-4 py-2 rounded bg-blue-600 text-white text-xs font-semibold disabled:opacity-60"
        >
          {saving
            ? isEditing
              ? 'Saving changes‚Ä¶'
              : 'Saving‚Ä¶'
            : isEditing
            ? 'Save Changes'
            : 'Add Showcase Item'}
        </button>
      </form>
    </div>
  );
}


===== FILE: components/admin/TechTab.js  (size=5696 bytes) =====
// components/admin/TechTab.js
import React, { useState } from 'react';
import TechShowcaseForm from '@/components/admin/TechShowcaseForm';
import SectionCard from '@/components/admin/SectionCard';
import { deleteRow } from '@/lib/adminUtils';

export default function TechTab({ posts: allPosts, refreshAll }) {
  const techPosts = (allPosts || []).filter((p) => p.division === 'tech');
  const [editingPost, setEditingPost] = useState(null);

  return (
    <SectionCard title="Tech Division">
      {/* Create / edit form */}
      <TechShowcaseForm
        onCreated={refreshAll}
        editingPost={editingPost}
        clearEditing={() => setEditingPost(null)}
      />

      {/* Existing showcase items */}
      <div className="mt-8">
        <h3 className="font-semibold mb-3">Showcase Items (Tech)</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Title</th>
              <th>Slug</th>
              <th>Category / Type</th>
              <th>URL</th>
              <th>Image</th>
              <th>Metadata JSON</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {techPosts.map((p) => {
              const meta = p.metadata || {};
              return (
                <tr
                  key={p.id}
                  className="border-b dark:border-gray-800 align-top"
                >
                  <td className="py-2 font-semibold">
                    {p.title}
                    {meta.tagline && (
                      <div className="text-[11px] text-gray-500 mt-0.5">
                        {meta.tagline}
                      </div>
                    )}
                  </td>

                  <td className="py-2 text-xs text-gray-400">{p.slug}</td>

                  <td className="py-2 text-xs">
                    <div>
                      <span className="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-800 px-2 py-0.5 text-[10px] mr-1">
                        {meta.app_category || 'flagship'}
                      </span>
                      <span className="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-800 px-2 py-0.5 text-[10px] mr-1">
                        {meta.app_type || 'app'}
                      </span>
                    </div>
                    {meta.status && (
                      <div className="mt-1 text-[11px] text-gray-500">
                        Status: {meta.status}
                      </div>
                    )}
                  </td>

                  <td className="py-2 text-xs max-w-[180px] break-words">
                    {meta.app_url ? (
                      <a
                        href={meta.app_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="underline"
                      >
                        {meta.app_url}
                      </a>
                    ) : (
                      '‚Äî'
                    )}
                  </td>

                  <td className="py-2">
                    {p.featured_image ? (
                      <img
                        src={p.featured_image}
                        className="w-16 h-16 object-cover rounded"
                        alt={p.title}
                      />
                    ) : (
                      '‚Äî'
                    )}
                  </td>

                  <td className="py-2 min-w-[220px]">
                    <textarea
                      className="w-full h-24 dark:bg-gray-800 text-xs"
                      value={JSON.stringify(meta, null, 2)}
                      readOnly
                    />
                  </td>

                  <td className="py-2 space-y-2">
                    <button
                      className="px-3 py-1 bg-blue-600 text-white rounded w-full text-xs"
                      onClick={() => {
                        setEditingPost(p);
                        if (typeof window !== 'undefined') {
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                      }}
                    >
                      Edit
                    </button>
                    <button
                      className="px-3 py-1 bg-red-600 text-white rounded w-full text-xs"
                      onClick={() =>
                        deleteRow(
                          'posts',
                          p.id,
                          () => {
                            if (editingPost?.id === p.id) {
                              setEditingPost(null);
                            }
                            refreshAll?.();
                          },
                          'Delete this Tech showcase item?'
                        )
                      }
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              );
            })}

            {techPosts.length === 0 && (
              <tr>
                <td colSpan={7} className="py-6 text-center opacity-70">
                  No showcase items yet. Add Daito, Nexu, RealKenyans, and
                  Manyagi.net above to populate the Tech page.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/UniversesTab.js  (size=111017 bytes) =====
import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import { supabase } from "@/lib/supabase";
/** =========================
 * Utils
 * ========================= */
function slugify(str = "") {
  return String(str)
    .toLowerCase()
    .trim()
    .replace(/['"]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/(^-|-$)/g, "");
}
function toMoney(cents = 0) {
  const n = Number(cents || 0);
  return (n / 100).toFixed(2);
}
function clampInt(v, fallback = 0) {
  const n = parseInt(String(v ?? ""), 10);
  return Number.isFinite(n) ? n : fallback;
}
function safeJsonParse(str, fallback = {}) {
  try {
    if (!str || !String(str).trim()) return fallback;
    const v = JSON.parse(str);
    return v && typeof v === "object" ? v : fallback;
  } catch {
    return fallback;
  }
}
function extFromFile(file) {
  const name = String(file?.name || "");
  const idx = name.lastIndexOf(".");
  return idx >= 0 ? name.slice(idx + 1).toLowerCase() : "bin";
}
function isLikelyMp4Url(url = "") {
  return String(url || "").toLowerCase().includes(".mp4");
}
function isAudioLikeUrl(url = "") {
  return /\.(mp3|wav|m4a|ogg)$/i.test(String(url || "").split("?")[0]);
}
function safeMeta(meta) {
  if (!meta) return {};
  if (typeof meta === "object") return meta;
  if (typeof meta === "string") {
    try {
      const v = JSON.parse(meta);
      return v && typeof v === "object" ? v : {};
    } catch {
      return {};
    }
  }
  return {};
}
/** =========================
 * ‚úÖ Storage helpers (CLIENT-SAFE)
 * ========================= */
const DEFAULT_BUCKET = process.env.NEXT_PUBLIC_STORAGE_BUCKET || "assets";
function normalizeExt(file) {
  const ext = extFromFile(file);
  return ext === "jpeg" ? "jpg" : ext;
}
function isMp4File(file) {
  const t = String(file?.type || "").toLowerCase();
  const n = String(file?.name || "").toLowerCase();
  return t === "video/mp4" || n.endsWith(".mp4");
}
function isImageFile(file) {
  const t = String(file?.type || "").toLowerCase();
  const n = String(file?.name || "").toLowerCase();
  return t.startsWith("image/") || /\.(png|jpg|jpeg|webp|gif)$/i.test(n);
}
function assertAllowed(file, allowed) {
  if (!file) throw new Error("No file selected.");
  if (allowed.includes("image") && isImageFile(file)) return;
  if (allowed.includes("mp4") && isMp4File(file)) return;
  const allowedText = allowed.join(", ");
  throw new Error(`Invalid file type. Allowed: ${allowedText}`);
}
function makeSafeFileName(file) {
  const ext = normalizeExt(file);
  const base = String(file?.name || "file")
    .toLowerCase()
    .replace(/\.[^/.]+$/, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/(^-|-$)/g, "");
  const rand = Math.random().toString(16).slice(2);
  return `${Date.now()}-${base || "file"}-${rand}.${ext}`;
}
async function uploadToStorage({
  bucket = DEFAULT_BUCKET,
  file,
  folder,
  upsert = true,
  allowed = ["image"], // ["image"], ["mp4"], ["image","mp4"]
}) {
  if (!bucket) throw new Error("No storage bucket selected.");
  assertAllowed(file, allowed);
  const safeName = makeSafeFileName(file);
  const path = `${folder}/${safeName}`;
  const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, {
    upsert,
    contentType: file.type || "application/octet-stream",
    cacheControl: "3600",
  });
  if (upErr) throw upErr;
  const { data } = supabase.storage.from(bucket).getPublicUrl(path);
  const publicUrl = data?.publicUrl;
  if (!publicUrl) throw new Error("Failed to get public URL.");
  return { publicUrl, path, bucket };
}
export default function UniversesTab() {
  /** =========================
   * State
   * ========================= */
  const [universes, setUniverses] = useState([]);
  const [selectedUniverse, setSelectedUniverse] = useState(null);
  const [assets, setAssets] = useState([]);
  const [loading, setLoading] = useState(true);
  const [savingUniverse, setSavingUniverse] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [notice, setNotice] = useState(null); // {type,msg}
  // ‚úÖ Storage bucket handling
  const [buckets, setBuckets] = useState([]);
  const [storageBucket, setStorageBucket] = useState(""); // chosen bucket
  const [bucketReady, setBucketReady] = useState(false);
  // Universe form
  const [uTitle, setUTitle] = useState("");
  const [uSlug, setUSlug] = useState("");
  const [uTagline, setUTagline] = useState("");
  const [uLogline, setULogline] = useState("");
  const [uSynopsis, setUSynopsis] = useState("");
  const [uCover, setUCover] = useState("");
  const [uHeroVideo, setUHeroVideo] = useState("");
  const [uTrailerVideo, setUTrailerVideo] = useState("");
  const [uWorldMap, setUWorldMap] = useState("");
  const [uStatus, setUStatus] = useState("draft"); // draft|published
  // Product search (existing)
  const [division, setDivision] = useState("publishing");
  const [query, setQuery] = useState("");
  const [productResults, setProductResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const lastSearchKey = useRef("");
  // ‚úÖ NEW: Media search (posts division=media)
  const [mediaQuery, setMediaQuery] = useState("");
  const [mediaTypeFilter, setMediaTypeFilter] = useState("all"); // all|soundtrack|score|trailer|audiobook|chapter_read|scene|playlist|musicvideo
  const [mediaResults, setMediaResults] = useState([]);
  const [mediaSearching, setMediaSearching] = useState(false);
  const lastMediaSearchKey = useRef("");
  // Universe asset CRUD
  const [assetEdits, setAssetEdits] = useState({});
  const [savingAssetIds, setSavingAssetIds] = useState({});
  // Quick-add (existing)
  const [qaDivision, setQaDivision] = useState("studios");
  const [qaType, setQaType] = useState("trailer");
  const [qaTitle, setQaTitle] = useState("");
  const [qaDesc, setQaDesc] = useState("");
  const [qaUrl, setQaUrl] = useState("");
  const [qaThumb, setQaThumb] = useState("");
  const [qaPublic, setQaPublic] = useState(true);
  const [qaPrice, setQaPrice] = useState("");
  const [qaStatus, setQaStatus] = useState("published");
  const [qaMetaStr, setQaMetaStr] = useState("");
  // Studio Pages (keep intact)
  const [studioPages, setStudioPages] = useState([]);
  const [loadingPages, setLoadingPages] = useState(false);
  const [savingPageId, setSavingPageId] = useState(null);
  const [pId, setPId] = useState(null);
  const [pType, setPType] = useState("one_sheet");
  const [pTitle, setPTitle] = useState("");
  const [pStatus, setPStatus] = useState("draft");
  const [pSort, setPSort] = useState(100);
  const [pExcerpt, setPExcerpt] = useState("");
  const [pHeroImg, setPHeroImg] = useState("");
  const [pHeroVid, setPHeroVid] = useState("");
  const [pContent, setPContent] = useState("");
  const PAGE_TYPES = useMemo(
    () => ["one_sheet", "series_bible", "press_kit", "negotiation", "roadmap", "prompts", "deck_copy"],
    []
  );
  const MEDIA_TYPES = useMemo(
    () => ["all", "soundtrack", "score", "trailer", "audiobook", "chapter_read", "scene", "playlist", "musicvideo"],
    []
  );
  const canEditUniverse = Boolean(selectedUniverse?.id);
  /** =========================
   * ‚úÖ INIT: client-safe bucket selection
   * ========================= */
  useEffect(() => {
    const preferred = DEFAULT_BUCKET;
    setStorageBucket(preferred);
    setBucketReady(true);
    (async () => {
      try {
        const { data } = await supabase.storage.listBuckets();
        setBuckets(data || []);
      } catch {
        setBuckets([]);
      }
    })();
  }, []);
  /** =========================
   * Reset helpers
   * ========================= */
  const resetUniverseForm = useCallback(() => {
    setUTitle("");
    setUSlug("");
    setUTagline("");
    setULogline("");
    setUSynopsis("");
    setUCover("");
    setUHeroVideo("");
    setUTrailerVideo("");
    setUWorldMap("");
    setUStatus("draft");
  }, []);
  const resetQuickAdd = useCallback(() => {
    setQaDivision("studios");
    setQaType("trailer");
    setQaTitle("");
    setQaDesc("");
    setQaUrl("");
    setQaThumb("");
    setQaPublic(true);
    setQaPrice("");
    setQaStatus("published");
    setQaMetaStr("");
  }, []);
  const resetPageEditor = useCallback(() => {
    setPId(null);
    setPType("one_sheet");
    setPTitle("");
    setPStatus("draft");
    setPSort(100);
    setPExcerpt("");
    setPHeroImg("");
    setPHeroVid("");
    setPContent("");
  }, []);
  /** =========================
   * Loaders
   * ========================= */
  const loadUniverses = useCallback(async () => {
    setLoading(true);
    setNotice(null);
    const { data, error } = await supabase.from("universes").select("*").order("updated_at", { ascending: false });
    if (error) {
      console.error(error);
      setUniverses([]);
      setNotice({ type: "error", msg: error.message || "Failed to load universes" });
    } else {
      setUniverses(data || []);
    }
    setLoading(false);
  }, []);
  const loadUniverseAssets = useCallback(async (universeId) => {
    if (!universeId) return;
    const { data, error } = await supabase
      .from("universe_assets")
      .select("*")
      .eq("universe_id", universeId)
      .order("sort_order", { ascending: true })
      .order("created_at", { ascending: true });
    if (error) {
      console.error(error);
      setAssets([]);
      setNotice({ type: "error", msg: error.message || "Failed to load universe items" });
    } else {
      setAssets(data || []);
    }
    setAssetEdits({});
    setSavingAssetIds({});
  }, []);
  const loadStudioPages = useCallback(async (universeId) => {
    if (!universeId) return;
    setLoadingPages(true);
    const { data, error } = await supabase
      .from("studio_pages")
      .select("*")
      .eq("universe_id", universeId)
      .order("sort_order", { ascending: true })
      .order("updated_at", { ascending: false });
    if (error) {
      console.error(error);
      setStudioPages([]);
      setNotice({ type: "error", msg: error.message || "Failed to load studio pages" });
    } else {
      setStudioPages(data || []);
    }
    setLoadingPages(false);
  }, []);
  useEffect(() => {
    loadUniverses();
  }, [loadUniverses]);
  useEffect(() => {
    if (!selectedUniverse?.id) return;
    loadUniverseAssets(selectedUniverse.id);
    loadStudioPages(selectedUniverse.id);
    resetPageEditor();
  }, [selectedUniverse?.id, loadUniverseAssets, loadStudioPages, resetPageEditor]);
  /** =========================
   * Select universe
   * ========================= */
  const selectUniverse = useCallback((u) => {
    setSelectedUniverse(u);
    setUTitle(u.title || "");
    setUSlug(u.slug || "");
    setUTagline(u.tagline || "");
    setULogline(u.logline || "");
    setUSynopsis(u.synopsis || "");
    setUCover(u.cover_image_url || "");
    setUHeroVideo(u.hero_video_url || "");
    setUTrailerVideo(u.trailer_video_url || "");
    setUWorldMap(u.world_map_url || "");
    setUStatus(u.status || "draft");
    setNotice(null);
  }, []);
  /** =========================
   * Save universe
   * ========================= */
  const saveUniverse = useCallback(
    async (nextStatus) => {
      setSavingUniverse(true);
      setNotice(null);
      try {
        const payload = {
          title: uTitle.trim(),
          slug: (uSlug || slugify(uTitle)).trim(),
          tagline: uTagline,
          logline: uLogline,
          synopsis: uSynopsis,
          cover_image_url: (uCover && uCover.trim()) || selectedUniverse?.cover_image_url || "",
          hero_video_url: (uHeroVideo && uHeroVideo.trim()) || selectedUniverse?.hero_video_url || "",
          trailer_video_url: (uTrailerVideo && uTrailerVideo.trim()) || selectedUniverse?.trailer_video_url || "",
          world_map_url: (uWorldMap && uWorldMap.trim()) || selectedUniverse?.world_map_url || "",
          status: (nextStatus || uStatus || "draft").trim(),
          division: "publishing",
          updated_at: new Date().toISOString(),
        };
        console.log("SAVE payload trailer_video_url =", payload.trailer_video_url);
        if (!payload.title) throw new Error("Title is required.");
        if (!payload.slug) throw new Error("Slug is required.");
        if (selectedUniverse?.id) {
          const { error } = await supabase.from("universes").update(payload).eq("id", selectedUniverse.id);
          if (error) throw error;
          setNotice({ type: "ok", msg: payload.status === "published" ? "Universe published." : "Universe saved." });
        } else {
          const { data, error } = await supabase.from("universes").insert([payload]).select("*").single();
          if (error) throw error;
          setSelectedUniverse(data);
          setNotice({
            type: "ok",
            msg: payload.status === "published" ? "Universe created + published." : "Universe created.",
          });
        }
        await loadUniverses();
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to save universe" });
      } finally {
        setSavingUniverse(false);
      }
    },
    [uTitle, uSlug, uTagline, uLogline, uSynopsis, uCover, uHeroVideo, uTrailerVideo, uWorldMap, uStatus, selectedUniverse, loadUniverses]
  );
  const publishUniverse = useCallback(async () => {
    setUStatus("published");
    await saveUniverse("published");
  }, [saveUniverse]);
  const unpublishUniverse = useCallback(async () => {
    setUStatus("draft");
    await saveUniverse("draft");
  }, [saveUniverse]);
  const deleteUniverse = useCallback(async () => {
    if (!selectedUniverse?.id) return;
    if (!confirm("Delete this universe AND all its universe items? This cannot be undone.")) return;
    try {
      setSavingUniverse(true);
      setNotice(null);
      const { error: aErr } = await supabase.from("universe_assets").delete().eq("universe_id", selectedUniverse.id);
      if (aErr) throw aErr;
      const { error: pErr } = await supabase.from("studio_pages").delete().eq("universe_id", selectedUniverse.id);
      if (pErr) throw pErr;
      const { error: uErr } = await supabase.from("universes").delete().eq("id", selectedUniverse.id);
      if (uErr) throw uErr;
      setSelectedUniverse(null);
      resetUniverseForm();
      setAssets([]);
      setStudioPages([]);
      resetPageEditor();
      setProductResults([]);
      setAssetEdits({});
      resetQuickAdd();
      setNotice({ type: "ok", msg: "Universe deleted." });
      await loadUniverses();
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to delete universe" });
    } finally {
      setSavingUniverse(false);
    }
  }, [selectedUniverse?.id, resetUniverseForm, resetPageEditor, loadUniverses, resetQuickAdd]);
  /** =========================
   * ‚úÖ Persist field immediately (cover/map/hero uploads)
   * ========================= */
  const persistUniverseField = useCallback(
    async (field, value) => {
      if (!selectedUniverse?.id) return;
      const { error } = await supabase
        .from("universes")
        .update({ [field]: value, updated_at: new Date().toISOString() })
        .eq("id", selectedUniverse.id);
      if (error) throw error;
    },
    [selectedUniverse?.id]
  );
  /** =========================
   * ‚úÖ Universe Cover Upload
   * ========================= */
  const uploadCoverFile = useCallback(
    async (file) => {
      if (!file) return;
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      try {
        setUploading(true);
        setNotice(null);
        const slug = (uSlug || selectedUniverse?.slug || slugify(uTitle)).trim() || "universe";
        const { publicUrl } = await uploadToStorage({
          bucket: storageBucket,
          file,
          folder: `images/universes/${slug}/cover`,
          allowed: ["image"],
        });
        setUCover(publicUrl);
        if (selectedUniverse?.id) await persistUniverseField("cover_image_url", publicUrl);
        setNotice({ type: "ok", msg: "Cover uploaded and saved." });
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Cover upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, uSlug, uTitle, selectedUniverse?.id, selectedUniverse?.slug, persistUniverseField]
  );
  /** =========================
   * ‚úÖ Hero Video Upload
   * ========================= */
  const uploadHeroVideoFile = useCallback(
    async (file) => {
      if (!file) return;
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      try {
        setUploading(true);
        setNotice(null);
        const slug = (uSlug || selectedUniverse?.slug || slugify(uTitle)).trim() || "universe";
        const { publicUrl } = await uploadToStorage({
          bucket: storageBucket,
          file,
          folder: `videos/universes/${slug}/hero`,
          allowed: ["mp4"],
        });
        setUHeroVideo(publicUrl);
        if (selectedUniverse?.id) await persistUniverseField("hero_video_url", publicUrl);
        setNotice({ type: "ok", msg: "Hero video uploaded and saved." });
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Hero video upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, uSlug, uTitle, selectedUniverse?.id, selectedUniverse?.slug, persistUniverseField]
  );
  /** =========================
   * ‚úÖ Trailer Video Upload
   * ========================= */
  const uploadTrailerVideoFile = useCallback(
    async (file) => {
      if (!file) return;
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      try {
        setUploading(true);
        setNotice(null);
        const slug = (uSlug || selectedUniverse?.slug || slugify(uTitle)).trim() || "universe";
        const { publicUrl } = await uploadToStorage({
          bucket: storageBucket,
          file,
          folder: `videos/universes/${slug}/trailer`,
          allowed: ["mp4"],
        });
        console.log("TRAILER UPLOADED publicUrl =", publicUrl);
        setUTrailerVideo(publicUrl);
        if (selectedUniverse?.id) await persistUniverseField("trailer_video_url", publicUrl);
        setNotice({ type: "ok", msg: "Trailer video uploaded and saved." });
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Trailer video upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, uSlug, uTitle, selectedUniverse?.id, selectedUniverse?.slug, persistUniverseField]
  );
  /** =========================
   * ‚úÖ Featured World Map Upload
   * ========================= */
  const uploadFeaturedWorldMapFile = useCallback(
    async (file) => {
      if (!file) return;
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      try {
        setUploading(true);
        setNotice(null);
        const slug = (uSlug || selectedUniverse?.slug || slugify(uTitle)).trim() || "universe";
        const { publicUrl } = await uploadToStorage({
          bucket: storageBucket,
          file,
          folder: `images/universes/${slug}/world-map/featured`,
          allowed: ["image"],
        });
        setUWorldMap(publicUrl);
        if (selectedUniverse?.id) await persistUniverseField("world_map_url", publicUrl);
        setNotice({ type: "ok", msg: "Featured world map uploaded and saved." });
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "World map upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, uSlug, uTitle, selectedUniverse?.id, selectedUniverse?.slug, persistUniverseField]
  );
  /** =========================
   * Studio pages (kept intact)
   * ========================= */
  const selectPage = useCallback((pg) => {
    setPId(pg.id);
    setPType(pg.page_type || "one_sheet");
    setPTitle(pg.title || "");
    setPStatus(pg.status || "draft");
    setPSort(pg.sort_order ?? 100);
    setPExcerpt(pg.excerpt || "");
    setPHeroImg(pg.hero_image_url || "");
    setPHeroVid(pg.hero_video_url || "");
    setPContent(pg.content_md || "");
  }, []);
  const savePage = useCallback(async () => {
    if (!selectedUniverse?.id) {
      setNotice({ type: "error", msg: "Select or create a universe first." });
      return;
    }
    if (!pTitle.trim()) {
      setNotice({ type: "error", msg: "Page title is required." });
      return;
    }
    setSavingPageId(pId || "new");
    setNotice(null);
    const payload = {
      universe_id: selectedUniverse.id,
      page_type: pType,
      title: pTitle.trim(),
      status: pStatus,
      sort_order: clampInt(pSort, 100),
      excerpt: pExcerpt || null,
      hero_image_url: pHeroImg || null,
      hero_video_url: pHeroVid || null,
      content_md: pContent || "",
      updated_at: new Date().toISOString(),
    };
    try {
      if (pId) {
        const { error } = await supabase.from("studio_pages").update(payload).eq("id", pId);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Studio page saved." });
      } else {
        const { data, error } = await supabase.from("studio_pages").insert([payload]).select("*").single();
        if (error) throw error;
        setPId(data.id);
        setNotice({ type: "ok", msg: "Studio page created." });
      }
      await loadStudioPages(selectedUniverse.id);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to save studio page" });
    } finally {
      setSavingPageId(null);
    }
  }, [selectedUniverse?.id, pId, pType, pTitle, pStatus, pSort, pExcerpt, pHeroImg, pHeroVid, pContent, loadStudioPages]);
  const deletePage = useCallback(async () => {
    if (!selectedUniverse?.id || !pId) return;
    if (!confirm("Delete this studio page?")) return;
    setSavingPageId(pId);
    setNotice(null);
    try {
      const { error } = await supabase.from("studio_pages").delete().eq("id", pId);
      if (error) throw error;
      setNotice({ type: "ok", msg: "Studio page deleted." });
      resetPageEditor();
      await loadStudioPages(selectedUniverse.id);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to delete studio page" });
    } finally {
      setSavingPageId(null);
    }
  }, [selectedUniverse?.id, pId, loadStudioPages, resetPageEditor]);
  /** =========================
   * Products attach (existing)
   * ========================= */
  const searchProducts = useCallback(async () => {
    setSearching(true);
    setNotice(null);
    try {
      const qtxt = query.trim();
      const searchKey = `${division}::${qtxt}`;
      lastSearchKey.current = searchKey;
      let q = supabase
        .from("products")
        .select("id,name,slug,division,price,image_url,tags,description,thumbnail_url,updated_at")
        .eq("division", division)
        .order("updated_at", { ascending: false })
        .limit(12);
      if (qtxt) q = q.or(`name.ilike.%${qtxt}%,slug.ilike.%${qtxt}%`);
      const { data, error } = await q;
      if (lastSearchKey.current !== searchKey) return;
      if (error) throw error;
      setProductResults(data || []);
    } catch (e) {
      console.error(e);
      setProductResults([]);
      setNotice({ type: "error", msg: e?.message || "Search failed" });
    } finally {
      setSearching(false);
    }
  }, [division, query]);
  useEffect(() => {
    if (!selectedUniverse?.id) return;
    if (query.trim() !== "") return;
    searchProducts();
  }, [division, selectedUniverse?.id, query, searchProducts]);
  const addProductToUniverse = useCallback(
    async (product) => {
      if (!selectedUniverse?.id) {
        setNotice({ type: "error", msg: "Select or create a universe first." });
        return;
      }
      const already = assets.some((a) => a.source_type === "product" && a.source_product_id === product.id);
      if (already) {
        setNotice({ type: "error", msg: "That product is already in this universe." });
        return;
      }
      const internalUrl =
        product.division === "publishing"
          ? `/publishing/${product.slug}`
          : product.division === "designs"
          ? `/designs/${product.slug}`
          : product.division === "capital"
          ? `/capital`
          : product.division === "realty"
          ? `/realty`
          : `/`;
      const assetType = product.division === "publishing" ? "book" : product.division === "designs" ? "merch" : "product";
      try {
        const maxSort = assets.length ? Math.max(...assets.map((x) => clampInt(x.sort_order, 0))) : 0;
        const insertRow = {
          universe_id: selectedUniverse.id,
          division: product.division,
          asset_type: assetType,
          title: product.name,
          description: product.description || "Linked from Products.",
          external_url: internalUrl,
          thumbnail_url: product.thumbnail_url || product.image_url || null,
          is_public: true,
          status: "published",
          sort_order: maxSort + 10,
          source_type: "product",
          source_product_id: product.id,
          metadata: {
            source: "products",
            product_id: product.id,
            product_slug: product.slug,
            product_division: product.division,
          },
        };
        const { error } = await supabase.from("universe_assets").insert([insertRow]);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Added to universe." });
        await loadUniverseAssets(selectedUniverse.id);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to add product" });
      }
    },
    [selectedUniverse?.id, assets, loadUniverseAssets]
  );
  /** =========================
   * ‚úÖ NEW: Media attach (from posts table where division='media')
   * Goal:
   * - Anything on media.js can be attached to a Universe (universe_assets)
   * - Studio page can render using metadata.audio_url/media_url
   *
   * IMPORTANT:
   * - We do NOT assume extra columns like source_post_id exist.
   * - We store identifiers in metadata so this works immediately.
   * ========================= */
  const searchMediaPosts = useCallback(async () => {
    if (!selectedUniverse?.id) {
      setMediaResults([]);
      return;
    }
    setMediaSearching(true);
    setNotice(null);
    try {
      const qtxt = mediaQuery.trim();
      const searchKey = `${mediaTypeFilter}::${qtxt}`;
      lastMediaSearchKey.current = searchKey;
      // ‚úÖ FIX: removed "thumbnail_url" from select because posts.thumbnail_url does not exist
      let q = supabase
        .from("posts")
        .select("id,title,slug,excerpt,division,featured_image,metadata,created_at,updated_at")
        .eq("division", "media")
        .order("updated_at", { ascending: false })
        .limit(20);
      if (qtxt) {
        q = q.or(`title.ilike.%${qtxt}%,slug.ilike.%${qtxt}%,excerpt.ilike.%${qtxt}%`);
      }
      const { data, error } = await q;
      if (lastMediaSearchKey.current !== searchKey) return;
      if (error) throw error;
      let list = (data || []).map((p) => {
        const m = safeMeta(p.metadata);
        const media_type = String(m.media_type || "").trim() || "soundtrack";
        const audio_url = String(m.audio_url || "").trim();
        const media_url = String(m.media_url || "").trim();
        const bestMediaUrl = audio_url || media_url || "";
        // ‚úÖ FIX: never reference p.thumbnail_url; derive thumbnail from metadata + featured_image only
        const thumb =
          String(m.thumbnail_url || m.thumb_url || m.cover_url || "").trim() ||
          String(p.featured_image || "").trim() ||
          "";
        return {
          ...p,
          _meta: m,
          _media_type: media_type,
          _audio_url: audio_url,
          _media_url: media_url,
          _best_url: bestMediaUrl,
          _thumb: thumb,
        };
      });
      if (mediaTypeFilter !== "all") {
        list = list.filter((p) => String(p._media_type || "").toLowerCase() === String(mediaTypeFilter).toLowerCase());
      }
      setMediaResults(list);
    } catch (e) {
      console.error(e);
      setMediaResults([]);
      setNotice({ type: "error", msg: e?.message || "Media search failed" });
    } finally {
      setMediaSearching(false);
    }
  }, [selectedUniverse?.id, mediaQuery, mediaTypeFilter]);
  useEffect(() => {
    if (!selectedUniverse?.id) return;
    // auto-load ‚Äúrecent media‚Äù once universe is selected
    if (mediaQuery.trim() !== "") return;
    searchMediaPosts();
  }, [selectedUniverse?.id, mediaTypeFilter, mediaQuery, searchMediaPosts]);
  const addMediaPostToUniverse = useCallback(
    async (post) => {
      if (!selectedUniverse?.id) {
        setNotice({ type: "error", msg: "Select or create a universe first." });
        return;
      }
      // de-dupe by metadata.post_id OR by external_url === /media/slug
      const already = assets.some((a) => {
        if (a.source_type === "post") {
          const md = a.metadata || {};
          if (md?.post_id && md.post_id === post.id) return true;
          if (md?.post_slug && md.post_slug === post.slug) return true;
        }
        if (a.external_url && post?.slug && String(a.external_url) === `/media/${post.slug}`) return true;
        return false;
      });
      if (already) {
        setNotice({ type: "error", msg: "That media item is already attached to this universe." });
        return;
      }
      try {
        const maxSort = assets.length ? Math.max(...assets.map((x) => clampInt(x.sort_order, 0))) : 0;
        const m = safeMeta(post._meta || post.metadata);
        // prefer a playable url for Studio preview (audio first)
        const audio_url = String(m.audio_url || post._audio_url || "").trim();
        const media_url = String(m.media_url || post._media_url || "").trim();
        const playable = audio_url || (isAudioLikeUrl(media_url) ? media_url : "");
        // Always set internal detail page too
        const detailUrl = post?.slug ? `/media/${post.slug}` : "";
        // Use playable url if present; otherwise link to the detail page so Studio can still open it
        const external_url = playable || media_url || detailUrl;
        // asset_type should map to your studio renderer categories
        // (you can adjust mappings here without touching Studio code)
        const asset_type = String(m.media_type || post._media_type || "soundtrack").trim() || "soundtrack";
        const insertRow = {
          universe_id: selectedUniverse.id,
          division: "media",
          asset_type, // soundtrack | score | trailer | audiobook | chapter_read | scene | playlist | musicvideo
          title: post.title || "Media Item",
          description: post.excerpt || "Linked from Media.",
          external_url: external_url || detailUrl || "",
          thumbnail_url: (m.thumbnail_url || post._thumb || post.featured_image || null) ?? null,
          is_public: true,
          status: "published",
          sort_order: maxSort + 10,
          source_type: "post",
          // ‚ö†Ô∏è do NOT include source_post_id unless you're 100% sure the column exists.
          metadata: {
            kind: "media",
            source: "posts",
            post_id: post.id,
            post_slug: post.slug,
            media_type: asset_type,
            // give Studio a direct audio field to play
            audio_url: audio_url || null,
            media_url: media_url || null,
            detail_url: detailUrl || null,
            duration: m.duration || null,
            mood: m.mood || null,
            scene: m.scene || null,
          },
          updated_at: new Date().toISOString(),
        };
        const { error } = await supabase.from("universe_assets").insert([insertRow]);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Media added to universe." });
        await loadUniverseAssets(selectedUniverse.id);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to add media" });
      }
    },
    [selectedUniverse?.id, assets, loadUniverseAssets]
  );
  /** =========================
   * Asset edit helpers (existing)
   * ========================= */
  const setAssetField = useCallback((assetId, patch) => {
    setAssetEdits((prev) => ({ ...prev, [assetId]: { ...(prev[assetId] || {}), ...patch } }));
  }, []);
  const getAssetVal = useCallback(
    (asset, key, fallback = "") => {
      const row = assetEdits[asset.id] || {};
      if (row[key] !== undefined) return row[key];
      return asset[key] ?? fallback;
    },
    [assetEdits]
  );
  const getAssetMetaStr = useCallback(
    (asset) => {
      const row = assetEdits[asset.id] || {};
      if (row.metadataStr !== undefined) return row.metadataStr;
      return JSON.stringify(asset.metadata || {}, null, 0);
    },
    [assetEdits]
  );
  const saveAsset = useCallback(
    async (asset) => {
      const row = assetEdits[asset.id] || {};
      if (!Object.keys(row).length) {
        setNotice({ type: "ok", msg: "No changes to save." });
        return;
      }
      try {
        setSavingAssetIds((prev) => ({ ...prev, [asset.id]: true }));
        setNotice(null);
        const payload = {};
        if (row.title !== undefined) payload.title = row.title;
        if (row.description !== undefined) payload.description = row.description;
        if (row.division !== undefined) payload.division = row.division;
        if (row.asset_type !== undefined) payload.asset_type = row.asset_type;
        if (row.external_url !== undefined) payload.external_url = row.external_url;
        if (row.thumbnail_url !== undefined) payload.thumbnail_url = row.thumbnail_url;
        if (row.status !== undefined) payload.status = row.status;
        if (row.sort_order !== undefined) payload.sort_order = clampInt(row.sort_order, asset.sort_order || 0);
        if (row.is_public !== undefined) payload.is_public = Boolean(row.is_public);
        if (row.price_cents !== undefined) payload.price_cents = clampInt(row.price_cents, 0);
        if (row.metadataStr !== undefined) payload.metadata = safeJsonParse(row.metadataStr, asset.metadata || {});
        payload.updated_at = new Date().toISOString();
        const { error } = await supabase.from("universe_assets").update(payload).eq("id", asset.id);
        if (error) throw error;
        setAssetEdits((prev) => ({ ...prev, [asset.id]: {} }));
        setNotice({ type: "ok", msg: "Universe item saved." });
        if (selectedUniverse?.id) await loadUniverseAssets(selectedUniverse.id);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to save item" });
      } finally {
        setSavingAssetIds((prev) => ({ ...prev, [asset.id]: false }));
      }
    },
    [assetEdits, selectedUniverse?.id, loadUniverseAssets]
  );
  const removeAsset = useCallback(
    async (assetId) => {
      if (!selectedUniverse?.id) return;
      if (!confirm("Remove this item from the universe?")) return;
      const { error } = await supabase.from("universe_assets").delete().eq("id", assetId);
      if (error) {
        console.error(error);
        setNotice({ type: "error", msg: error.message || "Failed to remove item" });
        return;
      }
      setNotice({ type: "ok", msg: "Removed." });
      await loadUniverseAssets(selectedUniverse.id);
    },
    [selectedUniverse?.id, loadUniverseAssets]
  );
  const moveAsset = useCallback(
    async (assetId, direction) => {
      const idx = assets.findIndex((a) => a.id === assetId);
      if (idx === -1) return;
      const targetIdx = idx + direction;
      if (targetIdx < 0 || targetIdx >= assets.length) return;
      const a1 = assets[idx];
      const a2 = assets[targetIdx];
      const so1 = clampInt(a1.sort_order, 0);
      const so2 = clampInt(a2.sort_order, 0);
      try {
        setNotice(null);
        setSavingAssetIds((prev) => ({ ...prev, [a1.id]: true, [a2.id]: true }));
        const { error: e1 } = await supabase
          .from("universe_assets")
          .update({ sort_order: so2, updated_at: new Date().toISOString() })
          .eq("id", a1.id);
        if (e1) throw e1;
        const { error: e2 } = await supabase
          .from("universe_assets")
          .update({ sort_order: so1, updated_at: new Date().toISOString() })
          .eq("id", a2.id);
        if (e2) throw e2;
        setNotice({ type: "ok", msg: "Reordered." });
        if (selectedUniverse?.id) await loadUniverseAssets(selectedUniverse.id);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to reorder" });
      } finally {
        setSavingAssetIds((prev) => ({ ...prev, [a1.id]: false, [a2.id]: false }));
      }
    },
    [assets, selectedUniverse?.id, loadUniverseAssets]
  );
  /** =========================
   * ‚úÖ Upload thumb for existing asset and persist immediately
   * ========================= */
  const uploadAssetThumbFile = useCallback(
    async (asset, file) => {
      if (!selectedUniverse?.id) {
        setNotice({ type: "error", msg: "Select a universe first." });
        return;
      }
      if (!asset?.id || !file) return;
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      try {
        setUploading(true);
        setNotice(null);
        const slug = (uSlug || selectedUniverse?.slug || slugify(uTitle)).trim() || "universe";
        const isMp4 = isMp4File(file);
        const folder = isMp4
          ? `videos/universes/${slug}/universe-items/${asset.id}/thumbnail`
          : `images/universes/${slug}/universe-items/${asset.id}/thumbnail`;
        const { publicUrl, path } = await uploadToStorage({
          bucket: storageBucket,
          file,
          folder,
          allowed: ["image", "mp4"],
        });
        const metaStr = getAssetMetaStr(asset);
        const metaObj = safeJsonParse(metaStr, asset.metadata || {});
        metaObj.storage = metaObj.storage || {};
        metaObj.storage.thumbnail = { bucket: storageBucket, path };
        if (isMp4) metaObj.thumb_kind = "video";
        else if (metaObj.thumb_kind) delete metaObj.thumb_kind;
        const { error } = await supabase
          .from("universe_assets")
          .update({ thumbnail_url: publicUrl, metadata: metaObj, updated_at: new Date().toISOString() })
          .eq("id", asset.id);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Thumbnail uploaded and saved." });
        await loadUniverseAssets(selectedUniverse.id);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Item thumbnail upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, selectedUniverse?.id, selectedUniverse?.slug, uSlug, uTitle, getAssetMetaStr, loadUniverseAssets]
  );
  /** =========================
   * Quick Add thumb upload (image OR mp4)
   * ========================= */
  const uploadQuickAddThumbFile = useCallback(
    async (file) => {
      if (!file) return;
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      try {
        setUploading(true);
        setNotice(null);
        const slug = (uSlug || selectedUniverse?.slug || slugify(uTitle)).trim() || "universe";
        const isMp4 = isMp4File(file);
        const folder = isMp4
          ? `videos/universes/${slug}/universe-items/thumbnails`
          : `images/universes/${slug}/universe-items/thumbnails`;
        const { publicUrl, path } = await uploadToStorage({
          bucket: storageBucket,
          file,
          folder,
          allowed: ["image", "mp4"],
        });
        setQaThumb(publicUrl);
        const nextMeta = safeJsonParse(qaMetaStr, {});
        nextMeta.storage = nextMeta.storage || {};
        nextMeta.storage.thumbnail = { bucket: storageBucket, path };
        if (isMp4) nextMeta.thumb_kind = "video";
        else if (nextMeta.thumb_kind) delete nextMeta.thumb_kind;
        setQaMetaStr(JSON.stringify(nextMeta));
        setNotice({ type: "ok", msg: "Thumbnail uploaded. Now click Add Item." });
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Thumbnail upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, uSlug, selectedUniverse?.slug, uTitle, qaMetaStr]
  );
  /** =========================
   * ‚úÖ World Map Gallery + Regions (kept intact)
   * ========================= */
  const uploadWorldMapGallery = useCallback(
    async (files) => {
      if (!selectedUniverse?.id) {
        setNotice({ type: "error", msg: "Select or create a universe first." });
        return;
      }
      if (!storageBucket) {
        setNotice({ type: "error", msg: "No storage bucket selected." });
        return;
      }
      const list = Array.from(files || []);
      if (!list.length) return;
      try {
        setUploading(true);
        setNotice(null);
        const maxSort = assets.length ? Math.max(...assets.map((x) => clampInt(x.sort_order, 0))) : 0;
        const slug = (uSlug || selectedUniverse.slug || slugify(uTitle)).trim() || "universe";
        const rows = [];
        let nextSort = maxSort + 10;
        for (let i = 0; i < list.length; i++) {
          const file = list[i];
          if (!isImageFile(file)) continue;
          const { publicUrl, path } = await uploadToStorage({
            bucket: storageBucket,
            file,
            folder: `images/universes/${slug}/world-map/gallery`,
            allowed: ["image"],
          });
          const baseTitle = String(file.name || "").replace(/\.[^/.]+$/, "");
          rows.push({
            universe_id: selectedUniverse.id,
            division: "studios",
            asset_type: "world_map",
            title: baseTitle || `World Map ${i + 1}`,
            description: "World map gallery image.",
            external_url: publicUrl,
            thumbnail_url: publicUrl,
            is_public: true,
            status: "published",
            sort_order: nextSort,
            source_type: "manual",
            metadata: { kind: "world_map", role: "gallery", storage: { bucket: storageBucket, path } },
            updated_at: new Date().toISOString(),
          });
          nextSort += 10;
        }
        if (!rows.length) {
          setNotice({ type: "error", msg: "No valid image files selected." });
          return;
        }
        const { error } = await supabase.from("universe_assets").insert(rows);
        if (error) throw error;
        setNotice({ type: "ok", msg: `Uploaded ${rows.length} world map images and saved to universe_assets.` });
        await loadUniverseAssets(selectedUniverse.id);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Gallery upload failed" });
      } finally {
        setUploading(false);
      }
    },
    [storageBucket, selectedUniverse?.id, selectedUniverse?.slug, assets, uSlug, uTitle, loadUniverseAssets]
  );
  const [selectedWorldMapAssetId, setSelectedWorldMapAssetId] = useState(null);
  const [regions, setRegions] = useState([]);
  const [loadingRegions, setLoadingRegions] = useState(false);
  const [savingRegionId, setSavingRegionId] = useState(null);
  const loadRegions = useCallback(async (universeId, worldMapAssetId) => {
    if (!universeId) return;
    setLoadingRegions(true);
    setNotice(null);
    let q = supabase
      .from("world_map_regions")
      .select("*")
      .eq("universe_id", universeId)
      .order("sort_order", { ascending: true })
      .order("created_at", { ascending: true });
    if (worldMapAssetId) q = q.eq("world_map_asset_id", worldMapAssetId);
    const { data, error } = await q;
    if (error) {
      console.error(error);
      setRegions([]);
      setNotice({ type: "error", msg: error.message || "Failed to load regions" });
    } else {
      setRegions(data || []);
    }
    setLoadingRegions(false);
  }, []);
  useEffect(() => {
    if (!selectedUniverse?.id) return;
    loadRegions(selectedUniverse.id, selectedWorldMapAssetId);
  }, [selectedUniverse?.id, selectedWorldMapAssetId, loadRegions]);
  const [rTitle, setRTitle] = useState("");
  const [rDesc, setRDesc] = useState("");
  const [rSort, setRSort] = useState(0);
  const [rMeta, setRMeta] = useState("");
  const resetRegionForm = useCallback(() => {
    setRTitle("");
    setRDesc("");
    setRSort(0);
    setRMeta("");
  }, []);
  const addRegion = useCallback(async () => {
    if (!selectedUniverse?.id) return;
    if (!rTitle.trim()) {
      setNotice({ type: "error", msg: "Region title is required." });
      return;
    }
    try {
      setSavingRegionId("new");
      setNotice(null);
      const payload = {
        universe_id: selectedUniverse.id,
        world_map_asset_id: selectedWorldMapAssetId || null,
        title: rTitle.trim(),
        description: rDesc || null,
        sort_order: clampInt(rSort, 0),
        metadata: safeJsonParse(rMeta, {}),
      };
      const { error } = await supabase.from("world_map_regions").insert([payload]);
      if (error) throw error;
      setNotice({ type: "ok", msg: "Region added." });
      resetRegionForm();
      await loadRegions(selectedUniverse.id, selectedWorldMapAssetId);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to add region" });
    } finally {
      setSavingRegionId(null);
    }
  }, [selectedUniverse?.id, selectedWorldMapAssetId, rTitle, rDesc, rSort, rMeta, loadRegions, resetRegionForm]);
  const updateRegion = useCallback(
    async (regionId, patch) => {
      try {
        setSavingRegionId(regionId);
        const { error } = await supabase.from("world_map_regions").update(patch).eq("id", regionId);
        if (error) throw error;
        await loadRegions(selectedUniverse.id, selectedWorldMapAssetId);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to update region" });
      } finally {
        setSavingRegionId(null);
      }
    },
    [selectedUniverse?.id, selectedWorldMapAssetId, loadRegions]
  );
  const deleteRegion = useCallback(
    async (regionId) => {
      if (!confirm("Delete this region?")) return;
      try {
        setSavingRegionId(regionId);
        const { error } = await supabase.from("world_map_regions").delete().eq("id", regionId);
        if (error) throw error;
        setNotice({ type: "ok", msg: "Region deleted." });
        await loadRegions(selectedUniverse.id, selectedWorldMapAssetId);
      } catch (e) {
        console.error(e);
        setNotice({ type: "error", msg: e?.message || "Failed to delete region" });
      } finally {
        setSavingRegionId(null);
      }
    },
    [selectedUniverse?.id, selectedWorldMapAssetId, loadRegions]
  );
  /** =========================
   * Quick add custom asset (existing)
   * ========================= */
  const addCustomAsset = useCallback(async () => {
    if (!selectedUniverse?.id) {
      setNotice({ type: "error", msg: "Select or create a universe first." });
      return;
    }
    if (!qaTitle.trim()) {
      setNotice({ type: "error", msg: "Title is required for the universe item." });
      return;
    }
    try {
      setNotice(null);
      const maxSort = assets.length ? Math.max(...assets.map((x) => clampInt(x.sort_order, 0))) : 0;
      const dollars = Number(String(qaPrice || "").trim());
      const priceCents = Number.isFinite(dollars) ? Math.round(dollars * 100) : 0;
      const metaObj = safeJsonParse(qaMetaStr, {});
      const thumbIsVideo = isLikelyMp4Url(qaThumb) || String(metaObj?.thumb_kind || "").toLowerCase() === "video";
      const insertRow = {
        universe_id: selectedUniverse.id,
        division: qaDivision,
        asset_type: qaType,
        title: qaTitle.trim(),
        description: qaDesc || "",
        external_url: qaUrl || "",
        thumbnail_url: qaThumb || null,
        is_public: Boolean(qaPublic),
        status: qaStatus || "published",
        sort_order: maxSort + 10,
        price_cents: qaPublic ? 0 : priceCents,
        source_type: "manual",
        metadata: {
          ...metaObj,
          ...(thumbIsVideo ? { thumb_kind: "video" } : {}),
        },
        updated_at: new Date().toISOString(),
      };
      const { error } = await supabase.from("universe_assets").insert([insertRow]);
      if (error) throw error;
      setNotice({ type: "ok", msg: "Universe item added." });
      resetQuickAdd();
      await loadUniverseAssets(selectedUniverse.id);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Failed to add universe item" });
    }
  }, [
    selectedUniverse?.id,
    qaDivision,
    qaType,
    qaTitle,
    qaDesc,
    qaUrl,
    qaThumb,
    qaPublic,
    qaPrice,
    qaStatus,
    qaMetaStr,
    assets,
    resetQuickAdd,
    loadUniverseAssets,
  ]);
  const primeQuickAddForCharacter = useCallback(() => {
    setQaDivision("studios");
    setQaType("character");
    setQaStatus("published");
    setQaPublic(true);
    const current = safeJsonParse(qaMetaStr, {});
    if (!Object.keys(current || {}).length) setQaMetaStr(JSON.stringify({ kind: "character", role: "cast" }));
    if (!qaTitle) setQaTitle("Character ‚Äî Name");
    if (!qaDesc) setQaDesc("Bio / role / motivation / arc.");
  }, [qaMetaStr, qaTitle, qaDesc]);
  /** =========================
   * ‚úÖ Local backfill tool
   * ========================= */
  const backfillThumbnailsLocal = useCallback(async () => {
    if (!selectedUniverse?.id) return;
    try {
      setNotice(null);
      const { data, error } = await supabase
        .from("universe_assets")
        .select("id,external_url,thumbnail_url")
        .eq("universe_id", selectedUniverse.id);
      if (error) throw error;
      const toFix = (data || []).filter(
        (r) =>
          (!r.thumbnail_url || !String(r.thumbnail_url).trim()) &&
          r.external_url &&
          /\.(png|jpg|jpeg|webp|gif|mp4)$/i.test(String(r.external_url))
      );
      if (!toFix.length) {
        setNotice({ type: "ok", msg: "No thumbnails to backfill." });
        return;
      }
      for (const row of toFix) {
        await supabase
          .from("universe_assets")
          .update({ thumbnail_url: row.external_url, updated_at: new Date().toISOString() })
          .eq("id", row.id);
      }
      setNotice({ type: "ok", msg: `Backfilled ${toFix.length} thumbnails from external_url.` });
      await loadUniverseAssets(selectedUniverse.id);
    } catch (e) {
      console.error(e);
      setNotice({ type: "error", msg: e?.message || "Backfill failed" });
    }
  }, [selectedUniverse?.id, loadUniverseAssets]);
  /** =========================
   * Derived views
   * ========================= */
  const missingCharacterThumbCount = useMemo(
    () => assets.filter((a) => a.asset_type === "character" && (!a.thumbnail_url || !String(a.thumbnail_url).trim())).length,
    [assets]
  );
  const missingWorldMapTitleCount = useMemo(
    () => assets.filter((a) => a.asset_type === "world_map" && (!a.title || !String(a.title).trim())).length,
    [assets]
  );
  const universeStatusBadge = useMemo(() => {
    const s = String(selectedUniverse?.status || uStatus || "draft");
    const isPub = s === "published";
    return (
      <span
        className={`inline-flex items-center px-2 py-0.5 rounded-full border text-xs ${
          isPub ? "border-emerald-300 bg-emerald-50 text-emerald-800" : "border-amber-300 bg-amber-50 text-amber-900"
        }`}
      >
        {isPub ? "published" : "draft"}
      </span>
    );
  }, [selectedUniverse?.status, uStatus]);
  const worldMapAssets = useMemo(
    () => assets.filter((a) => String(a.asset_type || "").toLowerCase() === "world_map"),
    [assets]
  );
  /** =========================
   * Render
   * ========================= */
  return (
    <div className="space-y-8">
      <div className="flex items-end justify-between gap-4 flex-wrap">
        <div>
          <h2 className="text-2xl font-bold">Universes (Studios)</h2>
          <p className="text-sm opacity-70">
            Create a universe, publish it, then curate items (world maps, characters, trailers, audio, decks) into the Studio page.
          </p>
          <div className="mt-2 flex items-center gap-2 flex-wrap text-[11px] opacity-70">
            <span>Storage bucket:</span>
            <code className="px-2 py-0.5 rounded border">{storageBucket || "NONE"}</code>
            {bucketReady && buckets.length > 0 && (
              <select
                className="border rounded-xl p-1 text-[12px]"
                value={storageBucket}
                onChange={(e) => {
                  setStorageBucket(e.target.value);
                  setNotice({ type: "ok", msg: `Storage bucket set to '${e.target.value}'.` });
                }}
              >
                {buckets.map((b) => (
                  <option key={b.id || b.name} value={b.name}>
                    {b.name}
                  </option>
                ))}
              </select>
            )}
            {bucketReady && !storageBucket && (
              <span className="text-red-700">Create a bucket in Supabase ‚Üí Storage (ex: assets) to enable uploads.</span>
            )}
          </div>
        </div>
        <button
          className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50"
          onClick={() => {
            setSelectedUniverse(null);
            resetUniverseForm();
            setAssets([]);
            setStudioPages([]);
            resetPageEditor();
            setProductResults([]);
            setAssetEdits({});
            resetQuickAdd();
            setNotice(null);
            setSelectedWorldMapAssetId(null);
            setRegions([]);
            resetRegionForm();
            setMediaResults([]);
            setMediaQuery("");
            setMediaTypeFilter("all");
          }}
        >
          + New Universe
        </button>
      </div>
      {notice?.msg && (
        <div
          className={`rounded-xl border p-3 text-sm ${
            notice.type === "error"
              ? "border-red-200 bg-red-50 text-red-800"
              : "border-emerald-200 bg-emerald-50 text-emerald-800"
          }`}
        >
          {notice.msg}
        </div>
      )}
      {/* Universe list + editor */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="rounded-2xl border border-gray-200 p-4">
          <div className="font-semibold mb-3">Universes</div>
          {loading ? (
            <div className="opacity-70">Loading‚Ä¶</div>
          ) : universes.length === 0 ? (
            <div className="opacity-70">No universes yet.</div>
          ) : (
            <div className="space-y-2">
              {universes.map((u) => {
                const isPub = String(u.status || "draft") === "published";
                return (
                  <button
                    key={u.id}
                    onClick={() => selectUniverse(u)}
                    className={`w-full text-left p-3 rounded-xl border transition ${
                      selectedUniverse?.id === u.id ? "border-black" : "border-gray-200 hover:border-gray-300"
                    }`}
                  >
                    <div className="flex items-center justify-between gap-2">
                      <div className="font-semibold">{u.title}</div>
                      <span
                        className={`px-2 py-0.5 rounded-full border text-xs ${
                          isPub
                            ? "border-emerald-300 bg-emerald-50 text-emerald-800"
                            : "border-amber-300 bg-amber-50 text-amber-900"
                        }`}
                      >
                        {isPub ? "published" : "draft"}
                      </span>
                    </div>
                    <div className="text-xs opacity-70">{u.slug}</div>
                  </button>
                );
              })}
            </div>
          )}
        </div>
        <div className="lg:col-span-2 rounded-2xl border border-gray-200 p-4">
          <div className="flex items-center justify-between gap-3 mb-3 flex-wrap">
            <div className="font-semibold">{canEditUniverse ? "Edit Universe" : "Create Universe"}</div>
            <div className="flex items-center gap-2">
              {canEditUniverse && universeStatusBadge}
              {selectedUniverse?.slug && (
                <a
                  className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm"
                  href={`/studios/${selectedUniverse.slug}`}
                  target="_blank"
                  rel="noreferrer"
                >
                  View Studio Page ‚Üí
                </a>
              )}
            </div>
          </div>
          {/* Warnings */}
          {canEditUniverse && (missingCharacterThumbCount > 0 || missingWorldMapTitleCount > 0) && (
            <div className="mb-4 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900">
              <div className="font-semibold">Fix Needed</div>
              <ul className="list-disc ml-5 mt-1">
                {missingCharacterThumbCount > 0 && <li>{missingCharacterThumbCount} character(s) missing thumbnails.</li>}
                {missingWorldMapTitleCount > 0 && <li>{missingWorldMapTitleCount} world map(s) missing titles.</li>}
              </ul>
              <div className="mt-2 flex gap-2 flex-wrap">
                <button className="px-3 py-1.5 rounded-xl border border-gray-300" onClick={backfillThumbnailsLocal}>
                  Backfill thumbnails from external_url
                </button>
              </div>
            </div>
          )}
          {!storageBucket && (
            <div className="mb-4 rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-800">
              <div className="font-semibold">Uploads disabled</div>
              <div className="mt-1">
                Supabase Storage bucket not found. Create one in Supabase ‚Üí Storage (recommended name: <code>assets</code>
                ), then pick it in the dropdown above.
              </div>
            </div>
          )}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="text-sm">
              Title
              <input
                className="mt-1 w-full border rounded-xl p-2"
                value={uTitle}
                onChange={(e) => {
                  const v = e.target.value;
                  setUTitle(v);
                  if (!canEditUniverse) setUSlug(slugify(v));
                }}
                placeholder="Legacy of the Hidden Clans"
              />
            </label>
            <label className="text-sm">
              Slug
              <input className="mt-1 w-full border rounded-xl p-2" value={uSlug} onChange={(e) => setUSlug(slugify(e.target.value))} />
            </label>
            <label className="text-sm md:col-span-2">
              Tagline
              <input className="mt-1 w-full border rounded-xl p-2" value={uTagline} onChange={(e) => setUTagline(e.target.value)} />
            </label>
            <label className="text-sm md:col-span-2">
              Logline
              <input className="mt-1 w-full border rounded-xl p-2" value={uLogline} onChange={(e) => setULogline(e.target.value)} />
            </label>
            <label className="text-sm md:col-span-2">
              Synopsis
              <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[110px]" value={uSynopsis} onChange={(e) => setUSynopsis(e.target.value)} />
            </label>
            {/* Cover */}
            <label className="text-sm">
              Cover Image URL
              <input className="mt-1 w-full border rounded-xl p-2" value={uCover} onChange={(e) => setUCover(e.target.value)} />
              <div className="mt-2 flex items-center gap-3 flex-wrap">
                <input type="file" accept="image/*" disabled={uploading || !storageBucket} onChange={(e) => uploadCoverFile(e.target.files?.[0])} />
                {uCover ? <img src={uCover} alt="" className="h-16 w-16 rounded-xl object-cover border" /> : null}
              </div>
            </label>
            {/* Hero Video */}
            <label className="text-sm">
              Hero Video URL
              <input className="mt-1 w-full border rounded-xl p-2" value={uHeroVideo} onChange={(e) => setUHeroVideo(e.target.value)} />
              <div className="mt-2 flex items-center gap-3 flex-wrap">
                <input type="file" accept="video/mp4" disabled={uploading || !storageBucket} onChange={(e) => uploadHeroVideoFile(e.target.files?.[0])} />
                {uHeroVideo && isLikelyMp4Url(uHeroVideo) ? (
                  <video src={uHeroVideo} className="h-16 w-24 rounded-xl object-cover border" muted playsInline loop autoPlay />
                ) : null}
              </div>
              <div className="text-[11px] opacity-60 mt-1">Uploads mp4 into Storage and saves to universes.hero_video_url.</div>
            </label>
            {/* Trailer Video */}
            <label className="text-sm">
              Trailer Video URL
              <input className="mt-1 w-full border rounded-xl p-2" value={uTrailerVideo} onChange={(e) => setUTrailerVideo(e.target.value)} />
              <div className="mt-2 flex items-center gap-3 flex-wrap">
                <input type="file" accept="video/mp4" disabled={uploading || !storageBucket} onChange={(e) => uploadTrailerVideoFile(e.target.files?.[0])} />
                {uTrailerVideo && isLikelyMp4Url(uTrailerVideo) ? (
                  <video src={uTrailerVideo} className="h-16 w-24 rounded-xl object-cover border" muted playsInline loop autoPlay />
                ) : null}
              </div>
              <div className="text-[11px] opacity-60 mt-1">Uploads mp4 into Storage and saves to universes.trailer_video_url.</div>
            </label>
            {/* Featured World Map */}
            <label className="text-sm">
              World Map URL (featured)
              <input className="mt-1 w-full border rounded-xl p-2" value={uWorldMap} onChange={(e) => setUWorldMap(e.target.value)} />
              <div className="mt-2 flex items-center gap-3 flex-wrap">
                <input type="file" accept="image/*" disabled={uploading || !storageBucket} onChange={(e) => uploadFeaturedWorldMapFile(e.target.files?.[0])} />
                {uWorldMap ? <img src={uWorldMap} alt="" className="h-16 w-24 rounded-xl object-cover border" /> : null}
              </div>
              <div className="text-[11px] opacity-60 mt-1">
                This saves to <code>universes.world_map_url</code> and updates immediately once the universe exists.
              </div>
            </label>
            <label className="text-sm">
              Status
              <select className="mt-1 w-full border rounded-xl p-2" value={uStatus} onChange={(e) => setUStatus(e.target.value)}>
                <option value="draft">draft</option>
                <option value="published">published</option>
              </select>
              <div className="text-[11px] opacity-60 mt-1">
                Published universes show up on <code>/studios</code>.
              </div>
            </label>
          </div>
          <div className="mt-4 flex gap-3 flex-wrap">
            <button
              onClick={() => saveUniverse()}
              disabled={savingUniverse || uploading || !uTitle.trim()}
              className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50"
            >
              {savingUniverse ? "Saving‚Ä¶" : uploading ? "Uploading‚Ä¶" : "Save"}
            </button>
            <button
              onClick={publishUniverse}
              disabled={savingUniverse || uploading || !uTitle.trim()}
              className="px-4 py-2 rounded-xl border border-emerald-300 bg-emerald-50 text-emerald-900 disabled:opacity-50"
              title="Sets status=published and saves"
            >
              Publish
            </button>
            <button
              onClick={unpublishUniverse}
              disabled={savingUniverse || !canEditUniverse}
              className="px-4 py-2 rounded-xl border border-amber-300 bg-amber-50 text-amber-900 disabled:opacity-50"
              title="Sets status=draft and saves"
            >
              Unpublish
            </button>
            <button
              onClick={deleteUniverse}
              disabled={savingUniverse || !canEditUniverse}
              className="px-4 py-2 rounded-xl border border-red-300 bg-red-50 text-red-900 disabled:opacity-50 ml-auto"
            >
              Delete Universe
            </button>
          </div>
        </div>
      </div>
      {/* ‚úÖ WORLD MAP CONTROL CENTER */}
      {selectedUniverse?.id && (
        <div className="rounded-2xl border border-gray-200 p-4">
          <div className="flex items-end justify-between gap-4 flex-wrap">
            <div>
              <div className="font-semibold">World Map Control Center</div>
              <div className="text-sm opacity-70">
                Upload multiple world maps (gallery), set one as featured, and manage Region labels.
              </div>
            </div>
            <div className="flex items-center gap-2 flex-wrap">
              <input type="file" accept="image/*" multiple disabled={uploading || !storageBucket} onChange={(e) => uploadWorldMapGallery(e.target.files)} />
            </div>
          </div>
          <div className="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            {/* Gallery */}
            <div className="rounded-2xl border border-gray-200 p-4">
              <div className="font-semibold">World Map Gallery ({worldMapAssets.length})</div>
              <div className="text-[12px] opacity-70 mt-1">
                Stored in <code>universe_assets</code> as <code>asset_type=world_map</code>.
              </div>
              {worldMapAssets.length === 0 ? (
                <div className="mt-3 text-sm opacity-70">No gallery maps yet. Upload above.</div>
              ) : (
                <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {worldMapAssets.map((m) => {
                    const url = m.thumbnail_url || m.external_url || "";
                    const isFeatured = uWorldMap && url && uWorldMap === url;
                    return (
                      <div key={m.id} className={`rounded-2xl border p-3 ${selectedWorldMapAssetId === m.id ? "border-black" : "border-gray-200"}`}>
                        <div className="flex items-center justify-between gap-2">
                          <button
                            className="text-left font-semibold truncate"
                            onClick={() => setSelectedWorldMapAssetId((prev) => (prev === m.id ? null : m.id))}
                            title="Select this map to manage regions"
                          >
                            {m.title || "World Map"}
                          </button>
                          {isFeatured ? (
                            <span className="text-[11px] px-2 py-0.5 rounded-full border border-emerald-300 bg-emerald-50 text-emerald-800">
                              featured
                            </span>
                          ) : null}
                        </div>
                        {url ? (
                          <img src={url} alt="" className="mt-2 h-32 w-full object-cover rounded-xl border" />
                        ) : (
                          <div className="mt-2 h-32 w-full rounded-xl border bg-gray-50 flex items-center justify-center text-xs opacity-60">
                            no image url
                          </div>
                        )}
                        <div className="mt-2 flex gap-2 flex-wrap">
                          <button
                            className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm"
                            onClick={async () => {
                              try {
                                setNotice(null);
                                const next = m.external_url || m.thumbnail_url || "";
                                if (!next) throw new Error("This map has no URL to feature.");
                                setUWorldMap(next);
                                await persistUniverseField("world_map_url", next);
                                setNotice({ type: "ok", msg: "Featured world map updated." });
                              } catch (e) {
                                setNotice({ type: "error", msg: e?.message || "Failed to set featured map" });
                              }
                            }}
                          >
                            Set as Featured
                          </button>
                          <button className="px-3 py-1.5 rounded-xl border border-red-300 bg-red-50 text-red-900 text-sm" onClick={() => removeAsset(m.id)}>
                            Delete
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            {/* Regions */}
            <div className="rounded-2xl border border-gray-200 p-4">
              <div className="flex items-center justify-between gap-3 flex-wrap">
                <div>
                  <div className="font-semibold">World Map Regions</div>
                  <div className="text-[12px] opacity-70 mt-1">
                    {selectedWorldMapAssetId ? (
                      <>
                        Filtering to selected map: <code>{String(selectedWorldMapAssetId).slice(0, 8)}‚Ä¶</code>
                      </>
                    ) : (
                      <>Showing all regions for the universe (select a map to filter).</>
                    )}
                  </div>
                </div>
                <button className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm" onClick={resetRegionForm}>
                  Clear Form
                </button>
              </div>
              {/* Add region */}
              <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                <label className="text-sm md:col-span-2">
                  Region title
                  <input className="mt-1 w-full border rounded-xl p-2" value={rTitle} onChange={(e) => setRTitle(e.target.value)} placeholder="The Ember Coast" />
                </label>
                <label className="text-sm md:col-span-2">
                  Description
                  <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[60px]" value={rDesc} onChange={(e) => setRDesc(e.target.value)} placeholder="Climate, factions, lore..." />
                </label>
                <label className="text-sm">
                  Sort order
                  <input className="mt-1 w-full border rounded-xl p-2" value={String(rSort)} onChange={(e) => setRSort(e.target.value)} />
                </label>
                <label className="text-sm">
                  Metadata JSON (optional)
                  <input className="mt-1 w-full border rounded-xl p-2" value={rMeta} onChange={(e) => setRMeta(e.target.value)} placeholder='{"x":0.2,"y":0.7}' />
                </label>
              </div>
              <div className="mt-3 flex gap-2">
                <button className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50" onClick={addRegion} disabled={savingRegionId}>
                  {savingRegionId === "new" ? "Adding‚Ä¶" : "Add Region"}
                </button>
              </div>
              {/* List regions */}
              <div className="mt-4">
                {loadingRegions ? (
                  <div className="text-sm opacity-70">Loading regions‚Ä¶</div>
                ) : regions.length === 0 ? (
                  <div className="text-sm opacity-70">No regions yet.</div>
                ) : (
                  <div className="space-y-2">
                    {regions.map((r) => {
                      const isSaving = savingRegionId === r.id;
                      return (
                        <div key={r.id} className="rounded-2xl border border-gray-200 p-3">
                          <div className="flex items-center justify-between gap-2">
                            <div className="font-semibold truncate">{r.title}</div>
                            <div className="flex gap-2">
                              <button
                                className="px-3 py-1 rounded-xl border text-sm disabled:opacity-50"
                                disabled={isSaving}
                                onClick={() => updateRegion(r.id, { sort_order: clampInt(r.sort_order, 0) - 10 })}
                              >
                                ‚Üë
                              </button>
                              <button
                                className="px-3 py-1 rounded-xl border text-sm disabled:opacity-50"
                                disabled={isSaving}
                                onClick={() => updateRegion(r.id, { sort_order: clampInt(r.sort_order, 0) + 10 })}
                              >
                                ‚Üì
                              </button>
                            </div>
                          </div>
                          {r.description ? <div className="text-sm opacity-80 mt-1">{r.description}</div> : null}
                          <div className="text-[11px] opacity-60 mt-1">sort: {r.sort_order}</div>
                          <div className="mt-2 flex gap-2 flex-wrap">
                            <button
                              className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm disabled:opacity-50"
                              disabled={isSaving}
                              onClick={() => {
                                setRTitle(r.title || "");
                                setRDesc(r.description || "");
                                setRSort(r.sort_order ?? 0);
                                setRMeta(JSON.stringify(r.metadata || {}));
                                setNotice({ type: "ok", msg: "Loaded region into form (edit fields, then use Update below)." });
                              }}
                            >
                              Load into form
                            </button>
                            <button
                              className="px-3 py-1.5 rounded-xl border border-gray-300 text-sm disabled:opacity-50"
                              disabled={isSaving}
                              onClick={() =>
                                updateRegion(r.id, {
                                  title: rTitle.trim() || r.title,
                                  description: rDesc || null,
                                  sort_order: clampInt(rSort, r.sort_order || 0),
                                  metadata: safeJsonParse(rMeta, r.metadata || {}),
                                })
                              }
                            >
                              {isSaving ? "Updating‚Ä¶" : "Update from form"}
                            </button>
                            <button
                              className="px-3 py-1.5 rounded-xl border border-red-300 bg-red-50 text-red-900 text-sm disabled:opacity-50"
                              disabled={isSaving}
                              onClick={() => deleteRegion(r.id)}
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
      {/* Studio Pages (kept intact) */}
      {selectedUniverse?.id && (
        <div className="rounded-2xl border border-gray-200 p-4">
          <div className="flex items-end justify-between gap-4 flex-wrap">
            <div>
              <div className="font-semibold">Studio Pages (Paste Content)</div>
              <div className="text-sm opacity-70">
                Published pages render on <code>/studios/[slug]</code>.
              </div>
            </div>
            <button className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50" onClick={resetPageEditor}>
              + New Page
            </button>
          </div>
          <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="rounded-2xl border border-gray-200 p-3">
              <div className="font-semibold mb-2">Pages</div>
              {loadingPages ? (
                <div className="opacity-70">Loading‚Ä¶</div>
              ) : studioPages.length === 0 ? (
                <div className="opacity-70 text-sm">No studio pages yet.</div>
              ) : (
                <div className="space-y-2">
                  {studioPages.map((pg) => (
                    <button
                      key={pg.id}
                      onClick={() => selectPage(pg)}
                      className={`w-full text-left p-3 rounded-xl border transition ${
                        pId === pg.id ? "border-black" : "border-gray-200 hover:border-gray-300"
                      }`}
                    >
                      <div className="flex items-center justify-between gap-2">
                        <div className="font-semibold">{pg.title}</div>
                        <span
                          className={`px-2 py-0.5 rounded-full border text-xs ${
                            pg.status === "published"
                              ? "border-emerald-300 bg-emerald-50 text-emerald-800"
                              : "border-amber-300 bg-amber-50 text-amber-900"
                          }`}
                        >
                          {pg.status}
                        </span>
                      </div>
                      <div className="text-xs opacity-70">{pg.page_type} ‚Ä¢ sort {pg.sort_order}</div>
                    </button>
                  ))}
                </div>
              )}
            </div>
            <div className="lg:col-span-2 rounded-2xl border border-gray-200 p-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <label className="text-sm md:col-span-2">
                  Title
                  <input className="mt-1 w-full border rounded-xl p-2" value={pTitle} onChange={(e) => setPTitle(e.target.value)} />
                </label>
                <label className="text-sm">
                  Type
                  <select className="mt-1 w-full border rounded-xl p-2" value={pType} onChange={(e) => setPType(e.target.value)}>
                    {PAGE_TYPES.map((t) => (
                      <option key={t} value={t}>
                        {t}
                      </option>
                    ))}
                  </select>
                </label>
                <label className="text-sm">
                  Status
                  <select className="mt-1 w-full border rounded-xl p-2" value={pStatus} onChange={(e) => setPStatus(e.target.value)}>
                    <option value="draft">draft</option>
                    <option value="published">published</option>
                  </select>
                </label>
                <label className="text-sm">
                  Sort
                  <input className="mt-1 w-full border rounded-xl p-2" value={String(pSort)} onChange={(e) => setPSort(e.target.value)} />
                </label>
                <label className="text-sm md:col-span-3">
                  Excerpt (optional)
                  <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[60px]" value={pExcerpt} onChange={(e) => setPExcerpt(e.target.value)} />
                </label>
                <label className="text-sm md:col-span-3">
                  Hero Image URL (optional)
                  <input className="mt-1 w-full border rounded-xl p-2" value={pHeroImg} onChange={(e) => setPHeroImg(e.target.value)} />
                </label>
                <label className="text-sm md:col-span-3">
                  Hero Video URL (optional)
                  <input className="mt-1 w-full border rounded-xl p-2" value={pHeroVid} onChange={(e) => setPHeroVid(e.target.value)} />
                </label>
                <label className="text-sm md:col-span-3">
                  Content (Markdown or plain text ‚Äî paste)
                  <textarea
                    className="mt-1 w-full border rounded-xl p-3 min-h-[260px] font-mono text-xs"
                    value={pContent}
                    onChange={(e) => setPContent(e.target.value)}
                  />
                </label>
              </div>
              <div className="mt-4 flex gap-3">
                <button className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50" onClick={savePage} disabled={!pTitle.trim() || savingPageId}>
                  {savingPageId ? "Saving‚Ä¶" : "Save Page"}
                </button>
                {pId ? (
                  <button className="px-4 py-2 rounded-xl border border-red-300 bg-red-50 text-red-900 disabled:opacity-50" onClick={deletePage} disabled={savingPageId}>
                    Delete Page
                  </button>
                ) : null}
              </div>
              <div className="mt-3 text-[11px] opacity-60">Tip: set Status=published to show on the public Studio page.</div>
            </div>
          </div>
        </div>
      )}
      {/* ‚úÖ NEW: Attach Media Tracks / Audio / Trailers from media.js (posts division=media) */}
      <div className="rounded-2xl border border-gray-200 p-4">
        <div className="flex items-end justify-between gap-4 flex-wrap">
          <div>
            <div className="font-semibold">Attach Media (Songs / Audio / Trailers)</div>
            <div className="text-sm opacity-70">
              Pull from <code>posts</code> where <code>division=media</code>. Adds to <code>universe_assets</code> so it renders on <code>/studios/[slug]</code>.
            </div>
          </div>
          <div className="flex gap-2 flex-wrap items-center">
            <select className="border rounded-xl p-2" value={mediaTypeFilter} onChange={(e) => setMediaTypeFilter(e.target.value)}>
              {MEDIA_TYPES.map((t) => (
                <option key={t} value={t}>
                  {t}
                </option>
              ))}
            </select>
            <input
              className="border rounded-xl p-2"
              value={mediaQuery}
              onChange={(e) => setMediaQuery(e.target.value)}
              placeholder="Search media title or slug‚Ä¶"
            />
            <button className="px-4 py-2 rounded-xl border border-gray-300" onClick={searchMediaPosts} disabled={mediaSearching || !selectedUniverse?.id}>
              {mediaSearching ? "Searching‚Ä¶" : "Search Media"}
            </button>
          </div>
        </div>
        {!selectedUniverse?.id && (
          <div className="mt-4 text-sm rounded-xl border border-amber-200 bg-amber-50 p-3">
            Create or select a universe first. Then you can attach media to it.
          </div>
        )}
        <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          {mediaResults.map((p) => {
            const already = assets.some((a) => {
              if (a.source_type === "post") {
                const md = a.metadata || {};
                if (md?.post_id && md.post_id === p.id) return true;
                if (md?.post_slug && md.post_slug === p.slug) return true;
              }
              if (a.external_url && p?.slug && String(a.external_url) === `/media/${p.slug}`) return true;
              return false;
            });
            const playable = p._audio_url || (isAudioLikeUrl(p._media_url) ? p._media_url : "");
            const detailUrl = p.slug ? `/media/${p.slug}` : "";
            const thumb = p._thumb;
            return (
              <div key={p.id} className="rounded-2xl border border-gray-200 p-3">
                <div className="flex items-start justify-between gap-2">
                  <div className="min-w-0">
                    <div className="text-[11px] opacity-70 uppercase tracking-[0.22em]">
                      media ‚Ä¢ {String(p._media_type || "soundtrack")}
                    </div>
                    <div className="font-semibold truncate">{p.title}</div>
                    <div className="text-xs opacity-70 truncate">{p.slug}</div>
                  </div>
                  {already ? (
                    <span className="text-[11px] px-2 py-0.5 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-800">
                      attached
                    </span>
                  ) : null}
                </div>
                {thumb ? <img src={thumb} alt="" className="mt-3 h-28 w-full object-cover rounded-xl" /> : null}
                <div className="mt-3 space-y-2">
                  {playable ? (
                    <audio controls className="w-full">
                      <source
                        src={playable}
                        type={
                          /\.mp3(\?|$)/i.test(playable)
                            ? "audio/mpeg"
                            : /\.wav(\?|$)/i.test(playable)
                            ? "audio/wav"
                            : /\.ogg(\?|$)/i.test(playable)
                            ? "audio/ogg"
                            : /\.m4a(\?|$)/i.test(playable)
                            ? "audio/mp4"
                            : undefined
                        }
                      />
                    </audio>
                  ) : (
                    <div className="text-xs opacity-70">
                      No direct audio URL found in metadata. (That‚Äôs okay ‚Äî Studio can still link to the Media page.)
                    </div>
                  )}
                  <div className="flex gap-2 flex-wrap">
                    {detailUrl ? (
                      <a className="text-sm underline" href={detailUrl} target="_blank" rel="noreferrer">
                        Open Media Page ‚Üí
                      </a>
                    ) : null}
                    {p._best_url ? (
                      <a className="text-sm underline" href={p._best_url} target="_blank" rel="noreferrer">
                        Open Source URL ‚Üí
                      </a>
                    ) : null}
                  </div>
                  <button
                    className="w-full px-3 py-2 rounded-xl bg-black text-white disabled:opacity-50"
                    onClick={() => addMediaPostToUniverse(p)}
                    disabled={!selectedUniverse?.id || already}
                  >
                    {already ? "Already Added" : "Add Media to Universe"}
                  </button>
                </div>
              </div>
            );
          })}
        </div>
        {selectedUniverse?.id && mediaResults.length === 0 && (
          <div className="mt-4 text-sm opacity-70">
            No media results. If you know you have items, confirm your <code>posts</code> table has <code>division='media'</code> and fields
            <code> title</code>/<code>slug</code>. Metadata should include <code>audio_url</code> and/or <code>media_url</code> for best Studio playback.
          </div>
        )}
      </div>
      {/* Quick add custom item (manual link) */}
      <div className="rounded-2xl border border-gray-200 p-4">
        <div className="flex items-end justify-between gap-4 flex-wrap">
          <div>
            <div className="font-semibold">Add Universe Item (Manual Link)</div>
            <div className="text-sm opacity-70">Perfect for Characters + Trailers + Decks. Thumbnail uploads now save reliably.</div>
          </div>
          <div className="flex gap-2 flex-wrap">
            <button className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50" onClick={primeQuickAddForCharacter} disabled={!selectedUniverse?.id}>
              + Character Mode
            </button>
          </div>
        </div>
        <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <label className="text-sm">
            Division
            <select className="mt-1 w-full border rounded-xl p-2" value={qaDivision} onChange={(e) => setQaDivision(e.target.value)}>
              <option value="studios">studios</option>
              <option value="media">media</option>
              <option value="publishing">publishing</option>
              <option value="designs">designs</option>
              <option value="capital">capital</option>
              <option value="tech">tech</option>
              <option value="realty">realty</option>
            </select>
          </label>
          <label className="text-sm">
            Asset Type
            <select className="mt-1 w-full border rounded-xl p-2" value={qaType} onChange={(e) => setQaType(e.target.value)}>
              <option value="trailer">trailer</option>
              <option value="soundtrack">soundtrack</option>
              <option value="score">score</option>
              <option value="audiobook">audiobook</option>
              <option value="chapter_read">chapter_read</option>
              <option value="scene">scene</option>
              <option value="playlist">playlist</option>
              <option value="musicvideo">musicvideo</option>
              <option value="pitch_deck">pitch_deck</option>
              <option value="option_deck">option_deck</option>
              <option value="script">script</option>
              <option value="pdf">pdf</option>
              <option value="image">image</option>
              <option value="link">link</option>
              <option value="nft">nft</option>
              <option value="world_map">world_map</option>
              <option value="character">character</option>
              <option value="episode_art">episode_art</option>
              <option value="mp4">mp4</option>
            </select>
          </label>
          <label className="text-sm">
            Status
            <select className="mt-1 w-full border rounded-xl p-2" value={qaStatus} onChange={(e) => setQaStatus(e.target.value)}>
              <option value="published">published</option>
              <option value="draft">draft</option>
            </select>
          </label>
          <label className="text-sm md:col-span-2">
            Title
            <input className="mt-1 w-full border rounded-xl p-2" value={qaTitle} onChange={(e) => setQaTitle(e.target.value)} placeholder="Kael ‚Äî Last Heir" />
          </label>
          <label className="text-sm">
            Public?
            <select className="mt-1 w-full border rounded-xl p-2" value={qaPublic ? "yes" : "no"} onChange={(e) => setQaPublic(e.target.value === "yes")}>
              <option value="yes">yes (free)</option>
              <option value="no">no (premium)</option>
            </select>
          </label>
          <label className="text-sm md:col-span-2">
            External URL (YouTube/Spotify/MP3/PDF/etc)
            <input className="mt-1 w-full border rounded-xl p-2" value={qaUrl} onChange={(e) => setQaUrl(e.target.value)} placeholder="https://..." />
            <div className="text-[11px] opacity-60 mt-1">Tip: for songs, use a direct mp3/wav URL for instant audio playback on Studio pages.</div>
          </label>
          <label className="text-sm">
            Thumbnail URL
            <input className="mt-1 w-full border rounded-xl p-2" value={qaThumb} onChange={(e) => setQaThumb(e.target.value)} placeholder="https://... OR upload below" />
            <div className="mt-2 flex items-center gap-3 flex-wrap">
              <input type="file" accept="image/*,video/mp4" disabled={uploading || !selectedUniverse?.id || !storageBucket} onChange={(e) => uploadQuickAddThumbFile(e.target.files?.[0])} />
              {qaThumb ? (
                isLikelyMp4Url(qaThumb) ? (
                  <video src={qaThumb} className="h-16 w-24 rounded-xl object-cover border" muted playsInline loop autoPlay />
                ) : (
                  <img src={qaThumb} alt="" className="h-16 w-16 rounded-xl object-cover border" />
                )
              ) : null}
            </div>
          </label>
          <label className="text-sm">
            Price (USD, premium only)
            <input className="mt-1 w-full border rounded-xl p-2" value={qaPrice} onChange={(e) => setQaPrice(e.target.value)} placeholder="49.00" disabled={qaPublic} />
          </label>
          <label className="text-sm md:col-span-3">
            Description
            <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[80px]" value={qaDesc} onChange={(e) => setQaDesc(e.target.value)} />
          </label>
          <label className="text-sm md:col-span-3">
            Metadata JSON (optional)
            <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[70px]" value={qaMetaStr} onChange={(e) => setQaMetaStr(e.target.value)} />
          </label>
        </div>
        <div className="mt-4 flex gap-3">
          <button className="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50" disabled={!selectedUniverse?.id} onClick={addCustomAsset}>
            Add Item
          </button>
          <button className="px-4 py-2 rounded-xl border border-gray-300" onClick={resetQuickAdd}>
            Reset
          </button>
        </div>
      </div>
      {/* Curate products into universe (existing) */}
      <div className="rounded-2xl border border-gray-200 p-4">
        <div className="flex items-end justify-between gap-4 flex-wrap">
          <div>
            <div className="font-semibold">Attach Products (from products table)</div>
            <div className="text-sm opacity-70">Search products and add them as universe items.</div>
          </div>
          <div className="flex gap-2 flex-wrap">
            <select className="border rounded-xl p-2" value={division} onChange={(e) => setDivision(e.target.value)}>
              <option value="publishing">publishing</option>
              <option value="designs">designs</option>
              <option value="capital">capital</option>
              <option value="realty">realty</option>
            </select>
            <input className="border rounded-xl p-2" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Search name or slug‚Ä¶" />
            <button className="px-4 py-2 rounded-xl border border-gray-300" onClick={searchProducts} disabled={searching}>
              {searching ? "Searching‚Ä¶" : "Search"}
            </button>
          </div>
        </div>
        {!selectedUniverse?.id && (
          <div className="mt-4 text-sm rounded-xl border border-amber-200 bg-amber-50 p-3">
            Create or select a universe first. Then you can attach products to it.
          </div>
        )}
        <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          {productResults.map((p) => {
            const exists = assets.some((a) => a.source_type === "product" && a.source_product_id === p.id);
            return (
              <div key={p.id} className="rounded-2xl border border-gray-200 p-3">
                <div className="font-semibold">{p.name}</div>
                <div className="text-xs opacity-70">{p.slug}</div>
                {p.image_url && <img src={p.image_url} alt="" className="mt-3 h-28 w-full object-cover rounded-xl" />}
                <button
                  className="mt-3 w-full px-3 py-2 rounded-xl bg-black text-white disabled:opacity-50"
                  onClick={() => addProductToUniverse(p)}
                  disabled={!selectedUniverse?.id || exists}
                >
                  {exists ? "Already Added" : "Add to Universe"}
                </button>
              </div>
            );
          })}
        </div>
      </div>
      {/* Current universe items (FULL CRUD) */}
      {selectedUniverse?.id && (
        <div className="rounded-2xl border border-gray-200 p-4">
          <div className="flex items-center justify-between gap-3 mb-3 flex-wrap">
            <div className="font-semibold">Universe Items ({assets.length})</div>
            <div className="text-sm opacity-70">
              Tip: for songs, ensure metadata has <code>audio_url</code> (mp3/wav) so Studio can play instantly.
            </div>
          </div>
          {assets.length === 0 ? (
            <div className="opacity-70 text-sm">Nothing attached yet.</div>
          ) : (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {assets.map((a, idx) => {
                const isSaving = Boolean(savingAssetIds[a.id]);
                const isPublic = Boolean(getAssetVal(a, "is_public", a.is_public));
                const priceCents = clampInt(getAssetVal(a, "price_cents", a.price_cents || 0), a.price_cents || 0);
                const status = String(getAssetVal(a, "status", a.status || "published") || "published");
                const thumb = getAssetVal(a, "thumbnail_url", a.thumbnail_url || "");
                const title = getAssetVal(a, "title", a.title || "");
                const desc = getAssetVal(a, "description", a.description || "");
                const exUrl = getAssetVal(a, "external_url", a.external_url || "");
                const divisionVal = getAssetVal(a, "division", a.division || "");
                const typeVal = getAssetVal(a, "asset_type", a.asset_type || "");
                const sortOrderVal = getAssetVal(a, "sort_order", a.sort_order ?? idx * 10);
                const metaStr = getAssetMetaStr(a);
                const metaObj = safeJsonParse(metaStr, a.metadata || {});
                const thumbIsVideo =
                  isLikelyMp4Url(thumb) || String(metaObj?.thumb_kind || "").toLowerCase() === "video";
                const hasAudio = isAudioLikeUrl(exUrl) || isAudioLikeUrl(metaObj?.audio_url || "");
                return (
                  <div key={a.id} className="rounded-2xl border border-gray-200 p-4">
                    <div className="flex items-start gap-3">
                      <div className="w-16 h-16 rounded-xl overflow-hidden border bg-gray-100 flex items-center justify-center text-[10px] opacity-70 shrink-0">
                        {thumb ? (
                          thumbIsVideo ? (
                            <video src={thumb} className="w-full h-full object-cover" muted playsInline loop autoPlay />
                          ) : (
                            <img src={thumb} alt="" className="w-full h-full object-cover" />
                          )
                        ) : (
                          "no thumb"
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="text-[11px] opacity-70 uppercase tracking-[0.22em]">
                          {String(a.division || "").toUpperCase()} ‚Ä¢ {String(a.asset_type || "").toUpperCase()}
                          {hasAudio ? " ‚Ä¢ AUDIO" : ""}
                        </div>
                        <div className="font-semibold truncate">{a.title}</div>
                        {!isPublic && (
                          <div className="mt-1 text-xs rounded-full inline-flex px-2 py-0.5 border border-amber-200 bg-amber-50">
                            Premium ‚Ä¢ ${toMoney(priceCents)}
                          </div>
                        )}
                      </div>
                      <div className="flex gap-2">
                        <button
                          className="px-3 py-1 rounded-xl border text-sm disabled:opacity-50"
                          disabled={idx === 0 || isSaving}
                          onClick={() => moveAsset(a.id, -1)}
                        >
                          ‚Üë
                        </button>
                        <button
                          className="px-3 py-1 rounded-xl border text-sm disabled:opacity-50"
                          disabled={idx === assets.length - 1 || isSaving}
                          onClick={() => moveAsset(a.id, +1)}
                        >
                          ‚Üì
                        </button>
                      </div>
                    </div>
                    <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                      <label className="text-sm">
                        Title
                        <input className="mt-1 w-full border rounded-xl p-2" value={title} onChange={(e) => setAssetField(a.id, { title: e.target.value })} />
                      </label>
                      <label className="text-sm">
                        Sort Order
                        <input
                          className="mt-1 w-full border rounded-xl p-2"
                          value={String(sortOrderVal ?? "")}
                          onChange={(e) => setAssetField(a.id, { sort_order: e.target.value })}
                        />
                      </label>
                      <label className="text-sm">
                        Division
                        <input className="mt-1 w-full border rounded-xl p-2" value={divisionVal} onChange={(e) => setAssetField(a.id, { division: e.target.value })} />
                      </label>
                      <label className="text-sm">
                        Asset Type
                        <input className="mt-1 w-full border rounded-xl p-2" value={typeVal} onChange={(e) => setAssetField(a.id, { asset_type: e.target.value })} />
                        <div className="text-[11px] opacity-60 mt-1">
                          For songs: <code>soundtrack</code> or <code>score</code>. For reads: <code>chapter_read</code>. For video: <code>trailer</code>.
                        </div>
                      </label>
                      <label className="text-sm md:col-span-2">
                        Description
                        <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[70px]" value={desc} onChange={(e) => setAssetField(a.id, { description: e.target.value })} />
                      </label>
                      <label className="text-sm md:col-span-2">
                        External URL
                        <input className="mt-1 w-full border rounded-xl p-2" value={exUrl} onChange={(e) => setAssetField(a.id, { external_url: e.target.value })} />
                        <div className="text-[11px] opacity-60 mt-1">
                          For audio playback on Studio pages, make this a direct <code>.mp3</code>/<code>.wav</code> or store <code>metadata.audio_url</code>.
                        </div>
                      </label>
                      <label className="text-sm md:col-span-2">
                        Thumbnail URL
                        <input className="mt-1 w-full border rounded-xl p-2" value={thumb} onChange={(e) => setAssetField(a.id, { thumbnail_url: e.target.value })} />
                        <div className="mt-2 flex items-center gap-3 flex-wrap">
                          <input
                            type="file"
                            accept="image/*,video/mp4"
                            disabled={uploading || isSaving || !storageBucket}
                            onChange={(e) => uploadAssetThumbFile(a, e.target.files?.[0])}
                          />
                          {thumb ? (
                            thumbIsVideo ? (
                              <video src={thumb} className="h-16 w-24 rounded-xl object-cover border" muted playsInline loop autoPlay />
                            ) : (
                              <img src={thumb} alt="" className="h-16 w-16 rounded-xl object-cover border" />
                            )
                          ) : null}
                        </div>
                      </label>
                      <label className="text-sm">
                        Status
                        <select className="mt-1 w-full border rounded-xl p-2" value={status} onChange={(e) => setAssetField(a.id, { status: e.target.value })}>
                          <option value="published">published</option>
                          <option value="draft">draft</option>
                        </select>
                      </label>
                      <label className="text-sm">
                        Public / Premium
                        <select
                          className="mt-1 w-full border rounded-xl p-2"
                          value={isPublic ? "public" : "premium"}
                          onChange={(e) => {
                            const nextPublic = e.target.value === "public";
                            setAssetField(a.id, { is_public: nextPublic, price_cents: nextPublic ? 0 : priceCents || 4900 });
                          }}
                        >
                          <option value="public">public (free)</option>
                          <option value="premium">premium (gated)</option>
                        </select>
                      </label>
                      <label className="text-sm md:col-span-2">
                        Price (cents, premium only)
                        <input
                          className="mt-1 w-full border rounded-xl p-2"
                          value={String(priceCents ?? 0)}
                          onChange={(e) => setAssetField(a.id, { price_cents: e.target.value })}
                          disabled={isPublic}
                        />
                        <div className="text-[11px] opacity-60 mt-1">Display: ${toMoney(priceCents)}</div>
                      </label>
                      <label className="text-sm md:col-span-2">
                        Metadata JSON
                        <textarea className="mt-1 w-full border rounded-xl p-2 min-h-[70px]" value={metaStr} onChange={(e) => setAssetField(a.id, { metadataStr: e.target.value })} />
                        <div className="text-[11px] opacity-60 mt-1">
                          For Studio music playback, include: <code>{`{"audio_url":"...mp3","media_type":"soundtrack"}`}</code>
                        </div>
                      </label>
                    </div>
                    <div className="mt-4 flex gap-3 items-center">
                      {exUrl ? (
                        <a className="text-sm underline" href={exUrl} target="_blank" rel="noreferrer">
                          Open ‚Üí
                        </a>
                      ) : (
                        <span className="text-sm opacity-60">No link</span>
                      )}
                      <button className="ml-auto px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50" disabled={isSaving} onClick={() => saveAsset(a)}>
                        {isSaving ? "Saving‚Ä¶" : "Save Item"}
                      </button>
                      <button className="px-4 py-2 rounded-xl border border-red-300 bg-red-50 text-red-900" onClick={() => removeAsset(a.id)} disabled={isSaving}>
                        Remove
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}
    </div>
  );
}


===== FILE: components/admin/UpcomingStaysPanel.js  (size=6078 bytes) =====
// components/admin/UpcomingStaysPanel.js
import { useEffect, useState } from 'react';

export default function UpcomingStaysPanel() {
  const [stays, setStays] = useState([]);
  const [loading, setLoading] = useState(true);

  // simple filter/search state
  const [search, setSearch] = useState('');

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/realty/upcoming');
        const data = await res.json();
        if (data.ok) {
          setStays(data.stays || []);
        } else {
          console.error('upcoming error:', data.error);
        }
      } catch (e) {
        console.error('upcoming crash:', e);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // lightweight client-side search by guest or property
  const filtered = stays.filter((s) => {
    if (!search.trim()) return true;
    const q = search.toLowerCase();
    return (
      s.guest_name.toLowerCase().includes(q) ||
      s.guest_email.toLowerCase().includes(q) ||
      s.property_name.toLowerCase().includes(q)
    );
  });

  return (
    <div className="glass p-4 rounded">
      <h2 className="text-lg font-semibold mb-4 flex items-center justify-between">
        <span>Upcoming Stays</span>
        <span className="text-xs font-normal opacity-70">
          {stays.length} total
        </span>
      </h2>

      {/* search/filter row */}
      <div className="flex flex-col md:flex-row md:items-center gap-3 mb-4">
        <input
          className="border border-gray-300 dark:border-gray-700 rounded px-2 py-1 text-sm dark:bg-gray-900"
          placeholder="Search guest or property‚Ä¶"
          value={search}
          onChange={(e) => setSearch(e.target.value)}
        />
        <div className="text-xs opacity-70">
          Showing reservations with status <code>paid</code> whose checkout is
          today or later.
        </div>
      </div>

      {/* table */}
      <div className="overflow-x-auto border border-gray-200 dark:border-gray-800 rounded">
        <table className="min-w-[700px] w-full text-sm border-collapse">
          <thead className="bg-gray-50 dark:bg-gray-800/50">
            <tr className="text-left border-b border-gray-200 dark:border-gray-800">
              <th className="py-2 px-3">Property</th>
              <th className="py-2 px-3">Dates</th>
              <th className="py-2 px-3">Guest</th>
              <th className="py-2 px-3">Guests</th>
              <th className="py-2 px-3">Total</th>
              <th className="py-2 px-3">Contact</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td
                  className="py-6 px-3 text-center opacity-70"
                  colSpan={6}
                >
                  Loading‚Ä¶
                </td>
              </tr>
            ) : filtered.length === 0 ? (
              <tr>
                <td
                  className="py-6 px-3 text-center opacity-70"
                  colSpan={6}
                >
                  No upcoming paid stays.
                </td>
              </tr>
            ) : (
              filtered.map((stay) => (
                <tr
                  key={stay.id}
                  className="border-b border-gray-200 dark:border-gray-800 align-top"
                >
                  <td className="py-3 px-3">
                    <div className="font-semibold text-sm">
                      {stay.property_name}
                    </div>
                    <div className="text-[11px] opacity-70">
                      /realty/{stay.property_slug}
                    </div>
                    <div className="text-[11px] opacity-70">
                      #{stay.property_id.slice(0, 6)}‚Ä¶
                    </div>
                  </td>

                  <td className="py-3 px-3 text-sm whitespace-nowrap">
                    <div>
                      <span className="font-medium">{stay.checkin}</span> ‚Üí
                      <span className="font-medium"> {stay.checkout}</span>
                    </div>
                    <div className="text-[11px] opacity-70">
                      {stay.status === 'paid' ? '‚úÖ Paid' : stay.status}
                    </div>
                  </td>

                  <td className="py-3 px-3 text-sm">
                    <div className="font-medium">{stay.guest_name}</div>
                    <div className="text-[11px] opacity-70">
                      {stay.guest_email}
                    </div>
                  </td>

                  <td className="py-3 px-3 text-sm">
                    {stay.guests || '‚Äî'}
                  </td>

                  <td className="py-3 px-3 text-sm whitespace-nowrap">
                    {stay.amount
                      ? `$${stay.amount} ${stay.currency || 'usd'}`
                      : '‚Äî'}
                  </td>

                  <td className="py-3 px-3 text-xs leading-relaxed">
                    {stay.guest_phone && (
                      <div className="opacity-90">{stay.guest_phone}</div>
                    )}
                    {stay.guest_email && (
                      <div className="opacity-70 break-all">
                        {stay.guest_email}
                      </div>
                    )}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <p className="text-[11px] opacity-60 mt-3 leading-snug">
        Tip: This list comes straight from Stripe ‚Üí webhook ‚Üí Supabase. As
        long as a checkout.session.completed fires and we mark the reservation
        paid, it‚Äôll show up here. If you manually comp a guest and skip Stripe,
        you‚Äôll need to insert a row in <code>realty_reservations</code> with
        status <code>paid</code>.
      </p>
    </div>
  );
}


===== FILE: components/admin/UsersTab.js  (size=2134 bytes) =====
// components/admin/UsersTab.js
import React from 'react';
import SectionCard from '@/components/admin/SectionCard';
import { supabase } from '@/lib/supabase';

export default function UsersTab({ users, refreshAll }) {
  const toggleUserRole = async (userId, currentRole) => {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    if (!confirm(`Change role to ${newRole} for this user?`)) return;
    const { error } = await supabase
      .from('users')
      .update({ role: newRole })
      .eq('id', userId);
    if (error) alert(`Failed to update role: ${error.message}`);
    else refreshAll?.();
  };

  return (
    <SectionCard title="Users Management">
      <div className="mt-6 overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Email</th>
              <th>Role</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {users.map((u) => (
              <tr
                key={u.id}
                className="border-b dark:border-gray-800"
              >
                <td className="py-2">{u.email}</td>
                <td className="py-2">{u.role || 'user'}</td>
                <td className="py-2">
                  {new Date(u.created_at).toLocaleString()}
                </td>
                <td className="py-2">
                  <button
                    className="px-3 py-1 bg-blue-600 text-white rounded"
                    onClick={() => toggleUserRole(u.id, u.role)}
                  >
                    Toggle Role
                  </button>
                </td>
              </tr>
            ))}

            {users.length === 0 && (
              <tr>
                <td colSpan={4} className="py-6 opacity-70">
                  No users yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/Calendar.js  (size=957 bytes) =====
// components/Calendar.js
import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import enUS from 'date-fns/locale/en-US'; // Added import
import 'react-big-calendar/lib/css/react-big-calendar.css';

const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: { 'en-US': enUS } // Added locales
});

export default function EventCalendar({ events }) {
  const formattedEvents = events.map(event => ({
    title: event.title,
    start: new Date(event.date),
    end: new Date(event.date),
    allDay: true,
  }));

  return (
    <div className="h-[600px]">
      <Calendar
        localizer={localizer}
        events={formattedEvents}
        startAccessor="start"
        endAccessor="end"
        style={{ height: '100%' }}
        className="bg-white dark:bg-gray-800 p-4 rounded glass"
      />
    </div>
  );
}


===== FILE: components/Card.js  (size=6398 bytes) =====
// components/Card.js
import { motion } from 'framer-motion';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';

const Card = ({
  children,
  className = '',
  title,
  description,
  image,
  link,
  category,
  buyButton = null,   // product object
  onBuy,              // optional handler from parent
  tags = [],          // optional explicit tags (fallback if product.tags missing)
  showTags = true,
  showNftBadge = true,
}) => {
  const dispatch = useDispatch();

  // product payload coming from parent (Designs page)
  const product = buyButton || {};
  const resolvedTags =
    Array.isArray(product.tags) && product.tags.length ? product.tags : tags;

  // we support either top-level nft_url or metadata.nft_url
  const nftUrl = product?.nft_url || product?.metadata?.nft_url || null;
  const hasNFT = Boolean(nftUrl);

  // NEW: Media playlist embed
  const metadata = product.metadata || {};
  const isPlaylist = metadata.media_type === 'playlist' && metadata.media_url;
  const playlistId = isPlaylist ? metadata.media_url.split('list=')[1] : null;

  // NEW: Tech app badges
  const isApp = metadata.app_type === 'app' && metadata.app_url;

  const handleClick = () => {
    if (category && typeof window !== 'undefined') {
      try {
        const clicks = JSON.parse(localStorage.getItem('clicks') || '{}');
        clicks[category] = (clicks[category] || 0) + 1;
        localStorage.setItem('clicks', JSON.stringify(clicks));
      } catch {
        /* ignore localStorage errors */
      }
    }
  };

  const handleBuy = (p) => {
    dispatch(addToCart(p));
  };

  return (
    <motion.article
      initial={{ opacity: 0, y: 20 }}
      whileInView={{ opacity: 1, y: 0 }}
      viewport={{ once: true }}
      transition={{ duration: 0.5 }}
      className={`card bg-white rounded-xl shadow-lg overflow-hidden transition-shadow hover:shadow-xl dark:bg-gray-900 ${className}`}
      role="article"
      onClick={handleClick}
    >
      {/* Media */}
      <div className="relative">
        {image && (
          <img
            src={image}
            alt={title || 'Card Image'}
            className="w-full h-[300px] object-cover"
            loading="lazy"
            onError={(e) => {
              if (e.currentTarget.src !== '/placeholder.png') {
                e.currentTarget.src = '/placeholder.png';
              }
            }}
          />
        )}

        {/* NFT Ribbon (clickable) */}
        {showNftBadge && hasNFT && (
          <a
            href={nftUrl}
            target="_blank"
            rel="noopener noreferrer"
            onClick={(e) => e.stopPropagation()}
            className="absolute top-3 right-3 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded"
            title="View NFT on OpenSea"
          >
            NFT
          </a>
        )}
      </div>

      {/* Body */}
      <div className="p-6 text-center">
        {title && <h3 className="text-2xl font-bold mb-4">{title}</h3>}
        {description && (
          <p className="text-gray-700 dark:text-gray-300 text-base mb-4">
            {description}
          </p>
        )}

        {/* Tags */}
        {showTags && Array.isArray(resolvedTags) && resolvedTags.length > 0 && (
          <div className="flex flex-wrap gap-2 justify-center mb-4">
            {resolvedTags.map((t) => (
              <span
                key={t}
                className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
              >
                {t}
              </span>
            ))}
          </div>
        )}

        {/* Learn more (optional) */}
        {link && (
          <a
            href={link}
            className={`btn bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 transition block mx-auto w-fit mb-4 ${
              className && className.includes('capital') ? 'hover:bg-purple-500' : ''
            }`}
            target="_blank"
            rel="noopener noreferrer"
          >
            Learn More
          </a>
        )}

        {/* Actions */}
        <div className="flex flex-wrap gap-3 justify-center">
          {buyButton && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                if (typeof onBuy === 'function') onBuy(buyButton);
                else handleBuy(buyButton);
              }}
              className="btn bg-yellow-500 text-black py-2 px-4 rounded hover:bg-yellow-400 transition"
            >
              Buy Now
              {typeof buyButton.price !== 'undefined'
                ? ` - $${Number(buyButton.price).toFixed(2)}`
                : ''}
            </button>
          )}

          {hasNFT && (
            <a
              href={nftUrl}
              target="_blank"
              rel="noopener noreferrer"
              onClick={(e) => e.stopPropagation()}
              className="btn bg-gray-900 text-white py-2 px-4 rounded hover:bg-black transition"
              title="View NFT"
            >
              View NFT
            </a>
          )}
        </div>

        {/* Extra children */}
        <div className="flex flex-wrap justify-center gap-4 items-center mt-4">
          {children}
        </div>

        {/* NEW: Playlist embed */}
        {isPlaylist && playlistId && (
          <div className="mt-4">
            <iframe
              width="100%"
              height="315"
              src={`https://www.youtube.com/embed/videoseries?list=${playlistId}`}
              title="YouTube video player"
              frameBorder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
            ></iframe>
          </div>
        )}

        {/* NEW: App store badge */}
        {isApp && (
          <div className="mt-4">
            <a href={metadata.app_url} target="_blank" rel="noopener noreferrer">
              <img src="/app-store-badge.png" alt="Download on the App Store" className="h-10" />
            </a>
          </div>
        )}
      </div>
    </motion.article>
  );
};

export default Card;


===== FILE: components/Cart.js  (size=8359 bytes) =====
// components/Cart.js
import { useSelector, useDispatch } from 'react-redux';
import { removeFromCart, updateQuantity } from '@/lib/cartSlice';
import Link from 'next/link';
import { loadStripe } from '@stripe/stripe-js';
import Recommender from './Recommender';
import { useState, useEffect } from 'react';

const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
  { automaticMode: 'auto' }
);

// Pick best available image, fallback safe
function lineItemImageSrc(item) {
  return (
    item.thumbnail_url ||
    item.display_image ||
    item.image_url ||
    item.thumbnail ||
    item.image ||
    item?.product?.thumbnail_url ||
    item?.product?.image_url ||
    '/placeholder.png'
  );
}

const Cart = () => {
  const items = useSelector((state) => state.cart.items || []);
  const dispatch = useDispatch();

  // we'll still let user type an email so we can prefill Stripe Checkout session
  const [email, setEmail] = useState('');
  const [error, setError] = useState('');

  // show running total
  const total = Array.isArray(items)
    ? items.reduce(
        (acc, item) =>
          acc + Number(item.price || 0) * (item.quantity || 1),
        0
      )
    : 0;

  // ---- helper: get affiliate code from localStorage
  const [affiliateCode, setAffiliateCode] = useState(null);
  useEffect(() => {
    try {
      const ref = window.localStorage.getItem('affiliate_ref');
      if (ref) setAffiliateCode(ref);
    } catch {
      /* ignore */
    }
  }, []);

  // ---- MAIN CHECKOUT HANDLER
  const handleCheckout = async () => {
    setError('');

    // must have at least 1 item
    if (!items.length) {
      setError('Your cart is empty.');
      return;
    }

    // üîí current backend assumes ONE product per checkout session
    if (items.length > 1) {
      setError(
        'Please checkout one item at a time (we only support single-item checkout right now).'
      );
      return;
    }

    const cartItem = items[0];
    const quantity = cartItem.quantity || 1;

    // special case: Realty bookings should NOT go through create-session,
    // they should already be using /api/realty/book from the property page.
    // If somehow a realty item is in the cart, bail with a message.
    if (cartItem.division === 'realty') {
      setError(
        'This stay needs to be booked from the property page. Please return to the listing to finish checkout.'
      );
      return;
    }

    // normal merch / digital / etc -> /api/checkout/create-session
    try {
      const stripe = await stripePromise;

      // we POST to create-session so it can:
      // - create Stripe Checkout Session
      // - insert pending row in orders
      // - include affiliate_code
      const resp = await fetch('/api/checkout/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: cartItem.id,        // required
          quantity,                       // default 1
          mode: undefined,                // NOT "subscription" (this is one-time)
          email: email || undefined,      // optional convenience
          affiliate_code: affiliateCode || null, // <-- üî• pass affiliate
        }),
      });

      const data = await resp.json();

      if (!resp.ok || data.error) {
        console.error('checkout create-session error:', data.error);
        setError(
          data.error ||
            'Checkout could not start. This product may be missing Stripe config.'
        );
        return;
      }

      if (data.url) {
        // just bounce to Stripe Checkout
        window.location.href = data.url;
        return;
      }

      // Backup path: if for some reason url isn't present
      setError('Checkout session did not return a redirect URL.');
    } catch (err) {
      console.error('Checkout error:', err);
      setError('An error occurred during checkout.');
    }
  };

  return (
    <div className="card max-w-2xl mx-auto bg-white text-black glass py-10">
      <h2 className="text-3xl font-bold mb-6">Your Cart</h2>

      {/* CART EMPTY STATE */}
      {items.length === 0 ? (
        <p className="text-gray-600 text-base mb-4">
          Cart is empty.{` `}
          <Link
            href="/designs"
            className="text-blue-600 hover:underline"
          >
            Shop Designs
          </Link>
          .
        </p>
      ) : (
        <>
          {/* LINE ITEMS */}
          <ul className="space-y-4 mb-6">
            {Array.isArray(items) &&
              items.map((item) => (
                <li
                  key={item.id}
                  className="flex justify-between items-center pb-4 border-b border-gray-300"
                >
                  <div className="flex items-center gap-4">
                    <img
                      src={lineItemImageSrc(item)}
                      alt={item.name || 'Product image'}
                      className="w-[100px] h-[100px] object-cover rounded bg-gray-100"
                      onError={(e) => {
                        e.currentTarget.src = '/placeholder.png';
                      }}
                    />
                    <div>
                      <div className="text-base font-medium">
                        {item.name}{' '}
                        <span className="opacity-70 text-sm">
                          ({item.division || 'site'})
                        </span>
                      </div>

                      <input
                        type="number"
                        value={item.quantity || 1}
                        min="1"
                        onChange={(e) =>
                          dispatch(
                            updateQuantity({
                              id: item.id,
                              quantity:
                                parseInt(e.target.value, 10) || 1,
                            })
                          )
                        }
                        className="w-16 p-1 border rounded mt-2"
                      />
                    </div>
                  </div>

                  <div className="text-right">
                    <div className="text-base">
                      $
                      {(
                        Number(item.price || 0) *
                        (item.quantity || 1)
                      ).toFixed(2)}
                    </div>

                    <button
                      onClick={() =>
                        dispatch(removeFromCart(item.id))
                      }
                      className="text-red-500 hover:text-red-600 text-sm mt-2"
                    >
                      Remove
                    </button>
                  </div>
                </li>
              ))}
          </ul>

          {/* TOTAL */}
          <p className="text-right font-bold text-base mb-4">
            Total: ${total.toFixed(2)}
          </p>

          {/* OPTIONAL EMAIL PREFILL */}
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Email (for receipt / delivery)"
            className="w-full p-3 border rounded bg-white text-black mb-3"
          />

          {/* affiliate note (read-only visual cue) */}
          {affiliateCode ? (
            <div className="text-xs text-green-700 bg-green-100 border border-green-300 rounded p-2 mb-3">
              Referred by code <strong>{affiliateCode}</strong> ‚Äî this
              purchase will be credited.
            </div>
          ) : null}

          {/* ERRORS */}
          {error && (
            <p className="text-red-500 text-base mb-3">{error}</p>
          )}

          {/* CHECKOUT BUTTON */}
          <button
            onClick={handleCheckout}
            className="btn bg-black text-white py-4 px-6 rounded w-full hover:scale-105 transition"
          >
            Checkout
          </button>

          <Recommender />
        </>
      )}
    </div>
  );
};

export default Cart;


===== FILE: components/ErrorBoundary.js  (size=841 bytes) =====
import React from 'react';

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error('Client-side error caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="p-8 text-center">
          <h2>Something went wrong.</h2>
          <p>{this.state.error?.message || 'Unknown error'}</p>
          <button onClick={() => window.location.reload()} className="btn bg-blue-600 text-white py-2 px-4 rounded">Reload Page</button>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;


===== FILE: components/Footer.js  (size=9144 bytes) =====
import Link from "next/link";
import { useRouter } from "next/router";
import {
  FaInstagram,
  FaTiktok,
  FaYoutube,
  FaTwitter,
  FaLinkedin,
  FaPinterest,
  FaFacebook,
  FaEnvelope,
} from "react-icons/fa";

// ===== Social handles (parent + divisions) =====
const SOCIAL_HANDLES = {
  parent: {
    label: "Manyagi",
    instagram: "manyagiofficial",
    twitter: "manyagiofficial",
    youtube: "@manyagiofficial",
    pinterest: "manyagiofficial",
    linkedin: "manyagiofficial",
    facebook: "manyagiofficial",
    tiktok: "manyagiofficial",
  },
  publishing: {
    label: "Manyagi Publishing",
    instagram: "manyagipublishing",
    twitter: "manyagipublish",
    pinterest: "manyagipublishing",
    linkedin: "manyagipublishing",
    facebook: "manyagipublishing",
    tiktok: "manyagipublishing",
  },
  designs: {
    label: "Manyagi Designs",
    instagram: "manyagidesigns",
    twitter: "manyagidesigns",
    pinterest: "manyagidesigns",
    linkedin: "manyagidesigns",
    facebook: "manyagidesigns",
    tiktok: "manyagidesigns",
  },
  media: {
    label: "Manyagi Media",
    instagram: "manyagimedia",
    twitter: "manyagimedia",
    youtube: "@manyagimedia",
    pinterest: "manyagimedia",
    linkedin: "manyagimedia",
    facebook: "manyagimedia",
    tiktok: "manyagimedia",
  },

  // NEW
  studios: {
    label: "Manyagi Studios",
    instagram: "manyagistudios",
    twitter: "manyagistudios",
    youtube: "@manyagistudios",
    pinterest: "manyagistudios",
    linkedin: "manyagistudios",
    facebook: "manyagistudios",
    tiktok: "manyagistudios",
  },

  capital: {
    label: "Manyagi Capital",
    instagram: "manyagicapital",
    twitter: "manyagicapital",
    linkedin: "manyagicapital",
    facebook: "manyagicapital",
    tiktok: "manyagicapital",
  },
  tech: {
    label: "Manyagi Tech",
    instagram: "manyagitech",
    twitter: "manyagitech",
    youtube: "@manyagitech",
    linkedin: "manyagitech",
    tiktok: "manyagitech",
  },
  realty: {
    label: "Manyagi Realty",
    instagram: "manyagirealty",
    twitter: "manyagirealty",
    linkedin: "manyagirealty",
    facebook: "manyagirealty",
    tiktok: "manyagirealty1",
  },
};

// ===== Public email per division =====
const DIVISION_EMAIL = {
  parent: "info@manyagi.net",
  publishing: "publishing@manyagi.net",
  designs: "designs@manyagi.net",
  media: "media@manyagi.net",

  // NEW
  studios: "studios@manyagi.net",

  capital: "capital@manyagi.net",
  tech: "tech@manyagi.net",
  realty: "realty@manyagi.net",
};

const DIVISION_BLURB = {
  parent:
    "Manyagi is a modern creative & capital group building IP, media, brands, and systems across publishing, designs, media, tech, capital, and realty.",
  publishing:
    "Manyagi Publishing develops original fiction, poetry, and story universes engineered for long-term readership and cross-media adaptation.",
  designs:
    "Manyagi Designs turns worlds and symbols into apparel, posters, collectibles, and visual identities that feel premium and timeless.",
  media:
    "Manyagi Media documents the build, grows the audience, and distributes our IP through series, shorts, documentaries, and digital storytelling.",
  studios:
    "Manyagi Studios is the IP vault: trailers, decks, world lore, and Hollywood-facing presentation per universe.",
  capital:
    "Manyagi Capital focuses on disciplined frameworks for wealth, income, and allocation ‚Äî treating creators like asset classes, not side projects.",
  tech:
    "Manyagi Tech ships the infrastructure: sites, apps, tools, and automations powering the Manyagi ecosystem and future platforms.",
  realty:
    "Manyagi Realty explores real estate and physical spaces that extend the brand into the real world through stays, sets, and experiences.",
};

function platformUrl(platform, handle) {
  if (!handle) return null;
  switch (platform) {
    case "instagram": return `https://instagram.com/${handle}`;
    case "twitter":   return `https://x.com/${handle.replace(/^@/, "")}`;
    case "youtube":   return `https://youtube.com/${handle.startsWith("@") ? handle : `@${handle}`}`;
    case "pinterest": return `https://pinterest.com/${handle}`;
    case "linkedin":  return `https://linkedin.com/company/${handle}`;
    case "facebook":  return `https://facebook.com/${handle}`;
    case "tiktok":    return `https://tiktok.com/@${handle.replace(/^@/, "")}`;
    default:          return null;
  }
}

function Icon({ name }) {
  switch (name) {
    case "instagram": return <FaInstagram />;
    case "tiktok":    return <FaTiktok />;
    case "youtube":   return <FaYoutube />;
    case "twitter":   return <FaTwitter />;
    case "linkedin":  return <FaLinkedin />;
    case "pinterest": return <FaPinterest />;
    case "facebook":  return <FaFacebook />;
    default:          return null;
  }
}

export default function Footer({ division: override }) {
  const router = useRouter();

  const division = override || (() => {
    const p = router.pathname || "";
    if (p.startsWith("/publishing")) return "publishing";
    if (p.startsWith("/designs"))    return "designs";
    if (p.startsWith("/media"))      return "media";
    if (p.startsWith("/studios"))    return "studios"; // NEW
    if (p.startsWith("/capital"))    return "capital";
    if (p.startsWith("/tech"))       return "tech";
    if (p.startsWith("/realty"))     return "realty";
    return "parent";
  })();

  const cfg   = SOCIAL_HANDLES[division] || SOCIAL_HANDLES.parent;
  const email = DIVISION_EMAIL[division] || DIVISION_EMAIL.parent;
  const blurb = DIVISION_BLURB[division] || DIVISION_BLURB.parent;

  const ORDER = ["instagram", "tiktok", "youtube", "twitter", "linkedin", "pinterest", "facebook"];
  let links = ORDER.map((p) => {
    const url = platformUrl(p, cfg[p]);
    return url ? { p, url } : null;
  }).filter(Boolean);

  // Always add Manyagi Media YouTube on division pages (not homepage)
  if (division !== "parent" && !links.some(l => l.url.includes("@manyagimedia"))) {
    links.push({ p: "youtube", url: "https://youtube.com/@manyagimedia" });
  }

  return (
    <footer className="bg-white text-black border-t border-gray-200">
      <div className="container mx-auto px-4 py-10 grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
          <h4 className="text-xl font-bold mb-2">
            {division === "parent" ? "Manyagi" : cfg.label}
          </h4>
          <p className="text-sm text-gray-700">{blurb}</p>
        </div>

        <div className="text-sm">
          <h5 className="font-semibold mb-2">Explore</h5>
          <ul className="space-y-1">
            <li><Link href="/publishing" className="hover:text-yellow-600">Publishing</Link></li>
            <li><Link href="/designs"    className="hover:text-yellow-600">Designs</Link></li>
            <li><Link href="/media"      className="hover:text-yellow-600">Media</Link></li>
            <li><Link href="/studios"    className="hover:text-yellow-600">Studios</Link></li> {/* NEW */}
            <li><Link href="/capital"    className="hover:text-yellow-600">Capital</Link></li>
            <li><Link href="/tech"       className="hover:text-yellow-600">Tech</Link></li>
            <li><Link href="/realty"     className="hover:text-yellow-600">Realty</Link></li>
            <li><Link href="/blog"       className="hover:text-yellow-600">Blog</Link></li>
          </ul>
        </div>

        <div className="text-sm">
          <h5 className="font-semibold mb-2 flex items-center gap-2">
            <FaEnvelope /> Contact
          </h5>
          <a
            href={`mailto:${email}`}
            className="underline hover:text-yellow-600 break-all"
          >
            {email}
          </a>
          <div className="mt-4 flex flex-wrap gap-3 text-xl">
            {links.map(({ p, url }) => (
              <a
                key={`${p}-${url}`}
                href={url}
                target="_blank"
                rel="noopener noreferrer"
                className="hover:text-yellow-600 transition-colors"
                title={p}
              >
                <Icon name={p} />
              </a>
            ))}
          </div>
        </div>
      </div>

      <div className="border-t border-gray-200">
        <div className="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-3 text-xs text-gray-700">
          <div>¬© {new Date().getFullYear()} {cfg.label}. All rights reserved.</div>
          <div className="flex gap-4">
            <Link href="/privacy" className="hover:text-yellow-600">Privacy</Link>
            <Link href="/terms"   className="hover:text-yellow-600">Terms</Link>
            <Link href="/about"   className="hover:text-yellow-600">About</Link>
          </div>
          <div className="text-gray-600">Creativity Meets Innovation</div>
        </div>
      </div>
    </footer>
  );
}


===== FILE: components/Header.js  (size=3594 bytes) =====
// components/Header.js
import Link from 'next/link';
import Image from 'next/image';
import { useRouter } from 'next/router';
import { useSelector } from 'react-redux';
import { FaShoppingCart } from 'react-icons/fa';
import { useTheme } from 'next-themes';
import { useEffect, useState } from 'react';

const Header = () => {
  const router = useRouter();
  const items = useSelector((state) => state.cart.items || []);
  const cartCount = items.length;
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => setMounted(true), []);

  const linkClass = (href) => {
    const active = router.pathname === href || router.pathname.startsWith(`${href}/`);
    return `hover:text-yellow-500 transition ${active ? 'text-yellow-600 font-semibold' : ''}`;
  };

  return (
    <header className="sticky top-0 bg-white z-50 border-b border-gray-300 text-black">
      <div className="container mx-auto flex items-center justify-between py-4 px-4 md:px-8 flex-col md:flex-row">
        {/* Logo */}
        <div className="flex items-center">
          <Link href="/" className="flex items-center gap-3 font-bold uppercase tracking-widest">
            <Image
              src="/images/logo.svg"
              alt="Manyagi Logo"
              width={100}
              height={50}
              loading="lazy"
            />
          </Link>
        </div>

        {/* Navigation */}
        <nav className="flex flex-wrap gap-4 md:gap-6 items-center justify-center md:justify-end mt-4 md:mt-0">
          <Link href="/" className={linkClass('/')}>Home</Link>
          <Link href="/publishing" className={linkClass('/publishing')}>Publishing</Link>
          <Link href="/designs" className={linkClass('/designs')}>Designs</Link>
          <Link href="/media" className={linkClass('/media')}>Media</Link>

          {/* NEW */}
          <Link href="/studios" className={linkClass('/studios')}>Studios</Link>

          <Link href="/capital" className={linkClass('/capital')}>Capital</Link>
          <Link href="/tech" className={linkClass('/tech')}>Tech</Link>
          <Link href="/realty" className={linkClass('/realty')}>Realty</Link>
          <Link href="/blog" className={linkClass('/blog')}>Blog</Link>
          <Link href="/about" className={linkClass('/about')}>About</Link>
          <Link href="/contact" className={linkClass('/contact')}>Contact</Link>
          <Link href="/links" className={linkClass('/links')}>Links</Link>

          <Link href="/admin" className="hover:text-yellow-500 transition bg-blue-100 px-2 py-1 rounded">
            Admin
          </Link>

          {/* Cart */}
          <Link href="/cart" className="relative hover:text-yellow-500 transition">
            <FaShoppingCart className="inline-block" />
            {cartCount > 0 && (
              <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center">
                {cartCount}
              </span>
            )}
          </Link>

          {/* Theme Toggle */}
          {mounted && (
            <button
              onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
              className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-black dark:text-white transition-colors"
            >
              {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
            </button>
          )}
        </nav>
      </div>
    </header>
  );
};

export default Header;


===== FILE: components/Hero.js  (size=2986 bytes) =====
// components/Hero.js
import { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import 'react-responsive-carousel/lib/styles/carousel.min.css';
import { Carousel } from 'react-responsive-carousel';

const Hero = ({ kicker, title, lead, children, carouselImages = [], videoSrc, height = 'h-[600px]' }) => {
  const [isClient, setIsClient] = useState(false);
  useEffect(() => { setIsClient(true); }, []);

  const hasMedia = videoSrc || carouselImages.length > 0;
  const showVideo = isClient && videoSrc && ((window.innerWidth >= 640) || !carouselImages.length);

  return (
    <motion.section
      className={`relative min-h-[600px] sm:${height} flex flex-col items-center overflow-hidden bg-white z-0`}
      aria-labelledby="hero-title"
    >
      {showVideo && videoSrc && (
        <video
          autoPlay
          loop
          muted
          className="relative w-full h-auto object-cover z-0 sm:absolute sm:inset-0 sm:h-full sm:w-full"
          src={videoSrc}
          aria-hidden="true"
        />
      )}
      {carouselImages.length > 0 && !showVideo && (
        <Carousel
          autoPlay
          interval={5000}
          showThumbs={false}
          showStatus={false}
          infiniteLoop
          stopOnHover
          showArrows
          className="z-0 relative w-full h-auto sm:absolute sm:inset-0 sm:h-full sm:w-full"
        >
          {carouselImages.map((img, i) => (
            <img key={i} src={img} alt={`Slide ${i + 1}`} className="object-cover w-full h-auto sm:h-full" loading="lazy" />
          ))}
        </Carousel>
      )}
      {hasMedia && <div className="absolute inset-0 bg-black/50 z-10 hidden sm:block" />}
      <div
        className={`relative z-30 p-10 max-w-4xl mx-auto flex flex-col items-center text-center text-black ${hasMedia ? 'sm:text-white' : ''} mt-auto sm:mt-0`}
      >
        <motion.span
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="uppercase tracking-widest text-lg mb-4"
        >
          {kicker}
        </motion.span>
        <motion.h1
          id="hero-title"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.4 }}
          className="text-5xl font-bold mb-4 leading-tight"
        >
          {title}
        </motion.h1>
        <motion.p
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.6 }}
          className="text-base mb-8 max-w-2xl"
        >
          {lead}
        </motion.p>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.8 }}
          className="flex flex-col md:flex-row gap-4"
        >
          {children}
        </motion.div>
      </div>
    </motion.section>
  );
};

export default Hero;


===== FILE: components/RealtyLeadForm.js  (size=4809 bytes) =====
// components/RealtyLeadForm.js
import { useState } from 'react';

export default function RealtyLeadForm({ propertyId, className = '' }) {
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [interest, setInterest] = useState('buy'); // default
  const [notes, setNotes] = useState('');
  const [statusMsg, setStatusMsg] = useState('');
  const [submitting, setSubmitting] = useState(false);

  const submitLead = async (e) => {
    e.preventDefault();
    if (!name || !email || !interest) {
      setStatusMsg('Please fill required fields.');
      return;
    }

    try {
      setSubmitting(true);
      setStatusMsg('');

      const res = await fetch('/api/realty/lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          email,
          phone,
          interest_type: interest,
          notes,
          property_id: propertyId || null,
        }),
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Failed to send');
      }

      setStatusMsg('Thanks ‚Äî we‚Äôll reach out shortly.');
      setName('');
      setEmail('');
      setPhone('');
      setNotes('');
      setInterest('buy');
    } catch (err) {
      console.error('lead submit error:', err);
      setStatusMsg('Something went wrong. Please try again.');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <form
      onSubmit={submitLead}
      className={`bg-white/95 dark:bg-gray-900 border dark:border-gray-700 rounded-2xl p-5 md:p-6 space-y-4 ${className}`}
    >
      <div>
        <h3 className="text-lg font-semibold">Talk to a Manyagi Realty Specialist</h3>
        <p className="text-xs opacity-80 -mt-1">
          California residential, commercial, and short-term rental management.
        </p>
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">I&apos;m looking to‚Ä¶</label>
        <select
          className="w-full border rounded-lg px-3 py-2 text-sm dark:bg-gray-800"
          value={interest}
          onChange={(e) => setInterest(e.target.value)}
        >
          <option value="buy">Buy property</option>
          <option value="sell">Sell my property</option>
          <option value="invest">Find an investment deal</option>
          <option value="manage">Get my rental managed</option>
          <option value="rental_inquiry">Ask about a stay</option>
          <option value="other">Other / Not sure yet</option>
        </select>
      </div>

      <div className="grid grid-cols-1 gap-3">
        <div>
          <label className="block text-sm font-medium mb-1">Your name *</label>
          <input
            className="w-full border rounded-lg px-3 py-2 text-sm dark:bg-gray-800"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="Jane Doe"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Email *</label>
          <input
            type="email"
            className="w-full border rounded-lg px-3 py-2 text-sm dark:bg-gray-800"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="you@email.com"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Phone</label>
          <input
            className="w-full border rounded-lg px-3 py-2 text-sm dark:bg-gray-800"
            value={phone}
            onChange={(e) => setPhone(e.target.value)}
            placeholder="(optional)"
          />
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">Notes</label>
        <textarea
          className="w-full border rounded-lg px-3 py-2 text-sm dark:bg-gray-800 h-24"
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          placeholder="Tell us what you're looking for. Timeline, budget, area, property type‚Ä¶"
        />
      </div>

      <button
        disabled={submitting}
        className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-semibold text-sm hover:bg-blue-500 disabled:opacity-50"
      >
        {submitting ? 'Sending‚Ä¶' : 'Get in Touch'}
      </button>

      {statusMsg && (
        <p className="text-sm text-center pt-1">{statusMsg}</p>
      )}

      <p className="text-[10px] opacity-60 text-center">
        No spam. We only contact you about this request.
      </p>
    </form>
  );
}


===== FILE: components/Recommender.js  (size=916 bytes) =====
// components/Recommender.js
import { useEffect, useState } from 'react';

const Recommender = () => {
  const [recommendation, setRecommendation] = useState('');

  useEffect(() => {
    const clicks = JSON.parse(localStorage.getItem('clicks') || '{}');
    const mostClicked = Object.keys(clicks).sort((a, b) => clicks[b] - clicks[a])[0];
    setRecommendation(
      mostClicked === 'publishing' ? 'Check out our latest books!' :
      mostClicked === 'designs' ? 'Explore our creative designs!' :
      mostClicked === 'media' ? 'Watch our latest videos!' :
      mostClicked === 'capital' ? 'Get trading signals!' :
      mostClicked === 'tech' ? 'Download our apps!' :
      'Discover all Manyagi divisions!'
    );
  }, []);

  return (
    <div className="p-6 text-center glass mt-4">
      <p className="text-lg">{recommendation}</p>
    </div>
  );
};

export default Recommender;


===== FILE: components/SectionIntro.js  (size=5223 bytes) =====
// components/SectionIntro.js

/**
 * SectionIntro
 *
 * Reusable section header / intro block used above content.
 * - kicker (eyebrow) text
 * - title
 * - lead / description
 * - optional image (left or right)
 * - optional children (buttons, chips, etc.)
 *
 * Usage:
 * <SectionIntro
 *   id="reader-impressions"
 *   kicker="Reader Impressions"
 *   title="Stories Made to Stay With You"
 *   lead="Readers describe the Manyagi Universe as emotionally grounded..."
 *   tone="warm"
 * />
 */

export default function SectionIntro({
  id,
  kicker,
  title,
  lead,
  align = 'center',          // 'left' | 'center'
  tone = 'plain',            // 'plain' | 'warm' | 'card' | 'neutral'
  imageSrc,
  imageAlt = '',
  imagePosition = 'right',   // 'left' | 'right'
  maxWidth = 'max-w-3xl',
  children,
  className = '',
}) {
  const hasImage = Boolean(imageSrc);

  const baseSectionClasses = [
    'w-full',
    'py-12 md:py-16',
    className,
  ]
    .filter(Boolean)
    .join(' ');

  const containerBase =
    'container mx-auto px-4 rounded-3xl transition-colors duration-300';

  let containerTone = '';
  if (tone === 'warm') {
    containerTone =
      'bg-gradient-to-b from-amber-50 via-amber-50/70 to-amber-100 ' +
      'dark:from-amber-900/40 dark:via-amber-900/30 dark:to-amber-900/60';
  } else if (tone === 'card') {
    containerTone =
      'bg-white/95 dark:bg-gray-950/95 border border-gray-200/70 ' +
      'dark:border-gray-800 shadow-sm';
  } else if (tone === 'neutral') {
    // ‚ú® New: neutral pill style used for Capital Roadmap & Catalog
    containerTone =
      'bg-gradient-to-b from-white/95 via-white/95 to-slate-50/95 ' +
      'border border-gray-200/70 dark:border-gray-800 shadow-sm';
  } else {
    // plain
    containerTone = 'bg-transparent';
  }

  const layoutClasses = [
    'flex flex-col gap-10 md:gap-12 py-8 md:py-10',
    hasImage && 'md:flex-row md:items-center',
    hasImage && imagePosition === 'left' && 'md:flex-row-reverse',
  ]
    .filter(Boolean)
    .join(' ');

  const textAlignClasses =
    align === 'left'
      ? 'md:items-start md:text-left'
      : 'md:items-center md:text-center';

  const textBlockWidth = hasImage ? 'md:w-1/2' : 'md:w-full';

  return (
    <section id={id} className={baseSectionClasses}>
      <div className={`${containerBase} ${containerTone}`}>
        <div className={layoutClasses}>
          {/* Text column */}
          <div
            className={[
              'flex flex-col gap-4 items-center',
              textAlignClasses,
              textBlockWidth,
            ]
              .filter(Boolean)
              .join(' ')}
          >
            {kicker && (
              <p className="text-[11px] font-semibold tracking-[0.28em] uppercase text-amber-700/80 dark:text-amber-300/80 text-center md:text-left">
                {kicker}
              </p>
            )}

            {title && (
              <h2
                className={[
                  'text-2xl md:text-3xl lg:text-4xl font-semibold text-gray-900 dark:text-gray-50',
                  align === 'left' ? 'text-left w-full' : 'text-center',
                ]
                  .filter(Boolean)
                  .join(' ')}
              >
                {title}
              </h2>
            )}

            {lead && (
              <p
                className={[
                  'text-sm md:text-base text-gray-600 dark:text-gray-300',
                  maxWidth,
                  align === 'left' ? 'text-left' : 'text-center',
                ]
                  .filter(Boolean)
                  .join(' ')}
              >
                {lead}
              </p>
            )}

            {children && (
              <div
                className={[
                  'mt-4 flex flex-wrap gap-3',
                  align === 'left' ? 'justify-start' : 'justify-center',
                ]
                  .filter(Boolean)
                  .join(' ')}
              >
                {children}
              </div>
            )}
          </div>

          {/* Optional image column */}
          {hasImage && (
            <div
              className={[
                'md:w-1/2 flex justify-center',
                imagePosition === 'left'
                  ? 'md:justify-start'
                  : 'md:justify-end',
              ]
                .filter(Boolean)
                .join(' ')}
            >
              <div className="relative w-full max-w-md overflow-hidden rounded-3xl shadow-lg shadow-amber-900/10 dark:shadow-black/40">
                <img
                  src={imageSrc}
                  alt={imageAlt}
                  className="h-full w-full object-cover transform transition-transform duration-500 hover:scale-[1.03]"
                />
                <div className="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/35 via-black/5 to-transparent mix-blend-multiply opacity-70" />
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  );
}


===== FILE: components/SEO.js  (size=3654 bytes) =====
// components/SEO.js
import Head from 'next/head';
import { useRouter } from 'next/router';

const SITE_NAME = 'Manyagi';
const TAGLINE = 'Creativity Meets Innovation';
const BASE_URL =
  process.env.NEXT_PUBLIC_SITE_URL ||
  process.env.SITE_URL ||
  'https://manyagi.net';

// Put a real image into /public/og-default.jpg (1200x630 recommended)
const DEFAULT_IMAGE = '/og-default.jpg';
const DEFAULT_DESC =
  'Manyagi ‚Äî Creativity Meets Innovation across Publishing, Designs, Media, Capital, Tech, and Realty.';

export default function SEO({
  title,
  description,
  image,
  url,
  type = 'website',         // article | product | video.other, etc.
  noindex = false,
  publishedTime,             // ISO string for articles
  modifiedTime,              // ISO string for articles
  jsonLd = null,             // optional extra JSON-LD object per page
}) {
  const router = useRouter();
  const path = (router && router.asPath) || '/';
  const canonical = (url || `${BASE_URL}${path.split('?')[0]}`).replace(/\/+$/, '') || BASE_URL;

  const pageTitle = title ? `${title} ‚Äî ${SITE_NAME}` : `${SITE_NAME} ‚Äî ${TAGLINE}`;
  const desc = description || DEFAULT_DESC;
  const ogImage = image?.startsWith('http')
    ? image
    : `${BASE_URL}${(image || DEFAULT_IMAGE).startsWith('/') ? '' : '/'}${image || DEFAULT_IMAGE}`;

  const robots = noindex ? 'noindex,nofollow' : 'index,follow';

  const articleMeta = type === 'article'
    ? [
        publishedTime ? <meta key="article:published_time" property="article:published_time" content={publishedTime} /> : null,
        modifiedTime ? <meta key="article:modified_time" property="article:modified_time" content={modifiedTime} /> : null,
      ].filter(Boolean)
    : null;

  const websiteJsonLd = {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: SITE_NAME,
    url: BASE_URL,
    description: DEFAULT_DESC,
    inLanguage: 'en',
    potentialAction: {
      '@type': 'SearchAction',
      target: `${BASE_URL}/search?q={search_term_string}`,
      'query-input': 'required name=search_term_string',
    },
  };

  return (
    <Head>
      {/* Title + Canonical */}
      <title>{pageTitle}</title>
      <link rel="canonical" href={canonical} />

      {/* Basic */}
      <meta name="description" content={desc} />
      <meta name="robots" content={robots} />
      <meta name="theme-color" content="#000000" />

      {/* OpenGraph */}
      <meta property="og:site_name" content={SITE_NAME} />
      <meta property="og:type" content={type} />
      <meta property="og:title" content={pageTitle} />
      <meta property="og:description" content={desc} />
      <meta property="og:url" content={canonical} />
      <meta property="og:image" content={ogImage} />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="630" />
      {articleMeta}

      {/* Twitter / X */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content={pageTitle} />
      <meta name="twitter:description" content={desc} />
      <meta name="twitter:image" content={ogImage} />

      {/* Structured Data */}
      <script
        type="application/ld+json"
        // Website baseline
        dangerouslySetInnerHTML={{ __html: JSON.stringify(websiteJsonLd) }}
      />
      {jsonLd ? (
        <script
          key="page-jsonld"
          type="application/ld+json"
          dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
        />
      ) : null}
    </Head>
  );
}


===== FILE: components/SignalsSubscriptionForm.js  (size=4614 bytes) =====
// components/SignalsSubscriptionForm.js
import { useState } from 'react';
import { loadStripe } from '@stripe/stripe-js';

// Stripe.js for redirect (kept for future enhancements)
const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
  { automaticMode: 'auto' }
);

/**
 * SignalsSubscriptionForm
 *
 * Props:
 * - priceId       (string, required)  ‚Üí Stripe price id for this tier
 * - planName      (string, optional)  ‚Üí e.g. "Crypto Signals"
 * - priceLabel    (string, optional)  ‚Üí e.g. "$39.99/month"
 * - blurb         (string, optional)  ‚Üí short description under title
 */
const SignalsSubscriptionForm = ({
  priceId,
  planName = 'Signals',
  priceLabel,
  blurb,
}) => {
  const [email, setEmail] = useState('');
  const [telegramId, setTelegramId] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const effectiveBlurb =
    blurb ||
    `Unlock structured ${planName.toLowerCase()} with clear entries, exits, and Telegram alerts after payment.`;

  const handleSubscribe = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      if (!priceId) {
        throw new Error(
          'This plan is temporarily unavailable. Please try again later.'
        );
      }

      if (!telegramId || isNaN(Number(telegramId))) {
        throw new Error('Please enter a valid numeric Telegram ID.');
      }

      const resp = await fetch('/api/checkout/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mode: 'subscription',
          price_id: priceId,
          email,
          telegramId,
        }),
      });

      const data = await resp.json();
      if (!resp.ok || data.error) {
        throw new Error(data.error || 'Failed to create checkout session.');
      }

      const stripe = await stripePromise; // reserved for future Stripe.js usage
      window.location.href = data.url;
    } catch (err) {
      console.error('Subscription error:', err);
      setError(err.message || 'Failed to start subscription.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-4 glass p-4 rounded bg-white text-black dark:bg-gray-900 dark:text-gray-100">
      <h3 className="text-xl font-bold">
        Subscribe to {planName}
      </h3>

      {priceLabel && (
        <div className="text-sm font-semibold text-gray-800 dark:text-gray-200">
          {priceLabel}
        </div>
      )}

      <p className="text-gray-600 text-sm dark:text-gray-300">
        {effectiveBlurb}
      </p>

      <form onSubmit={handleSubscribe} className="space-y-4 mt-2">
        {!priceId && (
          <div className="p-3 rounded bg-yellow-100 text-yellow-800 text-sm">
            Subscription plan is not configured. Add a Stripe price ID for this
            tier in the Capital admin panel.
          </div>
        )}

        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          placeholder="Email Address"
          className="w-full p-3 border border-gray-300 rounded bg-white text-black dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100"
          required
        />

        <input
          type="number"
          value={telegramId}
          onChange={(e) => setTelegramId(e.target.value)}
          placeholder="Telegram ID (e.g., 123456789) - Find via @userinfobot"
          className="w-full p-3 border border-gray-300 rounded bg-white text-black dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100"
          required
        />

        <button
          type="submit"
          disabled={loading || !priceId}
          className="w-full py-3 px-6 bg-yellow-500 text-black rounded font-bold hover:bg-yellow-400 hover:scale-105 transition disabled:opacity-60"
        >
          {loading ? 'Processing‚Ä¶' : `Subscribe to ${planName}`}
        </button>

        {error && (
          <p className="text-red-500 text-sm">
            {error}
          </p>
        )}
      </form>

      <p className="text-xs text-gray-600 dark:text-gray-400">
        Payments processed securely via Stripe. Cancel anytime. Nothing here is
        financial advice; always do your own research and never risk money you
        can‚Äôt afford to lose.
      </p>
    </div>
  );
};

export default SignalsSubscriptionForm;


===== FILE: components/SubscriptionForm.js  (size=2058 bytes) =====
// components/SubscriptionForm.js
import Script from 'next/script';

const SubscriptionForm = ({
  formId,
  uid,
  title,
  description,
  includeTelegramId = false,
}) => {
  return (
    <div aria-labelledby="form-title" className="space-y-4 glass p-4 rounded">
      {/* Load ConvertKit safely (avoids hydration mismatch) */}
      <Script
        id="convertkit-ckjs"
        src="https://f.convertkit.com/ckjs/ck.5.js"
        strategy="afterInteractive"
      />

      <h3 id="form-title" className="text-2xl font-bold text-black">
        {title}
      </h3>
      <p className="text-gray-600 text-base">{description}</p>

      <form
        action={`https://app.convertkit.com/forms/${formId}/subscriptions`}
        className="seva-form formkit-form"
        method="post"
        data-sv-form={formId}
        data-uid={uid}
        data-format="inline"
        data-version="5"
        target="__blank"
        rel="noopener noreferrer"
      >
        <input
          className="w-full p-3 border border-gray-300 rounded bg-white text-black mb-2"
          name="fields[first_name]"
          placeholder="First Name"
          type="text"
        />

        <input
          className="w-full p-3 border border-gray-300 rounded bg-white text-black mb-2"
          name="email_address"
          placeholder="Email Address"
          required
          type="email"
        />

        {includeTelegramId && (
          <input
            className="w-full p-3 border border-gray-300 rounded bg-white text-black mb-2"
            name="fields[telegram_id]"
            placeholder="Telegram ID (e.g., 123456789)"
            type="number"
            required
          />
        )}

        <button
          className="w-full py-4 px-6 bg-yellow-500 text-black rounded font-bold hover:bg-yellow-400 hover:scale-105 transition"
          type="submit"
        >
          Subscribe
        </button>
      </form>
    </div>
  );
};

export default SubscriptionForm;


===== FILE: components/TechQuoteForm.js  (size=5799 bytes) =====
// components/TechQuoteForm.js
import { useState } from 'react';

export default function TechQuoteForm({ className = '' }) {
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [company, setCompany] = useState('');
  const [projectType, setProjectType] = useState('Web / Landing Page');
  const [budget, setBudget] = useState('');
  const [timeline, setTimeline] = useState('');
  const [details, setDetails] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();

    const subject = `Tech Project Request from ${name || 'New Lead'}`;
    const bodyLines = [
      `Name: ${name}`,
      `Email: ${email}`,
      company && `Company / Brand: ${company}`,
      `Project Type: ${projectType}`,
      budget && `Rough Budget: ${budget}`,
      timeline && `Timeline: ${timeline}`,
      '',
      'Project Details:',
      details || '(no details provided yet)',
    ]
      .filter(Boolean)
      .join('\n');

    const mailto = `mailto:tech@manyagi.net?subject=${encodeURIComponent(
      subject
    )}&body=${encodeURIComponent(bodyLines)}`;

    window.location.href = mailto;
  };

  return (
    <div
      className={`rounded-3xl bg-white/95 dark:bg-gray-950/95 border border-gray-200/70 dark:border-gray-800 shadow-sm p-6 md:p-8 ${className}`}
    >
      <form className="space-y-5" onSubmit={handleSubmit}>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-semibold mb-1">Name</label>
            <input
              type="text"
              className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
            />
          </div>
          <div>
            <label className="block text-xs font-semibold mb-1">Email</label>
            <input
              type="email"
              className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
          </div>
        </div>

        <div>
          <label className="block text-xs font-semibold mb-1">
            Company / Brand (optional)
          </label>
          <input
            type="text"
            className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm"
            value={company}
            onChange={(e) => setCompany(e.target.value)}
            placeholder="Manyagi Capital, Daito, etc."
          />
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label className="block text-xs font-semibold mb-1">
              Project Type
            </label>
            <select
              className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm"
              value={projectType}
              onChange={(e) => setProjectType(e.target.value)}
            >
              <option>Web / Landing Page</option>
              <option>Full Web App</option>
              <option>iOS / Android App</option>
              <option>Community / Marketplace Platform</option>
              <option>Automation / Internal Tool</option>
              <option>Other (explain below)</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-semibold mb-1">
              Rough Budget
            </label>
            <input
              type="text"
              className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm"
              value={budget}
              onChange={(e) => setBudget(e.target.value)}
              placeholder="$2k‚Äì$5k, $10k+, not sure, etc."
            />
          </div>
          <div>
            <label className="block text-xs font-semibold mb-1">
              Ideal Timeline
            </label>
            <input
              type="text"
              className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm"
              value={timeline}
              onChange={(e) => setTimeline(e.target.value)}
              placeholder="4 weeks, this quarter, ASAP, etc."
            />
          </div>
        </div>

        <div>
          <label className="block text-xs font-semibold mb-1">
            Project Details
          </label>
          <textarea
            className="w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm h-32"
            value={details}
            onChange={(e) => setDetails(e.target.value)}
            placeholder="Tell us what you want to build, who it‚Äôs for, and any links or inspiration."
          />
        </div>

        <div className="flex flex-wrap items-center justify-between gap-3 pt-2">
          <button
            type="submit"
            className="inline-flex items-center justify-center rounded-md bg-blue-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 transition"
          >
            Generate Email Brief
          </button>
          <p className="text-[11px] text-gray-500 dark:text-gray-400">
            Submitting opens your email app with everything prefilled so you can
            review and send.
          </p>
        </div>
      </form>
    </div>
  );
}


===== FILE: components/ThemeToggle.js  (size=632 bytes) =====
// components/ThemeToggle.js
import { useTheme } from 'next-themes';
import { useEffect, useState } from 'react';

export default function ThemeToggle() {
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return null;

  return (
    <button
      onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
      className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-black dark:text-white transition-colors"
    >
      {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
    </button>
  );
}


===== FILE: lib/adminUtils.js  (size=2054 bytes) =====
// lib/adminUtils.js
import { supabase } from '@/lib/supabase';

// turn "a, b, c" into ["a","b","c"] unique
export const toArrayTags = (s) =>
  Array.from(
    new Set(
      String(s || '')
        .split(',')
        .map((t) => t.trim())
        .filter(Boolean)
    )
  );

export const safeJSON = (s, fallback = {}) => {
  try {
    if (!s) return fallback;
    if (typeof s === 'object') return s;
    return JSON.parse(s);
  } catch {
    return fallback;
  }
};

export const copyText = async (txt) => {
  try {
    await navigator.clipboard.writeText(txt);
    alert('Copied!');
  } catch {
    // ignore clipboard errors silently
  }
};

export const currency = (n) => {
  const num = Number(n || 0);
  return `$${num.toFixed(2)}`;
};

export const isWithinLastDays = (iso, days = 30) => {
  if (!iso) return false;
  const d = new Date(iso);
  const since = new Date();
  since.setDate(since.getDate() - days);
  return d >= since;
};

// generic row updater
export const updateRow = async (table, id, payload) => {
  const { error } = await supabase.from(table).update(payload).eq('id', id);
  if (error) throw error;
};

// products-specific convenience
export const updateProduct = async (id, payload) => {
  await updateRow('products', id, payload);
};

// delete product w/ confirm
export const deleteProduct = async (id, refreshAll) => {
  if (!confirm('Delete this product?')) return;
  const { error } = await supabase.from('products').delete().eq('id', id);
  if (error) {
    alert(`Delete failed: ${error.message}`);
  } else {
    refreshAll?.();
    alert('Product deleted.');
  }
};

// generic delete for any table
export const deleteRow = async (
  table,
  id,
  refreshAll,
  confirmMsg = 'Delete this?'
) => {
  if (!confirm(confirmMsg)) return;
  const { error } = await supabase.from(table).delete().eq('id', id);
  if (error) {
    alert(`Delete failed: ${error.message}`);
  } else {
    refreshAll?.();
    alert('Deleted.');
  }
};


===== FILE: lib/affiliate.js  (size=479 bytes) =====
// /lib/affiliate.js
export function rememberAffiliateFromURL() {
  if (typeof window === 'undefined') return;
  const url = new URL(window.location.href);
  const ref = url.searchParams.get('ref');
  if (ref) {
    // keep simple string like "INF001"
    window.localStorage.setItem('affiliate_ref', ref);
  }
}

export function getRememberedAffiliate() {
  if (typeof window === 'undefined') return null;
  return window.localStorage.getItem('affiliate_ref');
}


===== FILE: lib/cartSlice.js  (size=1035 bytes) =====
// lib/cartSlice.js
import { createSlice } from '@reduxjs/toolkit';

export const cartSlice = createSlice({
  name: 'cart',
  initialState: {
    items: [],
  },
  reducers: {
    addToCart: (state, action) => {
      const item = state.items.find((i) => i.id === action.payload.id);
      if (item) {
        item.quantity += action.payload.quantity || 1;
      } else {
        state.items.push({ ...action.payload, quantity: action.payload.quantity || 1 });
      }
    },
    removeFromCart: (state, action) => {
      state.items = state.items.filter((i) => i.id !== action.payload);
    },
    updateQuantity: (state, action) => {
      const item = state.items.find((i) => i.id === action.payload.id);
      if (item) {
        item.quantity = action.payload.quantity;
      }
    },
    setItems: (state, action) => {
      state.items = action.payload;
    },
  },
});

export const { addToCart, removeFromCart, updateQuantity, setItems } = cartSlice.actions;
export default cartSlice.reducer;


===== FILE: lib/emails/bookingReceipt.js  (size=939 bytes) =====
// lib/emails/bookingReceipt.js
import { sendEmail } from '../sendEmail';
import { itineraryEmailHTML } from '../emailTemplates';

export async function sendBookingReceipt({
  type = 'receipt', // Use 'receipt' to customize template if needed
  guestName = 'Guest',
  to = '',
  property = 'Manyagi Realty Property',
  checkin,
  checkout,
  guests = '',
  replyTo = 'realty@manyagi.net',
  snapshot = {},
}) {
  // Generate HTML using the template (reusing existing for consistency)
  const html = itineraryEmailHTML({
    type,
    guestName,
    to,
    property,
    checkin,
    checkout,
    guests,
    replyTo,
    snapshot,
  });

  // Send the email
  return await sendEmail({
    to,
    subject: `Booking Receipt for ${property}`,
    html,
    text: `Hello ${guestName},\n\nYour booking at ${property} from ${checkin} to ${checkout} for ${guests} guests is confirmed.\n\nThank you!`,
  });
}


===== FILE: lib/emails/itineraryEmail.js  (size=985 bytes) =====
// lib/emails/itineraryEmail.js
import { sendEmail } from '../sendEmail';
import { itineraryEmailHTML } from '../emailTemplates';

export async function sendItineraryEmail({
  type = 'itinerary', // NEW: 'itinerary' or 'receipt'
  guestName = 'Guest',
  to = '',
  property = 'Manyagi Realty Property',
  checkin,
  checkout,
  guests = '',
  replyTo = 'realty@manyagi.net',
  snapshot = {},
}) {
  // Generate HTML using the template
  const html = itineraryEmailHTML({
    type, // Pass to template for customizations
    guestName,
    to,
    property,
    checkin,
    checkout,
    guests,
    replyTo,
    snapshot,
  });

  // Send the email
  return await sendEmail({
    to,
    subject: type === 'receipt' ? `Booking Receipt for ${property}` : `Your Itinerary for ${property}`,
    html,
    text: `Hello ${guestName},\n\nYour booking at ${property} from ${checkin} to ${checkout} for ${guests} guests is confirmed.\n\nThank you!`,
  });
}


===== FILE: lib/emailTemplates.js  (size=3299 bytes) =====
// lib/emailTemplates.js

export function itineraryEmailHTML({
  type = 'itinerary', // NEW: 'itinerary' or 'receipt'
  kicker = 'Manyagi Realty',
  title = type === 'receipt' ? 'Your Booking Receipt' : 'Your Itinerary Quote',
  propertyName = 'Manyagi Realty Property',
  guestName = 'Guest',
  checkin,
  checkout,
  guests = '',
  icsUrl = '',
  detailsUrl = '',
  supportEmail = 'realty@manyagi.net',
}) {
  return `
  <div style="background:#f6f7fb;padding:24px">
    <table role="presentation" style="max-width:640px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif">
      <tr>
        <td style="background:#111827;padding:20px 24px;color:#fff">
          <div style="font-size:18px;font-weight:700">${kicker}</div>
          <div style="opacity:.85;font-size:12px;margin-top:2px">${title}</div>
        </td>
      </tr>
      <tr>
        <td style="padding:24px">
          <h1 style="font-size:20px;margin:0 0 12px 0;color:#111827">Hi ${guestName},</h1>
          <p style="margin:0 0 16px 0;color:#374151;line-height:1.55">
            Here‚Äôs your ${type === 'receipt' ? 'receipt' : 'itinerary quote'} for <strong>${propertyName}</strong>.
          </p>

          <table role="presentation" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;margin:16px 0">
            <tr>
              <td style="padding:12px 16px;border-bottom:1px solid #e5e7eb">
                <div style="font-size:12px;color:#6b7280;margin-bottom:2px">Check-in</div>
                <div style="font-size:14px;color:#111827">${checkin}</div>
              </td>
            </tr>
            <tr>
              <td style="padding:12px 16px;border-bottom:1px solid #e5e7eb">
                <div style="font-size:12px;color:#6b7280;margin-bottom:2px">Check-out</div>
                <div style="font-size:14px;color:#111827">${checkout}</div>
              </td>
            </tr>
            <tr>
              <td style="padding:12px 16px">
                <div style="font-size:12px;color:#6b7280;margin-bottom:2px">Guests</div>
                <div style="font-size:14px;color:#111827">${guests}</div>
              </td>
            </tr>
          </table>

          <div style="display:flex;gap:10px;margin-top:8px">
            <a href="${icsUrl}" style="background:#111827;color:#fff;text-decoration:none;padding:10px 14px;border-radius:8px;font-weight:600;display:inline-block">Add to Calendar</a>
            <a href="${detailsUrl}" style="background:#f3f4f6;color:#111827;text-decoration:none;padding:10px 14px;border-radius:8px;font-weight:600;display:inline-block">View Listing</a>
          </div>

          <p style="margin:20px 0 0 0;color:#6b7280;font-size:12px;line-height:1.55">
            Have questions? Reply to this email or contact us at
            <a href="mailto:${supportEmail}" style="color:#111827">${supportEmail}</a>.
          </p>
        </td>
      </tr>
      <tr>
        <td style="padding:16px 24px;background:#f9fafb;color:#6b7280;font-size:12px">
          ¬© ${new Date().getFullYear()} Manyagi Realty ‚Ä¢ All rights reserved.
        </td>
      </tr>
    </table>
  </div>
  `;
}


===== FILE: lib/printful.js  (size=876 bytes) =====
// lib/printful.js
import axios from 'axios';

const PRINTFUL_API = 'https://api.printful.com';

export async function createPrintfulOrder({
  externalId,            // e.g., Stripe session id
  recipient,             // { name, address1, city, state_code, country_code, zip, phone, email }
  items,                 // [{ sync_variant_id, quantity }]
  packingSlip = {},      // optional
}) {
  if (!process.env.PRINTFUL_API_KEY) {
    throw new Error('PRINTFUL_API_KEY is not set');
  }

  const headers = {
    Authorization: `Bearer ${process.env.PRINTFUL_API_KEY}`,
    'Content-Type': 'application/json',
  };

  const payload = {
    external_id: externalId,
    recipient,
    items,
    packing_slip: packingSlip,
  };

  const { data } = await axios.post(`${PRINTFUL_API}/orders`, payload, { headers });
  return data?.result || data;
}


===== FILE: lib/realtyHelpers.js  (size=1028 bytes) =====
// lib/realtyHelpers.js
import { supabaseAdmin } from './supabaseAdmin';

export async function isDateBlocked(propertyId, isoDate) {
  const { data: avail } = await supabaseAdmin.from('property_availability').select('status').eq('property_id', propertyId).eq('date', isoDate).maybeSingle();
  if (avail?.status === 'booked') return true;

  const { data: blocks } = await supabaseAdmin.from('realty_external_blocks').select('*').eq('property_id', propertyId);
  return (blocks || []).some(b => new Date(isoDate) >= new Date(b.starts_on) && new Date(isoDate) < new Date(b.ends_on));
}

export async function getRateForDate(propertyId, isoDate) {
  const { data: rates } = await supabaseAdmin.from('realty_rates').select('*').eq('property_id', propertyId).order('priority', { ascending: false });
  for (const r of rates || []) {
    if (new Date(isoDate) >= new Date(r.start_date) && new Date(isoDate) <= new Date(r.end_date)) {
      return r.nightly_rate;
    }
  }
  return null; // fallback to base price
}


===== FILE: lib/sendEmail.js  (size=771 bytes) =====
// lib/sendEmail.js
import nodemailer from 'nodemailer';

const {
  SMTP_HOST,
  SMTP_PORT,
  SMTP_USER,
  SMTP_PASS,
} = process.env;

export async function sendEmail({ to, subject, html }) {
  if (!SMTP_HOST || !SMTP_PORT || !SMTP_USER || !SMTP_PASS) {
    console.warn('SMTP not configured; skipping email send.');
    return { skipped: true };
  }

  const transporter = nodemailer.createTransport({
    host: SMTP_HOST,
    port: Number(SMTP_PORT),
    secure: Number(SMTP_PORT) === 465,
    auth: {
      user: SMTP_USER,
      pass: SMTP_PASS,
    },
  });

  const info = await transporter.sendMail({
    from: 'Manyagi Realty <realty@manyagi.net>',
    to,
    subject,
    html,
  });

  return { messageId: info.messageId };
}


===== FILE: lib/store.js  (size=197 bytes) =====
// lib/store.js
import { configureStore } from '@reduxjs/toolkit';
import cartReducer from './cartSlice';

export const store = configureStore({
  reducer: {
    cart: cartReducer,
  },
});


===== FILE: lib/studio/build-packet.js  (size=5011 bytes) =====
import archiver from "archiver";
import { PassThrough } from "stream";
import { finished } from "stream/promises";
import puppeteer from "puppeteer-core";
import chromium from "@sparticuz/chromium";
import { buildPagePdf } from "./build-pdf";

/**
 * buildPacketZip({ pages, tier, mode })
 * pages = array of studio_pages rows
 *
 * ‚úÖ FIX: resolve zip correctly (wait for readable "end")
 * ‚úÖ FIX: stable serverless chromium launch
 * ‚úÖ FIX: safer archiver drain + error handling
 *
 * ‚úÖ NEW FIX (empty buffer):
 * - DO NOT silently skip invalid PDFs
 * - Coerce pdf output to Buffer (Buffer | Uint8Array | ArrayBuffer | string)
 * - Throw with exact page filename + root error if PDF build fails
 * - Throw if zero PDFs were added (prevents empty ~22 byte zip)
 */

const isProd = process.env.NODE_ENV === "production";

function safeStr(v) {
  return String(v ?? "").trim();
}

function slugify(s) {
  return (
    safeStr(s)
      .toLowerCase()
      .replace(/[^a-z0-9-_]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "") || "page"
  );
}

async function resolveExecutablePath() {
  if (process.env.PUPPETEER_EXECUTABLE_PATH) return process.env.PUPPETEER_EXECUTABLE_PATH;
  try {
    const p = await chromium.executablePath();
    if (p) return p;
  } catch {}
  return undefined;
}

// ‚úÖ Coerce buildPagePdf return type into a Buffer (supports multiple return shapes safely)
function coerceToBuffer(pdfRaw) {
  if (!pdfRaw) return null;
  if (Buffer.isBuffer(pdfRaw)) return pdfRaw;
  if (pdfRaw instanceof Uint8Array) return Buffer.from(pdfRaw);
  if (pdfRaw instanceof ArrayBuffer) return Buffer.from(new Uint8Array(pdfRaw));
  if (typeof pdfRaw === "string") return Buffer.from(pdfRaw);
  return null;
}

export async function buildPacketZip({ pages = [], tier = "producer", mode = "full" } = {}) {
  const archive = archiver("zip", { zlib: { level: 9 } });

  // PassThrough is BOTH writable and readable; we read from it to collect bytes
  const stream = new PassThrough();
  const chunks = [];

  // Collect output
  stream.on("data", (d) => chunks.push(d));

  // Pipe archive -> stream
  archive.pipe(stream);

  // Warnings should not crash
  archive.on("warning", (err) => {
    console.warn("zip warning:", err?.message || err);
  });

  // Hard errors must reject
  const errorPromise = new Promise((_, reject) => {
    archive.on("error", reject);
    stream.on("error", reject);
  });

  // ‚úÖ IMPORTANT: Wait until the readable side ENDS (not "finish")
  // finished(stream) resolves on 'end'/'close' for readable streams.
  const drainPromise = finished(stream);

  const executablePath = await resolveExecutablePath();

  if (!isProd && !executablePath && !process.env.PUPPETEER_EXECUTABLE_PATH) {
    throw new Error(
      "Local PDF build requires Chrome. Set PUPPETEER_EXECUTABLE_PATH to your Chrome/Chromium executable."
    );
  }

  const browser = await puppeteer.launch({
    args: chromium.args,
    executablePath,
    headless: isProd ? chromium.headless : true,
    defaultViewport: chromium.defaultViewport, // ‚úÖ important on serverless
    ignoreHTTPSErrors: true,
  });

  let added = 0;

  try {
    for (let i = 0; i < pages.length; i++) {
      const page = pages[i];

      const pageType = slugify(page?.page_type || `page-${i + 1}`);
      const titlePart = slugify(page?.title || "");
      const name = `${String(i + 1).padStart(2, "0")}-${pageType}${titlePart ? `-${titlePart}` : ""}.pdf`;

      const watermark = mode === "preview" ? "PREVIEW ‚Äî MANYAGI STUDIOS" : "CONFIDENTIAL ‚Äî MANYAGI STUDIOS";

      let pdfRaw;
      try {
        // buildPagePdf should return something convertible to Buffer
        pdfRaw = await buildPagePdf(page, {
          watermark,
          browser,
          fast: true,
        });
      } catch (e) {
        // ‚úÖ DO NOT silently skip ‚Äî throw exact failing page name so you know what broke
        throw new Error(`buildPagePdf failed for "${name}": ${e?.message || e}`);
      }

      const pdf = coerceToBuffer(pdfRaw);

      // ‚úÖ If empty/invalid, fail loudly (this is what was producing "empty buffer")
      if (!pdf || pdf.length < 100) {
        throw new Error(`buildPagePdf returned empty/invalid PDF for "${name}" (bytes=${pdf?.length ?? 0})`);
      }

      archive.append(pdf, { name });
      added++;
    }

    // Finalize zip creation
    archive.finalize();

    // ‚úÖ Wait for either an error or full drain
    await Promise.race([Promise.all([drainPromise]), errorPromise]);

    const out = Buffer.concat(chunks);

    // ‚úÖ If we added nothing, this prevents "empty zip" situations from passing through
    if (added === 0) {
      throw new Error("No PDFs were added to the zip (all PDF builds failed).");
    }

    return out;
  } finally {
    try {
      await browser.close();
    } catch {}
  }
}


===== FILE: lib/studio/build-pdf.js  (size=4554 bytes) =====
import puppeteer from "puppeteer-core";
import chromium from "@sparticuz/chromium";
import { marked } from "marked";

/**
 * buildPagePdf(page, { watermark, html, browser, fast })
 *
 * ‚úÖ Backward compatible:
 * - If options.browser is NOT provided: launches + closes its own browser (original behavior)
 * - If options.browser IS provided: reuses it (used by build-packet.js for perf)
 *
 * ‚úÖ Fix: prevent packet hangs
 * - default waitUntil: "domcontentloaded" (networkidle0 can hang)
 * - optional fast mode blocks images/fonts/media
 * - adds hard timeouts so a page can‚Äôt stall the packet
 */

const isProd = process.env.NODE_ENV === "production";

function safeStr(v) {
  return String(v ?? "").trim();
}

function safeJson(v, fallback = {}) {
  try {
    if (!v) return fallback;
    if (typeof v === "object") return v;
    const parsed = JSON.parse(String(v));
    return parsed && typeof parsed === "object" ? parsed : fallback;
  } catch {
    return fallback;
  }
}

function getStudioBodyHtml(page) {
  const md = safeJson(page?.metadata, {});

  const raw =
    safeStr(page?.content_html) ||
    safeStr(page?.html) ||
    safeStr(page?.content_md) ||
    safeStr(md?.content || md?.body || md?.markdown) ||
    safeStr(page?.content) ||
    "";

  const looksLikeHtml =
    raw.includes("<p") ||
    raw.includes("<div") ||
    raw.includes("<h1") ||
    raw.includes("<h2") ||
    raw.includes("<br") ||
    raw.includes("<ul") ||
    raw.includes("<ol") ||
    raw.includes("<li");

  return looksLikeHtml ? raw : marked.parse(raw);
}

function buildHtmlFromStudioPage(page, watermark = "") {
  const title = safeStr(page?.title || page?.page_type || "Studio Page");
  const bodyHtml = getStudioBodyHtml(page);
  const wm = safeStr(watermark);

  return `<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>${title}</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 32px; }
      .watermark {
        position: fixed;
        bottom: 18px;
        right: 24px;
        opacity: 0.15;
        font-size: 12px;
        letter-spacing: 2px;
        text-transform: uppercase;
        pointer-events: none;
      }
      h1 { margin: 0 0 16px; font-size: 24px; }
      p { line-height: 1.6; margin: 0 0 10px; }
      ul { margin: 10px 0 10px 20px; }
      ol { margin: 10px 0 10px 20px; }
      li { margin: 6px 0; }
      pre { white-space: pre-wrap; }
      code { white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <h1>${title}</h1>
    <div>${bodyHtml}</div>
    ${wm ? `<div class="watermark">${wm}</div>` : ""}
  </body>
</html>`;
}

async function resolveExecutablePath() {
  if (process.env.PUPPETEER_EXECUTABLE_PATH) return process.env.PUPPETEER_EXECUTABLE_PATH;

  try {
    const p = await chromium.executablePath();
    if (p) return p;
  } catch {
    // ignore
  }

  return undefined;
}

export async function buildPagePdf(page, options = {}) {
  const watermark = safeStr(options?.watermark || "");
  const html = options?.html || buildHtmlFromStudioPage(page, watermark);

  const externalBrowser = options?.browser || null;
  const fast = !!options?.fast;

  let browser = externalBrowser;
  let ownsBrowser = false;

  if (!browser) {
    const executablePath = await resolveExecutablePath();
    browser = await puppeteer.launch({
      args: chromium.args,
      executablePath,
      headless: isProd ? chromium.headless : true,
    });
    ownsBrowser = true;
  }

  try {
    const p = await browser.newPage();

    // ‚úÖ prevents ‚Äúpending forever‚Äù
    p.setDefaultTimeout(20000);
    p.setDefaultNavigationTimeout(20000);

    if (fast) {
      await p.setRequestInterception(true);
      p.on("request", (req) => {
        const rt = req.resourceType();
        if (rt === "image" || rt === "font" || rt === "media") return req.abort();
        return req.continue();
      });
    }

    await p.setViewport({ width: 1200, height: 800, deviceScaleFactor: 1 });

    // ‚úÖ critical fix: avoid networkidle0 hangs
    await p.setContent(html, { waitUntil: "domcontentloaded" });

    const pdfBuffer = await p.pdf({
      format: "Letter",
      printBackground: true,
      margin: { top: "20mm", right: "15mm", bottom: "20mm", left: "15mm" },
    });

    await p.close();
    return pdfBuffer;
  } finally {
    if (ownsBrowser && browser) {
      await browser.close();
    }
  }
}


===== FILE: lib/supabase.js  (size=316 bytes) =====
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

// Client-side Supabase (safe for pages/, components, etc.)
export const supabase = createClient(supabaseUrl, supabaseAnonKey);


===== FILE: lib/supabaseAdmin.js  (size=431 bytes) =====
// lib/supabaseAdmin.js
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
// IMPORTANT: Server-only. Do not import this from client components/pages.
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
  auth: { autoRefreshToken: false, persistSession: false },
});


===== FILE: next-env.d.ts  (size=230 bytes) =====
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/pages/building-your-application/configuring/typescript for more information.


===== FILE: next-sitemap.config.js  (size=847 bytes) =====
/** @type {import('next-sitemap').IConfig} */
const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://manyagi.net';

module.exports = {
  siteUrl: SITE_URL,
  generateRobotsTxt: true,
  sitemapSize: 7000,
  changefreq: 'daily',
  priority: 0.7,
  exclude: ['/server-sitemap.xml'], // keep if you later attach a server sitemap
  robotsTxtOptions: {
    policies: [{ userAgent: '*', allow: '/' }],
    additionalSitemaps: [
      `${SITE_URL}/sitemap.xml`,
    ],
  },
  transform: async (config, path) => {
    // Set higher priority for home + divisions
    const hi = ['/', '/publishing', '/designs', '/media', '/capital', '/tech', '/realty', '/blog'];
    return {
      loc: path,
      changefreq: 'daily',
      priority: hi.includes(path) ? 0.9 : 0.7,
      lastmod: new Date().toISOString(),
    };
  },
};


===== FILE: next.config.js  (size=5676 bytes) =====
// next.config.js
const withTM = require('next-transpile-modules')(['gsap']);
const withMDX = require('@next/mdx')({
  extension: /\.mdx?$/,
  options: { remarkPlugins: [], rehypePlugins: [] },
});

/** @type {import('next').NextConfig} */
const nextConfig = withTM({
  pageExtensions: ['js', 'jsx', 'mdx', 'ts', 'tsx'],
  reactStrictMode: true,

  images: {
    remotePatterns: [
      { protocol: 'https', hostname: 'manyagi.net', pathname: '/**' },
      { protocol: 'https', hostname: 'images.unsplash.com', pathname: '/**' },
      { protocol: 'https', hostname: 'myfxbook.com', pathname: '/**' },
      { protocol: 'https', hostname: 'youtube.com', pathname: '/**' },
      { protocol: 'https', hostname: 'i.ytimg.com', pathname: '/**' },
      { protocol: 'https', hostname: 'img.youtube.com', pathname: '/**' },
      { protocol: 'https', hostname: 'dlbbjeohndiwtofitwec.supabase.co', pathname: '/**' },
      // Printful CDNs (mockups)
      { protocol: 'https', hostname: 'files.cdn.printful.com', pathname: '/**' },
      { protocol: 'https', hostname: 'img.printful.com', pathname: '/**' },
      // keep for scripts if you ever use next/image with external script assets
      { protocol: 'https', hostname: 'js.stripe.com', pathname: '/**' },
      // maps tiles / static maps (optional future)
      { protocol: 'https', hostname: 'maps.googleapis.com', pathname: '/**' },
      { protocol: 'https', hostname: 'maps.gstatic.com', pathname: '/**' },
      { protocol: 'https', hostname: 'www.gstatic.com', pathname: '/**' },
      { protocol: 'https', hostname: 'www.google.com', pathname: '/**' },
      { protocol: 'https', hostname: 'maps.google.com', pathname: '/**' },
    ],
    formats: ['image/avif', 'image/webp'],
    minimumCacheTTL: 60,
  },

  async headers() {
    // CSP tuned for:
    // - Stripe checkout
    // - Google Maps iframe + tiles
    // - Google Tag Manager
    // - Supabase storage + realtime
    // - Printful mockup images
    // - Twitter embeds / YouTube iframes
    //
    // NOTE: 'unsafe-eval' + 'unsafe-inline' are currently allowed because:
    // - Next dev / HMR
    // - Inline GTM snippet
    // We can tighten later with nonces/hashes.
    const csp = [
      // default fallback
      "default-src 'self'",
      // scripts we allow to run
      "script-src 'self' 'unsafe-eval' 'unsafe-inline' blob: data: https://www.googletagmanager.com https://www.google-analytics.com https://platform.twitter.com https://f.convertkit.com https://js.stripe.com https://maps.googleapis.com https://www.gstatic.com https://www.google.com",
      // inline styles + Google Fonts CSS
      "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
      // images (product thumbs, user uploads, YT thumbs, map tiles, etc)
      [
        "img-src 'self' data: blob:",
        "https://manyagi.net",
        "https://images.unsplash.com",
        "https://myfxbook.com",
        "https://youtube.com",
        "https://i.ytimg.com",
        "https://img.youtube.com",
        "https://syndication.twitter.com",
        "https://dlbbjeohndiwtofitwec.supabase.co",
        "https://files.cdn.printful.com",
        "https://img.printful.com",
        "https://maps.googleapis.com",
        "https://maps.gstatic.com",
        "https://www.gstatic.com",
        "https://www.google.com",
        "https://maps.google.com",
        "https://*.ggpht.com",
        "https://*.googleusercontent.com",
      ].join(' '),
      // audio/video blobs from Supabase, etc.
      "media-src 'self' data: blob: https://dlbbjeohndiwtofitwec.supabase.co",
      // XHR / fetch / websockets
      [
        "connect-src 'self'",
        "https://api.stripe.com",
        "https://api.telegram.org",
        "https://api.formspree.io",
        "https://app.convertkit.com",
        "https://www.google-analytics.com",
        "https://dlbbjeohndiwtofitwec.supabase.co",
        "wss://dlbbjeohndiwtofitwec.supabase.co",
        "https://files.cdn.printful.com",
        "https://img.printful.com",
        "https://maps.googleapis.com",
        "https://www.gstatic.com",
        "https://www.google.com",
        "https://maps.google.com",
      ].join(' '),
      // iframes we embed
      [
        "frame-src 'self'",
        "https://www.youtube.com",
        "https://www.youtube-nocookie.com",
        "https://platform.twitter.com",
        "https://syndication.twitter.com",
        "https://js.stripe.com",
        "https://hooks.stripe.com",
        "https://maps.google.com",
        "https://www.google.com",
      ].join(' '),
      // fonts
      "font-src 'self' data: https://fonts.gstatic.com",
    ].join('; ');

    return [
      {
        source: '/:path*',
        headers: [
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'Strict-Transport-Security', value: 'max-age=31536000; includeSubDomains' },
          { key: 'Content-Security-Policy', value: csp },
        ],
      },
    ];
  },

  experimental: {
    esmExternals: 'loose',
    optimizePackageImports: ['gsap', 'framer-motion'],
  },

  compress: true,

  async rewrites() {
    return [{ source: '/sitemap.xml', destination: '/sitemap.xml' }];
  },

  env: {
    NEXT_PUBLIC_SITE_URL: process.env.NEXTAUTH_URL || 'https://manyagi.net',
    SITE_URL: process.env.NEXTAUTH_URL || 'https://manyagi.net',
  },
});

module.exports = withMDX(nextConfig);


===== FILE: package.json  (size=1678 bytes) =====
{
  "name": "manyagi-site",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "postbuild": "next-sitemap"
  },
  "dependencies": {
    "@formspree/react": "^3.0.0",
    "@mdx-js/loader": "^3.0.1",
    "@mdx-js/react": "^3.0.1",
    "@netlify/plugin-nextjs": "^5.13.3",
    "@next/mdx": "^14.2.5",
    "@reduxjs/toolkit": "^2.2.8",
    "@sparticuz/chromium": "^143.0.0",
    "@stripe/react-stripe-js": "^2.7.3",
    "@stripe/stripe-js": "^4.10.0",
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/supabase-js": "^2.45.4",
    "archiver": "^7.0.1",
    "axios": "^1.12.2",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "framer-motion": "^11.11.9",
    "gray-matter": "^4.0.3",
    "gsap": "^3.12.5",
    "marked": "^17.0.1",
    "micro": "^10.0.1",
    "next": "^14.2.15",
    "next-mdx-remote": "^4.4.1",
    "next-sitemap": "^4.2.3",
    "next-themes": "^0.4.6",
    "next-transpile-modules": "^10.0.1",
    "node-fetch": "^3.3.2",
    "node-ical": "^0.22.0",
    "nodemailer": "^7.0.10",
    "posthog-js": "^1.268.8",
    "puppeteer": "^24.34.0",
    "puppeteer-core": "^24.34.0",
    "react": "^18.3.1",
    "react-big-calendar": "^1.19.4",
    "react-dom": "^18.3.1",
    "react-icons": "^5.3.0",
    "react-redux": "^9.2.0",
    "react-responsive-carousel": "^3.2.23",
    "react-scroll-parallax": "^3.4.5",
    "recharts": "^3.3.0",
    "redux": "^5.0.1",
    "stripe": "^16.12.0"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.47",
    "tailwindcss": "^3.4.14",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "5.9.2"
  }
}


===== FILE: pages/404.js  (size=3907 bytes) =====
// pages/404.js
import Link from 'next/link';
import Head from 'next/head';
import { motion } from 'framer-motion';
import Recommender from '../components/Recommender';

export default function Custom404() {
  return (
    <>
      <Head>
        <title>Portal Not Found ‚Äî Manyagi</title>
        <meta
          name="description"
          content="This realm doesn‚Äôt exist ‚Äî but your journey continues. Discover Publishing, Designs, Capital, Tech, Media, and Realty."
        />
        <meta name="robots" content="noindex,follow" />
      </Head>

      <section className="relative overflow-hidden">
        {/* Background aura */}
        <div className="absolute inset-0 -z-10 bg-gradient-to-br from-black via-gray-900 to-black" />
        <div className="absolute inset-0 -z-10 opacity-20 pointer-events-none"
             style={{
               backgroundImage:
                 'radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0) 70%)',
             }}
        />

        <div className="container mx-auto px-4 py-24 text-white text-center">
          <motion.h1
            initial={{ opacity: 0, y: -12 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5 }}
            className="text-5xl md:text-6xl font-extrabold tracking-tight"
          >
            Portal Not Found
          </motion.h1>

          <motion.p
            initial={{ opacity: 0, y: 6 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.15, duration: 0.5 }}
            className="mt-4 text-gray-300 max-w-2xl mx-auto"
          >
            Looks like this realm doesn‚Äôt exist ‚Äî but your journey continues.
            Choose a gateway below and step back into the Manyagi universe.
          </motion.p>

          {/* Primary actions */}
          <motion.div
            initial={{ opacity: 0, y: 6 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.25, duration: 0.5 }}
            className="mt-8 flex flex-wrap justify-center gap-3"
          >
            <Link href="/" className="btn bg-yellow-500 text-black px-5 py-2 rounded-lg hover:bg-yellow-400 transition">
              Return to HQ
            </Link>
            <Link href="/publishing" className="btn bg-white text-black px-5 py-2 rounded-lg hover:bg-gray-200 transition">
              Explore Publishing
            </Link>
            <Link href="/designs" className="btn bg-white/10 text-white px-5 py-2 rounded-lg hover:bg-white/20 transition border border-white/20">
              Shop Designs
            </Link>
          </motion.div>

          {/* Helpful discovery (turns 404 into a conversion moment) */}
          <div className="mt-14 bg-white text-black rounded-xl shadow-lg p-6 dark:bg-gray-900 dark:text-white">
            <h2 className="text-2xl font-bold mb-3">Recommended for you</h2>
            <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">
              Popular picks across our divisions.
            </p>
            <Recommender />
          </div>

          {/* Quick deep links */}
          <div className="mt-10 grid grid-cols-2 md:grid-cols-3 gap-3 text-sm text-gray-300">
            <Link href="/media" className="hover:text-yellow-400 transition">Media</Link>
            <Link href="/capital" className="hover:text-yellow-400 transition">Capital</Link>
            <Link href="/tech" className="hover:text-yellow-400 transition">Tech</Link>
            <Link href="/realty" className="hover:text-yellow-400 transition">Realty</Link>
            <Link href="/blog" className="hover:text-yellow-400 transition">Blog</Link>
            <Link href="/about" className="hover:text-yellow-400 transition">About</Link>
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/500.js  (size=2722 bytes) =====
// pages/500.js
import Link from 'next/link';
import Head from 'next/head';
import Recommender from '../components/Recommender';

export default function Custom500() {
  return (
    <>
      <Head>
        <title>System Interruption ‚Äî Manyagi</title>
        <meta
          name="description"
          content="Something went wrong within the Manyagi network. Our engineers are restoring balance."
        />
        <meta name="robots" content="noindex,follow" />
      </Head>

      <section className="relative overflow-hidden">
        {/* Deep crimson background for urgency */}
        <div className="absolute inset-0 -z-10 bg-gradient-to-br from-red-950 via-black to-black" />
        <div className="container mx-auto px-4 py-24 text-white text-center">
          <h1 className="text-5xl md:text-6xl font-extrabold tracking-tight">
            System Interruption
          </h1>
          <p className="mt-4 text-gray-300 max-w-2xl mx-auto">
            Something went wrong within the Manyagi network. Our engineers are restoring balance.
          </p>

          <div className="mt-8 flex flex-wrap justify-center gap-3">
            <Link href="/" className="btn bg-yellow-500 text-black px-5 py-2 rounded-lg hover:bg-yellow-400 transition">
              Return to HQ
            </Link>
            <Link href="/status" className="btn bg-white text-black px-5 py-2 rounded-lg hover:bg-gray-200 transition">
              System Status
            </Link>
          </div>

          {/* Give users somewhere valuable to go */}
          <div className="mt-14 bg-white text-black rounded-xl shadow-lg p-6 dark:bg-gray-900 dark:text-white">
            <h2 className="text-2xl font-bold mb-3">Explore while we fix things</h2>
            <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">
              Here are some popular picks across our divisions.
            </p>
            <Recommender />
          </div>

          <div className="mt-10 grid grid-cols-2 md:grid-cols-3 gap-3 text-sm text-gray-300">
            <Link href="/publishing" className="hover:text-yellow-400 transition">Publishing</Link>
            <Link href="/designs" className="hover:text-yellow-400 transition">Designs</Link>
            <Link href="/media" className="hover:text-yellow-400 transition">Media</Link>
            <Link href="/capital" className="hover:text-yellow-400 transition">Capital</Link>
            <Link href="/tech" className="hover:text-yellow-400 transition">Tech</Link>
            <Link href="/realty" className="hover:text-yellow-400 transition">Realty</Link>
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/_app.js  (size=3452 bytes) =====
// pages/_app.js
import '@/styles/globals.css';
import { Provider } from 'react-redux';
import { store } from '../lib/store';
import Header from '../components/Header';
import Footer from '../components/Footer';
import ErrorBoundary from '../components/ErrorBoundary';
import { useEffect } from 'react';
import { useRouter } from 'next/router';
import Script from 'next/script';
import Head from 'next/head';
import { ThemeProvider } from 'next-themes';
import SEO from '@/components/SEO';

// üî• NEW: track affiliate codes from URL (?ref=ABC)
import { rememberAffiliateFromURL } from '@/lib/affiliate';

const GA_ID = process.env.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID || '';

function MyApp({ Component, pageProps }) {
  const router = useRouter();

  // üî• NEW: capture & persist affiliate referral code from URL (once per mount / nav)
  useEffect(() => {
    rememberAffiliateFromURL();
  }, []);

  // Persist cart between refreshes
  useEffect(() => {
    const unsubscribe = store.subscribe(() => {
      try {
        localStorage.setItem(
          'cart',
          JSON.stringify(store.getState().cart.items || [])
        );
      } catch {
        /* ignore */
      }
    });

    try {
      const saved = localStorage.getItem('cart');
      if (saved)
        store.dispatch({
          type: 'cart/setItems',
          payload: JSON.parse(saved),
        });
    } catch {
      /* ignore */
    }

    return unsubscribe;
  }, []);

  // Google Analytics: track route changes
  useEffect(() => {
    if (!GA_ID) return;
    const handleRouteChange = (url) => {
      if (
        typeof window !== 'undefined' &&
        typeof window.gtag === 'function'
      ) {
        window.gtag('config', GA_ID, { page_path: url });
      }
    };
    router.events.on('routeChangeComplete', handleRouteChange);
    return () =>
      router.events.off('routeChangeComplete', handleRouteChange);
  }, [router.events]);

  return (
    <Provider store={store}>
      <ErrorBoundary>
        <Head>
          {/* Viewport + icons */}
          <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
          />
          <link rel="icon" href="/favicon.ico" />
        </Head>

        {GA_ID ? (
          <>
            <Script
              strategy="afterInteractive"
              src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}
            />
            <Script id="ga-init" strategy="afterInteractive">
              {`
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', '${GA_ID}');
              `}
            </Script>
          </>
        ) : null}

        <ThemeProvider attribute="class" defaultTheme="light">
          {/* Global SEO defaults; pages can override with their own <SEO .../> */}
          <SEO />

          <div className="min-h-screen gradient-bg dark:bg-gray-900 transition-colors">
            <Header />
            <main className="container mx-auto px-4 py-8 min-h-screen bg-white text-black gradient-bg">
              <Component {...pageProps} />
            </main>
            <Footer />
          </div>
        </ThemeProvider>
      </ErrorBoundary>
    </Provider>
  );
}

export default MyApp;


===== FILE: pages/_document.js  (size=3860 bytes) =====
// pages/_document.js
import { Html, Head, Main, NextScript } from 'next/document';

const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://manyagi.net';

export default function Document() {
  // Detect build environment at render time on server
  const isProd = process.env.NODE_ENV === 'production';

  // In dev: go loose so Next.js HMR, inline scripts, eval, etc. work
  const devCsp = `
    default-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* blob: data:;
    img-src 'self' blob: data: https:;
    font-src 'self' data: https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://js.stripe.com https://maps.googleapis.com https://www.gstatic.com https://www.google.com;
    connect-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* https: http: wss: blob:;
    frame-src 'self' https://js.stripe.com https://www.youtube.com https://www.youtube-nocookie.com https://maps.google.com https://www.google.com;
    media-src 'self' blob: data: https:;
    object-src 'none';
    base-uri 'self';
    form-action 'self' https://js.stripe.com;
  `;

  // In prod: tighter, but still allow Stripe checkout + Google Maps iframe + YouTube embeds
  const prodCsp = `
    default-src 'self';
    img-src 'self' data: blob: https:;
    font-src 'self' data: https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    script-src
      'self'
      'unsafe-inline'
      'unsafe-eval'
      blob:
      https://js.stripe.com
      https://www.gstatic.com
      https://maps.googleapis.com
      https://www.google.com;
    connect-src
      'self'
      https:
      wss:;
    frame-src
      'self'
      https://www.youtube.com
      https://www.youtube-nocookie.com
      https://js.stripe.com
      https://maps.google.com
      https://www.google.com;
    media-src 'self' blob: data: https:;
    object-src 'none';
    base-uri 'self';
    form-action 'self' https://js.stripe.com;
  `;

  const cspToUse = isProd ? prodCsp : devCsp;

  return (
    <Html lang="en">
      <Head>
        {/* Content Security Policy */}
        <meta httpEquiv="Content-Security-Policy" content={cspToUse} />

        {/* Fonts */}
        <link
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Georgia&display=swap"
          rel="stylesheet"
        />

        {/* Global org JSON-LD */}
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify({
              '@context': 'https://schema.org',
              '@type': 'Organization',
              name: 'Manyagi',
              url: SITE_URL,
              description:
                'Manyagi unites Publishing, Designs, Capital, Tech, Media, and Realty under one HQ.',
              logo: `${SITE_URL}/images/logo.png`,
              sameAs: [
                'https://instagram.com/manyagi.official',
                'https://tiktok.com/@manyagi.official',
                'https://youtube.com/@ManyagiOfficial',
                'https://x.com/ManyagiOfficial',
                'https://linkedin.com/company/manyagi',
                'https://pinterest.com/ManyagiOfficial',
              ],
              contactPoint: {
                '@type': 'ContactPoint',
                email: 'support@manyagi.net',
                contactType: 'customer support',
                availableLanguage: 'en',
              },
            }),
          }}
        />
      </Head>
      <body className="bg-white text-black">
        <Main />
        <NextScript />
      </body>
    </Html>
  );
}


===== FILE: pages/about.js  (size=9121 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import { useEffect } from 'react'; // ‚úÖ ADDED
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import SectionIntro from '../components/SectionIntro';
import Card from '../components/Card';
import { supabase } from '../lib/supabase'; // ‚úÖ ADDED

export default function About() {
  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-about.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/team-photo.webp',
  ];

  // ‚úÖ REWARD: first visit to About page
  useEffect(() => {
    (async () => {
      try {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        const userId = session?.user?.id;
        if (!userId) return;

        await fetch('/api/rewards/grant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            action: 'visit_about_first_time',
          }),
        });
      } catch (err) {
        console.error('[About] visit_about_first_time reward error', err);
      }
    })();
  }, []);

  return (
    <>
      <Head>
        <title>About Manyagi ‚Äî A Modern Creative & Capital Group</title>
        <meta
          name="description"
          content="Manyagi LLC is a multi-division creative, media, capital, and technology group building stories, products, and platforms designed to scale globally."
        />
      </Head>

      {/* HERO */}
      <Hero
        kicker="About Manyagi"
        title="A Modern Creative & Capital Conglomerate."
        lead="Manyagi unites publishing, design, media, capital, tech, and realty into one connected ecosystem designed for long-term IP, cash flow, and global scale."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#divisions"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-sm font-semibold"
        >
          Explore Our Divisions
        </Link>
      </Hero>

      {/* BRAND OVERVIEW */}
      <SectionIntro
        id="story"
        kicker="A Unified Vision"
        title="Who We Are"
        lead="Manyagi LLC is a creator-led, systems-driven company focused on turning ideas into durable intellectual property, products, and platforms."
        tone="neutral"
        align="center"
      >
        <p className="text-sm md:text-base mt-3 max-w-3xl mx-auto">
          We operate like a modern studio and holding company in one. Under the Manyagi umbrella, we build
          stories, brands, financial engines, and digital infrastructure that work together instead of
          competing for attention. From novels and apparel to media channels, software, and capital strategies,
          every division is designed to feed the rest of the ecosystem and compound over time.
        </p>
      </SectionIntro>

      {/* DIVISION OVERVIEW GRID */}
      <SectionIntro
        id="divisions"
        kicker="A Manyagi Company"
        title="Our Divisions"
        lead="Each division is a standalone brand with a shared backbone: world-class storytelling, clean design, smart systems, and disciplined capital."
        tone="card"
        align="center"
      />

      <section className="container mx-auto px-4 pb-16">
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">

          <Card
            title="Publishing"
            description="Original IP across fiction, poetry, and worlds designed for adaptation into books, film, animation, games, and long-term franchises."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-1.webp"
            category="publishing"
          >
            <p className="text-xs text-gray-500 font-mono">publishing@manyagi.net</p>
          </Card>

          <Card
            title="Designs"
            description="Apparel, posters, collectibles, and brand systems that let people wear the worlds, symbols, and stories that define the Manyagi Universe."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-1.webp"
            category="designs"
          >
            <p className="text-xs text-gray-500 font-mono">designs@manyagi.net</p>
          </Card>

          <Card
            title="Tech"
            description="Websites, apps, automation, and internal tools that power our brands, storefronts, communities, and future platforms."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-1.webp"
            category="tech"
          >
            <p className="text-xs text-gray-500 font-mono">tech@manyagi.net</p>
          </Card>

          <Card
            title="Media"
            description="Faceless and branded channels, shorts, series, and documentaries that show the process, promote the IP, and build the audience in public."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-4.webp"
            category="media"
          >
            <p className="text-xs text-gray-500 font-mono">media@manyagi.net</p>
          </Card>

          <Card
            title="Capital"
            description="A disciplined capital desk focused on long-term investing, income streams, and frameworks for creators and builders to grow real wealth."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/site/general/2025/11/6R5CJc-blackkungfu_stock_market_thumbnail_-v_7_fed2b20f-2a5b-451e-9c24-c790004e0a43_2.png"
            category="capital"
          >
            <p className="text-xs text-gray-500 font-mono">capital@manyagi.net</p>
          </Card>

          <Card
            title="Realty"
            description="Real estate concepts and future physical spaces that extend the Manyagi brand into the offline world through stays, sets, and experiences."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-realty.webp"
            category="realty"
          >
            <p className="text-xs text-gray-500 font-mono">realty@manyagi.net</p>
          </Card>
        </div>
      </section>

      {/* BRAND VALUES */}
      <SectionIntro
        id="values"
        kicker="Our Operating System"
        title="What We Stand For"
        lead="These principles are baked into every story, product, partnership, and investment decision we make."
        tone="neutral"
        align="center"
      />

      <section className="container mx-auto px-4 pb-20">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto text-sm md:text-base">
          <div className="rounded-3xl border bg-white/90 dark:bg-gray-950/90 p-5 shadow-sm text-center">
            <h3 className="font-semibold mb-2">Craft & Clarity</h3>
            <p>We obsess over the details but ship with intention, making things that feel sharp, timeless, and easy to understand.</p>
          </div>

          <div className="rounded-3xl border bg-white/90 dark:bg-gray-950/90 p-5 shadow-sm text-center">
            <h3 className="font-semibold mb-2">Systems & Scale</h3>
            <p>We design brands, products, and workflows to compound over years, not weeks ‚Äî with automation and leverage built in.</p>
          </div>

          <div className="rounded-3xl border bg-white/90 dark:bg-gray-950/90 p-5 shadow-sm text-center">
            <h3 className="font-semibold mb-2">Ownership & Community</h3>
            <p>We believe creators should own their worlds, and audiences should feel like they‚Äôre part of something bigger than a single product.</p>
          </div>
        </div>
      </section>

      {/* CONTACT CTA */}
      <SectionIntro
        id="contact"
        kicker="Partnerships, Publishing & Beyond"
        title="Connect with the Manyagi Team"
        lead="Whether you‚Äôre a reader, investor, creator, or collaborator, we‚Äôd love to explore what we can build together."
        tone="card"
        align="center"
        maxWidth="max-w-2xl"
      >
        <p className="text-xs text-gray-500 font-mono">info@manyagi.net</p>
      </SectionIntro>

      {/* NEWSLETTER */}
      <section id="subscribe" className="container mx-auto px-4 pt-4 pb-16">
        <SubscriptionForm
          formId="8427853"
          uid="637df68a06"
          title="Stay Connected"
          description="Get launches, behind-the-scenes building, and cross-division updates from the Manyagi ecosystem."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/admin.js  (size=9616 bytes) =====
// pages/admin.js
import React, { useEffect, useState, useCallback } from 'react';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';

import OverviewTab from '@/components/admin/OverviewTab';
import PublishingTab from '@/components/admin/PublishingTab';
import DesignsTab from '@/components/admin/DesignsTab';
import CapitalTab from '@/components/admin/CapitalTab';
import TechTab from '@/components/admin/TechTab';
import MediaTab from '@/components/admin/MediaTab';
import RealtyTab from '@/components/admin/RealtyTab';
import AssetsTab from '@/components/admin/AssetsTab';
import BlogTab from '@/components/admin/BlogTab';
import AffiliatesTab from '@/components/admin/AffiliatesTab';
import BundlesTab from '@/components/admin/BundlesTab';
import UsersTab from '@/components/admin/UsersTab';
import AnalyticsTab from '@/components/admin/AnalyticsTab';
import EventsTab from '@/components/admin/EventsTab';

// NEW
import UniversesTab from '@/components/admin/UniversesTab';

// ‚úÖ NEW: Studio Pages tab
import StudioPagesTab from '@/components/admin/StudioPagesTab';

// arrivals / upcoming stays dashboard
import UpcomingStaysPanel from '@/components/admin/UpcomingStaysPanel';

// little pill button for the tab nav
const TabButton = ({ active, onClick, children }) => (
  <button
    onClick={onClick}
    className={`px-3 py-2 rounded text-sm font-medium transition ${
      active
        ? 'bg-blue-500 text-white'
        : 'bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-200'
    }`}
  >
    {children}
  </button>
);

export default function Admin() {
  const router = useRouter();

  // auth state
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);

  // dashboard data
  const [products, setProducts] = useState([]);
  const [orders, setOrders] = useState([]);
  const [subscriptions, setSubscriptions] = useState([]);
  const [assets, setAssets] = useState([]);
  const [siteConfig, setSiteConfig] = useState({});
  const [users, setUsers] = useState([]);
  const [properties, setProperties] = useState([]);
  const [affiliates, setAffiliates] = useState([]);
  const [bundles, setBundles] = useState([]);
  const [events, setEvents] = useState([]);
  const [posts, setPosts] = useState([]);

  // reservations from realty_reservations for revenue/ops/affiliates
  const [reservations, setReservations] = useState([]);

  // leads from realty_leads (buy/sell/manage inquiries)
  const [realtyLeads, setRealtyLeads] = useState([]);

  // ui state
  const [loading, setLoading] = useState(true);

  // default active tab
  const [activeTab, setActiveTab] = useState('overview');

  // fetch everything for dashboard
  const refreshAll = useCallback(async () => {
    const [
      p,
      o,
      s,
      a,
      c,
      b,
      u,
      prop,
      aff,
      bund,
      ev,
      rr,   // realty_reservations
      leads // realty_leads
    ] = await Promise.all([
      supabase
        .from('products')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('orders')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('subscriptions')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('assets')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase.from('site_config').select('*'),

      supabase
        .from('posts')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('users')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('properties')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('affiliates')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('bundles')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('events')
        .select('*')
        .order('created_at', { ascending: false }),

      // grab reservations so we can display arrivals/revenue and feed affiliates
      supabase
        .from('realty_reservations')
        .select('*')
        .order('created_at', { ascending: false }),

      // grab brokerage / mgmt / seller / buyer leads
      supabase
        .from('realty_leads')
        .select('*')
        .order('created_at', { ascending: false }),
    ]);

    setProducts(p.data || []);
    setOrders(o.data || []);
    setSubscriptions(s.data || []);
    setAssets(a.data || []);
    setSiteConfig(
      (c.data || []).reduce(
        (acc, item) => ({ ...acc, [item.key]: item.value }),
        {}
      )
    );
    setPosts(b.data || []);
    setUsers(u.data || []);
    setProperties(prop.data || []);
    setAffiliates(aff.data || []);
    setBundles(bund.data || []);
    setEvents(ev.data || []);

    setReservations(rr.data || []);
    setRealtyLeads(leads.data || []);
  }, []);

  // bootstrap auth + data
  useEffect(() => {
    (async () => {
      // check session
      const {
        data: { user: supaUser },
      } = await supabase.auth.getUser();

      if (!supaUser) {
        router.push('/login');
        return;
      }

      setUser(supaUser);

      // verify admin role
      const { data: userRow, error } = await supabase
        .from('users')
        .select('role')
        .eq('id', supaUser.id)
        .maybeSingle();

      if (error) {
        console.error('role check error:', error);
      }

      if (userRow?.role !== 'admin') {
        router.push('/dashboard');
        return;
      }

      setIsAdmin(true);

      // load dashboard data
      await refreshAll();
      setLoading(false);
    })();
  }, [router, refreshAll]);

  if (loading) {
    return <p className="p-6">Loading admin dashboard‚Ä¶</p>;
  }

  if (!isAdmin) {
    return <p className="p-6">Not authorized.</p>;
  }

  // tab labels
  const tabs = [
    'overview',
    'universes', // NEW
    'studioPages', // ‚úÖ NEW
    'publishing',
    'designs',
    'capital',
    'tech',
    'media',
    'realty',
    'upcoming', // stays dashboard for realty arrivals
    'assets',
    'blog',
    'affiliates',
    'bundles',
    'users',
    'analytics',
    'events',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Admin Dashboard</title>
      </Head>

      <div className="container mx-auto px-4 py-8 space-y-12 gradient-bg dark:bg-gray-900 text-gray-900 dark:text-gray-100">
        {/* tab nav */}
        <nav className="flex gap-2 mb-6 flex-wrap">
          {tabs.map((tab) => (
            <TabButton
              key={tab}
              active={activeTab === tab}
              onClick={() => setActiveTab(tab)}
            >
              {tab.charAt(0).toUpperCase() + tab.slice(1)}
            </TabButton>
          ))}
        </nav>

        {/* tab bodies */}
        {activeTab === 'overview' && (
          <OverviewTab
            orders={orders}
            subscriptions={subscriptions}
            users={users}
          />
        )}

        {activeTab === 'universes' && <UniversesTab />}

        {/* ‚úÖ NEW */}
        {activeTab === 'studioPages' && <StudioPagesTab />}

        {activeTab === 'publishing' && (
          <PublishingTab products={products} refreshAll={refreshAll} />
        )}

        {activeTab === 'designs' && (
          <DesignsTab
            products={products}
            assets={assets}
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'capital' && (
          <CapitalTab products={products} refreshAll={refreshAll} />
        )}

        {activeTab === 'tech' && <TechTab posts={posts} refreshAll={refreshAll} />}

        {activeTab === 'media' && <MediaTab posts={posts} refreshAll={refreshAll} />}

        {activeTab === 'realty' && (
          <RealtyTab
            properties={properties}
            assets={assets}
            leads={realtyLeads}
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'upcoming' && (
          <section className="space-y-6">
            <UpcomingStaysPanel />
          </section>
        )}

        {activeTab === 'assets' && (
          <AssetsTab assets={assets} refreshAll={refreshAll} />
        )}

        {activeTab === 'blog' && (
          <BlogTab posts={posts} refreshAll={refreshAll} user={user} />
        )}

        {activeTab === 'affiliates' && (
          <AffiliatesTab
            affiliates={affiliates}
            orders={orders}
            reservations={reservations}
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'bundles' && (
          <BundlesTab
            bundles={bundles}
            products={products}
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'users' && <UsersTab users={users} refreshAll={refreshAll} />}

        {activeTab === 'analytics' && <AnalyticsTab users={users} orders={orders} />}

        {activeTab === 'events' && <EventsTab events={events} refreshAll={refreshAll} />}
      </div>
    </>
  );
}


===== FILE: pages/api/admin/fulfillment/retry.js  (size=5870 bytes) =====
// pages/api/admin/fulfillment/retry.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { createPrintfulOrder } from '@/lib/printful';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    // --- Auth (admin only) ---
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) return res.status(401).json({ error: 'Unauthorized' });

    const { data: userResp, error: getUserErr } = await supabaseAdmin.auth.getUser(token);
    if (getUserErr || !userResp?.user) return res.status(401).json({ error: 'Unauthorized' });

    const { data: roleRow } = await supabaseAdmin
      .from('users')
      .select('role')
      .eq('id', userResp.user.id)
      .maybeSingle();

    if ((roleRow?.role || 'user') !== 'admin') {
      return res.status(403).json({ error: 'Forbidden' });
    }

    // --- Inputs ---
    const { order_id, override_variant_id = null } = req.body || {};
    if (!order_id) return res.status(400).json({ error: 'order_id is required' });

    // --- Load order ---
    const { data: order, error: oErr } = await supabaseAdmin
      .from('orders')
      .select('*')
      .eq('id', order_id)
      .maybeSingle();
    if (oErr) throw oErr;
    if (!order) return res.status(404).json({ error: 'Order not found' });
    if ((order.status || '').toLowerCase() !== 'paid') {
      return res.status(400).json({ error: 'Order is not paid' });
    }
    if (!order.stripe_session_id) {
      return res.status(400).json({ error: 'Missing stripe_session_id on order' });
    }

    // --- Load product & build items ---
    const { data: product } = await supabaseAdmin
      .from('products')
      .select('*')
      .eq('id', order.product_id)
      .maybeSingle();

    const meta = product?.metadata || {};
    const quantity = Math.max(1, Number(order.quantity || 1));

    // If product includes a full multi-line item list, use it; else fall back to single variant
    let items = [];
    if (Array.isArray(meta.printful_items) && meta.printful_items.length > 0) {
      items = meta.printful_items.map(it => ({
        sync_variant_id: Number(it.sync_variant_id),
        quantity: Math.max(1, Number(it.quantity || quantity)),
      }));
    } else {
      const syncVariantId =
        override_variant_id ||
        meta.printful_sync_variant_id ||
        meta.printful_sync_variant ||
        null;

      if (!syncVariantId) {
        return res.status(400).json({
          error: 'Product is not configured for Printful (missing printful_sync_variant_id)',
        });
      }
      items = [{ sync_variant_id: Number(syncVariantId), quantity }];
    }

    // --- Get shipping details from original checkout session ---
    const session = await stripe.checkout.sessions.retrieve(order.stripe_session_id);
    const addr = session?.shipping_details?.address || null;
    if (!addr) {
      return res.status(400).json({
        error: 'This order has no shipping address; cannot send to Printful.',
      });
    }

    const recipient = {
      name: session?.customer_details?.name || 'Customer',
      address1: addr.line1 || '',
      city: addr.city || '',
      state_code: addr.state || '',
      country_code: addr.country || 'US',
      zip: addr.postal_code || '',
      phone: session?.customer_details?.phone || '',
      email: session?.customer_details?.email || '',
    };

    const packingSlip = {
      email: 'support@manyagi.net',
      phone: '',
      message: 'Thank you for supporting Manyagi!',
    };

    // Use stripe_session_id as external id for idempotency across webhook/retry
    const externalId = order.stripe_session_id;

    let pf;
    try {
      pf = await createPrintfulOrder({
        externalId,
        recipient,
        items,
        packingSlip,
      });
    } catch (e) {
      // If this fails because the external_id already exists, treat as success and fetch it
      const msg = e?.response?.data?.result || e?.response?.data || e?.message || '';
      const alreadyExists =
        typeof msg === 'string' && /external.*exist|already.*exist/i.test(msg);

      if (alreadyExists) {
        // Attempt to fetch by external_id
        try {
          const resp = await fetch(
            `https://api.printful.com/orders/@${encodeURIComponent(externalId)}`,
            { headers: { Authorization: `Bearer ${process.env.PRINTFUL_API_KEY}` } }
          );
          if (resp.ok) {
            const j = await resp.json();
            pf = j?.result;
          } else {
            throw new Error('Order exists but could not fetch from Printful');
          }
        } catch (fetchErr) {
          console.warn('Printful fetch-by-externalId failed:', fetchErr?.message || fetchErr);
          throw e; // bubble original
        }
      } else {
        throw e; // real error
      }
    }

    // --- Persist fulfillment back on the order ---
    await supabaseAdmin
      .from('orders')
      .update({
        fulfillment_provider: 'printful',
        fulfillment_status: pf?.status || 'submitted',
        fulfillment_id: pf?.id ? String(pf.id) : order.fulfillment_id || null,
        updated_at: new Date().toISOString(),
      })
      .eq('id', order.id);

    return res.status(200).json({ ok: true, printful: pf });
  } catch (err) {
    console.error('fulfillment/retry error:', err?.response?.data || err.message);
    return res.status(500).json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/admin/quick-create-product.js  (size=4366 bytes) =====
// pages/api/admin/quick-create-product.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

async function fetchPrintfulPreview(variantId) {
  if (!variantId || !process.env.PRINTFUL_API_KEY) return { preview_url: null, product_id: null };
  try {
    const headers = { Authorization: `Bearer ${process.env.PRINTFUL_API_KEY}` };
    const vRes = await fetch(`https://api.printful.com/store/variants/${variantId}`, { headers });
    if (!vRes.ok) throw new Error('Variant not found');
    const vJson = await vRes.json();
    const variant = vJson?.result;

    let preview_url =
      variant?.files?.find(f => f?.preview_url)?.preview_url ||
      variant?.thumbnail_url || null;

    const product_id = variant?.product_id ?? null;

    if (!preview_url && product_id) {
      const pRes = await fetch(`https://api.printful.com/store/products/${product_id}`, { headers });
      if (pRes.ok) {
        const pJson = await pRes.json();
        const sp = pJson?.result?.sync_product;
        const sv = pJson?.result?.sync_variants || [];
        preview_url =
          sp?.thumbnail_url ||
          (sv.find(x => (x?.files || []).some(f => f?.preview_url))?.files || []).find(f => f?.preview_url)?.preview_url ||
          null;
      }
    }
    return { preview_url, product_id };
  } catch (e) {
    return { preview_url: null, product_id: null };
  }
}

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const {
      name,
      description = '',
      price,                 // number or numeric string
      currency = 'usd',
      image = '',            // optional thumbnail/mockup URL
      printfulVariantId = '',// optional: numeric/id as string
      divisions = ['designs'],
      status = 'active',
      tags = [],
      extraMetadata = {},
    } = req.body || {};

    if (!name) return res.status(400).json({ error: 'Name is required' });
    const amount = Number(price);
    if (!(amount > 0)) return res.status(400).json({ error: 'Valid price required' });

    // If no image provided but we have a variant, try to fetch a mockup URL
    let thumbnail_url = image || null;
    let printful_product_id = null;

    if (!thumbnail_url && printfulVariantId) {
      const { preview_url, product_id } = await fetchPrintfulPreview(printfulVariantId);
      thumbnail_url = preview_url || null;
      printful_product_id = product_id ? String(product_id) : null;
    }

    // 1) Stripe objects
    const sProduct = await stripe.products.create({
      name,
      description,
      images: thumbnail_url ? [thumbnail_url] : undefined,
      default_price_data: {
        currency,
        unit_amount: Math.round(amount * 100),
      },
      metadata: {
        brand: 'Manyagi',
        ...extraMetadata,
      },
    });

    // default_price_data returns price in product‚Äôs default_price
    const sPriceId =
      typeof sProduct.default_price === 'string'
        ? sProduct.default_price
        : sProduct.default_price?.id;

    // 2) Create Supabase products for each division
    const rows = divisions.map((division) => ({
      name,
      division,
      price: amount,
      description,
      status,
      thumbnail_url: thumbnail_url || null,
      printful_product_id: printful_product_id, // may be null if not fetched
      tags,
      metadata: {
        stripe_product_id: sProduct.id,
        stripe_price_id: sPriceId,
        printful_sync_variant_id: printfulVariantId || null,
        extra: extraMetadata || {},
      },
    }));

    const { error: insErr } = await supabaseAdmin.from('products').insert(rows);
    if (insErr) throw insErr;

    return res.status(200).json({
      ok: true,
      stripe_product_id: sProduct.id,
      stripe_price_id: sPriceId,
      used_thumbnail_url: thumbnail_url || null,
      printful_product_id: printful_product_id,
      divisions_created: divisions,
    });
  } catch (err) {
    console.error('quick-create-product error:', err);
    return res.status(500).json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/admin/upload-asset-multi.js  (size=7478 bytes) =====
// pages/api/admin/upload-asset-multi.js
// Fault-tolerant batch uploader with SAFE storage keys.
//
// Keeps original behavior, adds:
// - server-side filename sanitization (fixes "Invalid key")
// - honors client-sent contentType/fileType when present
// - still catches errors PER FILE and returns { ok, items, errors }

import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { nanoid } from 'nanoid';

export const config = {
  api: {
    bodyParser: { sizeLimit: '50mb' },
  },
};

// --- Helpers ---------------------------------------------------------------

function guessContentType(ext) {
  switch ((ext || '').toLowerCase()) {
    case 'jpg':
    case 'jpeg': return 'image/jpeg';
    case 'png':  return 'image/png';
    case 'webp': return 'image/webp';
    case 'gif':  return 'image/gif';
    case 'svg':  return 'image/svg+xml';
    case 'heic':
    case 'heif': return 'image/heic';
    case 'pdf':  return 'application/pdf';
    case 'mp4':  return 'video/mp4';
    case 'mov':
    case 'm4v':  return 'video/quicktime';
    case 'webm': return 'video/webm';
    case 'mp3':  return 'audio/mpeg';
    case 'wav':  return 'audio/wav';
    default:     return 'application/octet-stream';
  }
}

function logicalTypeFromExt(ext) {
  const e = (ext || '').toLowerCase();
  if (['jpg','jpeg','png','webp','gif','svg','heic','heif'].includes(e)) return 'image';
  if (['mp4','mov','m4v','webm'].includes(e)) return 'video';
  if (['mp3','wav'].includes(e)) return 'audio';
  if (e === 'pdf') return 'pdf';
  return 'file';
}

// sanitize a single path segment for Supabase Storage keys
function sanitizeFilename(name) {
  const dot = name.lastIndexOf('.');
  const base = dot >= 0 ? name.slice(0, dot) : name;
  const ext  = dot >= 0 ? name.slice(dot).toLowerCase() : '';

  const safeBase = base
    .normalize('NFKD')
    // drop diacritics + punctuation not safe for keys
    .replace(/[^\w\s.-]/g, '')
    // spaces -> single dash
    .replace(/\s+/g, '-')
    // collapse multi-dashes
    .replace(/-+/g, '-')
    // trim leading/trailing dots/dashes
    .replace(/^[-.]+|[-.]+$/g, '');

  // keep keys reasonably short
  const trimmed = (safeBase || 'file').slice(0, 80);

  return `${trimmed}${ext || ''}`;
}

function logicalTypeFromClientOrExt(clientType, ext) {
  const allow = ['image','video','audio','pdf','file','other'];
  const t = (clientType || '').toLowerCase();
  if (allow.includes(t)) {
    // normalize "other" to "file" for DB
    return t === 'other' ? 'file' : t;
  }
  return logicalTypeFromExt(ext);
}

// --- Handler --------------------------------------------------------------

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // 1) Auth (admin only)
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'Unauthorized (no token)' }],
      });
    }

    const { data: userResp, error: getUserErr } = await supabaseAdmin.auth.getUser(token);
    if (getUserErr || !userResp?.user) {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'Unauthorized (bad token)' }],
      });
    }

    const { data: roleRow, error: roleErr } = await supabaseAdmin
      .from('users')
      .select('role')
      .eq('id', userResp.user.id)
      .maybeSingle();

    if (roleErr || (roleRow?.role || 'user') !== 'admin') {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'Forbidden (not admin)' }],
      });
    }

    // 2) Parse body
    const {
      files,
      division = 'site',
      purpose = 'general',
      folder = '',
      metadata = {},
    } = req.body || {};

    if (!Array.isArray(files) || files.length === 0) {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'No files provided' }],
      });
    }

    // storage prefix: assets/<division>/<purpose>/YYYY/MM[/folder]
    const now = new Date();
    const yyyy = now.getUTCFullYear();
    const mm = String(now.getUTCMonth() + 1).padStart(2, '0');

    const basePrefix = [division, purpose, yyyy, mm, folder ? folder : null]
      .filter(Boolean)
      .join('/');

    const items = [];
    const errors = [];

    // 3) Process each file independently
    for (const f of files) {
      const clientName = f?.name || `upload-${nanoid(8)}`;
      const originalName = clientName; // for messages
      try {
        if (!f?.data) throw new Error('Missing base64 data');

        // base64 -> Buffer
        let buffer;
        try { buffer = Buffer.from(f.data, 'base64'); }
        catch { throw new Error('Invalid base64'); }

        // extension from (possibly unsanitized) input name
        const ext = (clientName.split('.').pop() || 'bin').toLowerCase();

        // choose file_type/contentType
        const fileType = logicalTypeFromClientOrExt(f?.fileType, ext);
        const contentType = f?.contentType || guessContentType(ext);

        // SERVER-SIDE SANITIZATION: never use raw clientName in key
        const safeName = sanitizeFilename(clientName);

        const storagePath = `${basePrefix}/${nanoid(6)}-${safeName}`;

        // 3a) upload to Supabase Storage (bucket: assets)
        const { error: upErr } = await supabaseAdmin.storage
          .from('assets')
          .upload(storagePath, buffer, {
            contentType,
            upsert: false,
          });

        if (upErr) {
          // propagate clean message (this is where "Invalid key" came from before)
          throw new Error(`Storage upload failed: ${upErr.message || 'unknown'}`);
        }

        // 3b) public URL
        const { data: pub } = await supabaseAdmin.storage
          .from('assets')
          .getPublicUrl(storagePath);
        const file_url = pub?.publicUrl;
        if (!file_url) throw new Error('Failed to generate public URL');

        // 3c) insert public.assets row
        const insertPayload = {
          file_url,
          file_type: fileType, // 'image' | 'video' | 'audio' | 'pdf' | 'file'
          division,
          purpose,
          filename: safeName,  // store the cleaned filename
          metadata,
        };

        const { data: inserted, error: insertErr } = await supabaseAdmin
          .from('assets')
          .insert(insertPayload)
          .select('*')
          .single();

        if (insertErr) {
          throw new Error(`DB insert failed: ${insertErr.message}`);
        }

        items.push({
          id: inserted.id,
          file_url,
          filename: safeName,
          division,
          purpose,
        });
      } catch (err) {
        errors.push({ name: originalName, reason: String(err.message || err) });
      }
    }

    // 4) Respond
    return res.status(200).json({ ok: errors.length === 0, items, errors });
  } catch (fatal) {
    return res.status(200).json({
      ok: false,
      items: [],
      errors: [{ name: '(fatal)', reason: String(fatal?.message || fatal) }],
    });
  }
}


===== FILE: pages/api/admin/upload-asset.js  (size=9610 bytes) =====
// pages/api/admin/upload-asset.js
// Upload to Supabase Storage, insert into public.assets, and (optionally) upsert/link tags.
// Works with your existing supabaseAdmin helper (service role).
// Accepts file.data as either raw base64 *or* a data URL.
// Returns the inserted asset row, plus convenience fields.

import { supabaseAdmin } from '@/lib/supabaseAdmin';

export const config = { api: { bodyParser: { sizeLimit: '50mb' } } }; // allow big images/mp4

// ---------- helpers ----------
const clean = (s) =>
  String(s || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9._-]/g, '');

const normalizeTags = (input) => {
  if (!input) return [];
  if (Array.isArray(input)) return input.map(clean).filter(Boolean);
  if (typeof input === 'string') return input.split(',').map(clean).filter(Boolean);
  return [];
};

const guessMime = (name, fallbackType) => {
  const ext = (String(name || '').split('.').pop() || '').toLowerCase();
  if (['jpg', 'jpeg'].includes(ext)) return 'image/jpeg';
  if (ext === 'png') return 'image/png';
  if (ext === 'webp') return 'image/webp';
  if (ext === 'gif') return 'image/gif';
  if (ext === 'mp4') return 'video/mp4';
  if (ext === 'pdf') return 'application/pdf';
  // fall back to declared file_type if helpful
  if (fallbackType === 'image') return 'application/octet-stream'; // storage will still host
  if (fallbackType === 'video') return 'video/mp4';
  if (fallbackType === 'pdf') return 'application/pdf';
  return 'application/octet-stream';
};

const toBuffer = (maybeBase64) => {
  // Accept plain base64 or full data URL
  if (!maybeBase64) return null;
  const base64 =
    typeof maybeBase64 === 'string'
      ? (maybeBase64.includes('base64,') ? maybeBase64.split('base64,').pop() : maybeBase64)
      : '';
  try {
    return Buffer.from(base64, 'base64');
  } catch {
    return null;
  }
};

// ---------- SAFE column detector (no pg_catalog / information_schema) ----------
/**
 * We infer column names by selecting a single row from the table
 * and taking Object.keys(row). If the table is empty, we fall back
 * to an empty array. Result is cached per table for this lambda run.
 */
const columnsCache = {};
async function tableColumns(table) {
  if (columnsCache[table]) return columnsCache[table];

  try {
    const { data, error } = await supabaseAdmin.from(table).select('*').limit(1);
    if (error || !data || !data.length) {
      columnsCache[table] = [];
      return [];
    }
    const cols = Object.keys(data[0] || {});
    columnsCache[table] = cols;
    return cols;
  } catch (e) {
    console.warn(`[tableColumns] Failed to inspect table "${table}":`, e?.message || e);
    columnsCache[table] = [];
    return [];
  }
}

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    // ---------- 1) Auth: Bearer token + admin role ----------
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) return res.status(401).json({ error: 'Unauthorized (missing token)' });

    const { data: userResult, error: userErr } = await supabaseAdmin.auth.getUser(token);
    if (userErr || !userResult?.user?.id) {
      return res.status(401).json({ error: 'Unauthorized (invalid token)' });
    }
    const userId = userResult.user.id;

    const { data: roleRow, error: roleErr } = await supabaseAdmin
      .from('users')
      .select('role')
      .eq('id', userId)
      .maybeSingle();
    if (roleErr || roleRow?.role !== 'admin') {
      return res.status(403).json({ error: 'Forbidden' });
    }

    // ---------- 2) Parse inputs ----------
    const { file, file_type, division, purpose, metadata, tags } = req.body || {};
    if (!file?.data || !file?.name) {
      return res.status(400).json({ error: 'Missing file {data,name}' });
    }
    if (!file_type || !division || !purpose) {
      return res.status(400).json({ error: 'Missing file_type/division/purpose' });
    }

    const tagSlugs = normalizeTags(tags);
    const now = new Date().toISOString().replace(/[:.]/g, '-');
    const storage_key = `${clean(division)}/${clean(purpose)}/${now}-${clean(file.name)}`;
    const contentType = guessMime(file.name, file_type);

    // ---------- 3) Upload to Storage (handle duplicate path safely) ----------
    const bin = toBuffer(file.data);
    if (!bin) {
      return res.status(400).json({ error: 'Invalid base64 payload' });
    }

    let finalKey = storage_key;
    let upErr = null;

    const doUpload = async (key) => {
      const { error } = await supabaseAdmin.storage
        .from('assets')
        .upload(key, bin, { contentType, upsert: false });
      return error;
    };

    upErr = await doUpload(finalKey);
    if (upErr && String(upErr.message || '').toLowerCase().includes('duplicate')) {
      finalKey = `${clean(division)}/${clean(purpose)}/${now}-${Date.now()}-${clean(file.name)}`;
      upErr = await doUpload(finalKey);
    }
    if (upErr) {
      console.error('[upload error]', upErr);
      return res
        .status(500)
        .json({ error: `Storage upload failed: ${upErr.message || 'unknown'}` });
    }

    const { data: pub } = await supabaseAdmin.storage.from('assets').getPublicUrl(finalKey);
    const file_url = pub?.publicUrl;
    if (!file_url) {
      return res.status(500).json({ error: 'Failed to compute public URL' });
    }

    // ---------- 4) Normalize metadata ----------
    let meta = {};
    if (metadata) {
      if (typeof metadata === 'string') {
        try {
          meta = JSON.parse(metadata);
        } catch {
          meta = { raw: metadata };
        }
      } else if (typeof metadata === 'object') {
        meta = metadata;
      }
    }

    // ---------- 5) Insert into public.assets (supports assets.tags if present) ----------
    const cols = await tableColumns('assets').catch(() => []);
    const hasTagsColumn = cols.includes('tags'); // text[]
    const hasFilename = cols.includes('filename');
    const hasStorageKey = cols.includes('storage_key');
    const hasUploadedBy = cols.includes('uploaded_by');

    const insertPayload = {
      file_url,
      file_type,
      division,
      purpose,
      metadata: {
        ...meta,
        // ensure tags are always mirrored inside metadata
        tags: Array.isArray(meta?.tags) && meta.tags.length ? meta.tags : tagSlugs,
      },
    };

    if (hasTagsColumn) insertPayload.tags = tagSlugs;
    if (hasFilename) insertPayload.filename = String(file.name);
    if (hasStorageKey) insertPayload.storage_key = finalKey;
    if (hasUploadedBy) insertPayload.uploaded_by = userId;

    let inserted = null;
    {
      const { data, error } = await supabaseAdmin
        .from('assets')
        .insert(insertPayload)
        .select('*')
        .single();
      if (error) {
        console.error('[insert assets error]', error);
        return res.status(500).json({ error: `DB insert failed: ${error.message}` });
      }
      inserted = data;
    }

    // ---------- 6) Optional tags upsert & linking (assets_tags) ----------
    // If you created public.tags + public.assets_tags, we populate them; otherwise we silently skip.
    try {
      if (tagSlugs.length) {
        // upsert tags
        const upsertRows = tagSlugs.map((slug) => ({
          slug,
          label: slug.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()),
          kind: 'asset',
        }));
        const { data: tagRows } = await supabaseAdmin
          .from('tags')
          .upsert(upsertRows, { onConflict: 'slug' })
          .select('id, slug');

        if (Array.isArray(tagRows) && tagRows.length) {
          const linkRows = tagRows.map((t) => ({ asset_id: inserted.id, tag_id: t.id }));
          await supabaseAdmin.from('assets_tags').insert(linkRows);
        }
      }
    } catch (e) {
      // tables might not exist; ignore silently
      console.warn('[tags upsert/link skipped]', e?.message || e);
    }

    // ---------- 7) Optional site_config hooks ----------
    try {
      if (['hero', 'logo', 'favicon'].includes(purpose)) {
        await supabaseAdmin
          .from('site_config')
          .upsert(
            { key: purpose, value: { asset_id: inserted.id, file_url } },
            { onConflict: 'key' }
          );
      } else if (purpose === 'carousel') {
        const { data: existing } = await supabaseAdmin
          .from('site_config')
          .select('value')
          .eq('key', 'carousel_images')
          .maybeSingle();
        const arr = Array.isArray(existing?.value) ? existing.value : [];
        const updated = [...arr, file_url].slice(-5);
        await supabaseAdmin
          .from('site_config')
          .upsert({ key: 'carousel_images', value: updated }, { onConflict: 'key' });
      }
    } catch (e) {
      console.warn('[site_config hook skipped]', e?.message || e);
    }

    // ---------- 8) Done ----------
    return res.status(200).json({
      ...inserted,
      file_url,
      storage_key: finalKey,
      tags: tagSlugs,
    });
  } catch (error) {
    console.error('Asset upload fatal:', error);
    return res
      .status(500)
      .json({ error: error?.message || 'Failed to upload asset' });
  }
}


===== FILE: pages/api/capital/subscriptions-admin.js  (size=1980 bytes) =====
// pages/api/capital/subscriptions-admin.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Returns:
 * {
 *   ok: true,
 *   mrr: 123.45,
 *   subs: [
 *     {
 *       id,
 *       telegram_id,
 *       plan_type,
 *       status,
 *       current_period_end,
 *       current_period_start,
 *       amount_usd
 *     },
 *     ...
 *   ]
 * }
 *
 * Notes:
 * - We assume "Basic Signals" is $29.99/mo.
 * - You can change this mapping later if you add tiers.
 */
export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // Pull subscriptions we consider ‚Äúactive/paid‚Äù
    const { data, error } = await supabaseAdmin
      .from('subscriptions')
      .select('*')
      .in('status', ['active', 'paid', 'trialing']);

    if (error) {
      console.error('subscriptions-admin error:', error.message);
      return res.status(500).json({ error: error.message });
    }

    const PRICE_MAP = {
      'Basic Signals': 29.99,
    };

    // normalize and compute MRR
    let totalMRR = 0;
    const subs = (data || []).map((row) => {
      const amt = PRICE_MAP[row.plan_type] || 0;
      if (row.status === 'active' || row.status === 'paid' || row.status === 'trialing') {
        totalMRR += amt;
      }
      return {
        id: row.id,
        telegram_id: row.telegram_id,
        plan_type: row.plan_type,
        status: row.status,
        current_period_start: row.current_period_start,
        current_period_end: row.current_period_end,
        amount_usd: amt,
      };
    });

    return res.status(200).json({
      ok: true,
      mrr: Number(totalMRR.toFixed(2)),
      subs,
    });
  } catch (e) {
    console.error('subscriptions-admin crash:', e);
    return res.status(500).json({
      ok: false,
      error: e.message || 'internal error',
    });
  }
}


===== FILE: pages/api/checkout/create-session.js  (size=11113 bytes) =====
// pages/api/checkout/create-session.js
import Stripe from "stripe";
import { supabaseAdmin } from "@/lib/supabaseAdmin";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: "2024-06-20" });

// -------------------------------
// small helpers
// -------------------------------
function asStr(v) {
  return v === null || v === undefined ? "" : String(v);
}

function safeJSON(v) {
  if (!v) return {};
  if (typeof v === "object") return v;
  if (typeof v === "string") {
    try {
      const parsed = JSON.parse(v);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch {
      return {};
    }
  }
  return {};
}

function normalizeStudioTier(t) {
  const v = asStr(t).trim().toLowerCase();
  if (v === "priority" || v === "producer" || v === "packaging") return v;
  return "";
}

// ‚úÖ NEW: normalize/validate next path (prevents open redirects)
function normalizeNextPath(next) {
  const v = asStr(next).trim();
  if (!v) return "";
  // Only allow internal relative routes
  if (!v.startsWith("/")) return "";
  // Avoid protocol-relative //evil.com
  if (v.startsWith("//")) return "";
  return v;
}

async function getAuthedUserIdFromBearer(req) {
  const authHeader = req.headers.authorization || "";
  const token = authHeader.startsWith("Bearer ") ? authHeader.slice(7) : "";
  if (!token) return { userId: null, token: null };

  const { data, error } = await supabaseAdmin.auth.getUser(token);
  if (error || !data?.user?.id) return { userId: null, token: null };

  return { userId: data.user.id, token };
}

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).json({ error: "Method not allowed" });

  try {
    const {
      // Shared
      success_url,
      cancel_url,

      // SUBSCRIPTION path
      mode, // 'subscription' => create subscription checkout
      price_id, // optional override; falls back to env
      email, // optional prefill for subscription
      telegramId, // from Signals form

      // ONE-TIME path
      product_id, // required for one-time purchase (Supabase products.id)
      quantity = 1,
      user_id = null,

      // track who referred this customer
      affiliate_code = null,

      // ‚úÖ NEW: where to return after checkout (e.g. "/studios/<slug>")
      next,
    } = req.body || {};

    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || "http://localhost:3000";

    // ‚úÖ NEW: safe internal next path (never external)
    const nextPath = normalizeNextPath(next);

    // -------------------------
    // 1) SUBSCRIPTION CHECKOUT
    // -------------------------
    if (mode === "subscription") {
      const activePrice = price_id || process.env.NEXT_PUBLIC_STRIPE_PRICE_ID;
      if (!activePrice) {
        return res.status(400).json({
          error: "Missing price_id. Set NEXT_PUBLIC_STRIPE_PRICE_ID or pass price_id in body.",
        });
      }

      const session = await stripe.checkout.sessions.create({
        mode: "subscription",
        line_items: [{ price: activePrice, quantity: 1 }],
        allow_promotion_codes: true,
        customer_email: email || undefined,
        success_url: success_url || `${baseUrl}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: cancel_url || `${baseUrl}/checkout/cancelled`,
        customer_creation: "always", // ensures we have a Customer to store metadata on

        // put telegramId everywhere we might read it later
        metadata: {
          telegramId: telegramId ? String(telegramId) : "",
          plan: "Basic Signals",
          division: "capital",
          affiliate_code: affiliate_code || "",
        },
        subscription_data: {
          metadata: {
            telegramId: telegramId ? String(telegramId) : "",
            plan: "Basic Signals",
            division: "capital",
            affiliate_code: affiliate_code || "",
          },
        },
      });

      return res.status(200).json({
        ok: true,
        id: session.id,
        url: session.url,
      });
    }

    // --------------------------------
    // 2) ONE-TIME (PRODUCT) CHECKOUT
    // --------------------------------
    if (!product_id) {
      return res.status(400).json({
        error: 'product_id is required for one-time checkout (or set mode: "subscription")',
      });
    }

    const qty = Math.max(1, parseInt(quantity, 10) || 1);

    // Load product from Supabase
    const { data: product, error: pErr } = await supabaseAdmin
      .from("products")
      .select("*")
      .eq("id", product_id)
      .maybeSingle();

    if (pErr) throw pErr;
    if (!product) return res.status(404).json({ error: "Product not found" });

    const meta = safeJSON(product.metadata);
    const stripePriceId = meta.stripe_price_id;

    if (!stripePriceId) {
      return res.status(400).json({ error: "Missing metadata.stripe_price_id on this product" });
    }

    // Decide if we must collect shipping (for merch/physical items)
    const needsShipping = !!meta.printful_sync_variant_id || meta.fulfill_with_printful === true;

    // ‚úÖ FIX: Studio Access detection must include offer_type OR kind
    // This prevents subtle mismatches where products use metadata.offer_type = "studio_access"
    const offerType = asStr(meta.offer_type || meta.kind).trim().toLowerCase();
    const isStudioAccess = offerType === "studio_access";

    // Determine user_id:
    // - for normal products: keep your existing behavior (use body user_id if provided)
    // - for studio_access: require Supabase login (Bearer token)
    let resolvedUserId = user_id;

    if (isStudioAccess) {
      const { userId } = await getAuthedUserIdFromBearer(req);
      if (!userId) {
        return res.status(401).json({
          error: "Studio access requires login. Missing or invalid Authorization Bearer token.",
        });
      }
      resolvedUserId = userId;
    }

    // Studio metadata validation (only for studio_access)
    let studioUniverseId = null;
    let studioTier = "";
    let studioUniverseSlug = "";
    if (isStudioAccess) {
      studioUniverseId = asStr(meta.universe_id).trim();
      studioTier = normalizeStudioTier(meta.tier);
      studioUniverseSlug = asStr(meta.universe_slug).trim();

      if (!studioUniverseId) {
        return res.status(400).json({
          error: "Studio access product is missing metadata.universe_id",
        });
      }
      if (!studioTier) {
        return res.status(400).json({
          error: "Studio access product has invalid metadata.tier (must be priority|producer|packaging)",
        });
      }
    }

    // ‚úÖ NEW: build default return path for studio flows if caller didn't pass next
    // Priority: explicit next > inferred studio slug > studios library
    const inferredStudioNext = studioUniverseSlug ? `/studios/${studioUniverseSlug}` : "/studios";
    const finalNextPath = nextPath || (isStudioAccess ? inferredStudioNext : "");

    // ‚úÖ NEW: defaults for studio success/cancel that include next
    const studioSuccessUrl =
      `${baseUrl}/checkout/studio-success?session_id={CHECKOUT_SESSION_ID}` +
      (finalNextPath ? `&next=${encodeURIComponent(finalNextPath)}` : "");

    const studioCancelUrl =
      `${baseUrl}/checkout/studio-cancel` +
      (finalNextPath ? `?next=${encodeURIComponent(finalNextPath)}` : "");

    // build Checkout Session
    const session = await stripe.checkout.sessions.create({
      mode: "payment",
      line_items: [{ price: stripePriceId, quantity: isStudioAccess ? 1 : qty }],
      allow_promotion_codes: true,
      automatic_tax: { enabled: true },

      // ‚úÖ Shipping ONLY for physical merch
      shipping_address_collection: needsShipping
        ? {
            allowed_countries: ["US", "CA", "GB", "AU", "NZ", "DE", "FR", "ES", "IT", "NL", "SE"],
          }
        : undefined,
      phone_number_collection: needsShipping ? { enabled: true } : undefined,

      // ‚úÖ Studio: use studio-success by default (includes &next=...)
      success_url:
        success_url ||
        (isStudioAccess
          ? studioSuccessUrl
          : `${baseUrl}/checkout/success?session_id={CHECKOUT_SESSION_ID}`),

      // ‚úÖ Studio: use studio-cancel by default (includes ?next=...)
      cancel_url:
        cancel_url ||
        (isStudioAccess ? studioCancelUrl : `${baseUrl}/checkout/cancelled`),

      metadata: {
        // existing fields
        product_id: String(product.id),
        division: String(product.division || "site"),
        quantity: String(isStudioAccess ? 1 : qty),
        product_name: String(product.name || ""),
        affiliate_code: affiliate_code || "",

        // ‚úÖ FIX: webhook routing should be deterministic
        // - studio access must be "studio_access"
        // - non-studio should be "product_order" (not blank)
        type: isStudioAccess ? "studio_access" : "product_order",

        // ‚úÖ studio entitlement fields (only populated when studio_access)
        universe_id: isStudioAccess ? String(studioUniverseId) : "",
        tier: isStudioAccess ? String(studioTier) : "",
        user_id: isStudioAccess ? String(resolvedUserId || "") : "",

        // ‚úÖ include universe_slug for better webhook emails / links
        universe_slug: isStudioAccess ? String(studioUniverseSlug || "") : "",

        // ‚úÖ NEW: return routing (safe internal path only)
        next: finalNextPath ? String(finalNextPath) : "",
      },
    });

    // Record a pending order for your webhook to finalize
    const estimatedTotal = Number(product.price || 0) * (isStudioAccess ? 1 : qty);

    await supabaseAdmin.from("orders").insert({
      user_id: resolvedUserId,
      product_id: product.id,
      division: product.division || "site",
      status: "pending",
      quantity: isStudioAccess ? 1 : qty,
      total_amount: estimatedTotal,
      stripe_session_id: session.id,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      affiliate_code: affiliate_code || null,
      product_snapshot: {
        name: product.name,
        price: product.price,
        thumbnail_url: product.thumbnail_url || null,
        metadata: meta || {},

        // ‚úÖ extra trace info for studio purchases
        kind: isStudioAccess ? "studio_access" : offerType || null,
        universe_id: isStudioAccess ? studioUniverseId : null,
        tier: isStudioAccess ? studioTier : null,

        // ‚úÖ NEW: trace next routing
        next: finalNextPath || null,
      },
    });

    return res.status(200).json({
      ok: true,
      id: session.id,
      url: session.url,
    });
  } catch (err) {
    console.error("create-session error:", err);
    return res.status(500).json({ error: err.message || "Internal error" });
  }
}


===== FILE: pages/api/events.js  (size=1339 bytes) =====
// pages/api/events.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Public events feed.
 *
 * Accepts optional query params:
 *   ?division=tech      -> only show events for that division
 *   ?upcoming=1         -> only future events (start_date >= now)
 *
 * Returns: [{ id, title, description, start_date, end_date, division }]
 */
export default async function handler(req, res) {
  try {
    const { division, upcoming } = req.query || {};

    let query = supabaseAdmin
      .from('events')
      .select(
        'id,title,description,start_date,end_date,division,metadata'
      )
      .order('start_date', { ascending: true });

    // filter by division if provided
    if (division) {
      query = query.eq('division', division);
    }

    const { data, error } = await query;
    if (error) throw error;

    // upcoming filter (client can pass upcoming=1)
    let list = data || [];
    if (upcoming) {
      const now = Date.now();
      list = list.filter((ev) => {
        if (!ev.start_date) return false;
        const startTs = new Date(ev.start_date).getTime();
        return startTs >= now;
      });
    }

    return res.status(200).json(list);
  } catch (e) {
    console.error('events api error:', e);
    return res.status(200).json([]);
  }
}


===== FILE: pages/api/order-details.js  (size=724 bytes) =====
// pages/api/order-details.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  const { session_id } = req.query;

  if (!session_id) {
    return res.status(400).json({ error: 'Missing session_id' });
  }

  try {
    const { data, error } = await supabaseAdmin.from('orders').select('*').eq('stripe_session_id', session_id).single();
    if (error) throw error;
    if (!data) return res.status(404).json({ error: 'Order not found' });
    res.status(200).json({ ...data, type: data.type || 'general' });
  } catch (error) {
    console.error('Supabase error:', error);
    res.status(500).json({ error: 'Failed to fetch order details' });
  }
}


===== FILE: pages/api/posts.js  (size=3166 bytes) =====
// pages/api/posts.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * GET /api/posts
 *
 * Query params:
 *   ?division=tech            -> filter by division
 *   ?slug=daito-app           -> filter by slug (requires division OR will search all divisions)
 *
 * Shapes returned:
 *
 * 1) List mode (no slug):
 *    {
 *      ok: true,
 *      items: [
 *        { id, title, slug, excerpt, created_at, featured_image, content, status, division, metadata }
 *      ],
 *      total: 3
 *    }
 *
 * 2) Detail mode (has slug):
 *    {
 *      ok: true,
 *      post: { id, title, slug, ... }
 *    }
 *
 * Errors:
 *    { ok:false, error:"message" }
 *
 * NOTE:
 * We always .eq('status','published') so drafts won't leak.
 */

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res
      .status(405)
      .json({ ok: false, error: 'Method not allowed' });
  }

  try {
    const { division, slug } = req.query || {};

    // --- DETAIL MODE: division + slug (or just slug) -----------------
    // If we have a slug, we're trying to fetch a single post.
    if (slug) {
      // Build the query
      let q = supabaseAdmin
        .from('posts')
        .select(
          'id,title,slug,excerpt,created_at,featured_image,content,status,division,metadata'
        )
        .eq('status', 'published')
        .eq('slug', slug)
        .limit(1);

      // If division was provided, add that filter too
      if (division) {
        q = q.eq('division', division);
      }

      const { data, error } = await q;
      if (error) {
        console.error('posts detail fetch error:', error);
        return res
          .status(200)
          .json({ ok: false, error: error.message || 'query failed' });
      }

      const post = Array.isArray(data) && data.length > 0 ? data[0] : null;

      if (!post) {
        return res
          .status(200)
          .json({ ok: false, error: 'not found' });
      }

      return res.status(200).json({ ok: true, post });
    }

    // --- LIST MODE: no slug, maybe division --------------------------
    // Build base query for list
    let listQuery = supabaseAdmin
      .from('posts')
      .select(
        'id,title,slug,excerpt,created_at,featured_image,content,status,division,metadata'
      )
      .eq('status', 'published')
      .order('created_at', { ascending: false });

    if (division) {
      listQuery = listQuery.eq('division', division);
    }

    const { data: rows, error: listErr } = await listQuery;
    if (listErr) {
      console.error('posts list fetch error:', listErr);
      return res
        .status(200)
        .json({ ok: false, error: listErr.message || 'query failed', items: [], total: 0 });
    }

    return res.status(200).json({
      ok: true,
      items: rows || [],
      total: rows ? rows.length : 0,
    });
  } catch (e) {
    console.error('posts handler crash:', e);
    return res
      .status(200)
      .json({ ok: false, error: e.message || 'internal error', items: [], total: 0 });
  }
}


===== FILE: pages/api/posts/[slug].js  (size=713 bytes) =====
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  const { slug } = req.query;
  if (!slug) return res.status(400).json({ error: 'Missing slug' });
  try {
    const { data, error } = await supabaseAdmin
      .from('posts')
      .select('id,title,slug,excerpt,created_at,featured_image,content,status')
      .eq('slug', slug)
      .eq('status', 'published')
      .maybeSingle();
    if (error) throw error;
    if (!data) return res.status(404).json({ error: 'Not found' });
    res.status(200).json(data);
  } catch (e) {
    console.error('post fetch error:', e);
    res.status(500).json({ error: 'Failed to fetch post' });
  }
}


===== FILE: pages/api/products.js  (size=6010 bytes) =====
// pages/api/products.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

function coerceMetadata(meta) {
  if (!meta) return {};
  if (typeof meta === 'object') return meta;
  if (typeof meta === 'string') {
    try {
      return JSON.parse(meta);
    } catch {
      return {};
    }
  }
  return {};
}

function coerceTags(tags) {
  if (!tags) return [];
  if (Array.isArray(tags)) return tags;
  if (typeof tags === 'string') {
    // try JSON first
    try {
      const parsed = JSON.parse(tags);
      if (Array.isArray(parsed)) return parsed.map(String);
    } catch {
      // CSV fallback
      return tags
        .split(',')
        .map(t => t.trim())
        .filter(Boolean);
    }
  }
  return [];
}

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const {
    division = '',
    collection = '', // maps to metadata fields like book/series/drop/year/prompt
    tag = '',        // matches any item in products.tags text[]
    q = '',          // search in name/description/metadata.scene/book
    sort = 'new',    // 'new' | 'price_asc' | 'price_desc'
    limit = '16',
    offset = '0',
  } = req.query;

  try {
    // IMPORTANT: include nft_url in the selection!
    let query = supabaseAdmin
      .from('products')
      .select(
        `
        id, name, description, price, division, status,
        image_url, thumbnail_url, printful_product_id,
        metadata, tags, nft_url,
        created_at
      `,
        { count: 'exact' }
      )
      .eq('status', 'active');

    if (division) query = query.eq('division', division);

    if (q) {
      // Search across name, description, and metadata fields
      query = query.or(
        [
          `name.ilike.%${q}%`,
          `description.ilike.%${q}%`,
          `metadata->>scene.ilike.%${q}%`,
          `metadata->>book.ilike.%${q}%`,
        ].join(',')
      );
    }

    if (tag) {
      // products.tags is text[]; Supabase contains() works with arrays
      query = query.contains('tags', [tag]);
    }

    if (collection) {
      // support "prompt-1" or "2025" or direct book/series/drop strings
      if (/^prompt-\d+$/i.test(collection)) {
        const p = collection.split('-')[1];
        query = query.eq('metadata->>prompt', String(Number(p)));
      } else if (/^\d{4}$/.test(collection)) {
        query = query.eq('metadata->>year', collection);
      } else {
        // try book or series or drop match
        query = query.or(
          [
            `metadata->>book.eq.${collection}`,
            `metadata->>series.eq.${collection}`,
            `metadata->>drop.eq.${collection}`,
          ].join(',')
        );
      }
    }

    if (sort === 'price_asc') {
      query = query.order('price', { ascending: true, nullsFirst: true });
    } else if (sort === 'price_desc') {
      query = query.order('price', { ascending: false, nullsFirst: false });
    } else {
      query = query.order('created_at', { ascending: false });
    }

    const lim = Math.max(1, Math.min(100, Number(limit) || 16));
    const off = Math.max(0, Number(offset) || 0);
    query = query.range(off, off + lim - 1);

    const { data, error, count } = await query;
    if (error) throw error;

    const items = (data || []).map((row) => {
      const metadata = coerceMetadata(row.metadata);
      const tags = coerceTags(row.tags);

      // Prefer top-level nft_url; then metadata.nft_url; support legacy nftUrl as well
      const nft_url =
        row.nft_url ||
        metadata.nft_url ||
        row.nftUrl ||
        metadata.nftUrl ||
        null;

      return {
        id: row.id,
        name: row.name,
        description: row.description || '',
        division: row.division,
        status: row.status,
        price: Number(row.price),
        image_url: row.image_url || '',
        thumbnail_url: row.thumbnail_url || '',
        display_image: row.thumbnail_url || row.image_url || '',
        printful_product_id: row.printful_product_id || '',
        tags,
        metadata,
        // expose nft_url so Card can show the ribbon & button
        nft_url,
        // convenience fields that your UI already uses
        prompt: metadata?.prompt,
        book: metadata?.book,
        scene: metadata?.scene,
        productType:
          row.division === 'designs'
            ? 'merch'
            : row.division === 'publishing'
            ? 'book'
            : row.division === 'capital'
            ? 'download'
            : 'general',
        created_at: row.created_at,
      };
    });

    res.status(200).json({ items, total: count ?? items.length });
  } catch (error) {
    console.error('Supabase products error:', error);

    const fallback =
      division === 'designs'
        ? [
            {
              id: 'fallback-tee',
              name: 'Sample T-Shirt',
              price: 29.99,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
              thumbnail_url:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
              image_url:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
              division: 'designs',
              description: 'Fallback design merchandise',
              printful_product_id: 'fallback-tee-id',
              productType: 'merch',
              metadata: { prompt: 1, book: 'Sample', scene: 'Portal' },
              tags: ['sample', 'tee'],
              nft_url: null,
            },
          ]
        : [];

    res.status(200).json({ items: fallback, total: fallback.length });
  }
}


===== FILE: pages/api/realty/[slug].js  (size=5759 bytes) =====
// pages/realty/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import enUS from 'date-fns/locale/en-US';
import 'react-big-calendar/lib/css/react-big-calendar.css';

const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: { 'en-US': enUS }
});

export default function PropertyDetail() {
  const router = useRouter();
  const { slug } = router.query;
  const [property, setProperty] = useState(null);
  const [availability, setAvailability] = useState([]);
  const [checkin, setCheckin] = useState('');
  const [checkout, setCheckout] = useState('');
  const [guests, setGuests] = useState(1);
  const [quote, setQuote] = useState(null);
  const [guestName, setGuestName] = useState('');
  const [guestEmail, setGuestEmail] = useState('');
  const [guestPhone, setGuestPhone] = useState('');
  const [notes, setNotes] = useState('');
  const [loading, setLoading] = useState(true);
  const [busy, setBusy] = useState(false);

  useEffect(() => {
    if (slug) {
      fetch(`/api/realty/property?slug=${slug}`)
        .then(res => res.json())
        .then(data => {
          setProperty(data.property);
          setAvailability(data.availability || []);
          setLoading(false);
        })
        .catch(() => setLoading(false));
    }
  }, [slug]);

  const getQuote = async () => {
    if (!checkin || !checkout) return alert('Select dates');
    setBusy(true);
    try {
      const res = await fetch('/api/realty/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: property.id, checkin, checkout }),
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);
      setQuote(data);
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  };

  const book = async () => {
    if (!quote) return alert('Get a quote first');
    if (!guestName || !guestEmail) return alert('Enter guest details');
    setBusy(true);
    try {
      const res = await fetch('/api/realty/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: property.id,
          checkin,
          checkout,
          guests,
          guest_name: guestName,
          guest_email: guestEmail,
          guest_phone: guestPhone,
          notes,
        }),
      });
      const data = await res.json();
      if (data.url) window.location.href = data.url;
      else alert('Failed to book');
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  };

  const events = availability.map(a => ({
    title: a.status,
    start: new Date(a.date),
    end: new Date(a.date),
    allDay: true,
  }));

  if (loading) return <div>Loading property...</div>;
  if (!property) return <div>Property not found</div>;

  return (
    <>
      <Head>
        <title>{property.name} ‚Äî Manyagi Realty</title>
        <meta name="description" content={property.description} />
      </Head>
      <section className="container mx-auto px-4 py-16">
        <h1 className="text-4xl font-bold mb-4">{property.name}</h1>
        <img src={property.image_url} alt={property.name} className="w-full h-64 object-cover rounded mb-6" />
        <p className="mb-4">{property.description}</p>
        <p><strong>Price per night:</strong> ${property.nightly_price}</p>

        {/* NEW: Google Map embed if location */}
        {property.metadata?.location && (
          <div className="mt-6">
            <h2 className="text-2xl font-bold mb-2">Location</h2>
            <iframe
              src={`https://maps.google.com/maps?q=${encodeURI(property.metadata.location)}&output=embed`}
              width="100%"
              height="450"
              style={{ border: 0 }}
              allowFullScreen=""
              loading="lazy"
              referrerPolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>
        )}

        <h2 className="text-2xl font-bold mt-8">Availability</h2>
        <Calendar
          localizer={localizer}
          events={events}
          startAccessor="start"
          endAccessor="end"
          style={{ height: 500 }}
        />

        <h2 className="text-2xl font-bold mt-8">Book Now</h2>
        <div className="space-y-4">
          <input type="date" value={checkin} onChange={e => setCheckin(e.target.value)} />
          <input type="date" value={checkout} onChange={e => setCheckout(e.target.value)} />
          <input type="number" value={guests} onChange={e => setGuests(e.target.value)} min="1" />
          <button onClick={getQuote} disabled={busy}>Get Quote</button>
          {quote && (
            <div>
              <p>Total: ${quote.summary.total}</p>
              <input placeholder="Name" value={guestName} onChange={e => setGuestName(e.target.value)} />
              <input placeholder="Email" value={guestEmail} onChange={e => setGuestEmail(e.target.value)} />
              <input placeholder="Phone" value={guestPhone} onChange={e => setGuestPhone(e.target.value)} />
              <textarea placeholder="Notes" value={notes} onChange={e => setNotes(e.target.value)} />
              <button onClick={book} disabled={busy}>Book Now</button>
            </div>
          )}
        </div>
      </section>
    </>
  );
}


===== FILE: pages/api/realty/availability.js  (size=640 bytes) =====
// pages/api/realty/availability.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' });
  const { property_id } = req.query;
  if (!property_id) return res.status(400).json({ error: 'property_id required' });

  const { data, error } = await supabaseAdmin
    .from('property_availability')
    .select('*')
    .eq('property_id', property_id)
    .order('date');

  if (error) return res.status(500).json({ error: error.message });
  return res.status(200).json({ items: data });
}


===== FILE: pages/api/realty/book.js  (size=5569 bytes) =====
// pages/api/realty/book.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const {
      property_id,
      checkin,        // 'YYYY-MM-DD'
      checkout,       // 'YYYY-MM-DD' (exclusive)
      guests = 1,
      quote_total_cents,
      currency = 'usd',

      // guest details
      guestName,
      guestEmail,
      guestPhone,
      notes,

      includeDamageDeposit = false,
      success_url,
      cancel_url,

      // üî• NEW
      affiliate_ref,
    } = req.body || {};

    if (!property_id || !checkin || !checkout || !quote_total_cents) {
      return res.status(400).json({ error: 'Missing required fields' });
    }

    // helper to resolve affiliate
    async function getAffiliateInfo(refCode) {
      if (!refCode) return { affiliate_id: null, referral_code: null, commission_rate: null };
      const { data: affRow, error: affErr } = await supabaseAdmin
        .from('affiliates')
        .select('id, referral_code, commission_rate')
        .eq('referral_code', refCode)
        .maybeSingle();
      if (affErr || !affRow) {
        return { affiliate_id: null, referral_code: null, commission_rate: null };
      }
      return {
        affiliate_id: affRow.id,
        referral_code: affRow.referral_code,
        commission_rate: Number(affRow.commission_rate || 0),
      };
    }

    // Load property for deposit & name
    const { data: prop } = await supabaseAdmin
      .from('properties')
      .select('id, name, metadata')
      .eq('id', property_id)
      .maybeSingle();
    if (!prop) return res.status(404).json({ error: 'Property not found' });

    const meta = prop.metadata || {};
    const depositCents = includeDamageDeposit ? Number(meta.damage_deposit_cents || 0) : 0;

    // nights
    const nights = Math.max(
      1,
      Math.round(
        (new Date(checkout).getTime() - new Date(checkin).getTime()) / (1000 * 60 * 60 * 24)
      )
    );

    // figure affiliate commission (you can tweak calc: e.g. only on rent, not on deposit)
    const affInfo = await getAffiliateInfo(affiliate_ref);
    const subtotalCents = Number(quote_total_cents) + Number(depositCents || 0);
    // commission stored in dollars just like orders.commission_amount
    const commissionAmount =
      affInfo.commission_rate != null
        ? (subtotalCents / 100) * affInfo.commission_rate
        : 0;

    // Stripe line items
    const line_items = [
      {
        price_data: {
          currency,
          unit_amount: Number(quote_total_cents),
          product_data: {
            name: `${prop.name} ‚Äî ${checkin} ‚Üí ${checkout} (${nights} nights)`,
            metadata: { division: 'realty', property_id },
          },
        },
        quantity: 1,
      },
    ];

    if (depositCents > 0) {
      line_items.push({
        price_data: {
          currency,
          unit_amount: depositCents,
          product_data: {
            name: 'Damage Deposit (refundable)',
            metadata: { division: 'realty', property_id, type: 'deposit' },
          },
        },
        quantity: 1,
      });
    }

    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000';
    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      line_items,
      customer_email: guestEmail || undefined,
      success_url: success_url || `${baseUrl}/realty/booking-success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: cancel_url || `${baseUrl}/realty/booking-cancelled`,
      metadata: {
        type: 'realty_booking',
        property_id,
        checkin,
        checkout,
        guests: String(guests),
        nights: String(nights),
        guestName: guestName || '',
        guestEmail: guestEmail || '',
        guestPhone: guestPhone || '',
        notes: notes || '',
        includeDamageDeposit: includeDamageDeposit ? 'true' : 'false',

        // affiliate trail for webhook visibility
        affiliate_ref: affInfo.referral_code || '',
        affiliate_id: affInfo.affiliate_id || '',
        commission_rate: affInfo.commission_rate != null ? String(affInfo.commission_rate) : '',
      },
    });

    // Create or update pending reservation row keyed by session id
    await supabaseAdmin.from('realty_reservations').upsert(
      {
        property_id,
        checkin,
        checkout,
        nights,
        guests,
        status: 'pending',
        amount_cents: subtotalCents,
        currency,
        stripe_session_id: session.id,
        guest_name: guestName || null,
        guest_email: guestEmail || null,
        guest_phone: guestPhone || null,
        notes: notes || null,

        // üî• NEW affiliate tracking columns in DB
        affiliate_id: affInfo.affiliate_id,
        referral_code: affInfo.referral_code,
        commission_rate: affInfo.commission_rate,
        commission_amount: commissionAmount,
      },
      { onConflict: 'stripe_session_id' }
    );

    return res.status(200).json({ ok: true, url: session.url, session_id: session.id });
  } catch (e) {
    console.error('book error', e);
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/booking-success.js  (size=1433 bytes) =====
// pages/realty/booking-success.js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

export default function BookingSuccess() {
  const router = useRouter();
  const { session_id } = router.query;
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (session_id) {
      fetch(`/api/realty/booking-summary?session_id=${session_id}`)
        .then(res => res.json())
        .then(data => {
          setSummary(data);
          setLoading(false);
        })
        .catch(() => setLoading(false));
    }
  }, [session_id]);

  if (loading) return <div>Loading booking summary...</div>;

  return (
    <>
      <Head>
        <title>Booking Success ‚Äî Manyagi Realty</title>
      </Head>
      <section className="container mx-auto px-4 py-16 text-center">
        <h1 className="text-4xl font-bold mb-4">Booking Confirmed!</h1>
        {summary ? (
          <div>
            <p>Property: {summary.property}</p>
            <p>Check-in: {summary.checkin}</p>
            <p>Check-out: {summary.checkout}</p>
            <p>Guests: {summary.guests}</p>
            <p>Status: {summary.status}</p>
          </div>
        ) : (
          <p>Thank you for your booking. Check your email for details.</p>
        )}
      </section>
    </>
  );
}


===== FILE: pages/api/realty/booking-summary.js  (size=893 bytes) =====
// pages/api/realty/booking-summary.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' });
  const { session_id } = req.query;
  if (!session_id) return res.status(400).json({ error: 'session_id required' });

  const { data: resv } = await supabaseAdmin.from('realty_reservations').select('*').eq('stripe_session_id', session_id).maybeSingle();
  if (!resv) return res.status(404).json({ error: 'Reservation not found' });

  const { data: prop } = await supabaseAdmin.from('properties').select('name').eq('id', resv.property_id).maybeSingle();

  return res.status(200).json({
    property: prop?.name || 'Unknown',
    checkin: resv.checkin,
    checkout: resv.checkout,
    guests: resv.guests,
    status: resv.status,
  });
}


===== FILE: pages/api/realty/calendar-blocks.js  (size=2737 bytes) =====
// pages/api/realty/calendar-blocks.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Returns merged "unavailable" ranges for a property.
 *
 * Output:
 * {
 *   ok: true,
 *   blocks: [
 *     {
 *       start: '2025-11-26', // YYYY-MM-DD inclusive
 *       end:   '2025-11-30', // YYYY-MM-DD inclusive
 *       label: 'Booked' | 'External Block',
 *       kind:  'reservation' | 'external'
 *     }
 *   ]
 * }
 *
 * NOTE:
 * - Reservations: checkout is exclusive in DB, so we subtract 1 day
 *   and report that as inclusive `end`.
 * - External blocks: already inclusive starts_on..ends_on.
 */

export default async function handler(req, res) {
  if (req.method !== 'GET')
    return res.status(405).json({ error: 'Method not allowed' });

  const { property_id } = req.query || {};
  if (!property_id) {
    return res.status(400).json({ error: 'property_id required' });
  }

  try {
    // --- paid reservations ---
    const { data: reservations, error: resErr } = await supabaseAdmin
      .from('realty_reservations')
      .select('checkin, checkout, status')
      .eq('property_id', property_id)
      .eq('status', 'paid');

    if (resErr) {
      console.error('calendar-blocks reservations err', resErr.message);
    }

    // --- external blocks (Airbnb/VRBO etc synced) ---
    const { data: blocks, error: blkErr } = await supabaseAdmin
      .from('realty_external_blocks')
      .select('starts_on, ends_on, source')
      .eq('property_id', property_id);

    if (blkErr) {
      console.error('calendar-blocks blocks err', blkErr.message);
    }

    const out = [];

    // Reservations:
    // DB has checkin (inclusive) -> checkout (exclusive).
    // We'll make `end` = checkout-1day so UI can highlight those nights.
    (reservations || []).forEach((r) => {
      const start = r.checkin; // 'YYYY-MM-DD'
      const checkoutDate = new Date(r.checkout + 'T00:00:00Z');
      checkoutDate.setUTCDate(checkoutDate.getUTCDate() - 1);
      const end_display = checkoutDate.toISOString().slice(0, 10);

      out.push({
        start,
        end: end_display,
        label: 'Booked',
        kind: 'reservation',
      });
    });

    // External blocks are already inclusive
    (blocks || []).forEach((b) => {
      out.push({
        start: b.starts_on,
        end: b.ends_on,
        label: 'External Block',
        kind: 'external',
      });
    });

    return res.status(200).json({ ok: true, blocks: out });
  } catch (e) {
    console.error('calendar-blocks crash', e);
    return res
      .status(500)
      .json({ ok: false, error: e.message || 'internal error', blocks: [] });
  }
}


===== FILE: pages/api/realty/cleanup-holds.js  (size=544 bytes) =====
// pages/api/realty/cleanup-holds.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  // Delete pending reservations older than 30 min
  const threshold = new Date(Date.now() - 30 * 60 * 1000).toISOString();
  const { error } = await supabaseAdmin
    .from('realty_reservations')
    .delete()
    .eq('status', 'pending')
    .lt('created_at', threshold);

  if (error) return res.status(500).json({ error: error.message });
  return res.status(200).json({ ok: true });
}


===== FILE: pages/api/realty/create-checkout.js  (size=4171 bytes) =====
// pages/api/realty/create-checkout.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { calculateQuote } from './quote'; // reuse the logic, no internal fetch

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-06-20',
});

export default async function handler(req, res) {
  try {
    if (req.method !== 'POST')
      return res.status(405).json({ error: 'Method not allowed' });

    const {
      property_id,
      checkin,
      checkout,
      guests = 1,
      guest_name,
      guest_email,
      guest_phone,
      notes,
    } = req.body || {};

    if (
      !property_id ||
      !checkin ||
      !checkout ||
      !guest_name ||
      !guest_email
    ) {
      return res
        .status(400)
        .json({ error: 'Missing required fields' });
    }

    // 1. Load property row
    const { data: propRow, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('*')
      .eq('id', property_id)
      .maybeSingle();

    if (propErr)
      return res.status(500).json({ error: propErr.message });
    if (!propRow)
      return res.status(404).json({ error: 'property not found' });

    // 2. Load override rates for quote calculation
    const { data: rateRows, error: rateErr } = await supabaseAdmin
      .from('realty_rates')
      .select('*')
      .eq('property_id', property_id);

    if (rateErr)
      return res.status(500).json({ error: rateErr.message });

    // 3. Build quote on the server (NO fetch('/api/...'))
    const quote = calculateQuote({
      propRow,
      rates: rateRows || [],
      checkin,
      checkout,
    });

    if (!quote.ok) {
      return res
        .status(500)
        .json({ error: quote.error || 'Failed to build quote' });
    }

    const amountCents = Math.round(quote.summary.total * 100);
    const nightsCount = quote.summary.nights;

    // 4. Create "pending" reservation in Supabase
    const { data: reservation, error: resErr } = await supabaseAdmin
      .from('realty_reservations')
      .insert({
        property_id,
        checkin,
        checkout,
        nights: nightsCount,
        guests,
        guest_name,
        guest_email,
        guest_phone,
        notes,
        amount_cents: amountCents,
        currency: 'usd',
        status: 'pending',
      })
      .select('*')
      .maybeSingle();

    if (resErr)
      return res.status(500).json({ error: resErr.message });

    // 5. Create Stripe Checkout Session
    const successUrl = `${req.headers.origin}/realty/booking-success?session_id={CHECKOUT_SESSION_ID}`;
    // cancel should go back to the property detail, which is /realty/[slug]
    const cancelUrl = `${req.headers.origin}/realty/${propRow.slug}?cancelled=true`;

    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      line_items: [
        {
          price_data: {
            currency: 'usd',
            product_data: {
              name: `Booking: ${propRow.name}`,
              description: `Check-in ${checkin} ‚Üí Check-out ${checkout}`,
            },
            unit_amount: amountCents,
          },
          quantity: 1,
        },
      ],
      metadata: {
        type: 'realty_booking',
        reservation_id: reservation.id,
        property_id: property_id,
        checkin,
        checkout,
        guest_name,
        guest_email,
        guest_phone: guest_phone || '',
        notes: notes || '',
      },
      success_url: successUrl,
      cancel_url: cancelUrl,
    });

    // 6. Store Stripe session ID back on reservation
    await supabaseAdmin
      .from('realty_reservations')
      .update({ stripe_session_id: session.id })
      .eq('id', reservation.id);

    // 7. Send the Stripe hosted checkout URL back to frontend
    return res.status(200).json({ url: session.url });
  } catch (e) {
    console.error('create-checkout crash:', e);
    return res.status(500).json({
      error: e.message || 'checkout failed',
    });
  }
}


===== FILE: pages/api/realty/external-blocks.js  (size=1500 bytes) =====
// pages/api/realty/external-blocks.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method === 'GET') {
    const { property_id } = req.query;
    if (!property_id) return res.status(400).json({ error: 'property_id required' });
    const { data, error } = await supabaseAdmin
      .from('realty_external_blocks')
      .select('*')
      .eq('property_id', property_id);
    if (error) return res.status(500).json({ error: error.message });
    return res.status(200).json({ items: data });
  }

  if (req.method === 'POST') {
    const { property_id, starts_on, ends_on, source, uid } = req.body || {};
    if (!property_id || !starts_on || !ends_on || !source) return res.status(400).json({ error: 'required fields missing' });
    const { error } = await supabaseAdmin.from('realty_external_blocks').insert({ property_id, starts_on, ends_on, source, uid });
    if (error) return res.status(500).json({ error: error.message });
    return res.status(200).json({ ok: true });
  }

  if (req.method === 'DELETE') {
    const { id } = req.query;
    if (!id) return res.status(400).json({ error: 'id required' });
    const { error } = await supabaseAdmin.from('realty_external_blocks').delete().eq('id', id);
    if (error) return res.status(500).json({ error: error.message });
    return res.status(200).json({ ok: true });
  }

  return res.status(405).json({ error: 'Method not allowed' });
}


===== FILE: pages/api/realty/ical-export.js  (size=3420 bytes) =====
// pages/api/realty/ical-export.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const fmt = (d) => {
  const pad = (n) => String(n).padStart(2, '0');
  const y = d.getUTCFullYear();
  const m = pad(d.getUTCMonth() + 1);
  const day = pad(d.getUTCDate());
  const hh = pad(d.getUTCHours());
  const mm = pad(d.getUTCMinutes());
  const ss = pad(d.getUTCSeconds());
  return `${y}${m}${day}T${hh}${mm}${ss}Z`;
};

// Return VEVENT for a date range (all-day style, DTEND exclusive)
const vevent = ({ uid, start, end, summary }) => {
  const dtstamp = fmt(new Date());
  const dtstart = `${start.getUTCFullYear()}${String(start.getUTCMonth() + 1).padStart(2, '0')}${String(start.getUTCDate()).padStart(2, '0')}`;
  const dtend = `${end.getUTCFullYear()}${String(end.getUTCMonth() + 1).padStart(2, '0')}${String(end.getUTCDate()).padStart(2, '0')}`;
  return [
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${dtstamp}`,
    `DTSTART;VALUE=DATE:${dtstart}`,
    `DTEND;VALUE=DATE:${dtend}`,
    `SUMMARY:${summary || 'Reserved'}`,
    'TRANSP:OPAQUE',
    'END:VEVENT',
  ].join('\r\n');
};

export default async function handler(req, res) {
  try {
    const { property_id } = req.query || {};
    if (!property_id) {
      res.statusCode = 400;
      return res.end('Missing property_id');
    }

    // Property (for title)
    const { data: prop } = await supabaseAdmin
      .from('properties')
      .select('id,name')
      .eq('id', property_id)
      .maybeSingle();

    // Paid reservations
    const { data: paid } = await supabaseAdmin
      .from('realty_reservations')
      .select('id, checkin, checkout, status')
      .eq('property_id', property_id)
      .eq('status', 'paid');

    // External blocks
    const { data: blocks } = await supabaseAdmin
      .from('realty_external_blocks')
      .select('id, starts_on, ends_on, source')
      .eq('property_id', property_id);

    const events = [];

    (paid || []).forEach((r) => {
      const ci = new Date(r.checkin);
      const co = new Date(r.checkout); // checkout is exclusive
      events.push(
        vevent({
          uid: `${r.id}@manyagi`,
          start: ci,
          end: co,
          summary: `${prop?.name || 'Property'} ‚Äî Reserved`,
        })
      );
    });

    (blocks || []).forEach((b) => {
      const s = new Date(b.starts_on + 'T00:00:00Z');
      const e = new Date(b.ends_on + 'T00:00:00Z');
      // Make DTEND exclusive
      const eExclusive = new Date(e);
      eExclusive.setUTCDate(eExclusive.getUTCDate() + 1);
      events.push(
        vevent({
          uid: `${b.id}@manyagi-block`,
          start: s,
          end: eExclusive,
          summary: `${prop?.name || 'Property'} ‚Äî ${b.source || 'External Block'}`,
        })
      );
    });

    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      `PRODID:-//Manyagi Realty//Booking Calendar//EN`,
      `X-WR-CALNAME:${(prop?.name || 'Property') + ' ‚Äî Manyagi'}`,
      ...events,
      'END:VCALENDAR',
      '',
    ].join('\r\n');

    res.setHeader('Content-Type', 'text/calendar; charset=utf-8');
    res.setHeader('Content-Disposition', `attachment; filename="manyagi-${property_id}.ics"`);
    return res.status(200).send(ics);
  } catch (e) {
    return res.status(500).send('ICS error: ' + e.message);
  }
}


===== FILE: pages/api/realty/ical.js  (size=487 bytes) =====
// pages/api/realty/ical.js
export default async function handler(req, res) {
  try {
    const { url } = req.query;
    if (!url) return res.status(400).send('missing url');
    const r = await fetch(url);
    if (!r.ok) return res.status(502).send('ical fetch failed');
    const text = await r.text();
    res.setHeader('Content-Type', 'text/calendar; charset=utf-8');
    return res.status(200).send(text);
  } catch (e) {
    return res.status(500).send('error');
  }
}


===== FILE: pages/api/realty/lead.js  (size=1188 bytes) =====
// pages/api/realty/lead.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res
      .status(405)
      .json({ error: 'Method not allowed' });
  }

  try {
    const {
      name,
      email,
      phone,
      interest_type, // 'buy' | 'sell' | 'manage' | 'rental_inquiry' | 'other'
      notes,
      property_id,
    } = req.body || {};

    if (!name || !email || !interest_type) {
      return res
        .status(400)
        .json({ error: 'Missing required fields' });
    }

    const { error } = await supabaseAdmin
      .from('realty_leads')
      .insert({
        name,
        email,
        phone: phone || null,
        interest_type,
        notes: notes || null,
        property_id: property_id || null,
        status: 'new',
      });

    if (error) throw error;

    return res
      .status(200)
      .json({ ok: true, message: 'Lead captured.' });
  } catch (err) {
    console.error('lead capture error:', err);
    return res
      .status(500)
      .json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/realty/property.js  (size=3256 bytes) =====
// pages/api/realty/property.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

function sendJSON(res, status, payload) {
  res.status(status).json(payload);
}

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return sendJSON(res, 405, { error: 'Method not allowed' });
  }

  const { slug, all } = req.query;

  try {
    //
    // LIST MODE: /api/realty/property?all=1
    //
    if (all) {
      const { data, error } = await supabaseAdmin
        .from('properties')
        .select('*')
        .eq('division', 'realty')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('properties list error', error);
        return sendJSON(res, 500, { error: error.message });
      }

      const properties = (data || []).map((p) => ({
        id: p.id,
        name: p.name,
        slug: p.slug,
        description: p.description || '',
        nightly_price: Number(p.price || 0),
        image_url:
          (p.metadata && p.metadata.cover_url) ||
          (p.metadata && p.metadata.hero_url) ||
          '',
        metadata: p.metadata || {},
        created_at: p.created_at,
      }));

      return sendJSON(res, 200, { ok: true, properties });
    }

    //
    // DETAIL MODE: /api/realty/property?slug=...
    //
    if (!slug) {
      return sendJSON(res, 400, { error: 'slug required' });
    }

    const { data: rows, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('*')
      .eq('slug', slug)
      .limit(1);

    if (propErr) {
      console.error('property fetch error', propErr);
      return sendJSON(res, 500, { error: propErr.message });
    }

    const prop = rows && rows[0];
    if (!prop) {
      return sendJSON(res, 404, { error: 'Property not found' });
    }

    // pull gallery_urls array off metadata if present
    const gallery_urls = Array.isArray(prop.metadata?.gallery_urls)
      ? prop.metadata.gallery_urls
      : [];

    // normalize the property for frontend
    const property = {
      id: prop.id,
      name: prop.name,
      slug: prop.slug,
      description: prop.description || '',
      nightly_price: Number(prop.price || 0),
      image_url:
        (prop.metadata && prop.metadata.cover_url) ||
        (prop.metadata && prop.metadata.hero_url) ||
        '',
      metadata: prop.metadata || {},
      gallery_urls, // <-- NEW
    };

    // availability (optional table)
    let availability = [];
    try {
      const { data: availRows, error: aErr } = await supabaseAdmin
        .from('property_availability')
        .select('*')
        .eq('property_id', prop.id)
        .order('date');

      if (aErr) {
        console.warn('availability lookup error (non-fatal)', aErr.message);
      } else {
        availability = availRows || [];
      }
    } catch (innerErr) {
      console.warn('availability lookup threw (non-fatal)', innerErr);
    }

    return sendJSON(res, 200, { ok: true, property, availability });
  } catch (err) {
    console.error('unhandled property api error', err);
    return sendJSON(res, 500, { error: 'Server error' });
  }
}


===== FILE: pages/api/realty/quote.js  (size=5282 bytes) =====
// pages/api/realty/quote.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

// helper: iterate nights from checkin (inclusive) to checkout (exclusive)
function* dateRangeUTC(startISO, endISO) {
  const d = new Date(startISO + 'T00:00:00Z');
  const end = new Date(endISO + 'T00:00:00Z');
  for (; d < end; d.setUTCDate(d.getUTCDate() + 1)) {
    yield new Date(d);
  }
}

// helper: format YYYY-MM-DD in UTC
const ymd = (d) =>
  `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(
    d.getUTCDate()
  ).padStart(2, '0')}`;

/**
 * Build nightly pricing and enforce seasonal overrides.
 *
 * NEW: We now also calculate the min night requirement for the stay,
 * using the max() of any applicable min_nights for those dates.
 *
 * Returns { ok, nights[], summary{...}, min_nights_required, meets_min_stay, currency }
 */
export function calculateQuote({ propRow, rates, checkin, checkout }) {
  if (!propRow) {
    return { ok: false, error: 'missing property' };
  }

  const m = propRow.metadata || {};
  const pr = m.pricing || {};

  // base nightly, weekend override, fees/taxes
  const base =
    (typeof pr.base === 'number' ? pr.base : null) ?? Number(propRow.price || 0);
  const weekend = typeof pr.weekend === 'number' ? pr.weekend : null;
  const cleaningFee = Number(pr.cleaning_fee || 0);
  const taxRate = Number(pr.tax_rate || 0);

  // Track required min_nights across the stay
  // We'll take the max requirement across all nights in the quote.
  let requiredMinNights = 1; // default fallback
  const nights = [];

  for (const d of dateRangeUTC(checkin, checkout)) {
    const iso = ymd(d);

    // all override rows that cover this date
    const candidates = (rates || []).filter(
      (r) => iso >= r.start_date && iso <= r.end_date
    );

    // choose the top candidate by priority, then fallback to base
    candidates.sort((a, b) => (b.priority || 0) - (a.priority || 0));

    let nightly = candidates.length
      ? Number(candidates[0].nightly_rate)
      : base;

    // weekend logic if no seasonal override
    if (!candidates.length && weekend && [5, 6].includes(d.getUTCDay())) {
      nightly = weekend;
    }

    // ADDED:
    // pull min_nights from the chosen candidate and update requiredMinNights
    if (candidates.length) {
      const minN = candidates[0].min_nights
        ? Number(candidates[0].min_nights)
        : null;
      if (minN && minN > requiredMinNights) {
        requiredMinNights = minN;
      }
    }

    nights.push({ date: iso, nightly });
  }

  // money math
  const subtotal = nights.reduce((acc, n) => acc + Number(n.nightly), 0);
  const totalBeforeTax = subtotal + cleaningFee;
  const taxAmt =
    Math.round((totalBeforeTax * taxRate + Number.EPSILON) * 100) / 100;
  const total = totalBeforeTax + taxAmt;

  const stayLength = nights.length;

  // ADDED:
  // If no seasonal override enforced anything, we still might want a global min
  // For example, you might set metadata.pricing.min_nights = 2 in property.metadata.pricing
  const globalMinNights =
    typeof pr.min_nights === 'number' ? pr.min_nights : null;

  if (globalMinNights && globalMinNights > requiredMinNights) {
    requiredMinNights = globalMinNights;
  }

  // ADDED:
  const meetsMinStay = stayLength >= requiredMinNights;

  return {
    ok: true,
    currency: 'usd',
    nights,
    summary: {
      nights: stayLength,
      base_subtotal: subtotal,
      cleaning_fee: cleaningFee,
      tax_rate: taxRate,
      tax_amount: taxAmt,
      total,
    },
    // ADDED:
    min_nights_required: requiredMinNights,
    meets_min_stay: meetsMinStay,
  };
}

export default async function handler(req, res) {
  try {
    if (req.method !== 'POST')
      return res.status(405).json({ error: 'Method not allowed' });

    const { property_id, checkin, checkout } = req.body || {};

    if (!property_id || !checkin || !checkout) {
      return res.status(400).json({
        error:
          'property_id, checkin, checkout required (YYYY-MM-DD)',
      });
    }

    // Load property
    const { data: propRow, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('*')
      .eq('id', property_id)
      .maybeSingle();

    if (propErr)
      return res.status(500).json({ error: propErr.message });
    if (!propRow)
      return res.status(404).json({ error: 'property not found' });

    // Load seasonal / override rates
    const { data: rateRows, error: rateErr } = await supabaseAdmin
      .from('realty_rates')
      .select('*')
      .eq('property_id', property_id);

    if (rateErr)
      return res.status(500).json({ error: rateErr.message });

    const quote = calculateQuote({
      propRow,
      rates: rateRows || [],
      checkin,
      checkout,
    });

    if (!quote.ok) {
      return res
        .status(500)
        .json({ error: quote.error || 'quote failed' });
    }

    return res.status(200).json(quote);
  } catch (e) {
    console.error('quote handler crash:', e);
    res
      .status(500)
      .json({ error: e.message || 'internal error' });
  }
}


===== FILE: pages/api/realty/rates.js  (size=2199 bytes) =====
// pages/api/realty/rates.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  try {
    // ---- GET ----
    if (req.method === 'GET') {
      const { property_id } = req.query;
      if (!property_id)
        return res.status(400).json({ error: 'property_id required' });

      const { data, error } = await supabaseAdmin
        .from('realty_rates')
        .select('*')
        .eq('property_id', property_id)
        .order('start_date', { ascending: true });

      if (error) throw error;
      return res.status(200).json({ ok: true, items: data || [] });
    }

    // ---- POST ----
    if (req.method === 'POST') {
      const body =
        typeof req.body === 'string' ? JSON.parse(req.body) : req.body;
      const {
        property_id,
        start_date,
        end_date,
        nightly_rate,
        min_nights,
        priority,
        notes,
      } = body || {};

      if (!property_id || !start_date || !end_date || !nightly_rate)
        return res.status(400).json({ error: 'missing required fields' });

      const { error } = await supabaseAdmin.from('realty_rates').insert({
        property_id,
        start_date,
        end_date,
        nightly_rate: Number(nightly_rate),
        min_nights: min_nights ? Number(min_nights) : null,
        priority: priority ? Number(priority) : 0,
        notes: notes || '',
      });

      if (error) throw error;
      return res.status(200).json({ ok: true });
    }

    // ---- DELETE ----
    if (req.method === 'DELETE') {
      const { id } = req.query;
      if (!id) return res.status(400).json({ error: 'id required' });

      const { error } = await supabaseAdmin
        .from('realty_rates')
        .delete()
        .eq('id', id);

      if (error) throw error;
      return res.status(200).json({ ok: true });
    }

    res.setHeader('Allow', ['GET', 'POST', 'DELETE']);
    return res.status(405).json({ error: `Method ${req.method} not allowed` });
  } catch (e) {
    console.error('realty/rates error:', e);
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/reservations-admin.js  (size=3249 bytes) =====
// pages/api/realty/reservations-admin.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Admin-facing fetch of upcoming / recent reservations.
 *
 * Returns:
 * [
 *   {
 *     id,
 *     property_id,
 *     property_name,
 *     property_slug,
 *     checkin,
 *     checkout,
 *     nights,
 *     guests,
 *     guest_name,
 *     guest_email,
 *     amount_cents,
 *     currency,
 *     status,
 *     notes,
 *     created_at,
 *   },
 *   ...
 * ]
 *
 * NOTE: This assumes only admins can load /admin (which you already enforce),
 * so we're not doing auth checks here. Do not expose this to public UI.
 */

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // pull reservations
    const { data: reservations, error: rErr } = await supabaseAdmin
      .from('realty_reservations')
      .select(
        `
        id,
        property_id,
        checkin,
        checkout,
        nights,
        guests,
        guest_name,
        guest_email,
        guest_phone,
        notes,
        amount_cents,
        currency,
        status,
        stripe_session_id,
        created_at
      `
      )
      .order('checkin', { ascending: true });

    if (rErr) {
      console.error('reservations-admin fetch error:', rErr.message);
      return res.status(500).json({ error: rErr.message });
    }

    if (!reservations || reservations.length === 0) {
      return res.status(200).json({ ok: true, items: [] });
    }

    // gather property_ids
    const propIds = Array.from(
      new Set(reservations.map((r) => r.property_id).filter(Boolean))
    );

    // fetch property metadata for name/slug
    const { data: props, error: pErr } = await supabaseAdmin
      .from('properties')
      .select('id, name, slug')
      .in('id', propIds);

    if (pErr) {
      console.error('reservations-admin property join error:', pErr.message);
      return res.status(500).json({ error: pErr.message });
    }

    const propMap = {};
    (props || []).forEach((p) => {
      propMap[p.id] = {
        name: p.name || '(unnamed)',
        slug: p.slug || null,
      };
    });

    // normalize + decorate each reservation we return to the dashboard
    const items = reservations.map((r) => {
      const propInfo = propMap[r.property_id] || {};
      return {
        id: r.id,
        property_id: r.property_id,
        property_name: propInfo.name,
        property_slug: propInfo.slug,
        checkin: r.checkin,
        checkout: r.checkout,
        nights: r.nights,
        guests: r.guests,
        guest_name: r.guest_name,
        guest_email: r.guest_email,
        guest_phone: r.guest_phone,
        notes: r.notes,
        amount_cents: r.amount_cents,
        currency: r.currency || 'usd',
        status: r.status,
        created_at: r.created_at,
      };
    });

    return res.status(200).json({ ok: true, items });
  } catch (e) {
    console.error('reservations-admin crash:', e);
    return res.status(500).json({ error: e.message || 'internal error' });
  }
}


===== FILE: pages/api/realty/send-booking-confirmation.js  (size=1538 bytes) =====
// pages/api/realty/send-booking-confirmation.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';
import { sendBookingReceipt } from '@/lib/emails/bookingReceipt';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  const { session_id } = req.body;
  if (!session_id) return res.status(400).json({ error: 'session_id required' });

  const { data: resv } = await supabaseAdmin.from('realty_reservations').select('*').eq('stripe_session_id', session_id).maybeSingle();
  if (!resv) return res.status(404).json({ error: 'Reservation not found' });

  const { data: prop } = await supabaseAdmin.from('properties').select('name').eq('id', resv.property_id).maybeSingle();

  try {
    await sendItineraryEmail({
      guestName: resv.guest_name,
      to: resv.guest_email,
      property: prop?.name || 'Property',
      checkin: resv.checkin,
      checkout: resv.checkout,
      guests: resv.guests,
      replyTo: 'realty@manyagi.net',
    });

    await sendBookingReceipt({
      guestName: resv.guest_name,
      to: resv.guest_email,
      property: prop?.name || 'Property',
      checkin: resv.checkin,
      checkout: resv.checkout,
      guests: resv.guests,
      replyTo: 'realty@manyagi.net',
    });

    return res.status(200).json({ ok: true });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/sync-ical.js  (size=3803 bytes) =====
// pages/api/realty/sync-ical.js
// Fetch external ICS feeds from property.ical_urls (array of URLs) and upsert blocks
import { supabaseAdmin } from '@/lib/supabaseAdmin';

function parseIcsDate(v) {
  // supports VALUE=DATE (YYYYMMDD) and UTC date-time
  const m = String(v).trim();
  if (/^\\d{8}$/.test(m)) {
    const y = Number(m.slice(0, 4));
    const mm = Number(m.slice(4, 6)) - 1;
    const d = Number(m.slice(6, 8));
    return new Date(Date.UTC(y, mm, d, 0, 0, 0));
  }
  // try basic YYYYMMDDTHHMMSSZ
  const iso = m.replace(
    /^(\d{4})(\d{2})(\d{2})T?(\d{2})(\d{2})(\d{2})Z$/,
    '$1-$2-$3T$4:$5:$6Z'
  );
  const dt = new Date(iso);
  if (!isNaN(dt)) return dt;
  return null;
}

function extractEvents(icsText) {
  const blocks = icsText.split(/BEGIN:VEVENT/gi).slice(1);
  const events = [];
  blocks.forEach((raw) => {
    const seg = 'BEGIN:VEVENT' + raw;
    const endIdx = seg.indexOf('END:VEVENT');
    const vevent = seg.slice(0, endIdx);
    const lines = vevent.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
    let dtstart, dtend, uid, summary = '';
    lines.forEach((ln) => {
      if (ln.startsWith('UID:')) uid = ln.slice(4);
      if (ln.startsWith('SUMMARY:')) summary = ln.slice(8);
      if (ln.startsWith('DTSTART')) {
        const val = ln.split(':')[1];
        dtstart = parseIcsDate(val);
      }
      if (ln.startsWith('DTEND')) {
        const val = ln.split(':')[1];
        dtend = parseIcsDate(val);
      }
    });
    if (dtstart && dtend) {
      events.push({ uid, summary, dtstart, dtend });
    }
  });
  return events;
}

const ymd = (d) => d.toISOString().slice(0, 10);

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const { property_id } = req.body || {};
    if (!property_id) return res.status(400).json({ error: 'property_id required' });

    // Load property to get feeds
    const { data: prop, error: pErr } = await supabaseAdmin
      .from('properties')
      .select('id, metadata')
      .eq('id', property_id)
      .maybeSingle();
    if (pErr) throw pErr;
    if (!prop) return res.status(404).json({ error: 'Property not found' });

    const feeds = (prop.metadata?.ical_urls || []).filter(Boolean);
    if (!feeds.length) return res.status(200).json({ ok: true, imported: 0, feeds: 0 });

    let imported = 0;

    for (const url of feeds) {
      const r = await fetch(url);
      if (!r.ok) continue;
      const text = await r.text();
      const events = extractEvents(text);

      // Clear previous blocks for this source (optional: keep rolling window)
      await supabaseAdmin
        .from('realty_external_blocks')
        .delete()
        .eq('property_id', property_id)
        .eq('source', url);

      const rows = [];
      for (const ev of events) {
        // many channel feeds use DTEND exclusive; make the inclusive date:
        const dtend = new Date(ev.dtend);
        dtend.setUTCDate(dtend.getUTCDate() - 1);
        rows.push({
          property_id,
          starts_on: ymd(ev.dtstart),
          ends_on: ymd(dtend),
          source: url,
          uid: ev.uid || null,
        });
      }
      if (rows.length) {
        // insert in chunks
        const chunk = 500;
        for (let i = 0; i < rows.length; i += chunk) {
          const slice = rows.slice(i, i + chunk);
          await supabaseAdmin.from('realty_external_blocks').insert(slice);
        }
        imported += rows.length;
      }
    }

    return res.status(200).json({ ok: true, feeds: feeds.length, imported });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/test-email.js  (size=1009 bytes) =====
// pages/api/realty/test-email.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  const { property_id, email } = req.body;
  if (!property_id || !email) return res.status(400).json({ error: 'property_id and email required' });

  const { data: prop } = await supabaseAdmin.from('properties').select('name').eq('id', property_id).maybeSingle();
  if (!prop) return res.status(404).json({ error: 'Property not found' });

  try {
    await sendItineraryEmail({
      guestName: 'Test Guest',
      to: email,
      property: prop.name,
      checkin: '2025-10-25',
      checkout: '2025-10-28',
      guests: 2,
    });
    return res.status(200).json({ ok: true, message: 'Test email sent' });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/upcoming.js  (size=2898 bytes) =====
// pages/api/realty/upcoming.js
//
// Returns upcoming (future or current) paid reservations so you,
// the host, can see who is coming and when.
//
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // "today" in YYYY-MM-DD for filtering
    const todayISO = new Date().toISOString().slice(0, 10);

    // 1. get paid reservations that haven't ended yet
    const { data: reservations, error: resErr } = await supabaseAdmin
      .from('realty_reservations')
      .select(
        `
        id,
        property_id,
        checkin,
        checkout,
        guests,
        guest_name,
        guest_email,
        guest_phone,
        amount_cents,
        currency,
        status
      `
      )
      .eq('status', 'paid')
      // checkout is the last night+1 (guest leaves that morning),
      // we want anything where checkout >= today
      .gte('checkout', todayISO)
      .order('checkin', { ascending: true });

    if (resErr) {
      console.error('[upcoming] reservations error:', resErr.message);
      return res.status(500).json({ error: resErr.message });
    }

    if (!reservations || reservations.length === 0) {
      return res.status(200).json({ ok: true, stays: [] });
    }

    // 2. get unique property_ids so we can attach property names/slugs
    const propIds = [...new Set(reservations.map((r) => r.property_id))];

    const { data: props, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('id, name, slug')
      .in('id', propIds);

    if (propErr) {
      console.error('[upcoming] props error:', propErr.message);
      return res.status(500).json({ error: propErr.message });
    }

    const propMap = {};
    (props || []).forEach((p) => {
      propMap[p.id] = {
        name: p.name,
        slug: p.slug,
      };
    });

    // 3. normalize stays for frontend
    const stays = reservations.map((r) => ({
      id: r.id,
      property_id: r.property_id,
      property_name: propMap[r.property_id]?.name || 'Property',
      property_slug: propMap[r.property_id]?.slug || r.property_id,
      checkin: r.checkin,
      checkout: r.checkout,
      guests: r.guests,
      guest_name: r.guest_name || '‚Äî',
      guest_email: r.guest_email || '‚Äî',
      guest_phone: r.guest_phone || '‚Äî',
      amount: r.amount_cents
        ? (Number(r.amount_cents) / 100).toFixed(2)
        : '0.00',
      currency: r.currency || 'usd',
      status: r.status,
    }));

    return res.status(200).json({ ok: true, stays });
  } catch (e) {
    console.error('[upcoming] crash:', e);
    return res.status(500).json({ error: e.message || 'internal error' });
  }
}


===== FILE: pages/api/realty/webhook.js  (size=3948 bytes) =====
// pages/api/realty/webhook.js
import Stripe from 'stripe';
import { buffer } from 'micro';
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';
import { sendBookingReceipt } from '@/lib/emails/bookingReceipt';

// We need the raw body for Stripe signature verification
export const config = {
  api: {
    bodyParser: false,
  },
};

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-06-20',
});

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).send('Method not allowed');
  }

  let event;
  const sig = req.headers['stripe-signature'];

  let buf;
  try {
    buf = await buffer(req);
  } catch (e) {
    console.error('Webhook: failed to read buffer', e);
    return res.status(400).send(`Webhook Error: ${e.message}`);
  }

  try {
    event = stripe.webhooks.constructEvent(
      buf,
      sig,
      process.env.STRIPE_WEBHOOK_SECRET // <-- set this in env
    );
  } catch (err) {
    console.error('Webhook signature verify failed:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // We only really care about a successful Checkout payment
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;

    // We stored these in create-checkout.js metadata
    const {
      reservation_id,
      property_id,
      checkin,
      checkout,
      guest_name,
      guest_email,
      guest_phone,
      notes,
    } = session.metadata || {};

    try {
      // 1. Mark reservation as paid
      const { error: updErr } = await supabaseAdmin
        .from('realty_reservations')
        .update({
          status: 'paid',
        })
        .eq('id', reservation_id);

      if (updErr) {
        console.error('Webhook: failed to update reservation:', updErr.message);
      }

      // 2. Load property details for email context
      const { data: propRow, error: propErr } = await supabaseAdmin
        .from('properties')
        .select('name')
        .eq('id', property_id)
        .maybeSingle();

      if (propErr) {
        console.error('Webhook: property lookup err', propErr.message);
      }

      // 3. Send itinerary email (guest gets arrival details)
      try {
        await sendItineraryEmail({
          guestName: guest_name || 'Guest',
          to: guest_email,
          property: propRow?.name || 'Property',
          checkin,
          checkout,
          guests: session.metadata?.guests || '1',
          replyTo: 'realty@manyagi.net',
        });
      } catch (e) {
        console.error('Webhook: itinerary email failed', e);
      }

      // 4. Send receipt email (basic confirmation / thank you)
      try {
        await sendBookingReceipt({
          guestName: guest_name || 'Guest',
          to: guest_email,
          property: propRow?.name || 'Property',
          checkin,
          checkout,
          guests: session.metadata?.guests || '1',
          replyTo: 'realty@manyagi.net',
        });
      } catch (e) {
        console.error('Webhook: receipt email failed', e);
      }

      // 5. (Optional) You could also insert into property_availability here
      // so your frontend calendar shows it as blocked. We will instead expose
      // paid reservations via /api/realty/calendar-blocks.js.

      console.log(
        `[Realty] Reservation ${reservation_id} marked paid for ${propRow?.name}`
      );
    } catch (e) {
      console.error('Webhook crashed:', e);
      // We purposely do NOT fail the webhook with 500 because Stripe will retry.
      // Returning 200 tells Stripe we're good. If you want retries, return 400/500.
    }
  }

  // Stripe requires 2xx fast
  res.status(200).json({ received: true });
}


===== FILE: pages/api/site-config.js  (size=460 bytes) =====
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(_req, res) {
  try {
    const { data, error } = await supabaseAdmin.from('site_config').select('*');
    if (error) throw error;
    const map = (data || []).reduce((acc, row) => { acc[row.key] = row.value; return acc; }, {});
    res.status(200).json(map);
  } catch (e) {
    console.error('site-config error:', e);
    res.status(200).json({});
  }
}


===== FILE: pages/api/stripe-webhook.js  (size=20966 bytes) =====
// pages/api/stripe-webhook.js
import { buffer } from "micro";
import Stripe from "stripe";
import axios from "axios";
import { supabaseAdmin } from "@/lib/supabaseAdmin";
import { createPrintfulOrder } from "@/lib/printful";
import { sendEmail } from "@/lib/sendEmail";
import { sendItineraryEmail } from "@/lib/emails/itineraryEmail";
import { sendBookingReceipt } from "@/lib/emails/bookingReceipt";

export const config = { api: { bodyParser: false } };

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: "2024-06-20" });
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;
const telegramBotToken = process.env.TELEGRAM_BOT_TOKEN;
const telegramGroupChatId = process.env.TELEGRAM_GROUP_CHAT_ID;

// ===== helpers (non-breaking) =====
const safeStr = (v) => String(v ?? "").trim();
const lower = (v) => safeStr(v).toLowerCase();

const ACCESS_TIERS = ["public", "priority", "producer", "packaging"];
const TIER_RANK = { public: 0, priority: 1, producer: 2, packaging: 3 };
const normalizeTier = (t) => {
  const v = lower(t);
  return ACCESS_TIERS.includes(v) ? v : "public";
};
const rank = (t) => TIER_RANK[normalizeTier(t)] ?? 0;
const bestTier = (a, b) => (rank(a) >= rank(b) ? normalizeTier(a) : normalizeTier(b));
const maxIsoDate = (aIso, bIso) => {
  const a = aIso ? new Date(aIso) : null;
  const b = bIso ? new Date(bIso) : null;
  if (!a && !b) return null;
  if (!a) return b.toISOString();
  if (!b) return a.toISOString();
  return (a > b ? a : b).toISOString();
};

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).json({ error: "Method not allowed" });

  // ‚úÖ Guard: missing webhook secret should fail loudly (prevents silent unlock failures)
  if (!webhookSecret) {
    console.error("[stripe-webhook] Missing STRIPE_WEBHOOK_SECRET");
    return res.status(500).json({ error: "Server misconfigured (missing webhook secret)" });
  }

  // 1. Verify Stripe signature against the raw body
  const buf = await buffer(req);
  const sig = req.headers["stripe-signature"];

  if (!sig) {
    return res.status(400).json({ error: "Missing Stripe signature header" });
  }

  let event;
  try {
    event = stripe.webhooks.constructEvent(buf, sig, webhookSecret);
  } catch (err) {
    return res.status(400).json({ error: `Webhook Error: ${err.message}` });
  }

  try {
    switch (event.type) {
      case "checkout.session.completed": {
        // pull full session w/ expansions so we get payment info
        // ‚úÖ FIX: DO NOT expand shipping_details (Stripe does not allow expanding it)
        // customer_details + shipping_details are already included on the session payload when present.
        const session = await stripe.checkout.sessions.retrieve(event.data.object.id, {
          expand: ["payment_intent"],
        });

        //
        // ========== REALTY BOOKING FLOW ==========
        //
        if (session?.metadata?.type === "realty_booking") {
          // Metadata your checkout added in /api/realty/create-checkout
          const {
            reservation_id,
            property_id,
            checkin,
            checkout,
            guests,
            guest_name,
            guest_email,
            guest_phone,
            notes,
          } = session.metadata || {};

          // Amount + currency actually charged
          const amountCents = session.amount_total ?? null;
          const currency = session.currency ?? "usd";

          // 1) Mark reservation row as paid (and attach info)
          await supabaseAdmin
            .from("realty_reservations")
            .update({
              status: "paid",
              updated_at: new Date().toISOString(),
              amount_cents: amountCents,
              currency,
              stripe_session_id: session.id,
              stripe_payment_intent: session.payment_intent || null,
              guest_name: guest_name || null,
              guest_email: guest_email || null,
              guest_phone: guest_phone || null,
              notes: notes || null,
            })
            .eq("id", reservation_id || "")
            .eq("property_id", property_id || "");

          // 2) Get property info for emails / ICS
          const { data: prop } = await supabaseAdmin
            .from("properties")
            .select("id, name, slug, metadata")
            .eq("id", property_id)
            .maybeSingle();

          const propName = prop?.name || "Your Stay";
          const publicSlug = prop?.slug || prop?.metadata?.slug || property_id;
          const site = process.env.NEXT_PUBLIC_SITE_URL || "https://manyagi.net";

          // calendar feed (ics) for guest
          const icsUrl = `${site}/api/realty/ical-export?property_id=${property_id}`;
          const detailsUrl = `${site}/realty/${publicSlug}`;

          // 3) Send itinerary email (arrival details)
          if (guest_email) {
            try {
              await sendItineraryEmail({
                guestName: guest_name || "Guest",
                to: guest_email,
                property: propName,
                checkin,
                checkout,
                guests,
                replyTo: process.env.SUPPORT_EMAIL || "realty@manyagi.net",
              });
            } catch (e) {
              console.warn("sendItineraryEmail failed:", e.message);
            }

            // 4) Send booking receipt / thank you
            try {
              await sendBookingReceipt({
                guestName: guest_name || "Guest",
                to: guest_email,
                property: propName,
                checkin,
                checkout,
                guests,
                replyTo: process.env.SUPPORT_EMAIL || "realty@manyagi.net",
              });
            } catch (e) {
              console.warn("sendBookingReceipt failed:", e.message);
            }

            // 5) (Optional) fallback transactional email using generic sendEmail
            try {
              const html = `
                <h1>Your Manyagi stay is confirmed ‚úÖ</h1>
                <p><strong>${propName}</strong></p>
                <p>Check-in: ${checkin}</p>
                <p>Check-out: ${checkout}</p>
                <p>Guests: ${guests}</p>
                <p>View property: <a href="${detailsUrl}">${detailsUrl}</a></p>
                <p>Add to Calendar (ICS): <a href="${icsUrl}">${icsUrl}</a></p>
                <p>We‚Äôll be in touch with arrival details.</p>
              `;
              await sendEmail({
                to: guest_email,
                subject: "Your Manyagi stay is confirmed",
                html,
              });
            } catch (e) {
              console.warn("sendEmail fallback failed:", e.message);
            }
          }

          break;
        }

        //
        // ========== MANYAGI STUDIOS ACCESS (DIGITAL ENTITLEMENT) ==========
        //
        if (session?.metadata?.type === "studio_access") {
          const universe_id = session?.metadata?.universe_id || null;
          const tier = lower(session?.metadata?.tier || "");
          const user_id = session?.metadata?.user_id || null;
          const universe_slug = session?.metadata?.universe_slug || null;

          if (!universe_id || !user_id || !tier) {
            console.warn("[studio_access] Missing required metadata", session?.metadata);
            break; // don‚Äôt fall into merch flow
          }

          // Optional: set evaluation windows by tier (change anytime)
          const now = new Date();
          const computedExpires = new Date(now);

          // choose your windows; these match what you described earlier
          if (tier === "priority") computedExpires.setDate(computedExpires.getDate() + 45);
          else if (tier === "producer") computedExpires.setDate(computedExpires.getDate() + 90);
          else if (tier === "packaging") computedExpires.setFullYear(computedExpires.getFullYear() + 1);
          else {
            console.warn("[studio_access] Invalid tier in metadata:", tier);
            break;
          }

          try {
            // ‚úÖ Improvement (non-breaking): preserve best tier AND never shorten an existing expiry
            const { data: existing, error: existingErr } = await supabaseAdmin
              .from("studio_entitlements")
              .select("tier, expires_at")
              .eq("user_id", user_id)
              .eq("universe_id", universe_id)
              .maybeSingle();

            if (existingErr) {
              console.warn("[studio_access] existing entitlement lookup failed:", existingErr.message);
            }

            const finalTier = existing?.tier ? bestTier(existing.tier, tier) : normalizeTier(tier);

            // never shorten expiry if user already had longer window
            const finalExpiresIso = maxIsoDate(existing?.expires_at, computedExpires.toISOString());

            // ‚úÖ FIX: Upsert by the REAL identity (user_id, universe_id) ‚Äî requires your unique index
            const { error: upsertErr } = await supabaseAdmin.from("studio_entitlements").upsert(
              {
                user_id,
                universe_id,
                entitlement: "studio_access", // ‚úÖ required entitlement marker for studio access
                tier: finalTier,
                status: "active",
                expires_at: finalExpiresIso,
                stripe_session_id: session.id,
                stripe_customer_id: session.customer ? String(session.customer) : null,
                updated_at: new Date().toISOString(),
              },
              { onConflict: "user_id,universe_id" }
            );

            if (upsertErr) {
              console.error("[studio_access] upsert error:", upsertErr.message);
              throw upsertErr;
            }
          } catch (dbErr) {
            console.error("[studio_access] upsert failed:", dbErr?.message || dbErr);
            throw dbErr;
          }

          // ‚úÖ FIX: Mark the studio order paid so it doesn't stay pending
          try {
            await supabaseAdmin
              .from("orders")
              .update({ status: "paid", updated_at: new Date().toISOString() })
              .eq("stripe_session_id", session.id);
          } catch (e) {
            console.warn("[studio_access] orders update failed:", e?.message || e);
          }

          // ‚úÖ OPTIONAL: email receipt/access (safe + uses universe_slug if present)
          const to = session?.customer_details?.email;
          if (to) {
            try {
              const site = process.env.NEXT_PUBLIC_SITE_URL || "https://manyagi.net";
              const link = universe_slug ? `${site}/studios/${universe_slug}` : `${site}/studios`;

              const prettyTier =
                tier === "priority"
                  ? "Priority Window"
                  : tier === "producer"
                  ? "Producer Packet"
                  : tier === "packaging"
                  ? "Packaging Track"
                  : tier;

              const html = `
                <h1>Access Granted ‚úÖ</h1>
                <p>Your <strong>${prettyTier}</strong> access is active.</p>
                <p>Expires: <strong>${new Date(maxIsoDate(null, computedExpires.toISOString())).toLocaleDateString()}</strong></p>
                <p><a href="${link}">Open your studio package</a></p>
                <p style="opacity:.75;font-size:12px">
                  Tip: Your downloads are inside the unlocked pages under the Attachments links.
                </p>
              `;

              await sendEmail({
                to,
                subject: "Manyagi Studios ‚Äî Access Granted",
                html,
              });
            } catch (e) {
              console.warn("[studio_access] sendEmail failed:", e?.message || e);
            }
          }

          break; // IMPORTANT: stop here so it doesn't fall into Printful flow
        }

        //
        // ========== PHYSICAL MERCH (Printful) ==========
        //
        {
          const email = session?.customer_details?.email || null;
          const name = session?.customer_details?.name || null;
          const addr = session?.shipping_details?.address || null;

          // mark normal product order paid
          await supabaseAdmin
            .from("orders")
            .update({
              status: "paid",
              customer_email: email,
              customer_name: name,
              shipping_snapshot: addr
                ? {
                    line1: addr.line1 || "",
                    line2: addr.line2 || "",
                    city: addr.city || "",
                    state: addr.state || "",
                    postal_code: addr.postal_code || "",
                    country: addr.country || "",
                  }
                : null,
              updated_at: new Date().toISOString(),
            })
            .eq("stripe_session_id", session.id);

          try {
            const { data: orderRow } = await supabaseAdmin
              .from("orders")
              .select("*")
              .eq("stripe_session_id", session.id)
              .maybeSingle();

            if (orderRow) {
              const { data: product } = await supabaseAdmin
                .from("products")
                .select("*")
                .eq("id", orderRow.product_id)
                .maybeSingle();

              const meta = product?.metadata || {};
              const syncVariantId = meta.printful_sync_variant_id || meta.printful_sync_variant || null;

              const haveShippingAddress = Boolean(session?.shipping_details?.address?.line1);

              if (syncVariantId && haveShippingAddress) {
                const a = session.shipping_details.address;
                const recipient = {
                  name: session?.customer_details?.name || "Customer",
                  address1: a.line1 || "",
                  address2: a.line2 || "",
                  city: a.city || "",
                  state_code: a.state || "",
                  country_code: a.country || "US",
                  zip: a.postal_code || "",
                  phone: session?.customer_details?.phone || "",
                  email: session?.customer_details?.email || "",
                };

                const qty = Math.max(1, Number(orderRow?.quantity || 1));
                const items = [
                  {
                    sync_variant_id: Number(syncVariantId),
                    quantity: qty,
                  },
                ];

                const packingSlip = {
                  email: "support@manyagi.net",
                  phone: "",
                  message: "Thank you for supporting Manyagi!",
                };

                try {
                  const pf = await createPrintfulOrder({
                    externalId: session.id,
                    recipient,
                    items,
                    packingSlip,
                  });

                  await supabaseAdmin
                    .from("orders")
                    .update({
                      fulfillment_provider: "printful",
                      fulfillment_status: pf?.status || "submitted",
                      fulfillment_id: pf?.id ? String(pf.id) : null,
                      updated_at: new Date().toISOString(),
                    })
                    .eq("stripe_session_id", session.id);
                } catch (pfErr) {
                  await supabaseAdmin
                    .from("orders")
                    .update({
                      fulfillment_provider: "printful",
                      fulfillment_status: "error",
                      fulfillment_error: String(pfErr?.response?.data?.error || pfErr.message || "unknown"),
                      updated_at: new Date().toISOString(),
                    })
                    .eq("stripe_session_id", session.id);

                  console.warn("Printful error:", pfErr?.response?.data || pfErr.message);
                }
              }
            }
          } catch (fulfillErr) {
            console.warn("Fulfillment skipped:", fulfillErr?.response?.data || fulfillErr.message);
          }
        }

        break;
      }

      //
      // ========== TELEGRAM SUBSCRIPTIONS / SIGNALS ==========
      //
      case "customer.subscription.created": {
        const subscription = event.data.object;
        const customer = await stripe.customers.retrieve(subscription.customer);
        const telegramId = subscription?.metadata?.telegramId || customer?.metadata?.telegramId;

        if (telegramId && !isNaN(telegramId)) {
          try {
            await axios.post(`https://api.telegram.org/bot${telegramBotToken}/unbanChatMember`, {
              chat_id: telegramGroupChatId,
              user_id: telegramId,
            });
          } catch (tgErr) {
            console.warn("Telegram unban (created) error:", tgErr?.response?.data || tgErr.message);
          }
        }
        break;
      }

      case "invoice.paid": {
        const invoice = event.data.object;
        const customerId = invoice.customer;
        const subId = invoice.subscription;

        const [subscription, customer] = await Promise.all([
          subId ? stripe.subscriptions.retrieve(subId) : null,
          customerId ? stripe.customers.retrieve(customerId) : null,
        ]);

        const telegramId =
          subscription?.metadata?.telegramId || customer?.metadata?.telegramId || invoice?.metadata?.telegramId;

        if (!telegramId || isNaN(telegramId)) {
          console.warn(`[stripe-webhook] Missing/invalid Telegram ID, event=${event.type}, invoice=${invoice.id}`);
          break;
        }

        try {
          await axios.post(`https://api.telegram.org/bot${telegramBotToken}/unbanChatMember`, {
            chat_id: telegramGroupChatId,
            user_id: telegramId,
          });
        } catch (tgErr) {
          console.warn("Telegram unban error:", tgErr?.response?.data || tgErr.message);
        }

        const periodStart = subscription?.current_period_start
          ? new Date(subscription.current_period_start * 1000).toISOString()
          : new Date().toISOString();
        const periodEnd = subscription?.current_period_end
          ? new Date(subscription.current_period_end * 1000).toISOString()
          : null;

        await supabaseAdmin.from("subscriptions").upsert({
          stripe_subscription_id: subId || null,
          user_id: null,
          status: "active",
          plan_type: "Basic Signals",
          division: "capital",
          current_period_start: periodStart,
          current_period_end: periodEnd,
          telegram_id: String(telegramId),
          created_at: new Date().toISOString(),
        });

        try {
          const message = `Welcome to Manyagi Capital Signals! Join our Telegram group for real-time updates: ${process.env.TELEGRAM_INVITE_LINK}`;
          await axios.post(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
            chat_id: telegramId,
            text: message,
          });
        } catch (tgMsgErr) {
          console.warn("Telegram welcome message error:", tgMsgErr?.response?.data || tgMsgErr.message);
        }
        break;
      }

      case "customer.subscription.deleted":
      case "invoice.payment_failed": {
        const obj = event.data.object;
        const customer = await stripe.customers.retrieve(obj.customer);
        const telegramId = obj.metadata?.telegramId || customer?.metadata?.telegramId;

        if (telegramId) {
          await supabaseAdmin.from("subscriptions").delete().eq("telegram_id", String(telegramId));

          try {
            await axios.post(`https://api.telegram.org/bot${telegramBotToken}/banChatMember`, {
              chat_id: telegramGroupChatId,
              user_id: telegramId,
            });
          } catch (tgBanErr) {
            console.warn("Telegram ban error:", tgBanErr?.response?.data || tgBanErr.message);
          }
        }
        break;
      }

      default:
        console.log(`Unhandled event type: ${event.type}`);
    }

    return res.status(200).json({ received: true });
  } catch (err) {
    console.error("Webhook processing error:", err.message);
    return res.status(500).json({
      error: `Webhook processing failed: ${err.message}`,
    });
  }
}


===== FILE: pages/api/stripe/charge.js  (size=3698 bytes) =====
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { items, telegramId, priceId, email, address } = req.body;

  try {
    if (!items && !priceId) {
      return res.status(400).json({ error: 'Missing items or priceId' });
    }

    const lineItems = items
      ? items.map(item => ({
          price_data: {
            currency: 'usd',
            product_data: { 
              name: item.name, 
              metadata: { 
                division: item.division || 'general',
                type: item.productType || 'general',
                product_id: item.id 
              } 
            },
            unit_amount: Math.round(item.price * 100),
          },
          quantity: item.quantity || 1,
        }))
      : [{ price: priceId, quantity: 1 }];

    const mode = items ? 'payment' : 'subscription';

    const sessionMetadata = {
      telegramId: telegramId ?? '',
      address: JSON.stringify(address || {}),
    };

    const checkoutSession = await stripe.checkout.sessions.create({
      payment_method_types: ['card'],
      line_items: lineItems,
      mode,
      success_url: `${process.env.SITE_URL}/thank-you?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.SITE_URL}/`,
      customer_email: email,
      // üëá ensure a Customer object exists (so metadata can live on it)
      customer_creation: 'always',
      // üëá only for subscriptions: attach telegramId on the Subscription itself
      ...(mode === 'subscription'
        ? {
            subscription_data: {
              metadata: { telegramId: String(telegramId || '') },
            },
          }
        : {}),
      // Keep session-level metadata as well (belt & suspenders)
      metadata: sessionMetadata,
    });

    // Calculate total amount
    let totalAmount = 0;
    if (mode === 'subscription') {
      const pricePromises = lineItems.map(async (li) => {
        if (li.price_data?.unit_amount) return li.price_data.unit_amount / 100;
        const price = await stripe.prices.retrieve(li.price);
        return price.unit_amount / 100;
      });
      const prices = await Promise.all(pricePromises);
      totalAmount = lineItems.reduce((acc, li, index) => acc + (li.quantity * prices[index]), 0);
    } else {
      totalAmount = items.reduce((acc, item) => acc + (item.price * (item.quantity || 1)), 0);
    }

    // Save to Supabase
    const { error: saveError } = await supabaseAdmin.from('orders').insert({
      stripe_session_id: checkoutSession.id,
      total_amount: totalAmount,
      status: 'pending',
      items: items || [],
      shipping_address: address ? { ...address } : null,
      user_id: null,
      division: items?.[0]?.division || 'general',
      type: mode === 'subscription' ? 'signals' : items?.[0]?.productType || 'general',
      created_at: new Date().toISOString(),
    }).select().single();
    
    if (saveError) {
      console.error('Supabase save error:', saveError);
      return res.status(500).json({ error: 'Failed to save order' });
    }

    return res.status(200).json({ sessionId: checkoutSession.id, url: checkoutSession.url });
  } catch (error) {
    console.error('Stripe error:', error);
    return res.status(500).json({ error: error.message || 'Failed to process payment' });
  }
}


===== FILE: pages/api/studio/download-packet.js  (size=10133 bytes) =====
// pages/api/studio/download-packet.js
import { supabaseAdmin } from "@/lib/supabaseAdmin";
import { buildPacketZip } from "@/lib/studio/build-packet";

// ‚úÖ Prevent Next.js from limiting responses / buffering weirdness
export const config = {
  api: {
    bodyParser: { sizeLimit: "4mb" }, // request body size (small)
    responseLimit: false, // ‚úÖ allow large JSON/headers; zip is uploaded to storage anyway
  },
};

/* ------------------------------
   Shared tier helpers (safe)
--------------------------------*/
const ACCESS_TIERS = ["public", "priority", "producer", "packaging"];
const TIER_RANK = { public: 0, priority: 1, producer: 2, packaging: 3 };

function safeStr(v) {
  return String(v ?? "").trim();
}

function safeJson(v, fallback = {}) {
  try {
    if (!v) return fallback;
    if (typeof v === "object") return v;
    const parsed = JSON.parse(String(v));
    return parsed && typeof parsed === "object" ? parsed : fallback;
  } catch {
    return fallback;
  }
}

function normalizeTier(t) {
  const v = safeStr(t).toLowerCase();
  return ACCESS_TIERS.includes(v) ? v : "public";
}

function canAccess(viewerTier, requiredTier) {
  return (TIER_RANK[normalizeTier(viewerTier)] ?? 0) >= (TIER_RANK[normalizeTier(requiredTier)] ?? 0);
}

// ‚úÖ NEW: cap a tier by another tier (effective = min(viewer, packet))
function capTierBy(viewerTier, packetTier) {
  const v = normalizeTier(viewerTier);
  const p = normalizeTier(packetTier);
  return (TIER_RANK[v] ?? 0) <= (TIER_RANK[p] ?? 0) ? v : p;
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.length) return xf.split(",")[0].trim();
  if (Array.isArray(xf) && xf.length) return String(xf[0]).trim();
  return req.socket?.remoteAddress || null;
}

/* ------------------------------
   ‚úÖ NEW: Page tier logic (matches studios/[slug].js)
--------------------------------*/
const PAGE_TYPE_DEFAULT_TIER = {
  logline: "public",
  pitch_1p: "public",
  synopsis_1page: "public",
  comparable_titles: "public",
  format_rating_audience: "public",
  one_sheet: "public",
  beat_sheet: "priority",
  season1_outline: "priority",
  episode_list: "priority",
  pilot_outline: "priority",
  signature_scene_clip: "priority",
  teaser_trailer: "priority",
  themes_main_hero_villain: "priority",
  trailer_cue_stingers: "priority",
  series_bible: "producer",
  world_rules_factions: "producer",
  timeline: "producer",
  glossary: "producer",
  cast_profiles_arcs: "producer",
  lookbook_pdf: "producer",
  poster_key_art: "producer",
  trailer_storyboard: "producer",
  franchise_roadmap: "producer",
  pilot_script_or_treatment: "producer",
  chain_of_title_rights_matrix: "packaging",
  option_term_sheet_producer_packet: "packaging",
  negotiation: "packaging",
};

function getPageVisibility(p) {
  const md = safeJson(p?.metadata, {});
  const v = String(md?.visibility || "public").toLowerCase();
  return v === "vault" ? "vault" : "public";
}

function getPageAccessTier(p) {
  const md = safeJson(p?.metadata, {});
  // if explicit access_tier exists, honor it
  if (md?.access_tier) return normalizeTier(md.access_tier);

  // vault pages default to packaging (same as UI)
  if (getPageVisibility(p) === "vault") return "packaging";

  // otherwise default by page_type
  const t = safeStr(p?.page_type);
  return normalizeTier(PAGE_TYPE_DEFAULT_TIER[t] || "public");
}

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).end();

  // ‚úÖ Hard timeout to avoid ‚Äúinfinite hang‚Äù
  const HARD_TIMEOUT_MS = 55_000;
  let timeoutFired = false;

  const hardTimeout = setTimeout(() => {
    timeoutFired = true;
    try {
      console.error("download-packet hard timeout fired");
      if (!res.headersSent) res.status(504).json({ error: "Packet build timed out" });
    } catch {}
  }, HARD_TIMEOUT_MS);

  async function logPacketAttempt({
    user_id,
    universe_id,
    viewer_tier = "public",
    required_tier = "public",
    is_locked = false,
    file_path = null,
    file_size_bytes = null,
    packet_tier = "producer",
    download_kind = "packet_zip",
  }) {
    const ip = getClientIp(req);
    const user_agent = safeStr(req.headers["user-agent"] || "") || null;
    const share_token = `packet:${normalizeTier(packet_tier)}`;

    try {
      await supabaseAdmin.from("studio_download_logs").insert({
        universe_id,
        user_id: user_id || null,
        download_kind,
        page_id: null,
        viewer_tier: normalizeTier(viewer_tier),
        required_tier: normalizeTier(required_tier),
        is_locked: !!is_locked,
        share_token,
        file_path,
        file_size_bytes,
        ip,
        user_agent,
      });
    } catch (e) {
      console.warn("studio_download_logs insert failed:", e?.message || e);
    }
  }

  try {
    // 1) Auth
    const token = (req.headers.authorization || "").replace("Bearer ", "");
    if (!token) return res.status(401).json({ error: "Missing auth token" });

    const { data: auth, error: authErr } = await supabaseAdmin.auth.getUser(token);
    const user = auth?.user;
    if (authErr || !user) return res.status(401).json({ error: "Unauthorized" });

    const { universe_id, tier = "producer", mode = "full", include_vault = false } = req.body || {};
    if (!universe_id) return res.status(400).json({ error: "Missing universe_id" });

    const packetTier = normalizeTier(tier);

    // 2) Entitlement
    const { data: ent } = await supabaseAdmin
      .from("studio_entitlements")
      .select("tier,status,expires_at,updated_at")
      .eq("user_id", user.id)
      .eq("universe_id", universe_id)
      .order("updated_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    const now = new Date();
    const active = ent && ent.status === "active" && (!ent.expires_at || new Date(ent.expires_at) > now);
    const viewerTier = active ? normalizeTier(ent.tier) : "public";

    if (!active || !canAccess(viewerTier, packetTier)) {
      await logPacketAttempt({
        user_id: user.id,
        universe_id,
        viewer_tier: viewerTier,
        required_tier: packetTier,
        is_locked: true,
        packet_tier: packetTier,
      });
      return res.status(403).json({ error: "No access to this packet" });
    }

    // ‚úÖ NEW: Effective tier for THIS packet (prevents higher-tier users from getting extra pages in lower-tier packet)
    const effectiveTier = capTierBy(viewerTier, packetTier);

    // 3) Load pages
    const { data: pages, error: pagesErr } = await supabaseAdmin
      .from("studio_pages")
      .select("*")
      .eq("universe_id", universe_id)
      .eq("status", "published");

    if (pagesErr) throw pagesErr;

    const list = pages || [];

    // 4) Filter by tier + vault rules (matches UI logic)
    const allowVault = !!include_vault && canAccess(effectiveTier, "packaging");

    const allowedPages = list
      .filter((p) => {
        // vault visibility gate
        const vis = getPageVisibility(p);
        if (vis === "vault" && !allowVault) return false;

        // tier gate (IMPORTANT: uses UI default logic)
        const requiredTier = getPageAccessTier(p);
        return canAccess(effectiveTier, requiredTier);
      })
      // stable order (prefer DB sort_order if present)
      .sort((a, b) => {
        const ao = Number(a?.sort_order ?? 9999);
        const bo = Number(b?.sort_order ?? 9999);
        if (ao !== bo) return ao - bo;

        const ad = new Date(a?.updated_at || 0).getTime();
        const bd = new Date(b?.updated_at || 0).getTime();
        if (bd !== ad) return bd - ad;

        return safeStr(a?.title).localeCompare(safeStr(b?.title));
      });

    if (!allowedPages.length) return res.status(404).json({ error: "No pages available" });

    console.log("packet: building zip", {
      universe_id,
      allowedPages: allowedPages.length,
      packetTier,
      viewerTier,
      effectiveTier,
      mode,
      allowVault,
    });

    // 5) Build ZIP
    const zipBuffer = await buildPacketZip({
      pages: allowedPages,
      tier: packetTier,
      mode,
    });

    if (!zipBuffer || zipBuffer.length < 50) {
      throw new Error("ZIP build failed (empty buffer)");
    }

    console.log("packet: zip built", { bytes: zipBuffer.length });

    // 6) Upload
    const path = `studios/${universe_id}/packets/${mode}/${packetTier}${allowVault ? ".vault" : ""}.zip`;

    const { error: uploadErr } = await supabaseAdmin.storage.from("studio").upload(path, zipBuffer, {
      contentType: "application/zip",
      upsert: true,
    });

    if (uploadErr) throw uploadErr;

    // 7) Signed URL
    const { data: signed, error: signErr } = await supabaseAdmin.storage.from("studio").createSignedUrl(path, 60 * 10);

    if (signErr) throw signErr;

    // 8) Log success
    await logPacketAttempt({
      user_id: user.id,
      universe_id,
      viewer_tier: viewerTier,
      required_tier: packetTier,
      is_locked: false,
      file_path: path,
      file_size_bytes: zipBuffer.length,
      packet_tier: packetTier,
      download_kind: "packet_zip",
    });

    res.setHeader("Cache-Control", "no-store");
    return res.status(200).json({ url: signed.signedUrl });
  } catch (e) {
    console.error("download-packet error:", e);

    // If our timeout already fired, don‚Äôt double-respond
    if (timeoutFired || res.headersSent) return;

    // Better status mapping
    const msg = safeStr(e?.message || "Server error");
    const code =
      msg.includes("Unauthorized") || msg.includes("Missing auth") ? 401 :
      msg.includes("No access") ? 403 :
      msg.includes("Missing") ? 400 :
      500;

    return res.status(code).json({ error: msg });
  } finally {
    clearTimeout(hardTimeout);
  }
}


===== FILE: pages/api/studio/download-page.js  (size=7933 bytes) =====
// pages/api/studio/download-page.js
import { supabaseAdmin } from "@/lib/supabaseAdmin";
import { buildPagePdf } from "@/lib/studio/build-pdf";

/**
 * POST /api/studio/download-page
 * body: { universe_id, page_type, mode? }  // mode: "full" | "preview"
 */

/* -----------------------------
   Shared helpers (tier + access)
--------------------------------*/
const ACCESS_TIERS = ["public", "priority", "producer", "packaging"];
const TIER_RANK = { public: 0, priority: 1, producer: 2, packaging: 3 };

function safeStr(v) {
  return String(v ?? "").trim();
}
function safeJson(v, fallback = {}) {
  try {
    if (!v) return fallback;
    if (typeof v === "object") return v;
    const parsed = JSON.parse(String(v));
    return parsed && typeof parsed === "object" ? parsed : fallback;
  } catch {
    return fallback;
  }
}
function normalizeTier(t) {
  const v = safeStr(t).toLowerCase();
  return ACCESS_TIERS.includes(v) ? v : "public";
}
function canAccess(viewerTier, requiredTier) {
  const vt = normalizeTier(viewerTier);
  const rt = normalizeTier(requiredTier);
  return (TIER_RANK[vt] ?? 0) >= (TIER_RANK[rt] ?? 0);
}

// match your studios/[slug].js behavior
const PAGE_TYPE_DEFAULT_TIER = {
  logline: "public",
  pitch_1p: "public",
  synopsis_1page: "public",
  comparable_titles: "public",
  format_rating_audience: "public",
  one_sheet: "public",

  beat_sheet: "priority",
  season1_outline: "priority",
  episode_list: "priority",
  pilot_outline: "priority",
  signature_scene_clip: "priority",
  teaser_trailer: "priority",
  themes_main_hero_villain: "priority",
  trailer_cue_stingers: "priority",

  series_bible: "producer",
  world_rules_factions: "producer",
  timeline: "producer",
  glossary: "producer",
  cast_profiles_arcs: "producer",
  lookbook_pdf: "producer",
  poster_key_art: "producer",
  trailer_storyboard: "producer",
  franchise_roadmap: "producer",
  pilot_script_or_treatment: "producer",

  chain_of_title_rights_matrix: "packaging",
  option_term_sheet_producer_packet: "packaging",
  negotiation: "packaging",
};

function getPageVisibility(page) {
  const md = safeJson(page?.metadata, {});
  const v = String(md?.visibility || "public").toLowerCase();
  return v === "vault" ? "vault" : "public";
}

function getPageAccessTier(page) {
  const md = safeJson(page?.metadata, {});
  // explicit override
  if (md?.access_tier) return normalizeTier(md.access_tier);
  // vault implies packaging
  if (getPageVisibility(page) === "vault") return "packaging";
  // default map by page_type
  const t = safeStr(page?.page_type);
  return normalizeTier(PAGE_TYPE_DEFAULT_TIER[t] || "public");
}

function getClientIp(req) {
  const xf = req.headers["x-forwarded-for"];
  if (typeof xf === "string" && xf.length) return xf.split(",")[0].trim();
  if (Array.isArray(xf) && xf.length) return String(xf[0]).trim();
  return req.socket?.remoteAddress || null;
}

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).end();

  // small helper to log both allowed + denied attempts
  async function logDownloadAttempt({
    user_id,
    universe_id,
    page_id = null,
    viewer_tier = "public",
    required_tier = "public",
    is_locked = false,
    file_path = null,
    file_size_bytes = null,
    share_token = null,
    download_kind = "page_pdf",
  }) {
    const ip = getClientIp(req);
    const user_agent = safeStr(req.headers["user-agent"] || "") || null;

    // DO NOT throw if logging fails
    try {
      await supabaseAdmin.from("studio_download_logs").insert({
        universe_id,
        user_id: user_id || null,
        download_kind, // ‚úÖ required by schema
        page_id,       // ‚úÖ FK to studio_pages
        viewer_tier: normalizeTier(viewer_tier),     // ‚úÖ required by schema
        required_tier: normalizeTier(required_tier), // ‚úÖ required by schema
        is_locked: !!is_locked,                      // ‚úÖ required by schema
        share_token,
        file_path,
        file_size_bytes,
        ip,
        user_agent,
      });
    } catch (e) {
      console.warn("studio_download_logs insert failed:", e?.message || e);
    }
  }

  try {
    // 1) Auth (unchanged)
    const authHeader = req.headers.authorization || "";
    const token = authHeader.replace("Bearer ", "");
    if (!token) throw new Error("Missing auth token");

    const {
      data: { user },
      error: authErr,
    } = await supabaseAdmin.auth.getUser(token);

    if (authErr || !user) throw new Error("Unauthorized");

    const { universe_id, page_type, mode = "full" } = req.body || {};
    if (!universe_id || !page_type) throw new Error("Missing parameters");

    // 2) Entitlement check (‚úÖ bulletproof: always pick latest updated row)
    const { data: ent } = await supabaseAdmin
      .from("studio_entitlements")
      .select("tier,status,expires_at,updated_at")
      .eq("user_id", user.id)
      .eq("universe_id", universe_id)
      .order("updated_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    const now = new Date();
    const active =
      ent &&
      ent.status === "active" &&
      (!ent.expires_at || new Date(ent.expires_at) > now);

    const viewerTier = active ? normalizeTier(ent.tier) : "public";

    if (!active) {
      throw new Error("No active entitlement");
    }

    // 3) Load page (unchanged query)
    const { data: page } = await supabaseAdmin
      .from("studio_pages")
      .select("*")
      .eq("universe_id", universe_id)
      .eq("page_type", page_type)
      .eq("status", "published")
      .single();

    if (!page) throw new Error("Page not found");

    // ‚úÖ 4) Enforce required tier for THIS page (prevents tier leakage)
    const requiredTier = getPageAccessTier(page);
    const allowed = canAccess(viewerTier, requiredTier);

    if (!allowed) {
      await logDownloadAttempt({
        user_id: user.id,
        universe_id,
        page_id: page.id,
        viewer_tier: viewerTier,
        required_tier: requiredTier,
        is_locked: true,
        download_kind: "page_pdf",
      });
      throw new Error(`Requires ${requiredTier} access`);
    }

    // 5) Generate PDF (same as before, with optional preview watermark)
    const watermark =
      mode === "preview"
        ? "PREVIEW ‚Äî MANYAGI STUDIOS"
        : "CONFIDENTIAL ‚Äî MANYAGI STUDIOS";

    const pdfBuffer = await buildPagePdf(page, { watermark });

    // 6) Upload to PRIVATE studio bucket (kept, but path includes mode to avoid collisions)
    const path = `studios/${universe_id}/pages/${mode}/${page.page_type}.pdf`;

    const { error: uploadErr } = await supabaseAdmin.storage
      .from("studio")
      .upload(path, pdfBuffer, {
        contentType: "application/pdf",
        upsert: true,
      });

    if (uploadErr) throw uploadErr;

    // 7) Signed URL (unchanged)
    const { data: signed, error: signErr } = await supabaseAdmin.storage
      .from("studio")
      .createSignedUrl(path, 60 * 10); // 10 minutes

    if (signErr) throw signErr;

    // ‚úÖ 8) Correct download log (schema-aligned; no fake columns)
    await logDownloadAttempt({
      user_id: user.id,
      universe_id,
      page_id: page.id,
      viewer_tier: viewerTier,
      required_tier: requiredTier,
      is_locked: false,
      download_kind: "page_pdf",
      file_path: path,
      file_size_bytes: pdfBuffer?.length ?? null,
    });

    return res.json({ url: signed.signedUrl });
  } catch (e) {
    console.error("download-page error:", e);
    // 401 keeps your current behavior; if you want strict semantics: use 403 for locked
    return res.status(401).json({ error: e.message });
  }
}


===== FILE: pages/api/track.js  (size=809 bytes) =====
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  const { order_id } = req.query;

  if (!order_id) {
    return res.status(400).json({ error: 'Missing order_id' });
  }

  try {
    const { data: order, error } = await supabaseAdmin
      .from('orders')
      .select('*')
      .eq('id', order_id)
      .single();
      
    if (error || !order) throw new Error('Order not found');

    res.status(200).json({
      status: order.status,
      estimated_delivery: order.updated_at,
      division: order.division,
      total: order.total_amount,
      items: order.items
    });
  } catch (error) {
    console.error('Supabase track error:', error);
    res.status(500).json({ error: 'Failed to track order' });
  }
}


===== FILE: pages/blog.js  (size=12590 bytes) =====
// pages/blog.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState, useMemo } from 'react';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';

const PLACEHOLDER_IMAGE =
  'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-home.webp';

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return '';
  return d.toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}

function formatDivision(div) {
  if (!div) return 'Manyagi';
  return div.charAt(0).toUpperCase() + div.slice(1);
}

// Be defensive about the API shape: support {ok,items}, plain array, etc.
function normalizePosts(json) {
  if (Array.isArray(json)) return json;
  if (json && Array.isArray(json.items)) return json.items;
  if (json && Array.isArray(json.data)) return json.data;
  return [];
}

export default function Blog() {
  const [blogPosts, setBlogPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [errorMsg, setErrorMsg] = useState('');
  const [activeDivision, setActiveDivision] = useState('all');
  const [search, setSearch] = useState('');

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts');
        const json = await res.json();

        if (!res.ok || json.error) {
          throw new Error(json.error || `HTTP ${res.status}`);
        }

        const posts = normalizePosts(json);

        const sorted = (posts || []).slice().sort((a, b) => {
          const da = new Date(a.created_at || 0).getTime();
          const db = new Date(b.created_at || 0).getTime();
          return db - da;
        });

        setBlogPosts(sorted);
      } catch (e) {
        console.error('Blog fetch error:', e);
        setErrorMsg(
          'We had trouble loading posts. Showing a starter article.'
        );

        // Fallback starter article
        setBlogPosts([
          {
            id: 'welcome-manyagi',
            title: 'Welcome to the Manyagi Universe',
            slug: 'site-welcome-to-the-manyagi-universe',
            excerpt:
              'How Publishing, Tech, Realty, Capital, Media, and Designs connect into one creator engine.',
            created_at: '2025-09-01T00:00:00Z',
            featured_image: PLACEHOLDER_IMAGE,
            division: 'site',
            category: 'Announcement',
          },
        ]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // derive available divisions for filter pills
  const divisionOptions = useMemo(() => {
    const set = new Set();
    (blogPosts || []).forEach((p) => {
      if (p.division) set.add(p.division);
    });
    return ['all', ...Array.from(set)];
  }, [blogPosts]);

  // filter + search
  const filteredPosts = useMemo(() => {
    let items = blogPosts;

    if (activeDivision !== 'all') {
      items = items.filter((p) => (p.division || 'site') === activeDivision);
    }

    if (search.trim()) {
      const q = search.toLowerCase();
      items = items.filter(
        (p) =>
          (p.title || '').toLowerCase().includes(q) ||
          (p.excerpt || '').toLowerCase().includes(q) ||
          (p.slug || '').toLowerCase().includes(q)
      );
    }

    return items;
  }, [blogPosts, activeDivision, search]);

  const [featuredPost, otherPosts] = useMemo(() => {
    if (!filteredPosts.length) return [null, []];
    return [filteredPosts[0], filteredPosts.slice(1)];
  }, [filteredPosts]);

  return (
    <>
      <Head>
        <title>Manyagi Blog ‚Äî Insights, Playbooks & Updates</title>
        <meta
          name="description"
          content="Deep dives, playbooks, and updates from the Manyagi universe ‚Äî Publishing, Tech, Realty, Capital, Media, and more."
        />
      </Head>

      {/* Top header ‚Äì clean, editorial */}
      <header className="border-b border-gray-100 bg-white/70 backdrop-blur dark:bg-gray-900/80 dark:border-gray-800">
        <div className="container mx-auto px-4 py-10">
          <p className="text-xs font-semibold tracking-[0.2em] uppercase text-blue-600">
            Manyagi Blog
          </p>
          <h1 className="mt-2 text-3xl md:text-4xl font-bold tracking-tight">
            Creator engine, in public.
          </h1>
          <p className="mt-3 max-w-2xl text-sm md:text-base opacity-80">
            Build logs, playbooks, and behind-the-scenes notes as we grow
            Publishing, Tech, Realty, Capital, Media, and Designs under one
            universe.
          </p>
        </div>
      </header>

      {/* Filters + search */}
      <section className="container mx-auto px-4 pt-8">
        {errorMsg && (
          <div className="mb-4 rounded-md border border-yellow-300 bg-yellow-50 px-4 py-3 text-xs md:text-sm text-yellow-800">
            {errorMsg}
          </div>
        )}

        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          {/* Division pills */}
          <div className="flex flex-wrap gap-2">
            {divisionOptions.map((div) => (
              <button
                key={div}
                type="button"
                onClick={() => setActiveDivision(div)}
                className={`rounded-full border px-3 py-1 text-xs font-medium transition ${
                  activeDivision === div
                    ? 'border-blue-600 bg-blue-600 text-white'
                    : 'border-gray-200 bg-white text-gray-700 hover:border-blue-400 hover:text-blue-700 dark:bg-gray-900 dark:border-gray-700'
                }`}
              >
                {div === 'all' ? 'All divisions' : formatDivision(div)}
              </button>
            ))}
          </div>

          {/* Search */}
          <div className="w-full md:w-72">
            <input
              type="search"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              placeholder="Search posts‚Ä¶"
              className="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-gray-900 dark:border-gray-700"
            />
          </div>
        </div>
      </section>

      {/* Main content */}
      <main className="container mx-auto px-4 py-10">
        {loading ? (
          <div className="py-16 text-center text-lg opacity-80">
            Loading blog posts‚Ä¶
          </div>
        ) : !filteredPosts.length ? (
          <div className="py-16 text-center text-lg opacity-80">
            No posts yet ‚Äî first entry coming soon.
          </div>
        ) : (
          <>
            {/* Featured article */}
            {featuredPost && (
              <article className="mb-12 grid grid-cols-1 items-stretch gap-6 rounded-3xl border border-gray-100 bg-white/80 p-4 shadow-sm backdrop-blur dark:bg-gray-900/70 dark:border-gray-800 md:grid-cols-2 md:p-6">
                <div className="overflow-hidden rounded-2xl bg-black/5">
                  <img
                    src={featuredPost.featured_image || PLACEHOLDER_IMAGE}
                    alt={featuredPost.title}
                    className="h-full w-full object-cover transition-transform duration-500 hover:scale-[1.03]"
                  />
                </div>

                <div className="flex flex-col justify-center space-y-3 md:space-y-4">
                  <div className="flex flex-wrap items-center gap-2 text-xs">
                    {featuredPost.category && (
                      <span className="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-[10px] font-semibold uppercase tracking-wide text-blue-700">
                        {featuredPost.category}
                      </span>
                    )}
                    <span className="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-[10px] font-medium uppercase tracking-wide text-gray-700 dark:bg-gray-800 dark:text-gray-100">
                      {formatDivision(featuredPost.division)}
                    </span>
                  </div>

                  <h2 className="text-2xl md:text-3xl font-semibold leading-tight">
                    {featuredPost.title}
                  </h2>

                  <p className="text-xs md:text-sm opacity-70">
                    {formatDate(featuredPost.created_at)} ‚Ä¢ Manyagi Blog
                  </p>

                  <p className="text-sm md:text-base opacity-90">
                    {featuredPost.excerpt ||
                      'A new dispatch from the Manyagi universe ‚Äî strategy, systems, and story-driven assets.'}
                  </p>

                  <div className="pt-1">
                    <Link
                      href={`/blog/${featuredPost.slug}`}
                      className="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 transition"
                    >
                      Read article
                    </Link>
                  </div>
                </div>
              </article>
            )}

            {/* Rest of posts */}
            {otherPosts.length > 0 && (
              <>
                <h3 className="mb-4 text-sm font-semibold uppercase tracking-[0.2em] text-gray-500">
                  Recent posts
                </h3>
                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                  {otherPosts.map((post) => (
                    <article
                      key={post.id}
                      className="flex flex-col overflow-hidden rounded-2xl border border-gray-100 bg-white/80 shadow-sm backdrop-blur transition hover:-translate-y-0.5 hover:shadow-md dark:bg-gray-900/70 dark:border-gray-800"
                    >
                      <div className="h-40 w-full overflow-hidden">
                        <img
                          src={post.featured_image || PLACEHOLDER_IMAGE}
                          alt={post.title}
                          className="h-full w-full object-cover transition-transform duration-500 hover:scale-[1.03]"
                        />
                      </div>
                      <div className="flex flex-1 flex-col p-4 space-y-2">
                        <div className="flex items-center justify-between gap-2 text-[11px]">
                          <span className="rounded-full bg-gray-100 px-2 py-0.5 font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-100">
                            {formatDivision(post.division || 'site')}
                          </span>
                          <span className="opacity-70">
                            {formatDate(post.created_at)}
                          </span>
                        </div>

                        <h3 className="text-base md:text-lg font-semibold leading-snug line-clamp-2">
                          {post.title}
                        </h3>

                        {post.excerpt && (
                          <p className="text-sm opacity-80 line-clamp-3">
                            {post.excerpt}
                          </p>
                        )}

                        <div className="pt-2">
                          <Link
                            href={`/blog/${post.slug}`}
                            className="text-sm font-semibold text-blue-600 hover:underline"
                          >
                            Read more ‚Üí
                          </Link>
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              </>
            )}
          </>
        )}
      </main>

      {/* Newsletter */}
      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427852"
          uid="637df68a05"
          title="Subscribe to Blog Updates"
          description="Weekly playbooks and progress logs from the Manyagi build ‚Äî no spam, just signal."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/blog/[slug].js  (size=22799 bytes) =====
// pages/blog/[slug].js
import Head from 'next/head';
import Link from 'next/link';
import { useRouter } from 'next/router';
import { useEffect, useMemo, useState } from 'react';
import SubscriptionForm from '../../components/SubscriptionForm';
import Recommender from '../../components/Recommender';
import SectionIntro from '../../components/SectionIntro';

const PLACEHOLDER_IMAGE =
  'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-home.webp';

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return '';
  return d.toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}

function formatDivision(div) {
  if (!div) return 'Manyagi';
  return div.charAt(0).toUpperCase() + div.slice(1);
}

function getReadingTime(text = '') {
  if (!text.trim()) return '';
  const words = text.trim().split(/\s+/).length;
  const minutes = Math.max(1, Math.round(words / 200));
  return `${minutes} min read`;
}

// super lightweight markdown-ish renderer: # / ## / ### => headings, else paragraph
function renderContentBlocks(content = '') {
  const blocks = content.split(/\n\s*\n/); // double newline = new block

  return blocks
    .map((raw, idx) => {
      const text = raw.trim();
      if (!text) return null;

      if (text.startsWith('### ')) {
        return (
          <h3 key={idx} className="mt-6 mb-2 text-lg font-semibold">
            {text.slice(4)}
          </h3>
        );
      }
      if (text.startsWith('## ')) {
        return (
          <h2 key={idx} className="mt-8 mb-3 text-xl font-bold">
            {text.slice(3)}
          </h2>
        );
      }
      if (text.startsWith('# ')) {
        return (
          <h1 key={idx} className="mt-10 mb-4 text-2xl font-bold">
            {text.slice(2)}
          </h1>
        );
      }

      return (
        <p key={idx} className="mb-4 leading-relaxed">
          {text}
        </p>
      );
    })
    .filter(Boolean);
}

/* -------------------------------
   Media helpers (mirrors media.js/index.js)
--------------------------------*/
const asStr = (v) => (v === null || v === undefined ? '' : String(v));

function safeMeta(meta) {
  if (!meta) return {};
  if (typeof meta === 'object') return meta;
  if (typeof meta === 'string') {
    try {
      const parsed = JSON.parse(meta);
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch {
      return {};
    }
  }
  return {};
}

function isDirectAudio(url) {
  const u = (url || '').toLowerCase().split('?')[0];
  return u.endsWith('.mp3') || u.endsWith('.wav') || u.endsWith('.m4a') || u.endsWith('.ogg');
}

function inferPlatform(url) {
  if (!url) return '';
  const u = url.toLowerCase();
  if (u.includes('youtube.com') || u.includes('youtu.be')) return 'YouTube';
  if (u.includes('spotify.com')) return 'Spotify';
  if (u.includes('soundcloud.com')) return 'SoundCloud';
  if (u.includes('vimeo.com')) return 'Vimeo';
  if (u.includes('tiktok.com')) return 'TikTok';
  if (u.includes('instagram.com')) return 'Instagram';
  if (u.includes('apple.com') || u.includes('music.apple.com')) return 'Apple Music';
  if (u.includes('suno')) return 'Suno';
  return '';
}

function normalizeType(t) {
  const v = (t || '').toLowerCase().trim();
  if (v === 'music' || v === 'track') return 'soundtrack';
  if (v === 'chapter preview' || v === 'chapter') return 'chapter_read';
  if (v === 'opening_theme') return 'soundtrack';
  if (v === 'ending_theme') return 'soundtrack';
  if (v === 'character_theme') return 'soundtrack';
  if (v === 'battle_theme') return 'score';
  return v || 'other';
}

function prettyType(t) {
  const v = normalizeType(t);
  const map = {
    soundtrack: 'Soundtrack',
    score: 'Score',
    trailer: 'Trailer',
    audiobook: 'Audiobook',
    chapter_read: 'Chapter Read',
    scene: 'Scene',
    playlist: 'Playlist',
    musicvideo: 'Music Video',
    reel: 'Reel',
    podcast: 'Podcast',
    interview: 'Interview',
    event: 'Event',
    other: 'Media',
  };
  return map[v] || 'Media';
}

function bestUrl(meta, post) {
  const audio = asStr(meta?.audio_url).trim();
  const media = asStr(meta?.media_url).trim();

  const audio2 = asStr(post?.audio_url).trim();
  const media2 = asStr(post?.media_url).trim();

  return {
    audio_url: audio || audio2 || '',
    media_url: media || media2 || '',
  };
}

function pickIp(meta) {
  return (
    asStr(meta?.book).trim() ||
    asStr(meta?.series).trim() ||
    asStr(meta?.universe).trim() ||
    asStr(meta?.ip).trim() ||
    asStr(meta?.franchise).trim() ||
    ''
  );
}

function normalizeApiList(json) {
  if (Array.isArray(json)) return json;
  if (json && Array.isArray(json.posts)) return json.posts;
  if (json && Array.isArray(json.data)) return json.data;
  if (json && Array.isArray(json.rows)) return json.rows;
  if (json && Array.isArray(json.items)) return json.items;
  return [];
}

function Chip({ children, tone = 'neutral' }) {
  const cls =
    tone === 'amber'
      ? 'bg-amber-100/80 text-amber-800 border-amber-200 dark:bg-amber-900/25 dark:text-amber-200 dark:border-amber-800/40'
      : tone === 'blue'
      ? 'bg-blue-100/80 text-blue-800 border-blue-200 dark:bg-blue-900/25 dark:text-blue-200 dark:border-blue-800/40'
      : tone === 'purple'
      ? 'bg-purple-100/80 text-purple-800 border-purple-200 dark:bg-purple-900/25 dark:text-purple-200 dark:border-purple-800/40'
      : 'bg-white/70 text-gray-800 border-gray-200 dark:bg-gray-900/60 dark:text-gray-100 dark:border-gray-700';

  return (
    <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs border ${cls}`}>
      {children}
    </span>
  );
}

function MediaEmbed({ mediaUrl, audioUrl }) {
  const url = (audioUrl || mediaUrl || '').trim();
  if (!url) return null;

  if (isDirectAudio(url)) {
    return (
      <div className="w-full rounded-2xl border border-gray-200/80 dark:border-gray-700/70 bg-white/70 dark:bg-gray-900/50 p-4">
        <audio controls className="w-full">
          <source src={url} />
        </audio>
      </div>
    );
  }

  const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
  const isSpotify = url.includes('open.spotify.com');
  const isSoundCloud = url.includes('soundcloud.com');
  const isVimeo = url.includes('vimeo.com');

  if (isYouTube) {
    let embed = url;
    if (url.includes('watch?v=')) {
      const id = url.split('watch?v=')[1].split('&')[0];
      embed = `https://www.youtube.com/embed/${id}`;
    } else if (url.includes('youtu.be/')) {
      const id = url.split('youtu.be/')[1].split(/[?&]/)[0];
      embed = `https://www.youtube.com/embed/${id}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-gray-300/70 dark:border-gray-700/70 shadow-sm">
        <iframe src={embed} title="Media Preview" className="w-full h-full" allowFullScreen />
      </div>
    );
  }

  if (isSpotify) {
    const embed = url.replace('open.spotify.com/', 'open.spotify.com/embed/');
    return (
      <div className="w-full rounded-2xl overflow-hidden border border-gray-300/70 dark:border-gray-700/70 shadow-sm">
        <iframe
          src={embed}
          title="Spotify Player"
          className="w-full h-[152px] md:h-[232px]"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        />
      </div>
    );
  }

  if (isSoundCloud) {
    const embed = `https://w.soundcloud.com/player/?url=${encodeURIComponent(
      url
    )}&auto_play=false&show_teaser=true`;
    return (
      <div className="w-full rounded-2xl overflow-hidden border border-gray-300/70 dark:border-gray-700/70 shadow-sm">
        <iframe src={embed} title="SoundCloud Player" className="w-full h-[166px]" allow="autoplay" />
      </div>
    );
  }

  if (isVimeo) {
    let embed = url;
    const parts = url.split('vimeo.com/');
    if (parts[1]) {
      const id = parts[1].split(/[?&]/)[0];
      embed = `https://player.vimeo.com/video/${id}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-gray-300/70 dark:border-gray-700/70 shadow-sm">
        <iframe src={embed} title="Vimeo Player" className="w-full h-full" allowFullScreen />
      </div>
    );
  }

  return (
    <a
      href={url}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center justify-center w-full bg-blue-600 text-white text-sm font-semibold py-3 px-4 rounded-full hover:bg-blue-700 transition shadow-sm"
    >
      Open Link
    </a>
  );
}

export default function BlogPost() {
  const router = useRouter();
  const { slug } = router.query;

  const [post, setPost] = useState(null);
  const [linkedMedia, setLinkedMedia] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!slug) return;

    (async () => {
      setLoading(true);
      setPost(null);
      setLinkedMedia(null);

      try {
        const res = await fetch(`/api/posts/${slug}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data?.error) throw new Error(data?.error || 'Post not found');

        const m0 = safeMeta(data?.metadata);
        const u0 = bestUrl(m0, data || {});
        const hasDirectMedia = !!asStr(u0.audio_url).trim() || !!asStr(u0.media_url).trim();

        setPost(data);

        if (!hasDirectMedia) {
          try {
            const res2 = await fetch(`/api/posts?division=media&limit=50`);
            const json2 = await res2.json().catch(() => ({}));
            const raw = normalizeApiList(json2);
            const match = (raw || []).find((p) => asStr(p?.slug) === asStr(slug));
            if (match) setLinkedMedia(match);
          } catch (e2) {
            console.warn('Media lookup failed:', e2);
          }
        }
      } catch (e) {
        console.error('Blog post fetch error:', e);
        setPost({
          id: 'welcome-fallback',
          title: 'Welcome to the Manyagi Universe',
          slug: 'site-welcome-to-the-manyagi-universe',
          excerpt: 'An introduction to our multi-division platform.',
          created_at: '2025-09-01T00:00:00Z',
          featured_image: PLACEHOLDER_IMAGE,
          division: 'site',
          content:
            '# Welcome to the Manyagi Universe\n\nThis is a starter article used when the requested post cannot be loaded.',
          metadata: {},
        });
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  const mediaSource = linkedMedia || post;

  const meta = useMemo(() => safeMeta(mediaSource?.metadata), [mediaSource?.metadata]);
  const urls = useMemo(() => bestUrl(meta, mediaSource || {}), [meta, mediaSource]);

  const audio_url = urls.audio_url;
  const media_url = urls.media_url;
  const hasMedia = !!asStr(audio_url).trim() || !!asStr(media_url).trim();

  const platform = useMemo(
    () => asStr(meta?.platform).trim() || inferPlatform(media_url || audio_url),
    [meta, media_url, audio_url]
  );

  const ip = useMemo(() => pickIp(meta), [meta]);
  const mediaType = useMemo(() => prettyType(meta?.media_type || ''), [meta]);

  const showMediaPanel =
    hasMedia || asStr(post?.division).toLowerCase() === 'media' || !!linkedMedia;

  const metaLineParts = useMemo(() => {
    if (!post) return [];
    return [
      formatDate(post.created_at),
      post.division ? formatDivision(post.division) : null,
      getReadingTime(post.content || ''),
    ].filter(Boolean);
  }, [post]);

  const duration = asStr(meta?.duration).trim();
  const mood = asStr(meta?.mood).trim();
  const scene = asStr(meta?.scene).trim();

  const downloadUrl = asStr(meta?.download_url).trim();
  const licenseUrl = asStr(meta?.license_url).trim();
  const rightsNote = asStr(meta?.rights_note).trim(); // optional
  const contactEmail = asStr(meta?.contact_email).trim() || 'studios@manyagi.net';

  const mediaSlug = asStr(linkedMedia?.slug || post?.slug).trim();

  if (loading) {
    return <div className="container mx-auto px-4 py-16 text-center">Loading post‚Ä¶</div>;
  }
  if (!post) {
    return <div className="container mx-auto px-4 py-16 text-center">Post not found.</div>;
  }

  return (
    <>
      <Head>
        <title>{post.title} ‚Äî Manyagi Blog</title>
        <meta name="description" content={post.excerpt || 'Article from the Manyagi Blog.'} />
      </Head>

      {/* Premium background wash */}
      <div className="relative">
        <div className="absolute inset-0 -z-10">
          <div className="h-[520px] bg-gradient-to-b from-amber-200/60 via-amber-100/30 to-transparent dark:from-amber-900/20 dark:via-amber-900/10" />
          <div className="pointer-events-none absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(59,130,246,0.14),transparent_55%)]" />
        </div>

        <SectionIntro
          id="post-header"
          kicker="Manyagi Blog"
          title={post.title}
          lead={post.excerpt || 'A new dispatch from the Manyagi universe.'}
          tone="neutral"
          align="center"
          maxWidth="max-w-4xl"
        >
          <div className="mt-4 flex flex-wrap items-center justify-center gap-2">
            {metaLineParts.length > 0 && <Chip>{metaLineParts.join(' ‚Ä¢ ')}</Chip>}
            {mediaType && <Chip tone="amber">{mediaType}</Chip>}
            {platform && <Chip tone="blue">{platform}</Chip>}
            {duration && <Chip tone="purple">{duration}</Chip>}
          </div>
        </SectionIntro>

        <article className="container mx-auto px-4 pb-16">
          <div className="max-w-5xl mx-auto">
            {/* Back row */}
            <div className="mb-4 flex items-center justify-between gap-3">
              <Link
                href="/blog"
                className="inline-flex items-center text-xs text-gray-600 hover:text-blue-600 dark:text-gray-300"
              >
                ‚Üê Back to Blog
              </Link>

              {/* Executive quick actions (always visible) */}
              <div className="flex gap-2 flex-wrap justify-end">
                <Link
                  href="/media"
                  className="px-4 py-2 rounded-full text-xs font-semibold border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/60 hover:bg-white dark:hover:bg-gray-900 transition shadow-sm"
                >
                  Media Library ‚Üí
                </Link>
                {mediaSlug && (
                  <Link
                    href={`/media/${mediaSlug}`}
                    className="px-4 py-2 rounded-full text-xs font-semibold bg-blue-600 text-white hover:bg-blue-700 transition shadow-sm"
                  >
                    Media Detail ‚Üí
                  </Link>
                )}
                <a
                  href={`mailto:${contactEmail}?subject=${encodeURIComponent(
                    `Licensing / Commercial Inquiry ‚Äî ${post.title}`
                  )}`}
                  className="px-4 py-2 rounded-full text-xs font-semibold border border-emerald-200 dark:border-emerald-800/50 bg-emerald-50/80 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 hover:bg-emerald-100/70 dark:hover:bg-emerald-900/30 transition shadow-sm"
                >
                  Contact Licensing
                </a>
              </div>
            </div>

            {/* MAIN CARD */}
            <div className="rounded-[28px] border border-gray-200/70 dark:border-gray-800 bg-white/80 dark:bg-gray-950/60 backdrop-blur shadow-[0_10px_50px_-20px_rgba(0,0,0,0.35)] overflow-hidden">
              {/* Media panel: premium look */}
              {showMediaPanel && hasMedia && (
                <div className="p-6 md:p-8 border-b border-gray-200/70 dark:border-gray-800">
                  <div className="relative rounded-[22px] overflow-hidden">
                    {/* gradient border */}
                    <div className="absolute inset-0 bg-gradient-to-r from-amber-200/60 via-blue-200/40 to-purple-200/50 dark:from-amber-900/30 dark:via-blue-900/20 dark:to-purple-900/25" />
                    <div className="relative m-[1px] rounded-[21px] bg-white/75 dark:bg-gray-950/65 backdrop-blur p-5 md:p-6 border border-white/40 dark:border-gray-800/60">
                      <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                        <div className="min-w-0">
                          <div className="text-[11px] font-semibold tracking-[0.26em] uppercase text-gray-700/70 dark:text-gray-200/70">
                            Executive Preview
                          </div>

                          <div className="mt-2 flex flex-wrap items-center gap-2">
                            {ip && <Chip tone="amber">{ip}</Chip>}
                            {mediaType && <Chip>{mediaType}</Chip>}
                            {platform && <Chip tone="blue">{platform}</Chip>}
                            {duration && <Chip tone="purple">{duration}</Chip>}
                          </div>

                          {linkedMedia && (
                            <p className="mt-3 text-xs text-gray-600 dark:text-gray-300">
                              Linked to a Media drop with the same slug ‚Äî built for fast review + licensing.
                            </p>
                          )}

                          {scene && (
                            <p className="mt-3 text-sm text-gray-800 dark:text-gray-100 leading-relaxed">
                              <span className="font-semibold">Scene intent:</span> {scene}
                            </p>
                          )}

                          {mood && (
                            <p className="mt-2 text-sm text-gray-700 dark:text-gray-200">
                              <span className="font-semibold">Mood:</span> {mood}
                            </p>
                          )}
                        </div>

                        <div className="flex gap-2 flex-wrap md:justify-end">
                          {licenseUrl && (
                            <a
                              href={licenseUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-4 py-2 rounded-full text-sm font-semibold bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-sm"
                            >
                              License ‚Üí
                            </a>
                          )}
                          {downloadUrl && (
                            <a
                              href={downloadUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-4 py-2 rounded-full text-sm font-semibold bg-gray-900 text-white hover:bg-black transition shadow-sm"
                            >
                              Download ‚Üí
                            </a>
                          )}
                          <a
                            href={`mailto:${contactEmail}?subject=${encodeURIComponent(
                              `Licensing / Commercial Inquiry ‚Äî ${post.title}`
                            )}`}
                            className="px-4 py-2 rounded-full text-sm font-semibold border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-900/60 hover:bg-gray-50 dark:hover:bg-gray-900 transition shadow-sm"
                          >
                            Inquire ‚Üí
                          </a>
                        </div>
                      </div>

                      {/* Player */}
                      <div className="mt-5">
                        <MediaEmbed mediaUrl={media_url} audioUrl={audio_url} />
                      </div>

                      {/* Rights row */}
                      <div className="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div className="flex flex-wrap gap-2">
                          <Chip>Commercial-ready</Chip>
                          <Chip tone="blue">Fast review</Chip>
                          <Chip tone="amber">Option / Sync</Chip>
                          {!!rightsNote && <Chip>{rightsNote}</Chip>}
                        </div>

                        <div className="text-xs text-gray-600 dark:text-gray-300">
                          For licensing & commercialization: <span className="font-semibold">{contactEmail}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Featured image */}
              {post.featured_image && (
                <div className="px-6 md:px-8 pt-6 md:pt-8">
                  <div className="overflow-hidden rounded-2xl bg-black/5 border border-gray-200/60 dark:border-gray-800">
                    <img
                      src={post.featured_image || PLACEHOLDER_IMAGE}
                      alt={post.title}
                      className="w-full h-64 md:h-80 object-cover"
                    />
                  </div>
                </div>
              )}

              {/* Content */}
              <div className="px-6 md:px-8 py-6 md:py-8">
                <div className="prose max-w-none prose-sm md:prose-base dark:prose-invert">
                  {renderContentBlocks(post.content)}
                </div>
              </div>
            </div>
          </div>
        </article>

        <section id="subscribe" className="container mx-auto px-4 pt-0 pb-16">
          <div className="max-w-4xl mx-auto">
            <SubscriptionForm
              formId="8427852"
              uid="637df68a05"
              title="Subscribe to Blog Updates"
              description="Weekly playbooks and progress logs from the Manyagi build ‚Äî no spam, just signal."
            />
          </div>
        </section>

        <Recommender />
      </div>
    </>
  );
}


===== FILE: pages/capital.js  (size=17155 bytes) =====
// pages/capital.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import SignalsSubscriptionForm from '../components/SignalsSubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';
import SectionIntro from '../components/SectionIntro';

// Helpers
const asList = (v) => {
  if (Array.isArray(v)) return v;
  if (Array.isArray(v?.items)) return v.items;
  return [];
};

const pickImage = (p) =>
  p?.thumbnail_url ||
  p?.display_image ||
  p?.image_url ||
  p?.image ||
  '/placeholder.png';

// üîπ Hard-coded foundation images (top 3 cards)
const FOUNDATION_IMAGES = {
  stocks:
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/site/general/2025/11/6R5CJc-blackkungfu_stock_market_thumbnail_-v_7_fed2b20f-2a5b-451e-9c24-c790004e0a43_2.png',
  crypto:
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/site/general/2025/11/A6LoAJ-blackkungfu_crypto_signals_thumbnail_-v_7_4aed0a87-0bf1-423b-8485-77758cf84c70_1.png',
  forex:
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/site/general/2025/11/bjEUUV-blackkungfu_forex_signals_thumbnail_-v_7_b6c6132a-cb53-46c4-99d0-fec7e95352e7_3.png',
};

export default function Capital() {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const dispatch = useDispatch();

  // global fallback price id for signals
  const globalSignalsPriceId =
    process.env.NEXT_PUBLIC_STRIPE_PRICE_ID || '';

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/products?division=capital');
        const json = await res.json();

        const rawList = asList(json);

        const list = rawList.map((p) => ({
          ...p,
          display_image: pickImage(p),
          productType:
            p.metadata?.productType ||
            p.product_type ||
            p.productType ||
            'download',
        }));

        if (list.length === 0) {
          // seed with a simple live-looking setup if DB is empty
          const fallback = [
            {
              id: 'signals-core',
              name: 'Core Signals Tier',
              price: 39.99,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/chart-hero.webp',
              division: 'capital',
              description:
                'Structured trade ideas across stocks, crypto, and forex with clear entries, exits, and invalidation levels.',
              productType: 'subscription',
              metadata: {
                productType: 'subscription',
                plan_type: 'Core Signals',
              },
            },
            {
              id: 'trading-playbook-pdf',
              name: 'Manyagi Trading Playbook (PDF)',
              price: 29.0,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/performance-chart.webp',
              division: 'capital',
              description:
                'A practical trading playbook that shows exactly how to build a rules-based plan, journal your trades, and review performance.',
              productType: 'download',
              metadata: {
                productType: 'download',
                license_type: 'ebook',
                format: 'pdf',
              },
            },
            {
              id: 'bot-license-core',
              name: 'Manyagi Bot License',
              price: 99.0,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/bot-license.webp',
              division: 'capital',
              description:
                'A license for an automated strategy that mirrors the same risk rules used in the Manyagi Trading Playbook.',
              productType: 'download',
              metadata: {
                productType: 'download',
                license_type: 'bot',
              },
            },
          ];

          setProducts(fallback);
        } else {
          setProducts(list);
        }
      } catch (error) {
        console.error('Capital fetch error:', error);
        setProducts([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const handleAddToCart = (product) => {
    const payload = {
      ...product,
      productType: 'download',
    };
    if (!payload.display_image) payload.display_image = pickImage(product);
    dispatch(addToCart(payload));
  };

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/chart-hero.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/performance-chart.webp',
  ];

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading capital content...
      </div>
    );
  }

  const list = asList(products);

  // üîπ All products are just offers now
  const offers = list;

  return (
    <>
      <Head>
        <title>Manyagi Capital ‚Äî Signals, Bots &amp; Trading Playbooks</title>
        <meta
          name="description"
          content="Browse Manyagi Capital signals tiers, trading playbooks, and automation tools designed to keep your risk controlled and your decisions repeatable."
        />
      </Head>

      {/* HERO */}
      <Hero
        kicker="Capital"
        title="Trade With Structure, Not Guesswork"
        lead="Signals, bots, and trading playbooks built around risk, journaling, and repeatable rules ‚Äî not lottery tickets."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#products"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
        >
          View Capital Catalog
        </Link>
      </Hero>

      {/* FOUNDATIONS INTRO */}
      <SectionIntro
        id="foundations"
        kicker="Foundations"
        title="Three Markets, One Playbook"
        lead="Before you lean on signals or automation, you need to understand the terrain. Stocks, crypto, and forex each move differently, but the discipline behind them is shared."
        tone="warm"
      />

      {/* EDUCATIONAL MARKET PILLARS */}
      <section className="container mx-auto px-4 pt-8 pb-16">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Stocks */}
          <Card
            title="Stocks"
            description="Ownership in real companies. Great for long-term compounding, dividends, and riding macro trends with position sizing that fits your risk."
            image={FOUNDATION_IMAGES.stocks}
            category="capital"
          >
            <ul className="text-sm text-gray-700 dark:text-gray-300 space-y-1 mt-2">
              <li>‚Ä¢ Best for: long-term investing &amp; swing trades</li>
              <li>‚Ä¢ Tools: earnings calendars, sector ETFs, options</li>
              <li>‚Ä¢ Focus: risk management over hype cycles</li>
            </ul>
          </Card>

          {/* Crypto */}
          <Card
            title="Crypto"
            description="24/7 markets with higher volatility, on-chain narratives, and cycles that reward patience and risk control more than raw aggression."
            image={FOUNDATION_IMAGES.crypto}
            category="capital"
          >
            <ul className="text-sm text-gray-700 dark:text-gray-300 space-y-1 mt-2">
              <li>‚Ä¢ Best for: trend following &amp; cycle plays</li>
              <li>‚Ä¢ Tools: spot, futures (with caution), staking</li>
              <li>‚Ä¢ Focus: position sizing &amp; avoiding over-leverage</li>
            </ul>
          </Card>

          {/* Forex */}
          <Card
            title="Forex"
            description="Currencies driven by macro data, interest rates, and global flows. Highly liquid, but punishes undisciplined leverage more than any other market."
            image={FOUNDATION_IMAGES.forex}
            category="capital"
          >
            <ul className="text-sm text-gray-700 dark:text-gray-300 space-y-1 mt-2">
              <li>‚Ä¢ Best for: structured systems &amp; backtested edges</li>
              <li>‚Ä¢ Tools: session-based strategies, EAs, algos</li>
              <li>‚Ä¢ Focus: consistency, risk per trade, journal</li>
            </ul>
          </Card>
        </div>
      </section>

      {/* ROADMAP INTRO (SectionIntro pill) */}
      <SectionIntro
        id="roadmap"
        kicker="Roadmap"
        title="How Manyagi Capital Evolves"
        lead="Education first, then signals, then automation. Every new product has to line up with the same rules: risk defined, process repeatable, stats tracked."
        tone="neutral"
      />

      {/* ROADMAP STEPS */}
      <section className="container mx-auto px-4 pt-8 pb-16">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="rounded-2xl border border-gray-200/80 dark:border-gray-700/80 bg-white/90 dark:bg-gray-900/80 p-5 shadow-sm">
            <p className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80 mb-2">
              Phase 1
            </p>
            <h3 className="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-50">
              Education &amp; Playbook
            </h3>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              Trading ebooks and frameworks that show you exactly how to define
              entries, exits, risk-per-trade, journaling, and review loops.
            </p>
          </div>

          <div className="rounded-2xl border border-gray-200/80 dark:border-gray-700/80 bg-white/90 dark:bg-gray-900/80 p-5 shadow-sm">
            <p className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80 mb-2">
              Phase 2
            </p>
            <h3 className="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-50">
              Signals &amp; Market Notes
            </h3>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              Rules-based trade ideas with context, risk levels, and
              invalidation points ‚Äî built as an extension of the playbook, not a
              replacement for thinking.
            </p>
          </div>

          <div className="rounded-2xl border border-gray-200/80 dark:border-gray-700/80 bg-white/90 dark:bg-gray-900/80 p-5 shadow-sm">
            <p className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80 mb-2">
              Phase 3
            </p>
            <h3 className="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-50">
              Automation &amp; Bots
            </h3>
            <p className="text-sm text-gray-700 dark:text-gray-300">
              Once systems are proven, bots and semi-automated tools reflect the
              same rules ‚Äî with safety rails and transparent stats instead of
              black-box magic.
            </p>
          </div>
        </div>
      </section>

      {/* PRODUCTS / CATALOG INTRO (SectionIntro pill) */}
      <SectionIntro
        id="products"
        kicker="Catalog"
        title="Capital Products &amp; Services"
        lead="Signals tiers, trading playbooks, and automation licenses ‚Äî all under the same risk-first philosophy."
        tone="neutral"
      />

      {/* PRODUCTS / CATALOG GRID */}
      <section className="container mx-auto px-4 pt-8 pb-16">
        {/* Snapshot pill */}
        <div className="max-w-3xl mx-auto mb-8">
          <div className="flex flex-col items-center gap-2 px-4 py-3 rounded-2xl bg-white/80 border border-amber-200/70 shadow-sm text-sm text-gray-700 text-center dark:bg-gray-900/70 dark:border-amber-800/60 dark:text-gray-100">
            <span className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80">
              Capital Snapshot
            </span>
            <span>
              Showing{' '}
              <span className="font-semibold">{offers.length}</span>{' '}
              live {offers.length === 1 ? 'offer' : 'offers'} right now.
            </span>
          </div>
        </div>

        {/* Products grid */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {offers.length === 0 ? (
            <div className="col-span-full text-center text-lg">
              No capital products are listed yet. Check back soon.
            </div>
          ) : (
            offers.map((product) => {
              const productKind =
                product.metadata?.productType ||
                product.productType ||
                'download';

              const hasPlanType = !!product.metadata?.plan_type;
              const hasLicenseType = !!product.metadata?.license_type;

              // Treat anything with a plan_type (and no license_type) as a subscription
              const isSub =
                productKind === 'subscription' ||
                (hasPlanType && !hasLicenseType);

              const stage =
                product.metadata?.plan_type ||
                product.metadata?.license_type ||
                product.metadata?.stage ||
                '';

              const priceId =
                product.metadata?.stripe_price_id || globalSignalsPriceId;

              const priceLabel = product.price
                ? `$${Number(product.price).toFixed(2)}/month`
                : '';

              const planName =
                product.metadata?.plan_type || product.name || 'Signals';

              return (
                <Card
                  key={product.id}
                  title={product.name}
                  description={product.description}
                  image={product.display_image || pickImage(product)}
                  category="capital"
                  buyButton={!isSub && product.price > 0 ? product : null}
                  onBuy={
                    !isSub && product.price > 0
                      ? () => handleAddToCart(product)
                      : undefined
                  }
                >
                  {/* Pill showing plan / license type */}
                  {stage && (
                    <div className="mb-3">
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200">
                        {String(stage).toUpperCase()}
                      </span>
                    </div>
                  )}

                  {/* Subscription / signals */}
                  {isSub ? (
                    <div className="mt-2 border rounded-2xl p-3 bg-white/90 dark:bg-gray-900/70 dark:border-gray-700 text-sm">
                      <SignalsSubscriptionForm
                        priceId={priceId}
                        planName={planName}
                        priceLabel={priceLabel}
                      />
                      {!priceId && (
                        <p className="text-[11px] text-red-500 mt-2">
                          Missing Stripe price ID for this tier. Add{' '}
                          <code>metadata.stripe_price_id</code> in the admin
                          panel or set <code>NEXT_PUBLIC_STRIPE_PRICE_ID</code>{' '}
                          as a fallback.
                        </p>
                      )}
                    </div>
                  ) : (
                    <div className="mt-2 text-xs text-gray-500 dark:text-gray-400">
                      Instant digital access after checkout. Review the full
                      risk disclaimer before using any strategy or automation.
                    </div>
                  )}
                </Card>
              );
            })
          )}
        </div>
      </section>

      {/* BIG CTA: UPDATES / ECOSYSTEM */}
      <SectionIntro
        id="subscribe"
        kicker="Stay In The Loop"
        title="Get Capital Updates &amp; New Releases"
        lead="Bookmark this page or plug into the Manyagi ecosystem through Publishing and Media ‚Äî release notes and performance breakdowns will roll out as new tiers and tools go live."
        tone="warm"
      />

      {/* CROSS-DIVISION RECOMMENDER */}
      <Recommender />
    </>
  );
}


===== FILE: pages/cart.js  (size=401 bytes) =====
import Head from 'next/head';
import Cart from '../components/Cart';

export default function CartPage() {
  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Cart</title>
        <meta name="description" content="Review and checkout your Manyagi Designs." />
      </Head>
      <section className="container mx-auto px-4 py-10">
        <Cart />
      </section>
    </>
  );
};


===== FILE: pages/checkout/studio-cancel.js  (size=1639 bytes) =====
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import { useMemo } from "react";

export default function StudioCheckoutCancel() {
  const router = useRouter();
  const next = useMemo(() => String(router.query?.next || "/studios"), [router.query]);

  return (
    <>
      <Head>
        <title>Checkout Cancelled ‚Äî Manyagi</title>
        <meta name="robots" content="noindex,nofollow" />
      </Head>

      <section className="container mx-auto px-4 py-16">
        <div className="max-w-2xl mx-auto rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/60 shadow-sm p-8 text-center">
          <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Checkout Cancelled</div>
          <h1 className="text-3xl font-bold mt-2">No worries</h1>
          <p className="opacity-80 mt-3">
            Your payment wasn‚Äôt completed. You can try again anytime.
          </p>

          <div className="mt-6 flex flex-wrap gap-3 justify-center">
            <button
              onClick={() => router.replace(next || "/studios")}
              className="px-6 py-3 rounded-2xl bg-black text-white dark:bg-white dark:text-black font-semibold"
            >
              Back
            </button>
            <Link
              href="/studios"
              className="px-6 py-3 rounded-2xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40"
            >
              Studios Library
            </Link>
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/checkout/studio-success.js  (size=2974 bytes) =====
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import { useEffect, useMemo, useState } from "react";
import { supabase } from "@/lib/supabase";

export default function StudioCheckoutSuccess() {
  const router = useRouter();
  const session_id = useMemo(() => String(router.query?.session_id || ""), [router.query]);
  const next = useMemo(() => String(router.query?.next || "/studios"), [router.query]);

  const [countdown, setCountdown] = useState(4);
  const [status, setStatus] = useState("Finalizing your access‚Ä¶");

  useEffect(() => {
    if (!router.isReady) return;

    // Optional: try a quick session refresh (helps when coming back from Stripe)
    supabase.auth.getSession().catch(() => {});

    // Give webhook time to write entitlement, then send user back.
    const t1 = setTimeout(() => setStatus("Almost done‚Ä¶ redirecting you back to Studios."), 1200);

    const interval = setInterval(() => {
      setCountdown((c) => (c <= 1 ? 0 : c - 1));
    }, 1000);

    const t2 = setTimeout(() => {
      router.replace(next || "/studios");
    }, 4200);

    return () => {
      clearTimeout(t1);
      clearTimeout(t2);
      clearInterval(interval);
    };
  }, [router.isReady, next, router]);

  return (
    <>
      <Head>
        <title>Studio Access Unlocked ‚Äî Manyagi</title>
        <meta name="robots" content="noindex,nofollow" />
      </Head>

      <section className="container mx-auto px-4 py-16">
        <div className="max-w-2xl mx-auto rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/60 shadow-sm p-8 text-center">
          <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Payment Success</div>
          <h1 className="text-3xl font-bold mt-2">Studio access unlocked</h1>

          <p className="opacity-80 mt-3">{status}</p>

          {session_id ? (
            <div className="text-xs opacity-60 mt-3 break-all">
              session_id: {session_id}
            </div>
          ) : null}

          <div className="mt-6 flex flex-wrap gap-3 justify-center">
            <button
              onClick={() => router.replace(next || "/studios")}
              className="px-6 py-3 rounded-2xl bg-black text-white dark:bg-white dark:text-black font-semibold"
            >
              Continue ({countdown || 0})
            </button>

            <Link
              href="/studios"
              className="px-6 py-3 rounded-2xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40"
            >
              Studios Library
            </Link>
          </div>

          <div className="text-xs opacity-60 mt-6">
            If you still see locked content after redirect, refresh once ‚Äî the entitlement is applied by Stripe webhook.
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/coming-soon.js  (size=1293 bytes) =====
// pages/coming-soon.js
import Head from 'next/head';
import Hero from '../components/Hero';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';

export default function ComingSoon() {
  const carouselImages = [
    '/images/og-comingsoon.webp',
    '/images/home-carousel-1.webp',
    '/images/home-carousel-2.webp',
  ];

  return (
    <>
      <Head>
        <title>Coming Soon ‚Äî Manyagi</title>
        <meta name="description" content="This page is under construction. Sign up for updates." />
      </Head>
      <Hero
        kicker="Coming Soon"
        title="Page Under Construction"
        lead="We're building this page ‚Äî join the Manyagi newsletter for updates and early access."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <a href="https://manyagi.net" className="btn bg-blue-600 text-white py-4 px-6 rounded hover:scale-105 transition">
          Back to Home
        </a>
      </Hero>
      <section className="container mx-auto px-4 py-16">
        <SubscriptionForm formId="8427635" uid="db12290300" title="Get Notified" description="Be the first to know when it's live." />
      </section>
      <Recommender />
    </>
  );
};


===== FILE: pages/contact.js  (size=7553 bytes) =====
import Head from 'next/head';
import { useForm, ValidationError } from '@formspree/react';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import SectionIntro from '../components/SectionIntro';

export default function Contact() {
  const [state, handleSubmit] = useForm('xwkdwgdp');

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-contact.webp',
  ];

  return (
    <>
      <Head>
        <title>Contact Manyagi ‚Äî Global Creative & Capital Group</title>
        <meta
          name="description"
          content="Contact Manyagi LLC for publishing, media, design, tech, capital, and realty collaborations, partnerships, and general inquiries."
        />
      </Head>

      {/* HERO */}
      <Hero
        kicker="Contact"
        title="Get in Touch with Manyagi"
        lead="Partnerships, licensing, publishing, media, tech, and capital ‚Äî this is your direct line into the Manyagi ecosystem."
        carouselImages={carouselImages}
        height="h-[500px]"
      />

      {/* OVERVIEW / INTRO */}
      <SectionIntro
        id="contact-overview"
        kicker="Start a Conversation"
        title="Talk to the Right Division"
        lead="Use the form below for general inquiries, or reach out directly to a specific division using the dedicated emails."
        tone="neutral"
        align="center"
        maxWidth="max-w-3xl"
      />

      {/* DIVISION EMAIL GRID */}
      <section className="container mx-auto px-4 pb-10">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
          {/* General */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">General / HQ</h3>
            <p className="text-xs text-gray-500 mb-2">Group-level questions &amp; opportunities</p>
            <p className="font-mono text-xs break-all">info@manyagi.net</p>
          </div>

          {/* Publishing */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">Publishing</h3>
            <p className="text-xs text-gray-500 mb-2">Books, IP, adaptations &amp; rights</p>
            <p className="font-mono text-xs break-all">publishing@manyagi.net</p>
          </div>

          {/* Designs */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">Designs</h3>
            <p className="text-xs text-gray-500 mb-2">Branding, visuals, apparel &amp; merch</p>
            <p className="font-mono text-xs break-all">designs@manyagi.net</p>
          </div>

          {/* Media */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">Media</h3>
            <p className="text-xs text-gray-500 mb-2">Content, channels, and campaigns</p>
            <p className="font-mono text-xs break-all">media@manyagi.net</p>
          </div>

          {/* Tech */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">Tech</h3>
            <p className="text-xs text-gray-500 mb-2">Apps, platforms, web &amp; integrations</p>
            <p className="font-mono text-xs break-all">tech@manyagi.net</p>
          </div>

          {/* Capital */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">Capital</h3>
            <p className="text-xs text-gray-500 mb-2">Capital, strategy &amp; financial collaborations</p>
            <p className="font-mono text-xs break-all">capital@manyagi.net</p>
          </div>

          {/* Realty */}
          <div className="rounded-2xl border bg-white/90 dark:bg-gray-950/90 p-4 shadow-sm text-center">
            <h3 className="font-semibold mb-1">Realty</h3>
            <p className="text-xs text-gray-500 mb-2">Real estate &amp; physical brand concepts</p>
            <p className="font-mono text-xs break-all">realty@manyagi.net</p>
          </div>
        </div>
      </section>

      {/* FORM SECTION */}
      <SectionIntro
        id="form"
        kicker="Contact Form"
        title="Send Us a Message"
        lead="If you‚Äôre not sure where your message fits, use this form ‚Äî we‚Äôll route it to the right division internally."
        tone="card"
        align="center"
        maxWidth="max-w-2xl"
      />

      <section className="container mx-auto px-4 pb-16">
        <div className="max-w-xl mx-auto rounded-3xl border bg-white/95 dark:bg-gray-950/95 p-6 shadow-sm">
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium mb-1"
              >
                Email Address
              </label>
              <input
                id="email"
                type="email"
                name="email"
                className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
              <ValidationError prefix="Email" field="email" errors={state.errors} />
            </div>

            <div>
              <label
                htmlFor="message"
                className="block text-sm font-medium mb-1"
              >
                Message
              </label>
              <textarea
                id="message"
                name="message"
                rows={5}
                className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
              <ValidationError
                prefix="Message"
                field="message"
                errors={state.errors}
              />
            </div>

            <button
              type="submit"
              disabled={state.submitting}
              className="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-60"
            >
              {state.submitting ? 'Sending‚Ä¶' : 'Submit'}
            </button>

            {state.succeeded && (
              <p className="mt-2 text-sm text-green-600">
                Thanks for your message ‚Äî the Manyagi team will get back to you soon.
              </p>
            )}
          </form>
        </div>
      </section>

      {/* NEWSLETTER */}
      <section id="subscribe" className="container mx-auto px-4 pb-16">
        <SubscriptionForm
          formId="8427853"
          uid="637df68a06"
          title="Stay Connected"
          description="Join the Manyagi ecosystem for launch announcements, opportunities, and cross-division updates."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/dashboard.js  (size=6700 bytes) =====
// pages/dashboard.js
import Head from 'next/head';
import { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';

function formatDate(d) {
  try {
    return new Date(d).toLocaleDateString();
  } catch {
    return '‚Äî';
  }
}

function formatCurrency(n) {
  if (typeof n !== 'number') return n ?? '‚Äî';
  try {
    return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(n);
  } catch {
    return `$${n.toFixed(2)}`;
  }
}

export default function Dashboard() {
  const router = useRouter();
  const [user, setUser] = useState(null);
  const [error, setError] = useState(null);
  const [orders, setOrders] = useState([]);
  const [subscriptions, setSubscriptions] = useState([]);
  const [affiliate, setAffiliate] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;

    (async () => {
      try {
        // Authenticated user
        const {
          data: { user: authUser },
          error: authError,
        } = await supabase.auth.getUser();

        if (authError || !authUser) {
          router.push('/login');
          return;
        }
        if (!isMounted) return;
        setUser(authUser);

        // Role check
        const { data: userRow, error: roleError } = await supabase
          .from('users')
          .select('role')
          .eq('id', authUser.id)
          .maybeSingle();

        if (roleError) {
          if (!isMounted) return;
          setError('Failed to load user role. Please try again.');
          setLoading(false);
          return;
        }
        if (!userRow) {
          if (!isMounted) return;
          setError('User data not found. Contact support.');
          setLoading(false);
          return;
        }
        if (userRow.role === 'admin') {
          router.push('/admin');
          return;
        }

        // Parallel fetches
        const [o, s, a] = await Promise.all([
          supabase
            .from('orders')
            .select('*')
            .eq('user_id', authUser.id)
            .order('created_at', { ascending: false }),
          supabase
            .from('subscriptions')
            .select('*')
            .eq('user_id', authUser.id)
            .order('created_at', { ascending: false }),
          supabase.from('affiliates').select('*').eq('user_id', authUser.id).maybeSingle(),
        ]);

        if (!isMounted) return;

        if (o.error || s.error || a.error) {
          setError('Failed to load some dashboard data. Please try again.');
        }

        setOrders(o.data || []);
        setSubscriptions(s.data || []);
        setAffiliate(a.data || null);
        setLoading(false);
      } catch {
        if (!isMounted) return;
        setError('An unexpected error occurred. Please try again.');
        setLoading(false);
      }
    })();

    return () => {
      isMounted = false;
    };
  }, [router]);

  if (error) return <p className="p-6 text-red-500">{error}</p>;
  if (loading) return <p className="p-6">Loading dashboard...</p>;

  return (
    <>
      <Head>
        <title>Manyagi User Dashboard</title>
      </Head>

      <div className="container mx-auto px-4 py-8 space-y-8">
        <h1 className="text-2xl font-bold">User Dashboard</h1>

        {/* Orders */}
        <section>
          <h2 className="text-xl font-bold mb-2">Your Orders</h2>
          {orders.length === 0 ? (
            <p>No orders yet.</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="border p-2 text-left">Order ID</th>
                    <th className="border p-2 text-left">Date</th>
                    <th className="border p-2 text-left">Total</th>
                    <th className="border p-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.map((order) => (
                    <tr key={order.id}>
                      <td className="border p-2">{order.id}</td>
                      <td className="border p-2">{formatDate(order.created_at)}</td>
                      <td className="border p-2">{formatCurrency(order.total_amount)}</td>
                      <td className="border p-2 capitalize">{order.status}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* Subscriptions */}
        <section>
          <h2 className="text-xl font-bold mb-2">Your Subscriptions</h2>
          {subscriptions.length === 0 ? (
            <p>No subscriptions yet.</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="border p-2 text-left">Subscription ID</th>
                    <th className="border p-2 text-left">Start Date</th>
                    <th className="border p-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {subscriptions.map((sub) => (
                    <tr key={sub.id}>
                      <td className="border p-2">{sub.id}</td>
                      <td className="border p-2">{formatDate(sub.created_at)}</td>
                      <td className="border p-2 capitalize">{sub.status}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* Affiliate */}
        <section>
          <h2 className="text-xl font-bold mb-2">Your Affiliate Info</h2>
          {affiliate ? (
            <div className="rounded border p-3">
              <p>
                <span className="font-semibold">Referral Code:</span>{' '}
                <span className="font-mono">{affiliate.referral_code}</span>
              </p>
            </div>
          ) : (
            <p>No affiliate account. Contact support to join.</p>
          )}
        </section>

        <button
          onClick={() => supabase.auth.signOut().then(() => router.push('/'))}
          className="p-2 bg-red-500 text-white rounded"
        >
          Logout
        </button>
      </div>
    </>
  );
}


===== FILE: pages/designs.js  (size=33504 bytes) =====
// pages/designs.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState, useMemo } from 'react';
import { useRouter } from 'next/router';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';
import SectionIntro from '../components/SectionIntro';

const PAGE_SIZE = 16;
const RAILS_LIMIT = 200; // larger pull just for rails

// Prefer higher-quality image fields when available
function pickImage(p) {
  return (
    (p?.thumbnail_url &&
      typeof p.thumbnail_url === 'string' &&
      p.thumbnail_url) ||
    (p?.display_image &&
      typeof p.display_image === 'string' &&
      p.display_image) ||
    (p?.image_url && typeof p.image_url === 'string' && p.image_url) ||
    (p?.image && typeof p.image === 'string' && p.image) ||
    '/placeholder.png' // CSP-safe local fallback
  );
}

// Simple shuffle for light randomization of rails
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// Stable key for dedupe across rails
function productKey(p) {
  return p?.id || p?.slug || p?.sku || p?.name || '';
}

export default function Designs() {
  const router = useRouter();
  const dispatch = useDispatch();

  // Grid state (paged)
  const [items, setItems] = useState([]);
  const [total, setTotal] = useState(0);

  // Rails state (global, non-paged)
  const [railItems, setRailItems] = useState([]);

  const [loading, setLoading] = useState(true);
  const [railsLoading, setRailsLoading] = useState(true);
  const [fetchingMore, setFetchingMore] = useState(false);
  const [showModal, setShowModal] = useState(false);

  const initial = useMemo(
    () => ({
      q: (router.query.q || '').toString(),
      collection: (router.query.collection || '').toString(),
      tag: (router.query.tag || '').toString(),
      sort: (router.query.sort || 'new').toString(),
    }),
    [router.query]
  );

  const [q, setQ] = useState(initial.q);
  const [collection, setCollection] = useState(initial.collection);
  const [tag, setTag] = useState(initial.tag);
  const [sort, setSort] = useState(initial.sort);

  const canLoadMore = items.length < total;

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-1.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-2.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-3.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-4.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-5.webp',
  ];

  // --- GRID FETCH (paged, respects filters) ---
  const fetchProducts = async ({ offset = 0, append = false } = {}) => {
    const params = new URLSearchParams({
      division: 'designs',
      limit: String(PAGE_SIZE),
      offset: String(offset),
      sort: sort || 'new',
    });
    if (q) params.set('q', q);
    if (collection) params.set('collection', collection);
    if (tag) params.set('tag', tag);

    try {
      if (offset === 0) setLoading(true);
      else setFetchingMore(true);

      const res = await fetch(`/api/products?${params.toString()}`);
      const data = await res.json();

      const nextItemsRaw = Array.isArray(data?.items)
        ? data.items
        : Array.isArray(data)
        ? data
        : [];

      const nextItems = nextItemsRaw.map((p) => ({
        ...p,
        display_image: pickImage(p),
      }));

      setItems((prev) => (append ? [...prev, ...nextItems] : nextItems));
      setTotal(Number(data?.total ?? nextItems.length));
    } catch (e) {
      console.error('Designs fetch error:', e);
      if (offset === 0) {
        const sample = [
          {
            id: 'fallback-tee',
            name: 'Sample T-Shirt',
            price: 29.99,
            display_image:
              'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
            division: 'designs',
            description:
              'Fallback design merchandise. Made with 100% cotton for comfort.',
            printful_product_id: 'fallback-tee-id',
            productType: 'merch',
            metadata: { book: 'Sample', prompt: 1 },
          },
        ];
        setItems(sample);
        setTotal(sample.length);
      }
    } finally {
      setLoading(false);
      setFetchingMore(false);
    }
  };

  // --- RAIL FETCH (global, not paged, no filters; just used for rails) ---
  const fetchRailProducts = async () => {
    const params = new URLSearchParams({
      division: 'designs',
      limit: String(RAILS_LIMIT),
      offset: '0',
      sort: 'new',
    });

    try {
      setRailsLoading(true);
      const res = await fetch(`/api/products?${params.toString()}`);
      const data = await res.json();

      const raw = Array.isArray(data?.items)
        ? data.items
        : Array.isArray(data)
        ? data
        : [];

      const normalized = raw.map((p) => ({
        ...p,
        display_image: pickImage(p),
      }));

      setRailItems(normalized);
    } catch (e) {
      console.error('Designs rails fetch error:', e);
      // Fallback: at least use whatever is already in the grid
      setRailItems((prev) => (prev.length ? prev : items));
    } finally {
      setRailsLoading(false);
    }
  };

  useEffect(() => {
    setQ(initial.q);
    setCollection(initial.collection);
    setTag(initial.tag);
    setSort(initial.sort || 'new');

    // fetch paged grid (respects filters)
    fetchProducts({ offset: 0, append: false });

    // Always keep rails based on the *global* pool, independent of filters
    // so NFTs, bestsellers, etc. can appear even if not on the first page.
    fetchRailProducts();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [initial.q, initial.collection, initial.tag, initial.sort]);

  const applyFilters = (e) => {
    e?.preventDefault?.();
    const params = new URLSearchParams();
    params.set('division', 'designs');
    if (q) params.set('q', q);
    if (collection) params.set('collection', collection);
    if (tag) params.set('tag', tag);
    if (sort) params.set('sort', sort);
    router.push(`/designs?${params.toString()}`, undefined, { shallow: true });
  };

  const clearFilters = () => {
    setQ('');
    setCollection('');
    setTag('');
    setSort('new');
    router.push('/designs?division=designs', undefined, { shallow: true });
  };

  const loadMore = () => {
    if (!canLoadMore || fetchingMore) return;
    fetchProducts({ offset: items.length, append: true });
  };

  const collectionOptions = useMemo(() => {
    const set = new Set();
    items.forEach((p) => {
      if (p?.metadata?.book) set.add(p.metadata.book);
      if (p?.metadata?.series) set.add(p.metadata.series);
      if (p?.metadata?.drop) set.add(p.metadata.drop);
      if (p?.metadata?.year) set.add(String(p.metadata.year));
      if (p?.metadata?.prompt) set.add(`prompt-${p.metadata.prompt}`);
    });
    return Array.from(set);
  }, [items]);

  const tagOptions = useMemo(() => {
    const set = new Set();
    items.forEach((p) => (p?.tags || []).forEach((t) => set.add(t)));
    return Array.from(set);
  }, [items]);

  const handleAddToCart = (product) => {
    dispatch(
      addToCart({
        ...product,
        productType: 'merch',
        printful_product_id: product.printful_product_id,
        metadata: product.metadata || {},
      })
    );
    setShowModal(true);
    setTimeout(() => setShowModal(false), 1600);
  };

  const filtersActive =
    q || collection || tag || (sort && sort !== 'new');

  // ---- Multi-rail derived slices (based on global railItems) ----
  const rails = useMemo(() => {
    const base = railItems.length ? railItems : items;
    const usedIds = new Set();

    const pickUnique = (candidates, limit) => {
      if (!candidates || !candidates.length || limit <= 0) return [];
      const out = [];
      const pool = shuffle(candidates);
      for (const p of pool) {
        const key = productKey(p);
        if (!key || usedIds.has(key)) continue;
        out.push(p);
        usedIds.add(key);
        if (out.length >= limit) break;
      }
      return out;
    };

    // Featured collections (drop/series/book), flagged via metadata or tags
    const featuredCandidatesMap = new Map();
    base.forEach((p) => {
      const m = p.metadata || {};
      const tags = p.tags || [];
      const isFeatured =
        m.featured_collection || tags.includes('featured_collection');
      if (!isFeatured) return;
      const label =
        m.drop || m.series || m.book || (m.year && String(m.year)) || p.name;
      if (!label) return;
      if (!featuredCandidatesMap.has(label)) {
        featuredCandidatesMap.set(label, p);
      }
    });
    const featuredCandidates = Array.from(featuredCandidatesMap.values());

    // NFTs (PRIORITY lane ‚Äì make sure OpenSea URLs are always in here)
    const nftCandidates = base.filter((p) => {
      const m = p.metadata || {};
      const tags = (p.tags || []).map((t) => t.toLowerCase());
      const nftUrl = m.nft_url || m.nft_link || '';

      const hasOpenSea =
        typeof nftUrl === 'string' && nftUrl.includes('opensea.io');

      return (
        hasOpenSea ||
        m.nft ||
        tags.includes('nft') ||
        tags.includes('token') ||
        tags.includes('onchain')
      );
    });

    // Bestsellers (metadata or tag)
    const bestsellerCandidates = base.filter((p) => {
      const m = p.metadata || {};
      const tags = (p.tags || []).map((t) => t.toLowerCase());
      return m.bestseller || tags.includes('bestseller');
    });

    // Wall / studio art
    const wallArtCandidates = base.filter((p) => {
      const m = p.metadata || {};
      const tags = (p.tags || []).map((t) => t.toLowerCase());
      const type = String(m.product_type || '').toLowerCase();
      return (
        tags.includes('poster') ||
        tags.includes('print') ||
        tags.includes('wall_art') ||
        tags.includes('canvas') ||
        type === 'poster' ||
        type === 'print'
      );
    });

    // Under $25
    const under25Candidates = base.filter((p) => {
      const price = Number(p.price || p.metadata?.price);
      return price > 0 && price < 25;
    });

    // ORDER MATTERS:
    // 1) Featured collections
    // 2) NFTs (OpenSea & other on-chain)
    // 3) Bestsellers
    // 4) Wall art
    // 5) Under $25
    const featuredCollections = pickUnique(featuredCandidates, 4);
    const nftDesigns = pickUnique(nftCandidates, 8);
    const bestsellerDesigns = pickUnique(bestsellerCandidates, 8);
    const wallArtDesigns = pickUnique(wallArtCandidates, 8);
    const under25Designs = pickUnique(under25Candidates, 8);

    return {
      featuredCollections,
      nftDesigns,
      bestsellerDesigns,
      wallArtDesigns,
      under25Designs,
    };
  }, [railItems, items]);

  const {
    featuredCollections,
    nftDesigns,
    bestsellerDesigns,
    wallArtDesigns,
    under25Designs,
  } = rails;

  if (loading && railsLoading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading designs‚Ä¶
      </div>
    );
  }

  return (
    <>
      <Head>
        <title>Manyagi Designs ‚Äî Premium Apparel & Gear</title>
        <meta
          name="description"
          content="High-quality T-shirts, mugs, prints, and digital collectibles inspired by the Manyagi Universe. Exclusive drops, story-linked collections, and premium merch."
        />
      </Head>

      {/* HERO */}
      <Hero
        kicker="Manyagi Designs"
        title="Wear the Universe"
        lead="Story-linked apparel, posters, and gear forged from the worlds of the Manyagi Universe. Designed to feel like limited drops, not generic merch."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#products"
          className="btn bg-blue-600 text-white py-3 px-5 rounded hover:scale-105 transition"
        >
          Browse the Collection
        </Link>
      </Hero>

      {/* MICRO-NAV STRIP (Disney+ style) */}
      <section className="container mx-auto px-4 -mt-8 mb-10">
        <div className="flex gap-2 overflow-x-auto no-scrollbar justify-center text-xs md:text-[13px]">
          {[
            { href: '#products', label: 'All Designs' },
            { href: '#collections', label: 'Collections' },
            { href: '#nfts', label: 'NFTs' },
            { href: '#bestsellers', label: 'Bestsellers' },
            { href: '#wall-art', label: 'Wall Art' },
            { href: '#under-25', label: 'Under $25' },
            { href: '#subscribe', label: 'Updates' },
          ].map((item) => (
            <a
              key={item.href}
              href={item.href}
              className="whitespace-nowrap px-3 py-2 rounded-full border border-gray-200/80 bg-white/80 text-gray-800 hover:bg-gray-100 hover:border-blue-400 transition dark:bg-gray-900/80 dark:border-gray-700 dark:text-gray-100 dark:hover:bg-gray-800"
            >
              {item.label}
            </a>
          ))}
        </div>
      </section>

      {/* INTRO TO DESIGNS */}
      <SectionIntro
        id="designs-overview"
        kicker="Merch, But Cinematic"
        title="Designs Made to Feel Like Scenes"
        lead="Each piece is tied to a moment, character, or location from the Manyagi stories‚Äîso when you wear it, it feels like a frame pulled from a prestige series."
        tone="warm"
      />

      {/* TRUST BADGES */}
      <section className="container mx-auto px-4 pb-10 -mt-6">
        <div className="flex flex-wrap justify-center gap-4 md:gap-8">
          {[
            {
              label: 'Premium Printful Fulfillment',
              sub: 'Global, on-demand production',
            },
            {
              label: 'Secure Payment',
              sub: 'Stripe, PayPal & major cards',
            },
            {
              label: '30-Day Returns',
              sub: 'On misprints & damaged items',
            },
          ].map((badge) => (
            <div
              key={badge.label}
              className="flex flex-col items-center px-4 py-3 rounded-2xl bg-white/80 shadow-sm border border-amber-100 text-xs md:text-sm text-gray-700 dark:bg-gray-900/70 dark:border-amber-800/50 dark:text-gray-100"
            >
              <span className="font-semibold">{badge.label}</span>
              <span className="opacity-80">{badge.sub}</span>
            </div>
          ))}
        </div>
      </section>

      {/* FILTER BAR */}
      <section className="container mx-auto px-4 pt-4">
        <div className="rounded-3xl bg-white/80 dark:bg-gray-900/80 border border-amber-100/80 dark:border-gray-800 shadow-sm px-4 md:px-6 py-5 md:py-6">
          <form
            onSubmit={applyFilters}
            className="flex flex-col md:flex-row gap-4 items-stretch md:items-end"
          >
            <div className="flex-1">
              <label className="block text-xs font-semibold tracking-wide uppercase mb-1 text-gray-600 dark:text-gray-300">
                Search
              </label>
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                placeholder="Search title, scene, book‚Ä¶"
                className="w-full border rounded-xl px-3 py-2 text-sm dark:bg-gray-950 dark:border-gray-700"
              />
            </div>
            <div>
              <label className="block text-xs font-semibold tracking-wide uppercase mb-1 text-gray-600 dark:text-gray-300">
                Collection
              </label>
              <select
                value={collection}
                onChange={(e) => setCollection(e.target.value)}
                className="border rounded-xl px-3 py-2 w-40 md:w-48 text-sm dark:bg-gray-950 dark:border-gray-700"
              >
                <option value="">All</option>
                {collectionOptions.map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs font-semibold tracking-wide uppercase mb-1 text-gray-600 dark:text-gray-300">
                Tag
              </label>
              <select
                value={tag}
                onChange={(e) => setTag(e.target.value)}
                className="border rounded-xl px-3 py-2 w-40 md:w-48 text-sm dark:bg-gray-950 dark:border-gray-700"
              >
                <option value="">All</option>
                {tagOptions.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs font-semibold tracking-wide uppercase mb-1 text-gray-600 dark:text-gray-300">
                Sort
              </label>
              <select
                value={sort}
                onChange={(e) => setSort(e.target.value)}
                className="border rounded-xl px-3 py-2 w-32 md:w-40 text-sm dark:bg-gray-950 dark:border-gray-700"
              >
                <option value="new">Newest</option>
                <option value="price_asc">Price ‚Üë</option>
                <option value="price_desc">Price ‚Üì</option>
              </select>
            </div>
            <div className="flex gap-2 md:gap-3">
              <button className="px-4 py-2 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700">
                Apply
              </button>
              <button
                type="button"
                onClick={clearFilters}
                className="px-4 py-2 bg-gray-100 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-100 dark:hover:bg-gray-700"
              >
                Clear
              </button>
            </div>
          </form>
        </div>
      </section>

      {/* SNAPSHOT BAR + PRODUCTS GRID (All Designs rail) */}
      <section id="products" className="container mx-auto px-4 py-10">
        {/* Snapshot pill */}
        <div className="max-w-3xl mx-auto mb-8">
          <div className="flex flex-col items-center gap-2 px-4 py-3 rounded-2xl bg-white/80 border border-amber-200/70 shadow-sm text-sm text-gray-700 text-center dark:bg-gray-900/70 dark:border-amber-800/60 dark:text-gray-100">
            <span className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80">
              Design Gallery
            </span>
            <span>
              Showing{' '}
              <span className="font-semibold">{items.length}</span> of{' '}
              <span className="font-semibold">{total}</span> designs
              {filtersActive && ' in your filtered view.'}
              {!filtersActive && '.'}
            </span>
            {filtersActive && (
              <button
                type="button"
                onClick={clearFilters}
                className="inline-flex items-center gap-1 rounded-full border border-amber-300/80 bg-amber-50/70 px-3 py-1 text-xs font-medium text-amber-900 hover:bg-amber-100 dark:border-amber-700/80 dark:bg-amber-900/40 dark:text-amber-50 dark:hover:bg-amber-900/60"
              >
                Clear all filters
              </button>
            )}
          </div>
        </div>

        {items.length === 0 ? (
          <div className="text-center py-20">
            <p className="text-lg">No products found for your filters.</p>
            <button
              onClick={clearFilters}
              className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-xl"
            >
              Reset Filters
            </button>
          </div>
        ) : (
          <>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5">
              {items.map((product) => (
                <Card
                  key={product.id}
                  title={product.name}
                  description={`${product.description} Made with premium materials for lasting comfort.`}
                  image={product.display_image}
                  category="designs"
                  buyButton={product}
                  onBuy={() => handleAddToCart(product)}
                />
              ))}
            </div>

            {canLoadMore && (
              <div className="text-center mt-10">
                <button
                  disabled={fetchingMore}
                  onClick={loadMore}
                  className="px-5 py-2 rounded-full bg-gray-200 hover:bg-gray-300 text-sm font-medium dark:bg-gray-800 dark:hover:bg-gray-700"
                >
                  {fetchingMore ? 'Loading‚Ä¶' : 'Load more designs'}
                </button>
              </div>
            )}
          </>
        )}
      </section>

      {/* FEATURED COLLECTIONS RAIL */}
      {featuredCollections.length > 0 && (
        <>
          <SectionIntro
            id="collections"
            kicker="Featured Collections"
            title="Story-Linked Capsules & Drops"
            lead="Curated sets of tees, posters, and accessories tied to specific books, arcs, and seasons in the Manyagi Universe."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-12 -mt-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-5">
              {featuredCollections.map((p) => {
                const m = p.metadata || {};
                return (
                  <Card
                    key={p.id}
                    title={m.drop || m.series || p.name}
                    description={p.description}
                    image={p.display_image}
                    category="designs"
                  >
                    {m.book && (
                      <div className="mb-2 flex justify-center">
                        <span className="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                          From {m.book}
                        </span>
                      </div>
                    )}
                    <div className="mt-3 flex justify-center">
                      <Link
                        href={`/designs?collection=${encodeURIComponent(
                          m.drop || m.series || m.book || ''
                        )}`}
                        className="text-xs font-semibold text-blue-600 hover:underline"
                      >
                        View this collection ‚Üí
                      </Link>
                    </div>
                  </Card>
                );
              })}
            </div>
          </section>
        </>
      )}

      {/* NFT RAIL */}
      {nftDesigns.length > 0 && (
        <>
          <SectionIntro
            id="nfts"
            kicker="Digital Collectibles"
            title="On-Chain Scenes & Covers"
            lead="Select designs are available as NFTs or digital collectibles ‚Äî made for collectors who want a stake in the universe."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-12 -mt-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-5">
              {nftDesigns.map((product) => {
                const m = product.metadata || {};
                const nftUrl = m.nft_url || m.nft_link || '';
                return (
                  <Card
                    key={product.id}
                    title={product.name}
                    description={product.description}
                    image={product.display_image}
                    category="designs"
                  >
                    <div className="flex flex-wrap gap-2 justify-center mb-3">
                      <span className="text-[11px] px-2 py-1 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-200">
                        NFT / Digital Collectible
                      </span>
                      {m.book && (
                        <span className="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                          {m.book}
                        </span>
                      )}
                    </div>

                    <div className="mt-3 flex justify-center gap-2 flex-wrap">
                      {nftUrl && (
                        <a
                          href={nftUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="btn bg-purple-600 text-white py-2 px-4 rounded text-xs hover:bg-purple-700 transition"
                        >
                          View NFT
                        </a>
                      )}
                      <button
                        type="button"
                        onClick={() => handleAddToCart(product)}
                        className="btn bg-gray-900 text-white py-2 px-4 rounded text-xs hover:bg-black transition"
                      >
                        Get the Physical
                      </button>
                    </div>
                  </Card>
                );
              })}
            </div>
          </section>
        </>
      )}

      {/* BESTSELLERS RAIL */}
      {bestsellerDesigns.length > 0 && (
        <>
          <SectionIntro
            id="bestsellers"
            kicker="Bestsellers"
            title="Pieces People Keep Reordering"
            lead="Quiet fan favorites ‚Äî the designs that get reordered, gifted, and spotted the most."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-12 -mt-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-5">
              {bestsellerDesigns.map((product) => {
                const m = product.metadata || {};
                return (
                  <Card
                    key={product.id}
                    title={product.name}
                    description={product.description}
                    image={product.display_image}
                    category="designs"
                  >
                    {m.book && (
                      <div className="mb-2 flex justify-center">
                        <span className="text-[11px] px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200">
                          Fan favorite from {m.book}
                        </span>
                      </div>
                    )}
                    <button
                      type="button"
                      onClick={() => handleAddToCart(product)}
                      className="mt-3 w-full inline-flex justify-center rounded-md bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-700 transition"
                    >
                      Add to Cart
                    </button>
                  </Card>
                );
              })}
            </div>
          </section>
        </>
      )}

      {/* WALL ART RAIL */}
      {wallArtDesigns.length > 0 && (
        <>
          <SectionIntro
            id="wall-art"
            kicker="Wall & Studio"
            title="Posters & Prints"
            lead="Build a Manyagi wall ‚Äî key scenes, characters, and emblems framed as high-resolution art."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-12 -mt-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-5">
              {wallArtDesigns.map((product) => {
                const m = product.metadata || {};
                return (
                  <Card
                    key={product.id}
                    title={product.name}
                    description={product.description}
                    image={product.display_image}
                    category="designs"
                  >
                    <div className="flex flex-wrap gap-2 justify-center mb-2">
                      <span className="text-[11px] px-2 py-1 rounded-full bg-blue-50 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200">
                        Poster / Wall Art
                      </span>
                      {m.book && (
                        <span className="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                          {m.book}
                        </span>
                      )}
                    </div>
                    <button
                      type="button"
                      onClick={() => handleAddToCart(product)}
                      className="mt-3 w-full inline-flex justify-center rounded-md bg-gray-900 px-4 py-2 text-xs font-semibold text-white hover:bg-black transition"
                    >
                      Add to Cart
                    </button>
                  </Card>
                );
              })}
            </div>
          </section>
        </>
      )}

      {/* UNDER $25 RAIL */}
      {under25Designs.length > 0 && (
        <>
          <SectionIntro
            id="under-25"
            kicker="Everyday Pieces"
            title="Under $25"
            lead="Low-friction entries into the universe ‚Äî perfect for gifts, first-time buyers, or stacking multiple designs."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-12 -mt-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-5">
              {under25Designs.map((product) => {
                const m = product.metadata || {};
                return (
                  <Card
                    key={product.id}
                    title={product.name}
                    description={product.description}
                    image={product.display_image}
                    category="designs"
                  >
                    {m.book && (
                      <div className="mb-2 flex justify-center">
                        <span className="text-[11px] px-2 py-1 rounded-full bg-green-50 text-green-800 dark:bg-green-900/40 dark:text-green-200">
                          From {m.book}
                        </span>
                      </div>
                    )}
                    <button
                      type="button"
                      onClick={() => handleAddToCart(product)}
                      className="mt-3 w-full inline-flex justify-center rounded-md bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-700 transition"
                    >
                      Add to Cart
                    </button>
                  </Card>
                );
              })}
            </div>
          </section>
        </>
      )}

      {/* SUBSCRIBE */}
      <section id="subscribe" className="container mx-auto px-4 pb-16">
        <SubscriptionForm
          formId="8432506"
          uid="a194031db7"
          title="Stay Updated on New Designs"
          description="Get notified about new drops, limited runs, NFT releases, and exclusive offers from Manyagi Designs."
        />
      </section>

      {showModal && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/50 z-50">
          <div className="bg-white p-6 rounded-xl shadow-lg text-center dark:bg-gray-900">
            <p className="text-base font-medium">Added to cart!</p>
            <Link
              href="/cart"
              className="text-blue-600 hover:underline mt-4 inline-block"
            >
              View Cart
            </Link>
          </div>
        </div>
      )}

      {/* GLOBAL RECOMMENDER */}
      <Recommender />
    </>
  );
}


===== FILE: pages/events.js  (size=7187 bytes) =====
// pages/events.js
import Head from 'next/head';
import { useEffect, useState } from 'react';
import Hero from '@/components/Hero';

function formatRange(startISO, endISO) {
  if (!startISO && !endISO) return 'Date TBA';

  const start = startISO ? new Date(startISO) : null;
  const end = endISO ? new Date(endISO) : null;

  const fmt = (d) =>
    d.toLocaleString(undefined, {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    });

  if (start && end) {
    return `${fmt(start)} ‚Üí ${fmt(end)}`;
  }
  if (start && !end) {
    return fmt(start);
  }
  return fmt(end);
}

export default function EventsPage() {
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(true);

  // could later add filter like "tech", "media", etc.
  const [divisionFilter, setDivisionFilter] = useState('all');

  useEffect(() => {
    (async () => {
      try {
        const qs =
          divisionFilter === 'all'
            ? 'upcoming=1'
            : `division=${encodeURIComponent(
                divisionFilter
              )}&upcoming=1`;

        const res = await fetch(`/api/events?${qs}`);
        const json = await res.json();
        setEvents(Array.isArray(json) ? json : []);
      } catch (err) {
        console.error('events load error:', err);
        setEvents([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [divisionFilter]);

  const heroImages = [
    // totally optional, reuse anything from storage so the hero feels alive
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-3.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-1.webp',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Events ‚Äî Live Drops & Appearances</title>
        <meta
          name="description"
          content="Launches, signings, demos, reveals, and appearances across Manyagi divisions."
        />
      </Head>

      <Hero
        kicker="Events"
        title="Live Drops & Appearances"
        lead="See what's coming next across Realty, Media, Capital, and Tech."
        carouselImages={heroImages}
        height="h-[400px]"
      >
        <div className="flex flex-col sm:flex-row gap-2">
          <button
            onClick={() => setDivisionFilter('all')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'all'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            All
          </button>

          <button
            onClick={() => setDivisionFilter('tech')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'tech'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Tech
          </button>

          <button
            onClick={() => setDivisionFilter('media')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'media'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Media
          </button>

          <button
            onClick={() => setDivisionFilter('capital')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'capital'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Capital
          </button>

          <button
            onClick={() => setDivisionFilter('realty')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'realty'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Realty
          </button>
        </div>
      </Hero>

      <section className="container mx-auto px-4 py-16 max-w-4xl">
        {loading ? (
          <div className="text-center text-lg">
            Loading upcoming events‚Ä¶
          </div>
        ) : events.length === 0 ? (
          <div className="text-center text-lg opacity-70">
            No upcoming events.
          </div>
        ) : (
          <ul className="space-y-6">
            {events.map((ev) => (
              <li
                key={ev.id}
                className="rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-4 shadow-sm"
              >
                {/* Title + division badge */}
                <div className="flex flex-wrap items-start justify-between gap-2 mb-2">
                  <h2 className="text-xl font-bold text-black dark:text-white">
                    {ev.title || 'Untitled Event'}
                  </h2>
                  <span className="text-[11px] px-2 py-1 rounded bg-black text-white dark:bg-gray-700 dark:text-white font-semibold uppercase tracking-wide">
                    {ev.division || 'site'}
                  </span>
                </div>

                {/* Time range */}
                <div className="text-sm font-medium text-blue-600 dark:text-blue-400 mb-2">
                  {formatRange(ev.start_date, ev.end_date)}
                </div>

                {/* Description */}
                {ev.description && (
                  <p className="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-line mb-3">
                    {ev.description}
                  </p>
                )}

                {/* Optional location/map if provided in metadata */}
                {ev.metadata &&
                  typeof ev.metadata.location === 'string' &&
                  ev.metadata.location.trim().length > 0 && (
                    <div className="mt-4">
                      <div className="text-xs font-semibold mb-1">
                        Location
                      </div>
                      <div className="w-full h-48 bg-gray-200 rounded overflow-hidden border border-gray-300 dark:border-gray-700">
                        <iframe
                          className="w-full h-full"
                          src={`https://maps.google.com/maps?q=${encodeURIComponent(
                            ev.metadata.location
                          )}&output=embed`}
                          loading="lazy"
                          referrerPolicy="no-referrer-when-downgrade"
                        />
                      </div>
                      <div className="text-[11px] text-gray-600 dark:text-gray-400 mt-1">
                        {ev.metadata.location}
                      </div>
                    </div>
                  )}
              </li>
            ))}
          </ul>
        )}
      </section>
    </>
  );
}


===== FILE: pages/index.js  (size=34627 bytes) =====
// pages/index.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useMemo, useState } from 'react';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';

import Hero from '../components/Hero';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Card from '../components/Card';
import SectionIntro from '../components/SectionIntro';

// ---------- Shared helpers ----------

function getCfgImg(val, fallback) {
  // site_config values might be a plain string URL or { file_url }
  if (!val) return fallback;
  if (typeof val === 'string') return val;
  if (typeof val === 'object' && val.file_url) return val.file_url;
  return fallback;
}

function productKey(p) {
  return p?.id || p?.slug || p?.name || '';
}

function shuffle(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Picks up to `count` items from `list` while respecting usedIds
function pickFrom(list, count, usedIds) {
  if (!Array.isArray(list) || list.length === 0) return [];
  const picked = [];
  const pool = shuffle(list);

  for (const item of pool) {
    const key = productKey(item);
    if (!key || usedIds.has(key)) continue;
    picked.push(item);
    usedIds.add(key);
    if (picked.length >= count) break;
  }
  return picked;
}

// ---------- Tech helpers (mirrors /pages/tech.js) ----------

const asList = (v) => {
  if (Array.isArray(v)) return v;
  if (v && Array.isArray(v.items)) return v.items;
  return [];
};

const parseList = (v) => {
  if (Array.isArray(v)) return v;
  if (!v) return [];
  if (typeof v === 'string') {
    return v
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean);
  }
  return [];
};

const pickTechImage = (p) =>
  p?.featured_image ||
  p?.metadata?.screenshot ||
  'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-placeholder.webp';

// ---------- Media helpers (mirrors /pages/media.js logic) ----------

const asStr = (v) => (v === null || v === undefined ? '' : String(v));

function safeMeta(meta) {
  if (!meta) return {};
  if (typeof meta === 'object') return meta;
  if (typeof meta === 'string') {
    try {
      const parsed = JSON.parse(meta);
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch {
      return {};
    }
  }
  return {};
}

function isDirectAudio(url) {
  const u = (url || '').toLowerCase().split('?')[0];
  return u.endsWith('.mp3') || u.endsWith('.wav') || u.endsWith('.m4a') || u.endsWith('.ogg');
}

function inferPlatform(url) {
  if (!url) return '';
  const u = url.toLowerCase();
  if (u.includes('youtube.com') || u.includes('youtu.be')) return 'YouTube';
  if (u.includes('spotify.com')) return 'Spotify';
  if (u.includes('soundcloud.com')) return 'SoundCloud';
  if (u.includes('vimeo.com')) return 'Vimeo';
  if (u.includes('tiktok.com')) return 'TikTok';
  if (u.includes('instagram.com')) return 'Instagram';
  if (u.includes('apple.com') || u.includes('music.apple.com')) return 'Apple Music';
  if (u.includes('suno')) return 'Suno';
  return '';
}

function normalizeType(t) {
  const v = (t || '').toLowerCase().trim();
  if (v === 'music' || v === 'track') return 'soundtrack';
  if (v === 'chapter preview' || v === 'chapter') return 'chapter_read';
  if (v === 'opening_theme') return 'soundtrack';
  if (v === 'ending_theme') return 'soundtrack';
  if (v === 'character_theme') return 'soundtrack';
  if (v === 'battle_theme') return 'score';
  return v || 'other';
}

function bestUrl(meta, post) {
  const audio = asStr(meta?.audio_url).trim();
  const media = asStr(meta?.media_url).trim();

  const audio2 = asStr(post?.audio_url).trim();
  const media2 = asStr(post?.media_url).trim();

  return {
    audio_url: audio || audio2 || '',
    media_url: media || media2 || '',
  };
}

function pickCardImage(post, meta) {
  return (
    meta?.thumbnail_url ||
    post.thumbnail_url ||
    post.featured_image ||
    meta?.cover_url ||
    meta?.image_url ||
    '/placeholder.png'
  );
}

function pickIp(meta) {
  return (
    asStr(meta?.book).trim() ||
    asStr(meta?.series).trim() ||
    asStr(meta?.universe).trim() ||
    asStr(meta?.ip).trim() ||
    asStr(meta?.franchise).trim() ||
    ''
  );
}

function normalizeApiList(json) {
  if (Array.isArray(json)) return json;
  if (json && Array.isArray(json.posts)) return json.posts;
  if (json && Array.isArray(json.data)) return json.data;
  if (json && Array.isArray(json.rows)) return json.rows;
  if (json && Array.isArray(json.items)) return json.items;
  return [];
}

function MediaEmbed({ mediaUrl, audioUrl }) {
  const url = (audioUrl || mediaUrl || '').trim();
  if (!url) return null;

  if (isDirectAudio(url)) {
    return (
      <div className="w-full rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/60 p-3">
        <audio controls className="w-full">
          <source src={url} />
        </audio>
      </div>
    );
  }

  const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
  const isSpotify = url.includes('open.spotify.com');
  const isSoundCloud = url.includes('soundcloud.com');
  const isVimeo = url.includes('vimeo.com');

  if (isYouTube) {
    let embed = url;
    if (url.includes('watch?v=')) {
      const id = url.split('watch?v=')[1].split('&')[0];
      embed = `https://www.youtube.com/embed/${id}`;
    } else if (url.includes('youtu.be/')) {
      const id = url.split('youtu.be/')[1].split(/[?&]/)[0];
      embed = `https://www.youtube.com/embed/${id}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe src={embed} title="Media Preview" className="w-full h-full" allowFullScreen />
      </div>
    );
  }

  if (isSpotify) {
    const embed = url.replace('open.spotify.com/', 'open.spotify.com/embed/');
    return (
      <div className="w-full rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe
          src={embed}
          title="Spotify Player"
          className="w-full h-[152px] md:h-[232px]"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        />
      </div>
    );
  }

  if (isSoundCloud) {
    const embed = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false&show_teaser=true`;
    return (
      <div className="w-full rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe src={embed} title="SoundCloud Player" className="w-full h-[166px]" allow="autoplay" />
      </div>
    );
  }

  if (isVimeo) {
    let embed = url;
    const parts = url.split('vimeo.com/');
    if (parts[1]) {
      const id = parts[1].split(/[?&]/)[0];
      embed = `https://player.vimeo.com/video/${id}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe src={embed} title="Vimeo Player" className="w-full h-full" allowFullScreen />
      </div>
    );
  }

  return (
    <a
      href={url}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center justify-center w-full bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-full hover:bg-blue-700 transition"
    >
      Open Link
    </a>
  );
}

export default function Home() {
  const dispatch = useDispatch();

  const [siteConfig, setSiteConfig] = useState({});
  const [products, setProducts] = useState([]);

  const [featuredProducts, setFeaturedProducts] = useState([]);
  const [bookProducts, setBookProducts] = useState([]);
  const [merchProducts, setMerchProducts] = useState([]);

  const [techApps, setTechApps] = useState([]); // from /api/posts?division=tech
  const [blogPosts, setBlogPosts] = useState([]);

  // ‚úÖ NEW: media items for home page "Listen Now"
  const [mediaItems, setMediaItems] = useState([]);

  // --- Fetch site config + products (books/merch/featured) ---
  useEffect(() => {
    (async () => {
      try {
        const cfg = await fetch('/api/site-config')
          .then((r) => r.json())
          .catch(() => ({}));
        setSiteConfig(cfg || {});

        const res = await fetch('/api/products?limit=48');
        const json = await res.json().catch(() => []);
        const items = Array.isArray(json)
          ? json
          : Array.isArray(json.items)
          ? json.items
          : [];

        const normalized = items.map((p) => ({
          ...p,
          image_url:
            p.image_url ||
            p.thumbnail_url ||
            p.image ||
            p.imageUrl ||
            p.display_image ||
            '',
        }));

        setProducts(normalized);

        // Build sections without overlap (books, merch, featured)
        const usedIds = new Set();

        const publishing = normalized.filter(
          (p) => (p.division || '').toLowerCase() === 'publishing'
        );
        const designs = normalized.filter(
          (p) => (p.division || '').toLowerCase() === 'designs'
        );

        const books = pickFrom(publishing, 3, usedIds);
        const merch = pickFrom(designs, 3, usedIds);

        // Featured can be from any division, but must not reuse usedIds
        const featuredPool = normalized;
        const featured = pickFrom(featuredPool, 3, usedIds);

        setBookProducts(books);
        setMerchProducts(merch);
        setFeaturedProducts(
          featured.length ? featured : normalized.slice(0, 3)
        );
      } catch (e) {
        console.error('Home fetch error:', e);
        setProducts([]);
        setFeaturedProducts([]);
      }
    })();
  }, []);

  // --- Fetch Tech apps (same source as /pages/tech.js) ---
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts?division=tech');
        const json = await res.json().catch(() => ({}));

        const list = asList(json);
        const normalized = list.map((p) => {
          const meta = p.metadata || {};
          return {
            id: p.id,
            slug: p.slug,
            name: p.title,
            tagline: meta.tagline || '',
            description: p.content || p.excerpt || '',
            excerpt: p.excerpt || '',
            image: pickTechImage(p),
            domain: meta.app_url || '',
            appCategory: meta.app_category || 'flagship',
            appType: meta.app_type || 'app',
            status: meta.status || 'Live',
            platforms: parseList(meta.platforms),
            labels: parseList(meta.labels),
          };
        });

        setTechApps(normalized);
      } catch (e) {
        console.error('Home tech fetch error:', e);
        setTechApps([]);
      }
    })();
  }, []);

  // ‚úÖ NEW: Fetch Media items (same source style as /pages/media.js)
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts?division=media&limit=12');
        const json = await res.json().catch(() => ({}));
        const raw = normalizeApiList(json);

        const list = (raw || [])
          .map((p) => {
            const m = safeMeta(p.metadata);
            const media_type = normalizeType(m.media_type || '');
            const urls = bestUrl(m, p);
            const audio_url = urls.audio_url;
            const media_url = urls.media_url;

            const duration = asStr(m.duration || '').trim();
            const platform = asStr(m.platform || '').trim() || inferPlatform(media_url || audio_url);
            const ip = pickIp(m);
            const card_img = pickCardImage(p, m);

            return {
              id: p.id,
              slug: p.slug,
              title: p.title,
              excerpt: p.excerpt || '',
              content: p.content || '',
              created_at: p.created_at || m.created_at || null,
              metadata: m,
              media_type,
              audio_url,
              media_url,
              duration,
              platform,
              ip,
              card_img,
              scene: asStr(m.scene || '').trim(),
              mood: asStr(m.mood || '').trim(),
            };
          })
          .filter((it) => !!asStr(it.audio_url).trim() || !!asStr(it.media_url).trim())
          .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

        setMediaItems(list.slice(0, 6)); // show 6 on home
      } catch (e) {
        console.error('Home media fetch error:', e);
        setMediaItems([]);
      }
    })();
  }, []);

  // --- Fetch latest blog posts for the home page ---
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts?limit=6');
        const json = await res.json().catch(() => []);
        const posts = Array.isArray(json)
          ? json
          : Array.isArray(json.items)
          ? json.items
          : [];

        const sorted = posts
          .slice()
          .sort(
            (a, b) =>
              new Date(b.created_at || 0).getTime() -
              new Date(a.created_at || 0).getTime()
          );

        setBlogPosts(sorted.slice(0, 3));
      } catch (e) {
        console.error('Home blog fetch error:', e);
        setBlogPosts([]);
      }
    })();
  }, []);

  const carouselImages = siteConfig.carousel_images || [
    '/images/home-carousel-1.webp',
    '/images/home-carousel-2.webp',
    '/images/home-carousel-3.webp',
  ];

  const heroImage = getCfgImg(siteConfig.hero, '/videos/hero-bg.mp4');

  // Division card images with safe fallbacks
  const publishingImg = getCfgImg(
    siteConfig.publishing_hero,
    '/images/legacy-chapter-1.webp'
  );
  const designsImg = getCfgImg(
    siteConfig.designs_hero,
    '/images/mock-tee-1.webp'
  );
  const capitalImg = getCfgImg(
    siteConfig.capital_hero,
    '/images/chart-hero.webp'
  );
  const techImg = getCfgImg(
    siteConfig.tech_hero,
    '/images/daito-screenshot.webp'
  );
  const mediaImg = getCfgImg(
    siteConfig.media_hero,
    '/images/og-media.webp'
  );
  const realtyImg = getCfgImg(
    siteConfig.realty_hero,
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/realty-hero.webp'
  );

  const BLOG_PLACEHOLDER =
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-blog.webp';

  // Compute Tech showcase: random flagship apps (non-"upcoming")
  const flagshipApps = techApps.filter(
    (app) => (app.appCategory || '').toLowerCase() !== 'upcoming'
  );
  const techShowcase =
    flagshipApps.length > 0 ? shuffle(flagshipApps).slice(0, 3) : [];

  // --- Card render helpers (products) ---

  const renderPublishingCard = (product) => {
    const m = product.metadata || {};
    const buyUrl =
      m.amazon_url ||
      m.kindle_url ||
      m.paperback_url ||
      m.store_url ||
      null;

    const alsoLinks = [
      m.kindle_url ? { label: 'Kindle', url: m.kindle_url } : null,
      m.paperback_url ? { label: 'Paperback', url: m.paperback_url } : null,
    ].filter(Boolean);

    const chips = [
      m.format ? String(m.format).toUpperCase() : null,
      m.year ? `Y${m.year}` : null,
    ].filter(Boolean);

    return (
      <Card
        key={productKey(product)}
        title={product.name}
        description={product.description}
        image={product.image_url}
        category={product.division}
        tags={Array.isArray(product.tags) ? product.tags : []}
      >
        {chips.length > 0 && (
          <div className="flex flex-wrap gap-2 justify-center mb-2">
            {chips.map((c) => (
              <span
                key={c}
                className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
              >
                {c}
              </span>
            ))}
          </div>
        )}

        <div className="flex flex-wrap gap-3 mt-2 justify-center">
          {buyUrl && (
            <a
              href={buyUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-xs font-semibold"
            >
              Get Your Copy
            </a>
          )}
          {m.pdf_url && (
            <a
              href={m.pdf_url}
              target="_blank"
              rel="noopener noreferrer"
              className="btn bg-gray-900 text-white py-2 px-4 rounded hover:bg-black transition text-xs font-semibold"
            >
              Read Chapter 1
            </a>
          )}
        </div>

        {alsoLinks.length > 0 && (
          <p className="mt-3 text-[11px] text-gray-600">
            Also available:{' '}
            {alsoLinks.map((l, i) => (
              <a
                key={l.label}
                href={l.url}
                target="_blank"
                rel="noopener noreferrer"
                className="underline hover:text-blue-700"
              >
                {l.label}
                {i < alsoLinks.length - 1 ? ', ' : ''}
              </a>
            ))}
          </p>
        )}
      </Card>
    );
  };

  const renderProductCard = (product) => {
    if (!product) return null;

    if ((product.division || '').toLowerCase() === 'publishing') {
      return renderPublishingCard(product);
    }

    return (
      <Card
        key={productKey(product)}
        title={product.name}
        description={product.description}
        image={product.image_url}
        category={product.division}
        buyButton={product}
        onBuy={() =>
          dispatch(
            addToCart({
              ...product,
              productType:
                (product.division || '').toLowerCase() === 'designs'
                  ? 'merch'
                  : (product.division || '').toLowerCase() === 'capital'
                  ? 'download'
                  : 'product',
            })
          )
        }
      />
    );
  };

  // ‚úÖ NEW: Media card with inline player
  const renderMediaCard = (item) => {
    const chips = [
      item.media_type ? item.media_type : null,
      item.platform ? item.platform : null,
      item.duration ? item.duration : null,
      item.ip ? item.ip : null,
    ].filter(Boolean);

    const desc = item.scene || item.excerpt || 'New media drop from the Manyagi Universe.';

    return (
      <Card
        key={item.slug || item.id}
        title={item.title}
        description={desc}
        image={item.card_img}
        category="media"
      >
        {chips.length > 0 && (
          <div className="flex flex-wrap gap-2 justify-center mb-3">
            {chips.slice(0, 4).map((c) => (
              <span
                key={c}
                className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
              >
                {c}
              </span>
            ))}
          </div>
        )}

        <div className="mt-2">
          <MediaEmbed mediaUrl={item.media_url} audioUrl={item.audio_url} />
        </div>

        <div className="pt-3 flex justify-center gap-3 flex-wrap">
          <Link
            href={`/media/${item.slug}`}
            className="text-sm font-semibold text-blue-600 hover:underline"
          >
            Listen / View ‚Üí{/* keeps it general for video/audio */}
          </Link>
          <Link
            href="/media"
            className="text-sm font-semibold text-gray-700 dark:text-gray-200 hover:underline"
          >
            Full Media Library ‚Üí
          </Link>
        </div>
      </Card>
    );
  };

  // Micro-nav rails under hero
  const rails = [
    { label: 'Read', href: '#books' },
    { label: 'Wear', href: '#merch' },
    { label: 'Trade', href: '#featured' },
    { label: 'Build', href: '#tech' },
    { label: 'Listen', href: '#listen' }, // ‚úÖ NEW
    { label: 'Watch', href: '#blog' },
    { label: 'Live', href: '#divisions' },
  ];

  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Creativity Meets Innovation</title>
        <meta
          name="description"
          content="Manyagi is a story-first studio and product lab building books, designs, tools, apps, and experiences that live in one connected universe."
        />
        {getCfgImg(siteConfig.favicon, null) && (
          <link rel="icon" href={getCfgImg(siteConfig.favicon)} />
        )}
      </Head>

      {/* HERO */}
      <Hero
        kicker="The Manyagi Universe"
        title="One Brand. Many Worlds."
        lead="Stories, products, and platforms built to talk to each other ‚Äî from novels and merch to trading tools and apps. Creativity meets innovation under one roof."
        carouselImages={carouselImages}
        videoSrc={heroImage}
        height="h-[600px]"
      >
        <div className="flex flex-wrap gap-3">
          <Link
            href="#featured"
            className="btn bg-blue-600 text-white py-2 px-4 rounded hover:scale-105 transition text-sm font-semibold"
          >
            Enter the Universe
          </Link>
          <Link
            href="#divisions"
            className="btn bg-white/90 text-gray-900 border border-gray-300 py-2 px-4 rounded hover:bg-gray-50 transition text-sm font-semibold"
          >
            Explore the Divisions
          </Link>
        </div>
      </Hero>

      {/* MICRO NAV RAILS */}
      <section className="border-b border-black/5 dark:border-white/10 bg-white/70 dark:bg-gray-950/70 backdrop-blur">
        <div className="container mx-auto px-4 py-3">
          <div className="flex gap-3 overflow-x-auto text-[11px] font-semibold tracking-[0.25em] uppercase">
            {rails.map((item) => (
              <Link
                key={item.label}
                href={item.href}
                className="inline-flex items-center rounded-full px-3 py-1.5 bg-white dark:bg-gray-900 shadow-sm border border-gray-200/70 dark:border-gray-700/70 hover:shadow-md hover:-translate-y-[1px] transition text-gray-800 dark:text-gray-100 whitespace-nowrap"
              >
                {item.label}
              </Link>
            ))}
          </div>
        </div>
      </section>

      {/* DIVISIONS OVERVIEW */}
      <SectionIntro
        id="divisions"
        kicker="A Manyagi Company"
        title="Six Divisions, One Connected Ecosystem"
        lead="Publishing, Designs, Capital, Tech, Media, and Realty ‚Äî each with its own focus, all serving the same long-term universe."
        tone="neutral"
        align="center"
      />

      <section className="container mx-auto px-4 pb-16 grid grid-cols-1 md:grid-cols-3 gap-5">
        <Card
          title="Publishing"
          description="Novels, poetry, and written worlds designed to travel beyond the page."
          image={publishingImg}
          link="/publishing"
          category="publishing"
        />
        <Card
          title="Designs"
          description="Apparel, posters, and collectibles that let you wear the worlds you love."
          image={designsImg}
          link="/designs"
          category="designs"
        />
        <Card
          title="Capital"
          description="Signals, strategies, and tools focused on practical, steady growth."
          image={capitalImg}
          link="/capital"
          category="capital"
        />
        <Card
          title="Tech"
          description="Apps and platforms for commerce, community, and creators."
          image={techImg}
          link="/tech"
          category="tech"
        />
        <Card
          title="Media"
          description="Audio, video, and social storytelling built for the modern feed."
          image={mediaImg}
          link="/media"
          category="media"
        />
        <Card
          title="Realty"
          description="Future-facing real estate concepts to anchor the digital worlds."
          image={realtyImg}
          link="/realty"
          category="realty"
        />
      </section>

      {/* FEATURED PRODUCTS & DROPS */}
      <SectionIntro
        id="featured"
        kicker="Spotlight"
        title="Featured Products & Drops"
        lead="A rotating showcase from across the universe ‚Äî books, designs, tools, and apps that capture where Manyagi is right now."
        tone="card"
        align="center"
      />

      <section className="container mx-auto px-4 pb-16">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {(featuredProducts.length ? featuredProducts : products.slice(0, 3)).map(
            (product) => renderProductCard(product)
          )}
        </div>
      </section>

      {/* BOOKS SECTION */}
      <SectionIntro
        id="books"
        kicker="Manyagi Publishing"
        title="Books From the Universe"
        lead="Story-first IP ‚Äî novels and poetry that seed the rest of the ecosystem, from merch and media to future adaptations."
        tone="neutral"
        align="center"
      >
        <Link
          href="/publishing"
          className="inline-flex items-center text-xs font-semibold text-blue-700 hover:underline"
        >
          Visit Publishing ‚Üí
        </Link>
      </SectionIntro>

      <section className="container mx-auto px-4 pb-16">
        {bookProducts.length === 0 ? (
          <p className="text-center text-sm opacity-70">
            New titles are being prepared behind the scenes.
          </p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {bookProducts.map((product) => renderPublishingCard(product))}
          </div>
        )}
      </section>

      {/* MERCH & NFTS SECTION */}
      <SectionIntro
        id="merch"
        kicker="Designs & Collectibles"
        title="Merch, Art & Future NFTs"
        lead="Wear the worlds, frame the scenes, and collect moments from the stories ‚Äî built through Designs and future digital drops."
        tone="neutral"
        align="center"
      >
        <Link
          href="/designs"
          className="inline-flex items-center text-xs font-semibold text-blue-700 hover:underline"
        >
          Explore Designs ‚Üí
        </Link>
      </SectionIntro>

      <section className="container mx-auto px-4 pb-16">
        {merchProducts.length === 0 ? (
          <p className="text-center text-sm opacity-70">
            New drops are being staged. Check back soon.
          </p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {merchProducts.map((product) => renderProductCard(product))}
          </div>
        )}
      </section>

      {/* TECH SECTION ‚Äî pulls from /api/posts?division=tech */}
      <SectionIntro
        id="tech"
        kicker="Manyagi Tech"
        title="Platforms, Apps & Tools"
        lead="Digital infrastructure for the universe ‚Äî from commerce and community to productivity and trading."
        tone="neutral"
        align="center"
      >
        <Link
          href="/tech"
          className="inline-flex items-center text-xs font-semibold text-blue-700 hover:underline"
        >
          Visit Tech ‚Üí
        </Link>
      </SectionIntro>

      <section className="container mx-auto px-4 pb-16">
        {techShowcase.length === 0 ? (
          <p className="text-center text-sm opacity-70">
            New builds are in development ‚Äî launches will appear here first.
          </p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {techShowcase.map((app) => (
              <Card
                key={app.id}
                title={app.name}
                description={app.description || app.excerpt}
                image={app.image}
                category="tech"
              >
                {app.tagline && (
                  <div className="mb-2">
                    <p className="text-xs font-semibold text-gray-700 dark:text-gray-200">
                      {app.tagline}
                    </p>
                  </div>
                )}

                {app.labels.length > 0 && (
                  <div className="flex flex-wrap gap-1 mb-3">
                    {app.labels.map((label) => (
                      <span
                        key={label}
                        className="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-800 px-2.5 py-0.5 text-[11px] font-medium text-gray-700 dark:text-gray-200"
                      >
                        {label}
                      </span>
                    ))}
                  </div>
                )}

                {app.platforms.length > 0 && (
                  <div className="flex flex-wrap items-center gap-2 mb-3">
                    {app.platforms.map((plat) => (
                      <span
                        key={plat}
                        className="inline-flex items-center rounded-full border border-gray-200 dark:border-gray-700 px-2.5 py-0.5 text-[11px] text-gray-700 dark:text-gray-200"
                      >
                        {plat}
                      </span>
                    ))}
                  </div>
                )}

                {app.domain ? (
                  <a
                    href={app.domain}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-700 transition"
                  >
                    Open Site / Download
                  </a>
                ) : (
                  <span className="text-xs text-gray-500 dark:text-gray-400">
                    Coming soon
                  </span>
                )}
              </Card>
            ))}
          </div>
        )}
      </section>

      {/* ‚úÖ NEW: LISTEN NOW (Media player section on Home) */}
      <SectionIntro
        id="listen"
        kicker="Manyagi Media"
        title="Listen Now"
        lead="Fresh soundtracks and audio drops ‚Äî playable right here. Built for fans and Hollywood scanning the vibe in seconds."
        tone="card"
        align="center"
      >
        <Link
          href="/media"
          className="inline-flex items-center text-xs font-semibold text-blue-700 hover:underline"
        >
          Open the Media Library ‚Üí
        </Link>
      </SectionIntro>

      <section className="container mx-auto px-4 pb-16">
        {mediaItems.length === 0 ? (
          <p className="text-center text-sm opacity-70">
            No media drops yet. Upload a track in Admin ‚Üí Media (it will appear here automatically).
          </p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {mediaItems.map((item) => renderMediaCard(item))}
          </div>
        )}
      </section>

      {/* BLOG SECTION */}
      <SectionIntro
        id="blog"
        kicker="Manyagi Blog"
        title="Notes From the Build"
        lead="Strategy, behind-the-scenes logs, and creative process entries as the universe grows in public."
        tone="card"
        align="center"
      >
        <Link
          href="/blog"
          className="inline-flex items-center text-xs font-semibold text-blue-700 hover:underline"
        >
          Read all posts ‚Üí
        </Link>
      </SectionIntro>

      <section className="container mx-auto px-4 pb-16">
        {blogPosts.length === 0 ? (
          <p className="text-center text-sm opacity-70">
            First entries are coming soon.
          </p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {blogPosts.map((post) => (
              <Card
                key={post.slug || post.id}
                title={post.title}
                description={
                  post.excerpt ||
                  'A new dispatch from the Manyagi universe ‚Äî strategy, systems, and story-first building.'
                }
                image={post.featured_image || BLOG_PLACEHOLDER}
                category={post.division || 'Manyagi Blog'}
              >
                <div className="pt-2 flex justify-center">
                  <Link
                    href={`/blog/${post.slug}`}
                    className="text-sm font-semibold text-blue-600 hover:underline"
                  >
                    Read story ‚Üí
                  </Link>
                </div>
              </Card>
            ))}
          </div>
        )}
      </section>

      {/* EMAIL CAPTURE / NEWSLETTER */}
      <SectionIntro
        id="subscribe"
        kicker="Stay Ahead"
        title="Get Chapter 1, New Drops & Early Access"
        lead="Short, focused updates from across the universe ‚Äî books, merch, tools, apps, and more. No spam, just signal."
        tone="neutral"
        align="center"
      />

      <section className="container mx-auto px-4 pt-4 pb-16">
        <SubscriptionForm
          formId="8427635"
          uid="db12290300"
          title="Join the Manyagi List"
          description="Be first in line for new releases, beta invites, and behind-the-scenes notes."
        />
      </section>

      {/* CROSS-DIVISION RECOMMENDER */}
      <Recommender />
    </>
  );
}


===== FILE: pages/links.js  (size=4585 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import { FaInstagram, FaTiktok, FaYoutube, FaTwitter, FaLinkedin, FaPinterest } from 'react-icons/fa';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';

export default function Links() {
  const socialLinks = [
    { platform: 'Instagram', handle: 'https://instagram.com/manyagiofficial', icon: <FaInstagram size={24} /> },
    { platform: 'Twitter', handle: 'https://x.com/ManyagiOfficial', icon: <FaTwitter size={24} /> },
    { platform: 'YouTube', handle: 'https://youtube.com/@ManyagiOfficial', icon: <FaYoutube size={24} /> },
    { platform: 'LinkedIn', handle: 'https://linkedin.com/company/manyagiofficial', icon: <FaLinkedin size={24} /> },
    { platform: 'Pinterest', handle: 'https://pinterest.com/ManyagiOfficial', icon: <FaPinterest size={24} /> },
    { platform: 'TikTok', handle: 'https://tiktok.com/@manyagiofficial', icon: <FaTiktok size={24} /> },
  ];

  const divisionLinks = [
    { name: 'Publishing', url: '/publishing', description: 'Novels, poetry, and IP ready for adaptation.' },
    { name: 'Designs', url: '/designs', description: 'Story-driven apparel, art prints, and merch.' },
    { name: 'Capital', url: '/capital', description: 'Long-term investing, frameworks, and capital labs.' },
    { name: 'Tech', url: '/tech', description: 'Web, apps, automation, and digital infrastructure.' },
    { name: 'Media', url: '/media', description: 'Content, documentaries, and distribution channels.' },
    { name: 'Realty', url: '/realty', description: 'Real estate and physical experiences (future-facing).' },
  ];

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-home.webp',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Links ‚Äî Connect with the Manyagi Ecosystem</title>
        <meta
          name="description"
          content="All official Manyagi links in one place ‚Äî social channels, divisions, and ways to plug into the Manyagi ecosystem."
        />
      </Head>
      <Hero
        kicker="Links"
        title="Connect with the Manyagi Ecosystem"
        lead="Follow the journey, explore each division, and plug into the worlds we‚Äôre building."
        carouselImages={carouselImages}
        height="h-[600px]"
      />

      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6 text-center">Social Media</h2>
        <p className="text-center text-sm text-gray-600 max-w-xl mx-auto mb-6">
          These are the official Manyagi channels for announcements, behind-the-scenes building, and new releases.
        </p>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto">
          {socialLinks.map((link) => (
            <a
              key={link.platform}
              href={link.handle}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-2 p-4 border rounded-lg hover:bg-gray-100 transition"
            >
              {link.icon}
              <span>{link.platform}</span>
            </a>
          ))}
        </div>
      </section>

      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6 text-center">Our Divisions</h2>
        <p className="text-center text-sm text-gray-600 max-w-xl mx-auto mb-6">
          Explore each Manyagi division as its own doorway into the larger empire ‚Äî different focus, same DNA.
        </p>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
          {divisionLinks.map((link) => (
            <Link
              key={link.name}
              href={link.url}
              className="p-4 border rounded-lg hover:bg-gray-100 transition"
            >
              <h3 className="text-xl font-bold">{link.name}</h3>
              <p className="text-gray-600 text-sm mt-1">{link.description}</p>
            </Link>
          ))}
        </div>
      </section>

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427853"
          uid="637df68a06"
          title="Stay Connected"
          description="Join our list for new drops, launches, and ecosystem-wide updates from Manyagi."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/login.js  (size=3735 bytes) =====
import Head from 'next/head';
import { useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';
import Hero from '../components/Hero';  // Add Hero for background

export default function Login() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isSignup, setIsSignup] = useState(false);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleAuth = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      let data, authError;
      if (isSignup) {
        ({ data, error: authError } = await supabase.auth.signUp({ email, password }));
        if (authError) throw authError;
        await supabase.from('users').insert({
          id: data.user.id,
          email,
          role: 'user',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        });
      } else {
        ({ data, error: authError } = await supabase.auth.signInWithPassword({ email, password }));
        if (authError) throw authError;
      }
      router.push('/dashboard');
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleGoogleLogin = async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
      if (error) throw error;
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <>
      <Head>
        <title>{isSignup ? 'Sign Up' : 'Login'} - Manyagi</title>
      </Head>
      <Hero
        kicker={isSignup ? "Join Us" : "Welcome Back"}
        title={isSignup ? "Sign Up" : "Login"}
        lead={isSignup ? "Create your Manyagi account." : "Access your dashboard."}
        carouselImages={[]}  // Optional, or add images
        height="h-screen"  // Full screen for login
      >
        <div className="card max-w-md mx-auto bg-white text-black glass p-8 rounded-lg shadow-xl">
          {error && <p className="text-red-500 mb-4 text-center">{error}</p>}
          <form onSubmit={handleAuth} className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <button
              type="submit"
              disabled={loading}
              className="w-full p-3 bg-black text-white rounded disabled:opacity-50 hover:bg-gray-800 transition"
            >
              {loading ? 'Processing...' : isSignup ? 'Sign Up' : 'Login'}
            </button>
          </form>
          <button
            onClick={handleGoogleLogin}
            className="mt-4 w-full p-3 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
          >
            {isSignup ? 'Sign Up' : 'Login'} with Google
          </button>
          <button
            onClick={() => setIsSignup(!isSignup)}
            className="mt-4 text-blue-500 underline w-full text-center"
          >
            {isSignup ? 'Switch to Login' : 'Switch to Sign Up'}
          </button>
        </div>
      </Hero>
    </>
  );
}


===== FILE: pages/media.js  (size=25711 bytes) =====
// pages/media.js
import Head from "next/head";
import Link from "next/link";
import { useEffect, useMemo, useState } from "react";
import Hero from "@/components/Hero";
import Recommender from "@/components/Recommender";
import SectionIntro from "@/components/SectionIntro";
import SubscriptionForm from "@/components/SubscriptionForm";

// -------------------------------
// helpers
// -------------------------------
const asStr = (v) => (v === null || v === undefined ? "" : String(v));

function safeMeta(meta) {
  if (!meta) return {};
  if (typeof meta === "object") return meta;
  if (typeof meta === "string") {
    try {
      const parsed = JSON.parse(meta);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch {
      return {};
    }
  }
  return {};
}

function groupBy(arr, key) {
  return (arr || []).reduce((acc, item) => {
    const k = asStr(item?.[key] || "other").toLowerCase();
    acc[k] = acc[k] || [];
    acc[k].push(item);
    return acc;
  }, {});
}

function isDirectAudio(url) {
  const u = (url || "").toLowerCase().split("?")[0];
  return u.endsWith(".mp3") || u.endsWith(".wav") || u.endsWith(".m4a") || u.endsWith(".ogg");
}

function inferPlatform(url) {
  if (!url) return "";
  const u = url.toLowerCase();
  if (u.includes("youtube.com") || u.includes("youtu.be")) return "YouTube";
  if (u.includes("spotify.com")) return "Spotify";
  if (u.includes("soundcloud.com")) return "SoundCloud";
  if (u.includes("vimeo.com")) return "Vimeo";
  if (u.includes("tiktok.com")) return "TikTok";
  if (u.includes("instagram.com")) return "Instagram";
  if (u.includes("apple.com") || u.includes("music.apple.com")) return "Apple Music";
  if (u.includes("suno")) return "Suno";
  return "";
}

function normalizeType(t) {
  const v = (t || "").toLowerCase().trim();

  // legacy mappings
  if (v === "music" || v === "track") return "soundtrack";
  if (v === "chapter preview" || v === "chapter") return "chapter_read";

  // your MediaTab types
  if (v === "opening_theme") return "soundtrack";
  if (v === "ending_theme") return "soundtrack";
  if (v === "character_theme") return "soundtrack";
  if (v === "battle_theme") return "score";

  return v || "other";
}

function prettyType(t) {
  const v = normalizeType(t);
  const map = {
    soundtrack: "Soundtracks",
    score: "Score",
    trailer: "Trailers",
    audiobook: "Audiobooks",
    chapter_read: "Chapter Reads",
    scene: "Scenes",
    playlist: "Playlists",
    musicvideo: "Music Videos",
    reel: "Reels",
    podcast: "Podcasts",
    interview: "Interviews",
    event: "Events",
    other: "Media",
  };
  return map[v] || "Media";
}

function primaryCta(item) {
  const t = normalizeType(item.media_type);
  if (t === "soundtrack" || t === "score" || t === "chapter_read" || t === "audiobook") return "Play";
  if (t === "trailer" || t === "musicvideo" || t === "reel") return "Watch";
  if (t === "playlist") return "Open Playlist";
  return "View";
}

function clamp(s, n = 140) {
  const str = asStr(s);
  if (str.length <= n) return str;
  return str.slice(0, n - 1) + "‚Ä¶";
}

function pickCardImage(post, meta) {
  return (
    meta?.thumbnail_url ||
    post.thumbnail_url ||
    post.featured_image ||
    meta?.cover_url ||
    meta?.image_url ||
    "/placeholder.png"
  );
}

function bestUrl(meta, post) {
  const audio = asStr(meta?.audio_url).trim();
  const media = asStr(meta?.media_url).trim();

  const audio2 = asStr(post?.audio_url).trim();
  const media2 = asStr(post?.media_url).trim();

  return {
    audio_url: audio || audio2 || "",
    media_url: media || media2 || "",
  };
}

function pickIp(meta) {
  return (
    asStr(meta?.book).trim() ||
    asStr(meta?.series).trim() ||
    asStr(meta?.universe).trim() ||
    asStr(meta?.ip).trim() ||
    asStr(meta?.franchise).trim() ||
    ""
  );
}

function normalizeApiList(json) {
  if (Array.isArray(json)) return json;
  if (json && Array.isArray(json.posts)) return json.posts;
  if (json && Array.isArray(json.data)) return json.data;
  if (json && Array.isArray(json.rows)) return json.rows;
  if (json && Array.isArray(json.items)) return json.items;
  return [];
}

// -------------------------------
// embeds
// -------------------------------
function MediaEmbed({ mediaUrl, audioUrl }) {
  const url = (audioUrl || mediaUrl || "").trim();
  if (!url) return null;

  if (isDirectAudio(url)) {
    return (
      <div className="w-full rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/60 p-3">
        <audio controls className="w-full">
          <source src={url} />
        </audio>
      </div>
    );
  }

  const isYouTube = url.includes("youtube.com") || url.includes("youtu.be");
  const isSpotify = url.includes("open.spotify.com");
  const isSoundCloud = url.includes("soundcloud.com");
  const isVimeo = url.includes("vimeo.com");

  if (isYouTube) {
    let embed = url;
    if (url.includes("watch?v=")) {
      const id = url.split("watch?v=")[1].split("&")[0];
      embed = `https://www.youtube.com/embed/${id}`;
    } else if (url.includes("youtu.be/")) {
      const id = url.split("youtu.be/")[1].split(/[?&]/)[0];
      embed = `https://www.youtube.com/embed/${id}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe src={embed} title="Media Preview" className="w-full h-full" allowFullScreen />
      </div>
    );
  }

  if (isSpotify) {
    const embed = url.replace("open.spotify.com/", "open.spotify.com/embed/");
    return (
      <div className="w-full rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe
          src={embed}
          title="Spotify Player"
          className="w-full h-[152px] md:h-[232px]"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        />
      </div>
    );
  }

  if (isSoundCloud) {
    const embed = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false&show_teaser=true`;
    return (
      <div className="w-full rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe src={embed} title="SoundCloud Player" className="w-full h-[166px]" allow="autoplay" />
      </div>
    );
  }

  if (isVimeo) {
    let embed = url;
    const parts = url.split("vimeo.com/");
    if (parts[1]) {
      const id = parts[1].split(/[?&]/)[0];
      embed = `https://player.vimeo.com/video/${id}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe src={embed} title="Vimeo Player" className="w-full h-full" allowFullScreen />
      </div>
    );
  }

  return (
    <a
      href={url}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center justify-center w-full bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-full hover:bg-blue-700 transition"
    >
      Open Link
    </a>
  );
}

// -------------------------------
// rail component
// -------------------------------
function Rail({ id, title, lead, items }) {
  if (!items?.length) return null;

  return (
    <section id={id} className="container mx-auto px-4 py-10">
      <SectionIntro kicker="MEDIA" title={title} lead={lead} tone="neutral" align="center" />
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 -mt-6">
        {items.slice(0, 9).map((item) => (
          <div
            key={item.id}
            className="rounded-3xl border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm bg-white/70 dark:bg-gray-900/50"
          >
            <div className="relative h-44">
              <img src={item.card_img} alt="" className="absolute inset-0 w-full h-full object-cover" />
              <div className="absolute inset-0 bg-gradient-to-tr from-black/55 to-transparent" />
              <div className="absolute bottom-3 left-4 right-4">
                <div className="text-[11px] tracking-[0.28em] uppercase text-white/80">{prettyType(item.media_type)}</div>
                <div className="text-lg font-bold text-white leading-snug line-clamp-2">{item.title}</div>
              </div>
            </div>

            <div className="p-5">
              <p className="text-sm opacity-80 line-clamp-3">
                {item.scene ? (
                  <>
                    <span className="font-semibold">Scene:</span> {clamp(item.scene, 90)}
                    <br />
                    <span className="opacity-80">{item.excerpt ? clamp(item.excerpt, 90) : ""}</span>
                  </>
                ) : (
                  clamp(item.excerpt || "Explore this media item.", 140)
                )}
              </p>

              <div className="mt-4 flex gap-2 flex-wrap">
                {item.platform && (
                  <span className="px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs dark:bg-gray-800 dark:text-gray-200">
                    {item.platform}
                  </span>
                )}
                {item.duration && (
                  <span className="px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs dark:bg-gray-800 dark:text-gray-200">
                    {item.duration}
                  </span>
                )}
                {item.ip && (
                  <span className="px-2 py-1 rounded-full bg-amber-100 text-amber-700 text-xs dark:bg-amber-900/40 dark:text-amber-200">
                    {item.ip}
                  </span>
                )}
                {item.mood && (
                  <span className="px-2 py-1 rounded-full bg-purple-100 text-purple-700 text-xs dark:bg-purple-900/40 dark:text-purple-200">
                    {item.mood}
                  </span>
                )}
              </div>

              <div className="mt-4">
                <MediaEmbed mediaUrl={item.media_url} audioUrl={item.audio_url} />
              </div>

              <div className="mt-4 flex gap-2 flex-wrap">
                <Link
                  href={`/media/${item.slug}`}
                  className="px-3 py-2 rounded-full text-xs font-semibold border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition"
                >
                  {primaryCta(item)} Details ‚Üí
                </Link>

                {item.download_url && (
                  <a
                    href={item.download_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-3 py-2 rounded-full text-xs font-semibold bg-blue-600 text-white hover:bg-blue-700 transition"
                  >
                    Download
                  </a>
                )}

                {item.license_url && (
                  <a
                    href={item.license_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-3 py-2 rounded-full text-xs font-semibold bg-emerald-600 text-white hover:bg-emerald-700 transition"
                  >
                    License
                  </a>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      {items.length > 9 && (
        <div className="text-center mt-8">
          <a
            href="#library"
            className="inline-flex items-center justify-center px-5 py-2 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-semibold hover:bg-gray-50 dark:hover:bg-gray-800 transition"
          >
            Browse full library ‚Üì
          </a>
        </div>
      )}
    </section>
  );
}

// -------------------------------
// page
// -------------------------------
export default function MediaPage() {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeIP, setActiveIP] = useState("ALL");

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch("/api/posts?division=media");
        const json = await res.json();
        const raw = normalizeApiList(json);

        const list = (raw || [])
          .map((p) => {
            const m = safeMeta(p.metadata);

            const media_type = normalizeType(m.media_type || "");
            const urls = bestUrl(m, p);
            const audio_url = urls.audio_url;
            const media_url = urls.media_url;

            const duration = asStr(m.duration || "").trim();
            const platform = asStr(m.platform || "").trim() || inferPlatform(media_url || audio_url);

            const ip = pickIp(m);
            const card_img = pickCardImage(p, m);

            return {
              ...p,
              metadata: m,
              card_img,
              media_type,
              media_url,
              audio_url,
              duration,
              platform,
              ip,
              scene: asStr(m.scene || "").trim(),
              mood: asStr(m.mood || "").trim(),
              download_url: asStr(m.download_url || "").trim(),
              license_url: asStr(m.license_url || "").trim(),
              created_at: p.created_at || m.created_at || null,
            };
          })
          .filter((it) => !!asStr(it.audio_url).trim() || !!asStr(it.media_url).trim());

        list.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        setItems(list);
      } catch (err) {
        console.error("media fetch error:", err);
        setItems([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const carouselImages = [
    "https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-1.webp",
    "https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-2.webp",
    "https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-3.webp",
    "https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-4.webp",
    "https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-5.webp",
  ];

  const ipOptions = useMemo(() => {
    const set = new Set();
    items.forEach((it) => {
      if (it.ip) set.add(String(it.ip));
    });
    return ["ALL", ...Array.from(set)];
  }, [items]);

  const filtered = useMemo(() => {
    if (activeIP === "ALL") return items;
    return items.filter((it) => it.ip === activeIP);
  }, [items, activeIP]);

  const dropNow = useMemo(() => filtered.slice(0, 9), [filtered]);

  const byType = useMemo(() => groupBy(filtered, "media_type"), [filtered]);
  const soundtracks = byType["soundtrack"] || [];
  const score = byType["score"] || [];
  const trailers = byType["trailer"] || [];
  const audiobooks = byType["audiobook"] || [];
  const chapterReads = byType["chapter_read"] || [];
  const scenes = byType["scene"] || [];
  const playlists = byType["playlist"] || [];
  const musicVideos = byType["musicvideo"] || [];

  if (loading) {
    return <div className="container mx-auto px-4 py-16 text-center">Loading media...</div>;
  }

  return (
    <>
      <Head>
        <title>Manyagi Media ‚Äî Soundtracks & Trailers</title>
        <meta
          name="description"
          content="Soundtracks, score, trailers, audiobooks, and scene reads from the Manyagi Universe."
        />
      </Head>

      {/* ‚úÖ FIX: ensure hero does NOT overlap next section by removing negative margin usage below
          and adding a real spacer after Hero. */}
      <div className="relative">
        <Hero
          kicker="Manyagi Media"
          title="The Universe, In Sound & Motion"
          lead="Soundtracks, score, trailers, audiobooks, chapter reads, and scene moments ‚Äî organized by IP so every world feels alive."
          carouselImages={carouselImages}
          height="h-[600px]"
        >
          <div className="flex flex-wrap gap-3 justify-center">
            <Link href="#drop-now" className="btn bg-blue-600 text-white py-3 px-5 rounded hover:scale-105 transition">
              Drop Now
            </Link>
            <Link
              href="#library"
              className="btn bg-white/90 text-gray-900 border border-gray-200 py-3 px-5 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
            >
              Full Library
            </Link>
          </div>
        </Hero>

        {/* spacer so the next block never tucks under the hero (even if Hero uses absolute layers) */}
        <div className="h-6 md:h-10" />
      </div>

      {/* ‚úÖ FIX: removed -mt-8 (this is what was pulling the IP filter under/into the hero)
          also make sure it sits above anything with z-10 */}
      <section className="container mx-auto px-4 mt-2 md:mt-4 mb-10 relative z-10">
        <div className="rounded-3xl bg-white/80 dark:bg-gray-900/80 border border-amber-100/80 dark:border-gray-800 shadow-sm px-4 md:px-6 py-5 md:py-6">
          <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between">
            <div>
              <div className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80">
                IP Filter
              </div>
              <div className="text-sm opacity-80">Pick a universe to browse music + media together.</div>
            </div>

            <div className="flex gap-2 flex-wrap">
              {ipOptions.slice(0, 10).map((ip) => {
                const isActive = activeIP === ip;
                return (
                  <button
                    key={ip}
                    type="button"
                    onClick={() => setActiveIP(ip)}
                    className={[
                      "px-4 py-2 rounded-full text-sm border transition",
                      isActive
                        ? "bg-blue-600 text-white border-blue-600 shadow-sm"
                        : "bg-white/90 text-gray-800 border-gray-200 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700 dark:hover:bg-gray-800",
                    ].join(" ")}
                  >
                    {ip === "ALL" ? "All IPs" : ip}
                  </button>
                );
              })}
              {ipOptions.length > 10 && (
                <span className="text-xs opacity-70 self-center">(+{ipOptions.length - 10} more)</span>
              )}
            </div>
          </div>
        </div>
      </section>

      <SectionIntro
        kicker="Manyagi Media"
        title={activeIP === "ALL" ? "Drops Across the Universe" : `${activeIP} ‚Äî Media Hub`}
        lead="Start with the newest drops, then dive into soundtracks, score, trailers, and reads."
        tone="warm"
      />

      <Rail id="drop-now" title="Drop Now" lead="Newest uploads first ‚Äî perfect for fast Suno drops and instant site updates." items={dropNow} />

      <Rail id="soundtracks" title="Soundtracks" lead="Main themes, scene tracks, and character motifs." items={soundtracks} />
      <Rail id="score" title="Score" lead="Cinematic underscore and mood beds for key moments." items={score} />

      <Rail id="trailers" title="Trailers" lead="Visual previews powered by the music ‚Äî designed for share + pitch." items={trailers} />

      <Rail id="audiobooks" title="Audiobooks" lead="Long-form audio versions for binge listening." items={audiobooks} />
      <Rail id="chapter-reads" title="Chapter Preview Reads" lead="Short reads to tease the book before purchase." items={chapterReads} />

      <Rail id="scenes" title="Scenes" lead="Moment-based clips: a fight, a reveal, a betrayal ‚Äî each with its own sound." items={scenes} />
      <Rail id="playlists" title="Playlists" lead="Curated listening sessions per IP, character, or arc." items={playlists} />
      <Rail id="musicvideos" title="Music Videos" lead="Full cinematic edits where the song is the story." items={musicVideos} />

      {/* FULL LIBRARY GRID */}
      <section id="library" className="container mx-auto px-4 py-10">
        <div className="max-w-3xl mx-auto mb-8">
          <div className="flex flex-col items-center gap-2 px-4 py-3 rounded-2xl bg-white/80 border border-amber-200/70 shadow-sm text-sm text-gray-700 text-center dark:bg-gray-900/70 dark:border-amber-800/60 dark:text-gray-100">
            <span className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80">
              Full Library
            </span>
            <span>
              Showing <span className="font-semibold">{filtered.length}</span> item(s)
              {activeIP !== "ALL" ? (
                <>
                  {" "}
                  for <span className="italic">‚Äú{activeIP}‚Äù</span>
                </>
              ) : null}
              .
            </span>
          </div>
        </div>

        {filtered.length === 0 ? (
          <div className="text-center py-20">
            <p className="text-lg">No media items yet for this IP.</p>
            <p className="text-sm opacity-70 mt-2">
              Add a Media post in Admin ‚Üí Media with metadata.book/universe and metadata.audio_url or metadata.media_url.
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {filtered.map((item) => (
              <div
                key={item.id}
                className="rounded-3xl border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm bg-white/70 dark:bg-gray-900/50"
              >
                <div className="relative h-48">
                  <img src={item.card_img} alt="" className="absolute inset-0 w-full h-full object-cover" />
                  <div className="absolute inset-0 bg-gradient-to-tr from-black/55 to-transparent" />
                  <div className="absolute bottom-4 left-4 right-4">
                    <div className="text-[11px] tracking-[0.28em] uppercase text-white/80">{prettyType(item.media_type)}</div>
                    <div className="text-xl font-bold text-white">{item.title}</div>
                  </div>
                </div>

                <div className="p-5">
                  <p className="text-sm opacity-80 line-clamp-3">{item.excerpt || "Explore this media item."}</p>

                  <div className="mt-4 flex gap-2 flex-wrap">
                    {item.platform && (
                      <span className="px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs dark:bg-gray-800 dark:text-gray-200">
                        {item.platform}
                      </span>
                    )}
                    {item.ip && (
                      <span className="px-2 py-1 rounded-full bg-amber-100 text-amber-700 text-xs dark:bg-amber-900/40 dark:text-amber-200">
                        {item.ip}
                      </span>
                    )}
                    {item.scene && (
                      <span className="px-2 py-1 rounded-full bg-purple-100 text-purple-700 text-xs dark:bg-purple-900/40 dark:text-purple-200">
                        {clamp(item.scene, 40)}
                      </span>
                    )}
                  </div>

                  <div className="mt-4">
                    <MediaEmbed mediaUrl={item.media_url} audioUrl={item.audio_url} />
                  </div>

                  <div className="mt-4 flex gap-2 flex-wrap">
                    <Link href={`/media/${item.slug}`} className="text-sm font-semibold underline">
                      {primaryCta(item)} Details ‚Üí
                    </Link>
                    {item.download_url && (
                      <a
                        href={item.download_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-sm font-semibold underline"
                      >
                        Download ‚Üí
                      </a>
                    )}
                    {item.license_url && (
                      <a
                        href={item.license_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-sm font-semibold underline"
                      >
                        License ‚Üí
                      </a>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>

      <section id="subscribe" className="container mx-auto px-4 pb-16">
        <SubscriptionForm
          formId="8427848"
          uid="637df68a01"
          title="Get Media Updates"
          description="New soundtrack drops, trailer releases, and scene music by IP."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/media/[slug].js  (size=4537 bytes) =====
// pages/media/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

// helper to pick a hero image
function pickHero(post) {
  return (
    post.featured_image ||
    post.thumbnail_url ||
    (post.metadata && post.metadata.cover_url) ||
    '/placeholder.png'
  );
}

// same embed helper logic as list page
function MediaEmbed({ mediaUrl }) {
  if (!mediaUrl) return null;

  const isYouTube =
    mediaUrl.includes('youtube.com') || mediaUrl.includes('youtu.be');

  if (isYouTube) {
    let embed = mediaUrl;
    if (mediaUrl.includes('watch?v=')) {
      const videoId = mediaUrl.split('watch?v=')[1].split('&')[0];
      embed = `https://www.youtube.com/embed/${videoId}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded overflow-hidden border border-gray-300 dark:border-gray-700 mb-6">
        <iframe
          src={embed}
          title="Media Player"
          className="w-full h-full"
          allowFullScreen
        />
      </div>
    );
  }

  // fallback if not YouTube
  return (
    <div className="mb-6">
      <a
        href={mediaUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="inline-block bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded hover:bg-blue-700 transition"
      >
        Open / Play Media
      </a>
    </div>
  );
}

export default function MediaDetailPage() {
  const router = useRouter();
  const { slug } = router.query;

  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);

  // fetch single media post by slug
  useEffect(() => {
    if (!slug) return;
    (async () => {
      try {
        const res = await fetch(`/api/posts?division=media&slug=${slug}`);
        const json = await res.json();

        // normalize result
        let row = null;
        if (Array.isArray(json)) {
          row = json[0] || null;
        } else if (json.post) {
          row = json.post;
        } else if (json.items) {
          row = json.items[0] || null;
        }

        setPost(row);
      } catch (err) {
        console.error('media slug fetch error:', err);
        setPost(null);
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">Loading‚Ä¶</div>
    );
  }

  if (!post) {
    return (
      <div className="container mx-auto px-4 py-16">
        Media item not found.
      </div>
    );
  }

  const heroImg = pickHero(post);
  const mediaType = post.metadata?.media_type;
  const mediaUrl = post.metadata?.media_url;

  return (
    <>
      <Head>
        <title>{post.title} ‚Äî Manyagi Media</title>
        <meta
          name="description"
          content={
            post.excerpt || 'Manyagi Media feature'
          }
        />
      </Head>

      <section className="container mx-auto px-4 pb-32 pt-16 md:pb-16 max-w-3xl">
        {/* Title */}
        <h1 className="text-4xl font-bold mb-4">
          {post.title}
        </h1>

        {/* Badges */}
        <div className="flex flex-wrap gap-2 text-xs font-semibold mb-6">
          {mediaType && (
            <span className="inline-block bg-gray-900 text-white px-2 py-1 rounded uppercase tracking-wide">
              {mediaType}
            </span>
          )}
          <span className="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
            Manyagi Media
          </span>
        </div>

        {/* Hero image */}
        <div className="w-full h-64 md:h-[360px] rounded overflow-hidden bg-gray-200 mb-6 border border-gray-300 dark:border-gray-700">
          <img
            src={heroImg}
            alt={post.title}
            className="w-full h-full object-cover"
          />
        </div>

        {/* Player / CTA */}
        <MediaEmbed mediaUrl={mediaUrl} />

        {/* Excerpt */}
        {post.excerpt && (
          <p className="mb-6 text-lg text-gray-800 dark:text-gray-200 whitespace-pre-line">
            {post.excerpt}
          </p>
        )}

        {/* Content */}
        {post.content && (
          <article className="prose prose-neutral dark:prose-invert max-w-none whitespace-pre-line">
            {post.content}
          </article>
        )}
      </section>
    </>
  );
}


===== FILE: pages/privacy.js  (size=1152 bytes) =====
// pages/privacy.js
import Head from 'next/head';
import Link from 'next/link';
import Hero from '../components/Hero';

export default function Privacy() {
  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Privacy Policy</title>
        <meta name="description" content="Read Manyagi‚Äôs Privacy Policy." />
      </Head>
      <Hero
        kicker="Privacy"
        title="Privacy Policy"
        lead="Learn how we protect your data."
        carouselImages={['/images/og-home.webp']}
        height="h-[600px]"
      />
      <section className="container mx-auto px-4 py-16 text-sm space-y-4">
        <h2 className="text-xl font-bold">1. Data Collection</h2>
        <p>We collect minimal data for services like subscriptions and orders.</p>
        <h2 className="text-xl font-bold">2. GDPR Compliance</h2>
        <p>We protect your data under GDPR. Contact us at <a href="mailto:support@manyagi.net" className="text-blue-600 hover:underline">support@manyagi.net</a>.</p>
        <h2 className="text-xl font-bold">3. Cookies</h2>
        <p>We use cookies for analytics.</p>
      </section>
    </>
  );
}


===== FILE: pages/products.js  (size=2200 bytes) =====
import Head from 'next/head';
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';

export default function Products() {
  const [products, setProducts] = useState([]);
  const [division, setDivision] = useState('all');

  useEffect(() => {
    (async () => {
      let query = supabase.from('products').select('*');
      if (division !== 'all') query = query.eq('division', division);
      const { data } = await query;
      setProducts(data || []);
    })();
  }, [division]);

  const handleBuy = async (productId) => {
    const { data: session } = await supabase.auth.getSession();
    const response = await fetch('/api/stripe/charge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, userId: session?.session?.user?.id })
    });
    const { url } = await response.json();
    window.location.href = url; // Redirect to Stripe checkout
  };

  return (
    <>
      <Head>
        <title>Products - Manyagi</title>
      </Head>
      <div className="container mx-auto px-4 py-8">
        <h1 className="text-4xl font-bold mb-4">Products</h1>
        <select onChange={(e) => setDivision(e.target.value)} className="p-2 border rounded mb-4">
          <option value="all">All Divisions</option>
          <option value="publishing">Publishing</option>
          <option value="designs">Designs</option>
          <option value="capital">Capital</option>
          <option value="tech">Tech</option>
          <option value="media">Media</option>
          <option value="realty">Realty</option>
        </select>
        <ul className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {products.map((p) => (
            <li key={p.id} className="border p-4 rounded">
              <h2 className="text-2xl">{p.name} - ${p.price} ({p.division})</h2>
              <button
                onClick={() => handleBuy(p.id)}
                className="mt-2 p-2 bg-green-500 text-white rounded"
              >
                Buy Now
              </button>
            </li>
          ))}
        </ul>
      </div>
    </>
  );
}


===== FILE: pages/publishing.js  (size=23656 bytes) =====
// pages/publishing.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState, useMemo } from 'react';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';
import SectionIntro from '../components/SectionIntro';
import { supabase } from '@/lib/supabase';

const asList = (v) =>
  Array.isArray(v) ? v : Array.isArray(v?.items) ? v.items : [];

const pickImage = (p) =>
  p?.thumbnail_url ||
  p?.display_image ||
  p?.image_url ||
  p?.image ||
  '/placeholder.png';

// simple Fisher‚ÄìYates shuffle for light randomization
const shuffle = (arr) => {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

/**
 * Offers have tier/access_tier/required_tier in metadata.
 * Books do NOT.
 */
const isStudioOffer = (p) => {
  const m = p?.metadata || {};
  const tier = m?.tier ?? m?.access_tier ?? m?.required_tier;
  return tier !== undefined && tier !== null && String(tier).trim() !== '';
};

const isBook = (p) => !isStudioOffer(p);

export default function Publishing() {
  const dispatch = useDispatch();
  const [products, setProducts] = useState([]);
  const [carouselImages, setCarouselImages] = useState([]);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(true);

  // UX: allow readers to filter by series/universe
  const [activeSeries, setActiveSeries] = useState('ALL');

  // ‚úÖ NEW: stop double-clicking + show basic feedback
  const [checkoutLoadingId, setCheckoutLoadingId] = useState(null);

  useEffect(() => {
    (async () => {
      try {
        // ---- 1) Fetch publishing products ----
        const res = await fetch('/api/products?division=publishing');
        const json = await res.json();
        const list = asList(json).map((p) => ({
          ...p,
          display_image: pickImage(p),
        }));
        setProducts(list);
        setTotal(Number(json?.total ?? list.length));

        // ---- 2) Fetch carousel images for hero ----
        const { data: assetData, error: assetErr } = await supabase
          .from('assets')
          .select('file_url')
          .eq('division', 'publishing')
          .eq('purpose', 'carousel')
          .order('created_at', { ascending: false });

        if (assetErr) {
          console.warn('[publishing carousel assets error]', assetErr);
        }

        const fetchedImages = assetData?.map((d) => d.file_url) || [];

        setCarouselImages(
          fetchedImages.length > 0
            ? fetchedImages
            : [
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-1.webp',
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-2.webp',
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-3.webp',
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-4.webp',
              ]
        );
      } catch (err) {
        console.error('Publishing fetch error:', err);
        setProducts([]);
        setTotal(0);
        setCarouselImages([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const handleAddToCart = (product) => {
    dispatch(addToCart({ ...product, productType: 'book' }));
  };

  // ‚úÖ NEW: Stripe checkout (re-uses your existing create-session endpoint)
  const handleStripeCheckout = async (product) => {
    try {
      const pid = product?.id;
      if (!pid) {
        alert('Missing product id.');
        return;
      }

      // Only show button when this exists, but guard anyway
      const stripePriceId = product?.metadata?.stripe_price_id;
      if (!stripePriceId) {
        alert('This book is not configured for Stripe checkout yet.');
        return;
      }

      setCheckoutLoadingId(pid);

      const res = await fetch('/api/checkout/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: pid,
          quantity: 1,
          // optional overrides:
          // success_url: `${window.location.origin}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
          // cancel_url: `${window.location.origin}/publishing`,
        }),
      });

      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || 'Checkout failed');

      if (json?.url) {
        window.location.href = json.url;
      } else {
        throw new Error('No checkout URL returned');
      }
    } catch (e) {
      alert(`Checkout failed: ${e.message}`);
    } finally {
      setCheckoutLoadingId(null);
    }
  };

  /**
   * books-only list derived once and reused everywhere
   */
  const books = useMemo(() => products.filter(isBook), [products]);

  // ---- Derived data: series filters & filtered list ----
  const seriesOptions = useMemo(() => {
    const set = new Set();
    books.forEach((p) => {
      const m = p.metadata || {};
      const label = m.series || m.book;
      if (label) set.add(String(label));
    });
    return ['ALL', ...Array.from(set)];
  }, [books]);

  const filteredProducts = useMemo(() => {
    if (activeSeries === 'ALL') return books;
    return books.filter((p) => {
      const m = p.metadata || {};
      return m.series === activeSeries || m.book === activeSeries;
    });
  }, [books, activeSeries]);

  // ---- Multi-rail slices ----
  const startHereBooks = useMemo(() => {
    if (!books.length) return [];
    const flagged = books.filter((p) => p?.metadata?.start_here);
    if (flagged.length >= 3) return shuffle(flagged).slice(0, 3);

    const sorted = [...books].sort(
      (a, b) => (b?.metadata?.year || 0) - (a?.metadata?.year || 0)
    );
    return sorted.slice(0, 3);
  }, [books]);

  const sampleBooks = useMemo(
    () => shuffle(books.filter((p) => p?.metadata?.pdf_url)).slice(0, 4),
    [books]
  );

  const merchLinkedBooks = useMemo(
    () =>
      shuffle(
        books.filter((p) => {
          const m = p.metadata || {};
          const tags = p.tags || [];
          return m.has_merch || tags.includes('has_merch') || tags.includes('designs');
        })
      ).slice(0, 4),
    [books]
  );

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading books...
      </div>
    );
  }

  const list = asList(filteredProducts);

  return (
    <>
      <Head>
        <title>Manyagi Publishing ‚Äî Discover Epic Tales</title>
        <meta
          name="description"
          content="Immerse yourself in cinematic novels and poetry by D.N. Manyagi across the connected Manyagi Universe."
        />
      </Head>

      {/* HERO */}
      <Hero
        kicker="Manyagi Publishing"
        title="Uncover Hidden Worlds & Lasting Characters"
        lead="From grounded dystopias to hybrid magic-tech epics, explore stories built to live far beyond the page."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <div className="flex flex-wrap gap-3 justify-center">
          <Link
            href="#where-to-start"
            className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
          >
            Start Reading
          </Link>
          <Link
            href="#books"
            className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
          >
            Browse the Library
          </Link>
        </div>
      </Hero>

      {/* MICRO-NAV */}
      <section className="container mx-auto px-4 -mt-8 mb-10">
        <div className="flex gap-2 overflow-x-auto no-scrollbar justify-center text-xs md:text-[13px]">
          {[
            { href: '#where-to-start', label: 'Start Here' },
            { href: '#books', label: 'All Books' },
            { href: '#samples', label: 'Samples' },
            { href: '#books-with-merch', label: 'With Merch' },
            { href: '#subscribe', label: 'Updates' },
            { href: '#reader-impressions', label: 'Praise' },
          ].map((item) => (
            <a
              key={item.href}
              href={item.href}
              className="whitespace-nowrap px-3 py-2 rounded-full border border-gray-200/80 bg-white/80 text-gray-800 hover:bg-gray-100 hover:border-blue-400 transition dark:bg-gray-900/80 dark:border-gray-700 dark:text-gray-100 dark:hover:bg-gray-800"
            >
              {item.label}
            </a>
          ))}
        </div>
      </section>

      {/* TESTIMONIALS */}
      <SectionIntro
        id="reader-impressions"
        kicker="Reader Impressions"
        title="Stories Made to Stay With You"
        lead="Readers describe the Manyagi Universe as emotionally grounded, cinematic, and dangerously bingeable. Start with any book and you'll feel the connective tissue running through them all."
        tone="warm"
      />

      <section className="container mx-auto px-4 pb-10 -mt-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          <div className="card p-5 text-center bg-white/90 shadow-sm rounded-2xl dark:bg-gray-900/60">
            <p className="italic text-sm md:text-base">
              &quot;Felt like watching a prestige series in my head.&quot;
            </p>
            <p className="text-xs mt-3 text-gray-500 dark:text-gray-400">‚Äî Early Reader</p>
          </div>
          <div className="card p-5 text-center bg-white/90 shadow-sm rounded-2xl dark:bg-gray-900/60">
            <p className="italic text-sm md:text-base">
              &quot;Grounded, human, and still wildly imaginative.&quot;
            </p>
            <p className="text-xs mt-3 text-gray-500 dark:text-gray-400">‚Äî Beta Reader</p>
          </div>
          <div className="card p-5 text-center bg-white/90 shadow-sm rounded-2xl dark:bg-gray-900/60">
            <p className="italic text-sm md:text-base">
              &quot;The kind of world you keep thinking about at work.&quot;
            </p>
            <p className="text-xs mt-3 text-gray-500 dark:text-gray-400">‚Äî Advance Copy Reader</p>
          </div>
        </div>
      </section>

      {/* LIBRARY */}
      <section id="books" className="container mx-auto px-4 pt-10 pb-16">
        {seriesOptions.length > 1 && (
          <div className="flex flex-wrap gap-3 justify-center mb-6">
            {seriesOptions.map((series) => {
              const isActive = activeSeries === series;
              return (
                <button
                  key={series}
                  type="button"
                  onClick={() => setActiveSeries(series)}
                  className={[
                    'px-4 py-2 rounded-full text-sm border transition',
                    isActive
                      ? 'bg-blue-600 text-white border-blue-600 shadow-sm'
                      : 'bg-white/90 text-gray-800 border-gray-200 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700 dark:hover:bg-gray-800',
                  ].join(' ')}
                >
                  {series === 'ALL' ? 'All Series' : series}
                </button>
              );
            })}
          </div>
        )}

        {/* Snapshot (your ‚Äúcount only what is shown‚Äù version) */}
        <div className="mb-8">
          <div className="max-w-3xl mx-auto">
            <div className="flex flex-col items-center gap-2 px-4 py-3 rounded-2xl bg-white/80 border border-amber-200/70 shadow-sm text-sm text-gray-700 text-center dark:bg-gray-900/70 dark:border-amber-800/60 dark:text-gray-100">
              <span className="text-[11px] font-semibold tracking-[0.26em] uppercase text-amber-700/80 dark:text-amber-300/80">
                Library Snapshot
              </span>
              <span>
                Showing <span className="font-semibold">{list.length}</span> of{' '}
                <span className="font-semibold">{list.length}</span> books &amp; collections
                {activeSeries !== 'ALL' && (
                  <>
                    {' '}
                    in <span className="italic">‚Äú{activeSeries}‚Äù</span>
                  </>
                )}
                .
              </span>

              {activeSeries !== 'ALL' && (
                <button
                  type="button"
                  onClick={() => setActiveSeries('ALL')}
                  className="inline-flex items-center gap-1 rounded-full border border-amber-300/80 bg-amber-50/70 px-3 py-1 text-xs font-medium text-amber-900 hover:bg-amber-100 dark:border-amber-700/80 dark:bg-amber-900/40 dark:text-amber-50 dark:hover:bg-amber-900/60"
                >
                  <span>Clear filter</span>
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Grid */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {list.length === 0 ? (
            <div className="col-span-full text-center text-lg">
              No publishing items found for this filter yet.
            </div>
          ) : (
            list.map((product) => {
              const m = product.metadata || {};
              const buyUrl =
                m.amazon_url ||
                m.kindle_url ||
                m.paperback_url ||
                m.store_url ||
                null;

              const stripePriceId = m.stripe_price_id || null;

              const alsoLinks = [
                m.kindle_url ? { label: 'Kindle', url: m.kindle_url } : null,
                m.paperback_url ? { label: 'Paperback', url: m.paperback_url } : null,
              ].filter(Boolean);

              const chips = [
                m.series || m.book || null,
                m.format ? String(m.format).toUpperCase() : null,
                m.year ? `Published ${m.year}` : null,
              ].filter(Boolean);

              const isCheckingOut = checkoutLoadingId === product.id;

              return (
                <Card
                  key={product.id}
                  title={product.name}
                  description={product.description}
                  image={product.display_image || pickImage(product)}
                  category="publishing"
                  tags={Array.isArray(product.tags) ? product.tags : []}
                >
                  {chips.length > 0 && (
                    <div className="flex flex-wrap gap-2 justify-center mb-3">
                      {chips.map((c) => (
                        <span
                          key={c}
                          className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
                        >
                          {c}
                        </span>
                      ))}
                    </div>
                  )}

                  {/* CTAs */}
                  <div className="flex flex-wrap gap-3 mt-2 justify-center">
                    {/* External store wins if present */}
                    {buyUrl && (
                      <a
                        href={buyUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
                      >
                        Get Your Copy
                      </a>
                    )}

                    {/* Stripe buy for digital (only when no external buyUrl) */}
                    {!buyUrl && stripePriceId && (
                      <button
                        type="button"
                        disabled={isCheckingOut}
                        onClick={() => handleStripeCheckout(product)}
                        className={[
                          'btn py-2 px-4 rounded transition',
                          isCheckingOut
                            ? 'bg-gray-400 text-white cursor-not-allowed'
                            : 'bg-blue-600 text-white hover:bg-blue-700',
                        ].join(' ')}
                        title={`Stripe: ${stripePriceId}`}
                      >
                        {isCheckingOut ? 'Redirecting‚Ä¶' : 'Buy Digital'}
                      </button>
                    )}

                    {m.pdf_url && (
                      <a
                        href={m.pdf_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="btn bg-gray-700 text-white py-2 px-4 rounded hover:bg-gray-800 transition"
                      >
                        Read Sample
                      </a>
                    )}
                  </div>

                  {alsoLinks.length > 0 && (
                    <div className="text-xs text-gray-600 dark:text-gray-300 mt-3 text-center">
                      Also available:{' '}
                      {alsoLinks.map((l, i) => (
                        <a
                          key={l.label}
                          href={l.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="underline hover:text-blue-700"
                        >
                          {l.label}
                          {i < alsoLinks.length - 1 ? ', ' : ''}
                        </a>
                      ))}
                    </div>
                  )}

                  {/* Fallback cart only when no buyUrl AND no Stripe price */}
                  {!buyUrl && !stripePriceId && (
                    <div className="mt-4 flex justify-center">
                      <button
                        type="button"
                        onClick={() => handleAddToCart(product)}
                        className="text-xs px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-100 dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-800"
                      >
                        Add to Manyagi Cart
                      </button>
                    </div>
                  )}
                </Card>
              );
            })
          )}
        </div>
      </section>

      {/* START HERE */}
      <SectionIntro
        id="where-to-start"
        kicker="Start Here"
        title="Entry Points Into the Manyagi Universe"
        lead="Not sure which book to pick up first? These titles are designed as clean on-ramps into the wider universe."
        tone="warm"
        align="center"
      />
      <section className="container mx-auto px-4 pb-16 -mt-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {startHereBooks.map((p) => (
            <Card
              key={p.id}
              title={p.name}
              description={p.description}
              image={p.display_image || pickImage(p)}
              category="publishing"
            />
          ))}
          {startHereBooks.length < 3 && (
            <p className="col-span-full text-center opacity-70 text-sm">
              Flag more titles with <code>metadata.start_here = true</code> in admin to fill this rail.
            </p>
          )}
        </div>
      </section>

      {/* SAMPLES */}
      {sampleBooks.length > 0 && (
        <>
          <SectionIntro
            id="samples"
            kicker="Free to Read"
            title="Books with Sample Chapters"
            lead="Dip into the worlds before you commit ‚Äî these titles include free PDF samples or first chapters."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-16 -mt-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-5">
              {sampleBooks.map((p) => {
                const m = p.metadata || {};
                return (
                  <Card
                    key={p.id}
                    title={p.name}
                    description={p.description}
                    image={p.display_image || pickImage(p)}
                    category="publishing"
                  >
                    {m.pdf_url && (
                      <div className="mt-3 flex justify-center">
                        <a
                          href={m.pdf_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="btn bg-gray-800 text-white py-2 px-4 rounded text-xs hover:bg-black transition"
                        >
                          Read Sample
                        </a>
                      </div>
                    )}
                  </Card>
                );
              })}
            </div>
          </section>
        </>
      )}

      {/* MERCH LINKED */}
      {merchLinkedBooks.length > 0 && (
        <>
          <SectionIntro
            id="books-with-merch"
            kicker="Books With Merch"
            title="Stories With Their Own Collections"
            lead="These books have T-shirts, posters, or other designs tied directly to their worlds."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-16 -mt-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-5">
              {merchLinkedBooks.map((p) => (
                <Card
                  key={p.id}
                  title={p.name}
                  description={p.description}
                  image={p.display_image || pickImage(p)}
                  category="publishing"
                >
                  <div className="mt-3 flex justify-center">
                    <Link
                      href={`/designs?collection=${encodeURIComponent(
                        p.metadata?.series || p.metadata?.book || p.name
                      )}`}
                      className="text-xs font-semibold text-blue-600 hover:underline"
                    >
                      View merch for this book ‚Üí
                    </Link>
                  </div>
                </Card>
              ))}
            </div>
          </section>
        </>
      )}

      {/* SUBSCRIBE */}
      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427848"
          uid="637df68a01"
          title="Subscribe to Publishing Updates"
          description="Get launch dates, exclusive previews, and behind-the-scenes notes from the Manyagi Universe."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/r/[code].js  (size=1020 bytes) =====
// pages/r/[code].js
import { useRouter } from 'next/router';
import { useEffect } from 'react';

export default function AffiliateRedirect() {
  const router = useRouter();
  const { code } = router.query;

  useEffect(() => {
    if (!code) return;
    try {
      // Store cookie for 30 days
      document.cookie = `affiliate=${encodeURIComponent(
        code
      )}; path=/; max-age=${60 * 60 * 24 * 30}; SameSite=Lax`;

      // Redirect user after short delay (optional)
      setTimeout(() => {
        router.replace('/'); // or /capital, /tech, etc.
      }, 500);
    } catch (err) {
      console.error('Affiliate redirect error:', err);
    }
  }, [code]);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen text-center p-8">
      <h1 className="text-2xl font-bold mb-2">
        Thanks for supporting our partners!
      </h1>
      <p className="opacity-80">
        Redirecting you to Manyagi HQ‚Ä¶
      </p>
    </div>
  );
}


===== FILE: pages/realty.js  (size=11222 bytes) =====
// pages/realty.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import Hero from '../components/Hero';
import Card from '../components/Card';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import RealtyLeadForm from '../components/RealtyLeadForm';

// pick best image to show on the card
const pickCardImage = (p) =>
  p.image_url ||
  (p.metadata && p.metadata.cover_url) ||
  '/placeholder.png';

export default function RealtyList() {
  const [properties, setProperties] = useState([]);
  const [loading, setLoading] = useState(true);

  // load all properties in division=realty
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/realty/property?all=1');
        const json = await res.json();
        // json.properties should be [{id,name,slug,description,nightly_price,image_url,metadata,...}]
        const list = (json.properties || []).map((p) => ({
          ...p,
          display_image: pickCardImage(p),
        }));
        setProperties(list);
      } catch (err) {
        console.error('Realty list fetch error:', err);
        setProperties([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/rental-bigbear.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-realty.webp',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Realty ‚Äî California Rentals, Residential & Commercial</title>
        <meta
          name="description"
          content="Manyagi Realty helps you buy, sell, invest, and stay in story-inspired properties across California, plus short-term rentals managed like an Airbnb pro."
        />
      </Head>

      {/* HERO: Brand + primary CTAs */}
      <Hero
        kicker="Manyagi Realty"
        title="California Realty, Story-Inspired Stays."
        lead="Licensed California real estate, Vegas-seasoned experience, and short-term rentals run like a pro host ‚Äî all under one boutique brand."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <div className="flex flex-col sm:flex-row gap-3">
          <Link
            href="#properties"
            className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-sm font-semibold"
          >
            Browse Vacation Rentals
          </Link>
          <Link
            href="#work-with-us"
            className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-white transition text-sm font-semibold"
          >
            Work With a Realtor
          </Link>
        </div>
      </Hero>

      {/* SERVICES STRIPE: Residential / Commercial / STR Mgmt */}
      <section className="container mx-auto px-4 pt-12 pb-4">
        <div className="grid gap-6 md:grid-cols-3">
          <div className="rounded-2xl border border-gray-200/80 bg-white/80 dark:bg-gray-900/80 dark:border-gray-700 p-5 shadow-sm">
            <h3 className="text-lg font-semibold mb-1">Residential Buyers & Sellers</h3>
            <p className="text-sm opacity-80 mb-3">
              Single-family homes, condos, and townhomes across California. From first-time
              buyers to move-up sellers, we handle search, pricing, negotiations, and closing.
            </p>
            <ul className="text-xs space-y-1 opacity-80">
              <li>‚Ä¢ Home search & private showings</li>
              <li>‚Ä¢ Listing prep, pricing, and marketing</li>
              <li>‚Ä¢ Offer strategy & negotiation</li>
            </ul>
          </div>

          <div className="rounded-2xl border border-gray-200/80 bg-white/80 dark:bg-gray-900/80 dark:border-gray-700 p-5 shadow-sm">
            <h3 className="text-lg font-semibold mb-1">Small Commercial & Investors</h3>
            <p className="text-sm opacity-80 mb-3">
              Small multifamily, mixed-use, and light commercial. Ideal for investors who care
              about cash flow, appreciation, and long-term wealth.
            </p>
            <ul className="text-xs space-y-1 opacity-80">
              <li>‚Ä¢ Deal sourcing & underwriting support</li>
              <li>‚Ä¢ Rent comps & revenue projections</li>
              <li>‚Ä¢ 1031-friendly timelines & referrals</li>
            </ul>
          </div>

          <div className="rounded-2xl border border-gray-200/80 bg-white/80 dark:bg-gray-900/80 dark:border-gray-700 p-5 shadow-sm">
            <h3 className="text-lg font-semibold mb-1">Short-Term Rental & Airbnb Ops</h3>
            <p className="text-sm opacity-80 mb-3">
              From Big Bear to SoCal, we manage furnished stays like a full-time host ‚Äî so you
              don‚Äôt touch guest messages, cleaners, or dynamic pricing.
            </p>
            <ul className="text-xs space-y-1 opacity-80">
              <li>‚Ä¢ Airbnb / VRBO management</li>
              <li>‚Ä¢ Calendar sync and cleaner-friendly ops</li>
              <li>‚Ä¢ Revenue optimization & reviews strategy</li>
            </ul>
          </div>
        </div>
      </section>

      {/* RENTALS GRID */}
      <section
        id="properties"
        className="container mx-auto px-4 py-16"
      >
        <header className="max-w-2xl mb-8">
          <h2 className="text-2xl md:text-3xl font-bold mb-2">Featured Stays & Rentals</h2>
          <p className="text-sm md:text-base opacity-80">
            Every booking comes with clear communication, cleaner-friendly schedules, and
            transparent pricing. As we add more properties, they‚Äôll all appear here.
          </p>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {loading ? (
            <div className="col-span-full text-center text-lg">
              Loading properties...
            </div>
          ) : properties.length === 0 ? (
            <div className="col-span-full text-center text-lg">
              No properties available yet. Check back soon!
            </div>
          ) : (
            properties.map((prop) => (
              <Card
                key={prop.id}
                title={
                  <div className="space-y-2">
                    <div className="text-lg font-semibold leading-snug">
                      {prop.name}
                    </div>
                    {prop.nightly_price ? (
                      <div className="inline-block bg-yellow-100 text-yellow-800 text-[11px] font-semibold px-2 py-1 rounded">
                        From ${prop.nightly_price}/night
                      </div>
                    ) : null}
                  </div>
                }
                description={
                  prop.description || 'Premium rental property experience.'
                }
                image={prop.display_image}
                category="realty"
              >
                <div className="mt-4 flex items-center justify-between gap-2">
                  {prop.slug ? (
                    <Link
                      href={`/realty/${prop.slug}`}
                      className="btn bg-yellow-500 text-black py-2 px-4 rounded hover:bg-yellow-400 transition text-sm font-semibold"
                    >
                      View Details &amp; Book
                    </Link>
                  ) : (
                    <span className="text-xs opacity-70">
                      (no slug set yet, cannot view details)
                    </span>
                  )}
                  {prop.metadata?.location && (
                    <span className="text-[11px] opacity-70">
                      {prop.metadata.location}
                    </span>
                  )}
                </div>
              </Card>
            ))
          )}
        </div>
      </section>

      {/* BUY / SELL / MANAGEMENT LEAD BLOCK */}
      <section
        id="work-with-us"
        className="container mx-auto px-4 pb-16"
      >
        <div className="rounded-3xl bg-gradient-to-r from-amber-300 via-amber-400 to-orange-400 dark:from-amber-400 dark:via-amber-500 dark:to-orange-500 px-6 py-10 md:px-10 md:py-12 shadow-xl">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-10 items-start">
            <div className="space-y-4 text-gray-900">
              <p className="uppercase tracking-[0.2em] text-xs font-semibold">
                Manyagi Realty ¬∑ California
              </p>
              <h2 className="text-2xl md:text-3xl font-extrabold">
                Buying, selling, or need management in California?
              </h2>
              <p className="text-sm md:text-base leading-relaxed">
                Boutique representation powered by a licensed California Realtor¬Æ with
                roots in the Las Vegas market. Whether you&apos;re moving in, cashing
                out, or turning a cabin into a high-performing Airbnb, you get one point
                of contact and a full stack of systems behind the scenes.
              </p>
              <ul className="text-sm space-y-1.5">
                <li>‚Ä¢ Residential: houses, condos, and townhomes.</li>
                <li>‚Ä¢ Small commercial &amp; multifamily for investors.</li>
                <li>‚Ä¢ Full-service Airbnb / VRBO setup and management.</li>
                <li>‚Ä¢ Off-market conversations for the right opportunities.</li>
              </ul>
              <p className="text-xs opacity-80">
                Based in California with prior licensing and transaction history in Las
                Vegas ‚Äî experience on both sides of the state line, focused on smart
               , long-term decisions.
              </p>
              <div className="flex flex-wrap gap-3 pt-2 text-[11px] font-semibold">
                <span className="px-3 py-1 rounded-full bg-white/70">
                  Residential &amp; Commercial
                </span>
                <span className="px-3 py-1 rounded-full bg-white/70">
                  Short-Term Rental Friendly
                </span>
                <span className="px-3 py-1 rounded-full bg-white/70">
                  Investors Welcome
                </span>
              </div>
            </div>

            <div className="max-w-md ml-auto w-full">
              <RealtyLeadForm className="shadow-2xl" />
            </div>
          </div>
        </div>
      </section>

      {/* Newsletter opt-in */}
      <section id="subscribe" className="container mx-auto px-4 pb-16">
        <SubscriptionForm
          formId="8427851"
          uid="637df68a04"
          title="Stay Updated on Realty Listings"
          description="Get notified about new properties, rentals, and investment opportunities."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/realty/[slug].js  (size=21075 bytes) =====
// pages/realty/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState, useMemo } from 'react';
import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import enUS from 'date-fns/locale/en-US';
import 'react-big-calendar/lib/css/react-big-calendar.css';

// react-big-calendar localizer
const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: { 'en-US': enUS },
});

// safer date builder (avoid DST weirdness by using noon local time)
function ymdToDate(ymd) {
  const [y, m, d] = ymd.split('-').map(Number);
  return new Date(y, m - 1, d, 12, 0, 0);
}

// build calendar events out of merged blocks from /api/realty/calendar-blocks
function buildCalendarEvents(blocks) {
  const out = [];
  (blocks || []).forEach((b) => {
    const start = ymdToDate(b.start);

    // blocks are inclusive [start..end], but react-big-calendar
    // expects end to be EXCLUSIVE, so add 1 day
    const endInclusive = ymdToDate(b.end);
    const endExclusive = new Date(endInclusive);
    endExclusive.setDate(endExclusive.getDate() + 1);

    out.push({
      title: b.label || 'Booked',
      start,
      end: endExclusive,
      allDay: true,
      resource: b.kind || 'blocked',
    });
  });
  return out;
}

// small helper for quote breakdown rows
function MoneyRow({ label, value }) {
  return (
    <div className="flex justify-between text-sm">
      <span>{label}</span>
      <span>${Number(value || 0).toFixed(2)}</span>
    </div>
  );
}

export default function PropertyDetail() {
  const router = useRouter();
  const { slug } = router.query;

  // property record from Supabase
  const [property, setProperty] = useState(null);

  // unavailable ranges (paid reservations + synced external blocks)
  const [blocks, setBlocks] = useState([]);

  // booking form state
  const [checkin, setCheckin] = useState('');
  const [checkout, setCheckout] = useState('');
  const [guests, setGuests] = useState(1);

  // guest info (for checkout)
  const [guestName, setGuestName] = useState('');
  const [guestEmail, setGuestEmail] = useState('');
  const [guestPhone, setGuestPhone] = useState('');
  const [notes, setNotes] = useState('');

  // quote result from server (pricing summary, nights, tax, etc.)
  const [quote, setQuote] = useState(null);

  // ui state flags
  const [loading, setLoading] = useState(true);
  const [busy, setBusy] = useState(false);

  // --- LOAD PROPERTY + BLOCKED DATES ---
  useEffect(() => {
    if (!slug) return;
    (async () => {
      try {
        // 1. property details (name, desc, gallery, metadata, etc.)
        const propRes = await fetch(`/api/realty/property?slug=${slug}`);
        const propJson = await propRes.json();

        if (!propJson.ok || !propJson.property) {
          setProperty(null);
          setBlocks([]);
          setLoading(false);
          return;
        }

        const propRow = propJson.property;
        setProperty(propRow);

        // 2. merged calendar blocks (paid reservations + external blocks)
        const blkRes = await fetch(
          `/api/realty/calendar-blocks?property_id=${encodeURIComponent(
            propRow.id
          )}`
        );
        const blkJson = await blkRes.json();
        setBlocks(blkJson.blocks || []);
      } catch (err) {
        console.error('property load err:', err);
        setProperty(null);
        setBlocks([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  // events for react-big-calendar
  const calendarEvents = useMemo(
    () => buildCalendarEvents(blocks),
    [blocks]
  );

  // Get server-side quote
  async function getQuote() {
    if (!checkin || !checkout) {
      alert('Select check-in and check-out');
      return;
    }
    if (!property) return;

    setBusy(true);
    try {
      const res = await fetch('/api/realty/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: property.id,
          checkin,
          checkout,
        }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON response from /quote:', txt);
        throw new Error('Server returned non-JSON for quote');
      }

      if (!data.ok) {
        throw new Error(data.error || 'Failed to get quote');
      }

      setQuote(data);
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  }

  // Start Stripe Checkout session
  async function book() {
    if (!quote) {
      alert('Get a quote first');
      return;
    }
    if (!guestName || !guestEmail) {
      alert('Enter name and email');
      return;
    }

    // ADDED:
    // If they don't meet min stay, block booking
    if (quote && quote.meets_min_stay === false) {
      alert(
        `This stay does not meet the minimum of ${quote.min_nights_required} night${
          Number(quote.min_nights_required) === 1 ? '' : 's'
        } for those dates.`
      );
      return;
    }

    setBusy(true);
    try {
      const res = await fetch('/api/realty/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: property.id,
          checkin,
          checkout,
          guests,
          guest_name: guestName,
          guest_email: guestEmail,
          guest_phone: guestPhone,
          notes,
        }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON response from /create-checkout:', txt);
        throw new Error('Server error starting checkout (see console).');
      }

      if (data.url) {
        window.location.href = data.url;
      } else {
        alert(data.error || 'Checkout failed');
      }
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  }

  // CHANGED:
  // min-stay warning now uses the server's result
  const minStayWarning = useMemo(() => {
    if (!quote) return '';
    if (quote.meets_min_stay === false) {
      const req = Number(quote.min_nights_required || 0);
      if (req > 1) {
        return `This stay is below the ${req}-night minimum for those dates.`;
      } else {
        return 'This stay may not meet the minimum nights requirement.';
      }
    }
    return '';
  }, [quote]);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        Loading property...
      </div>
    );
  }

  if (!property) {
    return (
      <div className="container mx-auto px-4 py-16">
        Property not found.
      </div>
    );
  }

  // ---- UI DERIVED FIELDS ----

  // Gallery
  const coverImg =
    property.metadata?.cover_url ||
    property.image_url ||
    '/placeholder.png';

  const galleryFromMeta = Array.isArray(
    property.metadata?.gallery_urls
  )
    ? property.metadata.gallery_urls
    : [];
  const galleryLegacy = Array.isArray(property.gallery_urls)
    ? property.gallery_urls
    : [];
  const gallery =
    galleryFromMeta.length > 0
      ? galleryFromMeta
      : galleryLegacy.length > 0
      ? galleryLegacy
      : [coverImg];

  // Property location for map
  const mapQuery =
    typeof property.metadata?.location === 'string' &&
    property.metadata.location.trim().length > 2
      ? property.metadata.location.trim()
      : null;

  // Stats
  const beds = property.metadata?.beds;
  const baths = property.metadata?.baths;
  const sleeps = property.metadata?.sleeps;
  const amenities = Array.isArray(property.metadata?.amenities)
    ? property.metadata.amenities
    : [];

  return (
    <>
      <Head>
        <title>{property.name} ‚Äî Manyagi Realty</title>
        <meta
          name="description"
          content={property.description || ''}
        />
      </Head>

      <section className="container mx-auto px-4 pb-32 pt-16 md:pb-16 max-w-5xl">
        {/* Title */}
        <h1 className="text-4xl font-bold mb-6">{property.name}</h1>

        {/* HERO IMAGE + THUMBS */}
        <div className="mb-8">
          {/* main hero image */}
          <div className="w-full h-64 md:h-[400px] rounded overflow-hidden bg-gray-200 mb-4">
            <img
              src={gallery[0]}
              alt={property.name}
              className="w-full h-full object-cover"
            />
          </div>

          {/* thumbnails */}
          {gallery.length > 1 && (
            <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
              {gallery.slice(1, 7).map((url, idx) => (
                <div
                  key={idx}
                  className="w-full h-24 md:h-28 rounded overflow-hidden bg-gray-200"
                >
                  <img
                    src={url}
                    alt={`Gallery ${idx + 2}`}
                    className="w-full h-full object-cover"
                  />
                </div>
              ))}
            </div>
          )}

          {/* more photos indicator */}
          {gallery.length > 6 && (
            <div className="text-sm text-blue-600 mt-2 cursor-pointer">
              + {gallery.length - 6} more photos
            </div>
          )}
        </div>

        {/* QUICK FACTS */}
        <section className="border-b border-gray-200 dark:border-gray-700 pb-6 mb-8">
          <div className="flex flex-wrap gap-4 text-sm text-gray-700 dark:text-gray-300">
            {beds ? (
              <div className="flex items-center gap-1">
                <span role="img" aria-label="beds">
                  üõèÔ∏è
                </span>
                <span>{beds} Beds</span>
              </div>
            ) : null}

            {baths ? (
              <div className="flex items-center gap-1">
                <span role="img" aria-label="baths">
                  üõÅ
                </span>
                <span>{baths} Baths</span>
              </div>
            ) : null}

            {sleeps ? (
              <div className="flex items-center gap-1">
                <span role="img" aria-label="sleeps">
                  üßç‚Äç‚ôÇÔ∏è
                </span>
                <span>Sleeps {sleeps}</span>
              </div>
            ) : null}

            {property.nightly_price ? (
              <div className="flex items-center gap-1 font-semibold text-yellow-700 bg-yellow-100 px-2 py-1 rounded text-xs">
                <span>From ${property.nightly_price}/night</span>
              </div>
            ) : null}
          </div>

          {amenities.length > 0 && (
            <ul className="mt-4 flex flex-wrap gap-2 text-xs">
              {amenities.map((am, i) => (
                <li
                  key={i}
                  className="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-700"
                >
                  {am}
                </li>
              ))}
            </ul>
          )}
        </section>

        {/* DESCRIPTION */}
        <p className="mb-6 whitespace-pre-line text-gray-800 dark:text-gray-200">
          {property.description}
        </p>

        {/* PRICE REMINDER */}
        <p className="mb-10 font-semibold">
          Price per night:{' '}
          {property.nightly_price
            ? `$${property.nightly_price}`
            : '‚Äî'}
        </p>

        {/* MAP */}
        {mapQuery && (
          <div className="mt-8 mb-12">
            <h2 className="text-2xl font-bold mb-2">Location</h2>
            <div className="w-full h-[350px] bg-gray-200 rounded overflow-hidden border border-gray-300 dark:border-gray-700">
              <iframe
                src={`https://maps.google.com/maps?q=${encodeURIComponent(
                  mapQuery
                )}&output=embed`}
                width="100%"
                height="350"
                style={{ border: 0 }}
                loading="lazy"
                allowFullScreen
                referrerPolicy="no-referrer-when-downgrade"
                className="w-full h-full"
              />
            </div>
          </div>
        )}

        {/* AVAILABILITY CALENDAR */}
        <div className="mt-12 mb-12">
          <h2 className="text-2xl font-bold mb-2">Availability</h2>

          <div className="bg-white dark:bg-gray-900 rounded shadow p-4 overflow-auto border border-gray-200 dark:border-gray-700">
            <Calendar
              localizer={localizer}
              events={calendarEvents}
              startAccessor="start"
              endAccessor="end"
              views={['month']}
              defaultView="month"
              popup
              tooltipAccessor={(event) => event.title}
              style={{ height: 500 }}
              eventPropGetter={() => {
                // style blocked ranges (booked/unavailable)
                return {
                  className:
                    'bg-red-500/20 text-red-700 border border-red-300 rounded',
                };
              }}
            />
            <p className="text-xs opacity-70 mt-2">
              Marked dates are unavailable.
            </p>
          </div>
        </div>

        {/* BOOKING FORM */}
        <div className="mt-12" id="booking-form">
          <h2 className="text-2xl font-bold mb-4">
            Book Your Stay
          </h2>

          {/* inputs for checkin / checkout / guests / Get Quote */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label className="block text-sm font-semibold">
                Check-in
              </label>
              <input
                type="date"
                className="border rounded px-2 py-1 w-full dark:bg-gray-800 dark:border-gray-600"
                value={checkin}
                onChange={(e) => setCheckin(e.target.value)}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold">
                Check-out
              </label>
              <input
                type="date"
                className="border rounded px-2 py-1 w-full dark:bg-gray-800 dark:border-gray-600"
                value={checkout}
                onChange={(e) => setCheckout(e.target.value)}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold">
                Guests
              </label>
              <input
                type="number"
                min="1"
                className="border rounded px-2 py-1 w-full dark:bg-gray-800 dark:border-gray-600"
                value={guests}
                onChange={(e) => setGuests(e.target.value)}
              />
            </div>

            <div className="flex items-end">
              <button
                onClick={getQuote}
                disabled={busy}
                className="bg-blue-600 text-white rounded px-4 py-2 w-full font-semibold disabled:opacity-50"
              >
                {busy ? 'Calculating‚Ä¶' : 'Get Quote'}
              </button>
            </div>
          </div>

          {/* QUOTE BREAKDOWN */}
          {quote && quote.summary && (
            <div className="bg-gray-50 dark:bg-gray-800 rounded p-4 mb-6 text-sm border border-gray-200 dark:border-gray-700">
              <div className="font-semibold mb-2">
                {quote.summary.nights} night
                {quote.summary.nights === 1 ? '' : 's'} breakdown
              </div>

              {/* ADDED: show min stay requirement if >1 */}
              {Number(quote.min_nights_required || 0) > 1 && (
                <div className="text-xs mb-2 text-gray-700 dark:text-gray-300">
                  {quote.min_nights_required}-night minimum for
                  these dates.
                </div>
              )}

              <MoneyRow
                label="Nightly subtotal"
                value={quote.summary.base_subtotal}
              />
              {Number(quote.summary.cleaning_fee || 0) > 0 && (
                <MoneyRow
                  label="Cleaning fee"
                  value={quote.summary.cleaning_fee}
                />
              )}
              {Number(quote.summary.tax_amount || 0) > 0 && (
                <MoneyRow
                  label={`Tax (${(
                    Number(quote.summary.tax_rate || 0) * 100
                  ).toFixed(1)}%)`}
                  value={quote.summary.tax_amount}
                />
              )}

              <div className="border-t my-2 dark:border-gray-600" />

              <div className="flex justify-between text-base font-semibold">
                <span>Total</span>
                <span>
                  ${Number(quote.summary.total || 0).toFixed(2)}
                </span>
              </div>

              {/* CHANGED: smarter warning */}
              {minStayWarning && (
                <div className="mt-2 text-yellow-700 bg-yellow-100 border border-yellow-300 text-xs rounded p-2 dark:bg-yellow-800 dark:text-yellow-100 dark:border-yellow-600">
                  {minStayWarning}
                </div>
              )}
            </div>
          )}

          {/* GUEST INFO + CHECKOUT */}
          {quote && quote.summary && (
            <div className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input
                  className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                  placeholder="Full name"
                  value={guestName}
                  onChange={(e) => setGuestName(e.target.value)}
                />
                <input
                  className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                  placeholder="Email"
                  value={guestEmail}
                  onChange={(e) => setGuestEmail(e.target.value)}
                />
                <input
                  className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                  placeholder="Phone (optional)"
                  value={guestPhone}
                  onChange={(e) => setGuestPhone(e.target.value)}
                />
              </div>

              <textarea
                className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                placeholder="Notes for host (optional)"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
              />

              <button
                onClick={book}
                disabled={
                  busy ||
                  (quote && quote.meets_min_stay === false)
                }
                className="bg-green-600 text-white rounded px-4 py-3 font-semibold w-full md:w-auto disabled:opacity-50"
              >
                {busy
                  ? 'Processing‚Ä¶'
                  : quote && quote.meets_min_stay === false
                  ? 'Minimum Not Met'
                  : 'Book Now'}
              </button>
            </div>
          )}
        </div>

        {/* Contact fallback if no quote yet */}
        {!quote && (
          <div className="text-xs opacity-70 mt-8">
            Need custom dates or long-term stay? Contact us.
          </div>
        )}
      </section>

      {/* Sticky mobile CTA */}
      <div className="fixed bottom-0 left-0 right-0 md:hidden bg-white dark:bg-gray-900 text-black dark:text-white border-t border-gray-200 dark:border-gray-700 p-3 flex justify-between items-center z-50 shadow-[0_-2px_8px_rgba(0,0,0,0.08)]">
        <div className="text-sm font-semibold">
          {property.nightly_price
            ? `From $${property.nightly_price}/night`
            : ''}
        </div>
        <button
          onClick={() => {
            const el = document.getElementById('booking-form');
            if (el) {
              el.scrollIntoView({ behavior: 'smooth' });
            }
          }}
          className="bg-yellow-500 text-black dark:text-black font-semibold py-2 px-4 rounded hover:bg-yellow-400 transition"
        >
          Book Now
        </button>
      </div>
    </>
  );
}


===== FILE: pages/realty/booking/[slug].js  (size=3308 bytes) =====
// pages/realty/booking/[slug].js
import { useRouter } from 'next/router';
import { useState } from 'react';

export default function BookingForm() {
  const router = useRouter();
  const { slug } = router.query;
  const [form, setForm] = useState({
    checkin: '', checkout: '', guests: 1, guestName: '', guestEmail: '', guestPhone: '', notes: '',
  });
  const [quote, setQuote] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleQuote = async () => {
    setLoading(true);
    try {
      const res = await fetch('/api/realty/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: slug, checkin: form.checkin, checkout: form.checkout }),
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error);
      setQuote(json);
    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  };

  const handleBook = async () => {
    setLoading(true);
    try {
      const res = await fetch('/api/realty/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: slug,
          checkin: form.checkin,
          checkout: form.checkout,
          guests: form.guests,
          quote_total_cents: quote?.summary?.total * 100,
          guestName: form.guestName,
          guestEmail: form.guestEmail,
          guestPhone: form.guestPhone,
          notes: form.notes,
        }),
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error);
      window.location.href = json.url; // Redirect to Stripe
    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto px-4 py-10">
      <h1>Book Property</h1>
      <div className="grid gap-4 max-w-md">
        <input type="date" value={form.checkin} onChange={e => setForm({ ...form, checkin: e.target.value })} />
        <input type="date" value={form.checkout} onChange={e => setForm({ ...form, checkout: e.target.value })} />
        <input type="number" value={form.guests} onChange={e => setForm({ ...form, guests: e.target.value })} />
        <button onClick={handleQuote} disabled={loading} className="btn bg-blue-600 text-white">
          Get Quote
        </button>
        {quote && (
          <div>
            <p>Total: ${(quote.summary.total / 100).toFixed(2)}</p>
            <input placeholder="Name" value={form.guestName} onChange={e => setForm({ ...form, guestName: e.target.value })} />
            <input placeholder="Email" value={form.guestEmail} onChange={e => setForm({ ...form, guestEmail: e.target.value })} />
            <input placeholder="Phone" value={form.guestPhone} onChange={e => setForm({ ...form, guestPhone: e.target.value })} />
            <textarea placeholder="Notes" value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} />
            <button onClick={handleBook} disabled={loading} className="btn bg-green-600 text-white">
              Book Now
            </button>
          </div>
        )}
      </div>
    </div>
  );
}


===== FILE: pages/signup.js  (size=3189 bytes) =====
import Head from 'next/head';
import { useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';
import Hero from '../components/Hero';

export default function Signup() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleSignup = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      const { data, error: authError } = await supabase.auth.signUp({ email, password });
      if (authError) throw authError;
      await supabase.from('users').insert({
        id: data.user.id,
        email,
        role: 'user',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      });
      router.push('/dashboard');
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleGoogleSignup = async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
      if (error) throw error;
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <>
      <Head>
        <title>Sign Up - Manyagi</title>
      </Head>
      <Hero
        kicker="Join Us"
        title="Sign Up"
        lead="Create your Manyagi account."
        carouselImages={[]}
        height="h-screen"
      >
        <div className="card max-w-md mx-auto bg-white text-black glass p-8 rounded-lg shadow-xl">
          {error && <p className="text-red-500 mb-4 text-center">{error}</p>}
          <form onSubmit={handleSignup} className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <button
              type="submit"
              disabled={loading}
              className="w-full p-3 bg-black text-white rounded disabled:opacity-50 hover:bg-gray-800 transition"
            >
              {loading ? 'Processing...' : 'Sign Up'}
            </button>
          </form>
          <button
            onClick={handleGoogleSignup}
            className="mt-4 w-full p-3 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
          >
            Sign Up with Google
          </button>
          <button
            onClick={() => router.push('/login')}
            className="mt-4 text-blue-500 underline w-full text-center"
          >
            Already have an account? Login
          </button>
        </div>
      </Hero>
    </>
  );
}


===== FILE: pages/studios.js  (size=23156 bytes) =====
// pages/studios.js
import Head from "next/head";
import Link from "next/link";
import { useEffect, useMemo, useState } from "react";
import Hero from "@/components/Hero";
import SectionIntro from "@/components/SectionIntro";
import { supabase } from "@/lib/supabase";

function norm(s = "") {
  return String(s || "").toLowerCase().trim();
}

function pickUniverseArt(u, metaById) {
  return (
    u?.cover_image_url ||
    metaById?.[u.id]?.heroThumb ||
    metaById?.[u.id]?.visualThumb ||
    "/images/og-home.webp"
  );
}

function getUniverseBlurb(u) {
  return (
    u?.logline ||
    u?.tagline ||
    u?.synopsis ||
    "A premium, cinematic universe built for adaptation and expansion."
  );
}

function guessGenre(u) {
  const blob = [u?.title, u?.tagline, u?.logline, u?.synopsis].map(norm).join(" ");
  const hits = [];
  if (blob.includes("sci") || blob.includes("cyber") || blob.includes("future") || blob.includes("space")) hits.push("Sci-Fi");
  if (blob.includes("magic") || blob.includes("dragon") || blob.includes("kingdom") || blob.includes("myth")) hits.push("Fantasy");
  if (blob.includes("dystop") || blob.includes("war") || blob.includes("survival")) hits.push("Dystopian");
  if (blob.includes("horror") || blob.includes("demon") || blob.includes("curse")) hits.push("Dark");
  if (blob.includes("crime") || blob.includes("detective") || blob.includes("heist")) hits.push("Crime");
  if (blob.includes("romance")) hits.push("Romance");
  return hits.slice(0, 2);
}

function RailRow({ title, subtitle, items, metaById, q }) {
  if (!items?.length) return null;

  return (
    <section className="container mx-auto px-4 pb-10">
      <div className="flex items-end justify-between gap-4 mb-4">
        <div>
          <div className="text-sm opacity-70">{subtitle}</div>
          <h3 className="text-xl md:text-2xl font-bold">{title}</h3>
        </div>
        {q ? (
          <div className="text-xs opacity-70">Filtered by ‚Äú{q}‚Äù</div>
        ) : null}
      </div>

      {/* Netflix-ish rail */}
      <div className="flex gap-4 overflow-x-auto no-scrollbar pb-2">
        {items.map((u) => {
          const m = metaById?.[u.id] || {};
          const art = pickUniverseArt(u, metaById);
          const genres = guessGenre(u);

          return (
            <Link
              key={u.id}
              href={`/studios/${u.slug}`}
              className="group min-w-[280px] sm:min-w-[320px] md:min-w-[360px] rounded-3xl overflow-hidden border border-gray-200/80 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm hover:shadow-md transition"
            >
              <div className="relative h-44">
                <img
                  src={art}
                  alt=""
                  className="absolute inset-0 w-full h-full object-cover group-hover:scale-[1.02] transition"
                  loading="lazy"
                />
                <div className="absolute inset-0 bg-gradient-to-tr from-black/65 via-black/20 to-transparent" />

                {/* Top chips */}
                <div className="absolute top-3 left-3 right-3 flex items-center justify-between gap-2">
                  <div className="flex gap-2 flex-wrap">
                    {m.hasTrailer ? (
                      <span className="text-[11px] px-2 py-1 rounded-full bg-white/90 text-black font-semibold">
                        ‚ñ∂ Trailer
                      </span>
                    ) : null}
                    {m.hasPacket ? (
                      <span className="text-[11px] px-2 py-1 rounded-full bg-amber-200 text-amber-900 font-semibold">
                        üíº Producer Ready
                      </span>
                    ) : null}
                    {m.visualCount > 0 ? (
                      <span className="text-[11px] px-2 py-1 rounded-full bg-white/15 text-white border border-white/20">
                        üé¥ {m.visualCount} Visuals
                      </span>
                    ) : null}
                  </div>
                  <div className="text-[11px] text-white/70">
                    {u?.updated_at ? `Updated` : ""}
                  </div>
                </div>

                {/* Title */}
                <div className="absolute bottom-4 left-4 right-4">
                  <div className="text-[11px] tracking-[0.28em] uppercase text-white/70">
                    Universe
                  </div>
                  <div className="text-xl font-bold text-white leading-tight">
                    {u.title}
                  </div>
                </div>
              </div>

              <div className="p-5">
                {/* Genres */}
                {genres.length ? (
                  <div className="flex flex-wrap gap-2 mb-3">
                    {genres.map((g) => (
                      <span
                        key={g}
                        className="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
                      >
                        {g}
                      </span>
                    ))}
                  </div>
                ) : null}

                <p className="text-sm opacity-80 line-clamp-3">
                  {getUniverseBlurb(u)}
                </p>

                <div className="mt-4 flex items-center justify-between">
                  <span className="text-sm font-semibold underline">
                    Open ‚Üí
                  </span>
                  <span className="text-xs opacity-60">
                    {m.hasPacket ? "Optionable" : "Explore"}
                  </span>
                </div>
              </div>
            </Link>
          );
        })}
      </div>
    </section>
  );
}

export default function Studios() {
  const [universes, setUniverses] = useState([]);
  const [metaById, setMetaById] = useState({});
  const [loading, setLoading] = useState(true);
  const [q, setQ] = useState("");

  useEffect(() => {
    (async () => {
      setLoading(true);

      const { data: u, error: uErr } = await supabase
        .from("universes")
        .select("*")
        .eq("status", "published")
        .order("updated_at", { ascending: false });

      if (uErr) console.error(uErr);

      const list = u || [];
      setUniverses(list);

      // Pull lightweight asset signals to power ‚ÄúNetflix rails‚Äù
      if (list.length) {
        const ids = list.map((x) => x.id);

        const { data: a, error: aErr } = await supabase
          .from("universe_assets")
          .select("id, universe_id, asset_type, division, thumbnail_url, file_url, external_url, is_public, price_cents, status, metadata")
          .in("universe_id", ids)
          .eq("status", "published");

        if (aErr) console.error(aErr);

        const by = {};
        (a || []).forEach((asset) => {
          const uid = asset.universe_id;
          if (!by[uid]) {
            by[uid] = {
              hasTrailer: false,
              hasPacket: false,
              visualCount: 0,
              heroThumb: null,
              visualThumb: null,
            };
          }

          const t = String(asset.asset_type || "").toLowerCase();
          const div = String(asset.division || "").toLowerCase();
          const mediaType =
            String(asset?.metadata?.media_type || "").toLowerCase() ||
            String(asset?.metadata?.type || "").toLowerCase();

          const isTrailer =
            t === "trailer" || mediaType === "trailer" || t === "video";

          const isVisual =
            ["image", "art", "still", "poster"].includes(t) ||
            div === "designs";

          if (isTrailer) by[uid].hasTrailer = true;

          if (isVisual) {
            by[uid].visualCount += 1;
            if (!by[uid].visualThumb && asset.thumbnail_url) {
              by[uid].visualThumb = asset.thumbnail_url;
            }
          }

          // Producer packet = studios division + gated + priced
          if (
            div === "studios" &&
            asset.is_public === false &&
            Number(asset.price_cents || 0) > 0
          ) {
            by[uid].hasPacket = true;
          }

          // a ‚Äúhero thumb‚Äù preference (any thumbnail helps)
          if (!by[uid].heroThumb && asset.thumbnail_url) {
            by[uid].heroThumb = asset.thumbnail_url;
          }
        });

        setMetaById(by);
      } else {
        setMetaById({});
      }

      setLoading(false);
    })();
  }, []);

  const featured = useMemo(() => {
    const list = universes || [];
    const flagged = list.find((u) => u.is_featured);
    return flagged || list[0] || null;
  }, [universes]);

  const filtered = useMemo(() => {
    const query = norm(q);
    if (!query) return universes;

    return (universes || []).filter((u) => {
      const blob = [u.title, u.slug, u.tagline, u.logline, u.synopsis]
        .map(norm)
        .join(" ");
      return blob.includes(query);
    });
  }, [universes, q]);

  const rails = useMemo(() => {
    const base = filtered || [];

    // Producer-ready
    const producerReady = base.filter((u) => metaById?.[u.id]?.hasPacket);

    // Trailer-first
    const withTrailers = base.filter((u) => metaById?.[u.id]?.hasTrailer);

    // New & updated (already sorted by updated_at from DB)
    const newUpdated = base.slice(0, 12);

    // Visual heavy
    const visualHeavy = [...base]
      .sort((a, b) => (metaById?.[b.id]?.visualCount || 0) - (metaById?.[a.id]?.visualCount || 0))
      .slice(0, 12);

    return {
      producerReady: producerReady.slice(0, 12),
      withTrailers: withTrailers.slice(0, 12),
      newUpdated,
      visualHeavy,
    };
  }, [filtered, metaById]);

  const carouselImages = useMemo(() => {
    return [
      "/images/video-carousel-1.webp",
      "/images/video-carousel-2.webp",
      "/images/video-carousel-3.webp",
    ];
  }, []);

  return (
    <>
      <Head>
        <title>Manyagi Studios ‚Äî The IP Vault</title>
        <meta
          name="description"
          content="Hollywood-ready universes: trailers, decks, world bibles, and monetizable assets ‚Äî curated per IP."
        />
      </Head>

      <Hero
        kicker="Manyagi Studios"
        title="The IP Vault"
        lead="Prestige worlds engineered for adaptation: trailers, decks, lore, and monetizable assets‚Äîorganized like a studio slate."
        carouselImages={carouselImages}
        height="h-[650px]"
      >
        <div className="flex flex-wrap gap-3 justify-center">
          <a
            href="#browse"
            className="btn bg-black text-white py-2 px-4 rounded hover:scale-105 transition dark:bg-white dark:text-black"
          >
            Browse Universes
          </a>
          <a
            href="mailto:studios@manyagi.net?subject=Studios%20%7C%20Options%20%2F%20Licensing%20Inquiry"
            className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
          >
            Licensing / Options
          </a>
        </div>
      </Hero>

      {/* MICRO-NAV (Disney+/Netflix style) */}
      <section className="container mx-auto px-4 -mt-8 mb-10" id="browse">
        <div className="flex gap-2 overflow-x-auto no-scrollbar justify-center text-xs md:text-[13px]">
          {[
            { href: "#featured", label: "Featured" },
            { href: "#producer-ready", label: "Producer Ready" },
            { href: "#trailers", label: "Trailers" },
            { href: "#new-updated", label: "New & Updated" },
            { href: "#visuals", label: "Visual Worlds" },
          ].map((item) => (
            <a
              key={item.href}
              href={item.href}
              className="whitespace-nowrap px-3 py-2 rounded-full border border-gray-200/80 bg-white/80 text-gray-800 hover:bg-gray-100 hover:border-amber-400 transition dark:bg-gray-900/80 dark:border-gray-700 dark:text-gray-100 dark:hover:bg-gray-800"
            >
              {item.label}
            </a>
          ))}
        </div>
      </section>

      <SectionIntro
        kicker="Studio Slate"
        title="Built to Be Optioned"
        lead="Each universe is structured like a studio packet: a hook, a visual identity, and an expandable roadmap (film, series, animation, games, merch)."
        tone="warm"
      />

      {/* SEARCH / STATUS BAR */}
      <section className="container mx-auto px-4 pb-10 -mt-4">
        <div className="rounded-3xl bg-white/80 dark:bg-gray-900/75 border border-amber-100/80 dark:border-gray-800 shadow-sm px-4 md:px-6 py-5">
          <div className="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
            <div>
              <div className="text-sm opacity-70">Browse Universes</div>
              <div className="text-2xl font-bold">Studios Library</div>
              <div className="text-xs opacity-70 mt-1">
                Showing <span className="font-semibold">{filtered.length}</span>{" "}
                of <span className="font-semibold">{universes.length}</span>
              </div>
            </div>

            <div className="flex gap-2 w-full md:w-[520px]">
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                placeholder="Search universes, themes, worlds‚Ä¶"
                className="w-full border border-gray-200 dark:border-gray-800 rounded-xl px-4 py-2 bg-white/80 dark:bg-gray-950/60"
              />
              {q ? (
                <button
                  onClick={() => setQ("")}
                  className="px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-800"
                  aria-label="Clear search"
                  title="Clear"
                >
                  ‚úï
                </button>
              ) : null}
            </div>
          </div>
        </div>
      </section>

      {loading ? (
        <section className="container mx-auto px-4 pb-16">
          <div className="opacity-70">Loading Studios‚Ä¶</div>
        </section>
      ) : universes.length === 0 ? (
        <section className="container mx-auto px-4 pb-16">
          <div className="rounded-3xl border border-gray-200 dark:border-gray-800 p-8 bg-white/70 dark:bg-gray-900/50">
            <div className="text-xl font-bold">No universes published yet</div>
            <p className="opacity-80 mt-2">
              Create one in Admin ‚Üí Universes, then set <code>status</code> to{" "}
              <code>published</code>.
            </p>
            <div className="mt-6">
              <Link
                href="/admin"
                className="px-5 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black inline-block"
              >
                Go to Admin ‚Üí
              </Link>
            </div>
          </div>
        </section>
      ) : (
        <>
          {/* FEATURED BANNER (big, cinematic) */}
          {featured ? (
            <section className="container mx-auto px-4 pb-10" id="featured">
              <div className="rounded-[28px] overflow-hidden border border-gray-200/80 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm">
                <div className="grid grid-cols-1 lg:grid-cols-2">
                  <div className="p-7 md:p-10">
                    <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">
                      Featured Universe
                    </div>
                    <h2 className="text-3xl md:text-4xl font-bold mt-2 leading-tight">
                      {featured.title}
                    </h2>
                    <p className="mt-3 opacity-80 max-w-xl">
                      {getUniverseBlurb(featured)}
                    </p>

                    <div className="mt-5 flex flex-wrap gap-2">
                      {metaById?.[featured.id]?.hasTrailer ? (
                        <span className="text-xs px-3 py-1 rounded-full bg-black text-white dark:bg-white dark:text-black">
                          ‚ñ∂ Trailer Available
                        </span>
                      ) : null}
                      {metaById?.[featured.id]?.hasPacket ? (
                        <span className="text-xs px-3 py-1 rounded-full bg-amber-200 text-amber-900">
                          üíº Producer Packet (Gated)
                        </span>
                      ) : null}
                      {(guessGenre(featured) || []).map((g) => (
                        <span
                          key={g}
                          className="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
                        >
                          {g}
                        </span>
                      ))}
                    </div>

                    <div className="mt-7 flex gap-3 flex-wrap">
                      <Link
                        href={`/studios/${featured.slug}`}
                        className="px-5 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black"
                      >
                        Enter Studio Page
                      </Link>

                      <a
                        href={`mailto:studios@manyagi.net?subject=${encodeURIComponent(
                          `Licensing / Options Inquiry ‚Äî ${featured.title}`
                        )}`}
                        className="px-5 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40"
                      >
                        Licensing / Options
                      </a>
                    </div>

                    <div className="text-xs opacity-60 mt-4">
                      Designed for pitch: hook + visuals + expansion potential.
                    </div>
                  </div>

                  <div className="relative min-h-[320px]">
                    <img
                      src={pickUniverseArt(featured, metaById)}
                      alt=""
                      className="absolute inset-0 w-full h-full object-cover"
                      loading="lazy"
                    />
                    <div className="absolute inset-0 bg-gradient-to-tr from-black/70 via-black/15 to-transparent" />
                  </div>
                </div>
              </div>
            </section>
          ) : null}

          {/* RAILS */}
          <div id="producer-ready" />
          <RailRow
            title="Producer Ready"
            subtitle="Gated packets + licensing energy"
            items={rails.producerReady}
            metaById={metaById}
            q={q}
          />

          <div id="trailers" />
          <RailRow
            title="Trailers & Hooks"
            subtitle="Fastest way to feel the world"
            items={rails.withTrailers}
            metaById={metaById}
            q={q}
          />

          <div id="new-updated" />
          <RailRow
            title="New & Updated"
            subtitle="Recently refined universes"
            items={rails.newUpdated}
            metaById={metaById}
            q={q}
          />

          <div id="visuals" />
          <RailRow
            title="Visual Worlds"
            subtitle="Image-heavy universes"
            items={rails.visualHeavy}
            metaById={metaById}
            q={q}
          />

          {/* FALLBACK GRID (classic browse) */}
          <section className="container mx-auto px-4 pb-16">
            <div className="mt-2 mb-5 text-sm opacity-70">
              Full Library
            </div>
            {filtered.length === 0 ? (
              <div className="rounded-2xl border border-gray-200 dark:border-gray-800 p-8 text-center bg-white/70 dark:bg-gray-900/50">
                <div className="text-lg font-bold">No matches</div>
                <div className="opacity-80 mt-2">Try a different search term.</div>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {filtered.map((u) => (
                  <Link
                    key={u.id}
                    href={`/studios/${u.slug}`}
                    className="group rounded-3xl border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm hover:shadow-md transition bg-white/70 dark:bg-gray-900/50"
                  >
                    <div className="relative h-48">
                      <img
                        src={pickUniverseArt(u, metaById)}
                        alt=""
                        className="absolute inset-0 w-full h-full object-cover group-hover:scale-[1.02] transition"
                        loading="lazy"
                      />
                      <div className="absolute inset-0 bg-gradient-to-tr from-black/55 to-transparent" />
                      <div className="absolute bottom-4 left-4 right-4">
                        <div className="text-[11px] tracking-[0.28em] uppercase text-white/80">
                          Universe
                        </div>
                        <div className="text-xl font-bold text-white">
                          {u.title}
                        </div>
                      </div>
                    </div>

                    <div className="p-5">
                      <p className="text-sm opacity-80 line-clamp-3">
                        {getUniverseBlurb(u)}
                      </p>

                      <div className="mt-4 flex items-center justify-between">
                        <div className="text-sm font-semibold underline">
                          Open ‚Üí
                        </div>
                        <div className="flex gap-2">
                          {metaById?.[u.id]?.hasTrailer ? (
                            <span className="text-[11px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800">
                              ‚ñ∂
                            </span>
                          ) : null}
                          {metaById?.[u.id]?.hasPacket ? (
                            <span className="text-[11px] px-2 py-1 rounded-full bg-amber-200 text-amber-900">
                              üíº
                            </span>
                          ) : null}
                        </div>
                      </div>
                    </div>
                  </Link>
                ))}
              </div>
            )}
          </section>
        </>
      )}
    </>
  );
}


===== FILE: pages/studios/[slug].js  (size=111298 bytes) =====
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import { useEffect, useMemo, useState } from "react";
import Hero from "@/components/Hero";
import Card from "@/components/Card";
import SectionIntro from "@/components/SectionIntro";
import { supabase } from "@/lib/supabase";
/* ------------------------------
   Publishing helpers (Books)
--------------------------------*/
const asList = (v) => (Array.isArray(v) ? v : Array.isArray(v?.items) ? v.items : []);
const pickProductImage = (p) =>
  p?.thumbnail_url ||
  p?.display_image ||
  p?.image_url ||
  p?.image ||
  "/placeholder.png";
/**
 * ‚úÖ Bulletproof Studio Offer detection
 * Studio offers MUST have metadata.offer_type = "studio_access"
 * (or metadata.kind = "studio_access" if you prefer that key)
 */
const isStudioOfferProduct = (p) => {
  const m = p?.metadata || {};
  const offerType = safeStr(m.offer_type || m.kind).toLowerCase();
  return offerType === "studio_access";
};
const isBookProduct = (p) => !isStudioOfferProduct(p);
function matchesUniverseForProduct(product, universe) {
  if (!product || !universe) return false;
  const m = product.metadata || {};
  const uid = safeStr(m.universe_id);
  if (uid && safeStr(universe.id) && uid === safeStr(universe.id)) return true;
  const title = safeStr(universe.title).toLowerCase();
  const slug = safeStr(universe.slug).toLowerCase();
  const fields = [
    safeStr(m.universe).toLowerCase(),
    safeStr(m.book).toLowerCase(),
    safeStr(m.series).toLowerCase(),
    safeStr(m.ip).toLowerCase(),
    safeStr(m.franchise).toLowerCase(),
  ].filter(Boolean);
  if (!fields.length) return false;
  // exact hits
  if (title && fields.includes(title)) return true;
  if (slug && fields.includes(slug)) return true;
  // soft contains
  const hay = fields.join(" ");
  if (title && hay.includes(title)) return true;
  if (slug && hay.includes(slug)) return true;
  return false;
}
/* ------------------------------
   Small helpers (safe string/json)
--------------------------------*/
const asStr = (v) => (v === null || v === undefined ? "" : String(v));
function safeStr(v) {
  return String(v ?? "").trim();
}
function safeJson(v, fallback = {}) {
  try {
    if (!v) return fallback;
    if (typeof v === "object") return v;
    const parsed = JSON.parse(String(v));
    return parsed && typeof parsed === "object" ? parsed : fallback;
  } catch {
    return fallback;
  }
}
function safeMeta(meta) {
  if (!meta) return {};
  if (typeof meta === "object") return meta;
  if (typeof meta === "string") {
    try {
      const parsed = JSON.parse(meta);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch {
      return {};
    }
  }
  return {};
}
/* ------------------------------
   Studio Offer helpers (Supabase products)
--------------------------------*/
const PRODUCTS_SELECT_SAFE =
  "id,name,description,status,price,image_url,thumbnail_url,metadata,updated_at";
const STUDIO_TIER_ORDER = ["public", "priority", "producer", "packaging"];
function normalizeStudioOfferRow(row) {
  const md = safeJson(row?.metadata, {});
  const tier = normalizeTier(md?.tier || md?.access_tier || md?.required_tier || "public");
  // bullet list comes from metadata.features or metadata.bullets (array) or description lines
  const bullets =
    (Array.isArray(md?.features) && md.features) ||
    (Array.isArray(md?.bullets) && md.bullets) ||
    (Array.isArray(md?.deliverables) && md.deliverables) ||
    [];
  const duration =
    safeStr(md?.duration_label) ||
    (md?.duration_days ? `${md.duration_days} days` : "") ||
    "";
  const image =
    row?.image_url ||
    row?.thumbnail_url ||
    md?.image_url ||
    md?.thumbnail_url ||
    "";
  // price display: prefer row.price (your db), fallback to metadata.price
  const price =
    row?.price ?? md?.price ?? null;
  return {
    id: row?.id,
    tier,
    name: row?.name || md?.title || "",
    description: row?.description || md?.description || "",
    bullets: Array.isArray(bullets) ? bullets.map((x) => safeStr(x)).filter(Boolean) : [],
    duration: safeStr(duration),
    image_url: image,
    price_value: price,
    updated_at: row?.updated_at || null,
    raw: row,
  };
}
// "Offer rows" only (avoid books + other products)
function isStudioOfferRow(row) {
  const md = safeJson(row?.metadata, {});
  const offerType = safeStr(md?.offer_type || md?.kind).toLowerCase();
  const tier = normalizeTier(md?.tier || md?.access_tier || md?.required_tier || "public");
  // ‚úÖ Strong filter
  if (offerType !== "studio_access") return false;
  // ‚úÖ Must be one of our tiers
  if (!STUDIO_TIER_ORDER.includes(tier)) return false;
  return true;
}
// overlap rule: ONE per tier (newest wins)
function dedupeOffersByTier(rows = []) {
  const byTier = new Map();
  for (const r of rows) {
    const t = normalizeTier(r?.tier);
    const prev = byTier.get(t);
    if (!prev) byTier.set(t, r);
    else {
      const a = new Date(prev.updated_at || 0).getTime();
      const b = new Date(r.updated_at || 0).getTime();
      if (b >= a) byTier.set(t, r);
    }
  }
  return STUDIO_TIER_ORDER.map((t) => byTier.get(t)).filter(Boolean);
}
async function loadStudioOffersForUniverseId(universeId) {
  if (!universeId) return [];
  // Try server-side JSON filter first
  try {
    const { data, error } = await supabase
      .from("products")
      .select(PRODUCTS_SELECT_SAFE)
      .eq("status", "active")
      .filter("metadata->>universe_id", "eq", String(universeId))
      .order("updated_at", { ascending: false })
      .limit(50);
    if (!error && data) {
      const offers = (data || [])
        .filter(isStudioOfferRow)
        .map(normalizeStudioOfferRow);
      return dedupeOffersByTier(offers);
    }
  } catch {
    // fall through
  }
  // Fallback: load & filter client-side
  const { data } = await supabase
    .from("products")
    .select(PRODUCTS_SELECT_SAFE)
    .eq("status", "active")
    .order("updated_at", { ascending: false })
    .limit(200);
  const offers = (data || [])
    .filter((row) => {
      const md = safeJson(row?.metadata, {});
      return (
        safeStr(md?.universe_id) === String(universeId)
      );
    })
    .filter(isStudioOfferRow)
    .map(normalizeStudioOfferRow);
  return dedupeOffersByTier(offers);
}
// nice display for numeric price
function formatUsd(price) {
  const n = Number(price);
  if (!Number.isFinite(n)) return "";
  return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(n);
}
/* ------------------------------
   URL + platform helpers
--------------------------------*/
function isDirectAudio(url) {
  const u = (url || "").toLowerCase().split("?")[0];
  return u.endsWith(".mp3") || u.endsWith(".wav") || u.endsWith(".m4a") || u.endsWith(".ogg");
}
function inferPlatform(url) {
  if (!url) return "";
  const u = url.toLowerCase();
  if (u.includes("youtube.com") || u.includes("youtu.be")) return "YouTube";
  if (u.includes("spotify.com")) return "Spotify";
  if (u.includes("soundcloud.com")) return "SoundCloud";
  if (u.includes("vimeo.com")) return "Vimeo";
  if (u.includes("tiktok.com")) return "TikTok";
  if (u.includes("instagram.com")) return "Instagram";
  if (u.includes("apple.com") || u.includes("music.apple.com")) return "Apple Music";
  if (u.includes("suno")) return "Suno";
  return "";
}
function isYoutube(url = "") {
  const u = String(url || "");
  return u.includes("youtube.com") || u.includes("youtu.be");
}
function getYoutubeId(url = "") {
  const u = String(url || "");
  const youtuBe = u.match(/youtu\.be\/([a-zA-Z0-9_-]+)/);
  if (youtuBe?.[1]) return youtuBe[1];
  const watch = u.match(/[?&]v=([a-zA-Z0-9_-]+)/);
  if (watch?.[1]) return watch[1];
  const embed = u.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/);
  if (embed?.[1]) return embed[1];
  return null;
}
function YoutubeEmbed({ url, title = "Video" }) {
  const id = getYoutubeId(url);
  if (!id) return null;
  return (
    <div className="rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 shadow-sm bg-black">
      <iframe
        className="w-full h-[420px]"
        src={`https://www.youtube.com/embed/${id}`}
        title={title}
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowFullScreen
      />
    </div>
  );
}
function SpotifyEmbed({ url, title = "Spotify" }) {
  if (!url || !String(url).includes("spotify.com")) return null;
  const embedUrl = String(url).replace("open.spotify.com/", "open.spotify.com/embed/");
  return (
    <div className="rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/30">
      <iframe
        src={embedUrl}
        width="100%"
        height="352"
        frameBorder="0"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        title={title}
      />
    </div>
  );
}
/* ------------------------------
   Media type helpers
--------------------------------*/
function normalizeType(t) {
  const v = (t || "").toLowerCase().trim();
  if (v === "music" || v === "track") return "soundtrack";
  if (v === "chapter preview" || v === "chapter") return "chapter_read";
  if (v === "opening_theme") return "soundtrack";
  if (v === "ending_theme") return "soundtrack";
  if (v === "character_theme") return "soundtrack";
  if (v === "battle_theme") return "score";
  return v || "other";
}
function prettyType(t) {
  const v = normalizeType(t);
  const map = {
    soundtrack: "Soundtracks",
    score: "Score",
    trailer: "Trailers",
    audiobook: "Audiobooks",
    chapter_read: "Chapter Reads",
    scene: "Scenes",
    playlist: "Playlists",
    musicvideo: "Music Videos",
    other: "Media",
  };
  return map[v] || "Media";
}
function primaryCta(item) {
  const t = normalizeType(item.media_type);
  if (t === "soundtrack" || t === "score" || t === "chapter_read" || t === "audiobook") return "Play";
  if (t === "trailer" || t === "musicvideo" || t === "reel") return "Watch";
  if (t === "playlist") return "Open Playlist";
  return "View";
}
function pickCardImage(post, meta) {
  return (
    meta?.thumbnail_url ||
    post?.thumbnail_url ||
    post?.featured_image ||
    meta?.cover_url ||
    meta?.image_url ||
    "/placeholder.png"
  );
}
function bestUrl(meta, post) {
  const audio = asStr(meta?.audio_url).trim();
  const media = asStr(meta?.media_url).trim();
  const audio2 = asStr(post?.audio_url).trim();
  const media2 = asStr(post?.media_url).trim();
  return {
    audio_url: audio || audio2 || "",
    media_url: media || media2 || "",
  };
}
function pickIp(meta) {
  return (
    asStr(meta?.book).trim() ||
    asStr(meta?.series).trim() ||
    asStr(meta?.universe).trim() ||
    asStr(meta?.ip).trim() ||
    asStr(meta?.franchise).trim() ||
    ""
  );
}
/* ------------------------------
   Asset helpers
--------------------------------*/
function getAssetUrl(a) {
  return (
    a?.file_url ||
    a?.external_url ||
    a?.audio_url ||
    a?.video_url ||
    a?.metadata?.media_url ||
    a?.metadata?.audio_url ||
    a?.metadata?.url ||
    ""
  );
}
function getThumb(a) {
  return (
    a?.thumbnail_url ||
    a?.metadata?.thumbnail_url ||
    a?.metadata?.cover_url ||
    a?.metadata?.image_url ||
    a?.metadata?.art_url ||
    ""
  );
}
function guessFileType(url = "") {
  const u = safeStr(url).toLowerCase();
  if (!u) return "";
  const q = u.split("?")[0];
  if (q.endsWith(".mp3")) return "mp3";
  if (q.endsWith(".wav")) return "wav";
  if (q.endsWith(".m4a")) return "m4a";
  if (q.endsWith(".ogg")) return "ogg";
  if (q.endsWith(".mp4")) return "mp4";
  if (q.endsWith(".webm")) return "webm";
  if (q.endsWith(".mov")) return "mov";
  if (q.endsWith(".pdf")) return "pdf";
  if (q.endsWith(".png") || q.endsWith(".jpg") || q.endsWith(".jpeg") || q.endsWith(".webp")) return "image";
  return "";
}
function guessAttachmentKind(url = "") {
  const u = safeStr(url).toLowerCase();
  if (!u) return "link";
  if (u.includes("youtube.com") || u.includes("youtu.be") || u.includes("vimeo.com")) return "video";
  if (u.includes("spotify.com") || u.includes("soundcloud.com") || isDirectAudio(u)) return "audio";
  const ft = guessFileType(u);
  if (ft === "image") return "image";
  if (ft === "pdf") return "document";
  if (["mp4", "webm", "mov"].includes(ft)) return "video";
  if (["mp3", "wav", "m4a", "ogg"].includes(ft)) return "audio";
  return "link";
}
/* ------------------------------
   Attachments (studio pages)
--------------------------------*/
function normalizeTags(input) {
  if (Array.isArray(input)) return input.map((t) => safeStr(t)).filter(Boolean);
  const s = safeStr(input);
  if (!s) return [];
  return s
    .split(",")
    .map((x) => safeStr(x))
    .filter(Boolean);
}
function normalizeAttachment(a) {
  const base = a && typeof a === "object" ? a : {};
  const url = safeStr(base.url || base.file_url || base.external_url);
  const thumb = safeStr(base.thumbnail_url || base.thumb_url || base.cover_url || base.image_url);
  const kind = safeStr(base.kind) || guessAttachmentKind(url || thumb);
  const media_type = safeStr(base.media_type) || "other";
  const title = safeStr(base.title);
  const notes = safeStr(base.notes);
  const duration = safeStr(base.duration);
  const bpm = base.bpm === null || base.bpm === undefined || base.bpm === "" ? null : Number(base.bpm);
  const license_tier = safeStr(base.license_tier);
  const tags = normalizeTags(base.tags || []);
  return {
    id: safeStr(base.id) || `att_${Math.random().toString(16).slice(2)}_${Date.now()}`,
    kind,
    media_type,
    title,
    url,
    thumbnail_url: thumb,
    tags,
    duration,
    bpm: Number.isFinite(bpm) ? bpm : null,
    license_tier,
    notes,
  };
}
function getPageAttachments(page) {
  const md = safeJson(page?.metadata, {});
  const arr = Array.isArray(md?.attachments) ? md.attachments : [];
  return arr.map(normalizeAttachment).filter((x) => x && (x.url || x.thumbnail_url));
}
function niceAttachmentTypeLabel(media_type = "") {
  const t = safeStr(media_type).toLowerCase();
  const m = {
    poster: "Poster / Key Art",
    lookbook: "Lookbook",
    trailer: "Trailer",
    theme: "Theme",
    cue: "Cue",
    stinger: "Stinger",
    packet: "Packet",
    other: "Attachment",
  };
  return m[t] || "Attachment";
}
function renderPlainMarkdown(md = "") {
  const text = String(md || "");
  const lines = text.split("\n");
  return (
    <div className="space-y-2">
      {lines.map((line, i) => {
        const m = line.match(/^(#{1,3})\s+(.*)$/);
        if (m) {
          const level = m[1].length;
          const title = m[2];
          const cls =
            level === 1
              ? "text-2xl font-bold mt-6"
              : level === 2
              ? "text-xl font-bold mt-5"
              : "text-lg font-semibold mt-4";
          return (
            <div key={i} className={cls}>
              {title}
            </div>
          );
        }
        return (
          <p key={i} className="whitespace-pre-wrap leading-relaxed opacity-90">
            {line}
          </p>
        );
      })}
    </div>
  );
}
/* ------------------------------
   UI cards
--------------------------------*/
function chip(text) {
  return (
    <span className="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
      {text}
    </span>
  );
}
function HeaderCard({ kicker, title, subtitle, rightChips = [], align = "left", className = "", children }) {
  const center = align === "center";
  return (
    <div
      className={[
        "rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/60 shadow-sm p-6 md:p-8",
        className,
      ].join(" ")}
    >
      <div className={`flex flex-wrap gap-3 items-start ${center ? "justify-center text-center" : "justify-between"}`}>
        <div className={center ? "w-full" : ""}>
          {kicker ? <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">{kicker}</div> : null}
          {title ? <div className="text-xl md:text-2xl font-bold mt-1">{title}</div> : null}
          {subtitle ? <div className="text-sm opacity-80 mt-2">{subtitle}</div> : null}
        </div>
        {rightChips?.length ? (
          <div className={`flex flex-wrap gap-2 ${center ? "justify-center w-full" : "justify-end"}`}>
            {rightChips.map((c) => (
              <span key={c} className="text-[11px] px-3 py-1 rounded-full bg-white/80 text-gray-800 border border-gray-200/70 dark:bg-gray-900/60 dark:text-gray-100 dark:border-gray-700">
                {c}
              </span>
            ))}
          </div>
        ) : null}
      </div>
      {children ? <div className="mt-5">{children}</div> : null}
    </div>
  );
}
function AudioCard({ a }) {
  const url = a?.audio_url || a?.media_url || getAssetUrl(a);
  const thumb = a?.card_img || getThumb(a);
  const title = a?.title || "Audio";
  const desc = a?.excerpt || a?.description || "";
  const kind = safeStr(a?.media_type || a?.metadata?.media_type || a?.metadata?.audio_kind || a?.asset_type || "audio");
  const fileType = guessFileType(url);
  const isSpotify = url.includes("spotify.com");
  const isYT = isYoutube(url);
  return (
    <div className="rounded-3xl overflow-hidden border border-gray-200/80 dark:border-gray-800 bg-white/85 dark:bg-gray-900/60 shadow-sm">
      {thumb ? (
        <img src={thumb} alt={title} className="w-full h-48 object-cover" loading="lazy" />
      ) : (
        <div className="w-full h-48 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800" />
      )}
      <div className="p-5">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">
              {prettyType(kind)}
              {fileType ? ` ‚Ä¢ ${fileType.toUpperCase()}` : ""}
              {a?.platform ? ` ‚Ä¢ ${a.platform}` : ""}
            </div>
            <div className="text-lg font-semibold mt-1">{title}</div>
            {desc ? <div className="text-sm opacity-80 mt-2 whitespace-pre-wrap">{desc}</div> : null}
          </div>
          <div className="flex flex-col gap-2 items-end">
            {a?.duration ? chip(`${a.duration}`) : null}
            {a?.mood ? chip(`${a.mood}`) : null}
          </div>
        </div>
        <div className="mt-4">
          {isSpotify ? (
            <SpotifyEmbed url={url} title={title} />
          ) : isYT ? (
            <YoutubeEmbed url={url} title={title} />
          ) : url ? (
            <div className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/30 p-4">
              <audio controls preload="none" className="w-full">
                <source src={url} />
              </audio>
              <div className="mt-3 flex flex-wrap gap-2">
                <a
                  href={url}
                  target="_blank"
                  rel="noreferrer"
                  className="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold"
                >
                  Open {primaryCta({ media_type: kind })} ‚Üí
                </a>
                {a?.download_url ? (
                  <a
                    href={a.download_url}
                    target="_blank"
                    rel="noreferrer"
                    className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40 text-sm"
                  >
                    Download ‚Üí
                  </a>
                ) : null}
                {a?.license_url ? (
                  <a
                    href={a.license_url}
                    target="_blank"
                    rel="noreferrer"
                    className="px-4 py-2 rounded-xl border border-amber-300 bg-amber-50 text-amber-950 dark:bg-amber-950/20 dark:text-amber-100 text-sm"
                  >
                    Rights / License ‚Üí
                  </a>
                ) : null}
                {a?.slug ? (
                  <Link
                    href={`/media/${a.slug}`}
                    className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40 text-sm"
                  >
                    Details ‚Üí
                  </Link>
                ) : null}
              </div>
            </div>
          ) : (
            <div className="text-sm opacity-70">No audio URL found on this item.</div>
          )}
        </div>
        {Array.isArray(a?.tags) && a.tags.length ? (
          <div className="mt-4 flex flex-wrap gap-2">
            {a.tags.slice(0, 8).map((t) => (
              <span
                key={t}
                className="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
              >
                {String(t)}
              </span>
            ))}
          </div>
        ) : null}
      </div>
    </div>
  );
}
function AttachmentCard({ att }) {
  const url = safeStr(att?.url);
  const thumb = safeStr(att?.thumbnail_url);
  const title = safeStr(att?.title) || "Attachment";
  const kind = safeStr(att?.kind || "link");
  const mediaTypeLabel = niceAttachmentTypeLabel(att?.media_type);
  const platform = inferPlatform(url);
  const ft = guessFileType(url);
  const isSpotify = url.includes("spotify.com");
  const isYT = isYoutube(url);
  const isPdf = ft === "pdf";
  const isImage = kind === "image" || ft === "image";
  const isVideo = kind === "video" || ["mp4", "webm", "mov"].includes(ft) || isYT;
  const isAudio = kind === "audio" || ["mp3", "wav", "m4a", "ogg"].includes(ft) || isSpotify || url.includes("soundcloud.com");
  return (
    <div className="rounded-3xl overflow-hidden border border-gray-200/80 dark:border-gray-800 bg-white/85 dark:bg-gray-900/60 shadow-sm">
      {isImage && (thumb || url) ? (
        <img src={thumb || url} alt={title} className="w-full h-52 object-cover" loading="lazy" />
      ) : thumb ? (
        <img src={thumb} alt={title} className="w-full h-52 object-cover" loading="lazy" />
      ) : (
        <div className="w-full h-52 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800" />
      )}
      <div className="p-5">
        <div className="flex items-start justify-between gap-3">
          <div className="min-w-0">
            <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">
              {mediaTypeLabel}
              {kind ? ` ‚Ä¢ ${kind}` : ""}
              {platform ? ` ‚Ä¢ ${platform}` : ""}
              {ft && ft !== "image" ? ` ‚Ä¢ ${ft.toUpperCase()}` : ""}
            </div>
            <div className="text-lg font-semibold mt-1 truncate">{title}</div>
          </div>
        </div>
        <div className="mt-4">
          {isSpotify ? (
            <SpotifyEmbed url={url} title={title} />
          ) : isYT ? (
            <YoutubeEmbed url={url} title={title} />
          ) : isAudio && url ? (
            <div className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/30 p-4">
              <audio controls preload="none" className="w-full">
                <source src={url} />
              </audio>
            </div>
          ) : isVideo && url ? (
            <div className="rounded-2xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-black">
              <video src={url} controls playsInline className="w-full h-[360px] object-cover bg-black" />
            </div>
          ) : isPdf && url ? (
            <div className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/30 p-4">
              <div className="text-sm opacity-80">PDF ready. Open inline (new tab) or download from the source.</div>
            </div>
          ) : null}
        </div>
        {Array.isArray(att?.tags) && att.tags.length ? (
          <div className="mt-4 flex flex-wrap gap-2">
            {att.tags.slice(0, 8).map((t) => (
              <span
                key={t}
                className="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
              >
                {String(t)}
              </span>
            ))}
          </div>
        ) : null}
        <div className="mt-4 flex flex-wrap gap-2">
          {url ? (
            <a
              href={url}
              target="_blank"
              rel="noreferrer"
              className="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold"
            >
              Open ‚Üí
            </a>
          ) : null}
          {thumb ? (
            <a
              href={thumb}
              target="_blank"
              rel="noreferrer"
              className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40 text-sm"
            >
              Thumb ‚Üí
            </a>
          ) : null}
          {isPdf && url ? (
            <a
              href={url}
              target="_blank"
              rel="noreferrer"
              className="px-4 py-2 rounded-xl border border-amber-300 bg-amber-50 text-amber-950 dark:bg-amber-950/20 dark:text-amber-100 text-sm font-semibold"
            >
              Open PDF ‚Üí
            </a>
          ) : null}
        </div>
      </div>
    </div>
  );
}
function PageAttachmentsRail({ page }) {
  const attachments = useMemo(() => getPageAttachments(page), [page]);
  if (!attachments.length) return null;
  const counts = attachments.reduce(
    (acc, a) => {
      const k = safeStr(a.kind || "link");
      acc[k] = (acc[k] || 0) + 1;
      return acc;
    },
    { image: 0, video: 0, audio: 0, document: 0, link: 0 }
  );
  return (
    <div className="mt-8">
      <HeaderCard
        kicker="Attachments"
        title="Media Rail"
        subtitle="Optional assets attached to this page."
        rightChips={[
          `${attachments.length} total`,
          counts.image ? `i${counts.image}` : null,
          counts.video ? `v${counts.video}` : null,
          counts.audio ? `a${counts.audio}` : null,
          counts.document ? `d${counts.document}` : null,
        ].filter(Boolean)}
        align="left"
        className="mb-5"
      />
      {attachments.length === 1 ? (
        <div className="flex justify-center">
          <div className="w-full max-w-3xl">
            <AttachmentCard att={attachments[0]} />
          </div>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
          {attachments.map((att) => (
            <AttachmentCard key={att.id} att={att} />
          ))}
        </div>
      )}
    </div>
  );
}
/* ------------------------------
   ACCESS / TIERS (FIXED)
   ‚úÖ This is what caused: ReferenceError: tierLabel is not defined
--------------------------------*/
const ACCESS_TIERS = ["public", "priority", "producer", "packaging"];
function normalizeTier(t) {
  const v = safeStr(t).toLowerCase();
  if (ACCESS_TIERS.includes(v)) return v;
  return "public";
}
function normalizeTierOrNull(t) {
  const v = safeStr(t).toLowerCase();
  return ACCESS_TIERS.includes(v) ? v : null;
}
const TIER_RANK = { public: 0, priority: 1, producer: 2, packaging: 3 };
function canViewTier(viewerTier, pageTier) {
  const vt = TIER_RANK[normalizeTier(viewerTier)] ?? 0;
  const pt = TIER_RANK[normalizeTier(pageTier)] ?? 0;
  return vt >= pt;
}
function tierLabel(t) {
  const v = normalizeTier(t);
  const map = {
    public: "Public",
    priority: "Priority",
    producer: "Producer",
    packaging: "Packaging",
  };
  return map[v] || "Public";
}
/* ------------------------------
   Page tier logic
--------------------------------*/
const PAGE_TYPE_DEFAULT_TIER = {
  logline: "public",
  pitch_1p: "public",
  synopsis_1page: "public",
  comparable_titles: "public",
  format_rating_audience: "public",
  one_sheet: "public",
  beat_sheet: "priority",
  season1_outline: "priority",
  episode_list: "priority",
  pilot_outline: "priority",
  signature_scene_clip: "priority",
  teaser_trailer: "priority",
  themes_main_hero_villain: "priority",
  trailer_cue_stingers: "priority",
  series_bible: "producer",
  world_rules_factions: "producer",
  timeline: "producer",
  glossary: "producer",
  cast_profiles_arcs: "producer",
  lookbook_pdf: "producer",
  poster_key_art: "producer",
  trailer_storyboard: "producer",
  franchise_roadmap: "producer",
  pilot_script_or_treatment: "producer",
  chain_of_title_rights_matrix: "packaging",
  option_term_sheet_producer_packet: "packaging",
  negotiation: "packaging",
};
function getPageVisibility(p) {
  const md = safeJson(p?.metadata, {});
  const v = String(md?.visibility || "public").toLowerCase();
  return v === "vault" ? "vault" : "public";
}
function getPageAccessTier(p) {
  const md = safeJson(p?.metadata, {});
  const explicit = normalizeTier(md?.access_tier);
  if (md?.access_tier) return explicit;
  if (getPageVisibility(p) === "vault") return "packaging";
  const t = safeStr(p?.page_type);
  return normalizeTier(PAGE_TYPE_DEFAULT_TIER[t] || "public");
}
function tierBadge(t) {
  const v = normalizeTier(t);
  const map = {
    public:
      "text-[10px] px-2 py-0.5 rounded-full border border-emerald-300 bg-emerald-50 text-emerald-800 dark:bg-emerald-950/20 dark:text-emerald-100 dark:border-emerald-900/40",
    priority:
      "text-[10px] px-2 py-0.5 rounded-full border border-amber-300 bg-amber-50 text-amber-950 dark:bg-amber-950/20 dark:text-amber-100 dark:border-amber-900/40",
    producer:
      "text-[10px] px-2 py-0.5 rounded-full border border-sky-300 bg-sky-50 text-sky-900 dark:bg-sky-950/20 dark:text-sky-100 dark:border-sky-900/40",
    packaging:
      "text-[10px] px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700",
  };
  return map[v] || map.public;
}
function niceTypeLabel(t = "") {
  const m = {
    pitch_1p: "Pitch (1 Page)",
    synopsis_1page: "Synopsis (1 Page)",
    comparable_titles: "Comparable Titles",
    format_rating_audience: "Format / Rating / Audience",
    season1_outline: "Season 1 Outline",
    episode_list: "Episode List",
    pilot_outline: "Pilot Outline",
    pilot_script_or_treatment: "Pilot Script / Treatment",
    world_rules_factions: "World Rules + Factions",
    cast_profiles_arcs: "Cast Profiles + Arcs",
    lookbook_pdf: "Lookbook",
    poster_key_art: "Poster / Key Art",
    trailer_storyboard: "Trailer Storyboard",
    teaser_trailer: "Teaser Trailer",
    signature_scene_clip: "Signature Scene Clip",
    themes_main_hero_villain: "Themes (Main / Hero / Villain)",
    trailer_cue_stingers: "Trailer Cues + Stingers",
    chain_of_title_rights_matrix: "Chain of Title + Rights Matrix",
    option_term_sheet_producer_packet: "Option Term Sheet + Producer Packet",
  };
  return m[t] || String(t).replaceAll("_", " ").replace(/\b\w/g, (c) => c.toUpperCase());
}
/* ------------------------------
   Access gating UI
--------------------------------*/
function AccessGateCard({ viewerTier, requiredTier, title, subtitle, universe, onCheckout, children }) {
  const allowed = canViewTier(viewerTier, requiredTier);
  if (allowed) return children || null;
  return (
    <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/75 dark:bg-gray-900/55 shadow-sm p-6 md:p-8">
      <div className="flex items-start justify-between gap-3 flex-wrap">
        <div>
          <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Access required</div>
          <div className="text-2xl font-bold mt-2">{title}</div>
          <div className="text-sm opacity-80 mt-2">{subtitle}</div>
          <div className="mt-3 flex flex-wrap gap-2">
            <span className={tierBadge(requiredTier)}>{tierLabel(requiredTier)}</span>
            <span className={tierBadge(viewerTier)}>Viewing: {tierLabel(viewerTier)}</span>
          </div>
        </div>
        <div className="flex flex-col gap-2 min-w-[240px]">
          <button
            onClick={() => (typeof onCheckout === "function" ? onCheckout(requiredTier) : null)}
            className="px-5 py-3 rounded-2xl bg-black text-white dark:bg-white dark:text-black font-semibold text-center"
          >
            Unlock {tierLabel(requiredTier)} ‚Üí
          </button>
        </div>
      </div>
    </div>
  );
}
function PackagesBar({ universe, viewerTier, uiTier, showVault, onCheckout, offers = [], offersLoading = false, entitlement, onDownloadPacket }) {
  const fallbackTiers = [
    {
      key: "priority",
      title: "Priority Window",
      price: "$2,500",
      duration: "45 days",
      bullets: ["Serious evaluation", "Beats + season map", "Full trailer + themes"],
    },
    {
      key: "producer",
      title: "Producer Packet",
      price: "$10,000",
      duration: "90 days",
      bullets: ["Bible + world rules", "Lookbook + deck copy", "Shareable packet PDFs"],
    },
    {
      key: "packaging",
      title: "Packaging Track",
      price: "$35,000",
      duration: "12 months",
      bullets: ["Deal room access", "Rights matrix", "Option docs"],
    },
  ];
  // Convert DB offers to same shape as fallback
  const dbTiers = (offers || []).map((o) => ({
    key: o.tier,
    title: o.name || tierLabel(o.tier),
    price: formatUsd(o.price_value) || "",
    duration: o.duration || "",
    bullets: (o.bullets && o.bullets.length ? o.bullets : [])
      .slice(0, 6),
    image_url: o.image_url || "",
    description: o.description || "",
  }));
  // Merge rule: DB overrides fallback by tier
  const byTier = new Map();
  fallbackTiers.forEach((t) => byTier.set(t.key, t));
  dbTiers.forEach((t) => byTier.set(t.key, t));
  const tiers = ["priority", "producer", "packaging"]
    .map((k) => byTier.get(k))
    .filter(Boolean);
  const goTier = (tierKey) => {
    const href = universe?.slug
      ? `/studios/${universe.slug}?tier=${tierKey}${showVault ? "&vault=1" : ""}#package`
      : "#";
    // preview-only
    window.history.pushState({}, "", href);
    // optionally scroll
    document.getElementById("package")?.scrollIntoView({ behavior: "smooth" });
  };
  return (
    <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/60 shadow-sm p-6 md:p-8">
      <div className="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Packages</div>
          <div className="text-2xl font-bold mt-2">Choose access level</div>
          <div className="text-sm opacity-80 mt-2">Organize your studio pages into sellable tiers.
            {offersLoading ? " (Loading offers‚Ä¶)" : ""}
          </div>
          <div className="mt-3 flex flex-wrap gap-2">
            <span className={tierBadge(viewerTier)}>Viewing: {tierLabel(viewerTier)}</span>
          </div>
        </div>
        {/* tier buttons stay the same */}
        <div className="flex gap-2 flex-wrap justify-end">
          <button
            onClick={() => goTier('public')}
            className={`px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40 text-sm font-semibold ${normalizeTier(uiTier) === 'public' ? 'bg-amber-50/70 dark:bg-amber-950/10 border-amber-400/70' : ''}`}
          >
            Public
          </button>
          <button
            onClick={() => goTier('priority')}
            className={`px-4 py-2 rounded-xl border border-amber-300 bg-amber-50 text-amber-950 dark:bg-amber-950/20 dark:text-amber-100 text-sm font-semibold ${normalizeTier(uiTier) === 'priority' ? 'bg-amber-50/70 dark:bg-amber-950/10 border-amber-400/70' : ''}`}
          >
            Priority
          </button>
          <button
            onClick={() => goTier('producer')}
            className={`px-4 py-2 rounded-xl border border-sky-300 bg-sky-50 text-sky-900 dark:bg-sky-950/20 dark:text-sky-100 text-sm font-semibold ${normalizeTier(uiTier) === 'producer' ? 'bg-amber-50/70 dark:bg-amber-950/10 border-amber-400/70' : ''}`}
          >
            Producer
          </button>
          <button
            onClick={() => goTier('packaging')}
            className={`px-4 py-2 rounded-xl border border-slate-300 bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-gray-100 text-sm font-semibold ${normalizeTier(uiTier) === 'packaging' ? 'bg-amber-50/70 dark:bg-amber-950/10 border-amber-400/70' : ''}`}
          >
            Packaging
          </button>
        </div>
      </div>
      <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        {tiers.map((t) => {
          const active = normalizeTier(uiTier) === t.key;
          const unlocked = canViewTier(viewerTier, t.key);
          let daysLeft = null;
          if (unlocked && entitlement && entitlement.expires_at) {
            const expiresDate = new Date(entitlement.expires_at);
            const now = new Date();
            daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
          }
          return (
            <div
              key={t.key}
              className={[
                "rounded-3xl border shadow-sm p-5",
                active
                  ? "border-amber-400/70 bg-amber-50/70 dark:bg-amber-950/10"
                  : "border-gray-200 dark:border-gray-800 bg-white/60 dark:bg-gray-950/20",
              ].join(" ")}
            >
              {/* OPTIONAL: show offer image if you uploaded one in admin */}
              {t.image_url ? (
                <div className="mb-4 rounded-2xl overflow-hidden border border-gray-200 dark:border-gray-800">
                  <img src={t.image_url} alt={t.title} className="w-full h-32 object-cover" loading="lazy" />
                </div>
              ) : null}
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">{t.duration || tierLabel(t.key)}</div>
                  <div className="text-lg font-bold mt-1">{t.title}</div>
                </div>
                <div className="text-sm font-semibold">{t.price}</div>
              </div>
              {/* OPTIONAL: show description from admin */}
              {t.description ? <div className="text-sm opacity-80 mt-2 line-clamp-3">{t.description}</div> : null}
              <ul className="mt-3 space-y-2 text-sm opacity-90">
                {(t.bullets || []).slice(0, 6).map((b) => (
                  <li key={b} className="flex gap-2">
                    <span className="mt-[2px]">‚Ä¢</span>
                    <span>{b}</span>
                  </li>
                ))}
              </ul>
              <div className="mt-4 flex gap-2">
                {unlocked ? (
                  <div className="flex flex-col gap-2 flex-1">
                    <div className="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold text-center">
                      Unlocked ‚úì
                    </div>
                    <button
                      onClick={() => (typeof onDownloadPacket === "function" ? onDownloadPacket(t.key) : null)}
                      className="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold"
                    >
                      Download {tierLabel(t.key)} Packet ‚Üí
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => (typeof onCheckout === "function" ? onCheckout(t.key) : null)}
                    className="flex-1 px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold text-center"
                  >
                    Unlock ‚Üí
                  </button>
                )}
                <button
                  onClick={() => goTier(t.key)}
                  className="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40 text-sm font-semibold"
                >
                  Preview
                </button>
              </div>
              {unlocked && daysLeft !== null && daysLeft > 0 ? (
                <div className="text-xs opacity-70 text-center mt-1">{daysLeft} days remaining</div>
              ) : null}
            </div>
          );
        })}
      </div>
    </div>
  );
}
/* ------------------------------
   Package grouping
--------------------------------*/
const REQUIRED_25_PAGE_TYPES = [
  "logline",
  "pitch_1p",
  "synopsis_1page",
  "comparable_titles",
  "format_rating_audience",
  "beat_sheet",
  "season1_outline",
  "episode_list",
  "pilot_outline",
  "pilot_script_or_treatment",
  "franchise_roadmap",
  "series_bible",
  "world_rules_factions",
  "timeline",
  "glossary",
  "cast_profiles_arcs",
  "lookbook_pdf",
  "poster_key_art",
  "trailer_storyboard",
  "teaser_trailer",
  "signature_scene_clip",
  "themes_main_hero_villain",
  "trailer_cue_stingers",
  "chain_of_title_rights_matrix",
  "option_term_sheet_producer_packet",
];
const EXEC_GROUPS = [
  {
    key: "executive",
    title: "Executive Read",
    kicker: "Studio Package",
    lead: "Fast producer scan ‚Äî positioning, format, comps, and the clean pitch.",
    chips: ["Fast scan", "Optionable structure", "Shareable sections"],
    types: new Set(["logline", "pitch_1p", "synopsis_1page", "comparable_titles", "format_rating_audience", "one_sheet"]),
  },
  {
    key: "story",
    title: "Story Proof",
    kicker: "Story",
    lead: "Season structure, beats, pilot direction ‚Äî enough to greenlight a conversation.",
    chips: ["Beats + arcs", "Pilot-ready", "Season map"],
    types: new Set(["beat_sheet", "season1_outline", "episode_list", "pilot_outline", "pilot_script_or_treatment", "series_bible"]),
  },
  {
    key: "world",
    title: "World & Cast",
    kicker: "Lore",
    lead: "Rules, factions, timeline, glossary, and cast arcs ‚Äî continuity that scales.",
    chips: ["Rules", "Factions", "Continuity"],
    types: new Set(["world_rules_factions", "timeline", "glossary", "cast_profiles_arcs"]),
  },
  {
    key: "visual",
    title: "Visual & Marketing",
    kicker: "Look",
    lead: "Lookbook, poster, trailer storyboard, teasers, signature scene assets.",
    chips: ["Lookbook", "Poster", "Trailer kit"],
    types: new Set(["lookbook_pdf", "poster_key_art", "trailer_storyboard", "teaser_trailer", "signature_scene_clip"]),
  },
  {
    key: "audio",
    title: "Themes & Trailer Sound",
    kicker: "Sound",
    lead: "Motifs and cues that lock tone immediately.",
    chips: ["Motif-driven", "Trailer-ready", "Tone lock"],
    types: new Set(["themes_main_hero_villain", "trailer_cue_stingers"]),
  },
  {
    key: "vault",
    title: "Deal Room",
    kicker: "Vault",
    lead: "Rights + deal docs. Hidden by default ‚Äî use ?vault=1.",
    chips: ["Rights", "Deal docs", "Partner-ready"],
    types: new Set(["chain_of_title_rights_matrix", "option_term_sheet_producer_packet", "negotiation", "press_kit", "roadmap", "prompts", "deck_copy"]),
  },
];
function packageProgress(pages = []) {
  const present = new Set(pages.map((p) => safeStr(p.page_type)).filter(Boolean));
  const have = REQUIRED_25_PAGE_TYPES.filter((t) => present.has(t));
  return { count: have.length, total: REQUIRED_25_PAGE_TYPES.length };
}
function groupStudioPages(pages = [], showVault = false, viewerTier = "public") {
  const visible = pages.filter((p) => {
    const vis = getPageVisibility(p);
    if (vis === "vault" && !showVault) return false;
    const pageTier = getPageAccessTier(p);
    if (!canViewTier(viewerTier, pageTier)) return false;
    return true;
  });
  const buckets = EXEC_GROUPS.map((g) => ({ ...g, pages: [] }));
  const used = new Set();
  visible.forEach((p) => {
    const t = safeStr(p.page_type);
    const g = buckets.find((x) => x.types.has(t));
    if (g) {
      g.pages.push(p);
      used.add(p.id);
    }
  });
  const appendix = visible.filter((p) => !used.has(p.id));
  if (appendix.length) {
    buckets.splice(1, 0, {
      key: "appendix",
      title: "Appendix",
      kicker: "Extras",
      lead: "Additional published materials (notes, extras, variants).",
      chips: ["Extra pages", "Deep dives", "Variants"],
      types: new Set(),
      pages: appendix,
    });
  }
  buckets.forEach((b) => {
    b.pages.sort((a, c) => {
      const ao = Number(a.sort_order ?? 9999);
      const co = Number(c.sort_order ?? 9999);
      if (ao !== co) return ao - co;
      const ad = new Date(a.updated_at || 0).getTime();
      const cd = new Date(c.updated_at || 0).getTime();
      return cd - ad;
    });
  });
  return buckets.filter((b) => b.pages.length > 0);
}
function LockedSectionsPreview({ universe, pages = [], viewerTier = "public", showVault = false, onCheckout }) {
  const locked = useMemo(() => {
    const lockedByTier = [];
    const lockedByVault = [];
    (pages || []).forEach((p) => {
      const status = safeStr(p?.status).toLowerCase();
      if (status && status !== "published") return;
      const vis = getPageVisibility(p);
      const requiredTier = getPageAccessTier(p);
      if (vis === "vault" && !showVault) {
        lockedByVault.push({ p, requiredTier, vis });
        return;
      }
      if (!canViewTier(viewerTier, requiredTier)) {
        lockedByTier.push({ p, requiredTier, vis });
        return;
      }
    });
    const sortFn = (a, b) => {
      const ar = TIER_RANK[normalizeTier(a.requiredTier)] ?? 0;
      const br = TIER_RANK[normalizeTier(b.requiredTier)] ?? 0;
      if (br !== ar) return br - ar;
      const ao = Number(a.p?.sort_order ?? 9999);
      const bo = Number(b.p?.sort_order ?? 9999);
      if (ao !== bo) return ao - bo;
      const ad = new Date(a.p?.updated_at || 0).getTime();
      const bd = new Date(b.p?.updated_at || 0).getTime();
      return bd - ad;
    };
    lockedByTier.sort(sortFn);
    lockedByVault.sort(sortFn);
    return { lockedByTier, lockedByVault };
  }, [pages, viewerTier, showVault]);
  const totalLocked = (locked.lockedByTier?.length || 0) + (locked.lockedByVault?.length || 0);
  if (!totalLocked) return null;
  return (
    <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/60 shadow-sm p-6 md:p-8 mb-6">
      <div className="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Locked sections preview</div>
          <div className="text-2xl font-bold mt-2">What you unlock</div>
          <div className="text-sm opacity-80 mt-2">Titles only ‚Äî content stays locked until purchase / access tier is granted.</div>
          <div className="mt-3 flex flex-wrap gap-2">
            <span className={tierBadge(viewerTier)}>Viewing: {tierLabel(viewerTier)}</span>
            {locked.lockedByTier.length ? chip(`${locked.lockedByTier.length} tier-locked`) : null}
            {locked.lockedByVault.length ? chip(`${locked.lockedByVault.length} vault-hidden`) : null}
          </div>
        </div>
        <div className="min-w-[240px]">
          <div className="rounded-2xl bg-black text-white dark:bg-white dark:text-black p-4">
            <div className="text-sm font-semibold">Unlock access</div>
            <div className="text-xs opacity-80 mt-1">Upgrade tier above to preview locked sections.</div>
            <div className="mt-3 flex flex-wrap gap-2">
              <button
                onClick={() => {
                  document.getElementById("package")?.scrollIntoView({ behavior: "smooth" });
                  if (typeof onCheckout === "function") onCheckout("priority");
                }}
                className="px-3 py-2 rounded-xl bg-white/10 dark:bg-black/10 border border-white/20 dark:border-black/20 text-xs font-semibold"
              >
                Priority ‚Üí
              </button>
              <button
                onClick={() => {
                  document.getElementById("package")?.scrollIntoView({ behavior: "smooth" });
                  if (typeof onCheckout === "function") onCheckout("producer");
                }}
                className="px-3 py-2 rounded-xl bg-white/10 dark:bg-black/10 border border-white/20 dark:border-black/20 text-xs font-semibold"
              >
                Producer ‚Üí
              </button>
              <button
                onClick={() => {
                  document.getElementById("package")?.scrollIntoView({ behavior: "smooth" });
                  if (typeof onCheckout === "function") onCheckout("packaging");
                }}
                className="px-3 py-2 rounded-xl bg-white/10 dark:bg-black/10 border border-white/20 dark:border-black/20 text-xs font-semibold"
              >
                Packaging ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>
      {locked.lockedByTier.length ? (
        <div className="mt-6">
          <div className="text-sm font-semibold mb-3">Tier-locked pages</div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {locked.lockedByTier.slice(0, 24).map(({ p, requiredTier, vis }) => {
              const tag = niceTypeLabel(p.page_type);
              const title = safeStr(p.title) || tag;
              return (
                <div key={p.id} className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/60 dark:bg-gray-950/30 px-4 py-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="font-semibold truncate">{title}</div>
                      <div className="text-xs opacity-70 mt-1">{tag}</div>
                    </div>
                    <div className="flex flex-col items-end gap-2 shrink-0">
                      <span className={tierBadge(requiredTier)}>{tierLabel(requiredTier)}</span>
                      {vis === "vault" ? (
                        <span className="text-[10px] px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700">
                          vault
                        </span>
                      ) : null}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ) : null}
      {locked.lockedByVault.length ? (
        <div className="mt-8">
          <div className="text-sm font-semibold mb-3">Vault-hidden pages</div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {locked.lockedByVault.slice(0, 24).map(({ p, requiredTier }) => {
              const tag = niceTypeLabel(p.page_type);
              const title = safeStr(p.title) || tag;
              return (
                <div key={p.id} className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/60 dark:bg-gray-950/30 px-4 py-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="font-semibold truncate">{title}</div>
                      <div className="text-xs opacity-70 mt-1">{tag}</div>
                    </div>
                    <div className="flex flex-col items-end gap-2 shrink-0">
                      <span className={tierBadge(requiredTier)}>{tierLabel(requiredTier)}</span>
                      <span className="text-[10px] px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700">
                        vault
                      </span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ) : null}
    </div>
  );
}
/* ------------------------------
   Media normalization
--------------------------------*/
function normalizeApiList(json) {
  if (Array.isArray(json)) return json;
  if (json && Array.isArray(json.posts)) return json.posts;
  if (json && Array.isArray(json.data)) return json.data;
  if (json && Array.isArray(json.rows)) return json.rows;
  if (json && Array.isArray(json.items)) return json.items;
  return [];
}
function normalizeMediaPosts(raw) {
  const list = (raw || [])
    .map((p) => {
      const m = safeMeta(p.metadata);
      const media_type = normalizeType(m.media_type || "");
      const urls = bestUrl(m, p);
      const audio_url = urls.audio_url;
      const media_url = urls.media_url;
      const duration = asStr(m.duration || "").trim();
      const platform = asStr(m.platform || "").trim() || inferPlatform(media_url || audio_url);
      const ip = pickIp(m);
      const card_img = pickCardImage(p, m);
      return {
        ...p,
        metadata: m,
        card_img,
        media_type,
        media_url,
        audio_url,
        duration,
        platform,
        ip,
        scene: asStr(m.scene || "").trim(),
        mood: asStr(m.mood || "").trim(),
        download_url: asStr(m.download_url || "").trim(),
        license_url: asStr(m.license_url || "").trim(),
        tags: Array.isArray(m.tags) ? m.tags : [],
        created_at: p.created_at || m.created_at || null,
        updated_at: p.updated_at || m.updated_at || null,
      };
    })
    .filter((it) => !!asStr(it.audio_url).trim() || !!asStr(it.media_url).trim());
  list.sort((a, b) => new Date(b.created_at || b.updated_at || 0) - new Date(a.created_at || a.updated_at || 0));
  return list;
}
function matchesUniverseIp(item, universe) {
  if (!item || !universe) return false;
  const ip = safeStr(item.ip).toLowerCase();
  const title = safeStr(universe.title).toLowerCase();
  const slug = safeStr(universe.slug).toLowerCase();
  const m = item.metadata || {};
  const mu = safeStr(m.universe).toLowerCase();
  const mb = safeStr(m.book).toLowerCase();
  const ms = safeStr(m.series).toLowerCase();
  const mip = safeStr(m.ip).toLowerCase();
  const mf = safeStr(m.franchise).toLowerCase();
  if (ip && title && ip === title) return true;
  if (ip && slug && ip === slug) return true;
  if (mu && title && mu === title) return true;
  if (mu && slug && mu === slug) return true;
  if (mb && title && mb === title) return true;
  if (mb && slug && mb === slug) return true;
  if (ms && title && ms === title) return true;
  if (ms && slug && ms === slug) return true;
  if (mip && title && mip === title) return true;
  if (mip && slug && mip === slug) return true;
  if (mf && title && mf === title) return true;
  if (mf && slug && mf === slug) return true;
  const hay = [ip, mu, mb, ms, mip, mf].filter(Boolean).join(" ");
  if (title && hay.includes(title)) return true;
  if (slug && hay.includes(slug)) return true;
  return false;
}
function getPlaysScore(item) {
  const m = item?.metadata || {};
  const candidates = [
    item?.play_count,
    item?.plays,
    item?.view_count,
    item?.views,
    m?.play_count,
    m?.plays,
    m?.view_count,
    m?.views,
    m?.listen_count,
    m?.listens,
  ]
    .map((x) => Number(x))
    .filter((n) => Number.isFinite(n));
  if (!candidates.length) return 0;
  return Math.max(...candidates);
}
function getRecencyTs(item) {
  const t = item?.updated_at || item?.created_at || item?.metadata?.updated_at || item?.metadata?.created_at || 0;
  const ts = new Date(t || 0).getTime();
  return Number.isFinite(ts) ? ts : 0;
}
function pickSoundtrackCandidate({ mediaPosts = [], audioItems = [] }) {
  const playlist = (mediaPosts || []).find(
    (it) => normalizeType(it.media_type) === "playlist" && safeStr(it.media_url || it.audio_url)
  );
  if (playlist) return { kind: "playlist", item: playlist };
  const candidates = (audioItems || []).filter((it) => {
    const t = normalizeType(it.media_type);
    const url = safeStr(it.media_url || it.audio_url);
    if (!url) return false;
    if (t === "trailer") return false;
    return (
      ["soundtrack", "score", "chapter_read", "audiobook", "scene"].includes(t) ||
      isDirectAudio(url) ||
      isYoutube(url) ||
      url.includes("spotify.com") ||
      url.includes("soundcloud.com")
    );
  });
  if (!candidates.length) return null;
  const sorted = candidates
    .slice()
    .sort((a, b) => {
      const ap = getPlaysScore(a);
      const bp = getPlaysScore(b);
      if (bp !== ap) return bp - ap;
      return getRecencyTs(b) - getRecencyTs(a);
    });
  return { kind: "auto", item: sorted[0] };
}
/* =========================================================
   PAGE COMPONENT
========================================================= */
export default function StudioUniverse() {
  const router = useRouter();
  const { slug } = router.query;
  const [entitledTier, setEntitledTier] = useState("public");
  const [entitlement, setEntitlement] = useState(null);
  // REAL access tier
  const tokenTier = useMemo(() => normalizeTierOrNull(router.query?.token_tier), [router.query]);
  const viewerTier = useMemo(() => {
    const a = normalizeTier(entitledTier);
    const b = tokenTier ? normalizeTier(tokenTier) : "public";
    return TIER_RANK[b] > TIER_RANK[a] ? b : a;
  }, [entitledTier, tokenTier]);
  // vault gating
  const canSeeVault = useMemo(() => canViewTier(viewerTier, "packaging"), [viewerTier]);
  const showVault = useMemo(
    () => canSeeVault && String(router.query?.vault || "") === "1",
    [canSeeVault, router.query?.vault]
  );
  const previewTier = useMemo(() => normalizeTierOrNull(router.query?.tier), [router.query?.tier]);
  // ‚úÖ UI tier (PREVIEW) ‚Äî can be controlled via URL buttons, but does not grant access
  const uiTier = useMemo(() => previewTier || viewerTier, [previewTier, viewerTier]);
  const [universe, setUniverse] = useState(null);
  const [assets, setAssets] = useState([]);
  const [studioPages, setStudioPages] = useState([]);
  const [mediaPosts, setMediaPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [tierProducts, setTierProducts] = useState({});
  const [bookProducts, setBookProducts] = useState([]);
  const [studioOffers, setStudioOffers] = useState([]);
  const [offersLoading, setOffersLoading] = useState(false);
  async function getAccessTokenOrThrow() {
    const { data } = await supabase.auth.getSession();
    const token = data?.session?.access_token;
    if (!token) throw new Error("Not logged in");
    return token;
  }
  async function downloadPagePdf(page_type, mode = "full") {
    try {
      const token = await getAccessTokenOrThrow();
      const r = await fetch("/api/studio/download-page", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ universe_id: universe.id, page_type, mode }),
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error || "Download failed");
      window.open(j.url, "_blank");
    } catch (e) {
      alert(e.message || "Download failed");
    }
  }
  async function downloadPacket(tier = "producer", mode = "full", include_vault = false) {
    try {
      const token = await getAccessTokenOrThrow();
      const r = await fetch("/api/studio/download-packet", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ universe_id: universe.id, tier, mode, include_vault }),
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error || "Packet download failed");
      window.open(j.url, "_blank");
    } catch (e) {
      alert(e.message || "Download failed");
    }
  }
  useEffect(() => {
    if (!slug) return;
    let cancelled = false;
    (async () => {
      setLoading(true);
      const { data: u, error: uErr } = await supabase.from("universes").select("*").eq("slug", slug).maybeSingle();
      if (uErr) console.error(uErr);
      if (cancelled) return;
      setUniverse(u || null);
      if (!u?.id) {
        setAssets([]);
        setStudioPages([]);
        setMediaPosts([]);
        setLoading(false);
        return;
      }
      const [{ data: a, error: aErr }, { data: pages, error: pErr }] = await Promise.all([
        supabase
          .from("universe_assets")
          .select("*")
          .eq("universe_id", u.id)
          .eq("status", "published")
          .order("sort_order", { ascending: true })
          .order("updated_at", { ascending: false }),
        supabase
          .from("studio_pages")
          .select("*")
          .eq("universe_id", u.id)
          .eq("status", "published")
          .order("sort_order", { ascending: true })
          .order("updated_at", { ascending: false }),
      ]);
      if (aErr) console.error(aErr);
      if (pErr) console.error(pErr);
      if (cancelled) return;
      setAssets(a || []);
      setStudioPages(pages || []);
      try {
        const res = await fetch("/api/posts?division=media");
        const json = await res.json();
        const raw = normalizeApiList(json);
        const normalized = normalizeMediaPosts(raw);
        const scoped = normalized.filter((it) => matchesUniverseIp(it, u));
        setMediaPosts(scoped);
      } catch (err) {
        console.error("studio media fetch fetch error:", err);
        setMediaPosts([]);
      }
      setLoading(false);
      // entitlement lookup overrides viewerTier
      try {
        const { data: sess } = await supabase.auth.getSession();
        const user = sess?.session?.user;
        if (user?.id) {
          const { data: ent, error: entErr } = await supabase
            .from("studio_entitlements")
            .select("tier,status,expires_at")
            .eq("user_id", user.id)
            .eq("universe_id", u.id)
            .maybeSingle();
          if (entErr) console.warn("entitlement lookup failed:", entErr.message);
          const now = new Date();
          const isActive =
            ent &&
            (ent.status || "active") === "active" &&
            (!ent.expires_at || new Date(ent.expires_at) > now);
          setEntitledTier(isActive ? normalizeTier(ent.tier) : "public");
          setEntitlement(isActive ? ent : null);
        }
      } catch (e) {
        console.warn("entitlement lookup failed", e);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [slug]);
  useEffect(() => {
    if (!universe?.id) return;
    let cancelled = false;
    (async () => {
      setOffersLoading(true);
      const rows = await loadStudioOffersForUniverseId(universe.id);
      if (!cancelled) setStudioOffers(rows);
      setOffersLoading(false);
    })();
    return () => {
      cancelled = true;
    };
  }, [universe?.id]);
  useEffect(() => {
    if (!universe?.id) return;
    async function loadTierProducts() {
      const { data: products, error } = await supabase
        .from("products")
        .select("id, metadata, updated_at")
        .eq("status", "active")
        .filter("metadata->>universe_id", "eq", String(universe.id))
        .order("updated_at", { ascending: false });
      if (error) console.warn("loadTierProducts error:", error.message);
      const map = {};
      (products || []).forEach((p) => {
        const meta = safeJson(p.metadata, {});
        const offerType = safeStr(meta.offer_type || meta.kind).toLowerCase();
        // ‚úÖ ONLY studio offers
        if (offerType !== "studio_access") return;
        const tier = normalizeTier(meta.tier || meta.access_tier || meta.required_tier);
        if (!tier) return;
        // ‚úÖ store Supabase product.id (newest wins due to ordering)
        if (!map[tier]) map[tier] = p.id;
      });
      setTierProducts(map);
    }
    loadTierProducts();
  }, [universe?.id]);
  useEffect(() => {
    if (!universe?.id) return;
    let cancelled = false;
    (async () => {
      try {
        // Fetch attached publishing products from universe_assets
        const { data: attached, error: attachedErr } = await supabase
          .from("universe_assets")
          .select("source_product_id")
          .eq("universe_id", universe.id)
          .eq("source_type", "product")
          .eq("division", "publishing");

        if (attachedErr) throw attachedErr;

        const ids = attached.map((a) => a.source_product_id).filter(Boolean);

        if (!ids.length) {
          if (!cancelled) setBookProducts([]);
          return;
        }

        const { data: products, error: productsErr } = await supabase
          .from("products")
          .select("*")
          .in("id", ids)
          .eq("status", "active");

        if (productsErr) throw productsErr;

        const mapped = products.map((p) => {
          const meta = safeJson(p.metadata, {});
          return {
            ...p,
            metadata: meta,
            display_image: pickProductImage(p),
          };
        });

        if (!cancelled) setBookProducts(mapped);
      } catch (e) {
        console.error("studio books fetch error:", e);
        if (!cancelled) setBookProducts([]);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [universe?.id]);
  const heroImages = useMemo(() => {
    const thumbs = assets.map((x) => getThumb(x)).filter(Boolean).slice(0, 6);
    if (thumbs.length) return thumbs;
    if (universe?.cover_image_url) return [universe.cover_image_url];
    return ["/images/og-home.webp"];
  }, [assets, universe]);
  const trailerAsset = useMemo(() => {
    return (
      assets.find((x) => safeStr(x.asset_type).toLowerCase() === "trailer") ||
      assets.find((x) => safeStr(x?.metadata?.media_type).toLowerCase() === "trailer") ||
      assets.find((x) => safeStr(x?.media_type).toLowerCase() === "trailer") ||
      assets.find((x) => safeStr(x.asset_type).toLowerCase() === "video") ||
      null
    );
  }, [assets]);
  const trailerUrl = useMemo(() => {
    return universe?.trailer_video_url || getAssetUrl(trailerAsset) || universe?.hero_video_url || null;
  }, [trailerAsset, universe]);
  const worldMapAssets = useMemo(() => {
    return assets
      .filter(
        (a) =>
          safeStr(a.asset_type).toLowerCase() === "world_map" ||
          safeStr(a?.metadata?.kind).toLowerCase() === "world_map"
      )
      .filter((a) => getThumb(a) || a.external_url);
  }, [assets]);
  const featuredWorldMapUrl = useMemo(() => universe?.world_map_url || null, [universe]);
  const hasWorldMapSection = useMemo(() => {
    return worldMapAssets.length > 0 || Boolean(featuredWorldMapUrl);
  }, [worldMapAssets.length, featuredWorldMapUrl]);
  const visualAssetsRaw = useMemo(() => {
    return assets.filter((a) => {
      const t = safeStr(a.asset_type).toLowerCase();
      const div = safeStr(a.division).toLowerCase();
      const url = getAssetUrl(a);
      const ft = guessFileType(url);
      const kind = safeStr(a?.metadata?.kind).toLowerCase();
      const isWorldMap =
        t === "world_map" || kind === "world_map" || safeStr(a?.metadata?.media_type).toLowerCase() === "world_map";
      if (isWorldMap) return false;
      return ["image", "art", "still", "poster", "cover"].includes(t) || div === "designs" || ft === "image" || kind === "visual";
    });
  }, [assets]);
  const merchAssets = useMemo(() => {
    const isMerch = (a) => {
      const t = safeStr(a.asset_type).toLowerCase();
      const kind = safeStr(a?.metadata?.kind).toLowerCase();
      const purpose = safeStr(a?.purpose).toLowerCase();
      const tags = Array.isArray(a?.tags) ? a.tags.map((x) => safeStr(x).toLowerCase()) : [];
      const title = safeStr(a?.title).toLowerCase();
      return (
        ["merch", "mockup", "tshirt", "hoodie", "shirt", "product"].includes(t) ||
        ["merch", "mockup", "product"].includes(kind) ||
        ["merch", "mockup", "product"].includes(purpose) ||
        tags.some((x) => ["merch", "mockup", "tshirt", "hoodie", "product"].includes(x)) ||
        title.includes("merch") ||
        title.includes("mockup") ||
        title.includes("t-shirt") ||
        title.includes("tshirt") ||
        title.includes("hoodie")
      );
    };
    return visualAssetsRaw.filter(isMerch);
  }, [visualAssetsRaw]);
  const characterAssets = useMemo(() => {
    return assets.filter((a) => {
      const t = safeStr(a.asset_type).toLowerCase();
      const kind = safeStr(a?.metadata?.kind).toLowerCase();
      return t === "character" || kind === "character";
    });
  }, [assets]);
  const audioItems = useMemo(() => {
    const isAudioLike = (it) => {
      const t = normalizeType(it.media_type);
      if (["soundtrack", "score", "chapter_read", "audiobook", "scene"].includes(t)) return true;
      const url = safeStr(it.audio_url || it.media_url);
      return isDirectAudio(url) || url.includes("spotify.com") || isYoutube(url) || url.includes("soundcloud.com");
    };
    return (mediaPosts || []).filter(isAudioLike);
  }, [mediaPosts]);
  const soundtrackFromPosts = useMemo(() => {
    const pick = (mediaPosts || []).find((it) => normalizeType(it.media_type) === "playlist");
    return pick || null;
  }, [mediaPosts]);
  const soundtrackUrl = useMemo(() => {
    if (soundtrackFromPosts) return safeStr(soundtrackFromPosts.media_url || soundtrackFromPosts.audio_url);
    const fallbackAsset =
      assets.find((x) => safeStr(x.asset_type).toLowerCase() === "soundtrack") ||
      assets.find((x) => safeStr(x?.metadata?.media_type).toLowerCase() === "playlist") ||
      assets.find((x) => safeStr(x?.media_type).toLowerCase() === "playlist") ||
      assets.find((x) => safeStr(x.division).toLowerCase() === "media") ||
      null;
    return (
      fallbackAsset?.external_url ||
      fallbackAsset?.file_url ||
      fallbackAsset?.metadata?.media_url ||
      fallbackAsset?.metadata?.audio_url ||
      ""
    );
  }, [soundtrackFromPosts, assets]);
  const soundtrackCandidate = useMemo(() => {
    return pickSoundtrackCandidate({ mediaPosts, audioItems });
  }, [mediaPosts, audioItems]);
  const soundtrackResolved = useMemo(() => {
    if (safeStr(soundtrackUrl)) {
      return {
        source: "manual",
        url: safeStr(soundtrackUrl),
        item: soundtrackFromPosts || null,
        label: "Official Soundtrack",
      };
    }
    if (soundtrackCandidate?.item) {
      const it = soundtrackCandidate.item;
      const url = safeStr(it.media_url || it.audio_url);
      if (!url) return null;
      const plays = getPlaysScore(it);
      const kindLabel =
        soundtrackCandidate.kind === "playlist" ? "Official Playlist" : plays > 0 ? "Top Track" : "Most Recent Track";
      return { source: "auto", url, item: it, label: kindLabel };
    }
    return null;
  }, [soundtrackUrl, soundtrackFromPosts, soundtrackCandidate]);
  const producerPacket = useMemo(() => {
    return (
      assets.find(
        (x) => safeStr(x.division).toLowerCase() === "studios" && x.is_public === false && Number(x.price_cents || 0) > 0
      ) || null
    );
  }, [assets]);
  const nftAssets = useMemo(() => {
    return assets.filter((a) => safeStr(a.asset_type).toLowerCase() === "nft" || a?.metadata?.nft_url);
  }, [assets]);
  const producerEmailHref = useMemo(() => {
    if (!universe?.title || !universe?.slug) return "mailto:studios@manyagi.net";
    const subject = `Option / Licensing Inquiry ‚Äî ${universe.title}`;
    const body =
      `Universe: ${universe.title}\n` +
      `Link: https://manyagi.net/studios/${universe.slug}\n\n` +
      `Company:\nRole:\nBudget Range:\nTimeline:\nWhat are you looking to option?\nNotes:\n`;
    return `mailto:studios@manyagi.net?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }, [universe]);
  const quickSignals = useMemo(() => {
    const signals = [];
    if (trailerUrl) signals.push("Trailer Ready");
    if (audioItems.length) signals.push(`${audioItems.length} Audio Cues`);
    if (merchAssets.length) signals.push(`${merchAssets.length} Merch Mockups`);
    if (characterAssets.length) signals.push(`${characterAssets.length} Characters`);
    if (hasWorldMapSection) signals.push("World Map");
    if (producerPacket) signals.push("Producer Packet (Gated)");
    if (nftAssets.length) signals.push("Collectibles");
    if (studioPages.length) signals.push(`${studioPages.length} Studio Pages`);
    if (showVault) signals.push("Vault View");
    signals.push(`Tier: ${tierLabel(viewerTier)}`);
    return signals;
  }, [
    trailerUrl,
    audioItems.length,
    merchAssets.length,
    characterAssets.length,
    hasWorldMapSection,
    producerPacket,
    nftAssets.length,
    studioPages.length,
    showVault,
    viewerTier,
  ]);
  const canonicalUrl = useMemo(() => {
    if (!universe?.slug) return "";
    return `https://manyagi.net/studios/${universe.slug}`;
  }, [universe]);
  const jsonLd = useMemo(() => {
    if (!universe?.title) return null;
    return {
      "@context": "https://schema.org",
      "@type": "CreativeWorkSeries",
      name: universe.title,
      description: universe.logline || universe.tagline || "A Manyagi Studios Universe.",
      url: canonicalUrl || undefined,
      creator: { "@type": "Person", name: "Dennis Manyagi" },
      publisher: { "@type": "Organization", name: "Manyagi Studios" },
    };
  }, [universe, canonicalUrl]);
  const groupedPages = useMemo(() => groupStudioPages(studioPages, showVault, viewerTier), [studioPages, showVault, viewerTier]);
  const packageBar = useMemo(() => packageProgress(studioPages), [studioPages]);
  const studioToc = useMemo(() => {
    const toc = [];
    groupedPages.forEach((g) => {
      toc.push({ id: `pkg-${g.key}`, label: g.title, kind: "group" });
      g.pages.forEach((p) => {
        const pageTier = getPageAccessTier(p);
        toc.push({
          id: `p-${p.id}`,
          label: p.title || niceTypeLabel(p.page_type),
          kind: "page",
          tag: niceTypeLabel(p.page_type),
          vault: getPageVisibility(p) === "vault",
          tier: pageTier,
        });
      });
    });
    return toc;
  }, [groupedPages]);
  async function startStudioCheckout(tier) {
    const t = normalizeTier(tier);
    if (canViewTier(viewerTier, t)) {
      alert(`Already unlocked: ${tierLabel(t)}.`);
      return;
    }
    try {
      const { data: sess } = await supabase.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) {
        router.push(`/login?next=${encodeURIComponent(router.asPath)}`);
        return;
      }
      // ‚úÖ tierProducts should store product.id (Supabase row id)
      const product_id = tierProducts[normalizeTier(tier)];
      if (!product_id) throw new Error(`No active product found for ${tier} in this universe.`);
      const res = await fetch("/api/checkout/create-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ product_id, quantity: 1 }),
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || "Checkout failed");
      if (json?.url) window.location.href = json.url;
    } catch (e) {
      alert(e.message || "Checkout failed");
    }
  }
  if (loading) {
    return (
      <section className="container mx-auto px-4 px-4 py-16">
        <div className="opacity-70">Loading universe‚Ä¶</div>
      </section>
    );
  }
  if (!universe) {
    return (
      <section className="container mx-auto px-4 py-16">
        <h1 className="text-2xl font-bold">Universe not found</h1>
        <Link href="/studios" className="underline mt-4 inline-block">
          Back to Studios
        </Link>
      </section>
    );
  }
  const navItems = [
  { href: "#one-sheet", label: "One-Sheet" },
  ...(trailerUrl ? [{ href: "#trailer", label: "Trailer" }] : []),
  ...(characterAssets.length ? [{ href: "#characters", label: "Characters" }] : []),
  ...(hasWorldMapSection ? [{ href: "#world-map", label: "World Map" }] : []),
  ...(audioItems.length || soundtrackResolved ? [{ href: "#audio", label: "Sound" }] : []),
  ...(groupedPages.length ? [{ href: "#package", label: "Producer Materials" }] : []),
  ...(bookProducts.length ? [{ href: "#books", label: "Books" }] : []),
  { href: "#visuals", label: "Merch" },
  { href: "#vault", label: "Adaptation Assets" },
  { href: "#contact", label: "Options" },
];
  const resolvedSoundtrackUrl = soundtrackResolved?.url || "";
  const isSoundtrackSpotify = resolvedSoundtrackUrl.includes("spotify.com");
  const isSoundtrackYT = isYoutube(resolvedSoundtrackUrl);
  const isSoundtrackAudioFile = ["mp3", "wav", "m4a", "ogg"].includes(guessFileType(resolvedSoundtrackUrl));
  return (
    <>
      <Head>
        <title>{universe.title} ‚Äî Manyagi Studios</title>
        <meta name="description" content={universe.logline || universe.tagline || "A Manyagi Studios Universe."} />
        {canonicalUrl ? <link rel="canonical" href={canonicalUrl} /> : null}
        <meta property="og:type" content="website" />
        <meta property="og:title" content={`${universe.title} ‚Äî Manyagi Studios`} />
        <meta property="og:description" content={universe.logline || universe.tagline || "A Manyagi Studios Universe."} />
        {canonicalUrl ? <meta property="og:url" content={canonicalUrl} /> : null}
        {heroImages?.[0] ? <meta property="og:image" content={heroImages[0]} /> : null}
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={`${universe.title} ‚Äî Manyagi Studios`} />
        <meta name="twitter:description" content={universe.logline || universe.tagline || "A Manyagi Studios Universe."} />
        {heroImages?.[0] ? <meta name="twitter:image" content={heroImages[0]} /> : null}
        {jsonLd ? <script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }} /> : null}
      </Head>
      <Hero
        kicker="Manyagi Studios"
        title={universe.title}
        lead={universe.logline || universe.tagline || "Prestige IP engineered for adaptation."}
        carouselImages={heroImages}
        height="h-[720px]"
      >
        <div className="flex flex-wrap gap-3 justify-center">
          {trailerUrl ? (
            <a href="#trailer" className="btn bg-black text-white py-2 px-4 rounded hover:scale-105 transition dark:bg-white dark:text-black">
              ‚ñ∂ Watch Trailer
            </a>
          ) : null}
          {audioItems.length || soundtrackResolved ? (
            <a
              href="#audio"
              className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
            >
              üéß Listen
            </a>
          ) : null}
          {groupedPages.length ? (
            <a
              href="#package"
              className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
            >
              üì¶ Producer Materials
            </a>
          ) : null}
          <a
            href="#vault"
            className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
          >
            View Adaptation Assets
          </a>
          <a href={producerEmailHref} className="btn bg-amber-200 text-amber-950 py-2 px-4 rounded hover:bg-amber-300 transition">
            üíº Options / Licensing
          </a>
          <Link
            href={showVault ? `/studios/${universe.slug}?tier=${viewerTier}` : `/studios/${universe.slug}?vault=1&tier=${viewerTier}`}
            className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
          >
            {showVault ? "üîí Hide Vault" : "üîì Vault View"}
          </Link>
        </div>
      </Hero>
      <section className="container mx-auto px-4 -mt-8 mb-10">
        <div className="flex gap-2 overflow-x-auto no-scrollbar justify-center text-xs md:text-[13px]">
          {navItems.map((item) => (
            <a
              key={item.href}
              href={item.href}
              className="whitespace-nowrap px-3 py-2 rounded-full border border-gray-200/80 bg-white/80 text-gray-800 hover:bg-gray-100 hover:border-amber-400 transition dark:bg-gray-900/80 dark:border-gray-700 dark:text-gray-100 dark:hover:bg-gray-800"
            >
              {item.label}
            </a>
          ))}
        </div>
      </section>
      <section className="container mx-auto px-4 pb-10 -mt-2">
        <PackagesBar
          universe={universe}
          viewerTier={viewerTier}
          uiTier={uiTier}
          showVault={showVault}
          onCheckout={startStudioCheckout}
          offers={studioOffers}
          offersLoading={offersLoading}
          entitlement={entitlement}
          onDownloadPacket={(tierKey) => downloadPacket(tierKey)}
        />
      </section>
      <SectionIntro
        id="one-sheet"
        kicker="Studio One-Sheet"
        title="Logline ‚Ä¢ Synopsis ‚Ä¢ Adaptation Angle"
        lead="A fast executive read ‚Äî built for the first five minutes of a serious conversation."
        tone="warm"
      />
      <section className="container mx-auto px-4 pb-12 -mt-4">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 rounded-3xl bg-white/80 dark:bg-gray-900/70 border border-amber-100/80 dark:border-gray-800 shadow-sm p-6 md:p-8">
            <div className="flex flex-wrap gap-2 mb-4">
              {quickSignals.map((s) => (
                <span key={s} className="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                  {s}
                </span>
              ))}
            </div>
            <h3 className="text-2xl font-bold">Logline</h3>
            <p className="mt-2 text-base opacity-90">{universe.logline || "Add a studio-grade logline in Admin ‚Üí Universes."}</p>
            <h3 className="text-2xl font-bold mt-6">Synopsis</h3>
            <p className="mt-2 opacity-90 leading-relaxed">{universe.synopsis || "Add a studio-grade synopsis in Admin ‚Üí Universes."}</p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
              <div className="rounded-2xl border border-gray-200/70 dark:border-gray-800 bg-white/60 dark:bg-gray-950/30 p-4">
                <div className="text-xs opacity-60 uppercase tracking-wider">Tone</div>
                <div className="font-semibold mt-1">Cinematic ‚Ä¢ Mythic ‚Ä¢ Character-driven</div>
              </div>
              <div className="rounded-2xl border border-gray-200/70 dark:border-gray-800 bg-white/60 dark:bg-gray-950/30 p-4">
                <div className="text-xs opacity-60 uppercase tracking-wider">Format</div>
                <div className="font-semibold mt-1">Series / Feature / Animation</div>
              </div>
              <div className="rounded-2xl border border-gray-200/70 dark:border-gray-800 bg-white/60 dark:bg-gray-950/30 p-4">
                <div className="text-xs opacity-60 uppercase tracking-wider">Expansion</div>
                <div className="font-semibold mt-1">Multi-season arcs + spin-offs</div>
              </div>
            </div>
          </div>
          <div className="rounded-3xl bg-white/80 dark:bg-gray-900/70 border border-amber-100/80 dark:border-gray-800 shadow-sm p-6 md:p-8">
            <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Executive Scan</div>
            <h3 className="text-xl font-bold mt-2">At a glance</h3>
            <div className="mt-4 flex flex-col gap-3">
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">Trailer</div>
                <div className="text-sm font-semibold text-right">{trailerUrl ? "Available" : "Coming soon"}</div>
              </div>
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">Sound</div>
                <div className="text-sm font-semibold text-right">{audioItems.length ? `${audioItems.length} cues` : soundtrackResolved ? "Available" : "‚Äî"}</div>
              </div>
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">Characters</div>
                <div className="text-sm font-semibold text-right">{characterAssets.length ? `${characterAssets.length}` : "‚Äî"}</div>
              </div>
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">World Map</div>
                <div className="text-sm font-semibold text-right">{hasWorldMapSection ? "Included" : "‚Äî"}</div>
              </div>
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">Merch</div>
                <div className="text-sm font-semibold text-right">{merchAssets.length ? `${merchAssets.length}` : "‚Äî"}</div>
              </div>
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">Producer Materials</div>
                <div className="text-sm font-semibold text-right">
                  {packageBar.count}/{packageBar.total}
                </div>
              </div>
              <div className="flex items-start justify-between gap-4">
                <div className="text-sm opacity-70">Viewing Tier</div>
                <div className="text-sm font-semibold text-right">{tierLabel(viewerTier)}</div>
              </div>
            </div>
            <div className="mt-6 rounded-2xl bg-amber-200 text-amber-950 p-4">
              <div className="text-sm font-semibold">Options / Licensing</div>
              <div className="text-xs opacity-80 mt-1">Company ‚Ä¢ budget ‚Ä¢ timeline</div>
              <a
                href={producerEmailHref}
                className="mt-4 inline-flex w-full justify-center px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black font-semibold"
              >
                Request Conversation
              </a>
            </div>
          </div>
        </div>
      </section>
      {trailerUrl ? (
        <>
          <SectionIntro id="trailer" kicker="Sizzle" title="Trailer" lead="Tone. Scale. Momentum. One watch." tone="neutral" align="center" />
          <section className="container mx-auto px-4 pb-14 -mt-6">
            <div className="rounded-[28px] overflow-hidden border border-gray-200 dark:border-gray-800 bg-black shadow-sm">
              {isYoutube(trailerUrl) ? <YoutubeEmbed url={trailerUrl} title="Trailer" /> : <video src={trailerUrl} controls playsInline className="w-full h-[480px] object-cover bg-black" />}
            </div>
          </section>
        </>
      ) : null}
      {characterAssets.length ? (
        <>
          <SectionIntro id="characters" kicker="Cast" title="Characters" lead="Core cast ‚Äî roles, identities, and portraits for deck continuity." tone="neutral" align="center" />
          <section className="container mx-auto px-4 pb-14 -mt-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              {characterAssets.map((c) => (
                <div key={c.id} className="rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm">
                  {getThumb(c) ? (
                    <img src={getThumb(c)} alt={c.title || "Character"} className="w-full h-64 object-cover" loading="lazy" />
                  ) : (
                    <div className="w-full h-64 bg-gray-100 dark:bg-gray-800" />
                  )}
                  <div className="p-4">
                    <div className="font-semibold text-lg">{c.title || "Character"}</div>
                    {c.description ? <div className="text-sm opacity-80 mt-2 whitespace-pre-wrap leading-relaxed">{c.description}</div> : null}
                    {c?.metadata?.role || c?.metadata?.character_name ? (
                      <div className="mt-3 flex flex-wrap gap-2">
                        {c?.metadata?.character_name ? chip(String(c.metadata.character_name)) : null}
                        {c?.metadata?.role ? chip(String(c.metadata.role)) : null}
                      </div>
                    ) : null}
                  </div>
                </div>
              ))}
            </div>
          </section>
        </>
      ) : null}
      {hasWorldMapSection ? (
        <>
          <SectionIntro id="world-map" kicker="World" title="World Map" lead="Geography, regions, and zones ‚Äî the big picture." tone="neutral" align="center" />
          <section className="container mx-auto px-4 pb-14 -mt-6">
            {featuredWorldMapUrl && worldMapAssets.length === 0 ? (
              <div className="rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm">
                <img src={featuredWorldMapUrl} alt="World map" className="w-full h-[520px] object-cover" loading="lazy" />
                <div className="p-4">
                  <div className="font-semibold">World Map</div>
                  <div className="text-sm opacity-70 mt-1">Featured map</div>
                </div>
              </div>
            ) : null}
            {worldMapAssets.length ? (
              <div className="flex gap-4 overflow-x-auto no-scrollbar pb-2 snap-x snap-mandatory">
                {worldMapAssets.map((m) => (
                  <div key={m.id} className="snap-center shrink-0 w-[92%] md:w-[70%] rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm">
                    <img src={getThumb(m) || m.external_url} alt={m.title || "World map"} className="w-full h-[420px] object-cover" loading="lazy" />
                    <div className="p-4">
                      <div className="font-semibold">{m.title || "World Map"}</div>
                      {m.description ? <div className="text-sm opacity-70 mt-1">{m.description}</div> : null}
                      {m.external_url || getThumb(m) ? (
                        <a className="text-sm underline mt-3 inline-block" href={m.external_url || getThumb(m)} target="_blank" rel="noreferrer">
                          Open full size ‚Üí
                        </a>
                      ) : null}
                    </div>
                  </div>
                ))}
              </div>
            ) : null}
          </section>
        </>
      ) : null}
      {(audioItems.length || soundtrackResolved) ? (
        <>
          <SectionIntro
            id="audio"
            kicker="Sound"
            title="Themes & Cues"
            lead="Pulled from the same media feed as /media ‚Äî so your studio page always stays synced."
            tone="neutral"
            align="center"
          />
          <section className="container mx-auto px-4 pb-14 -mt-6">
            <HeaderCard
              kicker="Listening order"
              title="Main Theme ‚Üí Hero ‚Üí Villain ‚Üí Trailer Cue"
              subtitle="Designed to be skimmed fast, then revisited deeper."
              rightChips={["Motif-driven", "Trailer-ready", "Synced with /media"]}
              align="left"
              className="mb-6"
            />
            {audioItems.length ? (
              audioItems.length === 1 ? (
                <div className="flex justify-center">
                  <div className="w-full max-w-3xl">
                    <AudioCard a={audioItems[0]} />
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                  {audioItems.map((a) => (
                    <AudioCard key={a.id} a={a} />
                  ))}
                </div>
              )
            ) : (
              <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm p-6 md:p-8 text-center">
                <div className="text-lg font-bold">No cues published yet</div>
                <div className="opacity-80 mt-2">Publish media posts tagged to this universe to auto-sync here.</div>
              </div>
            )}
            {soundtrackResolved ? (
              <div className="mt-10">
                <HeaderCard
                  kicker="Official"
                  title="Soundtrack"
                  subtitle="Playlist link (Spotify / YouTube) or the official master track."
                  rightChips={[soundtrackResolved.source === "manual" ? "Manual link" : "Auto-selected", soundtrackResolved.label]}
                  align="center"
                  className="mb-6"
                />
                <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/85 dark:bg-gray-900/60 shadow-sm p-6 md:p-8">
                  {isSoundtrackSpotify ? (
                    <SpotifyEmbed url={resolvedSoundtrackUrl} title="Soundtrack" />
                  ) : isSoundtrackYT ? (
                    <YoutubeEmbed url={resolvedSoundtrackUrl} title="Soundtrack" />
                  ) : isSoundtrackAudioFile ? (
                    <div className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-950/30 p-4">
                      <audio controls preload="none" className="w-full">
                        <source src={resolvedSoundtrackUrl} />
                      </audio>
                    </div>
                  ) : (
                    <div className="text-sm opacity-70">Soundtrack link detected (open via button).</div>
                  )}
                  <div className="mt-4 flex flex-wrap gap-2 justify-center">
                    <a
                      className="px-5 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black font-semibold"
                      href={resolvedSoundtrackUrl}
                      target="_blank"
                      rel="noreferrer"
                    >
                      {isSoundtrackSpotify ? "Listen on Spotify ‚Üí" : isSoundtrackYT ? "Open on YouTube ‚Üí" : isSoundtrackAudioFile ? "Open Audio ‚Üí" : "Open Soundtrack ‚Üí"}
                    </a>
                    {soundtrackResolved?.item?.slug ? (
                      <Link
                        href={`/media/${soundtrackResolved.item.slug}`}
                        className="px-5 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40 font-semibold"
                      >
                        View Details ‚Üí
                      </Link>
                    ) : null}
                  </div>
                </div>
              </div>
            ) : null}
          </section>
        </>
      ) : null}
      <SectionIntro
        id="package"
        kicker="Producer Materials"
        title="Studio Pages"
        lead="Deck-ready sections grouped for fast executive review."
        tone="neutral"
        align="center"
      />
      <section className="container mx-auto px-4 pb-14 -mt-6">
        {/* optional: shows titles of locked pages so buyers see what they unlock */}
        <LockedSectionsPreview
          universe={universe}
          pages={studioPages}
          viewerTier={viewerTier}
          showVault={showVault}
          onCheckout={startStudioCheckout}
        />
        {!groupedPages.length ? (
          <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm p-8 text-center">
            <div className="text-lg font-bold">No studio pages published yet</div>
            <div className="opacity-80 mt-2">Publish pages in Admin ‚Üí Studio Pages.</div>
          </div>
        ) : (
          <div className="space-y-10">
            {groupedPages.map((g) => (
              <div key={g.key} id={`pkg-${g.key}`}>
                <HeaderCard
                  kicker={g.kicker}
                  title={g.title}
                  subtitle={g.lead}
                  rightChips={g.chips || []}
                  align="left"
                  className="mb-5"
                />
                <div className="space-y-5">
                  {g.pages.map((p) => {
                    const requiredTier = getPageAccessTier(p);
                    const tag = niceTypeLabel(p.page_type);
                    const pageTitle = p.title || tag;
                    const md = safeJson(p.metadata, {});
                    const body = safeStr(p.content_md || md.content || md.body || md.markdown || p.content || "");
                    return (
                      <AccessGateCard
                        key={p.id}
                        viewerTier={viewerTier}
                        requiredTier={requiredTier}
                        title={pageTitle}
                        subtitle={`${tag}${getPageVisibility(p) === "vault" ? " ‚Ä¢ Vault" : ""}`}
                        universe={universe}
                        onCheckout={startStudioCheckout}
                      >
                        <div id={`p-${p.id}`} className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/80 dark:bg-gray-900/60 shadow-sm p-6 md:p-8">
                          <div className="flex items-start justify-between gap-3 flex-wrap">
                            <div>
                              <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">{tag}</div>
                              <div className="text-2xl font-bold mt-2">{pageTitle}</div>
                              <div className="mt-3 flex flex-wrap gap-2">
                                <span className={tierBadge(requiredTier)}>{tierLabel(requiredTier)}</span>
                                {getPageVisibility(p) === "vault" ? chip("vault") : null}
                              </div>
                            </div>
                          </div>
                          <div className="mt-6">
                            {body ? renderPlainMarkdown(body) : <div className="text-sm opacity-70">No content yet.</div>}
                          </div>
                          <PageAttachmentsRail page={p} />
                          {canViewTier(viewerTier, requiredTier) ? (
                            <div className="mt-6 flex justify-end">
                              <button
                                onClick={() => downloadPagePdf(p.page_type)}
                                className="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold"
                              >
                                Download PDF ‚Üí
                              </button>
                            </div>
                          ) : null}
                        </div>
                      </AccessGateCard>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
        )}
      </section>
      {bookProducts.length ? (
  <>
    <SectionIntro
      id="books"
      kicker="Publishing"
      title="Books & Collections"
      lead="Publishing products linked to this universe (matched by universe_id with smart fallback matching)."
      tone="neutral"
      align="center"
    />
    <section className="container mx-auto px-4 pb-14 -mt-6">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
        {bookProducts.map((product) => {
          const m = product.metadata || {};
          const buyUrl =
            m.amazon_url ||
            m.kindle_url ||
            m.paperback_url ||
            m.store_url ||
            null;
          const alsoLinks = [
            m.kindle_url ? { label: "Kindle", url: m.kindle_url } : null,
            m.paperback_url ? { label: "Paperback", url: m.paperback_url } : null,
          ].filter(Boolean);
          const chips = [
            m.series || m.book || null,
            m.format ? String(m.format).toUpperCase() : null,
            m.year ? `Published ${m.year}` : null,
          ].filter(Boolean);
          return (
            <Card
              key={product.id}
              title={product.name}
              description={product.description}
              image={product.display_image || pickProductImage(product)}
              category="publishing"
              tags={Array.isArray(product.tags) ? product.tags : []}
            >
              {chips.length ? (
                <div className="flex flex-wrap gap-2 justify-center mb-3">
                  {chips.map((c) => (
                    <span
                      key={c}
                      className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
                    >
                      {c}
                    </span>
                  ))}
                </div>
              ) : null}
              <div className="flex flex-wrap gap-3 mt-2 justify-center">
                {buyUrl ? (
                  <a
                    href={buyUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="btn bg-black text-white py-2 px-4 rounded hover:opacity-90 transition"
                  >
                    Get Your Copy
                  </a>
                ) : (
                  <Link
                    href="/publishing"
                    className="btn bg-black text-white py-2 px-4 rounded hover:opacity-90 transition"
                  >
                    View in Publishing
                  </Link>
                )}
                {m.pdf_url ? (
                  <a
                    href={m.pdf_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="btn bg-white/90 text-gray-900 border border-gray-200 py-2 px-4 rounded hover:bg-gray-100 transition dark:bg-gray-900 dark:text-white dark:border-gray-700 dark:hover:bg-gray-800"
                  >
                    Read Sample
                  </a>
                ) : null}
              </div>
              {alsoLinks.length ? (
                <div className="text-xs text-gray-600 dark:text-gray-300 mt-3 text-center">
                  Also available:{" "}
                  {alsoLinks.map((l, i) => (
                    <a
                      key={l.label}
                      href={l.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="underline hover:text-blue-700"
                    >
                      {l.label}
                      {i < alsoLinks.length - 1 ? ", " : ""}
                    </a>
                  ))}
                </div>
              ) : null}
            </Card>
          );
        })}
      </div>
    </section>
  </>
) : null}
      <SectionIntro id="visuals" kicker="Visual Identity" title="Merch" lead="Merch mockups for brand extension, drops, and audience capture." tone="neutral" align="center" />
      <section className="container mx-auto px-4 pb-14 -mt-6">
        {merchAssets.length ? (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
            {merchAssets.slice(0, 12).map((a) => (
              <div key={a.id} className="rounded-3xl overflow-hidden border border-gray-200/80 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm">
                {getThumb(a) ? (
                  <img src={getThumb(a)} alt={a.title || ""} className="w-full h-56 object-cover" loading="lazy" />
                ) : (
                  <div className="w-full h-56 bg-gray-100 dark:bg-gray-800" />
                )}
                <div className="p-4">
                  <div className="font-semibold">{a.title || "Merch Asset"}</div>
                  <div className="text-xs opacity-70 mt-1">{safeStr(a.asset_type || "merch").toUpperCase()}</div>
                  {a.external_url || a.file_url ? (
                    <a className="text-sm underline mt-3 inline-block" href={a.external_url || a.file_url} target="_blank" rel="noreferrer">
                      Open ‚Üí
                    </a>
                  ) : null}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="rounded-3xl border border-gray-200 dark:border-gray-800 p-8 bg-white/70 dark:bg-gray-900/50 text-center">
            <div className="text-lg font-bold">No merch uploaded yet</div>
            <div className="opacity-80 mt-2">Add merch mockups to universe assets.</div>
          </div>
        )}
      </section>
      <SectionIntro id="vault" kicker="IP Vault" title="Adaptation Assets" lead="Package components for partners, buyers, and serious option conversations." tone="warm" align="center" />
      <section className="container mx-auto px-4 pb-14 -mt-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {producerPacket ? (
            <div className="rounded-3xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 shadow-sm p-6">
              <div className="text-[11px] tracking-[0.28em] uppercase opacity-70">Gated</div>
              <div className="text-xl font-bold mt-2">Producer Packet</div>
              <p className="opacity-80 mt-2">Deck + positioning + world overview (delivered on request).</p>
              <div className="mt-4 rounded-2xl bg-amber-200 text-amber-950 p-4">
                <div className="text-sm font-semibold">Request access</div>
                <div className="text-xs opacity-80">Include company ‚Ä¢ budget ‚Ä¢ timeline.</div>
                <a
                  href={producerEmailHref}
                  className="mt-3 inline-flex w-full justify-center px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black font-semibold"
                >
                  Request Option / Licensing
                </a>
              </div>
            </div>
          ) : (
            <Card title="Producer Packet" description="Enable by adding a studios asset with is_public=false and price_cents>0.">
              <div className="text-sm opacity-70">Currently not configured.</div>
            </Card>
          )}
          {nftAssets.map((a) => (
            <Card key={a.id} title={a.title || "Collectible"} description="Limited edition collectible / unlockable.">
              {a.metadata?.nft_url ? (
                <a className="underline" href={a.metadata.nft_url} target="_blank" rel="noreferrer">
                  View ‚Üí
                </a>
              ) : (
                <div className="text-sm opacity-70">Add metadata.nft_url to link.</div>
              )}
            </Card>
          ))}
          {(audioItems.length || soundtrackResolved) ? (
            <Card title="Sound Package" description="Themes + cues + soundtrack (synced from /media).">
              <a className="underline" href="#audio">
                Open sound ‚Üí
              </a>
            </Card>
          ) : null}
        </div>
      </section>
      <section className="container mx-auto px-4 pb-20" id="contact">
        <div className="text-center">
          <div className="text-3xl font-bold">Options / Licensing</div>
          <div className="opacity-80 mt-2">Company ‚Ä¢ budget ‚Ä¢ timeline</div>
          <div className="mt-6 flex flex-wrap gap-3 justify-center">
            <a href={producerEmailHref} className="px-6 py-3 rounded-2xl bg-black text-white dark:bg-white dark:text-black font-semibold">
              Email Studios ‚Üí
            </a>
            <Link href="/studios" className="px-6 py-3 rounded-2xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-950/40">
              Back to Library
            </Link>
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/tech.js  (size=12505 bytes) =====
// pages/tech.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';

import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';
import SectionIntro from '../components/SectionIntro';
import TechQuoteForm from '../components/TechQuoteForm';

const asList = (v) => {
  if (Array.isArray(v)) return v;
  if (v && Array.isArray(v.items)) return v.items;
  return [];
};

const parseList = (v) => {
  if (Array.isArray(v)) return v;
  if (!v) return [];
  if (typeof v === 'string') {
    return v
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean);
  }
  return [];
};

const pickImage = (p) =>
  p?.featured_image ||
  p?.metadata?.screenshot ||
  'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-placeholder.webp';

export default function Tech() {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts?division=tech');
        const json = await res.json();

        if (!json.ok) {
          setError(json.error || 'Failed to load Tech showcase items.');
        }

        const list = asList(json);
        const normalized = list.map((p) => {
          const meta = p.metadata || {};
          return {
            id: p.id,
            name: p.title,
            slug: p.slug,
            tagline: meta.tagline || '',
            description: p.content || p.excerpt || '',
            excerpt: p.excerpt || '',
            image: pickImage(p),
            domain: meta.app_url || '',
            appCategory: meta.app_category || 'flagship',
            appType: meta.app_type || 'app',
            status: meta.status || 'Live',
            platforms: parseList(meta.platforms),
            labels: parseList(meta.labels),
          };
        });

        setItems(normalized);
      } catch (e) {
        console.error('Tech fetch error:', e);
        setError(e.message || 'Error loading apps.');
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-1.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-2.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-3.webp',
  ];

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading tech apps...
      </div>
    );
  }

  const flagshipApps = items.filter((item) => item.appCategory !== 'upcoming');
  const upcomingApps = items.filter((item) => item.appCategory === 'upcoming');

  return (
    <>
      <Head>
        <title>Manyagi Tech ‚Äî Apps, Platforms & Custom Builds</title>
        <meta
          name="description"
          content="Manyagi Tech designs and ships real-world apps like Daito, Nexu, and RealKenyans ‚Äî and builds custom products, websites, and tools for clients."
        />
      </Head>

      {/* HERO */}
      <Hero
        kicker="Tech"
        title="Ship Real Products with Manyagi Tech"
        lead="From delivery apps to community platforms, we build tools that actually get used ‚Äî and we can build yours too."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <div className="flex flex-wrap gap-3">
          <Link
            href="#flagship"
            className="btn bg-white/90 text-gray-900 border border-gray-300 py-2 px-4 rounded hover:bg-gray-50 transition text-sm font-semibold"
          >
            View Our Apps
          </Link>
          <Link
            href="#quote"
            className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-sm font-semibold"
          >
            Start a Project
          </Link>
        </div>
      </Hero>

      {/* FLAGSHIP APPS */}
      <SectionIntro
        id="flagship"
        kicker="Flagship Platforms"
        title="Live Products Built by Manyagi Tech"
        lead="These are real, shipped products ‚Äî not just case-study mockups. You can visit them today, download the apps, and leave reviews."
        tone="neutral"
        align="center"
      />

      <section className="container mx-auto px-4 pt-4 pb-16">
        {error && (
          <div className="max-w-3xl mx-auto mb-4 text-sm text-red-500">
            {error}
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
          {flagshipApps.length === 0 ? (
            <div className="col-span-full text-center text-sm opacity-70">
              No flagship apps configured yet. Add Daito, Nexu, RealKenyans,
              and Manyagi.net in the Admin &gt; Tech tab.
            </div>
          ) : (
            flagshipApps.map((app) => (
              <Card
                key={app.id}
                title={app.name}
                description={app.description}
                image={app.image}
                category="tech"
              >
                {app.tagline && (
                  <div className="mb-2">
                    <p className="text-xs font-semibold text-gray-700 dark:text-gray-200">
                      {app.tagline}
                    </p>
                  </div>
                )}

                {app.labels.length > 0 && (
                  <div className="flex flex-wrap gap-1 mb-3">
                    {app.labels.map((label) => (
                      <span
                        key={label}
                        className="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-800 px-2.5 py-0.5 text-[11px] font-medium text-gray-700 dark:text-gray-200"
                      >
                        {label}
                      </span>
                    ))}
                  </div>
                )}

                {app.platforms.length > 0 && (
                  <div className="flex flex-wrap items-center gap-2 mb-3">
                    {app.platforms.map((plat) => (
                      <span
                        key={plat}
                        className="inline-flex items-center rounded-full border border-gray-200 dark:border-gray-700 px-2.5 py-0.5 text-[11px] text-gray-700 dark:text-gray-200"
                      >
                        {plat}
                      </span>
                    ))}
                  </div>
                )}

                {app.domain ? (
                  <a
                    href={app.domain}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-700 transition"
                  >
                    Open Site / Download
                  </a>
                ) : (
                  <span className="text-xs text-gray-500 dark:text-gray-400">
                    Coming soon
                  </span>
                )}

                {app.domain && (
                  <p className="mt-2 text-[11px] text-gray-500 dark:text-gray-400">
                    From the site you can find App Store / Google Play links
                    and leave reviews (where available).
                  </p>
                )}
              </Card>
            ))
          )}
        </div>
      </section>

      {/* UPCOMING / LABS */}
      <SectionIntro
        id="labs"
        kicker="Labs"
        title="Upcoming Apps & Experiments"
        lead="A glimpse at what‚Äôs currently cooking inside Manyagi Tech. Some of these will ship as standalone apps; others will plug into Daito, Nexu, or RealKenyans."
        tone="card"
        align="center"
      />

      <section className="container mx-auto px-4 pt-4 pb-16">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {upcomingApps.length === 0 ? (
            <div className="col-span-full text-center text-sm opacity-70">
              No upcoming apps configured yet. Use the Tech admin tab and set
              <code> Category = Upcoming / Labs</code>.
            </div>
          ) : (
            upcomingApps.map((app) => (
              <div
                key={app.id}
                className="rounded-3xl border border-gray-200/80 dark:border-gray-700/80 bg-white/95 dark:bg-gray-950/95 p-5 shadow-sm"
              >
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-50">
                    {app.name}
                  </h3>
                  <span className="inline-flex items-center rounded-full bg-amber-50 dark:bg-amber-900/40 px-2.5 py-0.5 text-[11px] font-medium text-amber-800 dark:text-amber-200">
                    {app.status}
                  </span>
                </div>
                <p className="text-sm text-gray-700 dark:text-gray-300 mb-3">
                  {app.description || app.excerpt}
                </p>
                {(app.labels.length > 0 || app.platforms.length > 0) && (
                  <div className="flex flex-wrap gap-1">
                    {app.labels.map((f) => (
                      <span
                        key={f}
                        className="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-800 px-2.5 py-0.5 text-[11px] text-gray-700 dark:text-gray-200"
                      >
                        {f}
                      </span>
                    ))}
                    {app.platforms.map((p) => (
                      <span
                        key={p}
                        className="inline-flex items-center rounded-full border border-gray-200 dark:border-gray-700 px-2.5 py-0.5 text-[11px] text-gray-700 dark:text-gray-200"
                      >
                        {p}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </section>

      {/* WORK WITH US / QUOTE SECTION (BOTTOM, SINGLE COLUMN FORM) */}
      <SectionIntro
        id="quote"
        kicker="Work With Manyagi Tech"
        title="Need a Website, App, or Platform Built?"
        lead="We design, build, and ship web apps, mobile apps, landing pages, and internal tools ‚Äî with a bias toward fast iteration and real-world usage."
        tone="neutral"
        align="center"
        maxWidth="max-w-2xl"
      >
        <p className="text-xs text-gray-500 dark:text-gray-400">
          This form opens your email client with a full brief prefilled. You can
          also email{' '}
          <a
            href="mailto:tech@manyagi.net"
            className="underline underline-offset-2"
          >
            tech@manyagi.net
          </a>{' '}
          directly.
        </p>
      </SectionIntro>

      <section className="container mx-auto px-4 pt-4 pb-16">
        {/* wide centered card; width controlled here so we can tweak easily */}
        <TechQuoteForm className="max-w-4xl mx-auto" />
      </section>

      {/* EMAIL CAPTURE FOR NEW DROPS */}
      <SectionIntro
        id="subscribe"
        kicker="Stay Ahead"
        title="Get Early Access to New Apps & Betas"
        lead="We quietly test new builds before they go public. Drop your email to get invites, changelogs, and behind-the-scenes updates from Manyagi Tech."
        tone="neutral"
        align="center"
      />

      <section className="container mx-auto px-4 pt-4 pb-16">
        <SubscriptionForm
          formId="8427849"
          uid="637df68a02"
          title="Get Early Access"
          description="Be first in line for new app betas, tools, and private releases."
        />
      </section>

      {/* CROSS-DIVISION RECOMMENDER */}
      <Recommender />
    </>
  );
}


===== FILE: pages/tech/[slug].js  (size=4026 bytes) =====
// pages/tech/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

const pickImage = (post) =>
  post?.featured_image ||
  post?.thumbnail_url ||
  post?.metadata?.cover_url ||
  '/placeholder.png';

export default function TechDetailPage() {
  const router = useRouter();
  const { slug } = router.query;

  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);

  // fetch single tech post by slug
  useEffect(() => {
    if (!slug) return;
    (async () => {
      try {
        // NOTE: you have /api/posts right now which returns ALL posts.
        // You‚Äôll want to extend /api/posts to handle ?division=tech&slug=...
        // (We already planned that in the posts.js change.)
        const res = await fetch(`/api/posts?division=tech&slug=${slug}`);
        const json = await res.json();

        // accept a few shapes
        let row = null;
        if (Array.isArray(json)) {
          row = json[0] || null;
        } else if (json.post) {
          row = json.post;
        } else if (json.items) {
          row = json.items[0] || null;
        }

        setPost(row);
      } catch (err) {
        console.error('tech slug fetch error:', err);
        setPost(null);
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        Loading‚Ä¶
      </div>
    );
  }

  if (!post) {
    return (
      <div className="container mx-auto px-4 py-16">
        Tech item not found.
      </div>
    );
  }

  const heroImg = pickImage(post);
  const appUrl = post?.metadata?.app_url;
  const appType = post?.metadata?.app_type;

  return (
    <>
      <Head>
        <title>{post.title} ‚Äî Manyagi Tech</title>
        <meta
          name="description"
          content={post.excerpt || 'Manyagi Tech showcase'}
        />
      </Head>

      <section className="container mx-auto px-4 pb-32 pt-16 md:pb-16 max-w-3xl text-gray-900 dark:text-gray-100">
        {/* Title */}
        <h1 className="text-4xl font-bold mb-4">{post.title}</h1>

        {/* Badges */}
        <div className="flex flex-wrap gap-2 text-xs mb-6">
          {appType && (
            <span className="inline-block bg-gray-900 text-white px-2 py-1 rounded font-semibold dark:bg-gray-100 dark:text-gray-900">
              {appType}
            </span>
          )}
          <span className="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold dark:bg-blue-900 dark:text-blue-100">
            Manyagi Tech
          </span>
        </div>

        {/* Hero image */}
        <div className="w-full h-64 md:h-[360px] rounded overflow-hidden bg-gray-200 dark:bg-gray-800 mb-6 border border-gray-300 dark:border-gray-700">
          <img
            src={heroImg}
            alt={post.title}
            className="w-full h-full object-cover"
          />
        </div>

        {/* CTA button */}
        {appUrl && (
          <div className="mb-8">
            <a
              href={appUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-block bg-blue-600 text-white py-2 px-4 rounded font-semibold hover:bg-blue-700 transition dark:bg-yellow-500 dark:text-black dark:hover:bg-yellow-400"
            >
              Visit App
            </a>
          </div>
        )}

        {/* Excerpt */}
        {post.excerpt && (
          <p className="mb-6 text-lg text-gray-800 dark:text-gray-200">
            {post.excerpt}
          </p>
        )}

        {/* Long content / body */}
        {post.content && (
          <article className="prose prose-neutral dark:prose-invert max-w-none whitespace-pre-line">
            {post.content}
          </article>
        )}
      </section>
    </>
  );
}


===== FILE: pages/terms.js  (size=1167 bytes) =====
// pages/terms.js
import Head from 'next/head';
import Link from 'next/link';
import Hero from '../components/Hero';

export default function Terms() {
  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Terms of Service</title>
        <meta name="description" content="Read Manyagi‚Äôs Terms of Service." />
      </Head>
      <Hero
        kicker="Terms"
        title="Terms of Service"
        lead="Understand the terms governing our services."
        carouselImages={['/images/og-home.webp']}
        height="h-[600px]"
      />
      <section className="container mx-auto px-4 py-16 text-sm space-y-4">
        <h2 className="text-xl font-bold">1. Introduction</h2>
        <p>By using Manyagi, you agree to these terms.</p>
        <h2 className="text-xl font-bold">2. Services</h2>
        <p>Details about our publishing, designs, capital, tech, and media services.</p>
        <h2 className="text-xl font-bold">3. GDPR Compliance</h2>
        <p>We comply with GDPR for data protection. See our <Link href="/privacy" className="text-blue-600 hover:underline">Privacy Policy</Link>.</p>
      </section>
    </>
  );
};


===== FILE: pages/thank-you.js  (size=5496 bytes) =====
// pages/thank-you.js
import Head from 'next/head';
import Link from 'next/link';
import Hero from '../components/Hero';
import { FaTwitter, FaFacebook, FaInstagram } from 'react-icons/fa';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

export default function ThankYou() {
  const router = useRouter();
  const { session_id } = router.query;
  const [orderDetails, setOrderDetails] = useState(null);
  const [error, setError] = useState('');
  const site = process.env.NEXT_PUBLIC_SITE_URL || (typeof window !== 'undefined' ? window.location.origin : 'https://manyagi.net');

  const carouselImages = [
    '/images/og-designs.webp',
    '/images/merch-carousel-1.webp',
    '/images/merch-carousel-2.webp',
  ];

  useEffect(() => {
    if (session_id) {
      fetch(`/api/order-details?session_id=${session_id}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) setError(data.error);
          else setOrderDetails(data);
        })
        .catch(err => {
          console.error('Fetch order details error:', err);
          setError('Failed to fetch order details');
        });
    }
  }, [session_id]);

  const leadText = error
    ? 'Your purchase is complete, but we couldn‚Äôt fetch order details. Check your email for confirmation.'
    : orderDetails
    ? (orderDetails.type === 'signals'
        ? 'Your subscription is active. Check Telegram for your invite/message.'
        : orderDetails.type === 'download'
        ? 'Your download is ready below.'
        : orderDetails.type === 'book'
        ? 'Your eBook is ready below.'
        : orderDetails.type === 'merch'
        ? 'Thanks! We‚Äôll notify you when it ships.'
        : 'Your purchase is complete. Check your email for details.')
    : 'Your purchase is complete. Check your email for details.';

  // Supabase public asset URLs (avoid missing /public/assets/)
  const BOT_LICENSE_PDF =
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/pdfs/bot-license.pdf';
  const LEGACY_CH1_PDF =
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/pdfs/Legacy_of_the_Hidden_Clans_(Chapter_1)_by_D.N._Manyagi.pdf';

  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Thank You</title>
        <meta name="description" content="Thank you for your purchase!" />
      </Head>
      <Hero
        kicker="Thank You"
        title="Order Confirmed"
        lead={leadText}
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link href="/designs" className="btn bg-blue-600 text-white py-4 px-6 rounded hover:scale-105 transition">
          Continue Shopping
        </Link>
      </Hero>
      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6">Share Your Purchase</h2>
        {error && <p className="text-red-500 text-base mb-4">{error}</p>}

        {orderDetails && (
          <div className="space-y-3 mb-8">
            <p>Type: {orderDetails.type}</p>

            {orderDetails.type === 'merch' && (
              <p>
                Track your order at <Link href="/track" className="text-blue-600 hover:underline">/track</Link> (you‚Äôll need your order ID).
              </p>
            )}

            {orderDetails.type === 'download' && (
              <a
                href={BOT_LICENSE_PDF}
                className="text-blue-600 hover:underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                Download your license
              </a>
            )}

            {orderDetails.type === 'book' && (
              <a
                href={LEGACY_CH1_PDF}
                className="text-blue-600 hover:underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                Download eBook
              </a>
            )}

            {orderDetails.type === 'signals' && (
              <div className="space-y-2">
                <p>Welcome to Manyagi Capital Signals!</p>
                {process.env.NEXT_PUBLIC_TELEGRAM_INVITE_LINK ? (
                  <a
                    href={process.env.NEXT_PUBLIC_TELEGRAM_INVITE_LINK}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-block text-blue-600 hover:underline"
                  >
                    Join the Telegram group
                  </a>
                ) : (
                  <p>Check your Telegram DMs for the invite link.</p>
                )}
              </div>
            )}
          </div>
        )}

        <div className="flex gap-4 text-lg">
          <a href={`https://x.com/share?url=${encodeURIComponent(site)}`} className="text-blue-600 hover:text-blue-500" aria-label="Share on X">
            <FaTwitter size={24} />
          </a>
          <a href={`https://facebook.com/sharer/sharer.php?u=${encodeURIComponent(site)}`} className="text-blue-600 hover:text-blue-500" aria-label="Share on Facebook">
            <FaFacebook size={24} />
          </a>
          <a href="https://instagram.com/manyagi.official" className="text-blue-600 hover:text-blue-500" aria-label="Instagram">
            <FaInstagram size={24} />
          </a>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/track.js  (size=2442 bytes) =====
// pages/track.js
import Head from 'next/head';
import { useState } from 'react';

export default function Track() {
  const [orderId, setOrderId] = useState('');
  const [result, setResult] = useState(null);
  const [error, setError] = useState('');

  const handleLookup = async (e) => {
    e.preventDefault();
    setError('');
    setResult(null);
    if (!orderId) {
      setError('Please enter an order ID');
      return;
    }
    try {
      const res = await fetch(`/api/track?order_id=${encodeURIComponent(orderId)}`);
      const data = await res.json();
      if (!res.ok || data.error) {
        setError(data.error || 'Not found');
      } else {
        setResult(data);
      }
    } catch (err) {
      setError('Failed to fetch tracking info');
    }
  };

  return (
    <>
      <Head>
        <title>Track Order ‚Äî Manyagi</title>
        <meta name="description" content="Look up your Manyagi order status." />
      </Head>
      <section className="container mx-auto px-4 py-16 max-w-2xl">
        <h1 className="text-3xl font-bold mb-4">Track Your Order</h1>
        <form onSubmit={handleLookup} className="flex gap-2 mb-6">
          <input
            type="text"
            value={orderId}
            onChange={(e) => setOrderId(e.target.value)}
            placeholder="Enter your order ID"
            className="flex-1 p-3 border rounded"
          />
          <button type="submit" className="px-4 py-3 bg-black text-white rounded hover:opacity-90">
            Track
          </button>
        </form>
        {error && <p className="text-red-600 mb-4">{error}</p>}
        {result && (
          <div className="border rounded p-4 space-y-2 bg-white">
            <p><strong>Status:</strong> {result.status}</p>
            {result.estimated_delivery && <p><strong>Updated:</strong> {new Date(result.estimated_delivery).toLocaleString()}</p>}
            <p><strong>Division:</strong> {result.division}</p>
            <p><strong>Total:</strong> ${Number(result.total).toFixed(2)}</p>
            <div>
              <strong>Items:</strong>
              <ul className="list-disc ml-6">
                {(result.items || []).map((i, idx) => (
                  <li key={idx}>{i.name} x {i.quantity || 1}</li>
                ))}
              </ul>
            </div>
          </div>
        )}
      </section>
    </>
  );
}


===== FILE: postcss.config.js  (size=82 bytes) =====
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};


===== FILE: posts/example-post.mdx  (size=286 bytes) =====
---
title: '#001 ‚Äî The HQ Goes Live'
date: '2025-08-15'
---

We launched a unified HQ for Publishing, Designs, Media, Capital, and Tech. Here‚Äôs how we built it and what‚Äôs next.

**Key Updates:**
- Publishing: Chapter 1 released.
- Designs: New tee drop.

[Read more...]


===== FILE: public/images/logo.svg  (size=2639 bytes) =====
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200px" height="200px" viewBox="0 0 200 200" version="1.1">
<g id="surface1">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;" d="M 62 69.132812 C 58.332031 69.867188 59.535156 70.464844 63.933594 70.132812 C 70.132812 69.734375 73.601562 71.066406 78 75.464844 L 81.332031 78.800781 L 81.332031 94.265625 C 81.332031 111.132812 80.867188 113.332031 77.332031 115.132812 C 75.867188 115.867188 76.464844 116 82 116 C 88.199219 116 88.265625 115.933594 86.199219 114.933594 C 82.332031 113 81.933594 111.199219 82.132812 94.535156 L 82.332031 79.667969 L 84.464844 83.132812 C 85.667969 85.066406 89.398438 92.734375 92.734375 100.132812 C 96.132812 107.601562 100 115.464844 101.398438 117.734375 C 104.464844 122.601562 110 127.933594 114.066406 130 C 117.464844 131.800781 126.667969 132.734375 126.667969 131.398438 C 126.667969 130.867188 126.132812 130.734375 125.332031 131 C 122.535156 131.867188 118.535156 130.601562 115.535156 127.800781 C 112 124.535156 108.933594 119.265625 105.398438 110.066406 L 102.734375 103.199219 L 107.800781 93.800781 C 110.535156 88.667969 113.132812 83.667969 113.535156 82.734375 C 114.199219 81.332031 114.398438 83.601562 114.535156 94.332031 C 114.734375 109.464844 114.464844 112.867188 112.601562 114.734375 C 111.332031 116 111.398438 116 118.398438 116 C 125.464844 116 125.464844 116 123.933594 114.734375 L 122.332031 113.464844 L 122.332031 79.867188 L 123.933594 78.601562 L 125.464844 77.332031 L 115.464844 77.332031 L 112.132812 83.464844 C 110.332031 86.867188 107.398438 92.464844 105.667969 95.867188 L 102.535156 102.132812 L 98.332031 93.535156 C 90.066406 76.667969 81.398438 69.535156 68.667969 69 C 65.933594 68.867188 62.933594 68.933594 62 69.132812 Z M 93.667969 89.933594 C 96.800781 95.601562 100.667969 104.398438 103 111 C 104 113.933594 105.132812 116.734375 105.464844 117.132812 C 105.933594 117.734375 105.933594 118 105.464844 118 C 104 118 100.332031 111.265625 94 96.667969 C 91.667969 91.265625 87.332031 82.667969 85.601562 80 C 85 79.066406 86.066406 80 87.867188 81.933594 C 89.734375 83.933594 92.332031 87.535156 93.667969 89.933594 Z M 119.398438 94.800781 C 119.398438 103 119.535156 110.332031 119.734375 111.199219 C 120 112.867188 118.199219 114.066406 117.398438 112.734375 C 117.132812 112.265625 116.800781 105.132812 116.734375 96.867188 C 116.601562 82.265625 116.867188 80 118.734375 80 C 119.066406 80 119.332031 86.667969 119.398438 94.800781 Z M 119.398438 94.800781 "/>
</g>
</svg>


===== FILE: public/robots.txt  (size=114 bytes) =====
# *
User-agent: *
Allow: /

# Host
Host: https://manyagi.net

# Sitemaps
Sitemap: https://manyagi.net/sitemap.xml


===== FILE: styles/globals.css  (size=3958 bytes) =====
/* Tailwind base, components, and utilities */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Base styles */
body {
  @apply bg-white text-black font-sans antialiased leading-relaxed text-left;
}

h1, h2, h3 {
  @apply font-bold tracking-wide;
}

/* Layout and components */
.container {
  @apply mx-auto px-4;
}

.card {
  @apply bg-white border border-gray-300 rounded-xl shadow-md p-4 mb-6 hover:shadow-xl transition;
}

.btn {
  @apply bg-yellow-500 text-black py-3 px-6 rounded-lg font-bold hover:bg-yellow-400 transition duration-300;
}

.section {
  @apply py-12;
}

/* Hover effects */
.hover\:text-gold:hover {
  color: #FFD700;
}

/* Dark mode */
.dark {
  --bg: #111;
  --text: #fff;
  --gray-100: #333;
  @apply bg-gray-900 text-white;
}

/* Glassmorphism */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
}

/* Gradient background */
.gradient-bg {
  background: linear-gradient(135deg, #9333ea, #FFD700, #4f46e5);
  background-size: 200% 200%;
  animation: gradientAnimation 15s ease infinite;
}

@keyframes gradientAnimation {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Blur and grainy effects */
.blur-bg {
  backdrop-filter: blur(5px);
}

.grainy {
  position: relative;
  overflow: hidden;
}

.grainy::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('/images/grain-texture.png') repeat;
  opacity: 0.05;
  pointer-events: none;
}

/* Bento grid */
.bento-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

/* Prose for text uniformity */
.prose {
  @apply text-left max-w-3xl mx-auto text-gray-800;
}

@tailwind base;
@tailwind components;
@tailwind utilities;

@font-face {
  font-family: 'PlayfulSans';
  src: url('/fonts/playful-sans.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
}

.font-playful {
  font-family: 'PlayfulSans', sans-serif;
}

.font-serif {
  font-family: 'Georgia', serif;
}



@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}



@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}


===== FILE: tailwind.config.js  (size=1987 bytes) =====
/** @type {import('tailwindcss').Config} */
module.exports = {
    darkMode: ['class'],
    content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
  	extend: {
  		colors: {
  			yellow: {
  				'400': '#FFCA28',
  				'500': '#FFD700'
  			},
  			purple: {
  				'500': '#6A1B9A'
  			},
  			gray: {
  				'100': '#F5F5F5'
  			},
  			background: 'hsl(var(--background))',
  			foreground: 'hsl(var(--foreground))',
  			card: {
  				DEFAULT: 'hsl(var(--card))',
  				foreground: 'hsl(var(--card-foreground))'
  			},
  			popover: {
  				DEFAULT: 'hsl(var(--popover))',
  				foreground: 'hsl(var(--popover-foreground))'
  			},
  			primary: {
  				DEFAULT: 'hsl(var(--primary))',
  				foreground: 'hsl(var(--primary-foreground))'
  			},
  			secondary: {
  				DEFAULT: 'hsl(var(--secondary))',
  				foreground: 'hsl(var(--secondary-foreground))'
  			},
  			muted: {
  				DEFAULT: 'hsl(var(--muted))',
  				foreground: 'hsl(var(--muted-foreground))'
  			},
  			accent: {
  				DEFAULT: 'hsl(var(--accent))',
  				foreground: 'hsl(var(--accent-foreground))'
  			},
  			destructive: {
  				DEFAULT: 'hsl(var(--destructive))',
  				foreground: 'hsl(var(--destructive-foreground))'
  			},
  			border: 'hsl(var(--border))',
  			input: 'hsl(var(--input))',
  			ring: 'hsl(var(--ring))',
  			chart: {
  				'1': 'hsl(var(--chart-1))',
  				'2': 'hsl(var(--chart-2))',
  				'3': 'hsl(var(--chart-3))',
  				'4': 'hsl(var(--chart-4))',
  				'5': 'hsl(var(--chart-5))'
  			}
  		},
  		fontFamily: {
  			sans: [
  				'Roboto',
  				'sans-serif'
  			]
  		},
  		fontSize: {
  			'14px': '14px',
  			'16px': '16px',
  			'32px': '32px',
  			'36px': '36px',
  			'40px': '40px',
  			'48px': '48px'
  		},
  		borderRadius: {
  			lg: 'var(--radius)',
  			md: 'calc(var(--radius) - 2px)',
  			sm: 'calc(var(--radius) - 4px)'
  		}
  	}
  },
    plugins: [
    require('tailwindcss-animate'),
  ],
};


===== FILE: tsconfig.json  (size=605 bytes) =====
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", "**/*.js"],
  "exclude": ["node_modules"]
}
